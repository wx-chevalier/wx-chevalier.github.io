<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="Java NIO 一、简介 Java NIO 是 JDK 1.4 中引入的新的 IO 方式，它主要包含 Buffer、Channel、Selector 这三个核心的组件，它与传统 IO 的区别如下： NIO IO 面向缓冲 面向流 同步非阻塞 同步阻塞 多路复用（选择器） 无 1.1 面向"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-nio/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-nio/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-nio/"><meta property="og:title" content="2020-heibaiying-Java NIO | Next-gen Tech Edu"><meta property="og:description" content="Java NIO 一、简介 Java NIO 是 JDK 1.4 中引入的新的 IO 方式，它主要包含 Buffer、Channel、Selector 这三个核心的组件，它与传统 IO 的区别如下： NIO IO 面向缓冲 面向流 同步非阻塞 同步阻塞 多路复用（选择器） 无 1.1 面向"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>2020-heibaiying-Java NIO | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=107914f78c3ab37c3be122f08c934f22><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">999.参考资料</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id60bf7bbde4cbc3a72b74d2e59492c1a7")' href=#id60bf7bbde4cbc3a72b74d2e59492c1a7 aria-expanded=false aria-controls=id60bf7bbde4cbc3a72b74d2e59492c1a7 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/>NIO</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id60bf7bbde4cbc3a72b74d2e59492c1a7 aria-expanded=false aria-controls=id60bf7bbde4cbc3a72b74d2e59492c1a7><i class="fa-solid fa-angle-down" id=caret-id60bf7bbde4cbc3a72b74d2e59492c1a7></i></a></div><ul class="nav docs-sidenav collapse show" id=id60bf7bbde4cbc3a72b74d2e59492c1a7><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idaca8ee4de8b6b2e40d70bca03ca2328e")' href=#idaca8ee4de8b6b2e40d70bca03ca2328e aria-expanded=false aria-controls=idaca8ee4de8b6b2e40d70bca03ca2328e aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>999.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idaca8ee4de8b6b2e40d70bca03ca2328e aria-expanded=false aria-controls=idaca8ee4de8b6b2e40d70bca03ca2328e><i class="fa-solid fa-angle-down" id=caret-idaca8ee4de8b6b2e40d70bca03ca2328e></i></a></div><ul class="nav docs-sidenav collapse show" id=idaca8ee4de8b6b2e40d70bca03ca2328e><li class="child level active"><a href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-nio/>2020-heibaiying-Java NIO</a></li></ul></div><li class="child level"><a href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/buffers/>Buffers</a></li><li class="child level"><a href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/channel/>Channel</a></li><li class="child level"><a href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/http/>HTTP</a></li><li class="child level"><a href=/books/java-series/3.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/3.%E5%B9%B6%E5%8F%91-io/nio/selector/>Selector</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#一简介>一、简介</a><ul><li><a href=#11-面向缓冲>1.1 面向缓冲</a></li><li><a href=#12-同步非阻塞>1.2 同步非阻塞</a></li><li><a href=#13-多路复用>1.3 多路复用</a></li></ul></li><li><a href=#二buffer>二、Buffer</a><ul><li><a href=#21-缓冲区属性>2.1 缓冲区属性</a></li><li><a href=#22-创建缓冲区>2.2 创建缓冲区</a></li><li><a href=#23-操作缓冲区>2.3 操作缓冲区</a></li><li><a href=#24-复制缓冲区>2.4 复制缓冲区</a></li><li><a href=#25-直接缓冲区>2.5 直接缓冲区</a></li></ul></li><li><a href=#三channel>三、Channel</a><ul><li><a href=#31-通道基础>3.1 通道基础</a></li><li><a href=#32-文件通道>3.2 文件通道</a></li><li><a href=#33-channel-to-channel>3.3 Channel To Channel</a></li><li><a href=#34-scattergather>3.4 Scatter/Gather</a></li><li><a href=#35-pipe>3.5 Pipe</a></li></ul></li><li><a href=#四selector>四、Selector</a><ul><li><a href=#41-创建选择器>4.1 创建选择器</a></li><li><a href=#42-注册通道>4.2 注册通道</a></li><li><a href=#43-select>4.3 select</a></li><li><a href=#44-selectionkey>4.4 SelectionKey</a></li></ul></li><li><a href=#五聊天室实例>五、聊天室实例</a><ul><li><a href=#51-群聊服务器>5.1 群聊服务器</a></li><li><a href=#52-客户端实现>5.2 客户端实现</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>2020-heibaiying-Java NIO</h1><div class=article-style><h1 id=java-nio>Java NIO</h1><h2 id=一简介>一、简介</h2><p>Java NIO 是 JDK 1.4 中引入的新的 IO 方式，它主要包含 Buffer、Channel、Selector 这三个核心的组件，它与传统 IO 的区别如下：</p><table><tr><th width=430px>NIO</th><th width=430px>IO</th></tr><tr><td align=center>面向缓冲</td><td align=center>面向流</td></tr><tr><td align=center>同步非阻塞</td><td align=center>同步阻塞</td></tr><tr><td align=center>多路复用（选择器）</td><td align=center>无</td></tr></table><h3 id=11-面向缓冲>1.1 面向缓冲</h3><p>传统的 IO 是面向流的，传统 IO 每次从流中读取一个或者多个字节，直至读取完所有的字节。而 NIO 是面向缓冲区的，所有的读写操作都需要通过 Buffer 来完成，数据会被先写入 Buffer 中，然后再进行处理，Buffer 提供了多种方法用于操纵其中的数据，因此其在操作上更加灵活，读取速度也更加快。</p><h3 id=12-同步非阻塞>1.2 同步非阻塞</h3><p>传统 IO 的流都是单向的，因此它们需要分为 Input Stream 和 Output Stream。而 NIO 中的 Channel 则是双向的，数据可以从 Channel 读到 Buffer 中，也可以从 Buffer 写到 Channel：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_channel_buffer.png></div><blockquote><p>注意：从 Channel 写入到 Buffer 执行的是 read 方法，而从 Buffer 写出到 Channel 执行的是 write 方法。</p></blockquote><p>Channel 可以设置为非阻塞模式，此时当 Channel 从 Buffer 中读取数据时，如果有待读取的数据则返回该数据；如果没有待读取的数据，对应的方法也不会阻塞，而是直接返回。</p><h3 id=13-多路复用>1.3 多路复用</h3><p>Java NIO 通过 Reactor 模型实现了 IO 的多路复用，可以在一个线程上通过一个选择（Selector）使用轮询的方式去监听多个通道 Channel 上注册的事件，从而在一个线程上就能实现对多个 Channel 的处理：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_selector.png></div><h2 id=二buffer>二、Buffer</h2><h3 id=21-缓冲区属性>2.1 缓冲区属性</h3><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_buffer.png></div><p>所有缓冲区（ByteBuffer、FloatBuffer、IntBuffer、DoubleBuffer、ShortBuffer、LongBuffer、CharBuffer、MappedByteBuffer）都直接或间接继承自 Buffer 抽象类，Buffer 中定义了缓冲区的四个基本属性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Buffer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>capacity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>limit</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>position</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mark</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li><strong>容量 (Capacity)</strong> ：缓冲区所能容纳元素的个数。</li><li><strong>上界 (Limit)</strong>：缓冲区中现存元素的个数。</li><li><strong>位置 (Position)</strong>：下一个待操作元素的索引。</li><li><strong>标记 (Mark)</strong>：标记位置。通过 <code>mark()</code> 方法可以让 mark 等于当前 position；之后通过 <code>reset()</code> 方法可以让 position 恢复到标记位置。</li></ul><h3 id=22-创建缓冲区>2.2 创建缓冲区</h3><p>通常可以通过以下两种方法来创建缓冲区：</p><ul><li><strong>allocate()</strong>：通过指定缓冲区的容量大小来创建：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>CharBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span></code></pre></div><ul><li><strong>wrap()</strong>：通过为缓冲区指定初始化数组来创建：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>char</span><span class=o>[]</span> <span class=n>chars</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=mi>100</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>CharBuffer</span><span class=o>.</span><span class=na>wrap</span><span class=o>(</span><span class=n>chars</span><span class=o>);</span>
</span></span></code></pre></div><p>实际上，在缓冲区内部就是通过数组来存储元素，以 CharBuffer 为例，它的内部维持有一个名为 <code>hb</code> 的数组，用来存放实际的元素：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>CharBuffer</span> <span class=kd>extends</span> <span class=n>Buffer</span> <span class=kd>implements</span> <span class=n>Comparable</span><span class=o>&lt;</span><span class=n>CharBuffer</span><span class=o>&gt;,</span> <span class=n>Appendable</span><span class=o>,</span> <span class=n>CharSequence</span><span class=o>,</span> <span class=n>Readable</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>char</span><span class=o>[]</span> <span class=n>hb</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>缓冲区创建完成后，它处于以下初始状态：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_init.png></div><h3 id=23-操作缓冲区>2.3 操作缓冲区</h3><p><strong>1. put()</strong></p><p>用于向缓冲区中填充数据。以 CharBuffer 为例，有以下四个常用的重载方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 使用字符串填充数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>put</span><span class=o>(</span><span class=n>String</span> <span class=n>src</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用字符串填充数据，start为字符串的开始位置，end为字符串的结束位置（不包含）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>put</span><span class=o>(</span><span class=n>String</span> <span class=n>src</span><span class=o>,</span> <span class=kt>int</span> <span class=n>start</span><span class=o>,</span> <span class=kt>int</span> <span class=n>end</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用数组填充数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>put</span><span class=o>(</span><span class=kt>char</span><span class=o>[]</span> <span class=n>src</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用数组填充数据，offset为数组填充的开始位置，length为填充的长度,不允许越界
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>put</span><span class=o>(</span><span class=kt>char</span><span class=o>[]</span> <span class=n>src</span><span class=o>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=o>,</span> <span class=kt>int</span> <span class=n>length</span><span class=o>)</span>
</span></span></code></pre></div><p>当我们向 Buffer 中添加数据后，position 属性也会随之变动：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_put.png></div><p><strong>2. get()</strong></p><p>用于读取缓冲区中的数据。以 CharBuffer 为例，有以下四个常用的重载方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取当前位置（postion）的数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=nf>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 获取指定位置的数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span> <span class=nf>get</span><span class=o>(</span><span class=kt>int</span> <span class=n>index</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 获取数据并填充到数组中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CharBuffer</span> <span class=nf>get</span><span class=o>(</span><span class=kt>char</span><span class=o>[]</span> <span class=n>dst</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 获取数据并填充到数据中，offset为数组填充的开始位置，length为填充的长度,不允许越界
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CharBuffer</span> <span class=nf>get</span><span class=o>(</span><span class=kt>char</span><span class=o>[]</span> <span class=n>dst</span><span class=o>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=o>,</span> <span class=kt>int</span> <span class=n>length</span><span class=o>)</span>
</span></span></code></pre></div><p><strong>3. flip()</strong></p><p>该方法会将 position 的值赋给 limit，然后将 position 设置为 0，从而可以由写模式切换到读模式。无论任何情况，只要由写操作转换到读操作，都需要先执行该方法。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>CharBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span> <span class=c1>//由写模式切换到读模式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>while</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span></code></pre></div><p>当使用 <code>filp()</code> 将 Buffer 由写模式切换到读模式后：position 属性会恢复到初始位置，代表从此处开始读取数据；limit 属性也会随之变动，代表我们所能读取数据的上界：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_flip.png></div><p>当我们再通过 <code>get()</code> 方法进行读取时，position 属性会随之移动，position 和 limit 之间就是待处理的数据：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_get.png></div><p><strong>4. hasRemaining()</strong></p><p><code>hasRemaining()</code> 用于判断当前的 position 是否小于 limit：如果 position 小于 limit，则返回 true，代表仍有待处理的数据。</p><p><strong>5. clear()</strong></p><p><code>clear()</code> 并不会真的清除缓冲区中的数据，它只是将 position 设置为 0，并将 limit 设置为 capacity 的大小，从而让缓冲区恢复到初始状态：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_clear.png></div><p>当有新的数据写入时，新的数据会覆盖原有位置上的数据。</p><p><strong>6. compact()</strong></p><p>用于压缩缓冲区，即将数组中待处理的数据复制到头部。如下所示，会将未读取的 <code>LL0</code> 复制到头部：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_compact.png></div><p>需要注意的是这里执行的是复制操作，而不是移动操作，底层调用的是 <code>System.arraycopy</code> 方法，因此原有位置上的数据依然存在。但由于 position 会移动到未处理数据的下一个位置上，所以不用担心原有位置上的数据会被读取到，原因是你切换到读模式时，原有的 <code>LO</code> 数据仍处于 limit 之后：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_compact_flip.png></div><p><strong>7. mark()</strong></p><p>用于设置标志位，设置好后可以使用 <code>reset()</code> 将 position 恢复到该位置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(</span><span class=mi>2</span><span class=o>).</span><span class=na>mark</span><span class=o>().</span><span class=na>position</span><span class=o>(</span><span class=mi>5</span><span class=o>).</span><span class=na>reset</span><span class=o>().</span><span class=na>position</span><span class=o>();</span> <span class=c1>//从位置2移动到位置5，之后又恢复到位置2
</span></span></span></code></pre></div><h3 id=24-复制缓冲区>2.4 复制缓冲区</h3><p>如果想要对一个已有的缓冲区进行复制，可以有以下三种方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=n>CharBuffer</span> <span class=nf>duplicate</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=n>CharBuffer</span> <span class=nf>asReadOnlyBuffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=n>CharBuffer</span> <span class=nf>slice</span><span class=o>();</span>
</span></span></code></pre></div><p>使用 <code>duplicate()</code> 复制的缓冲区具有以下特性：</p><ul><li>与原缓冲区共享相同的数据元素，这意味着对原缓冲区数据的修改也会影响复制缓冲区；</li><li>复制缓冲区的 mark、position、limit、capcaity 属性的初始值与复制时原缓冲区的 mark、position、limit、capcaity 的值相同，但这些属性与原缓冲区的属性相互独立，创建后就不再受原有缓冲区的影响；</li><li>如果原缓冲区是只读缓冲区或直接缓冲区，则复制缓冲区也将继承这些属性。</li></ul><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_duplicate.png></div><p><code>asReadOnlyBuffer()</code> 与 <code>duplicate()</code> 类似，但创建的复制缓冲区为只读缓冲区。</p><p><code>slice()</code> 也与 <code>duplicate()</code> 类似，但创建的复制缓冲区与原缓冲区只共享部分数据元素，并且所有标志位都处于原始状态：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/buffer_slice.png></div><p>使用示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>CharBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;helloworld&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(</span><span class=mi>2</span><span class=o>).</span><span class=na>limit</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>duplicate</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>.</span><span class=na>duplicate</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(</span><span class=mi>3</span><span class=o>).</span><span class=na>limit</span><span class=o>(</span><span class=mi>6</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>slice</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>.</span><span class=na>slice</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;buffer:&#34;</span> <span class=o>+</span> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;,&#34;</span> <span class=o>+</span> <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>());</span>     <span class=c1>// buffer:3,6
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;duplicate:&#34;</span> <span class=o>+</span> <span class=n>duplicate</span><span class=o>.</span><span class=na>position</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;,&#34;</span> <span class=o>+</span> <span class=n>duplicate</span><span class=o>.</span><span class=na>limit</span><span class=o>());</span> <span class=c1>// duplicate:2,5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;slice:&#34;</span> <span class=o>+</span> <span class=n>slice</span><span class=o>.</span><span class=na>position</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;,&#34;</span> <span class=o>+</span> <span class=n>slice</span><span class=o>.</span><span class=na>limit</span><span class=o>());</span>        <span class=c1>//slice:0,3
</span></span></span></code></pre></div><h3 id=25-直接缓冲区>2.5 直接缓冲区</h3><p>ByteBuffer 支持使用 <code>allocateDirect()</code> 方法来创建直接缓冲区，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>byteBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span></code></pre></div><h2 id=三channel>三、Channel</h2><h3 id=31-通道基础>3.1 通道基础</h3><p>Channel 接口的定义如下，其中定义了两个基础方法：</p><ul><li><strong>isOpen()</strong>：判断当前 Channel 是否处于打开状态；</li><li><strong>close()</strong>：关闭当前 Channel 。Channel 关闭后，就不能在其上再进行任何 IO 操作，否则将抛出 ClosedChannelException 异常。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Channel</span> <span class=kd>extends</span> <span class=n>Closeable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isOpen</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>close</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>对于常见的文件操作和网络操作都可以直接获取到其对应的 Channel：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取serverSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocket</span> <span class=n>serverSocket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=mi>8888</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ServerSocketChannel</span> <span class=n>serverSocketChannel</span> <span class=o>=</span> <span class=n>serverSocket</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取SocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=mi>8888</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>SocketChannel</span> <span class=n>socketChannel</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取FileChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FileInputStream</span> <span class=n>fileInputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;path&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>FileChannel</span> <span class=n>fileChannel</span> <span class=o>=</span> <span class=n>fileInputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span></code></pre></div><h3 id=32-文件通道>3.2 文件通道</h3><p>FileChannel 是一个连接到文件的通道，通过该通道可以完成文件的读写。另外 FileChannel 无法设置为非阻塞模式，因为对文件读写操作设置非阻塞并没有什么意义。FileChannel 的使用示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 示例：文件拷贝
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FileInputStream</span> <span class=n>inputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;D:\\a.png&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>FileOutputStream</span> <span class=n>outputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;D:\\b.png&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>inChannel</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>outChannel</span> <span class=o>=</span> <span class=n>outputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>256</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从输入channel中读取数据到buffer中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=o>(</span><span class=n>inChannel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 由写模式切换到读模式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//将buffer中的数据写出到输出channel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>outChannel</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>inputStream</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>outputStream</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>这里的最后我们只需要关闭 Stream 即可，其上的 Channel 也会被关闭，源码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>close</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>closeLock</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>closed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>closed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果channel不为空，则关闭
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=n>channel</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fd</span><span class=o>.</span><span class=na>closeAll</span><span class=o>(</span><span class=k>new</span> <span class=n>Closeable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>close</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           <span class=n>close0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>       <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=33-channel-to-channel>3.3 Channel To Channel</h3><p>在 Java NIO 中，如果两个 Channel 中有一个是 FileChannel，那么可以直接将数据从一个 Channel 传输到另外一个 Channel：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 将该通道上的数据直接传送到目标通道
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>transferTo</span><span class=o>(</span><span class=kt>long</span> <span class=n>position</span><span class=o>,</span> <span class=kt>long</span> <span class=n>count</span><span class=o>,</span> <span class=n>WritableByteChannel</span> <span class=n>target</span><span class=o>)</span> <span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 将原通道上的数据直接传送到该通道
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>transferFrom</span><span class=o>(</span><span class=n>ReadableByteChannel</span> <span class=n>src</span><span class=o>,</span> <span class=kt>long</span> <span class=n>position</span><span class=o>,</span> <span class=kt>long</span> <span class=n>count</span><span class=o>)</span>
</span></span></code></pre></div><p>还是以文件拷贝为例，使用示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FileInputStream</span> <span class=n>inputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;D:\\a.png&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>FileOutputStream</span> <span class=n>outputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;D:\\b.png&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>inChannel</span> <span class=o>=</span> <span class=n>inputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>outChannel</span> <span class=o>=</span> <span class=n>outputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>inChannel</span><span class=o>.</span><span class=na>transferTo</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span><span class=n>inChannel</span><span class=o>.</span><span class=na>size</span><span class=o>(),</span><span class=n>outChannel</span><span class=o>);</span>        <span class=c1>//使用transferTo实现
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// outChannel.transferFrom(inChannel, 0, inChannel.size()); //使用transferFrom实现
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>inputStream</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>outputStream</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=34-scattergather>3.4 Scatter/Gather</h3><p>Java NIO 支持 scatter 和 gather 操作：</p><ul><li><strong>分散 (scatter)</strong>：把 Channel 中的数据依次写入到多个 Buffer 上。示例如下：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer01</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>32</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer02</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>64</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer03</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span><span class=o>[]</span> <span class=n>buffers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuffer</span><span class=o>[]{</span><span class=n>buffer01</span><span class=o>,</span> <span class=n>buffer02</span><span class=o>,</span> <span class=n>buffer03</span><span class=o>};</span>
</span></span><span class=line><span class=cl><span class=n>fileInputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>().</span><span class=na>read</span><span class=o>(</span><span class=n>buffers</span><span class=o>);</span>
</span></span></code></pre></div><p>此时 Channel 中的数据会依次写入到 Buffer01， Buffer02， Buffer03 上。Scatter 通常用于固定长度数据的处理，假设一个数据单元由 header，body，footer 三部分组成，并且每部分的长度都是固定的，此时通过 Scatter 操作，每一组数据的 header，body，footer 都会分别固定地写到 Buffer01， Buffer02， Buffer03 上，此时就可以对每个 Buffer 应用不同的处理逻辑：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_scatter.png></div><ul><li><strong>聚集 (gather)</strong>：将多个 Buffer 中的数据依次写入到同一个 Channel 上。示例如下：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer01</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>32</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer02</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>64</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer03</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span><span class=o>[]</span> <span class=n>buffers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuffer</span><span class=o>[]{</span><span class=n>buffer01</span><span class=o>,</span> <span class=n>buffer02</span><span class=o>,</span> <span class=n>buffer03</span><span class=o>};</span>
</span></span><span class=line><span class=cl><span class=n>fileInputStream</span><span class=o>.</span><span class=na>getChannel</span><span class=o>().</span><span class=na>read</span><span class=o>(</span><span class=n>buffers</span><span class=o>);</span>
</span></span></code></pre></div><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_gather.png></div><h3 id=35-pipe>3.5 Pipe</h3><p>Java NIO 还提供了 Pipe 管道用于在不同线程之间传递数据：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_pipe.png></div><p>Pipe 管道可以通过 Pipe 类的静态方法 <code>open()</code> 来创建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Pipe</span> <span class=n>pipe</span> <span class=o>=</span> <span class=n>Pipe</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span></code></pre></div><p>创建完成后可以通过其 <code>sink()</code> 和 <code>source()</code> 方法来创建对应的 SinkChannel 和 SourceChannel：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Pipe</span><span class=o>.</span><span class=na>SinkChannel</span> <span class=n>sinkChannel</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=na>sink</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Pipe</span><span class=o>.</span><span class=na>SourceChannel</span> <span class=n>sourceChannel</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=na>source</span><span class=o>();</span>
</span></span></code></pre></div><p>SinkChannel 和 SourceChannel 的使用与基本的 Channel 类似，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Pipe</span> <span class=n>pipe</span> <span class=o>=</span> <span class=n>Pipe</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Pipe</span><span class=o>.</span><span class=na>SinkChannel</span> <span class=n>sink</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=na>sink</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;HelloWorld&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将数据写入SinkChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sink</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>sink</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Pipe</span><span class=o>.</span><span class=na>SourceChannel</span> <span class=n>source</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=na>source</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 读取SourceChannel中的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>source</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>((</span><span class=kt>char</span><span class=o>)</span> <span class=n>buffer</span><span class=o>.</span><span class=na>get</span><span class=o>());</span> <span class=c1>//输出：HelloWorld
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>source</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span></code></pre></div><h2 id=四selector>四、Selector</h2><h3 id=41-创建选择器>4.1 创建选择器</h3><p>想要创建一个选择器，可以通过 Selector 类的静态方法 <code>open()</code> 来实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span></code></pre></div><h3 id=42-注册通道>4.2 注册通道</h3><p>之后须要通过 <code>register()</code> 方法将 Channel 注册到 Selector 上，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建ServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocketChannel</span> <span class=n>serverChannel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 与 Selector一起使用的Channel必须处于非阻塞模式下
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>serverChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>serverChannel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>hostname</span><span class=o>,</span> <span class=n>port</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 注册监听CONNECT事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>serverChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span></code></pre></div><p><code>register()</code> 方法的第二个参数表示需要监听的事件，它有以下四个可选值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//读取事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>OP_READ</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>//写入事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>OP_WRITE</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>//连接事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>OP_CONNECT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>//接受连接事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>OP_ACCEPT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=o>;</span>
</span></span></code></pre></div><p>如果你需要监听多个事件，可以使用位操作符进行连接：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>interestSet</span> <span class=o>=</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span> <span class=o>|</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_WRITE</span><span class=o>;</span>
</span></span></code></pre></div><p>除此之外，你还可以在注册时通过调用 register 的另外一个重载方法来指定附加信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>register</span><span class=o>(</span><span class=n>Selector</span> <span class=n>sel</span><span class=o>,</span> <span class=kt>int</span> <span class=n>ops</span><span class=o>,</span> <span class=n>Object</span> <span class=n>att</span><span class=o>)</span>
</span></span></code></pre></div><p>这个附加信息可以在事件触发时通过 SelectionKey 对象再次得到。</p><h3 id=43-select>4.3 select</h3><p>当你在 Selector 上注册好通道后，就可以使用 <code>select()</code> 方法来获取处于就绪状态的事件的集合。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>select</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span></code></pre></div><p>select 有以下三个重载方法：</p><ul><li><strong>select()</strong>：持续阻塞，直到至少有一个通道在其注册的事件上处于就绪状态；</li><li><strong>select(long timeout)</strong>：与 <code>select()</code> 类似，但最长只阻塞 timout 毫秒；</li><li><strong>selectNow()</strong>：不会阻塞，如果不存在就绪事件，则直接返回 0。</li></ul><p>需要注意的是如果是 Ready 操作集发生了变化，select 操作的返回值也可能是 0。这意味着如果某个通道注册的是 <code>OP_READ</code> 事件，那么该通道在第一次收到消息时，select 操作返回的值是 1；但是之后收到消息时，select 的返回值却可能是 0。因此在循环获取消息时，对于 select 返回值的判断应该加上为 0 的情况：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如果选择器上存在就绪事件，则进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>while</span> <span class=o>(</span><span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>....</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=44-selectionkey>4.4 SelectionKey</h3><p>当注册的事件处于就绪状态时，可以通过 Selector 的 <code>selectedKeys()</code> 方法来获取处于就绪状态的事件信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>selectionKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span></code></pre></div><p>其返回的是 SelectionKey 的集合，SelectionKey 是对多个属性的综合封装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>SelectionKey</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SelectionKey对应的channel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=n>SelectableChannel</span> <span class=nf>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SelectionKey对应的选择器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=n>Selector</span> <span class=nf>selector</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前SelectionKey是否有效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>boolean</span> <span class=nf>isValid</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 取消channel在selector上注册的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>void</span> <span class=nf>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前channel注册的事件的合集
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>int</span> <span class=nf>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前channel是否对指定的事件感兴趣
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=n>SelectionKey</span> <span class=nf>interestOps</span><span class=o>(</span><span class=kt>int</span> <span class=n>ops</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 处于就绪状态的事件的合集
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>int</span> <span class=nf>readyOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Read事件是否就绪
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>isReadable</span><span class=o>()</span> <span class=o>{</span><span class=k>return</span> <span class=o>(</span><span class=n>readyOps</span><span class=o>()</span> <span class=o>&amp;</span> <span class=n>OP_READ</span><span class=o>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Write事件是否就绪
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>isWritable</span><span class=o>()</span> <span class=o>{</span><span class=k>return</span> <span class=o>(</span><span class=n>readyOps</span><span class=o>()</span> <span class=o>&amp;</span> <span class=n>OP_WRITE</span><span class=o>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Connect事件是否就绪
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>isConnectable</span><span class=o>()</span> <span class=o>{</span><span class=k>return</span> <span class=o>(</span><span class=n>readyOps</span><span class=o>()</span> <span class=o>&amp;</span> <span class=n>OP_CONNECT</span><span class=o>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Accept事件是否就绪
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>isAcceptable</span><span class=o>()</span> <span class=o>{</span><span class=k>return</span> <span class=o>(</span><span class=n>readyOps</span><span class=o>()</span> <span class=o>&amp;</span> <span class=n>OP_ACCEPT</span><span class=o>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 为SelectionKey指定附加属性，也可以在注册时通过register方法指定
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=n>Object</span> <span class=nf>attach</span><span class=o>(</span><span class=n>Object</span> <span class=n>ob</span><span class=o>)</span> <span class=o>{</span><span class=k>return</span> <span class=n>attachmentUpdater</span><span class=o>.</span><span class=na>getAndSet</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>ob</span><span class=o>);}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取附加属性
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>final</span> <span class=n>Object</span> <span class=nf>attachment</span><span class=o>()</span> <span class=o>{</span> <span class=k>return</span> <span class=n>attachment</span><span class=o>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=五聊天室实例>五、聊天室实例</h2><p>下面以一个群聊的聊天室为例，来展示 Java NIO 三大组件的综合使用，效果如下：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/nio_chat_group.png></div><h3 id=51-群聊服务器>5.1 群聊服务器</h3><p>群聊服务器的实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>chat</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.net.InetSocketAddress</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.ByteBuffer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.channels.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.charset.StandardCharsets</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Set</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>hostname</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>port</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Selector</span> <span class=n>selector</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ByteBuffer</span> <span class=n>rBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ByteBuffer</span> <span class=n>wBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ChatServer</span><span class=o>(</span><span class=kt>int</span> <span class=n>port</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>port</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ChatServer</span><span class=o>(</span><span class=n>String</span> <span class=n>hostname</span><span class=o>,</span> <span class=kt>int</span> <span class=n>port</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>hostname</span> <span class=o>=</span> <span class=n>hostname</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>port</span> <span class=o>=</span> <span class=n>port</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 创建ServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ServerSocketChannel</span> <span class=n>serverChannel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 设置为非阻塞模式
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>serverChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverChannel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>hostname</span><span class=o>,</span> <span class=n>port</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 创建selector
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 注册监听CONNECT事件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>serverChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 持续调用select()
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>selectionKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span><span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>:</span> <span class=n>selectionKeys</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 处理Accept事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 获取ServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>ServerSocketChannel</span> <span class=n>server</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 通过ServerSocketChannel获取SocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>SocketChannel</span> <span class=n>clientChannel</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>clientChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 注册Read事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>clientChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;欢迎&#34;</span> <span class=o>+</span> <span class=n>clientChannel</span><span class=o>.</span><span class=na>socket</span><span class=o>().</span><span class=na>getPort</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;加入聊天室！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 处理Readable事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>handleMessage</span><span class=o>(</span><span class=n>selectionKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>selectionKeys</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 关闭selector后，与之相关的所有资源都会被释放
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理客户端消息
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param selectionKey 处于Read状态的SelectionKey
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>SelectionKey</span> <span class=n>selectionKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SocketChannel</span> <span class=n>clientChannel</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取来自客户端的消息
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>StringBuilder</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>clientChannel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>rBuffer</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>rBuffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>rBuffer</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>rBuffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将消息发送给其他客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>broadcastMessage</span><span class=o>(</span><span class=n>clientChannel</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 该异常由clientChannel.read(rBuffer)方法抛出，如果出现该异常，则说明clientChannel已经关闭
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 此时需要调用cancel()取消注册在selector上的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selectionKey</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 在多线程环境下，如果另一个线程正在阻塞地调用select()，因为事件集已经改变，
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 因此需要通过wakeup()让其立刻返回并重新select()
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;用户&#34;</span> <span class=o>+</span> <span class=n>clientChannel</span><span class=o>.</span><span class=na>socket</span><span class=o>().</span><span class=na>getPort</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;退出聊天室！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 将客户端发来的消息广播给其他客户端
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param clientChannel 消息源
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg           消息
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>broadcastMessage</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>clientChannel</span><span class=o>,</span> <span class=n>String</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 遍历当前selector上所有channel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>:</span> <span class=n>selector</span><span class=o>.</span><span class=na>keys</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SelectableChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 消息不需要转发给ServerSocketChannel和当前客户端自己
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isValid</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!(</span><span class=n>channel</span> <span class=k>instanceof</span> <span class=n>ServerSocketChannel</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>channel</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>clientChannel</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SocketChannel</span> <span class=n>otherClient</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>wBuffer</span><span class=o>.</span><span class=na>put</span><span class=o>((</span><span class=s>&#34;用户&#34;</span> <span class=o>+</span> <span class=n>clientChannel</span><span class=o>.</span><span class=na>socket</span><span class=o>().</span><span class=na>getPort</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>).</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=o>(</span><span class=n>wBuffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>wBuffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>otherClient</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>wBuffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>wBuffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ChatServer</span><span class=o>(</span><span class=mi>8888</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=52-客户端实现>5.2 客户端实现</h3><p>客户端的实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>chat</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.net.InetSocketAddress</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.ByteBuffer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.channels.ClosedSelectorException</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.channels.SelectionKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.channels.Selector</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.channels.SocketChannel</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.charset.StandardCharsets</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Scanner</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Set</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>hostname</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>port</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Selector</span> <span class=n>selector</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ByteBuffer</span> <span class=n>rBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ByteBuffer</span> <span class=n>wBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ChatClient</span><span class=o>(</span><span class=n>String</span> <span class=n>hostname</span><span class=o>,</span> <span class=kt>int</span> <span class=n>port</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>hostname</span> <span class=o>=</span> <span class=n>hostname</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>port</span> <span class=o>=</span> <span class=n>port</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 创建SocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>SocketChannel</span> <span class=n>socketChannel</span> <span class=o>=</span> <span class=n>SocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>socketChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>socketChannel</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>hostname</span><span class=o>,</span> <span class=n>port</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 创建selector
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 注册监听CONNECT事件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>socketChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 持续调用select
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>selectionKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span><span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>:</span> <span class=n>selectionKeys</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 处理Connect事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isConnectable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>SocketChannel</span> <span class=n>clientChannel</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 有可能正处于连接中的状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>clientChannel</span><span class=o>.</span><span class=na>isConnectionPending</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 等待连接完成
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>clientChannel</span><span class=o>.</span><span class=na>finishConnect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 开始监听用户输入
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>inputListening</span><span class=o>(</span><span class=n>clientChannel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 为clientChannel注册上Read
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>clientChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;尊敬的用户&#34;</span> <span class=o>+</span> <span class=n>clientChannel</span><span class=o>.</span><span class=na>socket</span><span class=o>().</span><span class=na>getLocalPort</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                            <span class=o>+</span> <span class=s>&#34;, 你已成功加入群聊！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 处理Read事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>handleMessage</span><span class=o>(</span><span class=n>selectionKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClosedSelectorException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 主动关闭客户端，不做任何处理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 监听用户来自控制台的输入
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param clientChannel 客户端Channel
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>inputListening</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>clientChannel</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 要持续监听用户输入，但又不能阻塞主线程，所以需要一个单独的线程来完成
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=n>scanner</span><span class=o>.</span><span class=na>hasNextLine</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>String</span> <span class=n>input</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>input</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=s>&#34;exit&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>input</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>selector</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=n>wBuffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>input</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>wBuffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=k>while</span> <span class=o>(</span><span class=n>wBuffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>clientChannel</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>wBuffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=n>wBuffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理来自其他客户端的消息
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param selectionKey 处于Read状态的selectionKey
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>handleMessage</span><span class=o>(</span><span class=n>SelectionKey</span> <span class=n>selectionKey</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>rBuffer</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>rBuffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>rBuffer</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>rBuffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>selectionKey</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;聊天室服务器已关闭！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ChatClient</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=mi>8888</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=参考资料>参考资料</h2><ul><li><a href=https://book.douban.com/subject/1433583/ target=_blank rel=noopener>Ron Hitchens . Java NIO . O&rsquo;Reilly Media . 2002-08-15</a></li><li><a href=http://tutorials.jenkov.com/java-nio/index.html target=_blank rel=noopener>Java NIO Tutorial</a></li><li><a href="https://baijiahao.baidu.com/s?id=1632673729522644150&wfr=spider&for=pc" target=_blank rel=noopener>一文读懂 Java NIO 和 IO 的不同</a></li></ul></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>