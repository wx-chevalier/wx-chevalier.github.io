<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="近年来，开源的分布式流处理系统层出不穷，引起了广泛的关注与讨论。其中的先行者，譬如 Apache Storm提供了低延迟的流式处理功能，但是受限于 at-least-once 的投递保证，背压等不太良好的处理以及相对而言的开放 API 的底层化。不过"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/table-api/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/table-api/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/table-api/"><meta property="og:title" content="Table API | Next-gen Tech Edu"><meta property="og:description" content="近年来，开源的分布式流处理系统层出不穷，引起了广泛的关注与讨论。其中的先行者，譬如 Apache Storm提供了低延迟的流式处理功能，但是受限于 at-least-once 的投递保证，背压等不太良好的处理以及相对而言的开放 API 的底层化。不过"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>Table API | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=9efa8cc385c13d4f01b589f12617e53d><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">Flink</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id4f508d0c46b0dee1c344bf9acee745ea")' href=#id4f508d0c46b0dee1c344bf9acee745ea aria-expanded=false aria-controls=id4f508d0c46b0dee1c344bf9acee745ea aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/>流处理</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id4f508d0c46b0dee1c344bf9acee745ea aria-expanded=false aria-controls=id4f508d0c46b0dee1c344bf9acee745ea><i class="fa-solid fa-angle-down" id=caret-id4f508d0c46b0dee1c344bf9acee745ea></i></a></div><ul class="nav docs-sidenav collapse show" id=id4f508d0c46b0dee1c344bf9acee745ea><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id331e95dadbf6ef4552bd1638371f2211")' href=#id331e95dadbf6ef4552bd1638371f2211 aria-expanded=false aria-controls=id331e95dadbf6ef4552bd1638371f2211 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/beam/>Beam</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id331e95dadbf6ef4552bd1638371f2211 aria-expanded=false aria-controls=id331e95dadbf6ef4552bd1638371f2211><i class="fa-solid fa-angle-right" id=caret-id331e95dadbf6ef4552bd1638371f2211></i></a></div><ul class="nav docs-sidenav collapse" id=id331e95dadbf6ef4552bd1638371f2211><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/beam/dataflow-%E6%A8%A1%E5%9E%8B/>Dataflow 模型</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/beam/%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE/>部署与配置</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/beam/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>快速开始</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id1a6b42717cf537d448e1935010e7489b")' href=#id1a6b42717cf537d448e1935010e7489b aria-expanded=false aria-controls=id1a6b42717cf537d448e1935010e7489b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/dag/>DAG</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id1a6b42717cf537d448e1935010e7489b aria-expanded=false aria-controls=id1a6b42717cf537d448e1935010e7489b><i class="fa-solid fa-angle-right" id=caret-id1a6b42717cf537d448e1935010e7489b></i></a></div><ul class="nav docs-sidenav collapse" id=id1a6b42717cf537d448e1935010e7489b><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/dag/dryad/>Dryad</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id07f143c2e811b0acd2b5892acf9ecb7d")' href=#id07f143c2e811b0acd2b5892acf9ecb7d aria-expanded=false aria-controls=id07f143c2e811b0acd2b5892acf9ecb7d aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/>Flink</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id07f143c2e811b0acd2b5892acf9ecb7d aria-expanded=false aria-controls=id07f143c2e811b0acd2b5892acf9ecb7d><i class="fa-solid fa-angle-down" id=caret-id07f143c2e811b0acd2b5892acf9ecb7d></i></a></div><ul class="nav docs-sidenav collapse show" id=id07f143c2e811b0acd2b5892acf9ecb7d><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3adb58b632cf98a1c5c2f2d654b8602b")' href=#id3adb58b632cf98a1c5c2f2d654b8602b aria-expanded=false aria-controls=id3adb58b632cf98a1c5c2f2d654b8602b aria-hidden=false data-toggle=collapse></div></div><li class="child level active"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/table-api/>Table API</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91/>代码开发</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>快速开始</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idb5f061bea83aa26b12688099e1966944")' href=#idb5f061bea83aa26b12688099e1966944 aria-expanded=false aria-controls=idb5f061bea83aa26b12688099e1966944 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/spark/>Spark</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idb5f061bea83aa26b12688099e1966944 aria-expanded=false aria-controls=idb5f061bea83aa26b12688099e1966944><i class="fa-solid fa-angle-right" id=caret-idb5f061bea83aa26b12688099e1966944></i></a></div><ul class="nav docs-sidenav collapse" id=idb5f061bea83aa26b12688099e1966944><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/spark/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91/>代码开发</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/spark/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/>环境配置</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id36502913f9e0cc832b61a9e0eedee8ea")' href=#id36502913f9e0cc832b61a9e0eedee8ea aria-expanded=false aria-controls=id36502913f9e0cc832b61a9e0eedee8ea aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B/>编程模型</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id36502913f9e0cc832b61a9e0eedee8ea aria-expanded=false aria-controls=id36502913f9e0cc832b61a9e0eedee8ea><i class="fa-solid fa-angle-right" id=caret-id36502913f9e0cc832b61a9e0eedee8ea></i></a></div><ul class="nav docs-sidenav collapse" id=id36502913f9e0cc832b61a9e0eedee8ea><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B/%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3/>时间窗口</a></li></ul></div><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%B5%81%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94/>流计算框架对比</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id693044f61492b137cc370180b124182d")' href=#id693044f61492b137cc370180b124182d aria-expanded=false aria-controls=id693044f61492b137cc370180b124182d aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/>执行框架</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id693044f61492b137cc370180b124182d aria-expanded=false aria-controls=id693044f61492b137cc370180b124182d><i class="fa-solid fa-angle-right" id=caret-id693044f61492b137cc370180b124182d></i></a></div><ul class="nav docs-sidenav collapse" id=id693044f61492b137cc370180b124182d><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/%E5%8F%8D%E5%8E%8B/>反压</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BF%AB%E7%85%A7/>分布式快照</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/%E6%B5%81%E5%BC%8F%E8%BF%9E%E6%8E%A5/>流式连接</a></li><li class="child level"><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/%E5%AE%B9%E9%94%99/>容错</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#从何开始先来回顾下已有的-table-api>从何开始，先来回顾下已有的 Table API</a></li><li><a href=#table-api-joining-forces-with-sql>Table API joining forces with SQL</a></li><li><a href=#how-will-flinks-sql-on-streams-look-like>How will Flink’s SQL on streams look like?</a><ul><li><a href=#sql-following-the-syntax-proposal-of-calcites-streaming-sql-document>SQL (following the syntax proposal of Calcite’s streaming SQL document)</a></li><li><a href=#table-api>Table API</a></li></ul></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>Table API</h1><div class=article-style><p>近年来，开源的分布式流处理系统层出不穷，引起了广泛的关注与讨论。其中的先行者，譬如 <a href=https://storm.apache.org/ target=_blank rel=noopener>Apache Storm</a>提供了低延迟的流式处理功能，但是受限于 at-least-once 的投递保证，背压等不太良好的处理以及相对而言的开放 API 的底层化。不过 Storm 也起到了抛砖引玉的作用，自此之后，很多新的流处理系统在不同的维度上大放光彩。今日，Apache Flink 或者 <a href=https://beam.incubator.apache.org/ target=_blank rel=noopener>Apache Beam</a>的使用者能够使用流式的 Scala 或者 Java APIs 来进行流处理任务，同时保证了 exactly-once 的投递机制以及高吞吐情况下的的低延迟响应。与此同时，流处理也在产界得到了应用，从 Apache Kafka 与 Apache Flink 在流处理的基础设施领域的大规模部署也折射除了流处理在产界的快速发展。与日俱增的实时数据流催生了开发人员或者分析人员对流数据进行分析以及实时展现的需求。不过，流数据分析也需要一些必备的技能与知识储备，譬如无限流的基本特性、窗口、时间以及状态等等，这些概念都会在利用 Java 或者 Scala API 来完成一个流分析的任务时候起到很大的作用。
大概六个月之前，Apache Flink 社区着手为流数据分析系统引入一个 SQL 交互功能。众所周知，SQL 是访问与处理数据的标准语言，基本上每个用过数据库的或者进行或数据分析的都对 SQL 不陌生。鉴于此，为流处理系统添加一个 SQL 交互接口能够有效地扩大该技术的受用面，让更多的人可以熟悉并且使用。除此之外，引入 SQL 的支持还能满足于一些需要实时交互地用户场景，大大简化一些需要进行流操作或者转化的应用代码。这篇文章中，我们会从现有的状态、架构的设计以及未来 Apache Flink 社区准备添加 SQL 支持的计划这几个方面进行讨论。</p><h2 id=从何开始先来回顾下已有的-table-api>从何开始，先来回顾下已有的 Table API</h2><p>在 <a href=http://flink.apache.org/news/2015/04/13/release-0.9.0-milestone1.html target=_blank rel=noopener>0.9.0-milestone1</a> 发布之后，Apache Flink 添加了所谓的 Table API 来提供类似于 SQL 的表达式用于对关系型数据进行处理。这系列 API 的操作对象就是抽象而言的能够进行关系型操作的结构化数据或者流。Table API 一般与 DataSet 或者 DataStream 紧密关联，可以从 DataSet 或者 DataStream 来方便地创建一个 Table 对象，也可以用如下的操作将一个 Table 转化回一个 DataSet 或者 DataStream 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>execEnv</span> <span class=k>=</span> <span class=nc>ExecutionEnvironment</span><span class=o>.</span><span class=n>getExecutionEnvironment</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>tableEnv</span> <span class=k>=</span> <span class=nc>TableEnvironment</span><span class=o>.</span><span class=n>getTableEnvironment</span><span class=o>(</span><span class=n>execEnv</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// obtain a DataSet from somewhere
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>tempData</span><span class=k>:</span> <span class=kt>DataSet</span><span class=o>[(</span><span class=kt>String</span>, <span class=kt>Long</span>, <span class=kt>Double</span><span class=o>)]</span> <span class=k>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// convert the DataSet to a Table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>tempTable</span><span class=k>:</span> <span class=kt>Table</span> <span class=o>=</span> <span class=n>tempData</span><span class=o>.</span><span class=n>toTable</span><span class=o>(</span><span class=n>tableEnv</span><span class=o>,</span> &#39;location<span class=o>,</span> &#39;time<span class=o>,</span> &#39;tempF<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// compute your result
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>avgTempCTable</span><span class=k>:</span> <span class=kt>Table</span> <span class=o>=</span> <span class=n>tempTable</span>
</span></span><span class=line><span class=cl> <span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;location<span class=o>.</span><span class=n>like</span><span class=o>(</span><span class=s>&#34;room%&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl> <span class=o>.</span><span class=n>select</span><span class=o>(</span>
</span></span><span class=line><span class=cl>   <span class=o>(</span>&#39;time <span class=o>/</span> <span class=o>(</span><span class=mi>3600</span> <span class=o>*</span> <span class=mi>24</span><span class=o>))</span> <span class=n>as</span> &#39;day<span class=o>,</span>
</span></span><span class=line><span class=cl>   &#39;Location <span class=n>as</span> &#39;room<span class=o>,</span>
</span></span><span class=line><span class=cl>   <span class=o>((</span>&#39;tempF <span class=o>-</span> <span class=mi>32</span><span class=o>)</span> <span class=o>*</span> <span class=mf>0.556</span><span class=o>)</span> <span class=n>as</span> &#39;tempC
</span></span><span class=line><span class=cl>  <span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=o>.</span><span class=n>groupBy</span><span class=o>(</span>&#39;day<span class=o>,</span> &#39;room<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=o>.</span><span class=n>select</span><span class=o>(</span>&#39;day<span class=o>,</span> &#39;room<span class=o>,</span> &#39;tempC<span class=o>.</span><span class=n>avg</span> <span class=n>as</span> &#39;avgTempC<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// convert result Table back into a DataSet and print it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>avgTempCTable</span><span class=o>.</span><span class=n>toDataSet</span><span class=o>[</span><span class=kt>Row</span><span class=o>].</span><span class=n>print</span><span class=o>()</span>
</span></span></code></pre></div><p>上面这坨代码是 Scala 的，不过你可以简单地用 Java 版本的 Table API 进行实现，下面这张图就展示了 Table API 的原始的结构：<figure><div class="d-flex justify-content-center"><div class=w-100><img src=http://flink.apache.org/img/blog/stream-sql/old-table-api.png alt loading=lazy data-zoomable></div></div></figure>在我们从 DataSet 或者 DataStream 创建了 Table 之后，可以利用类似于<code>filter</code>, <code>join</code>, 或者 <code>select</code>关系型转化操作来转化为一个新的 Table 对象。而从内部实现上来说，所有应用于 Table 的转化操作都会变成一棵逻辑表操作树，在 Table 对象被转化回 DataSet 或者 DataStream 之后，专门的转化器会将这棵逻辑操作符树转化为对等的 DataSet 或者 DataStream 操作符。譬如<code>'location.like("room%")</code>这样的表达式会经由代码生成编译为 Flink 中的函数。
不过，老版本的 Table API 还是有很多的限制的。首先，Table API 并不能单独使用，而必须嵌入到 DataSet 或者 DataStream 的程序中，对于批处理表的查询并不支持外连接、排序以及其他很多在 SQL 中经常使用的扩展操作。而流处理表中只支持譬如 filters、union 以及 projections，不能支持 aggregations 以及 joins。并且，这个转化处理过程并不能有查询优化，你要优化的话还是要去参考那些对于 DataSet 操作的优化。</p><h2 id=table-api-joining-forces-with-sql>Table API joining forces with SQL</h2><p>关于是否需要添加 SQL 支持的讨论之前就在 Flink 社区中发生过几次，Flink 0.9 发布之后，Table API、关系表达式的代码生成工具以及运行时的操作符等都预示着添加 SQL 支持的很多基础已经具备，可以考虑进行添加了。不过另一方面，在整个 Hadoop 生态链里已经存在了大量的所谓“SQL-on-Hadoop”的解决方案，譬如<a href=https://hive.apache.org/ target=_blank rel=noopener>Apache Hive</a>, <a href=https://drill.apache.org/ target=_blank rel=noopener>Apache Drill</a>, <a href=http://impala.io/ target=_blank rel=noopener>Apache Impala</a>, <a href=https://tajo.apache.org/ target=_blank rel=noopener>Apache Tajo</a>，在已经有了这么多的可选方案的情况下，我们觉得应该优先提升 Flink 其他方面的特性，于是就暂时搁置了 SQL-on-Hadoop 的开发。
不过，随着流处理系统的日渐火热以及 Flink 受到的越来越广泛地应用，我们发现有必要为用户提供一个更简单的可以用于数据分析的接口。大概半年前，我们决定要改造下 Table API，扩展其对于流处理的能力并且最终完成在流处理上的 SQL 支持。不过我们也不打算重复造轮子，因此打算基于<a href=https://calcite.apache.org/ target=_blank rel=noopener>Apache Calcite</a>这个非常流行的 SQL 解析器进行重构操作。Calcite 在其他很多开源项目里也都应用到了，譬如 Apache Hive, Apache Drill, Cascading, and many <a href=https://calcite.apache.org/docs/powered_by.html target=_blank rel=noopener>more</a>。此外，Calcite 社区本身也有将<a href=https://calcite.apache.org/docs/stream.html target=_blank rel=noopener>SQL on streams</a>列入到它们的路线图中，因此我们一拍即合。Calcite 在新的架构设计中的地位大概如下所示:<figure><div class="d-flex justify-content-center"><div class=w-100><img src=http://flink.apache.org/img/blog/stream-sql/new-table-api.png alt loading=lazy data-zoomable></div></div></figure>新的架构主要是将 Table API 与 SQL 集成起来，用这两货的 API 构建的查询最终都会转化到 Calcite 的所谓的 logicl plans 表述。转化之后的流查询与批查询基本上差不多，然后 Calcite 的优化器会基于转化和优化规则来优化这些 logical plans，针对数据源(流还是静态数据)的不同我们会应用不同的规则。最后，经过优化的 logical plan 会转化为一个普通的 Flink DataStream 或者 DataSet 对象，即还是利用代码生成来将关系型表达式编译为 Flink 的函数。
新的架构继续提供了 Table API 并且在此基础上进行了很大的提升，它为流数据与关系型数据提供了统一的查询接口。另外，我们利用了 Calcite 的查询优化框架与 SQL 解释器来进行了查询优化。不过，因为这些设计都还是基于 Flink 的已有的 API，譬如 DataStream API 提供的低延迟、高吞吐以及 exactly-once 投递的功能，以及 DataSet API 通过的健壮与高效的内存级别的操作器与管道式的数据交换，任何对于 Flink 核心 API 的提升都能够自动地提升 Table API 或者 SQL 查询的效率。
在这些工作之后，Flink 就已经具备了同时对于流数据与静态数据的 SQL 支持。不过，我们并不想把这个当成一个高效的 SQL-on-Hadoop 的解决方案，就像 Impala, Drill, 以及 Hive 那样的角色，我们更愿意把它当成为流处理提供便捷的交互接口的方案。另外，这套机制还能促进同时用了 Flink API 与 SQL 的应用的性能。</p><h2 id=how-will-flinks-sql-on-streams-look-like>How will Flink’s SQL on streams look like?</h2><p>我们讨论了为啥要重构 Flink 的流 SQL 接口的原因以及大概怎么去完成这个任务，现在我们讨论下最终的 API 或者使用方式会是啥样的。新的 SQL 接口会集成到 Table API 中。DataStreams、DataSet 以及额外的数据源都会先在 TableEnvironment 中注册成一个 Table 然后再进行 SQL 操作。<code>TableEnvironment.sql()</code>方法会允许你输入 SQL 查询语句然后执行返回一个新的 Table，下面这个例子就展示了一个完整的从 JSON 编码的 Kafka 主题中读取数据然后利用 SQL 查询进行处理最终写入另一个 Kafka 主题的模型。注意，这下面提到的 KafkaJsonSource 与 KafkaJsonSink 都还未发布，未来的话 TableSource 与 TableSinks 都会固定提供，这样可以减少很多的模板代码。</p><pre tabindex=0><code>// get environments
val execEnv = StreamExecutionEnvironment.getExecutionEnvironment
val tableEnv = TableEnvironment.getTableEnvironment(execEnv)

// configure Kafka connection
val kafkaProps = ...
// define a JSON encoded Kafka topic as external table
val sensorSource = new KafkaJsonSource[(String, Long, Double)](
    &#34;sensorTopic&#34;,
    kafkaProps,
    (&#34;location&#34;, &#34;time&#34;, &#34;tempF&#34;))

// register external table
tableEnv.registerTableSource(&#34;sensorData&#34;, sensorSource)

// define query in external table
val roomSensors: Table = tableEnv.sql(
    &#34;SELECT STREAM time, location AS room, (tempF - 32) * 0.556 AS tempC &#34; +
    &#34;FROM sensorData &#34; +
    &#34;WHERE location LIKE &#39;room%&#39;&#34;
  )

// define a JSON encoded Kafka topic as external sink
val roomSensorSink = new KafkaJsonSink(...)

// define sink for room sensor data and execute query
roomSensors.toSink(roomSensorSink)
execEnv.execute()
</code></pre><p>你可能会发现上面这个例子中没有体现流处理中两个重要的方面：基于窗口的聚合与关联。下面我就会解释下怎么在 SQL 中表达关于窗口的操作。Apache Calcite 社区关于这方面已经有所讨论：<a href=https://calcite.apache.org/docs/stream.html target=_blank rel=noopener>SQL on streams</a>。Calcite 的流 SQL 被认为是一个标准 SQL 的扩展，而不是另一个类似于 SQL 的语言。这会有几个方面的好处，首先，已经熟悉了标准 SQL 语法的同学就没必要花时间再学一波新的语法了，皆大欢喜。现在对于静态表与流数据的查询已经基本一致了，可以很方便地进行转换。Flink 一直主张的是批处理只是流处理的一个特殊情况，因此用户也可以同时在静态表与流上进行查询，譬如处理有限的流。最后，未来也会有很多工具支持进行标准的 SQL 进行数据分析。
尽管我们还没有完全地定义好在 Flink SQL 表达式与 Table API 中如何进行窗口等设置，下面这个简单的例子会指明如何在 SQL 与 Table API 中进行滚动窗口式查询：</p><h3 id=sql-following-the-syntax-proposal-of-calcites-streaming-sql-document>SQL (following the syntax proposal of Calcite’s streaming SQL document)</h3><pre tabindex=0><code>SELECT STREAM
  TUMBLE_END(time, INTERVAL &#39;1&#39; DAY) AS day,
  location AS room,
  AVG((tempF - 32) * 0.556) AS avgTempC
FROM sensorData
WHERE location LIKE &#39;room%&#39;
GROUP BY TUMBLE(time, INTERVAL &#39;1&#39; DAY), location
</code></pre><h3 id=table-api>Table API</h3><pre tabindex=0><code>val avgRoomTemp: Table = tableEnv.ingest(&#34;sensorData&#34;)
  .where(&#39;location.like(&#34;room%&#34;))
  .partitionBy(&#39;location)
  .window(Tumbling every Days(1) on &#39;time as &#39;w)
  .select(&#39;w.end, &#39;location,, ((&#39;tempF - 32) * 0.556).avg as &#39;avgTempCs)
</code></pre></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/distributedcompute-series/%E6%B5%81%E5%A4%84%E7%90%86/flink/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91/ rel=prev>代码开发</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>