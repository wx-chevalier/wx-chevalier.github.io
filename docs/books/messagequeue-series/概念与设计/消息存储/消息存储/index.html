<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="消息中间件中的数据存储 顺序读写 消息系统数据持久化一般采用为每个消费者队列提供一个 B 树或其他通用的随机访问数据结构来维护消息的元数据，B 树操作的时间复杂度为 O(log n)，O(log n)的时间复杂度可以看成是一"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/"><meta property="og:title" content="消息存储 | Next-gen Tech Edu"><meta property="og:description" content="消息中间件中的数据存储 顺序读写 消息系统数据持久化一般采用为每个消费者队列提供一个 B 树或其他通用的随机访问数据结构来维护消息的元数据，B 树操作的时间复杂度为 O(log n)，O(log n)的时间复杂度可以看成是一"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>消息存储 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=5c207600bce3b379bcda87b3e6dba7df><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">消息存储</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id7e209e01ec7322180c01ec21cdf25b4b")' href=#id7e209e01ec7322180c01ec21cdf25b4b aria-expanded=false aria-controls=id7e209e01ec7322180c01ec21cdf25b4b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/>概念与设计</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id7e209e01ec7322180c01ec21cdf25b4b aria-expanded=false aria-controls=id7e209e01ec7322180c01ec21cdf25b4b><i class="fa-solid fa-angle-down" id=caret-id7e209e01ec7322180c01ec21cdf25b4b></i></a></div><ul class="nav docs-sidenav collapse show" id=id7e209e01ec7322180c01ec21cdf25b4b><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id69008f83f4d2bdd9a3175304e0a35e1c")' href=#id69008f83f4d2bdd9a3175304e0a35e1c aria-expanded=false aria-controls=id69008f83f4d2bdd9a3175304e0a35e1c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/1.%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/>1.背景与价值</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id69008f83f4d2bdd9a3175304e0a35e1c aria-expanded=false aria-controls=id69008f83f4d2bdd9a3175304e0a35e1c><i class="fa-solid fa-angle-right" id=caret-id69008f83f4d2bdd9a3175304e0a35e1c></i></a></div><ul class="nav docs-sidenav collapse" id=id69008f83f4d2bdd9a3175304e0a35e1c><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/1.%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E9%80%9A%E7%94%A8%E6%A6%82%E5%BF%B5/>通用概念</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/1.%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E7%9A%84%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8F/>消息传递的不同方式</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/1.%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/>消息队列的应用场景</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idc00eb772f70d81750925c7c9d1827081")' href=#idc00eb772f70d81750925c7c9d1827081 aria-expanded=false aria-controls=idc00eb772f70d81750925c7c9d1827081 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/>2.消息生产与消费</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idc00eb772f70d81750925c7c9d1827081 aria-expanded=false aria-controls=idc00eb772f70d81750925c7c9d1827081><i class="fa-solid fa-angle-right" id=caret-idc00eb772f70d81750925c7c9d1827081></i></a></div><ul class="nav docs-sidenav collapse" id=idc00eb772f70d81750925c7c9d1827081><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF/>顺序消息</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E9%98%B2%E4%B8%A2%E5%A4%B1/>消息防丢失</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B%E5%A4%84%E7%90%86/>消息积压处理</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B/>消息消费模型</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/2.%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E9%87%8D%E5%A4%8D%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/>重复消息处理</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2191dcef30b017f4a860bca0488913bf")' href=#id2191dcef30b017f4a860bca0488913bf aria-expanded=false aria-controls=id2191dcef30b017f4a860bca0488913bf aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/3.%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/>3.消息存储</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id2191dcef30b017f4a860bca0488913bf aria-expanded=false aria-controls=id2191dcef30b017f4a860bca0488913bf><i class="fa-solid fa-angle-right" id=caret-id2191dcef30b017f4a860bca0488913bf></i></a></div><ul class="nav docs-sidenav collapse" id=id2191dcef30b017f4a860bca0488913bf><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/3.%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E5%88%86%E5%8C%BA%E6%97%A5%E5%BF%97/>分区日志</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/3.%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/>消息存储</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idbe96c9d80ce8e605b82dd2fd34cbb906")' href=#idbe96c9d80ce8e605b82dd2fd34cbb906 aria-expanded=false aria-controls=idbe96c9d80ce8e605b82dd2fd34cbb906 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/4.%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/>4.开源系统对比</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idbe96c9d80ce8e605b82dd2fd34cbb906 aria-expanded=false aria-controls=idbe96c9d80ce8e605b82dd2fd34cbb906><i class="fa-solid fa-angle-right" id=caret-idbe96c9d80ce8e605b82dd2fd34cbb906></i></a></div><ul class="nav docs-sidenav collapse" id=idbe96c9d80ce8e605b82dd2fd34cbb906><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/4.%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/%E5%8A%9F%E8%83%BD%E5%AF%B9%E6%AF%94/>功能对比</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/4.%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/>性能对比</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id9e89310aaa0c3127f51e7ae6fc2d3a3b")' href=#id9e89310aaa0c3127f51e7ae6fc2d3a3b aria-expanded=false aria-controls=id9e89310aaa0c3127f51e7ae6fc2d3a3b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/>背景与价值</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id9e89310aaa0c3127f51e7ae6fc2d3a3b aria-expanded=false aria-controls=id9e89310aaa0c3127f51e7ae6fc2d3a3b><i class="fa-solid fa-angle-right" id=caret-id9e89310aaa0c3127f51e7ae6fc2d3a3b></i></a></div><ul class="nav docs-sidenav collapse" id=id9e89310aaa0c3127f51e7ae6fc2d3a3b><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E9%80%9A%E7%94%A8%E6%A6%82%E5%BF%B5/>通用概念</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E7%9A%84%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8F/>消息传递的不同方式</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%B7%E5%80%BC/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/>消息队列的应用场景</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id1b16b4b3f5ac37e76efb25c9149506b4")' href=#id1b16b4b3f5ac37e76efb25c9149506b4 aria-expanded=false aria-controls=id1b16b4b3f5ac37e76efb25c9149506b4 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/>开源系统对比</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id1b16b4b3f5ac37e76efb25c9149506b4 aria-expanded=false aria-controls=id1b16b4b3f5ac37e76efb25c9149506b4><i class="fa-solid fa-angle-right" id=caret-id1b16b4b3f5ac37e76efb25c9149506b4></i></a></div><ul class="nav docs-sidenav collapse" id=id1b16b4b3f5ac37e76efb25c9149506b4><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/%E5%8A%9F%E8%83%BD%E5%AF%B9%E6%AF%94/>功能对比</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E5%BC%80%E6%BA%90%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%AF%94/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/>性能对比</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id795e41ba2cb11f6ed4a554d49c4d799f")' href=#id795e41ba2cb11f6ed4a554d49c4d799f aria-expanded=false aria-controls=id795e41ba2cb11f6ed4a554d49c4d799f aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/>消息存储</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id795e41ba2cb11f6ed4a554d49c4d799f aria-expanded=false aria-controls=id795e41ba2cb11f6ed4a554d49c4d799f><i class="fa-solid fa-angle-down" id=caret-id795e41ba2cb11f6ed4a554d49c4d799f></i></a></div><ul class="nav docs-sidenav collapse show" id=id795e41ba2cb11f6ed4a554d49c4d799f><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E5%88%86%E5%8C%BA%E6%97%A5%E5%BF%97/>分区日志</a></li><li class="child level active"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/>消息存储</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3223b1b4646b8b01e833fa826c8a45c7")' href=#id3223b1b4646b8b01e833fa826c8a45c7 aria-expanded=false aria-controls=id3223b1b4646b8b01e833fa826c8a45c7 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/>消息生产与消费</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id3223b1b4646b8b01e833fa826c8a45c7 aria-expanded=false aria-controls=id3223b1b4646b8b01e833fa826c8a45c7><i class="fa-solid fa-angle-right" id=caret-id3223b1b4646b8b01e833fa826c8a45c7></i></a></div><ul class="nav docs-sidenav collapse" id=id3223b1b4646b8b01e833fa826c8a45c7><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF/>顺序消息</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E9%98%B2%E4%B8%A2%E5%A4%B1/>消息防丢失</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B%E5%A4%84%E7%90%86/>消息积压处理</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B/>消息消费模型</a></li><li class="child level"><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E4%B8%8E%E6%B6%88%E8%B4%B9/%E9%87%8D%E5%A4%8D%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/>重复消息处理</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#wal>WAL</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>消息存储</h1><div class=article-style><h1 id=消息中间件中的数据存储>消息中间件中的数据存储</h1><h1 id=顺序读写>顺序读写</h1><p>消息系统数据持久化一般采用为每个消费者队列提供一个 B 树或其他通用的随机访问数据结构来维护消息的元数据，B 树操作的时间复杂度为 O(log n)，O(log n)的时间复杂度可以看成是一个常量时间，而且 B 树可以支持各种各样的事务性和非事务性语义消息的传递。尽管 B 树具有这些优点，但这并不适合磁盘操作。目前的磁盘寻道时间一般在 10ms 以内，对一块磁盘来说，在同一时刻只能有一个磁头来读写磁盘，这样在并发 IO 能力上就有问题。同时，对树结构性能的观察结果表明：其性能会随着数据的增长而线性下降。鉴于消息系统本身的作用考虑，数据的持久化队列可以建立在简单地对文件进行追加的实现方案上。</p><p>操作系统每次从磁盘读写数据的时候，需要先寻址，也就是先要找到数据在磁盘上的物理位置，然后再进行数据读写。如果是机械硬盘，这个寻址需要比较长的时间，因为它要移动磁头，这是个机械运动，机械硬盘工作的时候会发出咔咔的声音，就是移动磁头发出的声音。顺序读写相比随机读写省去了大部分的寻址时间，它只要寻址一次，就可以连续地读写下去，所以说，性能要比随机读写要好很多。</p><p>以 Kafka 为例，因为是顺序追加，所以 Kafka 在设计上是采用时间复杂度 O(1)的磁盘结构，它提供了常量时间的性能，即使是存储海量的信息(TB 级)也如此，性能和数据的大小关系也不大，同时 Kafka 将数据持久化到磁盘上，这样只要磁盘空间足够大数据就可以一直追加，而不会像一般的消息系统在消息被消费后就删除掉，Kafka 提供了相关配置让用户自己决定消息要保存多久，这样为消费者提供了更灵活的处理方式，因此 Kafka 能够在没有性能损失的情况下提供一般消息系统不具备的特性。</p><h2 id=wal>WAL</h2><p>包括数据库内很多的具有持久化能力的中间件都会采用 WAL，Writing Ahead Log 策略来保证数据的安全性与一致性。从客户端获取到的数据往往是会被首先写入到类似于 Commit Log 这样的文件中，该文件是实时顺序追加写入的。当系统发生了某些异常的崩溃后，即可以从这样的 Commit Log 中进行数据恢复。在写入 Commit Log 之后，数据或者对于数据的描述信息才会被写入到实际的表或分区文件中。数据文件往往采用异步刷盘的策略，而刷盘的时候也是依据时间或者数据的策略：</p><ul><li><p>Flush driven by timer: There is a backend timer which flushes data in cache periodically to disks. The period is configurable via parameter commitTime in system configuration file taos.cfg.</p></li><li><p>Flush driven by data: Data in the cache is also flushed to disks when the left buffer size is below a threshold. Flush driven by data can reset the timer of flush driven by the timer.</p></li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://tva3.sinaimg.cn/large/007DFXDhgy1g50s4k8hdvj30h4072t90.jpg alt loading=lazy data-zoomable></div></div></figure></p><h1 id=flush>Flush</h1><h1 id=kafka-与-pulsar-存储对比>Kafka 与 Pulsar 存储对比</h1><p>Apache Kafka 和 Apache Pulsar 都有类似的消息概念。客户端通过主题与消息系统进行交互。每个主题都可以分为多个分区。然而，Apache Pulsar 和 Apache Kafka 之间的根本区别在于 Apache Kafka 是以分区为存储中心，而 Apache Pulsar 是以 Segment 为存储中心。</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://user-images.githubusercontent.com/5803001/50600083-f3fb9c80-0eea-11e9-999d-b9e511f03edd.png alt=image loading=lazy data-zoomable></div></div></figure></p><p>在 Apache Kafka 中，分区只能存储在单个节点上并复制到其他节点，其容量受最小节点容量的限制。这意味着容量扩展需要对分区重新平衡，这反过来又需要重新复制整个分区，以平衡新添加的代理的数据和流量。重新传输数据非常昂贵且容易出错，并且会消耗网络带宽和 IO。维护人员在执行此操作时必须非常小心，以避免破坏生产系统。</p><p>Kafka 中分区数据的重新拷贝不仅发生在以分区为中心的系统中的群集扩展上。许多其他事情也会触发数据重新拷贝，例如副本故障，磁盘故障或计算机的故障。在数据重新复制期间，分区通常不可用，直到数据重新复制完成。例如，如果您将分区配置为存储为 3 个副本，这时，如果丢失了一个副本，则必须重新复制完整个分区后，分区才可以再次可用。</p><p>在用户遇到故障之前，通常会忽略这种缺陷，因为许多情况下，在短时间内仅是对内存中缓存数据的读取。当数据被保存到磁盘后，用户将越来越多地不可避免地遇到数据丢失，故障恢复的问题，特别是在需要将数据长时间保存的场合。</p><p>相反，在 Apache Pulsar 中，同样是以分区为逻辑单元，但是以 Segment 为物理存储单元。分区随着时间的推移会进行分段，并在整个集群中均衡分布，旨在有效地迅速地扩展。Pulsar 是以 Segment 为中心的，因此在扩展容量时不需要数据重新平衡和拷贝，旧数据不会被重新复制，这要归功于在 Apache BookKeeper 中使用可扩展的以 Segment 为中心的分布式日志存储系统。</p><p>通过利用分布式日志存储，Pulsar 可以最大化 Segment 放置选项，实现高写入和高读取可用性。例如，使用 BookKeeper，副本设置等于 2，只要任何 2 个 Bookie 启动，就可以对主题分区进行写入。对于读取可用性，只要主题分区的副本集中有 1 个处于活动状态，用户就可以读取它，而不会出现任何不一致。</p><p>总之，Apache Pulsar 这种独特的基于分布式日志存储的以 Segment 为中心的发布/订阅消息系统可以提供许多优势，例如可靠的流式系统，包括无限制的日志存储，无需分区重新平衡的即时扩展，快速复制修复以及通过最大化数据放置实现高写入和读取可用性选项。</p></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/messagequeue-series/%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1/%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/%E5%88%86%E5%8C%BA%E6%97%A5%E5%BF%97/ rel=next>分区日志</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte-website.oss-accelerate.aliyuncs.com/disqus/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte-website.oss-accelerate.aliyuncs.com/disqus/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>