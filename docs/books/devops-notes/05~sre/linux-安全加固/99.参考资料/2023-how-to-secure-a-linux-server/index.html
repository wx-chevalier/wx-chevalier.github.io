<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
    <meta name="google-site-verification" content="google69a5cccb61297807" />
    <meta name="baidu-site-verification" content="cqmZHEleVh" />
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="How To Secure A Linux Server An evolving how-to guide for securing a Linux server that, hopefully, also teaches you a little about security and why it matters.
Table of Contents How To Secure A Linux Server Table of Contents Introduction Guide Objective Why Secure Your Server Why Yet Another Guide Other Guides To Do / To Add Guide Overview About This Guide My Use-Case Editing Configuration Files - For The Lazy Contributing Before You Start Identify Your Principles Picking A Linux Distribution Installing Linux Pre/Post Installation Requirements Other Important Notes The SSH Server Important Note Before You Make SSH Changes SSH Public/Private Keys Why How It Works Goals Notes References Steps Create SSH Group For AllowGroups Why How It Works Goals Notes References Steps Secure /etc/ssh/sshd_config Why How It Works Goals Notes References Steps Remove Short Diffie-Hellman Keys Why Goals References Steps 2FA/MFA for SSH Why Why Not How It Works Goals Notes References Steps The Basics Limit Who Can Use sudo Why Goals Notes Steps Limit Who Can Use su Why Goals References Steps Run applications in a sandbox with FireJail Why Goals References Steps NTP Client Why How It Works Goals References Steps Securing /proc Why Goals References Steps Force Accounts To Use Secure Passwords Why How It Works Goals Steps Automatic Security Updates and Alerts Why Why Not Notes Goals Debian Based Systems How It Works References Steps More Secure Random Entropy Pool (WIP) Why How It Works Goals References Steps The Network Firewall With UFW (Uncomplicated Firewall) Why How It Works Goals Notes References Steps Default Applications Custom Application iptables Intrusion Detection And Prevention with PSAD Why How It Works References Steps Application Intrusion Detection And Prevention With Fail2Ban Why How It Works Goals Notes References Steps Custom Jails Unban an IP The Auditing File/Folder Integrity Monitoring With AIDE (WIP) Why How It Works Goals References Steps Updating The Database Anti-Virus Scanning With ClamAV (WIP) Why How It Works Goals Notes References Steps Scanning Files/Folders Rootkit Detection With Rkhunter (WIP) Why How It Works Goals References Steps Rootkit Detection With chrootkit (WIP) Why How It Works Goals References Steps logwatch - system log analyzer and reporter Why How It Works Goals Notes References Steps ss - Seeing Ports Your Server Is Listening On Why Goals References Steps Lynis - Linux Security Auditing Why Goals Notes References Steps OSSEC - Host Intrusion Detection Why Goals References Steps The Danger Zone Proceed At Your Own Risk Table of Contents Linux Kernel sysctl Hardening Why Why Not Disclaimer Notes References Steps Password Protect GRUB Why Why Not Goals Notes References Steps Disable Root Login Why Why Not Goals Notes References Steps Change Default umask Why Why Not How It Works Goals Notes References Steps Orphaned Software Why Notes Debian Based Systems Why Not Steps The Miscellaneous The Simple way with MSMTP Why Gmail and Exim4 As MTA With Implicit TLS Why Goals References Steps Separate iptables Log File Why References Steps Left Over Contacting Me Helpful Links Acknowledgments License and Copyright (TOC made with nGitHubTOC)" />

  
  <link rel="alternate" hreflang="zh" href="https://ng-tech.icu/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2023-how-to-secure-a-linux-server/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">
    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.0d97305106da5efa530e28b021b4c580.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', "G-40NYXJ8823");
</script>


  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://ng-tech.icu/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2023-how-to-secure-a-linux-server/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@wx-chevalier" />
    <meta property="twitter:creator" content="@wx-chevalier" />
  
  <meta property="og:site_name" content="Next-gen Tech Edu" />
  <meta property="og:url" content="https://ng-tech.icu/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2023-how-to-secure-a-linux-server/" />
  <meta property="og:title" content="2023-How To Secure A Linux Server | Next-gen Tech Edu" />
  <meta property="og:description" content="How To Secure A Linux Server An evolving how-to guide for securing a Linux server that, hopefully, also teaches you a little about security and why it matters.
Table of Contents How To Secure A Linux Server Table of Contents Introduction Guide Objective Why Secure Your Server Why Yet Another Guide Other Guides To Do / To Add Guide Overview About This Guide My Use-Case Editing Configuration Files - For The Lazy Contributing Before You Start Identify Your Principles Picking A Linux Distribution Installing Linux Pre/Post Installation Requirements Other Important Notes The SSH Server Important Note Before You Make SSH Changes SSH Public/Private Keys Why How It Works Goals Notes References Steps Create SSH Group For AllowGroups Why How It Works Goals Notes References Steps Secure /etc/ssh/sshd_config Why How It Works Goals Notes References Steps Remove Short Diffie-Hellman Keys Why Goals References Steps 2FA/MFA for SSH Why Why Not How It Works Goals Notes References Steps The Basics Limit Who Can Use sudo Why Goals Notes Steps Limit Who Can Use su Why Goals References Steps Run applications in a sandbox with FireJail Why Goals References Steps NTP Client Why How It Works Goals References Steps Securing /proc Why Goals References Steps Force Accounts To Use Secure Passwords Why How It Works Goals Steps Automatic Security Updates and Alerts Why Why Not Notes Goals Debian Based Systems How It Works References Steps More Secure Random Entropy Pool (WIP) Why How It Works Goals References Steps The Network Firewall With UFW (Uncomplicated Firewall) Why How It Works Goals Notes References Steps Default Applications Custom Application iptables Intrusion Detection And Prevention with PSAD Why How It Works References Steps Application Intrusion Detection And Prevention With Fail2Ban Why How It Works Goals Notes References Steps Custom Jails Unban an IP The Auditing File/Folder Integrity Monitoring With AIDE (WIP) Why How It Works Goals References Steps Updating The Database Anti-Virus Scanning With ClamAV (WIP) Why How It Works Goals Notes References Steps Scanning Files/Folders Rootkit Detection With Rkhunter (WIP) Why How It Works Goals References Steps Rootkit Detection With chrootkit (WIP) Why How It Works Goals References Steps logwatch - system log analyzer and reporter Why How It Works Goals Notes References Steps ss - Seeing Ports Your Server Is Listening On Why Goals References Steps Lynis - Linux Security Auditing Why Goals Notes References Steps OSSEC - Host Intrusion Detection Why Goals References Steps The Danger Zone Proceed At Your Own Risk Table of Contents Linux Kernel sysctl Hardening Why Why Not Disclaimer Notes References Steps Password Protect GRUB Why Why Not Goals Notes References Steps Disable Root Login Why Why Not Goals Notes References Steps Change Default umask Why Why Not How It Works Goals Notes References Steps Orphaned Software Why Notes Debian Based Systems Why Not Steps The Miscellaneous The Simple way with MSMTP Why Gmail and Exim4 As MTA With Implicit TLS Why Goals References Steps Separate iptables Log File Why References Steps Left Over Contacting Me Helpful Links Acknowledgments License and Copyright (TOC made with nGitHubTOC)" /><meta property="og:image" content="https://ng-tech.icu/media/sharing.png" />
    <meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
    
  

  



  

  

  





  <title>2023-How To Secure A Linux Server | Next-gen Tech Edu</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="a5441121fc97f86d1a756fd1a3e9da4b" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">Next-gen Tech Edu</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">Next-gen Tech Edu</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/books-gallery"><span>笔记（万篇）</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#knowledge-map"><span>知识图谱</span></a>
          </li>

          
          

          
          <style>
            .dropdown-item{
              display: inline-flex;
            }
          </style>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>实验室</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/galaxy-home/gh-craft"><span>Craft 方块世界</span></a>
              
                <a class="dropdown-item" href="/galaxy-home/glossary-cards"><span>3D 知识卡牌</span></a>
              
            </div>
          </li>

          
          

          
          <style>
            .dropdown-item{
              display: inline-flex;
            }
          </style>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>其他阅读渠道</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="https://zhuanlan.zhihu.com/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png"></img><span>知乎</span></a>
              
                <a class="dropdown-item" href="https://segmentfault.com/blog/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png"></img><span>SegmentFault</span></a>
              
                <a class="dropdown-item" href="https://zhuanlan.zhihu.com/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png"></img><span>掘金</span></a>
              
            </div>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link" href="https://github.com/wx-chevalier" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        
        
        <div></div>
        
        <style>
        @media only screen and (max-width: 600px) {
          .jimmysong-template {
            display: none!important;
          }
        }
        </style>
        
        <li class="jimmysong-template" style="color: white;font-size: 12px;">
          <a href="https://jimmysong.io" style="color: white">By Jimmy Song's Template</a>
        </li>
      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">
<div class="container-xl docs">
  <div class="row flex-xl-nowrap">
    <div class="docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
          99.参考资料
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">搜索...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      <ul class="nav docs-sidenav">
        <li style="display: inline-flex">
          <a style="cursor: pointer;" onclick="window.history.back()">
            <i class="fas fa-arrow-left pr-1"></i>
            Back
          </a>
          <span>|</span>
          <a href="/books/">
            <i class="fa-solid fa-house" style="margin-right: 4px"></i>
            Books
          </a>
        </li>
      </ul>

      
      
        
          
        
      



  
    
    
    
    
      
    
    

    
    
    
    
    
    <div class="docs-toc-item has-child">
    <div class="parent-node d-flex justify-content-between" onClick="Collapse(&#34;caret-id6c36a8a67c6e252a6376e412dca0b0c4&#34;)" href="#id6c36a8a67c6e252a6376e412dca0b0c4" aria-expanded="false" aria-controls="id6c36a8a67c6e252a6376e412dca0b0c4" aria-hidden="false" data-toggle="collapse">
    
    <a class="d-inline docs-toc-link " href="/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/">Linux 安全加固</a>
    <a class="nav-toogle d-inline level" aria-hidden="false" data-toggle="collapse" href="#id6c36a8a67c6e252a6376e412dca0b0c4" aria-expanded="false" aria-controls="id6c36a8a67c6e252a6376e412dca0b0c4">
    
    <i class="fa-solid fa-angle-down" id="caret-id6c36a8a67c6e252a6376e412dca0b0c4"></i>
    
    </a>
    
    </div>
    
      
      <ul class="nav docs-sidenav collapse  show " id="id6c36a8a67c6e252a6376e412dca0b0c4">
      



  
    
    
    
    
      
    
    

    
    
    
    
    
    <div class="docs-toc-item has-child">
    <div class="parent-node d-flex justify-content-between" onClick="Collapse(&#34;caret-id9a18f0712e94ee4d23464ecc9bf0d197&#34;)" href="#id9a18f0712e94ee4d23464ecc9bf0d197" aria-expanded="false" aria-controls="id9a18f0712e94ee4d23464ecc9bf0d197" aria-hidden="false" data-toggle="collapse">
    
    <a class="d-inline docs-toc-link " href="/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/">99.参考资料</a>
    <a class="nav-toogle d-inline level" aria-hidden="false" data-toggle="collapse" href="#id9a18f0712e94ee4d23464ecc9bf0d197" aria-expanded="false" aria-controls="id9a18f0712e94ee4d23464ecc9bf0d197">
    
    <i class="fa-solid fa-angle-down" id="caret-id9a18f0712e94ee4d23464ecc9bf0d197"></i>
    
    </a>
    
    </div>
    
      
      <ul class="nav docs-sidenav collapse  show " id="id9a18f0712e94ee4d23464ecc9bf0d197">
      



  <li class="child level active"><a href="/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2023-how-to-secure-a-linux-server/">2023-How To Secure A Linux Server</a></li>

      
        </ul>
      
    

    
      </div>
    




  <li class="child level "><a href="/books/devops-notes/05.sre/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/linux-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/">Linux 安全加固</a></li>

      
        </ul>
      
    

    
      </div>
    

    
  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      
     
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">目录</a></li>
      </ul>
     

      <nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-contents">Table of Contents</a></li>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#guide-objective">Guide Objective</a></li>
        <li><a href="#why-secure-your-server">Why Secure Your Server</a></li>
        <li><a href="#why-yet-another-guide">Why Yet Another Guide</a></li>
        <li><a href="#other-guides">Other Guides</a></li>
        <li><a href="#to-do--to-add">To Do / To Add</a></li>
      </ul>
    </li>
    <li><a href="#guide-overview">Guide Overview</a>
      <ul>
        <li><a href="#about-this-guide">About This Guide</a></li>
        <li><a href="#my-use-case">My Use-Case</a></li>
        <li><a href="#editing-configuration-files---for-the-lazy">Editing Configuration Files - For The Lazy</a></li>
        <li><a href="#contributing">Contributing</a></li>
      </ul>
    </li>
    <li><a href="#before-you-start">Before You Start</a>
      <ul>
        <li><a href="#identify-your-principles">Identify Your Principles</a></li>
        <li><a href="#picking-a-linux-distribution">Picking A Linux Distribution</a></li>
        <li><a href="#installing-linux">Installing Linux</a></li>
        <li><a href="#prepost-installation-requirements">Pre/Post Installation Requirements</a></li>
        <li><a href="#other-important-notes">Other Important Notes</a></li>
      </ul>
    </li>
    <li><a href="#the-ssh-server">The SSH Server</a>
      <ul>
        <li><a href="#important-note-before-you-make-ssh-changes">Important Note Before You Make SSH Changes</a></li>
        <li><a href="#ssh-publicprivate-keys">SSH Public/Private Keys</a></li>
        <li><a href="#create-ssh-group-for-allowgroups">Create SSH Group For AllowGroups</a></li>
        <li><a href="#secure-etcsshsshd_config">Secure <code>/etc/ssh/sshd_config</code></a></li>
        <li><a href="#remove-short-diffie-hellman-keys">Remove Short Diffie-Hellman Keys</a></li>
        <li><a href="#2famfa-for-ssh">2FA/MFA for SSH</a></li>
      </ul>
    </li>
    <li><a href="#the-basics">The Basics</a>
      <ul>
        <li><a href="#limit-who-can-use-sudo">Limit Who Can Use sudo</a></li>
        <li><a href="#limit-who-can-use-su">Limit Who Can Use su</a></li>
        <li><a href="#run-applications-in-a-sandbox-with-firejail">Run applications in a sandbox with FireJail</a></li>
        <li><a href="#ntp-client">NTP Client</a></li>
        <li><a href="#securing-proc">Securing /proc</a></li>
        <li><a href="#force-accounts-to-use-secure-passwords">Force Accounts To Use Secure Passwords</a></li>
        <li><a href="#automatic-security-updates-and-alerts">Automatic Security Updates and Alerts</a></li>
        <li><a href="#more-secure-random-entropy-pool-wip">More Secure Random Entropy Pool (WIP)</a></li>
      </ul>
    </li>
    <li><a href="#the-network">The Network</a>
      <ul>
        <li><a href="#firewall-with-ufw-uncomplicated-firewall">Firewall With UFW (Uncomplicated Firewall)</a></li>
        <li><a href="#iptables-intrusion-detection-and-prevention-with-psad">iptables Intrusion Detection And Prevention with PSAD</a></li>
        <li><a href="#application-intrusion-detection-and-prevention-with-fail2ban">Application Intrusion Detection And Prevention With Fail2Ban</a></li>
      </ul>
    </li>
    <li><a href="#the-auditing">The Auditing</a>
      <ul>
        <li><a href="#filefolder-integrity-monitoring-with-aide-wip">File/Folder Integrity Monitoring With AIDE (WIP)</a></li>
        <li><a href="#anti-virus-scanning-with-clamav-wip">Anti-Virus Scanning With ClamAV (WIP)</a></li>
        <li><a href="#rootkit-detection-with-rkhunter-wip">Rootkit Detection With Rkhunter (WIP)</a></li>
        <li><a href="#rootkit-detection-with-chrootkit-wip">Rootkit Detection With chrootkit (WIP)</a></li>
        <li><a href="#logwatch---system-log-analyzer-and-reporter">logwatch - system log analyzer and reporter</a></li>
        <li><a href="#ss---seeing-ports-your-server-is-listening-on">ss - Seeing Ports Your Server Is Listening On</a></li>
        <li><a href="#lynis---linux-security-auditing">Lynis - Linux Security Auditing</a></li>
        <li><a href="#ossec---host-intrusion-detection">OSSEC - Host Intrusion Detection</a></li>
      </ul>
    </li>
    <li><a href="#the-danger-zone">The Danger Zone</a>
      <ul>
        <li><a href="#proceed-at-your-own-risk">Proceed At Your Own Risk</a></li>
        <li><a href="#table-of-contents-1">Table of Contents</a></li>
        <li><a href="#linux-kernel-sysctl-hardening">Linux Kernel sysctl Hardening</a></li>
        <li><a href="#password-protect-grub">Password Protect GRUB</a></li>
        <li><a href="#disable-root-login">Disable Root Login</a></li>
        <li><a href="#change-default-umask">Change Default umask</a></li>
        <li><a href="#orphaned-software">Orphaned Software</a></li>
      </ul>
    </li>
    <li><a href="#the-miscellaneous">The Miscellaneous</a>
      <ul>
        <li><a href="#the-simple-way-with-msmtp">The Simple way with MSMTP</a></li>
        <li><a href="#gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</a></li>
        <li><a href="#separate-iptables-log-file">Separate iptables Log File</a></li>
      </ul>
    </li>
    <li><a href="#left-over">Left Over</a>
      <ul>
        <li><a href="#contacting-me">Contacting Me</a></li>
        <li><a href="#helpful-links">Helpful Links</a></li>
        <li><a href="#acknowledgments">Acknowledgments</a></li>
        <li><a href="#license-and-copyright">License and Copyright</a></li>
      </ul>
    </li>
  </ul>
</nav>

      
<div class="subscribe-module col-24 mt-1">
    <img src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png" alt="image" title="王下邀月熊的微信公众号"/>
</div>



    </div>
    

    <main class="py-md-3 pl-md-3 docs-content col-xl-8" role="main">

      <article class="article">

          

          <h1>2023-How To Secure A Linux Server</h1>

          <div class="article-style">
            <h1 id="how-to-secure-a-linux-server">How To Secure A Linux Server</h1>
<p>An evolving how-to guide for securing a Linux server that, hopefully, also teaches you a little about security and why it matters.</p>
<p><a href="#license">
















  <figure  >
    <div class="d-flex justify-content-center">
      <div class="w-100" ><img src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="CC-BY-SA" loading="lazy" data-zoomable /></div>
    </div></figure></a></p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#how-to-secure-a-linux-server">How To Secure A Linux Server</a>
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#guide-objective">Guide Objective</a></li>
<li><a href="#why-secure-your-server">Why Secure Your Server</a></li>
<li><a href="#why-yet-another-guide">Why Yet Another Guide</a></li>
<li><a href="#other-guides">Other Guides</a></li>
<li><a href="#to-do--to-add">To Do / To Add</a></li>
</ul>
</li>
<li><a href="#guide-overview">Guide Overview</a>
<ul>
<li><a href="#about-this-guide">About This Guide</a></li>
<li><a href="#my-use-case">My Use-Case</a></li>
<li><a href="#editing-configuration-files---for-the-lazy">Editing Configuration Files - For The Lazy</a></li>
<li><a href="#contributing">Contributing</a></li>
</ul>
</li>
<li><a href="#before-you-start">Before You Start</a>
<ul>
<li><a href="#identify-your-principles">Identify Your Principles</a></li>
<li><a href="#picking-a-linux-distribution">Picking A Linux Distribution</a></li>
<li><a href="#installing-linux">Installing Linux</a></li>
<li><a href="#prepost-installation-requirements">Pre/Post Installation Requirements</a></li>
<li><a href="#other-important-notes">Other Important Notes</a></li>
</ul>
</li>
<li><a href="#the-ssh-server">The SSH Server</a>
<ul>
<li><a href="#important-note-before-you-make-ssh-changes">Important Note Before You Make SSH Changes</a></li>
<li><a href="#ssh-publicprivate-keys">SSH Public/Private Keys</a>
<ul>
<li><a href="#why">Why</a></li>
<li><a href="#how-it-works">How It Works</a></li>
<li><a href="#goals">Goals</a></li>
<li><a href="#notes">Notes</a></li>
<li><a href="#references">References</a></li>
<li><a href="#steps">Steps</a></li>
</ul>
</li>
<li><a href="#create-ssh-group-for-allowgroups">Create SSH Group For AllowGroups</a>
<ul>
<li><a href="#why-1">Why</a></li>
<li><a href="#how-it-works-1">How It Works</a></li>
<li><a href="#goals-1">Goals</a></li>
<li><a href="#notes-1">Notes</a></li>
<li><a href="#references-1">References</a></li>
<li><a href="#steps-1">Steps</a></li>
</ul>
</li>
<li><a href="#secure-etcsshsshd_config">Secure <code>/etc/ssh/sshd_config</code></a>
<ul>
<li><a href="#why-2">Why</a></li>
<li><a href="#how-it-works-2">How It Works</a></li>
<li><a href="#goals-2">Goals</a></li>
<li><a href="#notes-2">Notes</a></li>
<li><a href="#references-2">References</a></li>
<li><a href="#steps-2">Steps</a></li>
</ul>
</li>
<li><a href="#remove-short-diffie-hellman-keys">Remove Short Diffie-Hellman Keys</a>
<ul>
<li><a href="#why-3">Why</a></li>
<li><a href="#goals-3">Goals</a></li>
<li><a href="#references-3">References</a></li>
<li><a href="#steps-3">Steps</a></li>
</ul>
</li>
<li><a href="#2famfa-for-ssh">2FA/MFA for SSH</a>
<ul>
<li><a href="#why-4">Why</a></li>
<li><a href="#why-not">Why Not</a></li>
<li><a href="#how-it-works-3">How It Works</a></li>
<li><a href="#goals-4">Goals</a></li>
<li><a href="#notes-3">Notes</a></li>
<li><a href="#references-4">References</a></li>
<li><a href="#steps-4">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-basics">The Basics</a>
<ul>
<li><a href="#limit-who-can-use-sudo">Limit Who Can Use sudo</a>
<ul>
<li><a href="#why-5">Why</a></li>
<li><a href="#goals-5">Goals</a></li>
<li><a href="#notes-4">Notes</a></li>
<li><a href="#steps-5">Steps</a></li>
</ul>
</li>
<li><a href="#limit-who-can-use-su">Limit Who Can Use su</a>
<ul>
<li><a href="#why-6">Why</a></li>
<li><a href="#goals-6">Goals</a></li>
<li><a href="#references-5">References</a></li>
<li><a href="#steps-6">Steps</a></li>
</ul>
</li>
<li><a href="#run-applications-in-a-sandbox-with-firejail">Run applications in a sandbox with FireJail</a>
<ul>
<li><a href="#why-7">Why</a></li>
<li><a href="#goals-7">Goals</a></li>
<li><a href="#references-6">References</a></li>
<li><a href="#steps-7">Steps</a></li>
</ul>
</li>
<li><a href="#ntp-client">NTP Client</a>
<ul>
<li><a href="#why-8">Why</a></li>
<li><a href="#how-it-works-4">How It Works</a></li>
<li><a href="#goals-8">Goals</a></li>
<li><a href="#references-7">References</a></li>
<li><a href="#steps-8">Steps</a></li>
</ul>
</li>
<li><a href="#securing-proc">Securing /proc</a>
<ul>
<li><a href="#why-9">Why</a></li>
<li><a href="#goals-9">Goals</a></li>
<li><a href="#references-8">References</a></li>
<li><a href="#steps-9">Steps</a></li>
</ul>
</li>
<li><a href="#force-accounts-to-use-secure-passwords">Force Accounts To Use Secure Passwords</a>
<ul>
<li><a href="#why-10">Why</a></li>
<li><a href="#how-it-works-5">How It Works</a></li>
<li><a href="#goals-10">Goals</a></li>
<li><a href="#steps-10">Steps</a></li>
</ul>
</li>
<li><a href="#automatic-security-updates-and-alerts">Automatic Security Updates and Alerts</a>
<ul>
<li><a href="#why-11">Why</a></li>
<li><a href="#why-not-1">Why Not</a></li>
<li><a href="#notes-5">Notes</a></li>
<li><a href="#goals-11">Goals</a></li>
<li><a href="#debian-based-systems">Debian Based Systems</a>
<ul>
<li><a href="#how-it-works-6">How It Works</a></li>
<li><a href="#references-9">References</a></li>
<li><a href="#steps-11">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#more-secure-random-entropy-pool-wip">More Secure Random Entropy Pool (WIP)</a>
<ul>
<li><a href="#why-12">Why</a></li>
<li><a href="#how-it-works-7">How It Works</a></li>
<li><a href="#goals-12">Goals</a></li>
<li><a href="#references-10">References</a></li>
<li><a href="#steps-12">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-network">The Network</a>
<ul>
<li><a href="#firewall-with-ufw-uncomplicated-firewall">Firewall With UFW (Uncomplicated Firewall)</a>
<ul>
<li><a href="#why-13">Why</a></li>
<li><a href="#how-it-works-8">How It Works</a></li>
<li><a href="#goals-13">Goals</a></li>
<li><a href="#notes-6">Notes</a></li>
<li><a href="#references-11">References</a></li>
<li><a href="#steps-13">Steps</a></li>
<li><a href="#default-applications">Default Applications</a></li>
<li><a href="#custom-application">Custom Application</a></li>
</ul>
</li>
<li><a href="#iptables-intrusion-detection-and-prevention-with-psad">iptables Intrusion Detection And Prevention with PSAD</a>
<ul>
<li><a href="#why-14">Why</a></li>
<li><a href="#how-it-works-9">How It Works</a></li>
<li><a href="#references-12">References</a></li>
<li><a href="#steps-14">Steps</a></li>
</ul>
</li>
<li><a href="#application-intrusion-detection-and-prevention-with-fail2ban">Application Intrusion Detection And Prevention With Fail2Ban</a>
<ul>
<li><a href="#why-15">Why</a></li>
<li><a href="#how-it-works-10">How It Works</a></li>
<li><a href="#goals-14">Goals</a></li>
<li><a href="#notes-7">Notes</a></li>
<li><a href="#references-13">References</a></li>
<li><a href="#steps-15">Steps</a></li>
<li><a href="#custom-jails">Custom Jails</a></li>
<li><a href="#unban-an-ip">Unban an IP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-auditing">The Auditing</a>
<ul>
<li><a href="#filefolder-integrity-monitoring-with-aide-wip">File/Folder Integrity Monitoring With AIDE (WIP)</a>
<ul>
<li><a href="#why-16">Why</a></li>
<li><a href="#how-it-works-11">How It Works</a></li>
<li><a href="#goals-15">Goals</a></li>
<li><a href="#references-14">References</a></li>
<li><a href="#steps-16">Steps</a></li>
<li><a href="#updating-the-database">Updating The Database</a></li>
</ul>
</li>
<li><a href="#anti-virus-scanning-with-clamav-wip">Anti-Virus Scanning With ClamAV (WIP)</a>
<ul>
<li><a href="#why-17">Why</a></li>
<li><a href="#how-it-works-12">How It Works</a></li>
<li><a href="#goals-16">Goals</a></li>
<li><a href="#notes-8">Notes</a></li>
<li><a href="#references-15">References</a></li>
<li><a href="#steps-17">Steps</a></li>
<li><a href="#scanning-filesfolders">Scanning Files/Folders</a></li>
</ul>
</li>
<li><a href="#rootkit-detection-with-rkhunter-wip">Rootkit Detection With Rkhunter (WIP)</a>
<ul>
<li><a href="#why-18">Why</a></li>
<li><a href="#how-it-works-13">How It Works</a></li>
<li><a href="#goals-17">Goals</a></li>
<li><a href="#references-16">References</a></li>
<li><a href="#steps-18">Steps</a></li>
</ul>
</li>
<li><a href="#rootkit-detection-with-chrootkit-wip">Rootkit Detection With chrootkit (WIP)</a>
<ul>
<li><a href="#why-19">Why</a></li>
<li><a href="#how-it-works-14">How It Works</a></li>
<li><a href="#goals-18">Goals</a></li>
<li><a href="#references-17">References</a></li>
<li><a href="#steps-19">Steps</a></li>
</ul>
</li>
<li><a href="#logwatch---system-log-analyzer-and-reporter">logwatch - system log analyzer and reporter</a>
<ul>
<li><a href="#why-20">Why</a></li>
<li><a href="#how-it-works-15">How It Works</a></li>
<li><a href="#goals-19">Goals</a></li>
<li><a href="#notes-9">Notes</a></li>
<li><a href="#references-18">References</a></li>
<li><a href="#steps-20">Steps</a></li>
</ul>
</li>
<li><a href="#ss---seeing-ports-your-server-is-listening-on">ss - Seeing Ports Your Server Is Listening On</a>
<ul>
<li><a href="#why-21">Why</a></li>
<li><a href="#goals-20">Goals</a></li>
<li><a href="#references-19">References</a></li>
<li><a href="#steps-21">Steps</a></li>
</ul>
</li>
<li><a href="#lynis---linux-security-auditing">Lynis - Linux Security Auditing</a>
<ul>
<li><a href="#why-22">Why</a></li>
<li><a href="#goals-21">Goals</a></li>
<li><a href="#notes-10">Notes</a></li>
<li><a href="#references-20">References</a></li>
<li><a href="#steps-22">Steps</a></li>
</ul>
</li>
<li><a href="#ossec---host-intrusion-detection">OSSEC - Host Intrusion Detection</a>
<ul>
<li><a href="#why-23">Why</a></li>
<li><a href="#goals-22">Goals</a></li>
<li><a href="#references-21">References</a></li>
<li><a href="#steps-23">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-danger-zone">The Danger Zone</a>
<ul>
<li><a href="#proceed-at-your-own-risk">Proceed At Your Own Risk</a></li>
<li><a href="#table-of-contents-1">Table of Contents</a></li>
<li><a href="#linux-kernel-sysctl-hardening">Linux Kernel sysctl Hardening</a>
<ul>
<li><a href="#why-24">Why</a></li>
<li><a href="#why-not-2">Why Not</a></li>
<li><a href="#disclaimer">Disclaimer</a></li>
<li><a href="#notes-11">Notes</a></li>
<li><a href="#references-22">References</a></li>
<li><a href="#steps-24">Steps</a></li>
</ul>
</li>
<li><a href="#password-protect-grub">Password Protect GRUB</a>
<ul>
<li><a href="#why-25">Why</a></li>
<li><a href="#why-not-3">Why Not</a></li>
<li><a href="#goals-23">Goals</a></li>
<li><a href="#notes-12">Notes</a></li>
<li><a href="#references-23">References</a></li>
<li><a href="#steps-25">Steps</a></li>
</ul>
</li>
<li><a href="#disable-root-login">Disable Root Login</a>
<ul>
<li><a href="#why-26">Why</a></li>
<li><a href="#why-not-4">Why Not</a></li>
<li><a href="#goals-24">Goals</a></li>
<li><a href="#notes-13">Notes</a></li>
<li><a href="#references-24">References</a></li>
<li><a href="#steps-26">Steps</a></li>
</ul>
</li>
<li><a href="#change-default-umask">Change Default umask</a>
<ul>
<li><a href="#why-27">Why</a></li>
<li><a href="#why-not-5">Why Not</a></li>
<li><a href="#how-it-works-16">How It Works</a></li>
<li><a href="#goals-25">Goals</a></li>
<li><a href="#notes-14">Notes</a></li>
<li><a href="#references-25">References</a></li>
<li><a href="#steps-27">Steps</a></li>
</ul>
</li>
<li><a href="#orphaned-software">Orphaned Software</a>
<ul>
<li><a href="#why-28">Why</a></li>
<li><a href="#notes-15">Notes</a></li>
<li><a href="#debian-based-systems-1">Debian Based Systems</a>
<ul>
<li><a href="#why-not-6">Why Not</a></li>
<li><a href="#steps-28">Steps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-miscellaneous">The Miscellaneous</a>
<ul>
<li><a href="#the-simple-way-with-msmtp">The Simple way with MSMTP</a>
<ul>
<li><a href="#why-29">Why</a></li>
</ul>
</li>
<li><a href="#gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</a>
<ul>
<li><a href="#why-30">Why</a></li>
<li><a href="#goals-26">Goals</a></li>
<li><a href="#references-26">References</a></li>
<li><a href="#steps-29">Steps</a></li>
</ul>
</li>
<li><a href="#separate-iptables-log-file">Separate iptables Log File</a>
<ul>
<li><a href="#why-31">Why</a></li>
<li><a href="#references-27">References</a></li>
<li><a href="#steps-30">Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#left-over">Left Over</a>
<ul>
<li><a href="#contacting-me">Contacting Me</a></li>
<li><a href="#helpful-links">Helpful Links</a></li>
<li><a href="#acknowledgments">Acknowledgments</a></li>
<li><a href="#license-and-copyright">License and Copyright</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>(TOC made with <a href="https://imthenachoman.github.io/nGitHubTOC/" target="_blank" rel="noopener">nGitHubTOC</a>)</p>
<h2 id="introduction">Introduction</h2>
<h3 id="guide-objective">Guide Objective</h3>
<p>This guides purpose is to teach you how to secure a Linux server.</p>
<p>There are a lot of things you can do to secure a Linux server and this guide will attempt to cover as many of them as possible. More topics/material will be added as I learn, or as folks <a href="#contributing">contribute</a>.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="why-secure-your-server">Why Secure Your Server</h3>
<p>I assume you&rsquo;re using this guide because you, hopefully, already understand why good security is important. That is a heavy topic onto itself and breaking it down is out-of-scope for this guide. If you don&rsquo;t know the answer to that question, I advise you research it first.</p>
<p>At a high level, the second a device, like a server, is in the public domain &ndash; i.e visible to the outside world &ndash; it becomes a target for bad-actors. An unsecured device is a playground for bad-actors who want access to your data, or to use your server as another node for their large-scale DDOS attacks.</p>
<p>What&rsquo;s worse is, without good security, you may never know if your server has been compromised. A bad-actor may have gained unauthorized access to your server and copied your data without changing anything so you&rsquo;d never know. Or your server may have been part of a DDOS attack and you wouldn&rsquo;t know. Look at many of the large scale data breaches in the news &ndash; the companies often did not discover the data leak or intrusion until long after the bad-actors were gone.</p>
<p>Contrary to popular belief, bad-actors don&rsquo;t always want to change something or <a href="https://en.wikipedia.org/wiki/Ransomware" target="_blank" rel="noopener">lock you out of your data for money</a>. Sometimes they just want the data on your server for their data warehouses (there is big money in big data) or to covertly use your server for their nefarious purposes.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="why-yet-another-guide">Why Yet Another Guide</h3>
<p>This guide may appear duplicative/unnecessary because there are countless articles online that tell you <a href="https://duckduckgo.com/?q=how&#43;to&#43;secure&#43;linux&amp;t=ffab&amp;atb=v151-7&amp;ia=web" target="_blank" rel="noopener">how to secure Linux</a>, but the information is spread across different articles, that cover different things, and in different ways. Who has time to scour through hundreds of articles?</p>
<p>As I was going through research for my Debian build, I kept notes. At the end I realized that, along with what I already knew, and what I was learning, I had the makings of a how-to guide. I figured I&rsquo;d put it online to hopefully help others <strong>learn</strong>, and <strong>save time</strong>.</p>
<p>I&rsquo;ve never found one guide that covers everything &ndash; this guide is my attempt.</p>
<p>Many of the things covered in this guide may be rather basic/trivial, but most of us do not install Linux every day and it is easy to forget those basic things.</p>
<p>IT automation tools like <a href="https://www.ansible.com/" target="_blank" rel="noopener">Ansible</a>, <a href="https://www.chef.io/" target="_blank" rel="noopener">Chef</a>, <a href="https://jenkins.io/" target="_blank" rel="noopener">Jenkins</a>, <a href="https://puppet.com/" target="_blank" rel="noopener">Puppet</a>, etc. help with the tedious task of installing/configuring a server but IMHO they are better suited for multiple or large scale deployments. IMHO, the overhead required to use those kinds of automation tools is wholly unnecessary for a one-time single server install for home use.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="other-guides">Other Guides</h3>
<p>There are many guides provided by experts, industry leaders, and the distributions themselves. It is not practical, and sometimes against copyright, to include everything from those guides. I recommend you check them out before starting with this guide.</p>
<ul>
<li>The <a href="https://www.cisecurity.org/" target="_blank" rel="noopener">Center for Internet Security (CIS)</a> provides <a href="https://www.cisecurity.org/cis-benchmarks/" target="_blank" rel="noopener">benchmarks</a> that are exhaustive, industry trusted, step-by-step instructions for securing many flavors of Linux. Check their <a href="https://www.cisecurity.org/about-us/" target="_blank" rel="noopener">About Us</a> page for details. My recommendation is to go through this guide (the one you&rsquo;re reading here) first and THEN CIS&rsquo;s guide. That way their recommendations will trump anything in this guide.</li>
<li>For distribution specific hardening/security guides, check your distributions documentation.</li>
<li><a href="https://security.utexas.edu/os-hardening-checklist/linux-7" target="_blank" rel="noopener">https://security.utexas.edu/os-hardening-checklist/linux-7</a> - Red Hat Enterprise Linux 7 Hardening Checklist</li>
<li><a href="https://cloudpro.zone/index.php/2018/01/18/debian-9-3-server-setup-guide-part-1/" target="_blank" rel="noopener">https://cloudpro.zone/index.php/2018/01/18/debian-9-3-server-setup-guide-part-1/</a> - # Debian 9.3 server setup guide</li>
<li><a href="https://blog.vigilcode.com/2011/04/ubuntu-server-initial-security-quick-secure-setup-part-i/" target="_blank" rel="noopener">https://blog.vigilcode.com/2011/04/ubuntu-server-initial-security-quick-secure-setup-part-i/</a> - Ubuntu Server Initial Security guide</li>
<li><a href="https://www.tldp.org/LDP/sag/html/index.html" target="_blank" rel="noopener">https://www.tldp.org/LDP/sag/html/index.html</a></li>
<li><a href="https://seifried.org/lasg/" target="_blank" rel="noopener">https://seifried.org/lasg/</a></li>
<li><a href="https://news.ycombinator.com/item?id=19178964" target="_blank" rel="noopener">https://news.ycombinator.com/item?id=19178964</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Security" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Security</a> - many folks have also recommended this one</li>
<li><a href="https://securecompliance.co/linux-server-hardening-checklist/" target="_blank" rel="noopener">https://securecompliance.co/linux-server-hardening-checklist/</a></li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="to-do--to-add">To Do / To Add</h3>
<ul>
<li><input disabled="" type="checkbox"> <a href="#custom-jails">Custom Jails for Fail2ban</a></li>
<li><input disabled="" type="checkbox"> MAC (Mandatory Access Control) and Linux Security Modules (LSMs)
<ul>
<li><a href="https://wiki.archlinux.org/index.php/security#Mandatory_access_control" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/security#Mandatory_access_control</a></li>
<li>Security-Enhanced Linux / SELinux
<ul>
<li><a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Security-Enhanced_Linux</a></li>
<li><a href="https://linuxtechlab.com/beginners-guide-to-selinux/" target="_blank" rel="noopener">https://linuxtechlab.com/beginners-guide-to-selinux/</a></li>
<li><a href="https://linuxtechlab.com/replicate-selinux-policies-among-linux-machines/" target="_blank" rel="noopener">https://linuxtechlab.com/replicate-selinux-policies-among-linux-machines/</a></li>
<li><a href="https://teamignition.us/how-to-stop-being-a-scrub-and-learn-to-use-selinux.html" target="_blank" rel="noopener">https://teamignition.us/how-to-stop-being-a-scrub-and-learn-to-use-selinux.html</a></li>
</ul>
</li>
<li>AppArmor
<ul>
<li><a href="https://wiki.archlinux.org/index.php/AppArmor" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/AppArmor</a></li>
<li><a href="https://security.stackexchange.com/questions/29378/comparison-between-apparmor-and-selinux" target="_blank" rel="noopener">https://security.stackexchange.com/questions/29378/comparison-between-apparmor-and-selinux</a></li>
<li><a href="http://www.insanitybit.com/2012/06/01/why-i-like-apparmor-more-than-selinux-5/" target="_blank" rel="noopener">http://www.insanitybit.com/2012/06/01/why-i-like-apparmor-more-than-selinux-5/</a></li>
</ul>
</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> disk encryption</li>
<li><input disabled="" type="checkbox"> Rkhunter and chrootkit
<ul>
<li><a href="http://www.chkrootkit.org/" target="_blank" rel="noopener">http://www.chkrootkit.org/</a></li>
<li><a href="http://rkhunter.sourceforge.net/" target="_blank" rel="noopener">http://rkhunter.sourceforge.net/</a></li>
<li><a href="https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/</a></li>
<li><a href="https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/" target="_blank" rel="noopener">https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/</a></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> shipping/backing up logs - <a href="https://news.ycombinator.com/item?id=19178681" target="_blank" rel="noopener">https://news.ycombinator.com/item?id=19178681</a></li>
<li><input disabled="" type="checkbox"> CIS-CAT - <a href="https://learn.cisecurity.org/cis-cat-landing-page" target="_blank" rel="noopener">https://learn.cisecurity.org/cis-cat-landing-page</a></li>
<li><input disabled="" type="checkbox"> debsums - <a href="https://blog.sleeplessbeastie.eu/2015/03/02/how-to-verify-installed-packages/" target="_blank" rel="noopener">https://blog.sleeplessbeastie.eu/2015/03/02/how-to-verify-installed-packages/</a></li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="guide-overview">Guide Overview</h2>
<h3 id="about-this-guide">About This Guide</h3>
<p>This guide&hellip;</p>
<ul>
<li>&hellip;<strong>is</strong> a work in progress.</li>
<li>&hellip;<strong>is</strong> focused on <strong>at-home</strong> Linux servers. All of the concepts/recommendations here apply to larger/professional environments but those use-cases call for more advanced and specialized configurations that are out-of-scope for this guide.</li>
<li>&hellip;<strong>does not</strong> teach you about Linux, how to <a href="#installing-linux">install Linux</a>, or how to use it. Check <a href="https://linuxjourney.com/" target="_blank" rel="noopener">https://linuxjourney.com/</a> if you&rsquo;re new to Linux.</li>
<li>&hellip;<strong>is</strong> meant to be <a href="#picking-a-linux-distribution">Linux distribution agnostic</a>.</li>
<li>&hellip;<strong>does not</strong> teach you everything you need to know about security nor does it get into all aspects of system/server security. For example, physical security is out of scope for this guide.</li>
<li>&hellip;<strong>does not</strong> talk about how programs/tools work, nor does it delve into their nook and crannies. Most of the programs/tools this guide references are very powerful and highly configurable. The goal is to cover the bare necessities &ndash; enough to whet your appetite and make you hungry enough to want to go and learn more.</li>
<li>&hellip;<strong>aims</strong> to make it easy by providing code you can copy-and-paste. You might need to modify the commands before you paste so keep your favorite <a href="https://notepad-plus-plus.org/" target="_blank" rel="noopener">text editor</a> handy.</li>
<li>&hellip;<strong>is</strong> organized in an order that makes logical sense to me &ndash; i.e. securing SSH before installing a firewall. As such, this guide is intended to be followed in the order it is presented but it is not necessary to do so. Just be careful if you do things in a different order &ndash; some sections require previous sections to be completed.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="my-use-case">My Use-Case</h3>
<p>There are many types of servers and different use-cases. While I want this guide to be as generic as possible, there will be some things that may not apply to all/other use-cases. Use your best judgement when going through this guide.</p>
<p>To help put context to many of the topics covered in this guide, my use-case/configuration is:</p>
<ul>
<li>A desktop class computer&hellip;</li>
<li>With a single NIC&hellip;</li>
<li>Connected to a consumer grade router&hellip;</li>
<li>Getting a dynamic WAN IP provided by the ISP&hellip;</li>
<li>With WAN+LAN on IPV4&hellip;</li>
<li>And LAN using <a href="https://en.wikipedia.org/wiki/Network_address_translation" target="_blank" rel="noopener">NAT</a>&hellip;</li>
<li>That I want to be able to SSH to remotely from unknown computers and unknown locations (i.e. a friend&rsquo;s house).</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="editing-configuration-files---for-the-lazy">Editing Configuration Files - For The Lazy</h3>
<p>I am very lazy and do not like to edit files by hand if I don&rsquo;t need to. I also assume everyone else is just like me. :)</p>
<p>So, when and where possible, I have provided <code>code</code> snippets to quickly do what is needed, like add or change a line in a configuration file.</p>
<p>The <code>code</code> snippets use basic commands like <code>echo</code>, <code>cat</code>, <code>sed</code>, <code>awk</code>, and <code>grep</code>. How the <code>code</code> snippets work, like what each command/part does, is out of scope for this guide &ndash; the <code>man</code> pages are your friend.</p>
<p><strong>Note</strong>: The <code>code</code> snippets do not validate/verify the change went through &ndash; i.e. the line was actually added or changed. I&rsquo;ll leave the verifying part in your capable hands. The steps in this guide do include taking backups of all files that will be changed.</p>
<p>Not all changes can be automated with <code>code</code> snippets. Those changes need good, old fashioned, manual editing. For example, you can&rsquo;t just append a line to an <a href="https://en.wikipedia.org/wiki/INI_file" target="_blank" rel="noopener">INI</a> type file. Use your <a href="https://en.wikipedia.org/wiki/Vi" target="_blank" rel="noopener">favorite</a> Linux text editor.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="contributing">Contributing</h3>
<p>I wanted to put this guide on <a href="http://www.github.com" target="_blank" rel="noopener">GitHub</a> to make it easy to collaborate. The more folks that contribute, the better and more complete this guide will become.</p>
<p>To contribute you can fork and submit a pull request or submit a <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/new" target="_blank" rel="noopener">new issue</a>.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="before-you-start">Before You Start</h2>
<h3 id="identify-your-principles">Identify Your Principles</h3>
<p>Before you start you will want to identify what your Principles are. What is your <a href="https://en.wikipedia.org/wiki/Threat_model" target="_blank" rel="noopener">threat model</a>? Some things to think about:</p>
<ul>
<li>Why do you want to secure your server?</li>
<li>How much security do you want or not want?</li>
<li>How much convenience are you willing to compromise for security and vice-versa?</li>
<li>What are the threats you want to protect against? What are the specifics to your situation? For example:
<ul>
<li>Is physical access to your server/network a possible attack vector?</li>
<li>Will you be opening ports on your router so you can access your server from outside your home?</li>
<li>Will you be hosting a file share on your server that will be mounted on a desktop class machine? What is the possibility of the desktop machine getting infected and, in turn, infecting the server?</li>
</ul>
</li>
<li>Do you have a means of recovering if your security implementation locks you out of your own server? For example, you <a href="#disable-root-login">disabled root login</a> or <a href="#password-protect-grub">password protected GRUB</a>.</li>
</ul>
<p>These are just <strong>a few things</strong> to think about. Before you start securing your server you will want to understand what you&rsquo;re trying to protect against and why so you know what you need to do.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="picking-a-linux-distribution">Picking A Linux Distribution</h3>
<p>This guide is intended to be distribution agnostic so users can use <a href="https://distrowatch.com/" target="_blank" rel="noopener">any distribution</a> they want. With that said, there are a few things to keep in mind:</p>
<p>You want a distribution that&hellip;</p>
<ul>
<li>&hellip;<strong>is stable</strong>. Unless you like debugging issues at 2 AM, you don&rsquo;t want an <a href="#automatic-security-updates-and-alerts">unattended upgrade</a>, or a manual package/system update, to render your server inoperable. But this also means you&rsquo;re okay with not running the latest, greatest, bleeding edge software.</li>
<li>&hellip;<strong>stays up-to-date with security patches</strong>. You can secure everything on your server, but if the core OS or applications you&rsquo;re running have known vulnerabilities, you&rsquo;ll never be safe.</li>
<li>&hellip;<strong>you&rsquo;re familiar with.</strong> If you don&rsquo;t know Linux, I would advise you play around with one before you try to secure it. You should be comfortable with it and know your way around, like how to install software, where configuration files are, etc&hellip;</li>
<li>&hellip;<strong>is well supported.</strong> Even the most seasoned admin needs help every now and then. Having a place to go for help will save your sanity.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="installing-linux">Installing Linux</h3>
<p>Installing Linux is out-of-scope for this guide because each distribution does it differently and the installation instructions are usually well documented. If you need help, start with your distribution&rsquo;s documentation. Regardless of the distribution, the high-level process usually goes like so:</p>
<ol>
<li>download the ISO</li>
<li>burn/copy/transfer it to your install medium (e.g. a CD or USB stick)</li>
<li>boot your server from your install medium</li>
<li>follow the prompts to install</li>
</ol>
<p>Where applicable, use the expert install option so you have tighter control of what is running on your server. <strong>Only install what you absolutely need.</strong> I, personally, do not install anything other than SSH. Also, tick the Disk Encryption option.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="prepost-installation-requirements">Pre/Post Installation Requirements</h3>
<ul>
<li>If you&rsquo;re opening ports on your router so you can access your server from the outside, disable the port forwarding until your system is up and secured.</li>
<li>Unless you&rsquo;re doing everything physically connected to your server, you&rsquo;ll need remote access so be sure SSH works.</li>
<li>Keep your system up-to-date (i.e. <code>sudo apt update &amp;&amp; sudo apt upgrade</code> on Debian based systems).</li>
<li>Make sure you perform any tasks specific to your setup like:
<ul>
<li>Configuring network</li>
<li>Configuring mount points in <code>/etc/fstab</code></li>
<li>Creating the initial user accounts</li>
<li>Installing core software you&rsquo;ll want like <code>man</code></li>
<li>Etc&hellip;</li>
</ul>
</li>
<li>Your server will need to be able to send e-mails so you can get important security alerts. If you&rsquo;re not setting up a mail server check <a href="#gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</a>.</li>
<li>I would also recommend you <strong>read</strong> through the <a href="https://www.cisecurity.org/cis-benchmarks/" target="_blank" rel="noopener">CIS Benchmarks</a> before you start with this guide just to digest/understand what they have to say. My recommendation is to go through this guide (the one you&rsquo;re reading here) first and THEN CIS&rsquo;s guide. That way their recommendations will trump anything in this guide.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="other-important-notes">Other Important Notes</h3>
<ul>
<li>This guide is being written and tested on Debian. Most things below should work on other distributions. If you find something that does not, please <a href="#contacting-me">contact me</a>. The main thing that separates each distribution will be its package management system. Since I use Debian, I will provide the appropriate <code>apt</code> commands that should work on all <a href="https://www.debian.org/derivatives/" target="_blank" rel="noopener">Debian based distributions</a>. If someone is willing to <a href="#contributing">provide</a> the respective commands for other distributions, I will add them.</li>
<li>File paths and settings also may differ slightly &ndash; check with your distribution&rsquo;s documentation if you have issues.</li>
<li>Read the whole guide before you start. Your use-case and/or principals may call for not doing something or for changing the order.</li>
<li>Do not <strong>blindly</strong> copy-and-paste without understanding what you&rsquo;re pasting. Some commands will need to be modified for your needs before they&rsquo;ll work &ndash; usernames for example.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-ssh-server">The SSH Server</h2>
<h3 id="important-note-before-you-make-ssh-changes">Important Note Before You Make SSH Changes</h3>
<p>It is highly advised you keep a 2nd terminal open to your server <strong>before you make and apply SSH configuration changes</strong>. This way if you lock yourself out of your 1st terminal session, you still have one session connected so you can fix it.</p>
<p>Thank you to <a href="https://github.com/Sonnenbrand" target="_blank" rel="noopener">Sonnenbrand</a> for this <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/56" target="_blank" rel="noopener">idea</a>.</p>
<h3 id="ssh-publicprivate-keys">SSH Public/Private Keys</h3>
<h4 id="why">Why</h4>
<p>Using SSH public/private keys is more secure than using a password. It also makes it easier and faster, to connect to our server because you don&rsquo;t have to enter a password.</p>
<h4 id="how-it-works">How It Works</h4>
<p>Check the references below for more details but, at a high level, public/private keys work by using a pair of keys to verify identity.</p>
<ol>
<li>One key, the <strong>public</strong> key, <strong>can only encrypt data</strong>, not decrypt it</li>
<li>The other key, the <strong>private</strong> key, can decrypt the data</li>
</ol>
<p>For SSH, a public and private key is created on the client. You want to keep both keys secure, especially the private key. Even though the public key is meant to be public, it is wise to make sure neither keys fall in the wrong hands.</p>
<p>When you connect to an SSH server, SSH will look for a public key that matches the client you&rsquo;re connecting from in the file <code>~/.ssh/authorized_keys</code> on the server you&rsquo;re connecting to. Notice the file is in the <strong>home folder</strong> of the ID you&rsquo;re trying to connect to. So, after creating the public key, you need to append it to <code>~/.ssh/authorized_keys</code>. One approach is to copy it to a USB stick and physically transfer it to the server. Another approach is to use use <a href="https://www.ssh.com/ssh/copy-id" target="_blank" rel="noopener"><code>ssh-copy-id</code></a> to transfer and append the public key.</p>
<p>After the keys have been created and the public key has been appended to <code>~/.ssh/authorized_keys</code> on the host, SSH uses the public and private keys to verify identity and then establish a secure connection. How identity is verified is a complicated process but <a href="https://www.digitalocean.com/community/tutorials/understanding-the-ssh-encryption-and-connection-process" target="_blank" rel="noopener">Digital Ocean</a> has a very nice write-up of how it works. At a high level, identity is verified by the server encrypting a challenge message with the public key, then sending it to the client. If the client cannot decrypt the challenge message with the private key, the identity can&rsquo;t be verified and a connection will not be established.</p>
<p>They are considered more secure because you need the private key to establish an SSH connection. If you set <a href="#PasswordAuthentication"><code>PasswordAuthentication no</code> in <code>/etc/ssh/sshd_config</code></a>, then SSH won&rsquo;t let you connect without the private key.</p>
<p>You can also set a pass-phrase for the keys which would require you to enter the key pass-phrase when connecting using public/private keys. Keep in mind doing this means you can&rsquo;t use the key for automation because you&rsquo;ll have no way to send the passphrase in your scripts. <code>ssh-agent</code> is a program that is shipped in many Linux distros (and usually already running) that will allow you to hold your unencrypted private key in memory for a configurable duration. Simply run <code>ssh-add</code> and it will prompt you for your passphrase. You will not be prompted for your passphrase again until the configurable duration has passed.</p>
<p>We will be using Ed25519 keys which, according to <a href="https://linux-audit.com/using-ed25519-openssh-keys-instead-of-dsa-rsa-ecdsa/" target="_blank" rel="noopener">https://linux-audit.com/</a>:</p>
<blockquote>
<p>It is using an elliptic curve signature scheme, which offers better security than ECDSA and DSA. At the same time, it also has good performance.</p>
</blockquote>
<h4 id="goals">Goals</h4>
<ul>
<li>Ed25519 public/private SSH keys:
<ul>
<li>private key on your client</li>
<li>public key on your server</li>
</ul>
</li>
</ul>
<h4 id="notes">Notes</h4>
<ul>
<li>You&rsquo;ll need to do this step for every computer and account you&rsquo;ll be connecting to your server from/as.</li>
</ul>
<h4 id="references">References</h4>
<ul>
<li><a href="https://www.ssh.com/ssh/public-key-authentication" target="_blank" rel="noopener">https://www.ssh.com/ssh/public-key-authentication</a></li>
<li><a href="https://help.ubuntu.com/community/SSH/OpenSSH/Keys" target="_blank" rel="noopener">https://help.ubuntu.com/community/SSH/OpenSSH/Keys</a></li>
<li><a href="https://linux-audit.com/using-ed25519-openssh-keys-instead-of-dsa-rsa-ecdsa/" target="_blank" rel="noopener">https://linux-audit.com/using-ed25519-openssh-keys-instead-of-dsa-rsa-ecdsa/</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/understanding-the-ssh-encryption-and-connection-process" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/understanding-the-ssh-encryption-and-connection-process</a></li>
<li><a href="https://wiki.archlinux.org/index.php/SSH_Keys" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/SSH_Keys</a></li>
<li><a href="https://www.ssh.com/ssh/copy-id" target="_blank" rel="noopener">https://www.ssh.com/ssh/copy-id</a></li>
<li><code>man ssh-keygen</code></li>
<li><code>man ssh-copy-id</code></li>
<li><code>man ssh-add</code></li>
</ul>
<h4 id="steps">Steps</h4>
<ol>
<li>
<p>From the computer you&rsquo;re going to use to connect to your server, <strong>the client</strong>, not the server itself, create an <a href="https://linux-audit.com/using-ed25519-openssh-keys-instead-of-dsa-rsa-ecdsa/" target="_blank" rel="noopener">Ed25519</a> key with <code>ssh-keygen</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh-keygen -t ed25519
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Generating public/private ed25519 key pair.
Enter file in which to save the key (/home/user/.ssh/id_ed25519):
Created directory &#39;/home/user/.ssh&#39;.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/user/.ssh/id_ed25519.
Your public key has been saved in /home/user/.ssh/id_ed25519.pub.
The key fingerprint is:
SHA256:F44D4dr2zoHqgj0i2iVIHQ32uk/Lx4P+raayEAQjlcs user@client
The key&#39;s randomart image is:
+--[ED25519 256]--+
|xxxx  x          |
|o.o +. .         |
| o o oo   .      |
|. E oo . o .     |
| o o. o S o      |
|... .. o o       |
|.+....+ o        |
|+.=++o.B..       |
|+..=**=o=.       |
+----[SHA256]-----+
</code></pre></blockquote>
<p><strong>Note</strong>: If you set a passphrase, you&rsquo;ll need to enter it every time you connect to your server using this key, unless you&rsquo;re using <code>ssh-agent</code>.</p>
</li>
<li>
<p>Now you need to <strong>append</strong> the public key <code>~/.ssh/id_ed25519.pub</code> from your client to the <code>~/.ssh/authorized_keys</code> file on your server. Since we&rsquo;re presumable still at home on the LAN, we&rsquo;re probably safe from <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_blank" rel="noopener">MIM</a> attacks, so we will use <code>ssh-copy-id</code> to transfer and append the public key:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh-copy-id user@server
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &#34;/home/user/.ssh/id_ed25519.pub&#34;
The authenticity of host &#39;host (192.168.1.96)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:QaDQb/X0XyVlogh87sDXE7MR8YIK7ko4wS5hXjRySJE.
Are you sure you want to continue connecting (yes/no)? yes
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
user@host&#39;s password:

Number of key(s) added: 1

Now try logging into the machine, with:   &#34;ssh &#39;user@host&#39;&#34;
and check to make sure that only the key(s) you wanted were added.
</code></pre></blockquote>
</li>
</ol>
<p>Now would be a good time to <a href="#prepost-installation-requirements">perform any tasks specific to your setup</a>.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="create-ssh-group-for-allowgroups">Create SSH Group For AllowGroups</h3>
<h4 id="why-1">Why</h4>
<p>To make it easy to control who can SSH to the server. By using a group, we can quickly add/remove accounts to the group to quickly allow or not allow SSH access to the server.</p>
<h4 id="how-it-works-1">How It Works</h4>
<p>We will use the <a href="#AllowGroups">AllowGroups option</a> in SSH&rsquo;s configuration file <a href="#secure-etcsshsshd_config"><code>/etc/ssh/sshd_config</code></a> to tell the SSH server to only allow users to SSH in if they are a member of a certain UNIX group. Anyone not in the group will not be able to SSH in.</p>
<h4 id="goals-1">Goals</h4>
<ul>
<li>a UNIX group that we&rsquo;ll use in <a href="#secure-etcsshsshd_config">Secure <code>/etc/ssh/sshd_config</code></a> to limit who can SSH to the server</li>
</ul>
<h4 id="notes-1">Notes</h4>
<ul>
<li>This is a prerequisite step to support the <code>AllowGroup</code> setting set in <a href="#secure-etcsshsshd_config">Secure <code>/etc/ssh/sshd_config</code></a>.</li>
</ul>
<h4 id="references-1">References</h4>
<ul>
<li><code>man groupadd</code></li>
<li><code>man usermod</code></li>
</ul>
<h4 id="steps-1">Steps</h4>
<ol>
<li>
<p>Create a group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo groupadd sshusers
</span></span></code></pre></div></li>
<li>
<p>Add account(s) to the group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo usermod -a -G sshusers user1
</span></span><span class="line"><span class="cl">sudo usermod -a -G sshusers user2
</span></span><span class="line"><span class="cl">sudo usermod -a -G sshusers ...
</span></span></code></pre></div><p>You&rsquo;ll need to do this for every account on your server that needs SSH access.</p>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="secure-etcsshsshd_config">Secure <code>/etc/ssh/sshd_config</code></h3>
<h4 id="why-2">Why</h4>
<p>SSH is a door into your server. This is especially true if you are opening ports on your router so you can SSH to your server from outside your home network. If it is not secured properly, a bad-actor could use it to gain unauthorized access to your system.</p>
<h4 id="how-it-works-2">How It Works</h4>
<p><code>/etc/ssh/sshd_config</code> is the default configuration file that the SSH server uses. We will use this file to tell what options the SSH server should use.</p>
<h4 id="goals-2">Goals</h4>
<ul>
<li>a secure SSH configuration</li>
</ul>
<h4 id="notes-2">Notes</h4>
<ul>
<li>Make sure you&rsquo;ve completed <a href="#create-ssh-group-for-allowgroups">Create SSH Group For AllowGroups</a> first.</li>
</ul>
<h4 id="references-2">References</h4>
<ul>
<li>Mozilla&rsquo;s OpenSSH guidelines for OpenSSH 6.7+ at <a href="https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67" target="_blank" rel="noopener">https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67</a></li>
<li><a href="https://linux-audit.com/audit-and-harden-your-ssh-configuration/" target="_blank" rel="noopener">https://linux-audit.com/audit-and-harden-your-ssh-configuration/</a></li>
<li><a href="https://www.ssh.com/ssh/sshd_config/" target="_blank" rel="noopener">https://www.ssh.com/ssh/sshd_config/</a></li>
<li><a href="https://www.techbrown.com/harden-ssh-secure-linux-vps-server/" target="_blank" rel="noopener">https://www.techbrown.com/harden-ssh-secure-linux-vps-server/</a> (broken; try <a href="http://web.archive.org/web/20200413100933/https://www.techbrown.com/harden-ssh-secure-linux-vps-server/" target="_blank" rel="noopener">http://web.archive.org/web/20200413100933/https://www.techbrown.com/harden-ssh-secure-linux-vps-server/</a>)</li>
<li><a href="https://serverfault.com/questions/660160/openssh-difference-between-internal-sftp-and-sftp-server/660325" target="_blank" rel="noopener">https://serverfault.com/questions/660160/openssh-difference-between-internal-sftp-and-sftp-server/660325</a></li>
<li><code>man sshd_config</code></li>
<li>Thanks to <a href="https://github.com/than0s" target="_blank" rel="noopener">than0s</a> for <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/38" target="_blank" rel="noopener">how to find duplicate settings</a>.</li>
</ul>
<h4 id="steps-2">Steps</h4>
<ol>
<li>
<p>Make a backup of OpenSSH server&rsquo;s configuration file <code>/etc/ssh/sshd_config</code> and remove comments to make it easier to read:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/ssh/sshd_config /etc/ssh/sshd_config-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo sed -i -r -e <span class="s1">&#39;/^#|^$/ d&#39;</span> /etc/ssh/sshd_config
</span></span></code></pre></div></li>
<li>
<p>Edit <code>/etc/ssh/sshd_config</code> then find and edit or add these settings that should be applied regardless of your configuration/setup:</p>
<p><strong>Note</strong>: SSH does not like duplicate contradicting settings. For example, if you have <code>ChallengeResponseAuthentication no</code> and then <code>ChallengeResponseAuthentication yes</code>, SSH will respect the first one and ignore the second. Your <code>/etc/ssh/sshd_config</code> file may already have some of the settings/lines below. To avoid issues you will need to manually go through your <code>/etc/ssh/sshd_config</code> file and address any duplicate contradicting settings.</p>
<pre tabindex="0"><code>########################################################################################################
# start settings from https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67 as of 2019-01-01
########################################################################################################

# Supported HostKey algorithms by order of preference.
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key

KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256

Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com

# LogLevel VERBOSE logs user&#39;s key fingerprint on login. Needed to have a clear audit track of which key was using to log in.
LogLevel VERBOSE

# Use kernel sandbox mechanisms where possible in unprivileged processes
# Systrace on OpenBSD, Seccomp on Linux, seatbelt on MacOSX/Darwin, rlimit elsewhere.
# Note: This setting is deprecated in OpenSSH 7.5 (https://www.openssh.com/txt/release-7.5)
# UsePrivilegeSeparation sandbox

########################################################################################################
# end settings from https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67 as of 2019-01-01
########################################################################################################

# don&#39;t let users set environment variables
PermitUserEnvironment no

# Log sftp level file access (read/write/etc.) that would not be easily logged otherwise.
Subsystem sftp  internal-sftp -f AUTHPRIV -l INFO

# only use the newer, more secure protocol
Protocol 2

# disable X11 forwarding as X11 is very insecure
# you really shouldn&#39;t be running X on a server anyway
X11Forwarding no

# disable port forwarding
AllowTcpForwarding no
AllowStreamLocalForwarding no
GatewayPorts no
PermitTunnel no

# don&#39;t allow login if the account has an empty password
PermitEmptyPasswords no

# ignore .rhosts and .shosts
IgnoreRhosts yes

# verify hostname matches IP
UseDNS yes

Compression no
TCPKeepAlive no
AllowAgentForwarding no
PermitRootLogin no

# don&#39;t allow .rhosts or /etc/hosts.equiv
HostbasedAuthentication no
</code></pre></li>
<li>
<p>Then <strong>find and edit or add</strong> these settings, and set values as per your requirements:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Valid Values</th>
<th>Example</th>
<th>Description</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><a name="AllowGroups"></a><strong>AllowGroups</strong></td>
<td>local UNIX group name</td>
<td><code>AllowGroups sshusers</code></td>
<td>group to allow SSH access to</td>
<td></td>
</tr>
<tr>
<td><strong>ClientAliveCountMax</strong></td>
<td>number</td>
<td><code>ClientAliveCountMax 0</code></td>
<td>maximum number of client alive messages sent without response</td>
<td></td>
</tr>
<tr>
<td><strong>ClientAliveInterval</strong></td>
<td>number of seconds</td>
<td><code>ClientAliveInterval 300</code></td>
<td>timeout in seconds before a response request</td>
<td></td>
</tr>
<tr>
<td><strong>ListenAddress</strong></td>
<td>space separated list of local addresses</td>
<td><ul><li><code>ListenAddress 0.0.0.0</code></li><li><code>ListenAddress 192.168.1.100</code></li></ul></td>
<td>local addresses <code>sshd</code> should listen on</td>
<td>See <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/1" target="_blank" rel="noopener">Issue #1</a> for important details.</td>
</tr>
<tr>
<td><strong>LoginGraceTime</strong></td>
<td>number of seconds</td>
<td><code>LoginGraceTime 30</code></td>
<td>time in seconds before login times-out</td>
<td></td>
</tr>
<tr>
<td><strong>MaxAuthTries</strong></td>
<td>number</td>
<td><code>MaxAuthTries 2</code></td>
<td>maximum allowed attempts to login</td>
<td></td>
</tr>
<tr>
<td><strong>MaxSessions</strong></td>
<td>number</td>
<td><code>MaxSessions 2</code></td>
<td>maximum number of open sessions</td>
<td></td>
</tr>
<tr>
<td><strong>MaxStartups</strong></td>
<td>number</td>
<td><code>MaxStartups 2</code></td>
<td>maximum number of login sessions</td>
<td></td>
</tr>
<tr>
<td><a name="PasswordAuthentication"></a><strong>PasswordAuthentication</strong></td>
<td><code>yes</code> or <code>no</code></td>
<td><code>PasswordAuthentication no</code></td>
<td>if login with a password is allowed</td>
<td></td>
</tr>
<tr>
<td><strong>Port</strong></td>
<td>any open/available port number</td>
<td><code>Port 22</code></td>
<td>port that <code>sshd</code> should listen on</td>
<td></td>
</tr>
</tbody>
</table>
<p>Check <code>man sshd_config</code> for more details what these settings mean.</p>
</li>
<li>
<p>Make sure there are no duplicate settings that contradict each other. The below command should not have any output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">awk <span class="s1">&#39;NF &amp;&amp; $1!~/^(#|HostKey)/{print $1}&#39;</span> /etc/ssh/sshd_config <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> grep -v <span class="s1">&#39; 1 &#39;</span>
</span></span></code></pre></div></li>
<li>
<p>Restart ssh:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service sshd restart
</span></span></code></pre></div></li>
<li>
<p>You can check verify the configurations worked with <code>sshd -T</code> and verify the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sshd -T
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>port 22
addressfamily any
listenaddress [::]:22
listenaddress 0.0.0.0:22
usepam yes
logingracetime 30
x11displayoffset 10
maxauthtries 2
maxsessions 2
clientaliveinterval 300
clientalivecountmax 0
streamlocalbindmask 0177
permitrootlogin no
ignorerhosts yes
ignoreuserknownhosts no
hostbasedauthentication no
...
subsystem sftp internal-sftp -f AUTHPRIV -l INFO
maxstartups 2:30:2
permittunnel no
ipqos lowdelay throughput
rekeylimit 0 0
permitopen any
</code></pre></blockquote>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="remove-short-diffie-hellman-keys">Remove Short Diffie-Hellman Keys</h3>
<h4 id="why-3">Why</h4>
<p>Per <a href="https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67" target="_blank" rel="noopener">Mozilla&rsquo;s OpenSSH guidelines for OpenSSH 6.7+</a>, &ldquo;all Diffie-Hellman moduli in use should be at least 3072-bit-long&rdquo;.</p>
<p>The Diffie-Hellman algorithm is used by SSH to establish a secure connection. The larger the moduli (key size) the stronger the encryption.</p>
<h4 id="goals-3">Goals</h4>
<ul>
<li>remove all Diffie-Hellman keys that are less than 3072 bits long</li>
</ul>
<h4 id="references-3">References</h4>
<ul>
<li>Mozilla&rsquo;s OpenSSH guidelines for OpenSSH 6.7+ at <a href="https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67" target="_blank" rel="noopener">https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67</a></li>
<li><a href="https://infosec.mozilla.org/guidelines/key_management" target="_blank" rel="noopener">https://infosec.mozilla.org/guidelines/key_management</a></li>
<li><code>man moduli</code></li>
</ul>
<h4 id="steps-3">Steps</h4>
<ol>
<li>
<p>Make a backup of SSH&rsquo;s moduli file <code>/etc/ssh/moduli</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/ssh/moduli /etc/ssh/moduli-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Remove short moduli:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo awk <span class="s1">&#39;$5 &gt;= 3071&#39;</span> /etc/ssh/moduli <span class="p">|</span> sudo tee /etc/ssh/moduli.tmp
</span></span><span class="line"><span class="cl">sudo mv /etc/ssh/moduli.tmp /etc/ssh/moduli
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="2famfa-for-ssh">2FA/MFA for SSH</h3>
<h4 id="why-4">Why</h4>
<p>Even though SSH is a pretty good security guard for your doors and windows, it is still a visible door that bad-actors can see and try to brute-force in. <a href="#fail2ban-application-intrusion-detection-and-prevention">Fail2ban</a> will monitor for these brute-force attempts but there is no such thing as being too secure. Requiring two factors adds an extra layer of security.</p>
<p>Using Two Factor Authentication (2FA) / Multi Factor Authentication (MFA) requires anyone entering to have <strong>two</strong> keys to enter which makes it harder for bad actors. The two keys are:</p>
<ol>
<li>Their password</li>
<li>A 6 digit token that changes every 30 seconds</li>
</ol>
<p>Without both keys, they won&rsquo;t be able to get in.</p>
<h4 id="why-not">Why Not</h4>
<p>Many folks might find the experience cumbersome or annoying. And, access to your system is dependent on the accompanying authenticator app that generates the code.</p>
<h4 id="how-it-works-3">How It Works</h4>
<p>On Linux, PAM is responsible for authentication. There are four tasks to PAM that you can read about at <a href="https://en.wikipedia.org/wiki/Linux_PAM" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Linux_PAM</a>. This section talks about the authentication task.</p>
<p>When you log into a server, be it directly from the console or via SSH, the door you came through will send the request to the authentication task of PAM and PAM will ask for and verify your password. You can customize the rules each doors use. For example, you could have one set of rules when logging in directly from the console and another set of rules for when logging in via SSH.</p>
<p>This section will alter the authentication rules for when logging in via SSH to require both a password and a 6 digit code.</p>
<p>We will use Google&rsquo;s libpam-google-authenticator PAM module to create and verify a <a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm" target="_blank" rel="noopener">TOTP</a> key. <a href="https://fastmail.blog/2016/07/22/how-totp-authenticator-apps-work/" target="_blank" rel="noopener">https://fastmail.blog/2016/07/22/how-totp-authenticator-apps-work/</a> and <a href="https://jemurai.com/2018/10/11/how-it-works-totp-based-mfa/" target="_blank" rel="noopener">https://jemurai.com/2018/10/11/how-it-works-totp-based-mfa/</a> have very good writeups of how TOTP works.</p>
<p>What we will do is tell the server&rsquo;s SSH PAM configuration to ask the user for their password and then their numeric token. PAM will then verify the user&rsquo;s password and, if it is correct, then it will route the authentication request to libpam-google-authenticator which will ask for and verify your 6 digit token. If, and only if, everything is good will the authentication succeed and user be allowed to log in.</p>
<h4 id="goals-4">Goals</h4>
<ul>
<li>2FA/MFA enabled for all SSH connections</li>
</ul>
<h4 id="notes-3">Notes</h4>
<ul>
<li>Before you do this, you should have an idea of how 2FA/MFA works and you&rsquo;ll need an authenticator app on your phone to continue.</li>
<li>We&rsquo;ll use <a href="https://github.com/google/google-authenticator-libpam" target="_blank" rel="noopener">google-authenticator-libpam</a>.</li>
<li>With the below configuration, a user will only need to enter their 2FA/MFA code if they are logging on with their password but <strong>not</strong> if they are using <a href="#ssh-publicprivate-keys">SSH public/private keys</a>. Check the documentation on how to change this behavior to suite your requirements.</li>
</ul>
<h4 id="references-4">References</h4>
<ul>
<li><a href="https://github.com/google/google-authenticator-libpam" target="_blank" rel="noopener">https://github.com/google/google-authenticator-libpam</a></li>
<li><a href="https://en.wikipedia.org/wiki/Linux_PAM" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Linux_PAM</a></li>
<li><a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm</a></li>
<li><a href="https://fastmail.blog/2016/07/22/how-totp-authenticator-apps-work/" target="_blank" rel="noopener">https://fastmail.blog/2016/07/22/how-totp-authenticator-apps-work/</a></li>
<li><a href="https://jemurai.com/2018/10/11/how-it-works-totp-based-mfa/" target="_blank" rel="noopener">https://jemurai.com/2018/10/11/how-it-works-totp-based-mfa/</a></li>
</ul>
<h4 id="steps-4">Steps</h4>
<ol>
<li>
<p>Install it libpam-google-authenticator.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install libpam-google-authenticator
</span></span></code></pre></div></li>
<li>
<p><strong>Make sure you&rsquo;re logged in as the ID you want to enable 2FA/MFA for</strong> and <strong>execute</strong> <code>google-authenticator</code> to create the necessary token data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">google-authenticator
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Do you want authentication tokens to be time-based (y/n) y
https://www.google.com/chart?chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/user@host%3Fsecret%3DR4ZWX34FQKZROVX7AGLJ64684Y%26issuer%3Dhost

...

Your new secret key is: R3NVX3FFQKZROVX7AGLJUGGESY
Your verification code is 751419
Your emergency scratch codes are:
  12345678
  90123456
  78901234
  56789012
  34567890

Do you want me to update your &#34;/home/user/.google_authenticator&#34; file (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, tokens are good for 30 seconds. In order to compensate for
possible time-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with
poor time synchronization, you can increase the window from its default
size of +-1min (window size of 3) to about +-4min (window size of
17 acceptable tokens).
Do you want to do so? (y/n) y

If the computer that you are logging into isn&#39;t hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y
</code></pre></blockquote>
<p>Notice this is <strong>not run as root</strong>.</p>
<p>Select default option (y in most cases) for all the questions it asks and remember to save the emergency scratch codes.</p>
</li>
<li>
<p>Make a backup of PAM&rsquo;s SSH configuration file <code>/etc/pam.d/sshd</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/pam.d/sshd /etc/pam.d/sshd-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Now we need to enable it as an authentication method for SSH by adding this line to <code>/etc/pam.d/sshd</code>:</p>
<pre tabindex="0"><code>auth       required     pam_google_authenticator.so nullok
</code></pre><p><strong>Note</strong>: Check <a href="https://github.com/google/google-authenticator-libpam/blob/master/README.md#nullok" target="_blank" rel="noopener">here</a> for what <code>nullok</code> means.</p>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\nauth       required     pam_google_authenticator.so nullok         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/pam.d/sshd
</span></span></code></pre></div></li>
<li>
<p>Tell SSH to leverage it by adding or editing this line in <code>/etc/ssh/sshd_config</code>:</p>
<pre tabindex="0"><code>ChallengeResponseAuthentication yes
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;s/^(challengeresponseauthentication .*)</span>$<span class="s2">/# \1         # commented by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">/I&#34;</span> /etc/ssh/sshd_config
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\nChallengeResponseAuthentication yes         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/ssh/sshd_config
</span></span></code></pre></div></li>
<li>
<p>Restart ssh:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service sshd restart
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-basics">The Basics</h2>
<h3 id="limit-who-can-use-sudo">Limit Who Can Use sudo</h3>
<h4 id="why-5">Why</h4>
<p>sudo lets accounts run commands as other accounts, including <strong>root</strong>. We want to make sure that only the accounts we want can use sudo.</p>
<h4 id="goals-5">Goals</h4>
<ul>
<li>sudo privileges limited to those who are in a group we specify</li>
</ul>
<h4 id="notes-4">Notes</h4>
<ul>
<li>Your installation may have already done this, or may already have a special group intended for this purpose so check first.
<ul>
<li>
<p>Debian creates the sudo group. To view users that are part of this group (thus have sudo privileges):</p>
<pre tabindex="0"><code>cat /etc/group | grep &#34;sudo&#34;
</code></pre></li>
<li>
<p>RedHat creates the wheel group</p>
</li>
</ul>
</li>
<li>See <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/39" target="_blank" rel="noopener">https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/39</a> for a note on some distributions making it so <code>sudo</code> does not require a password. Thanks to <a href="https://github.com/sbrl" target="_blank" rel="noopener">sbrl</a> for sharing.</li>
</ul>
<h4 id="steps-5">Steps</h4>
<ol>
<li>
<p>Create a group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo groupadd sudousers
</span></span></code></pre></div></li>
<li>
<p>Add account(s) to the group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo usermod -a -G sudousers user1
</span></span><span class="line"><span class="cl">sudo usermod -a -G sudousers user2
</span></span><span class="line"><span class="cl">sudo usermod -a -G sudousers  ...
</span></span></code></pre></div><p>You&rsquo;ll need to do this for every account on your server that needs sudo privileges.</p>
</li>
<li>
<p>Make a backup of the sudo&rsquo;s configuration file <code>/etc/sudoers</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/sudoers /etc/sudoers-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Edit sudo&rsquo;s configuration file <code>/etc/sudoers</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo visudo
</span></span></code></pre></div></li>
<li>
<p>Tell sudo to only allow users in the <code>sudousers</code> group to use sudo by adding this line if it is not already there:</p>
<pre tabindex="0"><code>%sudousers   ALL=(ALL:ALL) ALL
</code></pre></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="limit-who-can-use-su">Limit Who Can Use su</h3>
<h4 id="why-6">Why</h4>
<p>su also lets accounts run commands as other accounts, including <strong>root</strong>. We want to make sure that only the accounts we want can use su.</p>
<h4 id="goals-6">Goals</h4>
<ul>
<li>su privileges limited to those who are in a group we specify</li>
</ul>
<h4 id="references-5">References</h4>
<ul>
<li>Thanks to <a href="https://github.com/olavim" target="_blank" rel="noopener">olavim</a> for sharing <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/41" target="_blank" rel="noopener">this idea</a></li>
</ul>
<h4 id="steps-6">Steps</h4>
<ol>
<li>
<p>Create a group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo groupadd suusers
</span></span></code></pre></div></li>
<li>
<p>Add account(s) to the group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo usermod -a -G suusers user1
</span></span><span class="line"><span class="cl">sudo usermod -a -G suusers user2
</span></span><span class="line"><span class="cl">sudo usermod -a -G suusers  ...
</span></span></code></pre></div><p>You&rsquo;ll need to do this for every account on your server that needs sudo privileges.</p>
</li>
<li>
<p>Make it so only users in this group can execute <code>/bin/su</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-statoverride --update --add root suusers <span class="m">4750</span> /bin/su
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="run-applications-in-a-sandbox-with-firejail">Run applications in a sandbox with FireJail</h3>
<h4 id="why-7">Why</h4>
<p>It&rsquo;s absolutely better, for many applications, to run in a sandbox.</p>
<p>Browsers (even more the Closed Source ones) and eMail Clients are highly suggested.</p>
<h4 id="goals-7">Goals</h4>
<ul>
<li>confine applications in a jail (few safe directories) and block access to the rest of the system</li>
</ul>
<h4 id="references-6">References</h4>
<ul>
<li>Thanks to <a href="https://firejail.wordpress.com/" target="_blank" rel="noopener">FireJail</a></li>
</ul>
<h4 id="steps-7">Steps</h4>
<ol>
<li>
<p>Install the software:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install firejail firejail-profiles
</span></span></code></pre></div><p>Note: for Debian 10 Stable, official Backport is suggested:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install -t buster-backports firejail firejail-profiles
</span></span></code></pre></div></li>
<li>
<p>Allow an application (installed in <code>/usr/bin</code> or <code>/bin</code>) to run only in a sandbox (see few examples below here):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ln -s /usr/bin/firejail /usr/local/bin/google-chrome-stable
</span></span><span class="line"><span class="cl">sudo ln -s /usr/bin/firejail /usr/local/bin/firefox
</span></span><span class="line"><span class="cl">sudo ln -s /usr/bin/firejail /usr/local/bin/chromium
</span></span><span class="line"><span class="cl">sudo ln -s /usr/bin/firejail /usr/local/bin/evolution
</span></span><span class="line"><span class="cl">sudo ln -s /usr/bin/firejail /usr/local/bin/thunderbird
</span></span></code></pre></div></li>
<li>
<p>Run the application as usual (via terminal or launcher) and check if is running in a jail:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">firejail --list
</span></span></code></pre></div></li>
<li>
<p>Allow a sandboxed app to run again as it was before (example: firefox)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo rm /usr/local/bin/firefox
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="ntp-client">NTP Client</h3>
<h4 id="why-8">Why</h4>
<p>Many security protocols leverage the time. If your system time is incorrect, it could have negative impacts to your server. An NTP client can solve that problem by keeping your system time in-sync with <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noopener">global NTP servers</a></p>
<h4 id="how-it-works-4">How It Works</h4>
<p>NTP stands for Network Time Protocol. In the context of this guide, an NTP client on the server is used to update the server time with the official time pulled from official servers. Check <a href="https://www.pool.ntp.org/en/" target="_blank" rel="noopener">https://www.pool.ntp.org/en/</a> for all of the public NTP servers.</p>
<h4 id="goals-8">Goals</h4>
<ul>
<li>NTP client installed and keeping server time in-sync</li>
</ul>
<h4 id="references-7">References</h4>
<ul>
<li><a href="https://cloudpro.zone/index.php/2018/01/27/debian-9-3-server-setup-guide-part-4/" target="_blank" rel="noopener">https://cloudpro.zone/index.php/2018/01/27/debian-9-3-server-setup-guide-part-4/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Network_Time_Protocol</a></li>
<li><a href="https://www.pool.ntp.org/en/" target="_blank" rel="noopener">https://www.pool.ntp.org/en/</a></li>
<li><a href="https://serverfault.com/questions/957302/securing-hardening-ntp-client-on-linux-servers-config-file/957450#957450" target="_blank" rel="noopener">https://serverfault.com/questions/957302/securing-hardening-ntp-client-on-linux-servers-config-file/957450#957450</a></li>
<li><a href="https://tf.nist.gov/tf-cgi/servers.cgi" target="_blank" rel="noopener">https://tf.nist.gov/tf-cgi/servers.cgi</a></li>
</ul>
<h4 id="steps-8">Steps</h4>
<ol>
<li>
<p>Install ntp.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install ntp
</span></span></code></pre></div></li>
<li>
<p>Make a backup of the NTP client&rsquo;s configuration file <code>/etc/ntp.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/ntp.conf /etc/ntp.conf-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>The default configuration, at least on Debian, is already pretty secure. The only thing we&rsquo;ll want to make sure is we&rsquo;re the <code>pool</code> directive and not any <code>server</code> directives. The <code>pool</code> directive allows the NTP client to stop using a server if it is unresponsive or serving bad time. Do this by commenting out all <code>server</code> directives and adding the below to <code>/etc/ntp.conf</code>.</p>
<pre tabindex="0"><code>pool pool.ntp.org iburst
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;s/^((server|pool).*)/# \1         # commented by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">/&#34;</span> /etc/ntp.conf
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\npool pool.ntp.org iburst         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/ntp.conf
</span></span></code></pre></div><p><strong>Example <code>/etc/ntp.conf</code></strong>:</p>
<blockquote>
<pre tabindex="0"><code>driftfile /var/lib/ntp/ntp.drift
statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable
restrict -4 default kod notrap nomodify nopeer noquery limited
restrict -6 default kod notrap nomodify nopeer noquery limited
restrict 127.0.0.1
restrict ::1
restrict source notrap nomodify noquery
pool pool.ntp.org iburst         # added by user on 2019-03-09 @ 10:23:35
</code></pre></blockquote>
</li>
<li>
<p>Restart ntp:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service ntp restart
</span></span></code></pre></div></li>
<li>
<p>Check the status of the ntp service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl status ntp
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>● ntp.service - LSB: Start NTP daemon
   Loaded: loaded (/etc/init.d/ntp; generated; vendor preset: enabled)
   Active: active (running) since Sat 2019-03-09 15:19:46 EST; 4s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 1016 ExecStop=/etc/init.d/ntp stop (code=exited, status=0/SUCCESS)
  Process: 1028 ExecStart=/etc/init.d/ntp start (code=exited, status=0/SUCCESS)
    Tasks: 2 (limit: 4915)
   CGroup: /system.slice/ntp.service
           └─1038 /usr/sbin/ntpd -p /var/run/ntpd.pid -g -u 108:113

Mar 09 15:19:46 host ntpd[1038]: Listen and drop on 0 v6wildcard [::]:123
Mar 09 15:19:46 host ntpd[1038]: Listen and drop on 1 v4wildcard 0.0.0.0:123
Mar 09 15:19:46 host ntpd[1038]: Listen normally on 2 lo 127.0.0.1:123
Mar 09 15:19:46 host ntpd[1038]: Listen normally on 3 enp0s3 10.10.20.96:123
Mar 09 15:19:46 host ntpd[1038]: Listen normally on 4 lo [::1]:123
Mar 09 15:19:46 host ntpd[1038]: Listen normally on 5 enp0s3 [fe80::a00:27ff:feb6:ed8e%2]:123
Mar 09 15:19:46 host ntpd[1038]: Listening on routing socket on fd #22 for interface updates
Mar 09 15:19:47 host ntpd[1038]: Soliciting pool server 108.61.56.35
Mar 09 15:19:48 host ntpd[1038]: Soliciting pool server 69.89.207.199
Mar 09 15:19:49 host ntpd[1038]: Soliciting pool server 45.79.111.114
</code></pre></blockquote>
</li>
<li>
<p>Check ntp&rsquo;s status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ntpq -p
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 pool.ntp.org    .POOL.          16 p    -   64    0    0.000    0.000   0.000
*lithium.constan 198.30.92.2      2 u    -   64    1   19.900    4.894   3.951
 ntp2.wiktel.com 212.215.1.157    2 u    2   64    1   48.061   -0.431   0.104
</code></pre></blockquote>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="securing-proc">Securing /proc</h3>
<h4 id="why-9">Why</h4>
<p>To quote <a href="https://linux-audit.com/linux-system-hardening-adding-hidepid-to-proc/" target="_blank" rel="noopener">https://linux-audit.com/linux-system-hardening-adding-hidepid-to-proc/</a>:</p>
<blockquote>
<p>When looking in <code>/proc</code> you will discover a lot of files and directories. Many of them are just numbers, which represent the information about a particular process ID (PID). By default, Linux systems are deployed to allow all local users to see this all information. This includes process information from other users. This could include sensitive details that you may not want to share with other users. By applying some filesystem configuration tweaks, we can change this behavior and improve the security of the system.</p>
</blockquote>
<p><strong>Note</strong>: This may break on some <code>systemd</code> systems. Please see <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/37" target="_blank" rel="noopener">https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/37</a> for more information. Thanks to <a href="https://github.com/nlgranger" target="_blank" rel="noopener">nlgranger</a> for sharing.</p>
<h4 id="goals-9">Goals</h4>
<ul>
<li><code>/proc</code> mounted with <code>hidepid=2</code> so users can only see information about their processes</li>
</ul>
<h4 id="references-8">References</h4>
<ul>
<li><a href="https://linux-audit.com/linux-system-hardening-adding-hidepid-to-proc/" target="_blank" rel="noopener">https://linux-audit.com/linux-system-hardening-adding-hidepid-to-proc/</a></li>
<li><a href="https://likegeeks.com/secure-linux-server-hardening-best-practices/#Hardening-proc-Directory" target="_blank" rel="noopener">https://likegeeks.com/secure-linux-server-hardening-best-practices/#Hardening-proc-Directory</a></li>
<li><a href="https://www.cyberciti.biz/faq/linux-hide-processes-from-other-users/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/linux-hide-processes-from-other-users/</a></li>
</ul>
<h4 id="steps-9">Steps</h4>
<ol>
<li>
<p>Make a backup of <code>/etc/fstab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/fstab /etc/fstab-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Add this line to <code>/etc/fstab</code> to have <code>/proc</code> mounted with <code>hidepid=2</code>:</p>
<pre tabindex="0"><code>proc     /proc     proc     defaults,hidepid=2     0     0
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\nproc     /proc     proc     defaults,hidepid=2     0     0         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/fstab
</span></span></code></pre></div></li>
<li>
<p>Reboot the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo reboot now
</span></span></code></pre></div><p><strong>Note</strong>: Alternatively, you can remount <code>/proc</code> without rebooting with <code>sudo mount -o remount,hidepid=2 /proc</code></p>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="force-accounts-to-use-secure-passwords">Force Accounts To Use Secure Passwords</h3>
<h4 id="why-10">Why</h4>
<p>By default, accounts can use any password they want, including bad ones. <a href="https://linux.die.net/man/5/pwquality.conf" target="_blank" rel="noopener">pwquality</a>/<a href="https://linux.die.net/man/8/pam_pwquality" target="_blank" rel="noopener">pam_pwquality</a> addresses this security gap by providing &ldquo;a way to configure the default password quality requirements for the system passwords&rdquo; and checking &ldquo;its strength against a system dictionary and a set of rules for identifying poor choices.&rdquo;</p>
<h4 id="how-it-works-5">How It Works</h4>
<p>On Linux, PAM is responsible for authentication. There are four tasks to PAM that you can read about at <a href="https://en.wikipedia.org/wiki/Linux_PAM" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Linux_PAM</a>. This section talks about the password task.</p>
<p>When there is a need to set or change an account password, the password task of PAM handles the request. In this section we will tell PAM&rsquo;s password task to pass the requested new password to libpam-pwquality to make sure it meets our requirements. If the requirements are met it is used/set; if it does not meet the requirements it errors and lets the user know.</p>
<h4 id="goals-10">Goals</h4>
<ul>
<li>enforced strong passwords</li>
</ul>
<h4 id="steps-10">Steps</h4>
<ol>
<li>
<p>Install libpam-pwquality.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install libpam-pwquality
</span></span></code></pre></div></li>
<li>
<p>Make a backup of PAM&rsquo;s password configuration file <code>/etc/pam.d/common-password</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/pam.d/common-password /etc/pam.d/common-password-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Tell PAM to use libpam-pwquality to enforce strong passwords by editing the file <code>/etc/pam.d/common-password</code> and change the line that starts like this:</p>
<pre tabindex="0"><code>password        requisite                       pam_pwquality.so
</code></pre><p>to this:</p>
<pre tabindex="0"><code>password        requisite                       pam_pwquality.so retry=3 minlen=10 difok=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 maxrepeat=3 gecoschec
</code></pre><p>The above options are:</p>
<ul>
<li><code>retry=3</code> = prompt user 3 times before returning with error.</li>
<li><code>minlen=10</code> = the minimum length of the password, factoring in any credits (or debits) from these:
<ul>
<li><code>dcredit=-1</code> = must have at least <strong>one digit</strong></li>
<li><code>ucredit=-1</code> = must have at least <strong>one upper case letter</strong></li>
<li><code>lcredit=-1</code> = must have at least <strong>one lower case letter</strong></li>
<li><code>ocredit=-1</code> = must have at least <strong>one non-alphanumeric character</strong></li>
</ul>
</li>
<li><code>difok=3</code> = at least 3 characters from the new password cannot have been in the old password</li>
<li><code>maxrepeat=3</code> = allow a maximum of 3 repeated characters</li>
<li><code>gecoschec</code> = do not allow passwords with the account&rsquo;s name</li>
</ul>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;s/^(password\s+requisite\s+pam_pwquality.so)(.*)</span>$<span class="s2">/# \1\2         # commented by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\n\1 retry=3 minlen=10 difok=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 maxrepeat=3 gecoschec         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">/&#34;</span> /etc/pam.d/common-password
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="automatic-security-updates-and-alerts">Automatic Security Updates and Alerts</h3>
<h4 id="why-11">Why</h4>
<p>It is important to keep a server updated with the latest <strong>critical security patches and updates</strong>. Otherwise you&rsquo;re at risk of known security vulnerabilities that bad-actors could use to gain unauthorized access to your server.</p>
<p>Unless you plan on checking your server every day, you&rsquo;ll want a way to automatically update the system and/or get emails about available updates.</p>
<p>You don&rsquo;t want to do all updates because with every update there is a risk of something breaking. It is important to do the critical updates but everything else can wait until you have time to do it manually.</p>
<h4 id="why-not-1">Why Not</h4>
<p>Automatic and unattended updates may break your system and you may not be near your server to fix it. This would be especially problematic if it broke your SSH access.</p>
<h4 id="notes-5">Notes</h4>
<ul>
<li>Each distribution manages packages and updates differently. So far I only have steps for Debian based systems.</li>
<li>Your server will need a way to send e-mails for this to work</li>
</ul>
<h4 id="goals-11">Goals</h4>
<ul>
<li>Automatic, unattended, updates of critical security patches</li>
<li>Automatic emails of remaining pending updates</li>
</ul>
<h4 id="debian-based-systems">Debian Based Systems</h4>
<h5 id="how-it-works-6">How It Works</h5>
<p>On Debian based systems you can use:</p>
<ul>
<li>unattended-upgrades to automatically do system updates you want (i.e. critical security updates)</li>
<li>apt-listchanges to get details about package changes before they are installed/upgraded</li>
<li>apticron to get emails for pending package updates</li>
</ul>
<p>We will use unattended-upgrades to apply <strong>critical security patches</strong>. We can also apply stable updates since they&rsquo;ve already been thoroughly tested by the Debian community.</p>
<h5 id="references-9">References</h5>
<ul>
<li><a href="https://wiki.debian.org/UnattendedUpgrades" target="_blank" rel="noopener">https://wiki.debian.org/UnattendedUpgrades</a></li>
<li><a href="https://debian-handbook.info/browse/stable/sect.regular-upgrades.html" target="_blank" rel="noopener">https://debian-handbook.info/browse/stable/sect.regular-upgrades.html</a></li>
<li><a href="https://blog.sleeplessbeastie.eu/2015/01/02/how-to-perform-unattended-upgrades/" target="_blank" rel="noopener">https://blog.sleeplessbeastie.eu/2015/01/02/how-to-perform-unattended-upgrades/</a></li>
<li><a href="https://www.vultr.com/docs/how-to-set-up-unattended-upgrades-on-debian-9-stretch" target="_blank" rel="noopener">https://www.vultr.com/docs/how-to-set-up-unattended-upgrades-on-debian-9-stretch</a></li>
<li><a href="https://github.com/mvo5/unattended-upgrades" target="_blank" rel="noopener">https://github.com/mvo5/unattended-upgrades</a></li>
<li><a href="https://wiki.debian.org/UnattendedUpgrades#apt-listchanges" target="_blank" rel="noopener">https://wiki.debian.org/UnattendedUpgrades#apt-listchanges</a></li>
<li><a href="https://www.cyberciti.biz/faq/apt-get-apticron-send-email-upgrades-available/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/apt-get-apticron-send-email-upgrades-available/</a></li>
<li><a href="https://www.unixmen.com/how-to-get-email-notifications-for-new-updates-on-debianubuntu/" target="_blank" rel="noopener">https://www.unixmen.com/how-to-get-email-notifications-for-new-updates-on-debianubuntu/</a></li>
<li><code>/etc/apt/apt.conf.d/50unattended-upgrades</code></li>
</ul>
<h5 id="steps-11">Steps</h5>
<ol>
<li>
<p>Install unattended-upgrades, apt-listchanges, and apticron:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install unattended-upgrades apt-listchanges apticron
</span></span></code></pre></div></li>
<li>
<p>Now we need to configure unattended-upgrades to automatically apply the updates. This is typically done by editing the files <code>/etc/apt/apt.conf.d/20auto-upgrades</code> and <code>/etc/apt/apt.conf.d/50unattended-upgrades</code> that were created by the packages. However, because these file may get overwritten with a future update, we&rsquo;ll create a new file instead. Create the file <code>/etc/apt/apt.conf.d/51myunattended-upgrades</code> and add this:</p>
<pre tabindex="0"><code>// Enable the update/upgrade script (0=disable)
APT::Periodic::Enable &#34;1&#34;;

// Do &#34;apt-get update&#34; automatically every n-days (0=disable)
APT::Periodic::Update-Package-Lists &#34;1&#34;;

// Do &#34;apt-get upgrade --download-only&#34; every n-days (0=disable)
APT::Periodic::Download-Upgradeable-Packages &#34;1&#34;;

// Do &#34;apt-get autoclean&#34; every n-days (0=disable)
APT::Periodic::AutocleanInterval &#34;7&#34;;

// Send report mail to root
//     0:  no report             (or null string)
//     1:  progress report       (actually any string)
//     2:  + command outputs     (remove -qq, remove 2&gt;/dev/null, add -d)
//     3:  + trace on    APT::Periodic::Verbose &#34;2&#34;;
APT::Periodic::Unattended-Upgrade &#34;1&#34;;

// Automatically upgrade packages from these
Unattended-Upgrade::Origins-Pattern {
      &#34;o=Debian,a=stable&#34;;
      &#34;o=Debian,a=stable-updates&#34;;
      &#34;origin=Debian,codename=${distro_codename},label=Debian-Security&#34;;
};

// You can specify your own packages to NOT automatically upgrade here
Unattended-Upgrade::Package-Blacklist {
};

// Run dpkg --force-confold --configure -a if a unclean dpkg state is detected to true to ensure that updates get installed even when the system got interrupted during a previous run
Unattended-Upgrade::AutoFixInterruptedDpkg &#34;true&#34;;

//Perform the upgrade when the machine is running because we wont be shutting our server down often
Unattended-Upgrade::InstallOnShutdown &#34;false&#34;;

// Send an email to this address with information about the packages upgraded.
Unattended-Upgrade::Mail &#34;root&#34;;

// Always send an e-mail
Unattended-Upgrade::MailOnlyOnError &#34;false&#34;;

// Remove all unused dependencies after the upgrade has finished
Unattended-Upgrade::Remove-Unused-Dependencies &#34;true&#34;;

// Remove any new unused dependencies after the upgrade has finished
Unattended-Upgrade::Remove-New-Unused-Dependencies &#34;true&#34;;

// Automatically reboot WITHOUT CONFIRMATION if the file /var/run/reboot-required is found after the upgrade.
Unattended-Upgrade::Automatic-Reboot &#34;true&#34;;

// Automatically reboot even if users are logged in.
Unattended-Upgrade::Automatic-Reboot-WithUsers &#34;true&#34;;
</code></pre><p><strong>Notes</strong>:</p>
<ul>
<li>Check <code>/usr/lib/apt/apt.systemd.daily</code> for details on the <code>APT::Periodic</code> options</li>
<li>Check <a href="https://github.com/mvo5/unattended-upgrades" target="_blank" rel="noopener">https://github.com/mvo5/unattended-upgrades</a> for details on the <code>Unattended-Upgrade</code> options</li>
</ul>
</li>
<li>
<p>Run a dry-run of unattended-upgrades to make sure your configuration file is okay:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo unattended-upgrade -d --dry-run
</span></span></code></pre></div><p>If everything is okay, you can let it run whenever it&rsquo;s scheduled to or force a run with <code>unattended-upgrade -d</code>.</p>
</li>
<li>
<p>Configure apt-listchanges to your liking:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure apt-listchanges
</span></span></code></pre></div></li>
<li>
<p>For apticron, the default settings are good enough but you can check them in <code>/etc/apticron/apticron.conf</code> if you want to change them. For example, my configuration looks like this:</p>
<blockquote>
<pre tabindex="0"><code>EMAIL=&#34;root&#34;
NOTIFY_NO_UPDATES=&#34;1&#34;
</code></pre></blockquote>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="more-secure-random-entropy-pool-wip">More Secure Random Entropy Pool (WIP)</h3>
<h4 id="why-12">Why</h4>
<p>WIP</p>
<h4 id="how-it-works-7">How It Works</h4>
<p>WIP</p>
<h4 id="goals-12">Goals</h4>
<p>WIP</p>
<h4 id="references-10">References</h4>
<ul>
<li>Thanks to <a href="https://github.com/branneman" target="_blank" rel="noopener">branneman</a> for this idea as submitted in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/33" target="_blank" rel="noopener">issue #33</a>.</li>
<li><a href="https://hackaday.com/2017/11/02/what-is-entropy-and-how-do-i-get-more-of-it/" target="_blank" rel="noopener">https://hackaday.com/2017/11/02/what-is-entropy-and-how-do-i-get-more-of-it/</a></li>
<li><a href="https://www.2uo.de/myths-about-urandom" target="_blank" rel="noopener">https://www.2uo.de/myths-about-urandom</a></li>
<li><a href="https://www.gnu.org/software/hurd/user/tlecarrour/rng-tools.html" target="_blank" rel="noopener">https://www.gnu.org/software/hurd/user/tlecarrour/rng-tools.html</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Rng-tools" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Rng-tools</a></li>
<li><a href="https://www.howtoforge.com/helping-the-random-number-generator-to-gain-enough-entropy-with-rng-tools-debian-lenny" target="_blank" rel="noopener">https://www.howtoforge.com/helping-the-random-number-generator-to-gain-enough-entropy-with-rng-tools-debian-lenny</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-encryption-using_the_random_number_generator" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-encryption-using_the_random_number_generator</a></li>
</ul>
<h4 id="steps-12">Steps</h4>
<ol>
<li>
<p>Install rng-tools.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install rng-tools
</span></span></code></pre></div></li>
<li>
<p>Now we need to set the hardware device used to generate random numbers by adding this to <code>/etc/default/rng-tools</code>:</p>
<pre tabindex="0"><code>HRNGDEVICE=/dev/urandom
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;HRNGDEVICE=/dev/urandom&#34;</span> <span class="p">|</span> sudo tee -a /etc/default/rng-tools
</span></span></code></pre></div></li>
<li>
<p>Restart the service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl stop rng-tools.service
</span></span><span class="line"><span class="cl">sudo systemctl start rng-tools.service
</span></span></code></pre></div></li>
<li>
<p>Test randomness:</p>
<ul>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-encryption-using_the_random_number_generator" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-encryption-using_the_random_number_generator</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Rng-tools" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/Rng-tools</a></li>
</ul>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-network">The Network</h2>
<h3 id="firewall-with-ufw-uncomplicated-firewall">Firewall With UFW (Uncomplicated Firewall)</h3>
<h4 id="why-13">Why</h4>
<p>Call me paranoid, and you don&rsquo;t have to agree, but I want to deny all traffic in and out of my server except what I explicitly allow. Why would my server be sending traffic out that I don&rsquo;t know about? And why would external traffic be trying to access my server if I don&rsquo;t know who or what it is? When it comes to good security, my opinion is to reject/deny by default, and allow by exception.</p>
<p>Of course, if you disagree, that is totally fine and can configure UFW to suit your needs.</p>
<p>Either way, ensuring that only traffic we explicitly allow is the job of a firewall.</p>
<h4 id="how-it-works-8">How It Works</h4>
<p>The Linux kernel provides capabilities to monitor and control network traffic. These capabilities are exposed to the end-user through firewall utilities. On Linux, the most common firewall is <a href="https://en.wikipedia.org/wiki/Iptables" target="_blank" rel="noopener">iptables</a>. However, iptables is rather complicated and confusing (IMHO). This is where UFW comes in. Think of UFW as a front-end to iptables. It simplifies the process of managing the iptables rules that tell the Linux kernel what to do with network traffic.</p>
<p><strong>UFW</strong> works by letting you configure rules that:</p>
<ul>
<li><strong>allow</strong> or <strong>deny</strong></li>
<li><strong>input</strong> or <strong>output</strong> traffic</li>
<li><strong>to</strong> or <strong>from</strong> ports</li>
</ul>
<p>You can create rules by explicitly specifying the ports or with application configurations that specify the ports.</p>
<h4 id="goals-13">Goals</h4>
<ul>
<li>all network traffic, input and output, blocked except those we explicitly allow</li>
</ul>
<h4 id="notes-6">Notes</h4>
<ul>
<li>As you install other programs, you&rsquo;ll need to enable the necessary ports/applications.</li>
</ul>
<h4 id="references-11">References</h4>
<ul>
<li><a href="https://launchpad.net/ufw" target="_blank" rel="noopener">https://launchpad.net/ufw</a></li>
</ul>
<h4 id="steps-13">Steps</h4>
<ol>
<li>
<p>Install ufw.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install ufw
</span></span></code></pre></div></li>
<li>
<p>Deny all outgoing traffic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw default deny outgoing comment <span class="s1">&#39;deny all outgoing traffic&#39;</span>
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Default outgoing policy changed to &#39;deny&#39;
(be sure to update your rules accordingly)
</code></pre></blockquote>
<p>If you are not as paranoid as me, and don&rsquo;t want to deny all outgoing traffic, you can allow it instead:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw default allow outgoing comment <span class="s1">&#39;allow all outgoing traffic&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>Deny all incoming traffic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw default deny incoming comment <span class="s1">&#39;deny all incoming traffic&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>Obviously we want SSH connections in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw limit in ssh comment <span class="s1">&#39;allow SSH connections in&#39;</span>
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Rules updated
Rules updated (v6)
</code></pre></blockquote>
</li>
<li>
<p>Allow additional traffic as per your needs. Some common use-cases:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># allow traffic out to port 53 -- DNS</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">53</span> comment <span class="s1">&#39;allow DNS calls out&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow traffic out to port 123 -- NTP</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">123</span> comment <span class="s1">&#39;allow NTP out&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow traffic out for HTTP, HTTPS, or FTP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># apt might needs these depending on which sources you&#39;re using</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out http comment <span class="s1">&#39;allow HTTP traffic out&#39;</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out https comment <span class="s1">&#39;allow HTTPS traffic out&#39;</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out ftp comment <span class="s1">&#39;allow FTP traffic out&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow whois</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out whois comment <span class="s1">&#39;allow whois&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow mails for status notifications -- choose port according to your provider</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">25</span> comment <span class="s1">&#39;allow SMTP out&#39;</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">587</span> comment <span class="s1">&#39;allow SMTP out&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow traffic out to port 68 -- the DHCP client</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you only need this if you&#39;re using DHCP</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">67</span> comment <span class="s1">&#39;allow the DHCP client to update&#39;</span>
</span></span><span class="line"><span class="cl">sudo ufw allow out <span class="m">68</span> comment <span class="s1">&#39;allow the DHCP client to update&#39;</span>
</span></span></code></pre></div><p><strong>Note</strong>: You&rsquo;ll need to allow HTTP/HTTPS for installing packages and many other things.</p>
</li>
<li>
<p>Start ufw:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw <span class="nb">enable</span>
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
</code></pre></blockquote>
</li>
<li>
<p>If you want to see a status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw status
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Status: active

To                         Action      From
--                         ------      ----
22/tcp                     LIMIT       Anywhere                   # allow SSH connections in
22/tcp (v6)                LIMIT       Anywhere (v6)              # allow SSH connections in

53                         ALLOW OUT   Anywhere                   # allow DNS calls out
123                        ALLOW OUT   Anywhere                   # allow NTP out
80/tcp                     ALLOW OUT   Anywhere                   # allow HTTP traffic out
443/tcp                    ALLOW OUT   Anywhere                   # allow HTTPS traffic out
21/tcp                     ALLOW OUT   Anywhere                   # allow FTP traffic out
Mail submission            ALLOW OUT   Anywhere                   # allow mail out
43/tcp                     ALLOW OUT   Anywhere                   # allow whois
53 (v6)                    ALLOW OUT   Anywhere (v6)              # allow DNS calls out
123 (v6)                   ALLOW OUT   Anywhere (v6)              # allow NTP out
80/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow HTTP traffic out
443/tcp (v6)               ALLOW OUT   Anywhere (v6)              # allow HTTPS traffic out
21/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow FTP traffic out
Mail submission (v6)       ALLOW OUT   Anywhere (v6)              # allow mail out
43/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow whois
</code></pre></blockquote>
<p>or</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw status verbose
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Status: active
Logging: on (low)
Default: deny (incoming), deny (outgoing), disabled (routed)
New profiles: skip

To                         Action      From
--                         ------      ----
22/tcp                     LIMIT IN    Anywhere                   # allow SSH connections in
22/tcp (v6)                LIMIT IN    Anywhere (v6)              # allow SSH connections in

53                         ALLOW OUT   Anywhere                   # allow DNS calls out
123                        ALLOW OUT   Anywhere                   # allow NTP out
80/tcp                     ALLOW OUT   Anywhere                   # allow HTTP traffic out
443/tcp                    ALLOW OUT   Anywhere                   # allow HTTPS traffic out
21/tcp                     ALLOW OUT   Anywhere                   # allow FTP traffic out
587/tcp (Mail submission)  ALLOW OUT   Anywhere                   # allow mail out
43/tcp                     ALLOW OUT   Anywhere                   # allow whois
53 (v6)                    ALLOW OUT   Anywhere (v6)              # allow DNS calls out
123 (v6)                   ALLOW OUT   Anywhere (v6)              # allow NTP out
80/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow HTTP traffic out
443/tcp (v6)               ALLOW OUT   Anywhere (v6)              # allow HTTPS traffic out
21/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow FTP traffic out
587/tcp (Mail submission (v6)) ALLOW OUT   Anywhere (v6)              # allow mail out
43/tcp (v6)                ALLOW OUT   Anywhere (v6)              # allow whois
</code></pre></blockquote>
</li>
<li>
<p>If you need to delete a rule</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw status numbered
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">sudo ufw delete <span class="m">3</span> <span class="c1">#line number of the rule you want to delete</span>
</span></span></code></pre></div></li>
</ol>
<h4 id="default-applications">Default Applications</h4>
<p>ufw ships with some default applications. You can see them with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw app list
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Available applications:
  AIM
  Bonjour
  CIFS
  DNS
  Deluge
  IMAP
  IMAPS
  IPP
  KTorrent
  Kerberos Admin
  Kerberos Full
  Kerberos KDC
  Kerberos Password
  LDAP
  LDAPS
  LPD
  MSN
  MSN SSL
  Mail submission
  NFS
  OpenSSH
  POP3
  POP3S
  PeopleNearby
  SMTP
  SSH
  Socks
  Telnet
  Transmission
  Transparent Proxy
  VNC
  WWW
  WWW Cache
  WWW Full
  WWW Secure
  XMPP
  Yahoo
  qBittorrent
  svnserve
</code></pre></blockquote>
<p>To get details about the app, like which ports it includes, type:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw app info <span class="o">[</span>app name<span class="o">]</span>
</span></span></code></pre></div><blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw app info DNS
</span></span></code></pre></div><pre tabindex="0"><code>Profile: DNS
Title: Internet Domain Name Server
Description: Internet Domain Name Server

Port:
  53
</code></pre></blockquote>
<h4 id="custom-application">Custom Application</h4>
<p>If you don&rsquo;t want to create rules by explicitly providing the port number(s), you can create your own application configurations. To do this, create a file in <code>/etc/ufw/applications.d</code>.</p>
<p>For example, here is what you would use for <a href="https://support.plex.tv/articles/201543147-what-network-ports-do-i-need-to-allow-through-my-firewall/" target="_blank" rel="noopener">Plex</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /etc/ufw/applications.d/plexmediaserver
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>[PlexMediaServer]
title=Plex Media Server
description=This opens up PlexMediaServer for http (32400), upnp, and autodiscovery.
ports=32469/tcp|32413/udp|1900/udp|32400/tcp|32412/udp|32410/udp|32414/udp|32400/udp
</code></pre></blockquote>
<p>Then you can enable it like any other app:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw allow plexmediaserver
</span></span></code></pre></div><p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="iptables-intrusion-detection-and-prevention-with-psad">iptables Intrusion Detection And Prevention with PSAD</h3>
<h4 id="why-14">Why</h4>
<p>Even if you have a firewall to guard your doors, it is possible to try brute-forcing your way in any of the guarded doors. We want to monitor all network activity to detect potential intrusion attempts, such has repeated attempts to get in, and block them.</p>
<h4 id="how-it-works-9">How It Works</h4>
<p>I can&rsquo;t explain it any better than user <a href="https://serverfault.com/users/143961/finesec" target="_blank" rel="noopener">FINESEC</a> from <a href="https://serverfault.com/" target="_blank" rel="noopener">https://serverfault.com/</a> did at: <a href="https://serverfault.com/a/447604/289829" target="_blank" rel="noopener">https://serverfault.com/a/447604/289829</a>.</p>
<blockquote>
<p>Fail2BAN scans log files of various applications such as apache, ssh or ftp and automatically bans IPs that show the malicious signs such as automated login attempts. PSAD on the other hand scans iptables and ip6tables log messages (typically /var/log/messages) to detect and optionally block scans and other types of suspect traffic such as DDoS or OS fingerprinting attempts. It&rsquo;s ok to use both programs at the same time because they operate on different level.</p>
</blockquote>
<p>And, since we&rsquo;re already using <a href="#ufw-uncomplicated-firewall">UFW</a> so we&rsquo;ll follow the awesome instructions by <a href="https://gist.github.com/netson" target="_blank" rel="noopener">netson</a> at <a href="https://gist.github.com/netson/c45b2dc4e835761fbccc" target="_blank" rel="noopener">https://gist.github.com/netson/c45b2dc4e835761fbccc</a> to make PSAD work with UFW.</p>
<h4 id="references-12">References</h4>
<ul>
<li><a href="http://www.cipherdyne.org/psad/" target="_blank" rel="noopener">http://www.cipherdyne.org/psad/</a></li>
<li><a href="http://www.cipherdyne.org/psad/docs/config.html" target="_blank" rel="noopener">http://www.cipherdyne.org/psad/docs/config.html</a></li>
<li><a href="https://www.thefanclub.co.za/how-to/how-install-psad-intrusion-detection-ubuntu-1204-lts-server" target="_blank" rel="noopener">https://www.thefanclub.co.za/how-to/how-install-psad-intrusion-detection-ubuntu-1204-lts-server</a></li>
<li><a href="https://serverfault.com/a/447604/289829" target="_blank" rel="noopener">https://serverfault.com/a/447604/289829</a></li>
<li><a href="https://serverfault.com/a/770424/289829" target="_blank" rel="noopener">https://serverfault.com/a/770424/289829</a></li>
<li><a href="https://gist.github.com/netson/c45b2dc4e835761fbccc" target="_blank" rel="noopener">https://gist.github.com/netson/c45b2dc4e835761fbccc</a></li>
<li>Thanks to <a href="https://github.com/sysadt" target="_blank" rel="noopener">sysadt</a> for catching the issue (<a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/61" target="_blank" rel="noopener">#61</a>) with <code>psadwatchd</code>.</li>
</ul>
<h4 id="steps-14">Steps</h4>
<ol>
<li>
<p>Install psad.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install psad
</span></span></code></pre></div></li>
<li>
<p>Make a backup of psad&rsquo;s configuration file <code>/etc/psad/psad.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/psad/psad.conf /etc/psad/psad.conf-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Review and update configuration options in <code>/etc/psad/psad.conf</code>. Pay special attention to these:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Set To</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://www.cipherdyne.org/psad/docs/config.html#EMAIL_ADDRESSES" target="_blank" rel="noopener"><code>EMAIL_ADDRESSES</code></a></td>
<td>your email address(s)</td>
</tr>
<tr>
<td><code>HOSTNAME</code></td>
<td>your server&rsquo;s hostname</td>
</tr>
<tr>
<td><code>EXPECT_TCP_OPTIONS</code></td>
<td><code>EXPECT_TCP_OPTIONS Y;</code></td>
</tr>
<tr>
<td><code>ENABLE_PSADWATCHD</code></td>
<td><code>ENABLE_PSADWATCHD Y;</code></td>
</tr>
<tr>
<td><a href="http://www.cipherdyne.org/psad/docs/config.html#ENABLE_AUTO_IDS" target="_blank" rel="noopener"><code>ENABLE_AUTO_IDS</code></a></td>
<td><code>ENABLE_AUTO_IDS Y;</code></td>
</tr>
<tr>
<td><code>ENABLE_AUTO_IDS_EMAILS</code></td>
<td><code>ENABLE_AUTO_IDS_EMAILS Y;</code></td>
</tr>
</tbody>
</table>
<p>Check the configuration file psad&rsquo;s documentation at <a href="http://www.cipherdyne.org/psad/docs/config.html" target="_blank" rel="noopener">http://www.cipherdyne.org/psad/docs/config.html</a> for more details.</p>
</li>
<li>
<p><a name="psad_step4"></a>Now we need to make some changes to ufw so it works with psad by telling ufw to log all traffic so psad can analyze it. Do this by editing <strong>two files</strong> and adding these lines <strong>at the end but before the COMMIT line</strong>.</p>
<p>Make backups:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/ufw/before.rules /etc/ufw/before.rules-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo cp --archive /etc/ufw/before6.rules /etc/ufw/before6.rules-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div><p>Edit the files:</p>
<ul>
<li><code>/etc/ufw/before.rules</code></li>
<li><code>/etc/ufw/before6.rules</code></li>
</ul>
<p>And add add this <strong>at the end but before the COMMIT line</strong>:</p>
<pre tabindex="0"><code># log all traffic so psad can analyze
-A INPUT -j LOG --log-tcp-options --log-prefix &#34;[IPTABLES] &#34;
-A FORWARD -j LOG --log-tcp-options --log-prefix &#34;[IPTABLES] &#34;
</code></pre><p><strong>Note</strong>: We&rsquo;re adding a log prefix to all the iptables logs. We&rsquo;ll need this for <a href="#ns-separate-iptables-log-file">seperating iptables logs to their own file</a>.</p>
<p>For example:</p>
<blockquote>
<pre tabindex="0"><code>...

# log all traffic so psad can analyze
-A INPUT -j LOG --log-tcp-options --log-prefix &#34;[IPTABLES] &#34;
-A FORWARD -j LOG --log-tcp-options --log-prefix &#34;[IPTABLES] &#34;

# don&#39;t delete the &#39;COMMIT&#39; line or these rules won&#39;t be processed
COMMIT
</code></pre></blockquote>
</li>
<li>
<p>Now we need to reload/restart ufw and psad for the changes to take effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ufw reload
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo psad -R
</span></span><span class="line"><span class="cl">sudo psad --sig-update
</span></span><span class="line"><span class="cl">sudo psad -H
</span></span></code></pre></div></li>
<li>
<p>Analyze iptables rules for errors:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo psad --fw-analyze
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>[+] Parsing INPUT chain rules.
[+] Parsing INPUT chain rules.
[+] Firewall config looks good.
[+] Completed check of firewall ruleset.
[+] Results in /var/log/psad/fw_check
[+] Exiting.
</code></pre></blockquote>
<p><strong>Note</strong>: If there were any issues you will get an e-mail with the error.</p>
</li>
<li>
<p>Check the status of psad:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo psad --Status
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>[-] psad: pid file /var/run/psad/psadwatchd.pid does not exist for psadwatchd on vm
[+] psad_fw_read (pid: 3444)  %CPU: 0.0  %MEM: 2.2
    Running since: Sat Feb 16 01:03:09 2019

[+] psad (pid: 3435)  %CPU: 0.2  %MEM: 2.7
    Running since: Sat Feb 16 01:03:09 2019
    Command line arguments: [none specified]
    Alert email address(es): root@localhost

[+] Version: psad v2.4.3

[+] Top 50 signature matches:
        [NONE]

[+] Top 25 attackers:
        [NONE]

[+] Top 20 scanned ports:
        [NONE]

[+] iptables log prefix counters:
        [NONE]

    Total protocol packet counters:

[+] IP Status Detail:
        [NONE]

    Total scan sources: 0
    Total scan destinations: 0

[+] These results are available in: /var/log/psad/status.out
</code></pre></blockquote>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="application-intrusion-detection-and-prevention-with-fail2ban">Application Intrusion Detection And Prevention With Fail2Ban</h3>
<h4 id="why-15">Why</h4>
<p>UFW tells your server what doors to board up so nobody can see them, and what doors to allow authorized users through. PSAD monitors network activity to detect and prevent potential intrusions &ndash; repeated attempts to get in.</p>
<p>But what about the applications/services your server is running, like SSH and Apache, where your firewall is configured to allow access in. Even though access may be allowed that doesn&rsquo;t mean all access attempts are valid and harmless. What if someone tries to brute-force their way in to a web-app you&rsquo;re running on your server? This is where Fail2ban comes in.</p>
<h4 id="how-it-works-10">How It Works</h4>
<p>Fail2ban monitors the logs of your applications (like SSH and Apache) to detect and prevent potential intrusions. It will monitor network traffic/logs and prevent intrusions by blocking suspicious activity (e.g. multiple successive failed connections in a short time-span).</p>
<h4 id="goals-14">Goals</h4>
<ul>
<li>network monitoring for suspicious activity with automatic banning of offending IPs</li>
</ul>
<h4 id="notes-7">Notes</h4>
<ul>
<li>As of right now, the only thing running on this server is SSH so we&rsquo;ll want Fail2ban to monitor SSH and ban as necessary.</li>
<li>As you install other programs, you&rsquo;ll need to create/configure the appropriate jails and enable them.</li>
</ul>
<h4 id="references-13">References</h4>
<ul>
<li><a href="https://www.fail2ban.org/" target="_blank" rel="noopener">https://www.fail2ban.org/</a></li>
<li><a href="https://blog.vigilcode.com/2011/05/ufw-with-fail2ban-quick-secure-setup-part-ii/" target="_blank" rel="noopener">https://blog.vigilcode.com/2011/05/ufw-with-fail2ban-quick-secure-setup-part-ii/</a></li>
<li><a href="https://dodwell.us/security/ufw-fail2ban-portscan.html" target="_blank" rel="noopener">https://dodwell.us/security/ufw-fail2ban-portscan.html</a></li>
<li><a href="https://www.howtoforge.com/community/threads/fail2ban-and-ufw-on-debian.77261/" target="_blank" rel="noopener">https://www.howtoforge.com/community/threads/fail2ban-and-ufw-on-debian.77261/</a></li>
</ul>
<h4 id="steps-15">Steps</h4>
<ol>
<li>
<p>Install fail2ban.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install fail2ban
</span></span></code></pre></div></li>
<li>
<p>We don&rsquo;t want to edit <code>/etc/fail2ban/fail2ban.conf</code> or <code>/etc/fail2ban/jail.conf</code> because a future update may overwrite those so we&rsquo;ll create a local copy instead. Create the file <code>/etc/fail2ban/jail.local</code> and add this to it after replacing <code>[LAN SEGMENT]</code> and <code>[your email]</code> with the appropriate values:</p>
<pre tabindex="0"><code>[DEFAULT]
# the IP address range we want to ignore
ignoreip = 127.0.0.1/8 [LAN SEGMENT]

# who to send e-mail to
destemail = [your e-mail]

# who is the email from
sender = [your e-mail]

# since we&#39;re using exim4 to send emails
mta = mail

# get email alerts
action = %(action_mwl)s
</code></pre><p><strong>Note</strong>: Your server will need to be able to send e-mails so Fail2ban can let you know of suspicious activity and when it banned an IP.</p>
</li>
<li>
<p>We need to create a jail for SSH that tells fail2ban to look at SSH logs and use ufw to ban/unban IPs as needed. Create a jail for SSH by creating the file <code>/etc/fail2ban/jail.d/ssh.local</code> and adding this to it:</p>
<pre tabindex="0"><code>[sshd]
enabled = true
banaction = ufw
port = ssh
filter = sshd
logpath = %(sshd_log)s
maxretry = 5
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | sudo tee /etc/fail2ban/jail.d/ssh.local
</span></span></span><span class="line"><span class="cl"><span class="s">[sshd]
</span></span></span><span class="line"><span class="cl"><span class="s">enabled = true
</span></span></span><span class="line"><span class="cl"><span class="s">banaction = ufw
</span></span></span><span class="line"><span class="cl"><span class="s">port = ssh
</span></span></span><span class="line"><span class="cl"><span class="s">filter = sshd
</span></span></span><span class="line"><span class="cl"><span class="s">logpath = %(sshd_log)s
</span></span></span><span class="line"><span class="cl"><span class="s">maxretry = 5
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>In the above we tell fail2ban to use the ufw as the <code>banaction</code>. Fail2ban ships with an action configuration file for ufw. You can see it in <code>/etc/fail2ban/action.d/ufw.conf</code></p>
</li>
<li>
<p>Enable fail2ban:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo fail2ban-client start
</span></span><span class="line"><span class="cl">sudo fail2ban-client reload
</span></span><span class="line"><span class="cl">sudo fail2ban-client add sshd <span class="c1"># This may fail on some systems if the sshd jail was added by default</span>
</span></span></code></pre></div></li>
<li>
<p>To check the status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo fail2ban-client status
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Status
|- Number of jail:      1
`- Jail list:   sshd
</code></pre></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo fail2ban-client status sshd
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Status for the jail: sshd
|- Filter
|  |- Currently failed: 0
|  |- Total failed:     0
|  `- File list:        /var/log/auth.log
`- Actions
   |- Currently banned: 0
   |- Total banned:     0
   `- Banned IP list:
</code></pre></blockquote>
</li>
</ol>
<h4 id="custom-jails">Custom Jails</h4>
<p>I have not needed to create a custom jail yet. Once I do, and I figure out how, I will update this guide. Or, if you know how please help <a href="#contributing">contribute</a>.</p>
<h4 id="unban-an-ip">Unban an IP</h4>
<p>To unban an IP use this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">fail2ban-client <span class="nb">set</span> <span class="o">[</span>jail<span class="o">]</span> unbanip <span class="o">[</span>IP<span class="o">]</span>
</span></span></code></pre></div><p><code>[jail]</code> is the name of the jail that has the banned IP and <code>[IP]</code> is the IP address you want to unban. For example, to unaban <code>192.168.1.100</code> from SSH you would do:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">fail2ban-client <span class="nb">set</span> sshd unbanip 192.168.1.100
</span></span></code></pre></div><p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-auditing">The Auditing</h2>
<h3 id="filefolder-integrity-monitoring-with-aide-wip">File/Folder Integrity Monitoring With AIDE (WIP)</h3>
<h4 id="why-16">Why</h4>
<p>WIP</p>
<h4 id="how-it-works-11">How It Works</h4>
<p>WIP</p>
<h4 id="goals-15">Goals</h4>
<p>WIP</p>
<h4 id="references-14">References</h4>
<ul>
<li><a href="https://aide.github.io/" target="_blank" rel="noopener">https://aide.github.io/</a></li>
<li><a href="https://www.hiroom2.com/2017/06/09/debian-8-file-integrity-check-with-aide/" target="_blank" rel="noopener">https://www.hiroom2.com/2017/06/09/debian-8-file-integrity-check-with-aide/</a></li>
<li><a href="https://blog.rapid7.com/2017/06/30/how-to-install-and-configure-aide-on-ubuntu-linux/" target="_blank" rel="noopener">https://blog.rapid7.com/2017/06/30/how-to-install-and-configure-aide-on-ubuntu-linux/</a></li>
<li><a href="https://www.stephenrlang.com/2016/03/using-aide-for-file-integrity-monitoring-fim-on-ubuntu/" target="_blank" rel="noopener">https://www.stephenrlang.com/2016/03/using-aide-for-file-integrity-monitoring-fim-on-ubuntu/</a></li>
<li><a href="https://www.howtoforge.com/how-to-configure-the-aide-advanced-intrusion-detection-environment-file-integrity-scanner-for-your-website" target="_blank" rel="noopener">https://www.howtoforge.com/how-to-configure-the-aide-advanced-intrusion-detection-environment-file-integrity-scanner-for-your-website</a></li>
<li><a href="https://www.tecmint.com/check-integrity-of-file-and-directory-using-aide-in-linux/" target="_blank" rel="noopener">https://www.tecmint.com/check-integrity-of-file-and-directory-using-aide-in-linux/</a></li>
<li><a href="https://www.cyberciti.biz/faq/debian-ubuntu-linux-software-integrity-checking-with-aide/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/debian-ubuntu-linux-software-integrity-checking-with-aide/</a></li>
<li><a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/83" target="_blank" rel="noopener">https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/83</a></li>
</ul>
<h4 id="steps-16">Steps</h4>
<ol>
<li>
<p>Install AIDE.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install aide aide-common
</span></span></code></pre></div></li>
<li>
<p>Make a backup of AIDE&rsquo;s defaults file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -p /etc/default/aide /etc/default/aide-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Go through <code>/etc/default/aide</code> and set AIDE&rsquo;s defaults per your requirements. If you want AIDE to run daily and e-mail you, be sure to set <code>CRON_DAILY_RUN</code> to <code>yes</code>.</p>
</li>
<li>
<p>Make a backup of AIDE&rsquo;s configuration files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -pr /etc/aide /etc/aide-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>On Debian based systems:</p>
<ul>
<li>AIDE&rsquo;s configuration files are in <code>/etc/aide/aide.conf.d/</code>.</li>
<li>You&rsquo;ll want to go through AIDE&rsquo;s documentation and the configuration files in to set them per your requirements.</li>
<li>If you want new settings, to monitor a new folder for example, you&rsquo;ll want to add them to <code>/etc/aide/aide.conf</code> or <code>/etc/aide/aide.conf.d/</code>.</li>
<li>Take a backup of the stock configuration files: <code>sudo cp -pr /etc/aide /etc/aide-COPY-$(date +&quot;%Y%m%d%H%M%S&quot;)</code>.</li>
</ul>
</li>
<li>
<p>Create a new database, and install it.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo aideinit
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Running aide --init...
Start timestamp: 2019-04-01 21:23:37 -0400 (AIDE 0.16)
AIDE initialized database at /var/lib/aide/aide.db.new
Verbose level: 6

Number of entries:      25973

---------------------------------------------------
The attributes of the (uncompressed) database(s):
---------------------------------------------------

/var/lib/aide/aide.db.new
  RMD160   : moyQ1YskQQbidX+Lusv3g2wf1gQ=
  TIGER    : 7WoOgCrXzSpDrlO6I3PyXPj1gRiaMSeo
  SHA256   : gVx8Fp7r3800WF2aeXl+/KHCzfGsNi7O
             g16VTPpIfYQ=
  SHA512   : GYfa0DJwWgMLl4Goo5VFVOhu4BphXCo3
             rZnk49PYztwu50XjaAvsVuTjJY5uIYrG
             tV+jt3ELvwFzGefq4ZBNMg==
  CRC32    : /cusZw==
  HAVAL    : E/i5ceF3YTjwenBfyxHEsy9Kzu35VTf7
             CPGQSW4tl14=
  GOST     : n5Ityzxey9/1jIs7LMc08SULF1sLBFUc
             aMv7Oby604A=


End timestamp: 2019-04-01 21:24:45 -0400 (run time: 1m 8s)
</code></pre></blockquote>
</li>
<li>
<p>Test everything works with no changes.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo aide.wrapper --check
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Start timestamp: 2019-04-01 21:24:45 -0400 (AIDE 0.16)
AIDE found NO differences between database and filesystem. Looks okay!!
Verbose level: 6

Number of entries:      25973

---------------------------------------------------
The attributes of the (uncompressed) database(s):
---------------------------------------------------

/var/lib/aide/aide.db
  RMD160   : moyQ1YskQQbidX+Lusv3g2wf1gQ=
  TIGER    : 7WoOgCrXzSpDrlO6I3PyXPj1gRiaMSeo
  SHA256   : gVx8Fp7r3800WF2aeXl+/KHCzfGsNi7O
             g16VTPpIfYQ=
  SHA512   : GYfa0DJwWgMLl4Goo5VFVOhu4BphXCo3
             rZnk49PYztwu50XjaAvsVuTjJY5uIYrG
             tV+jt3ELvwFzGefq4ZBNMg==
  CRC32    : /cusZw==
  HAVAL    : E/i5ceF3YTjwenBfyxHEsy9Kzu35VTf7
             CPGQSW4tl14=
  GOST     : n5Ityzxey9/1jIs7LMc08SULF1sLBFUc
             aMv7Oby604A=


End timestamp: 2019-04-01 21:26:03 -0400 (run time: 1m 18s)
</code></pre></blockquote>
</li>
<li>
<p>Test everything works after making some changes.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo touch /etc/test.sh
</span></span><span class="line"><span class="cl">sudo touch /root/test.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo aide.wrapper --check
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo rm /etc/test.sh
</span></span><span class="line"><span class="cl">sudo rm /root/test.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo aideinit -y -f
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Start timestamp: 2019-04-01 21:37:37 -0400 (AIDE 0.16)
AIDE found differences between database and filesystem!!
Verbose level: 6

Summary:
  Total number of entries:      25972
  Added entries:                2
  Removed entries:              0
  Changed entries:              1

---------------------------------------------------
Added entries:
---------------------------------------------------

f++++++++++++++++: /etc/test.sh
f++++++++++++++++: /root/test.sh

---------------------------------------------------
Changed entries:
---------------------------------------------------

d =.... mc.. .. .: /root

---------------------------------------------------
Detailed information about changes:
---------------------------------------------------

Directory: /root
  Mtime    : 2019-04-01 21:35:07 -0400        | 2019-04-01 21:37:36 -0400
  Ctime    : 2019-04-01 21:35:07 -0400        | 2019-04-01 21:37:36 -0400


---------------------------------------------------
The attributes of the (uncompressed) database(s):
---------------------------------------------------

/var/lib/aide/aide.db
  RMD160   : qF9WmKaf2PptjKnhcr9z4ueCPTY=
  TIGER    : zMo7MvvYJcq1hzvTQLPMW7ALeFiyEqv+
  SHA256   : LSLLVjjV6r8vlSxlbAbbEsPcQUB48SgP
             pdVqEn6ZNbQ=
  SHA512   : Qc4U7+ZAWCcitapGhJ1IrXCLGCf1IKZl
             02KYL1gaZ0Fm4dc7xLqjiquWDMSEbwzW
             oz49NCquqGz5jpMIUy7UxA==
  CRC32    : z8ChEA==
  HAVAL    : YapzS+/cdDwLj3kHJEq8fufLp3DPKZDg
             U12KCSkrO7Y=
  GOST     : 74sLV4HkTig+GJhokvxZQm7CJD/NR0mG
             6jV7zdt5AXQ=


End timestamp: 2019-04-01 21:38:50 -0400 (run time: 1m 13s)
</code></pre></blockquote>
</li>
<li>
<p>That&rsquo;s it. If you set <code>CRON_DAILY_RUN</code> to <code>yes</code> in <code>/etc/default/aide</code> then cron will execute <code>/etc/cron.daily/aide</code> every day and e-mail you the output.</p>
</li>
</ol>
<h4 id="updating-the-database">Updating The Database</h4>
<p>Every time you make changes to files/folders that AIDE monitors, you will need to update the database to capture those changes. To do that on Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo aideinit -y -f
</span></span></code></pre></div><p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="anti-virus-scanning-with-clamav-wip">Anti-Virus Scanning With ClamAV (WIP)</h3>
<h4 id="why-17">Why</h4>
<p>WIP</p>
<h4 id="how-it-works-12">How It Works</h4>
<ul>
<li>ClamAV is a virus scanner</li>
<li>ClamAV-Freshclam is a service that keeps the virus definitions updated</li>
<li>ClamAV-Daemon keeps the <code>clamd</code> process running to make scanning faster</li>
</ul>
<h4 id="goals-16">Goals</h4>
<p>WIP</p>
<h4 id="notes-8">Notes</h4>
<ul>
<li>These instructions <strong>do not</strong> tell you how to enable the ClamAV daemon service to ensure <code>clamd</code> is running all the time. <code>clamd</code> is only if you&rsquo;re running a mail server and does not provide real-time monitoring of files. Instead, you&rsquo;d want to scan files manually or on a schedule.</li>
</ul>
<h4 id="references-15">References</h4>
<ul>
<li><a href="https://www.clamav.net/documents/installation-on-debian-and-ubuntu-linux-distributions" target="_blank" rel="noopener">https://www.clamav.net/documents/installation-on-debian-and-ubuntu-linux-distributions</a></li>
<li><a href="https://wiki.debian.org/ClamAV" target="_blank" rel="noopener">https://wiki.debian.org/ClamAV</a></li>
<li><a href="https://www.osradar.com/install-clamav-debian-9-ubuntu-18/" target="_blank" rel="noopener">https://www.osradar.com/install-clamav-debian-9-ubuntu-18/</a></li>
<li><a href="https://www.lisenet.com/2014/automate-clamav-to-perform-daily-system-scan-and-send-email-notifications-on-linux/" target="_blank" rel="noopener">https://www.lisenet.com/2014/automate-clamav-to-perform-daily-system-scan-and-send-email-notifications-on-linux/</a></li>
<li><a href="https://www.howtoforge.com/tutorial/configure-clamav-to-scan-and-notify-virus-and-malware/" target="_blank" rel="noopener">https://www.howtoforge.com/tutorial/configure-clamav-to-scan-and-notify-virus-and-malware/</a></li>
<li><a href="https://serverfault.com/questions/741299/is-there-a-way-to-keep-clamav-updated-on-debian-8" target="_blank" rel="noopener">https://serverfault.com/questions/741299/is-there-a-way-to-keep-clamav-updated-on-debian-8</a></li>
<li><a href="https://askubuntu.com/questions/250290/how-do-i-scan-for-viruses-with-clamav" target="_blank" rel="noopener">https://askubuntu.com/questions/250290/how-do-i-scan-for-viruses-with-clamav</a></li>
<li><a href="https://ngothang.com/how-to-install-clamav-and-configure-daily-scanning-on-centos/" target="_blank" rel="noopener">https://ngothang.com/how-to-install-clamav-and-configure-daily-scanning-on-centos/</a></li>
</ul>
<h4 id="steps-17">Steps</h4>
<ol>
<li>
<p>Install ClamAV.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install clamav clamav-freshclam clamav-daemon
</span></span></code></pre></div></li>
<li>
<p>Make a backup of <code>clamav-freshclam</code>&rsquo;s configuration file <code>/etc/clamav/freshclam.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/clamav/freshclam.conf /etc/clamav/freshclam.conf-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p><code>clamav-freshclam</code>&rsquo;s default settings are probably good enough but if you want to change them, you can either edit the file <code>/etc/clamav/freshclam.conf</code> or use <code>dpkg-reconfigure</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure clamav-freshclam
</span></span></code></pre></div><p><strong>Note</strong>: The default settings will update the definitions 24 times in a day. To change the interval, check the <code>Checks</code> setting in <code>/etc/clamav/freshclam.conf</code> or use <code>dpkg-reconfigure</code>.</p>
</li>
<li>
<p>Start the <code>clamav-freshclam</code> service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service clamav-freshclam start
</span></span></code></pre></div></li>
<li>
<p>You can make sure <code>clamav-freshclam</code> running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo service clamav-freshclam status
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>● clamav-freshclam.service - ClamAV virus database updater
   Loaded: loaded (/lib/systemd/system/clamav-freshclam.service; enabled; vendor preset: enabled)   Active: active (running) since Sat 2019-03-16 22:57:07 EDT; 2min 13s ago
     Docs: man:freshclam(1)
           man:freshclam.conf(5)
           https://www.clamav.net/documents
 Main PID: 1288 (freshclam)
   CGroup: /system.slice/clamav-freshclam.service
           └─1288 /usr/bin/freshclam -d --foreground=true

Mar 16 22:57:08 host freshclam[1288]: Sat Mar 16 22:57:08 2019 -&gt; ^Local version: 0.100.2 Recommended version: 0.101.1
Mar 16 22:57:08 host freshclam[1288]: Sat Mar 16 22:57:08 2019 -&gt; DON&#39;T PANIC! Read https://www.clamav.net/documents/upgrading-clamav
Mar 16 22:57:15 host freshclam[1288]: Sat Mar 16 22:57:15 2019 -&gt; Downloading main.cvd [100%]
Mar 16 22:57:38 host freshclam[1288]: Sat Mar 16 22:57:38 2019 -&gt; main.cvd updated (version: 58, sigs: 4566249, f-level: 60, builder: sigmgr)
Mar 16 22:57:40 host freshclam[1288]: Sat Mar 16 22:57:40 2019 -&gt; Downloading daily.cvd [100%]
Mar 16 22:58:13 host freshclam[1288]: Sat Mar 16 22:58:13 2019 -&gt; daily.cvd updated (version: 25390, sigs: 1520006, f-level: 63, builder: raynman)
Mar 16 22:58:14 host freshclam[1288]: Sat Mar 16 22:58:14 2019 -&gt; Downloading bytecode.cvd [100%]
Mar 16 22:58:16 host freshclam[1288]: Sat Mar 16 22:58:16 2019 -&gt; bytecode.cvd updated (version: 328, sigs: 94, f-level: 63, builder: neo)
Mar 16 22:58:24 host freshclam[1288]: Sat Mar 16 22:58:24 2019 -&gt; Database updated (6086349 signatures) from db.local.clamav.net (IP: 104.16.219.84)
Mar 16 22:58:24 host freshclam[1288]: Sat Mar 16 22:58:24 2019 -&gt; ^Clamd was NOT notified: Can&#39;t connect to clamd through /var/run/clamav/clamd.ctl: No such file or directory
</code></pre></blockquote>
<p><strong>Note</strong>: Don&rsquo;t worry about that <code>Local version</code> line. Check <a href="https://serverfault.com/questions/741299/is-there-a-way-to-keep-clamav-updated-on-debian-8" target="_blank" rel="noopener">https://serverfault.com/questions/741299/is-there-a-way-to-keep-clamav-updated-on-debian-8</a> for more details.</p>
</li>
<li>
<p>Make a backup of <code>clamav-daemon</code>&rsquo;s configuration file <code>/etc/clamav/clamd.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/clamav/clamd.conf /etc/clamav/clamd.conf-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>You can change <code>clamav-daemon</code>&rsquo;s settings by editing the file <code>/etc/clamav/clamd.conf</code> or useing <code>dpkg-reconfigure</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure clamav-daemon
</span></span></code></pre></div></li>
</ol>
<h4 id="scanning-filesfolders">Scanning Files/Folders</h4>
<ul>
<li>To scan files/folders use the <code>clamscan</code> program.</li>
<li><code>clamscan</code> runs as the user it is executed as so it needs read permissions to the files/folders it is scanning.</li>
<li>Using <code>clamscan</code> as <code>root</code> is dangerous because if a file is in fact a virus there is risk that it could use the root privileges.</li>
<li>To scan a file: <code>clamscan /path/to/file</code>.</li>
<li>To scan a directory: <code>clamscan -r /path/to/folder</code>.</li>
<li>You can use the <code>-i</code> switch to only print infected files.</li>
<li>Check <code>clamscan</code>&rsquo;s <code>man</code> pages for other switches/options.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="rootkit-detection-with-rkhunter-wip">Rootkit Detection With Rkhunter (WIP)</h3>
<h4 id="why-18">Why</h4>
<p>WIP</p>
<h4 id="how-it-works-13">How It Works</h4>
<p>WIP</p>
<h4 id="goals-17">Goals</h4>
<p>WIP</p>
<h4 id="references-16">References</h4>
<ul>
<li><a href="http://rkhunter.sourceforge.net/" target="_blank" rel="noopener">http://rkhunter.sourceforge.net/</a></li>
<li><a href="https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/</a></li>
<li><a href="https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/" target="_blank" rel="noopener">https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/</a></li>
</ul>
<h4 id="steps-18">Steps</h4>
<ol>
<li>
<p>Install Rkhunter.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install rkhunter
</span></span></code></pre></div></li>
<li>
<p>Make a backup of rkhunter&rsquo; defaults file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -p /etc/default/rkhunter /etc/default/rkhunter-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>rkhunter&rsquo;s configuration file is <code>/etc/rkhunter.conf</code>. Instead of making changes to it, create and use the file <code>/etc/rkhunter.conf.local</code> instead:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp -p /etc/rkhunter.conf /etc/rkhunter.conf.local
</span></span></code></pre></div></li>
<li>
<p>Go through the configuration file <code>/etc/rkhunter.conf.local</code> and set to your requirements. My recommendations:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UPDATE_MIRRORS=1</code></td>
<td></td>
</tr>
<tr>
<td><code>MIRRORS_MODE=0</code></td>
<td></td>
</tr>
<tr>
<td><code>MAIL-ON-WARNING=root</code></td>
<td></td>
</tr>
<tr>
<td><code>COPY_LOG_ON_ERROR=1</code></td>
<td>to save a copy of the log if there is an error</td>
</tr>
<tr>
<td><code>PKGMGR=...</code></td>
<td>set to the appropriate value per the documentation</td>
</tr>
<tr>
<td><code>PHALANX2_DIRTEST=1</code></td>
<td>read the documentation for why</td>
</tr>
<tr>
<td><code>WEB_CMD=&quot;&quot;</code></td>
<td>this is to address an issue with the Debian package that disables the ability for rkhunter to self-update.</td>
</tr>
<tr>
<td><code>USE_LOCKING=1</code></td>
<td>to prevent issues with rkhunter running multiple times</td>
</tr>
<tr>
<td><code>SHOW_SUMMARY_WARNINGS_NUMBER=1</code></td>
<td>to see the actual number of warnings found</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>You want rkhunter to run every day and e-mail you the result. You can write your own script or check <a href="https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/" target="_blank" rel="noopener">https://www.tecmint.com/install-rootkit-hunter-scan-for-rootkits-backdoors-in-linux/</a> for a sample cron script you can use.</p>
<p>On Debian based system, rkhunter comes with cron scripts. To enable them check <code>/etc/default/rkhunter</code> or use <code>dpkg-reconfigure</code> and say <code>Yes</code> to all of the questions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure rkhunter
</span></span></code></pre></div></li>
<li>
<p>After you&rsquo;ve finished with all of the changes, make sure all the settings are valid:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo rkhunter -C
</span></span></code></pre></div></li>
<li>
<p>Update rkhunter and its database:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo rkhunter --versioncheck
</span></span><span class="line"><span class="cl">sudo rkhunter --update
</span></span><span class="line"><span class="cl">sudo rkhunter --propupd
</span></span></code></pre></div></li>
<li>
<p>If you want to do a manual scan and see the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo rkhunter --check
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="rootkit-detection-with-chrootkit-wip">Rootkit Detection With chrootkit (WIP)</h3>
<h4 id="why-19">Why</h4>
<p>WIP</p>
<h4 id="how-it-works-14">How It Works</h4>
<p>WIP</p>
<h4 id="goals-18">Goals</h4>
<p>WIP</p>
<h4 id="references-17">References</h4>
<ul>
<li><a href="http://www.chkrootkit.org/" target="_blank" rel="noopener">http://www.chkrootkit.org/</a></li>
<li><a href="https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/howto-check-linux-rootkist-with-detectors-software/</a></li>
<li><a href="https://askubuntu.com/questions/258658/eth0-packet-sniffer-sbin-dhclient" target="_blank" rel="noopener">https://askubuntu.com/questions/258658/eth0-packet-sniffer-sbin-dhclient</a></li>
</ul>
<h4 id="steps-19">Steps</h4>
<ol>
<li>
<p>Install chkrootkit.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install chkrootkit
</span></span></code></pre></div></li>
<li>
<p>Do a manual scan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo chkrootkit
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>ROOTDIR is `/&#39;
Checking `amd&#39;...                                           not found
Checking `basename&#39;...                                      not infected
Checking `biff&#39;...                                          not found
Checking `chfn&#39;...                                          not infected
Checking `chsh&#39;...                                          not infected
...
Checking `scalper&#39;...                                       not infected
Checking `slapper&#39;...                                       not infected
Checking `z2&#39;...                                            chklastlog: nothing deleted
Checking `chkutmp&#39;...                                       chkutmp: nothing deleted
Checking `OSX_RSPLUG&#39;...                                    not infected
</code></pre></blockquote>
</li>
<li>
<p>Make a backup of chkrootkit&rsquo;s configuration file <code>/etc/chkrootkit.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/chkrootkit.conf /etc/chkrootkit.conf-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>You want chkrootkit to run every day and e-mail you the result.</p>
<p>On Debian based system, chkrootkit comes with cron scripts. To enable them check <code>/etc/chkrootkit.conf</code> or use <code>dpkg-reconfigure</code> and say <code>Yes</code> to the first question:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure chkrootkit
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="logwatch---system-log-analyzer-and-reporter">logwatch - system log analyzer and reporter</h3>
<h4 id="why-20">Why</h4>
<p>Your server will be generating a lot of logs that may contain important information. Unless you plan on checking your server everyday, you&rsquo;ll want a way to get e-mail summary of your server&rsquo;s logs. To accomplish this we&rsquo;ll use <a href="https://sourceforge.net/projects/logwatch/" target="_blank" rel="noopener">logwatch</a>.</p>
<h4 id="how-it-works-15">How It Works</h4>
<p>logwatch scans system log files and summarizes them. You can run it directly from the command line or schedule it to run on a recurring schedule. logwatch uses service files to know how to read/summarize a log file. You can see all of the stock service files in <code>/usr/share/logwatch/scripts/services</code>.</p>
<p>logwatch&rsquo;s configuration file <code>/usr/share/logwatch/default.conf/logwatch.conf</code> specifies default options. You can override them via command line arguments.</p>
<h4 id="goals-19">Goals</h4>
<ul>
<li>Logwatch configured to send a daily e-mail summary of all of the server&rsquo;s status and logs</li>
</ul>
<h4 id="notes-9">Notes</h4>
<ul>
<li>Your server will need to be able to send e-mails for this to work</li>
<li>The below steps will result in logwatch running every day. If you want to change the schedule, modify the cronjob to your liking. You&rsquo;ll also want to change the <code>range</code> option to cover your recurrence window. See <a href="https://www.badpenguin.org/configure-logwatch-for-weekly-email-and-html-output-format" target="_blank" rel="noopener">https://www.badpenguin.org/configure-logwatch-for-weekly-email-and-html-output-format</a> for an example.</li>
<li>If logwatch fails to deliver mail due to the e-mail having long lines please check <a href="https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender" target="_blank" rel="noopener">https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender</a> as documented in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">issue #29</a>. If you you followed <a href="#gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</a> then we already took care of this in step #7.</li>
</ul>
<h4 id="references-18">References</h4>
<ul>
<li>Thanks to <a href="https://github.com/amacheema" target="_blank" rel="noopener">amacheema</a> for fixing some issues with the steps and letting me know of a long line bug with exim4 as documented in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">issue #29</a>.</li>
<li><a href="https://sourceforge.net/projects/logwatch/" target="_blank" rel="noopener">https://sourceforge.net/projects/logwatch/</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps</a></li>
</ul>
<h4 id="steps-20">Steps</h4>
<ol>
<li>
<p>Install logwatch.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install logwatch
</span></span></code></pre></div></li>
<li>
<p>To see a sample of what logwatch collects you can run it directly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo /usr/sbin/logwatch --output stdout --format text --range yesterday --service all
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>
 ################### Logwatch 7.4.3 (12/07/16) ####################
        Processing Initiated: Mon Mar  4 00:05:50 2019
        Date Range Processed: yesterday
                              ( 2019-Mar-03 )
                              Period is day.
        Detail Level of Output: 5
        Type of Output/Format: stdout / text
        Logfiles for Host: host
 ##################################################################

 --------------------- Cron Begin ------------------------
...
...
 ---------------------- Disk Space End -------------------------


 ###################### Logwatch End #########################
</code></pre></blockquote>
</li>
<li>
<p>Go through logwatch&rsquo;s self-documented configuration file <code>/usr/share/logwatch/default.conf/logwatch.conf</code> before continuing. There is no need to change anything here but pay special attention to the <code>Output</code>, <code>Format</code>, <code>MailTo</code>, <code>Range</code>, and <code>Service</code> as those are the ones we&rsquo;ll be using. For our purposes, instead of specifying our options in the configuration file, we will pass them as command line arguments in the daily cron job that executes logwatch. That way, if the configuration file is ever modified (e.g. during an update), our options will still be there.</p>
</li>
<li>
<p>Make a backup of logwatch&rsquo;s daily cron file <code>/etc/cron.daily/00logwatch</code> and unset the execute bit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/cron.daily/00logwatch /etc/cron.daily/00logwatch-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo chmod -x /etc/cron.daily/00logwatch-COPY*
</span></span></code></pre></div></li>
<li>
<p>By default, logwatch outputs to <code>stdout</code>. Since the goal is to get a daily e-mail, we need to change the output type that logwatch uses to send e-mail instead. We could do this through the configuration file above, but that would apply to every time it is run &ndash; even when we run it manually and want to see the output to the screen. Instead, we&rsquo;ll change the cron job that executes logwatch to send e-mail. This way, when run manually, we&rsquo;ll still get output to <code>stdout</code> and when run by cron, it&rsquo;ll send an e-mail. We&rsquo;ll also make sure it checks for all services, and change the output format to html so it&rsquo;s easier to read regardless of what the configuration file says. In the file <code>/etc/cron.daily/00logwatch</code> find the execute line and change it to:</p>
<pre tabindex="0"><code>/usr/sbin/logwatch --output mail --format html --mailto root --range yesterday --service all
</code></pre><blockquote>
<pre tabindex="0"><code>#!/bin/bash

#Check if removed-but-not-purged
test -x /usr/share/logwatch/scripts/logwatch.pl || exit 0

#execute
/usr/sbin/logwatch --output mail --format html --mailto root --range yesterday --service all

#Note: It&#39;s possible to force the recipient in above command
#Just pass --mailto address@a.com instead of --output mail
</code></pre></blockquote>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;s,^(</span><span class="k">$(</span>sudo which logwatch<span class="k">)</span><span class="s2">.*?),# \1         # commented by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\n</span><span class="k">$(</span>sudo which logwatch<span class="k">)</span><span class="s2"> --output mail --format html --mailto root --range yesterday --service all         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">,&#34;</span> /etc/cron.daily/00logwatch
</span></span></code></pre></div></li>
<li>
<p>You can test the cron job by executing it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo /etc/cron.daily/00logwatch
</span></span></code></pre></div><p><strong>Note</strong>: If logwatch fails to deliver mail due to the e-mail having long lines please check <a href="https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender" target="_blank" rel="noopener">https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender</a> as documented in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">issue #29</a>. If you you followed <a href="#gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</a> then we already took care of this in step #7.</p>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="ss---seeing-ports-your-server-is-listening-on">ss - Seeing Ports Your Server Is Listening On</h3>
<h4 id="why-21">Why</h4>
<p>Ports are how applications, services, and processes communicate with each other &ndash; either locally within your server or with other devices on the network. When you have an application or service (like SSH or Apache) running on your server, they listen for requests on specific ports.</p>
<p>Obviously we don&rsquo;t want your server listening on ports we don&rsquo;t know about. We&rsquo;ll use <code>ss</code> to see all the ports that services are listening on. This will help us track down and stop rogue, potentially dangerous, services.</p>
<h4 id="goals-20">Goals</h4>
<ul>
<li>find out non-localhost what ports are open and listening for connections</li>
</ul>
<h4 id="references-19">References</h4>
<ul>
<li><a href="https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/egrib6o/" target="_blank" rel="noopener">https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/egrib6o/</a></li>
<li><a href="https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/egs1rev/" target="_blank" rel="noopener">https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/egs1rev/</a></li>
<li><a href="https://www.tecmint.com/find-open-ports-in-linux/" target="_blank" rel="noopener">https://www.tecmint.com/find-open-ports-in-linux/</a></li>
<li><code>man ss</code></li>
</ul>
<h4 id="steps-21">Steps</h4>
<ol>
<li>
<p>To see the all the ports listening for traffic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ss -lntup
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>Netid  State      Recv-Q Send-Q     Local Address:Port     Peer Address:Port
udp    UNCONN     0      0                      *:68                  *:*        users:((&#34;dhclient&#34;,pid=389,fd=6))
tcp    LISTEN     0      128                    *:22                  *:*        users:((&#34;sshd&#34;,pid=4390,fd=3))
tcp    LISTEN     0      128                   :::22                 :::*        users:((&#34;sshd&#34;,pid=4390,fd=4))
</code></pre></blockquote>
<p><strong>Switch Explanations</strong>:</p>
<ul>
<li><code>l</code> = display listening sockets</li>
<li><code>n</code> = do now try to resolve service names</li>
<li><code>t</code> = display TCP sockets</li>
<li><code>u</code> = display UDP sockets</li>
<li><code>p</code> = show process information</li>
</ul>
</li>
<li>
<p>If you see anything suspicious, like a port you&rsquo;re not aware of or a process you don&rsquo;t know, investigate and remediate as necessary.</p>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="lynis---linux-security-auditing">Lynis - Linux Security Auditing</h3>
<h4 id="why-22">Why</h4>
<p>From <a href="https://cisofy.com/lynis/" target="_blank" rel="noopener">https://cisofy.com/lynis/</a>:</p>
<blockquote>
<p>Lynis is a battle-tested security tool for systems running Linux, macOS, or Unix-based operating system. It performs an extensive health scan of your systems to support system hardening and compliance testing.</p>
</blockquote>
<h4 id="goals-21">Goals</h4>
<ul>
<li>Lynis installed</li>
</ul>
<h4 id="notes-10">Notes</h4>
<ul>
<li>CISOFY offers packages for many distributions. Check <a href="https://packages.cisofy.com/" target="_blank" rel="noopener">https://packages.cisofy.com/</a> for distribution specific installation instructions.</li>
</ul>
<h4 id="references-20">References</h4>
<ul>
<li><a href="https://cisofy.com/documentation/lynis/get-started/" target="_blank" rel="noopener">https://cisofy.com/documentation/lynis/get-started/</a></li>
<li><a href="https://packages.cisofy.com/community/#debian-ubuntu" target="_blank" rel="noopener">https://packages.cisofy.com/community/#debian-ubuntu</a></li>
<li><a href="https://thelinuxcode.com/audit-lynis-ubuntu-server/" target="_blank" rel="noopener">https://thelinuxcode.com/audit-lynis-ubuntu-server/</a></li>
<li><a href="https://www.vultr.com/docs/install-lynis-on-debian-8" target="_blank" rel="noopener">https://www.vultr.com/docs/install-lynis-on-debian-8</a></li>
</ul>
<h4 id="steps-22">Steps</h4>
<ol>
<li>
<p>Install lynis. <a href="https://cisofy.com/lynis/#installation" target="_blank" rel="noopener">https://cisofy.com/lynis/#installation</a> has detailed instructions on how to install it for your distribution.</p>
<p>On Debian based systems, using CISOFY&rsquo;s community software repository:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install apt-transport-https ca-certificates host
</span></span><span class="line"><span class="cl">sudo wget -O - https://packages.cisofy.com/keys/cisofy-software-public.key <span class="p">|</span> sudo apt-key add -
</span></span><span class="line"><span class="cl">sudo <span class="nb">echo</span> <span class="s2">&#34;deb https://packages.cisofy.com/community/lynis/deb/ stable main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/cisofy-lynis.list
</span></span><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install lynis host
</span></span></code></pre></div></li>
<li>
<p>Update it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo lynis update info
</span></span></code></pre></div></li>
<li>
<p>Run a security audit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo lynis audit system
</span></span></code></pre></div><p>This will scan your server, report its audit findings, and at the end it will give you suggestions. Spend some time going through the output and address gaps as necessary.</p>
</li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="ossec---host-intrusion-detection">OSSEC - Host Intrusion Detection</h3>
<h4 id="why-23">Why</h4>
<p>From <a href="https://github.com/ossec/ossec-hids" target="_blank" rel="noopener">https://github.com/ossec/ossec-hids</a></p>
<blockquote>
<p>OSSEC is a full platform to monitor and control your systems. It mixes together all the aspects of HIDS (host-based intrusion detection), log monitoring and SIM/SIEM together in a simple, powerful and open source solution.</p>
</blockquote>
<h4 id="goals-22">Goals</h4>
<ul>
<li>OSSEC-HIDS installed</li>
</ul>
<h4 id="references-21">References</h4>
<ul>
<li><a href="https://www.ossec.net/docs/" target="_blank" rel="noopener">https://www.ossec.net/docs/</a></li>
</ul>
<h4 id="steps-23">Steps</h4>
<ol>
<li>
<p>Install OSSEC-HIDS from sources</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install -y libz-dev libssl-dev libpcre2-dev build-essential libsystemd-dev
</span></span><span class="line"><span class="cl">wget https://github.com/ossec/ossec-hids/archive/3.7.0.tar.gz
</span></span><span class="line"><span class="cl">tar xzf 3.7.0.tar.gz
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ossec-hids-3.7.0/
</span></span><span class="line"><span class="cl">sudo ./install.sh
</span></span></code></pre></div></li>
<li>
<p>Useful commands:</p>
</li>
</ol>
<p><strong>Agent information</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> sudo /var/ossec/bin/agent_control -i &lt;AGENT_ID&gt;
</span></span></code></pre></div><p><code>AGENT_ID</code> by default is <code>000</code>, to be sure the command <code>sudo /var/ossec/bin/agent_control -l</code> can be used.</p>
<p><strong>Run integrity/rootkit checking</strong></p>
<p>OSSEC by default run rootkit check each 2 hours.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> sudo /var/ossec/bin/agent_control -u &lt;AGENT_ID&gt; -r
</span></span></code></pre></div><p><strong>Alerts</strong></p>
<ul>
<li>All:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tail -f /var/ossec/logs/alerts/alerts.log
</span></span></code></pre></div></li>
<li>Integrity check:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cat /var/ossec/logs/alerts/alerts.log <span class="p">|</span> grep -A4  -i integrity
</span></span></code></pre></div></li>
<li>Rootkit check:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> sudo cat /var/ossec/logs/alerts/alerts.log <span class="p">|</span> grep -A4  <span class="s2">&#34;rootcheck,&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-danger-zone">The Danger Zone</h2>
<h3 id="proceed-at-your-own-risk">Proceed At Your Own Risk</h3>
<p>This sections cover things that are high risk because there is a possibility they can make your system unusable, or are considered unnecessary by many because the risks outweigh any rewards.</p>
<p><strong>!! PROCEED AT YOUR OWN RISK !!</strong></p>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="table-of-contents-1">Table of Contents</h3>
<ul>
<li><a href="#linux-kernel-sysctl-hardening">Linux Kernel sysctl Hardening</a></li>
<li><a href="#password-protect-grub">Password Protect GRUB</a></li>
<li><a href="#disable-root-login">Disable Root Login</a></li>
<li><a href="#change-default-umask">Change Default umask</a></li>
<li><a href="#orphaned-software">Orphaned Software</a></li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="linux-kernel-sysctl-hardening">Linux Kernel sysctl Hardening</h3>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<h4 id="why-24">Why</h4>
<p>The kernel is the brains of a Linux system. Securing it just makes sense.</p>
<h4 id="why-not-2">Why Not</h4>
<p>Changing kernel settings with sysctl is risky and could break your server. If you don&rsquo;t know what you are doing, don&rsquo;t have the time to debug issues, or just don&rsquo;t want to take the risks, I would advise from not following these steps.</p>
<h4 id="disclaimer">Disclaimer</h4>
<p>I am not as knowledgeable about hardening/securing a Linux kernel as I&rsquo;d like. As much as I hate to admit it, I do not know what all of these settings do. My understanding is that most of them are general kernel hardening and performance, and the others are to protect against spoofing and DOS attacks.</p>
<p>In fact, since I am not 100% sure exactly what each setting does, I took recommended settings from numerous sites (all linked in the references below) and combined them to figure out what should be set. I figure if multiple reputable sites mention the same setting, it&rsquo;s probably safe.</p>
<p>If you have a better understanding of what these settings do, or have any other feedback/advice on them, please <a href="#contacting-me">let me know</a>.</p>
<p>I won&rsquo;t provide <a href="#editing-configuration-files---for-the-lazy">For the lazy</a> code in this section.</p>
<h4 id="notes-11">Notes</h4>
<ul>
<li>Documentation on all the sysctl settings/keys is severely lacking. The <a href="https://github.com/torvalds/linux/tree/master/Documentation" target="_blank" rel="noopener">documentation I can find</a> seems to reference the 2.2 version kernel. I could not find anything newer. If you know where I can, please <a href="#contacting-me">let me know</a>.</li>
<li>The reference sites listed below have more comments on what each setting does.</li>
</ul>
<h4 id="references-22">References</h4>
<ul>
<li><a href="https://github.com/torvalds/linux/tree/master/Documentation" target="_blank" rel="noopener">https://github.com/torvalds/linux/tree/master/Documentation</a></li>
<li><a href="https://www.cyberciti.biz/faq/linux-kernel-etcsysctl-conf-security-hardening/" target="_blank" rel="noopener">https://www.cyberciti.biz/faq/linux-kernel-etcsysctl-conf-security-hardening/</a></li>
<li><a href="https://geektnt.com/sysctl-conf-hardening.html" target="_blank" rel="noopener">https://geektnt.com/sysctl-conf-hardening.html</a></li>
<li><a href="https://linoxide.com/how-tos/linux-server-protection/" target="_blank" rel="noopener">https://linoxide.com/how-tos/linux-server-protection/</a></li>
<li><a href="https://github.com/klaver/sysctl/blob/master/sysctl.conf" target="_blank" rel="noopener">https://github.com/klaver/sysctl/blob/master/sysctl.conf</a></li>
<li><a href="https://cloudpro.zone/index.php/2018/01/30/debian-9-3-server-setup-guide-part-5/" target="_blank" rel="noopener">https://cloudpro.zone/index.php/2018/01/30/debian-9-3-server-setup-guide-part-5/</a></li>
</ul>
<h4 id="steps-24">Steps</h4>
<ol>
<li>
<p>The sysctl settings can be found in the <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/blob/master/linux-kernel-sysctl-hardening.md" target="_blank" rel="noopener">linux-kernel-sysctl-hardening.md</a> file in this repo.</p>
</li>
<li>
<p>Before you make a kernel sysctl change permanent, you can test it with the sysctl command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sysctl -w <span class="o">[</span><span class="nv">key</span><span class="o">=</span>value<span class="o">]</span>
</span></span></code></pre></div><p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sysctl -w kernel.ctrl-alt-del<span class="o">=</span><span class="m">0</span>
</span></span></code></pre></div><p><strong>Note</strong>: There are no spaces in <code>key=value</code>, including before and after the space.</p>
</li>
<li>
<p>Once you have tested a setting, and made sure it works without breaking your server, you can make it permanent by adding the values to <code>/etc/sysctl.conf</code>. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo cat /etc/sysctl.conf
</span></span><span class="line"><span class="cl">kernel.ctrl-alt-del <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">fs.file-max <span class="o">=</span> <span class="m">65535</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">kernel.sysrq <span class="o">=</span> <span class="m">0</span>
</span></span></code></pre></div></li>
<li>
<p>After updating the file you can reload the settings or reboot. To reload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sysctl -p
</span></span></code></pre></div></li>
</ol>
<p><strong>Note</strong>: If sysctl has trouble writing any settings then <code>sysctl -w</code> or <code>sysctl -p</code> will write an error to stderr. You can use this to quickly find invalid settings in your <code>/etc/sysctl.conf</code> file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sysctl -p &gt;/dev/null
</span></span></code></pre></div></details><br />
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="password-protect-grub">Password Protect GRUB</h3>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<h4 id="why-25">Why</h4>
<p>If a bad actor has physical access to your server, they could use GRUB to gain unauthorized access to your system.</p>
<h4 id="why-not-3">Why Not</h4>
<p>If you forget the password, you&rsquo;ll have to go through <a href="https://www.cyberciti.biz/tips/howto-recovering-grub-boot-loader-password.html" target="_blank" rel="noopener">some work</a> to recover the password.</p>
<h4 id="goals-23">Goals</h4>
<ul>
<li>auto boot the default Debian install and require a password for anything else</li>
</ul>
<h4 id="notes-12">Notes</h4>
<ul>
<li>This will only protect GRUB and anything behind it like your operating systems. Check your motherboard&rsquo;s documentation for password protecting your BIOS to prevent a bad actor from circumventing GRUB.</li>
</ul>
<h4 id="references-23">References</h4>
<ul>
<li><a href="https://selivan.github.io/2017/12/21/grub2-password-for-all-but-default-menu-entries.html" target="_blank" rel="noopener">https://selivan.github.io/2017/12/21/grub2-password-for-all-but-default-menu-entries.html</a></li>
<li><a href="https://help.ubuntu.com/community/Grub2/Passwords" target="_blank" rel="noopener">https://help.ubuntu.com/community/Grub2/Passwords</a></li>
<li><a href="https://computingforgeeks.com/how-to-protect-grub-with-password-on-debian-ubuntu-and-kali-linux/" target="_blank" rel="noopener">https://computingforgeeks.com/how-to-protect-grub-with-password-on-debian-ubuntu-and-kali-linux/</a></li>
<li><code>man grub</code></li>
<li><code>man grub-mkpasswd-pbkdf2</code></li>
</ul>
<h4 id="steps-25">Steps</h4>
<ol>
<li>
<p>Create a <a href="https://en.wikipedia.org/wiki/PBKDF2" target="_blank" rel="noopener">Password-Based Key Derivation Function 2 (PBKDF2)</a> hash of your password:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grub-mkpasswd-pbkdf2 -c <span class="m">100000</span>
</span></span></code></pre></div><p>The below output is from using <code>password</code> as the password:</p>
<blockquote>
<pre tabindex="0"><code>Enter password:
Reenter password:
PBKDF2 hash of your password is grub.pbkdf2.sha512.100000.2812C233DFC899EFC3D5991D8CA74068C99D6D786A54F603E9A1EFE7BAEDDB6AA89672F92589FAF98DB9364143E7A1156C9936328971A02A483A84C3D028C4FF.C255442F9C98E1F3C500C373FE195DCF16C56EEBDC55ABDD332DD36A92865FA8FC4C90433757D743776AB186BD3AE5580F63EF445472CC1D151FA03906D08A6D
</code></pre></blockquote>
</li>
<li>
<p>Copy everything <strong>after</strong> <code>PBKDF2 hash of your password is </code>, <strong>starting from and including</strong> <code>grub.pbkdf2.sha512...</code> to the end. You&rsquo;ll need this in the next step.</p>
</li>
<li>
<p>The <code>update-grub</code> program uses scripts to generate configuration files it will use for GRUB&rsquo;s settings. Create the file <code>/etc/grub.d/01_password</code> and add the below code after replacing <code>[hash]</code> with the hash you copied from the first step. This tells <code>update-grub</code> to use this username and password for GRUB.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">set superusers=&#34;grub&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">password_pbkdf2 grub [hash]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>For example:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">set superusers=&#34;grub&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">password_pbkdf2 grub grub.pbkdf2.sha512.100000.2812C233DFC899EFC3D5991D8CA74068C99D6D786A54F603E9A1EFE7BAEDDB6AA89672F92589FAF98DB9364143E7A1156C9936328971A02A483A84C3D028C4FF.C255442F9C98E1F3C500C373FE195DCF16C56EEBDC55ABDD332DD36A92865FA8FC4C90433757D743776AB186BD3AE5580F63EF445472CC1D151FA03906D08A6D
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div></blockquote>
</li>
<li>
<p>Set the file&rsquo;s execute bit so <code>update-grub</code> includes it when it updates GRUB&rsquo;s configuration:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo chmod a+x /etc/grub.d/01_password
</span></span></code></pre></div></li>
<li>
<p>Make a backup of GRUB&rsquo;s configuration file <code>/etc/grub.d/10_linux</code> that we&rsquo;ll be modifying and unset the execute bit so <code>update-grub</code> doesn&rsquo;t try to run it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/grub.d/10_linux /etc/grub.d/10_linux-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo chmod a-x /etc/grub.d/10_linux.*
</span></span></code></pre></div></li>
<li>
<p>To make the default Debian install unrestricted (<strong>without</strong> the password) while keeping everything else restricted (<strong>with</strong> the password) modify <code>/etc/grub.d/10_linux</code> and add <code>--unrestricted</code> to the <code>CLASS</code> variable.</p>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;/^CLASS=/ a CLASS=\&#34;\${CLASS} --unrestricted\&#34;         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> /etc/grub.d/10_linux
</span></span></code></pre></div></li>
<li>
<p>Update GRUB with <code>update-grub</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo update-grub
</span></span></code></pre></div></li>
</ol>
</details><br />
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="disable-root-login">Disable Root Login</h3>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<h4 id="why-26">Why</h4>
<p>If you have sudo <a href="#limit-who-can-use-sudo">configured properly</a>, then the <strong>root</strong> account will mostly never need to log in directly &ndash; either at the terminal or remotely.</p>
<h4 id="why-not-4">Why Not</h4>
<p><strong>Be warned, this can cause issues with some configurations!</strong></p>
<p>If your installation uses <a href="https://linux.die.net/man/8/sulogin" target="_blank" rel="noopener"><code>sulogin</code></a> (like Debian) to drop to a <strong>root</strong> console during boot failures, then locking the <strong>root</strong> account will prevent <code>sulogin</code> from opening the <strong>root</strong> shell and you will get this error:</p>
<pre><code>Cannot open access to console, the root account is locked.

See sulogin(8) man page for more details.

Press Enter to continue.
</code></pre>
<p>To work around this, you can use the <code>--force</code> option for <code>sulogin</code>. Some distributions already include this, or some other, workaround.</p>
<p>An alternative to locking the <strong>root</strong> acount is set a long/complicated <strong>root</strong> password and store it in a secured, non digital format. That way you have it when/if you need it.</p>
<h4 id="goals-24">Goals</h4>
<ul>
<li>locked <strong>root</strong> account that nobody can use to log in as <strong>root</strong></li>
</ul>
<h4 id="notes-13">Notes</h4>
<ul>
<li>Some distributions disable <strong>root</strong> login by default (e.g. Ubuntu) so you may not need to do this step. Check with your distribution&rsquo;s documentation.</li>
</ul>
<h4 id="references-24">References</h4>
<ul>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=806852" target="_blank" rel="noopener">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=806852</a></li>
<li><a href="https://github.com/systemd/systemd/issues/7115" target="_blank" rel="noopener">https://github.com/systemd/systemd/issues/7115</a></li>
<li><a href="https://github.com/karelzak/util-linux/commit/7ff1162e67164cb4ece19dd809c26272461aa254" target="_blank" rel="noopener">https://github.com/karelzak/util-linux/commit/7ff1162e67164cb4ece19dd809c26272461aa254</a></li>
<li><a href="https://github.com/systemd/systemd/issues/11596" target="_blank" rel="noopener">https://github.com/systemd/systemd/issues/11596</a></li>
<li><a href="https://www.reddit.com/r/selfhosted/comments/aoxd4l/new_guide_created_by_me_how_to_secure_a_linux/eg4rkfi/" target="_blank" rel="noopener">https://www.reddit.com/r/selfhosted/comments/aoxd4l/new_guide_created_by_me_how_to_secure_a_linux/eg4rkfi/</a></li>
<li><code>man systemd</code></li>
</ul>
<h4 id="steps-26">Steps</h4>
<ol>
<li>
<p>Lock the <strong>root</strong> account:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo passwd -l root
</span></span></code></pre></div></li>
</ol>
</details><br />
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="change-default-umask">Change Default umask</h3>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<h4 id="why-27">Why</h4>
<p>umask controls the <strong>default</strong> permissions of files/folders when they are created. Insecure file/folder permissions give other accounts potentially unauthorized access to your data. This may include the ability to make configuration changes.</p>
<ul>
<li>For <strong>non-root</strong> accounts, there is no need for other accounts to get any access to the account&rsquo;s files/folders <strong>by default</strong>.</li>
<li>For the <strong>root</strong> account, there is no need for the file/folder primary group or other accounts to have any access to <strong>root</strong>&rsquo;s files/folders <strong>by default</strong>.</li>
</ul>
<p>When and if other accounts need access to a file/folder, you want to explicitly grant it using a combination of file/folder permissions and primary group.</p>
<h4 id="why-not-5">Why Not</h4>
<p>Changing the default umask can create unexpected problems. For example, if you set umask to <code>0077</code> for <strong>root</strong>, then <strong>non-root</strong> accounts <strong>will not</strong> have access to application configuration files/folders in <code>/etc/</code> which could break applications that do not run with <strong>root</strong> privileges.</p>
<h4 id="how-it-works-16">How It Works</h4>
<p>In order to explain how umask works I&rsquo;d have to explain how Linux file/folder permissions work. As that is a rather complicated question, I will defer you to the references below for further reading.</p>
<h4 id="goals-25">Goals</h4>
<ul>
<li>set default umask for <strong>non-root</strong> accounts to <strong>0027</strong></li>
<li>set default umask for the <strong>root</strong> account to <strong>0077</strong></li>
</ul>
<h4 id="notes-14">Notes</h4>
<ul>
<li>umask is a Bash built-in which means a user can change their own umask setting.</li>
</ul>
<h4 id="references-25">References</h4>
<ul>
<li><a href="https://www.linuxnix.com/umask-define-linuxunix/" target="_blank" rel="noopener">https://www.linuxnix.com/umask-define-linuxunix/</a></li>
<li><a href="https://serverfault.com/questions/818783/which-umask-is-more-secure-in-linux-022-or-027" target="_blank" rel="noopener">https://serverfault.com/questions/818783/which-umask-is-more-secure-in-linux-022-or-027</a></li>
<li><a href="https://www.cyberciti.biz/tips/understanding-linux-unix-umask-value-usage.html" target="_blank" rel="noopener">https://www.cyberciti.biz/tips/understanding-linux-unix-umask-value-usage.html</a></li>
<li><code>man umask</code></li>
</ul>
<h4 id="steps-27">Steps</h4>
<ol>
<li>
<p>Make a backup of files we&rsquo;ll be editing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/profile /etc/profile-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo cp --archive /etc/bash.bashrc /etc/bash.bashrc-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo cp --archive /etc/login.defs /etc/login.defs-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sudo cp --archive /root/.bashrc /root/.bashrc-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Set default umask for <strong>non-root</strong> accounts to <strong>0027</strong> by adding this line to <code>/etc/profile</code> and <code>/etc/bash.bashrc</code>:</p>
<pre tabindex="0"><code>umask 0027
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\numask 0027         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/profile /etc/bash.bashrc
</span></span></code></pre></div></li>
<li>
<p>We also need to add this line to <code>/etc/login.defs</code>:</p>
<pre tabindex="0"><code>UMASK 0027
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\nUMASK 0027         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /etc/login.defs
</span></span></code></pre></div></li>
<li>
<p>Set default umask for the <strong>root</strong> account to <strong>0077</strong> by adding this line to <code>/root/.bashrc</code>:</p>
<pre tabindex="0"><code>umask 0077
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\numask 0077         # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="p">|</span> sudo tee -a /root/.bashrc
</span></span></code></pre></div></li>
</ol>
</details><br />
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="orphaned-software">Orphaned Software</h3>
<details><summary>!! PROCEED AT YOUR OWN RISK !!</summary>
<h4 id="why-28">Why</h4>
<p>As you use your system, and you install and uninstall software, you&rsquo;ll eventually end up with orphaned, or unused software/packages/libraries. You don&rsquo;t need to remove them, but if you don&rsquo;t need them, why keep them? When security is a priority, anything not explicitly needed is a potential security threat. You want to keep your server as trimmed and lean as possible.</p>
<h4 id="notes-15">Notes</h4>
<ul>
<li>Each distribution manages software/packages/libraries differently so how you find and remove orphaned packages will be different. So far I only have steps for Debian based systems.</li>
</ul>
<h4 id="debian-based-systems-1">Debian Based Systems</h4>
<p>On Debian based systems, you can use <a href="http://freshmeat.sourceforge.net/projects/deborphan/" target="_blank" rel="noopener">deborphan</a> to find orphaned packages.</p>
<h5 id="a-nameorphaned-software-why-notawhy-not"><a name="orphaned-software-why-not"></a>Why Not</h5>
<p>Keep in mind, deborphan finds packages that have <strong>no package dependencies</strong>. That does not mean they are not used. You could very well have a package you use every day that has no dependencies that you wouldn&rsquo;t want to remove. And, if deborphan gets anything wrong, then removing critical packages may break your system.</p>
<h5 id="steps-28">Steps</h5>
<ol>
<li>
<p>Install deborphan.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install deborphan
</span></span></code></pre></div></li>
<li>
<p>Run deborphan as <strong>root</strong> to see a list of orphaned packages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo deborphan
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>libxapian30
libpipeline1
</code></pre></blockquote>
</li>
<li>
<p><a href="#orphaned-software-why-not">Assuming you want to remove all of the packages deborphan finds</a>, you can pass it&rsquo;s output to <code>apt</code> to remove them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt --autoremove purge <span class="k">$(</span>deborphan<span class="k">)</span>
</span></span></code></pre></div></li>
</ol>
</details>
</details><br />
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="the-miscellaneous">The Miscellaneous</h2>
<h3 id="the-simple-way-with-msmtp">The Simple way with MSMTP</h3>
<p>(#msmtp-alternative)</p>
<h4 id="why-29">Why</h4>
<p>Well I will SIMPLIFY this method, to only output email using google mail account (and others). True Simple! :)</p>
<pre><code>``` bash
#!/bin/bash
###### PLEASE .... EDIT IT...
USEREMAIL=&quot;usernameemail&quot;
DOMPROV=&quot;gmail.com&quot;
PWDEMAIL=&quot;passwordStrong&quot;  ## ATTENTION DONT USE Special Chars.. like as SPACE # and some others not all. Feel free to test ;)
MAILPROV=&quot;smtp.google.com:583&quot;
MYMAIL=&quot;$USRMAIL@$DOMPROV&quot;
USERLOC=&quot;root&quot;
#######
apt install -y msmtp
    ln -s /usr/bin/msmtp /usr/sbin/sendmail
#wget http://www.cacert.org/revoke.crl -O /etc/ssl/certs/revoke.crl
#chmod 644 /etc/ssl/certs/revoke.crl
touch /root/.msmtprc
cat &lt;&lt;EOF&gt; .msmtprc
defaults
account gmail
host $MAILPROV
port $MAILPORT
#proxy_host 127.0.0.1
#proxy_port 9001
from $MYEMAIL
timeout off
protocol smtp
#auto_from [(on|off)]
#from envelope_from
#maildomain [domain]
auth on
user $USRMAIL
passwordeval &quot;gpg -q --for-your-eyes-only --no-tty -d /root/msmtp-mail.gpg&quot;
#passwordeval &quot;gpg --quiet --for-your-eyes-only --no-tty --decrypt /root/msmtp-mail.gpg&quot;
tls on
tls_starttls on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
#tls_crl_file /etc/ssl/certs/revoke.crl
#tls_fingerprint [fingerprint]
#tls_key_file [file]
#tls_cert_file [file]
tls_certcheck on
tls_force_sslv3 on
tls_min_dh_prime_bits 512
#tls_priorities [priorities]
#dsn_notify (off|condition)
#dsn_return (off|amount)
#domain argument
#keepbcc off
logfile /var/log/mail.log
syslog on
account default : gmail
EOF
chmod 0400 /root/.msmtprc

   ## In testing .. auto command
# echo -e &quot;1\n4096\n\ny\n$MYUSRMAIL\n$MYEMAIL\nmy key\nO\n$PWDMAIL\n$PWDMAIL\n&quot; | gpg --full-generate-key
##
gpg --full-generate-key
gpg --output revoke.asc --gen-revoke $MYEMAIL
echo -e &quot;$PWDEMAIL\n&quot; | gpg -e -o /root/msmtp-mail.gpg --recipient $MYEMAIL
echo &quot;export GPG_TTY=\$(tty)&quot; &gt;&gt; .baschrc
chmod 400 msmtp-mail.gpg

echo &quot;Hello there&quot; | msmtp --debug $MYEMAIL
echo&quot;######################
## MSMTP Configured ##
######################&quot;
```
</code></pre>
<p>DONE!! ;)
(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="gmail-and-exim4-as-mta-with-implicit-tls">Gmail and Exim4 As MTA With Implicit TLS</h3>
<h4 id="why-30">Why</h4>
<p>Unless you&rsquo;re planning on setting up your own mail server, you&rsquo;ll need a way to send e-mails from your server. This will be important for system alerts/messages.</p>
<p>You can use any Gmail account. I recommend you create one specific for this server. That way if your server <strong>is</strong> compromised, the bad-actor won&rsquo;t have any passwords for your primary account. Granted, if you have 2FA/MFA enabled and you use an app password, there isn&rsquo;t much a bad-actor can do with just the app password, but why take the risk?</p>
<p>There are many guides on-line that cover how to configure Gmail as MTA using STARTTLS including a <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/tree/cc5edcae1cf846dd250e76b121e721d836481d2f#configure-gmail-as-mta" target="_blank" rel="noopener">previous version of this guide</a>. With STARTTLS, an initial <strong>unencrypted</strong> connection is made and then upgraded to an encrypted TLS or SSL connection. Instead, with the approach outlined below, an encrypted TLS connection is made from the start.</p>
<p>Also, as discussed in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">issue #29</a> and <a href="https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender" target="_blank" rel="noopener">here</a>, exim4 will fail for messages with long lines. We&rsquo;ll fix this in this section too.</p>
<h4 id="goals-26">Goals</h4>
<ul>
<li><code>mail</code> configured to send e-mails from your server using <a href="https://mail.google.com/" target="_blank" rel="noopener">Gmail</a></li>
<li>long line support for exim4</li>
</ul>
<h4 id="references-26">References</h4>
<ul>
<li>Thanks to <a href="https://github.com/remyabel" target="_blank" rel="noopener">remyabel</a> for figuring out how to get this to work with TLS as documented in <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/24" target="_blank" rel="noopener">issue #24</a> and <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/pull/26" target="_blank" rel="noopener">pull request #26</a>.</li>
<li><a href="https://wiki.debian.org/Exim" target="_blank" rel="noopener">https://wiki.debian.org/Exim</a></li>
<li><a href="https://wiki.debian.org/GmailAndExim4" target="_blank" rel="noopener">https://wiki.debian.org/GmailAndExim4</a></li>
<li><a href="https://www.exim.org/exim-html-current/doc/html/spec_html/ch-encrypted_smtp_connections_using_tlsssl.html" target="_blank" rel="noopener">https://www.exim.org/exim-html-current/doc/html/spec_html/ch-encrypted_smtp_connections_using_tlsssl.html</a></li>
<li><a href="https://php.quicoto.com/setup-exim4-to-use-gmail-in-ubuntu/" target="_blank" rel="noopener">https://php.quicoto.com/setup-exim4-to-use-gmail-in-ubuntu/</a></li>
<li><a href="https://www.fastmail.com/help/technical/ssltlsstarttls.html" target="_blank" rel="noopener">https://www.fastmail.com/help/technical/ssltlsstarttls.html</a></li>
<li>exim4 fails for messages with long lines - <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">issue #29</a> and <a href="https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender" target="_blank" rel="noopener">https://blog.dhampir.no/content/exim4-line-length-in-debian-stretch-mail-delivery-failed-returning-message-to-sender</a></li>
</ul>
<h4 id="steps-29">Steps</h4>
<ol>
<li>
<p>Install exim4. You will also need openssl and ca-certificates.</p>
<p>On Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install exim4 openssl ca-certificates
</span></span></code></pre></div></li>
<li>
<p>Configure exim4:</p>
<p>For Debian based systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg-reconfigure exim4-config
</span></span></code></pre></div><p>You&rsquo;ll be prompted with some questions:</p>
<table>
<thead>
<tr>
<th style="text-align:right">Prompt</th>
<th>Answer</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">General type of mail configuration</td>
<td><code>mail sent by smarthost; no local mail</code></td>
</tr>
<tr>
<td style="text-align:right">System mail name</td>
<td><code>localhost</code></td>
</tr>
<tr>
<td style="text-align:right">IP-addresses to listen on for incoming SMTP connections</td>
<td><code>127.0.0.1; ::1</code></td>
</tr>
<tr>
<td style="text-align:right">Other destinations for which mail is accepted</td>
<td>(default)</td>
</tr>
<tr>
<td style="text-align:right">Visible domain name for local users</td>
<td><code>localhost</code></td>
</tr>
<tr>
<td style="text-align:right">IP address or host name of the outgoing smarthost</td>
<td><code>smtp.gmail.com::465</code></td>
</tr>
<tr>
<td style="text-align:right">Keep number of DNS-queries minimal (Dial-on-Demand)?</td>
<td><code>No</code></td>
</tr>
<tr>
<td style="text-align:right">Split configuration into small files?</td>
<td><code>No</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Make a backup of <code>/etc/exim4/passwd.client</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/exim4/passwd.client /etc/exim4/passwd.client-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Add a line like this to <code>/etc/exim4/passwd.client</code></p>
<pre tabindex="0"><code>smtp.gmail.com:yourAccount@gmail.com:yourPassword
*.google.com:yourAccount@gmail.com:yourPassword
</code></pre><p><strong>Notes</strong>:</p>
<ul>
<li>Replace <code>yourAccount@gmail.com</code> and <code>yourPassword</code> with your details. If you have 2FA/MFA enabled on your Gmail then you&rsquo;ll need to create and use an app password here.</li>
<li>Always check <code>host smtp.gmail.com</code> for the most up-to-date domains to list.</li>
</ul>
</li>
<li>
<p>This file has your Gmail password so we need to lock it down:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo chown root:Debian-exim /etc/exim4/passwd.client
</span></span><span class="line"><span class="cl">sudo chmod <span class="m">640</span> /etc/exim4/passwd.client
</span></span></code></pre></div></li>
<li>
<p>The next step is to create an TLS certificate that exim4 will use to make the encrypted connection to <code>smtp.gmail.com</code>. You can use your own certificate, like one from <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let&rsquo;s Encrypt</a>, or create one yourself using openssl. We will use a script that comes with exim4 that calls openssl to make our certificate:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo bash /usr/share/doc/exim4-base/examples/exim-gencert
</span></span></code></pre></div><blockquote>
<pre tabindex="0"><code>[*] Creating a self signed SSL certificate for Exim!
    This may be sufficient to establish encrypted connections but for
    secure identification you need to buy a real certificate!

    Please enter the hostname of your MTA at the Common Name (CN) prompt!

Generating a RSA private key
..........................................+++++
................................................+++++
writing new private key to &#39;/etc/exim4/exim.key&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Code (2 letters) [US]:[redacted]
State or Province Name (full name) []:[redacted]
Locality Name (eg, city) []:[redacted]
Organization Name (eg, company; recommended) []:[redacted]
Organizational Unit Name (eg, section) []:[redacted]
Server name (eg. ssl.domain.tld; required!!!) []:localhost
Email Address []:[redacted]
[*] Done generating self signed certificates for exim!
    Refer to the documentation and example configuration files
    over at /usr/share/doc/exim4-base/ for an idea on how to enable TLS
    support in your mail transfer agent.
</code></pre></blockquote>
</li>
<li>
<p>Instruct exim4 to use TLS and port 465, and <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/29" target="_blank" rel="noopener">fix exim4&rsquo;s long lines issue</a>, by creating the file <code>/etc/exim4/exim4.conf.localmacros</code> and adding:</p>
<pre tabindex="0"><code>MAIN_TLS_ENABLE = 1
REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS = *
TLS_ON_CONNECT_PORTS = 465
REQUIRE_PROTOCOL = smtps
IGNORE_SMTP_LINE_LENGTH_LIMIT = true
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | sudo tee /etc/exim4/exim4.conf.localmacros
</span></span></span><span class="line"><span class="cl"><span class="s">MAIN_TLS_ENABLE = 1
</span></span></span><span class="line"><span class="cl"><span class="s">REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS = *
</span></span></span><span class="line"><span class="cl"><span class="s">TLS_ON_CONNECT_PORTS = 465
</span></span></span><span class="line"><span class="cl"><span class="s">REQUIRE_PROTOCOL = smtps
</span></span></span><span class="line"><span class="cl"><span class="s">IGNORE_SMTP_LINE_LENGTH_LIMIT = true
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>Make a backup of exim4&rsquo;s configuration file <code>/etc/exim4/exim4.conf.template</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp --archive /etc/exim4/exim4.conf.template /etc/exim4/exim4.conf.template-COPY-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M%S&#34;</span><span class="k">)</span>
</span></span></code></pre></div></li>
<li>
<p>Add the below to <code>/etc/exim4/exim4.conf.template</code> after the <code>.ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS ... .endif</code> block:</p>
<pre tabindex="0"><code>.ifdef REQUIRE_PROTOCOL
  protocol = REQUIRE_PROTOCOL
.endif
</code></pre><blockquote>
<pre tabindex="0"><code>.ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS
  hosts_require_tls = REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS
.endif
.ifdef REQUIRE_PROTOCOL
    protocol = REQUIRE_PROTOCOL
.endif
.ifdef REMOTE_SMTP_HEADERS_REWRITE
  headers_rewrite = REMOTE_SMTP_HEADERS_REWRITE
.endif
</code></pre></blockquote>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s1">&#39;/^.ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS$/I { :a; n; /^.endif$/!ba; a\# added by &#39;</span><span class="s2">&#34;</span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">&#34;</span><span class="s1">&#39;\n.ifdef REQUIRE_PROTOCOL\n    protocol = REQUIRE_PROTOCOL\n.endif\n# end add&#39;</span> -e <span class="s1">&#39;}&#39;</span> /etc/exim4/exim4.conf.template
</span></span></code></pre></div></li>
<li>
<p>Add the below to <code>/etc/exim4/exim4.conf.template</code> inside the <code>.ifdef MAIN_TLS_ENABLE</code> block:</p>
<pre tabindex="0"><code>.ifdef TLS_ON_CONNECT_PORTS
  tls_on_connect_ports = TLS_ON_CONNECT_PORTS
.endif
</code></pre><blockquote>
<pre tabindex="0"><code>.ifdef MAIN_TLS_ENABLE
.ifdef TLS_ON_CONNECT_PORTS
    tls_on_connect_ports = TLS_ON_CONNECT_PORTS
.endif
</code></pre></blockquote>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;/\.ifdef MAIN_TLS_ENABLE/ a # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\n.ifdef TLS_ON_CONNECT_PORTS\n    tls_on_connect_ports = TLS_ON_CONNECT_PORTS\n.endif\n# end add&#34;</span> /etc/exim4/exim4.conf.template
</span></span></code></pre></div></li>
<li>
<p>Update exim4 configuration to use TLS and then restart the service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo update-exim4.conf
</span></span><span class="line"><span class="cl">sudo service exim4 restart
</span></span></code></pre></div></li>
<li>
<p>If you&rsquo;re using <a href="#ufw-uncomplicated-firewall">UFW</a>, you&rsquo;ll need to allow outbound traffic on 465. To do this we&rsquo;ll create a custom UFW application profile and then enable it. Create the file <code>/etc/ufw/applications.d/smtptls</code>, add this, then run <code>ufw allow out smtptls comment 'open TLS port 465 for use with SMPT to send e-mails'</code>:</p>
<pre tabindex="0"><code>[SMTPTLS]
title=SMTP through TLS
description=This opens up the TLS port 465 for use with SMPT to send e-mails.
ports=465/tcp
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | sudo tee /etc/ufw/applications.d/smtptls
</span></span></span><span class="line"><span class="cl"><span class="s">[SMTPTLS]
</span></span></span><span class="line"><span class="cl"><span class="s">title=SMTP through TLS
</span></span></span><span class="line"><span class="cl"><span class="s">description=This opens up the TLS port 465 for use with SMPT to send e-mails.
</span></span></span><span class="line"><span class="cl"><span class="s">ports=465/tcp
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ufw allow out smtptls comment <span class="s1">&#39;open TLS port 465 for use with SMPT to send e-mails&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>Add some mail aliases so we can send e-mails to local accounts by adding lines like this to <code>/etc/aliases</code>:</p>
<pre tabindex="0"><code>user1: user1@gmail.com
user2: user2@gmail.com
...
</code></pre><p>You&rsquo;ll need to add all the local accounts that exist on your server.</p>
</li>
<li>
<p>Test your setup:</p>
<pre tabindex="0"><code>echo &#34;test&#34; | mail -s &#34;Test&#34; email@gmail.com
sudo tail /var/log/exim4/mainlog
</code></pre></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="separate-iptables-log-file">Separate iptables Log File</h3>
<h4 id="why-31">Why</h4>
<p>There will come a time when you&rsquo;ll need to look through your iptables logs. Having all the iptables logs go to their own file will make it a lot easier to find what you&rsquo;re looking for.</p>
<h4 id="references-27">References</h4>
<ul>
<li><a href="https://blog.shadypixel.com/log-iptables-messages-to-a-separate-file-with-rsyslog/" target="_blank" rel="noopener">https://blog.shadypixel.com/log-iptables-messages-to-a-separate-file-with-rsyslog/</a></li>
<li><a href="https://gist.github.com/netson/c45b2dc4e835761fbccc" target="_blank" rel="noopener">https://gist.github.com/netson/c45b2dc4e835761fbccc</a></li>
<li><a href="https://www.rsyslog.com/doc/v8-stable/configuration/actions.html" target="_blank" rel="noopener">https://www.rsyslog.com/doc/v8-stable/configuration/actions.html</a></li>
</ul>
<h4 id="steps-30">Steps</h4>
<ol>
<li>
<p>The first step is by telling your firewall to prefix all log entries with some unique string. If you&rsquo;re using iptables directly, you would do something like <code>--log-prefix &quot;[IPTABLES] &quot;</code> for all the rules. We took care of this in step <a href="#psad_step4">step 4 of installing psad</a>.</p>
</li>
<li>
<p>After you&rsquo;ve added a prefix to the firewall logs, we need to tell rsyslog to send those lines to its own file. Do this by creating the file <code>/etc/rsyslog.d/10-iptables.conf</code> and adding this:</p>
<pre tabindex="0"><code>:msg, contains, &#34;[IPTABLES] &#34; /var/log/iptables.log
&amp; stop
</code></pre><p>If you&rsquo;re expecting a lot if data being logged by your firewall, prefix the filename with a <code>-</code> <a href="https://www.rsyslog.com/doc/v8-stable/configuration/actions.html#regular-file" target="_blank" rel="noopener">&ldquo;to omit syncing the file after every logging&rdquo;</a>. For example:</p>
<pre tabindex="0"><code>:msg, contains, &#34;[IPTABLES] &#34; -/var/log/iptables.log
&amp; stop
</code></pre><p><strong>Note</strong>: Remember to change the prefix to whatever you use.</p>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | sudo tee /etc/rsyslog.d/10-iptables.conf
</span></span></span><span class="line"><span class="cl"><span class="s">:msg, contains, &#34;[IPTABLES] &#34; /var/log/iptables.log
</span></span></span><span class="line"><span class="cl"><span class="s">&amp; stop
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div></li>
<li>
<p>Since we&rsquo;re logging firewall messages to a different file, we need to tell psad where the new file is. Edit <code>/etc/psad/psad.conf</code> and set <code>IPT_SYSLOG_FILE</code> to the path of the log file. For example:</p>
<pre tabindex="0"><code>IPT_SYSLOG_FILE /var/log/iptables.log;
</code></pre><p><strong>Note</strong>: Remember to change the prefix to whatever you use.</p>
<p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo sed -i -r -e <span class="s2">&#34;s/^(IPT_SYSLOG_FILE\s+)([^;]+)(;)</span>$<span class="s2">/# \1\2\3       # commented by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">\n\1\/var\/log\/iptables.log\3       # added by </span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2"> on </span><span class="k">$(</span>date +<span class="s2">&#34;%Y-%m-%d @ %H:%M:%S&#34;</span><span class="k">)</span><span class="s2">/&#34;</span> /etc/psad/psad.conf
</span></span></code></pre></div></li>
<li>
<p>Restart psad and rsyslog to activate the changes (or reboot):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo psad -R
</span></span><span class="line"><span class="cl">sudo psad --sig-update
</span></span><span class="line"><span class="cl">sudo psad -H
</span></span><span class="line"><span class="cl">sudo service rsyslog restart
</span></span></code></pre></div></li>
<li>
<p>The last thing we have to do is tell logrotate to rotate the new log file so it doesn&rsquo;t get to big and fill up our disk. Create the file <code>/etc/logrotate.d/iptables</code> and add this:</p>
<pre tabindex="0"><code>/var/log/iptables.log
{
    rotate 7
    daily
    missingok
    notifempty
    delaycompress
    compress
    postrotate
        invoke-rc.d rsyslog rotate &gt; /dev/null
    endscript
}
</code></pre><p><a href="#editing-configuration-files---for-the-lazy">For the lazy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt; EOF | sudo tee /etc/logrotate.d/iptables
</span></span></span><span class="line"><span class="cl"><span class="s">/var/log/iptables.log
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    rotate 7
</span></span></span><span class="line"><span class="cl"><span class="s">    daily
</span></span></span><span class="line"><span class="cl"><span class="s">    missingok
</span></span></span><span class="line"><span class="cl"><span class="s">    notifempty
</span></span></span><span class="line"><span class="cl"><span class="s">    delaycompress
</span></span></span><span class="line"><span class="cl"><span class="s">    compress
</span></span></span><span class="line"><span class="cl"><span class="s">    postrotate
</span></span></span><span class="line"><span class="cl"><span class="s">        invoke-rc.d rsyslog rotate &gt; /dev/null
</span></span></span><span class="line"><span class="cl"><span class="s">    endscript
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div></li>
</ol>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h2 id="left-over">Left Over</h2>
<h3 id="contacting-me">Contacting Me</h3>
<p>For any questions, comments, concerns, feedback, or issues, submit a <a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server/issues/new" target="_blank" rel="noopener">new issue</a>.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="helpful-links">Helpful Links</h3>
<ul>
<li><a href="https://github.com/pratiktri/server_init_harden" target="_blank" rel="noopener">https://github.com/pratiktri/server_init_harden</a> - Bash script that automates few of the tasks that you need to perform on a new Linux server to give it basic amount security.</li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="acknowledgments">Acknowledgments</h3>
<ul>
<li><a href="https://www.reddit.com/r/linuxquestions/comments/aopzl7/new_guide_created_by_me_how_to_secure_a_linux/" target="_blank" rel="noopener">https://www.reddit.com/r/linuxquestions/comments/aopzl7/new_guide_created_by_me_how_to_secure_a_linux/</a></li>
<li><a href="https://www.reddit.com/r/selfhosted/comments/aoxd4l/new_guide_created_by_me_how_to_secure_a_linux/" target="_blank" rel="noopener">https://www.reddit.com/r/selfhosted/comments/aoxd4l/new_guide_created_by_me_how_to_secure_a_linux/</a></li>
<li><a href="https://news.ycombinator.com/item?id=19177435#19178618" target="_blank" rel="noopener">https://news.ycombinator.com/item?id=19177435#19178618</a></li>
<li><a href="https://www.reddit.com/r/linuxadmin/comments/arx7xo/howtosecurealinuxserver_an_evolving_howto_guide/" target="_blank" rel="noopener">https://www.reddit.com/r/linuxadmin/comments/arx7xo/howtosecurealinuxserver_an_evolving_howto_guide/</a></li>
<li><a href="https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/" target="_blank" rel="noopener">https://www.reddit.com/r/linux/comments/arx7st/howtosecurealinuxserver_an_evolving_howto_guide/</a></li>
</ul>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>
<h3 id="license-and-copyright">License and Copyright</h3>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">
















  <figure  >
    <div class="d-flex justify-content-center">
      <div class="w-100" ><img src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="CC-BY-SA" loading="lazy" data-zoomable /></div>
    </div></figure></a></p>
<p><a href="https://github.com/imthenachoman/How-To-Secure-A-Linux-Server" target="_blank" rel="noopener">How To Secure A Linux Server</a> by <a href="https://github.com/imthenachoman" target="_blank" rel="noopener">Anchal Nigam</a> is licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0" target="_blank" rel="noopener">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<p>See <a href="LICENSE.txt">LICENSE</a> for the full license.</p>
<p>(<a href="#table-of-contents">Table of Contents</a>)</p>

          </div>

          



          
          
          <div class="article-widget">
            
<div class="container-xl row post-nav">
  
  
</div>

          </div>
          

        <div class="body-footer">
          <p>最近更新于 0001-01-01</p>

          



          


  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); 
    s.async = true;
    s.src = 'https://' + "ngte" + '.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </section>
  



          


        </div>

      </article>

      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2017-2022 NGTE all rights reserved</p>
        </div>
    </div>
  </div>

  <script type="text/javascript" id="clstr_globe" async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script>
  
</footer>


    </main>
  </div>
</div>
<script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
  const heti = new Heti('.article');
  heti.autoSpacing();
</script>
<script type="text/javascript">
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "12adcc35-9621-4313-8262-62dc654b29d8";
  (function () {
    setTimeout(function() {
      d = document;
      s = d.createElement("script");
      s.src = "https://client.crisp.chat/l.js";
      s.async = 1;
      d.getElementsByTagName("head")[0].appendChild(s);
    }, 2500);
  })();
</script>
  </div>

  <div class="page-footer">
    
    
  </div>

      

    
    <script src="/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js"></script>

    
    
    
      

      
      

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
      

    

    
    
    

    
    
    
      
      <script id="search-hit-algolia-template" type="text/html">
        <div class="search-hit">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a>
            </div>
            <div class="article-metadata search-hit-type">{{type}}</div>
            <p class="search-hit-description">{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p>
          </div>
        </div>
      </script>
      
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js" crossorigin="anonymous"></script>
      
      
    

    
    

    
    
    
    
      <script id="dsq-count-scr" src="https://ngte.disqus.com/count.js" async></script>
      
    

    
    
      
      
      
      
      
      
      
    

    
    <script src="/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js" type="module"></script>
    

    
    
    
    <script id="page-data" type="application/json">{"use_headroom":false}</script>

    
    
    
    
    
    
    
    
    
    
    <script src="/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js"></script>

    
    
    
    
    
    
    <script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>


    

    
    
    <script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    <script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>

    


</body>
</html>
