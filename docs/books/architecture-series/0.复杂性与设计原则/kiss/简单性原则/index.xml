<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>简单性原则 | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/</link><atom:link href="https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/index.xml" rel="self" type="application/rss+xml"/><description>简单性原则</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>简单性原则</title><link>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/</link></image><item><title>案例：FitNess</title><link>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/%E6%A1%88%E4%BE%8Bfitness/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/%E6%A1%88%E4%BE%8Bfitness/</guid><description>&lt;h1 id="fitnesse-实例">FitNesse 实例&lt;/h1>
&lt;p>这段代码案例来自 Robert Martin 的著作《代码整洁之道》。Robert Martin 在书中给出了对源代码的三个重构版本，这三个版本的演化恰好可以帮助我们理解简单设计原则。重构前的代码初始版本是定义在 HtmlUtil 类中的一个长函数：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">testableHtml&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">wikiPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWikiPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuffer&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">suiteSetupPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_SETUP_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">suiteSetupPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">pagePath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">suiteSetupPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">pagePathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n!include -setup .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">setupPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;SetUp&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">setupPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">setupPath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">setupPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">setupPathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">setupPath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n!include -setup .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">setupPathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContent&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">teardownPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;TearDown&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">teardownPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">tearDownPath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">teardownPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">tearDownPathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tearDownPath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;!include -teardown .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tearDownPathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">suiteTeardownPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_TEARDOWN_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">suiteTeardownPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">pagePath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">suiteTeardownPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">pagePathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n!include -teardown .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>假定这一个函数已经通过了测试，按照简单设计的评判步骤，我们需要检查代码是否存在重复。显然，在上述代码的 6~13 行、15~22 行、26~34 行以及 36~43 行四个地方都发现了重复或相似的代码。这些代码的执行步骤像一套模板：&lt;/p>
&lt;ul>
&lt;li>获取 Page&lt;/li>
&lt;li>若 Page 不为 null，则获取路径&lt;/li>
&lt;li>解析路径名称&lt;/li>
&lt;li>添加到输出结果中&lt;/li>
&lt;/ul>
&lt;p>这套模板的差异部分可以通过参数差异化完成，故而可以提取方法：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WikiPage&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">pageName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">suiteSetupPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">suiteSetupPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">pagePath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">suiteSetupPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">pagePathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buildIncludeDirective&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">pagePathName&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">buildIncludeDirective&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">pagePathName&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n!include &amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sectionName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34; .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在提取了 includePage()方法后，就可以消除四段几乎完全相似的重复代码。重构后的长函数为：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">testableHtml&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">wikiPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWikiPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuffer&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">wikiPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_SETUP_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-setup&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">wikiPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;SetUp&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-setup&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContent&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">wikiPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;TearDown&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-teardown&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">wikiPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_TEARDOWN_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-teardown&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从重复性角度看，以上代码已经去掉了重复。当然，也可以将 pageData.hasAttribute(&amp;ldquo;Test&amp;rdquo;)视为重复，因为该表达式在第 5 行和第 12 行都出现过，表达式用到的常量&amp;quot;Test&amp;quot;也是重复。不过，你若认为这是从代码可读性角度对其重构，也未尝不可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">isTestPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>若遵循信息专家模式，isTestPage()方法应该分配给 PageData 类，通过移动方法，转移到 PageData 类后，将其改变为实例方法：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">PageData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">isTestPage&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重构后的 testableHtml()方法的可读性仍有不足之处，例如方法的名称，buffer 变量名都没有清晰表达设计意图，对 Test 和 Suite 的判断增加了条件分支，给代码阅读制造了障碍。由于 includePage()方法是一个通用方法，未能清晰表达其意图，且传递的参数同样干扰了阅读，应该将各个调用分别封装为表达业务含义的方法，例如定义为 includeSetupPage()。当页面并非测试页面时，pageData 的内容无需重新设置，可以直接通过 getHtml()方法返回。因此，添加页面内容的第 11 行代码还可以放到 isTestPage() 分支中，让逻辑变得更加紧凑：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">renderPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isTestPage&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">testPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWikiPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">newPageContent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuffer&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSuiteSetupPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSetupPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePageContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeTeardownPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSuiteTeardownPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>无论是避免重复，还是清晰表达意图，这个版本的代码都要远胜于最初的版本。Robert Martin 在《代码整洁之道》中也给出了他重构的第一个版本：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">renderPageWithSetupsAndTeardowns&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">isTestPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAttribute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Test&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isTestPage&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">testPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWikiPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">newPageContent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuffer&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSetupPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getContent&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeTeardownPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newPageContent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>对比我的版本和 Robert Martin 的版本，我认为 Robert Martin 的当前版本仍有以下不足之处：&lt;/p>
&lt;ul>
&lt;li>方法名称过长，暴露了实现细节&lt;/li>
&lt;li>isTestPage 变量不如 isTestPage()方法的封装性好&lt;/li>
&lt;li>方法体缺少分段，不同的意图混淆在了一起&lt;/li>
&lt;/ul>
&lt;p>最关键的不足之处在于第 7 行代码。对比第 7 行和第 6、8 两行代码，虽然都是一行代码，但其表达的意图却有风马牛不相及的违和感。这是因为第 7 行代码实际暴露了将页面内容追加到 newPageContent 的实现细节，第 6 行和第 8 行代码却隐藏了这一实现细节。这三行代码没有处于同一个抽象层次，违背了“单一抽象层次原则（SLAP）”。Robert Martin 在这个版本基础上，继续精进，给出了重构后的第二个版本：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">renderPageWithSetupsAndTeardowns&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isTestPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSetupAndTeardownPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>该版本的方法仍然定义在 HtmlUtil 工具类中。对比 Robert Martin 的两个重构版本，后一版本的主方法变得更加简单了，方法体只有短短的三行代码。虽然方法变得更简短，但提取出来的 includeSetupAndTeardownPages()方法却增加了不必要的抽象层次。&lt;/p>
&lt;h1 id="有限封装">有限封装&lt;/h1>
&lt;p>封装需要有度，引入太多的层次反而会干扰阅读。尤其是方法，Java 或大多数语言都不提供“方法嵌套方法”的层次结构（Scala 支持这一语法特性）。如果为一个方法的不同业务层次提取了太多方法，在逻辑上，它存在递进的嵌套关系，在物理上，却是一个扁平的结构。阅读这样的代码会造成不停的跳转，不够直接。正如 Grady Booch 所述：“整洁的代码从不隐藏设计者的意图，充满了干净利落的抽象和直截了当的控制语句。”干净利落，直截了当，可以破除对过度细粒度方法的迷信！与其封装一个用超长名称才能表达其意图的 includeSetupAndTeardownPages()方法，不如直接“敞开”相同层次的代码细节，如：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">includeSuiteSetupPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">includeSetupPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">includePageContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">includeTeardownPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">includeSuiteTeardownPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">testPage&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">includeSuiteSetup&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这五行代码不正是直截了当地表达了包含的页面结构吗？因此，我觉得 Robert Martin 提取出来的 includeSetupAndTeardownPages()方法违背了简单设计的第四条原则，即增加了不必要的软件元素。事实上，如果一个方法的名称包含了 and，就说明该方法可能违背了“一个方法只做一件事情”的基本原则。&lt;/p>
&lt;p>我并不反对定义细粒度方法，相反我很欣赏合理的细粒度方法，如前提取的 includePageContent()方法。一个庞大的方法往往缺少内聚性，不利于重用，但什么才是方法的合适粒度呢？不同的公司有着不同的方法行限制，有的是 200 行，有的是 50 行，有的甚至约束到 5 行。最关键的不是限制代码行，而在于一个方法只能做一件事。&lt;/p>
&lt;p>若发现一个主方法过长，可通过提取方法使它变短。当提取方法的逻辑层次嵌套太多，彼此的职责又高内聚时，就需要考虑将这个主方法和提取出来的方法一起委派到一个专门的类。此外，通过 includeSetupPage()等方法传递的共同参数，也说明了这些方法相较于其他方法而言，要更加内聚。&lt;/p>
&lt;p>由此可知，testableHtml()方法的逻辑提供了一个相对独立的职责，不应该将其实现逻辑放在 HtmlUtil 工具类，而应按照其意图独立为一个类 TestPageIncluder。一旦提取为类，还可以将方法共同传递的参数转换为这个新类的字段，从而减少方法之间传递的参数。重构后的代码为：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">TestPageIncluder&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">testPage&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">StringBuffer&lt;/span> &lt;span class="n">newPageContent&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">PageCrawler&lt;/span> &lt;span class="n">pageCrawler&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="nf">TestPageIncluder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">pageData&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">testPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getWikiPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageCrawler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">testPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">newPageContent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">StringBuffer&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">PageData&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TestPageIncluder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">renderPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">renderPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isTestPage&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSetupPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePageContent&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeTeardownPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">isSuite&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">updatePageContent&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHtml&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeSetupPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSuitesSetupPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSetupPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeSuitesSetupPage&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_SETUP_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-setup&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeSetupPage&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;SetUp&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-setup&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeTeardownPages&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">boolean&lt;/span> &lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">isSuite&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeSuitesTeardownPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includeTeardownPage&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeSuitesTeardownPage&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SuiteResponder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SUITE_TEARDOWN_NAME&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-teardown&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includeTeardownPage&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;TearDown&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;-teardown&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">updateContent&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pageData&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setContent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newPageContent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">includePage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">pageName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPage&lt;/span> &lt;span class="n">inheritedPage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PageCrawlerImpl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInheritedPage&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pageName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">inheritedPage&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WikiPagePath&lt;/span> &lt;span class="n">pagePath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wikiPage&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPageCrawler&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getFullPath&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">inheritedPage&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">pathName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PathParser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">render&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pagePath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buildIncludeDirective&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pathName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">buildIncludeDirective&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">pathName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">sectionName&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buffer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n!include &amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sectionName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34; .&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">pathName&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>引入 TestPageIncluder 类后，职责的层次更加清晰了，分离出来的这个类承担了组装测试页面信息的职责，HtmlUtil 类只需要调用它的静态方法 render()即可，避免了因承担太多职责而形成一个上帝类。通过提取出类和对应的方法，形成不同的抽象层次，让代码的阅读者有选择地阅读自己关心的部分，这就是清晰表达设计者意图的价值。&lt;/p>
&lt;p>对比 Robert Martin 给出的重构第二个版本以及这个提取类的最终版本，我赞成将该主方法的逻辑提取给专门的类，但不赞成在主方法中定义过度抽象层次的 includeSetupAndTeardownPages()方法。&lt;/p>
&lt;p>我曾就 Robert Martin 给出的两个版本做过调查，发现仍然有一部分人偏爱第二个更加简洁的版本。这一现象恰好说明简单设计的第三条原则属于主观判断，不如第二条原则那般具有客观的评判标准，恰如大家对美各有自己的欣赏。但我认为，一定不会有人觉得重构前的版本才是最好。即使不存在重复代码，单从可读性角度判断，也会觉得最初版本的代码不堪入目，恰如大家对美的评判标准，仍具有一定的普适性。&lt;/p>
&lt;p>Robert Martin 在《代码整洁之道》中也给出了分离职责的类 SetupTeardownIncluder。两个类的实现相差不大，只是 TestPageIncluder 类要少一些方法。除了没有 includeSetupAndTeardownPages()方法外，我也未曾定义 findInheritedPage()和 getPathNameForPage()之类的方法，也没有提取 isSuite 字段，因为我认为这些都是不必要的软件元素，它违背了简单设计的第四条原则，应当用奥卡姆的剃刀一割了之。&lt;/p>
&lt;p>当然，如果开发人员在编写代码时就能遵循简单设计原则，实则也不会写出 FitNesse 最早版本这样的代码，因为该原则与测试驱动开发相匹配，在完成一个失败测试的实现之后，应该即刻进行重构，重构时依据重用性、可读性和简单性对代码质量进行判断，自然不会出现大段的充满了重复、冗长的代码臭味。&lt;/p></description></item><item><title>案例：Istio</title><link>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/%E6%A1%88%E4%BE%8Bistio/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/architecture-series/0.%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/kiss/%E7%AE%80%E5%8D%95%E6%80%A7%E5%8E%9F%E5%88%99/%E6%A1%88%E4%BE%8Bistio/</guid><description>&lt;h1 id="案例istio-化繁为简">案例：Istio 化繁为简&lt;/h1>
&lt;p>lstio 作为 Service Mesh（服务网格）领域最具权威的控制面，基本上提到服务网格，所有人都会不自觉地想到它，从 2017 年发布第一个版本以来，lstio 就有着一个堪称非常优雅的架构设计。服务网格整个系统分为数据面和控制面，前者通过同样是开源的智能代理组件 Envoy 负责进行流量处理。而之所以称之为智能，是因为 Envoy 相对比其它代理比如 Nginx 有着更丰富的治理能力和灵活的配置方式，并且支持各种插件可用于扩展流量治理能力；而控制面在网格系统里则根据功能职能的不同，被划分成以下 5 个核心组件：&lt;/p>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://s1.ax1x.com/2020/03/16/8JFyLt.png" alt="Istio Control Plane" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Pilot：控制面的核心组件，负责对接 Envoy 数据面，也可以解析上层抽象出来的 lstio 配置，转换成数据面可以识别的 xDS 协议配置并分发到各个 Envoy；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Galley：为更好的解耦职责，它在 lstio 1.1 后由仅负责配置验证升级成了控制面的配置管理中心，可以对接不同注册中心，用于为服务网格提供配置输入能力；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Injector：在 K8s 体系里负责数据面的初始化相关工作，其中 lstio 的核心特性之一 Sidecar 自动注入正是依赖该组件；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Mixer：是 ilstio 里负责提供策略控制和遥测收集的组件，内部包含两个子组件 —— Telemetry 和 Policy，其中 Telemetry 前者负责监控相关的采集信息的数据聚合以用于对接各种监控后端，而 Policy 负责在服务相互调用过程中对请求进行策略检查，例如鉴权；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Citadel：负责服务网格里安全相关功能，为服务和用户提供认证和鉴权、管理凭据和 RBAC 等相关能力；&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>服务网格控制面各个组件被定义得清楚了然，设计之初就已经考虑到各种组件职责解耦、扩展性、安全性等，架构上看起来也非常清晰优雅。在这个架构设计中，究竟存在着什么样的难解之题，迫使 istio 开发团队在 istio 推出将近 3 年之时，决定推翻这个架构设计，重新用起“复古的”单体应用设计？&lt;/p>
&lt;p>如果有人问 lstio 在回归单体架构设计后，谁最应该开香槟庆祝的话，我可能会不假思索的说是服务网格的运维人员，如果还要再加一类人，那必须算上 lstio 的开发人员。长期以来，服务网格的运维人员饱受折磨，而这种难言之苦，估计也只有 lstio 的开发同学才能感同深受，试想一下如下场景：正常非服务网格的环境下，当用户部署的一个应用出现调用异常时，只需要简单排查下这个应用自身以及被调用服务端即可，排除网络等基础组件异常的话，问题基本上跑不出这两个应用，原因自然也很容易被定位出来；&lt;/p>
&lt;p>现在当用户的应用接入服务网格后，众所周知，在服务网格里的调用模型应该是如下图所示的：&lt;/p>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://s1.ax1x.com/2020/03/16/8JFHe0.md.png" alt="Istio 调用模型" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;p>此时，如果业务出现调用异常，由于接入服务网格，问题处理人员要确认 lstio 系统是否正常工作，还记得之前介绍过的控制面组件吗，首先需要检查 pilot 是否正常工作，配置是否能下发到 sidecar，然后可能还要检查 galley 组件是否正常同步到服务实例信息，也有可能是 sidecar 注入问题，还需要检查 injector 组件是否正常工作…… 这还只是控制面的排查，涉及到数据面还可能需要排查 Envoy 日志等，不过这不是这次关注的点，暂且先不展开介绍。lstio 控制面的各个组件异常都可能会导致数据面在发起请求调用时出现问题，而控制面组件越多，意味着在排查问题的时候要检查的故障点越多，当然过多的组件设计导致部署难度会增加这点也是毋庸置疑。&lt;/p>
&lt;p>在这这份公开的设计文档里，作者一开始便非常明确地提出 istiod 的设计目标：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>降低安装复杂度&lt;/strong>。单一的二进制文件在安装部署时将会更加简单；&lt;/li>
&lt;li>&lt;strong>降低配置复杂度&lt;/strong>。之前的很大一部分配置文件是用于编排控制面组件，而单体化设计后这部分配置可以被移除，而且新版本的 Istiod 在配置上可能更精简，只需保留一个 mesh.yaml 文件，并且能提供最佳实践配置；&lt;/li>
&lt;li>&lt;strong>增加控制面可运维性&lt;/strong>。通过单体设计后的控制面在类似于金丝雀发布的多控制面场景里显得更加简单；不同的工作负载可以通过 namespace 或者 pod 上的标签设置（也可以是组合匹配）来选择对接不同的控制平面；&lt;/li>
&lt;li>&lt;strong>提高问题诊断能力&lt;/strong>。单个控制面组件意味着出了问题后无需在不同的组件间切换来切换去，排查各种问题，显然这有助于提升问题排查效率；&lt;/li>
&lt;li>&lt;strong>提高效率和响应速度&lt;/strong>。再也不用在各个组件间通过远程调用来传递数据，而且原本不同组件间需要共享的数据，现在也可以安全被共享，而且也会一定程度上加快控制面的启动速度；&lt;/li>
&lt;li>&lt;strong>消除不必要的耦合&lt;/strong>。通过把 Envoy 的启动配置生成移到控制面可以避免 pilot agent 的访问权限问题。（这个设计目标存在争议，有人提出 Envoy 的启动配置跟 pilot 或者 galley 没有直接关系应该单独出文档介绍，也有人认为作者的意图是指说将 injector 组件也合并入 Istiod 组件内）。&lt;/li>
&lt;/ol>
&lt;p>&lt;a href="https://s1.ax1x.com/2020/03/16/8JkQTf.png" target="_blank" rel="noopener">Istiod Architecture&lt;/a>&lt;/p>
&lt;p>系统越简单，宕机时间越少。使用简单系统的船舶，更易于操作和理解，这使得它们易于修复，因此停机时间更少。考虑到船舶的“停机”可能是被困于千里之外，因此不停机这是一项重要的指标。&lt;/p>
&lt;p>以船舶的转向系统为例，方向舵由金属杆向左或向右推动，这些杆通过液压移动，压力由液压泵控制，泵由来自驾驶室的电子信号控制，信号由自动驾驶仪控制。不需要火箭科学家或海军架构师，就可以找到问题的原因和解决方案：&lt;/p>
&lt;ul>
&lt;li>如果自动驾驶仪出现故障，可以在驾驶室手动驾驶船舶。&lt;/li>
&lt;li>如果电子信号故障，可以前往控制室手动控制泵，并通过简单的声控电话与桥交谈。&lt;/li>
&lt;li>如果液压故障，请使用机械连接的紧急方向盘。&lt;/li>
&lt;li>如果机械连接失败，可以用链条钩在舵的两侧，然后向所需方向拖！&lt;/li>
&lt;/ul>
&lt;p>像船运这样的初创公司承受不起系统故障的停顿。销售、市场营销、网络，客户支持、招聘、产品和其他系统的不正常，可能会对业务增长造成无法弥补的损害。&lt;/p>
&lt;h2 id="为什么简单性可以减少宕机时间">为什么简单性可以减少宕机时间&lt;/h2>
&lt;ol>
&lt;li>熟练系统所需时间更少&lt;/li>
&lt;/ol>
&lt;p>如果负责系统的人员离开、掉落、被车撞了或被拉入另一个项目，则另一个人可以在不需要太多学习或培训的情况下接手。这意味着可以有更多的人可以介入故障排除和修复工作。&lt;/p>
&lt;p>例如，使用 Tableau 构建的分析仪表盘，可能比由定制脚本和 API 拼凑而成的分析仪表盘，有更多符合资格的人员来修复。谁都不想去找数据科学家或产品开发人员来修复一个条形图的小问题。&lt;/p>
&lt;ol start="2">
&lt;li>故障排除花费时间更少&lt;/li>
&lt;/ol>
&lt;p>如果一个系统中每个组件的行为与其他组件的关系易于理解，排查问题并找到损坏的组件（以及根本原因）就更加容易。&lt;/p>
&lt;p>例如，如果一家公司在其网站上有许多可下载的白皮书，并且都被封闭在一个表格中（而不是为每个一个表格），那么如果下载白皮书，则他们仅需要对一种表格和一种自动化工作流程进行故障排除。&lt;/p>
&lt;ol start="3">
&lt;li>更多替代解决方案&lt;/li>
&lt;/ol>
&lt;p>当系统的每个部分都具有明确的功能时，更容易找到替代方案。&lt;/p>
&lt;p>例如，假设有一个 Salesforce 流程，该流程使用大量自动化和第三方工具来对得分、筛选、分类和分配新的销售线索进行评分。如果出现问题，则没有明显的替代方法。一切将被搁置，直到该问题解决或被类似的复杂解决方案替代。&lt;/p>
&lt;p>现在想象一下一个销售过程，在该过程中，销售团队会被简单地通知每个新的销售线索以及相关的详细信息，让他们决定是否跟进该线索。如果 Salesforce 通知步骤失败，很容易想出其他一百种方法来将这些信息发送给销售团队：报告，Slack 通知，列表导出，手动观察，或者使用 Zapier 通过几乎任何媒介发送警报。停机时间最多只能持续几分钟。&lt;/p>
&lt;p>淘汰和替换项目是痛苦的，也具有破坏性，即使从长期看它的收益可观。许多初创公司（如轮船那样）一旦启航，就没有时间和资源进行大修。&lt;/p>
&lt;p>以下是我评估或实施新系统时遵循的三个原则：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>功能需求不能证明系统复杂的合理性。如果一个复杂的飞行控制系统导致整个机队停飞，或者像 Marketo 这样的企业营销平台导致无法进行市场营销活动，那么复杂的系统对大家有什么好处？选择易于操作的工具，而不是承诺最多功能的工具。我对初创企业的常见建议是选择 HubSpot 作为其营销平台，而不是诸如 Marketo，Eloqua 或 Pardot 之类的企业平台。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>复杂的想法导致复杂的实现。如果解释或掌握一个想法花的时间太长，那么它的实现将会很复杂，并且当不可避免地发生问题时，修复它所需时间将会很长。例如，一个新提议的销售流程需要一个小时来作展示，那将是一场噩梦，无论它看起来多么强大。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>先考虑修改，再考虑堆砌。当出现新需求时，常规的做法是在已有系统上堆砌新功能。但是，可以尝试看下修改原有系统的核心是否可以满足新需求。与前文提到 Marketo 到 HubSpot 的迁移方案，短期可能会导致更长的（计划内）停机时间，但长期来看（计划外）停机时间会更少。&lt;/p>
&lt;/li>
&lt;/ul></description></item></channel></rss>