<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
    <meta name="google-site-verification" content="google69a5cccb61297807" />
    <meta name="baidu-site-verification" content="cqmZHEleVh" />
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="﻿在笔者之前关于RARF的描述中，曾提及基于 MVC 风格的业务模块代码架构中存在的一些问题。彼时笔者推崇的是基于 URFP 的链式逻辑组织，换言之，一个完整的业务逻辑有数个 ResourceHandler 链接完成。但是在实践中这种方式并不是适用于" />

  
  <link rel="alternate" hreflang="zh" href="https://ng-tech.icu/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/%E7%B1%BB-redux-%E7%9A%84%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">
    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', "G-40NYXJ8823");
</script>


  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://ng-tech.icu/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/%E7%B1%BB-redux-%E7%9A%84%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@wx-chevalier" />
    <meta property="twitter:creator" content="@wx-chevalier" />
  
  <meta property="og:site_name" content="Next-gen Tech Edu" />
  <meta property="og:url" content="https://ng-tech.icu/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/%E7%B1%BB-redux-%E7%9A%84%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" />
  <meta property="og:title" content="类 Redux 的代码组织 | Next-gen Tech Edu" />
  <meta property="og:description" content="﻿在笔者之前关于RARF的描述中，曾提及基于 MVC 风格的业务模块代码架构中存在的一些问题。彼时笔者推崇的是基于 URFP 的链式逻辑组织，换言之，一个完整的业务逻辑有数个 ResourceHandler 链接完成。但是在实践中这种方式并不是适用于" /><meta property="og:image" content="https://ng-tech.icu/media/sharing.png" />
    <meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
    
  

  



  

  

  





  <title>类 Redux 的代码组织 | Next-gen Tech Edu</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="66adbee994e9b8d6752d4d5e043a474d" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">Next-gen Tech Edu</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">Next-gen Tech Edu</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/books-gallery"><span>笔记（万篇）</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#knowledge-map"><span>知识图谱</span></a>
          </li>

          
          

          
          <style>
            .dropdown-item{
              display: inline-flex;
            }
          </style>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>实验室</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/galaxy-home/gh-craft"><span>Craft 方块世界</span></a>
              
                <a class="dropdown-item" href="/galaxy-home/glossary-cards"><span>3D 知识卡牌</span></a>
              
            </div>
          </li>

          
          

          
          <style>
            .dropdown-item{
              display: inline-flex;
            }
          </style>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>其他阅读渠道</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="https://zhuanlan.zhihu.com/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png"></img><span>知乎</span></a>
              
                <a class="dropdown-item" href="https://segmentfault.com/blog/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png"></img><span>SegmentFault</span></a>
              
                <a class="dropdown-item" href="https://zhuanlan.zhihu.com/wxyyxc1992"><img style="width:16px;height:16px;display:inline-block;margin-right:8px" src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png"></img><span>掘金</span></a>
              
            </div>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link" href="https://github.com/wx-chevalier" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        
        
        <div></div>
        
        <style>
        @media only screen and (max-width: 600px) {
          .jimmysong-template {
            display: none!important;
          }
        }
        </style>
        
        <li class="jimmysong-template" style="color: white;font-size: 12px;">
          <a href="https://jimmysong.io" style="color: white">By Jimmy Song's Template</a>
        </li>
      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">
<div class="container-xl docs">
  <div class="row flex-xl-nowrap">
    <div class="docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
          RARF
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">搜索...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      <ul class="nav docs-sidenav">
        <li style="display: inline-flex">
          <a style="cursor: pointer;" onclick="window.history.back()">
            <i class="fas fa-arrow-left pr-1"></i>
            Back
          </a>
          <span>|</span>
          <a href="/books/">
            <i class="fa-solid fa-house" style="margin-right: 4px"></i>
            Books
          </a>
        </li>
      </ul>

      
      
        
          
        
      



  
    
    
    
    
      
    
    

    
    
    
    
    
    <div class="docs-toc-item has-child">
    <div class="parent-node d-flex justify-content-between" onClick="Collapse(&#34;caret-id5e2187d5787da536d799038ebc6c952a&#34;)" href="#id5e2187d5787da536d799038ebc6c952a" aria-expanded="false" aria-controls="id5e2187d5787da536d799038ebc6c952a" aria-hidden="false" data-toggle="collapse">
    
    <a class="d-inline docs-toc-link " href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/">UDLMA</a>
    <a class="nav-toogle d-inline level" aria-hidden="false" data-toggle="collapse" href="#id5e2187d5787da536d799038ebc6c952a" aria-expanded="false" aria-controls="id5e2187d5787da536d799038ebc6c952a">
    
    <i class="fa-solid fa-angle-down" id="caret-id5e2187d5787da536d799038ebc6c952a"></i>
    
    </a>
    
    </div>
    
      
      <ul class="nav docs-sidenav collapse  show " id="id5e2187d5787da536d799038ebc6c952a">
      



  
    
    
    
    
      
    
    

    
    
    
    
    
    <div class="docs-toc-item has-child">
    <div class="parent-node d-flex justify-content-between" onClick="Collapse(&#34;caret-idff0f83069a52a6b189d09d4a950e635f&#34;)" href="#idff0f83069a52a6b189d09d4a950e635f" aria-expanded="false" aria-controls="idff0f83069a52a6b189d09d4a950e635f" aria-hidden="false" data-toggle="collapse">
    
    <a class="d-inline docs-toc-link " href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/">RARF</a>
    <a class="nav-toogle d-inline level" aria-hidden="false" data-toggle="collapse" href="#idff0f83069a52a6b189d09d4a950e635f" aria-expanded="false" aria-controls="idff0f83069a52a6b189d09d4a950e635f">
    
    <i class="fa-solid fa-angle-down" id="caret-idff0f83069a52a6b189d09d4a950e635f"></i>
    
    </a>
    
    </div>
    
      
      <ul class="nav docs-sidenav collapse  show " id="idff0f83069a52a6b189d09d4a950e635f">
      



  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/aarf/">AARF</a></li>




  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/aarf.en/">AARF.en</a></li>




  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/rarf/">RARF</a></li>




  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/rarf.en/">RARF.en</a></li>




  <li class="child level active"><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/%E7%B1%BB-redux-%E7%9A%84%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/">类 Redux 的代码组织</a></li>

      
        </ul>
      
    

    
      </div>
    




  
    
    
    
    
      
    
    

    
    
    
    <div class="docs-toc-item has-child">
    <div class="parent-node d-flex justify-content-between" onClick="Collapse(&#34;caret-id09bba24eb42538cc1ce673840d1a2303&#34;)" href="#id09bba24eb42538cc1ce673840d1a2303" aria-expanded="false" aria-controls="id09bba24eb42538cc1ce673840d1a2303" aria-hidden="false" data-toggle="collapse">
    
    <a class="d-inline docs-toc-link " href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/%E6%89%A9%E5%B1%95/">扩展</a>
    <a class="nav-toogle d-inline level" aria-hidden="false" data-toggle="collapse" href="#id09bba24eb42538cc1ce673840d1a2303" aria-expanded="false" aria-controls="id09bba24eb42538cc1ce673840d1a2303">
    
        <i class="fa-solid fa-angle-right" id="caret-id09bba24eb42538cc1ce673840d1a2303"></i>
    
    </a>
    
    </div>
    
      
      <ul class="nav docs-sidenav collapse  " id="id09bba24eb42538cc1ce673840d1a2303">
      



  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/%E6%89%A9%E5%B1%95/%E5%8F%8D%E5%BA%94%E5%BC%8F/">反应式</a></li>




  <li class="child level "><a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/%E6%89%A9%E5%B1%95/%E6%89%A9%E5%B1%95%E7%82%B9/">扩展点</a></li>

      
        </ul>
      
    

    
      </div>
    

      
        </ul>
      
    

    
      </div>
    

    
  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      
     
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">目录</a></li>
      </ul>
     

      <nav id="TableOfContents">
  <ul>
    <li><a href="#清晰的业务代码逻辑">清晰的业务代码逻辑</a></li>
    <li><a href="#全局状态与局部状态的分割">全局状态与局部状态的分割</a></li>
    <li><a href="#可回溯性">可回溯性</a></li>
    <li><a href="#可容错性">可容错性</a></li>
    <li><a href="#并发编程与异步实现">并发编程与异步实现</a></li>
  </ul>

  <ul>
    <li><a href="#context">Context</a></li>
    <li><a href="#step">Step</a></li>
    <li><a href="#uniresourcebag">UniResourceBag</a></li>
    <li><a href="#reducer--action">Reducer &amp; Action</a>
      <ul>
        <li><a href="#requesthandler对于请求数据进行预处理">RequestHandler:对于请求数据进行预处理</a></li>
        <li><a href="#responsehandler对于输出数据进行处理">ResponseHandler:对于输出数据进行处理</a></li>
      </ul>
    </li>
  </ul>
</nav>

      
<div class="subscribe-module col-24 mt-1">
    <img src="https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png" alt="image" title="王下邀月熊的微信公众号"/>
</div>



    </div>
    

    <main class="py-md-3 pl-md-3 docs-content col-xl-8" role="main">

      <article class="article">

          

          <h1>类 Redux 的代码组织</h1>

          <div class="article-style">
            <p>﻿在笔者之前关于<a href="https://segmentfault.com/a/1190000004600730" target="_blank" rel="noopener">RARF</a>的描述中，曾提及基于 MVC 风格的业务模块代码架构中存在的一些问题。彼时笔者推崇的是基于 URFP 的链式逻辑组织，换言之，一个完整的业务逻辑有数个 ResourceHandler 链接完成。但是在实践中这种方式并不是适用于全部的情况，很多时候，从一个正常的思维角度来说，我们还是习惯于去写<strong>面条式</strong>的代码，即在一个 Controller 中通过调用多个 Service 进行一条业务逻辑线的处理，本文笔者即是在编写这种面条式的逻辑代码的前提下，自己思索的一些实践。</p>
<blockquote>
<p>笔者并没有评估过本文这种实现所引起的性能损耗，大概是因为 JVM 调试分析的能力太渣了吧。另一方面，本文很有可能矫枉过正，所以权当一乐。</p>
</blockquote>
<h1 id="overview">Overview</h1>
<p>为了能有一个大概的印象，我们以一个简单的登录注册逻辑作为示范，整个流程中只有两条主要的逻辑线，然后我们直接看最终的 Controller 的写法：</p>
<pre tabindex="0"><code>@RequestMapping(&#34;/login/{verifyCode}&#34;)
String login(HttpServletRequest request, @PathVariable(&#34;verifyCode&#34;) String verifyCode) {

    //初始化上下文
    SyncContext syncContext = new SyncContext();

    syncContext

            //判断用户提交的信息是否有效
            .requestHandler((uniResourceBag, action) -&gt; {


                JSONObject requestData = UniResourceBag.parseRequestData(request, &#34;username&#34;, &#34;password&#34;);

                return new Action(&#34;RequestDataReady&#34;)
                        .addActionData(&#34;username&#34;, requestData.getString(&#34;username&#34;))
                        .addActionData(&#34;password&#34;, requestData.getString(&#34;password&#34;));

            })

            .step(&#34;请求处理&#34;)

            .reducer(&#34;判断用户是否存在&#34;, (uniResourceBag, action) -&gt; {

                //判断接收到的类型是否为当前需要处理的类型,如果不是则忽略
                if (!action.isType(&#34;RequestDataReady&#34;)) {
                    return new Action();
                }

                String username = (String) action.getActionDataOrDefault(&#34;username&#34;);

                String password = (String) action.getActionDataOrDefault(&#34;password&#34;);

                //如果用户名为chevalier,则认为是存在的
                if (username.equals(&#34;chevalier&#34;)) {

                    return new Action(&#34;doLogin&#34;).addActionData(&#34;username&#34;, username).addActionData(&#34;password&#34;, password);

                } else if (username.equals(&#34;error&#34;)) {

                    throw new NullPointerException(&#34;error&#34;);

                } else {
                    //否则创建新用户
                    return new Action(&#34;doRegister&#34;).addActionData(&#34;username&#34;, username).addActionData(&#34;password&#34;, password);
                }

            })

            .step(&#34;执行登录操作或者创建新用户&#34;)

            .reducer(&#34;对于已存在用户进行登录操作,返回user_token&#34;, (uniResourceBag, action) -&gt; {

                if (!action.isType(&#34;doLogin&#34;)) {
                    return new Action();
                }

                String username = (String) action.getActionDataOrDefault(&#34;username&#34;);

                String password = (String) action.getActionDataOrDefault(&#34;password&#34;);

                //将username+password连接作为user_token登录
                uniResourceBag.setRequestDataWhenSuccess(&#34;user_token&#34;, UUID.randomUUID());

                return new Action(&#34;Complete&#34;);
            })

            .reducer(&#34;对于新用户判断用户名是否存在,返回创建好的信息与user_token&#34;, (uniResourceBag, action) -&gt; {

                if (!action.isType(&#34;doRegister&#34;)) {
                    return new Action();
                }

                //返回用户名,用户密码,创建时间和用户Token
                String username = (String) action.getActionDataOrDefault(&#34;username&#34;);

                String password = (String) action.getActionDataOrDefault(&#34;password&#34;);

                //将username+password连接作为user_token登录
                uniResourceBag.setRequestDataWhenSuccess(
                        &#34;username&#34;, username,
                        &#34;password&#34;, password,
                        &#34;create_time&#34;, Instant.now().toEpochMilli(),
                        &#34;user_token&#34;, UUID.randomUUID());

                return new Action(&#34;Complete&#34;);
            })

            .responseHandler((uniResourceBag, action) -&gt; {

                //进行最后的处理

                return new Action();
            });


    return syncContext
            .getUniResourceBag()
            .getResponseString();
}
</code></pre><p>上面就是完成该流程的整个的代码，可以看出整个流程由 step 划分为了数个层次，这也是借鉴了软件设计中的分层模型，一般来说，每次请求只会针对一条逻辑线，即是每一个 Step 中只有一个 Reducer 会被调用。同一个 Step 中的不同的 Reducer 往往之间是不同的条件选择，而不同 Step 之间只会用 Action 进行沟通。但是整个流程还是以面条式的代码实现，方便理解。我们再看下整个的请求与响应效果：
(1)正常登录请求：login/1?requestData={&ldquo;username&rdquo;:&ldquo;chevalier&rdquo;,&ldquo;password&rdquo;:123}</p>
<pre tabindex="0"><code>
      {    &#34;code&#34;: 0,    &#34;subCode&#34;: 0,    &#34;runtimeLog&#34;:    {        &#34;Context Uptime&#34;: 2,        &#34;steps&#34;:        [            {                &#34;actualReducerDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepId&#34;: 0,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;RequestDataReady&#34;,                    &#34;actionData&#34;:                    {                        &#34;password&#34;: &#34;123&#34;,                        &#34;username&#34;: &#34;chevalier&#34;                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;2608550a-6550-40da-84aa-a6a5b68bb93d&#34;            },            {                &#34;actualReducerDesc&#34;: &#34;判断用户是否存在&#34;,                &#34;stepDesc&#34;: &#34;请求处理&#34;,                &#34;stepId&#34;: 1,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;doLogin&#34;,                    &#34;actionData&#34;:                    {                        &#34;password&#34;: &#34;123&#34;,                        &#34;username&#34;: &#34;chevalier&#34;                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;92277976-bc24-4f69-b286-a4c95be993ac&#34;            },            {                &#34;actualReducerDesc&#34;: &#34;对于已存在用户进行登录操作,返回user_token&#34;,                &#34;stepDesc&#34;: &#34;执行登录操作或者创建新用户&#34;,                &#34;stepId&#34;: 2,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;Complete&#34;,                    &#34;actionData&#34;:                    {                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;f21b1a80-9b86-49d7-9751-5bdc6d90c355&#34;            }        ]    },    &#34;user_token&#34;: &#34;499206a2-0130-484b-82e0-2b822c3b8dfa&#34;,    &#34;desc&#34;: &#34;Success&#34;
}
</code></pre><p>(2)正常注册请求：login/1?requestData={&ldquo;username&rdquo;:&ldquo;123&rdquo;,&ldquo;password&rdquo;:123}</p>
<pre tabindex="0"><code>
      {    &#34;password&#34;: &#34;123&#34;,    &#34;code&#34;: 0,    &#34;create_time&#34;: 1461944838909,    &#34;subCode&#34;: 0,    &#34;runtimeLog&#34;:    {        &#34;Context Uptime&#34;: 0,        &#34;steps&#34;:        [            {                &#34;actualReducerDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepId&#34;: 0,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;RequestDataReady&#34;,                    &#34;actionData&#34;:                    {                        &#34;password&#34;: &#34;123&#34;,                        &#34;username&#34;: &#34;123&#34;                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;c3e3040d-6ff4-41a7-b911-dbc31de6c6dd&#34;            },            {                &#34;actualReducerDesc&#34;: &#34;判断用户是否存在&#34;,                &#34;stepDesc&#34;: &#34;请求处理&#34;,                &#34;stepId&#34;: 1,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;doRegister&#34;,                    &#34;actionData&#34;:                    {                        &#34;password&#34;: &#34;123&#34;,                        &#34;username&#34;: &#34;123&#34;                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;a5ea22dd-41c4-46bc-9d14-f60c8f6a737d&#34;            },            {                &#34;actualReducerDesc&#34;: &#34;对于新用户判断用户名是否存在,返回创建好的信息与user_token&#34;,                &#34;stepDesc&#34;: &#34;执行登录操作或者创建新用户&#34;,                &#34;stepId&#34;: 2,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;Complete&#34;,                    &#34;actionData&#34;:                    {                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;eb06837e-03b3-4812-9c2d-ff86a4d795a0&#34;            }        ]    },    &#34;user_token&#34;: &#34;6866cf13-ee06-4333-831a-dde0f2114764&#34;,    &#34;username&#34;: &#34;123&#34;,    &#34;desc&#34;: &#34;Success&#34;}
</code></pre><p>(3)我在随机一个地方抛出了一个异常：</p>
<pre tabindex="0"><code>
      {    &#34;code&#34;: -1008,    &#34;runtimeLog&#34;:    {        &#34;Context Uptime&#34;: 5,        &#34;steps&#34;:        [            {                &#34;actualReducerDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepDesc&#34;: &#34;RequestHandler&#34;,                &#34;stepId&#34;: 0,                &#34;actualReducerAction&#34;:                {                    &#34;actionType&#34;: &#34;RequestDataReady&#34;,                    &#34;actionData&#34;:                    {                        &#34;password&#34;: &#34;123&#34;,                        &#34;username&#34;: &#34;error&#34;                    }                },                &#34;stepRunTime&#34;: 0,                &#34;actualReducerUUID&#34;: &#34;50cb7b43-cc09-4491-8650-3294903fd6e6&#34;            },            {                &#34;stepDesc&#34;: &#34;请求处理&#34;,                &#34;stepId&#34;: 1,                &#34;stepRunTime&#34;: -1461944917734            },            {                &#34;stepDesc&#34;: &#34;执行登录操作或者创建新用户&#34;,                &#34;stepId&#34;: 2,                &#34;stepRunTime&#34;: 0            }        ]    },    &#34;stackTrace&#34;: &#34;error
wx.controller.user.LoginController.lambda$login$13(LoginController.java:67)
wx.controller.user.LoginController$$Lambda$215/1765146717.doWork(Unknown Source)
wx.rarf.context.SyncContext.lambda$null$21(SyncContext.java:304)
wx.rarf.context.SyncContext$$Lambda$220/1322867488.call(Unknown Source)
rx.Observable.unsafeSubscribe(Observable.java:7507)
rx.internal.operators.OperatorMerge$MergeSubscriber.handleNewSource(OperatorMerge.java:215)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:185)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:120)
rx.internal.operators.OperatorMap$1.onNext(OperatorMap.java:55)
rx.internal.operators.OperatorSingle$ParentSubscriber.onCompleted(OperatorSingle.java:124)
rx.internal.operators.OperatorTake$1.onNext(OperatorTake.java:69)
rx.internal.operators.OperatorMerge$InnerSubscriber.emit(OperatorMerge.java:676)
rx.internal.operators.OperatorMerge$InnerSubscriber.onNext(OperatorMerge.java:586)
wx.rarf.context.SyncContext.lambda$requestHandler$18(SyncContext.java:93)
wx.rarf.context.SyncContext$$Lambda$214/1827551503.call(Unknown Source)
rx.Observable.unsafeSubscribe(Observable.java:7507)
rx.internal.operators.OperatorMerge$MergeSubscriber.handleNewSource(OperatorMerge.java:215)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:185)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:120)
rx.internal.operators.OnSubscribeFromIterable$IterableProducer.request(OnSubscribeFromIterable.java:98)
rx.Subscriber.setProducer(Subscriber.java:177)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:50)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:33)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable.unsafeSubscribe(Observable.java:7507)
rx.internal.operators.OperatorMerge$MergeSubscriber.handleNewSource(OperatorMerge.java:215)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:185)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:120)
rx.internal.operators.OnSubscribeFromIterable$IterableProducer.request(OnSubscribeFromIterable.java:98)
rx.Subscriber.setProducer(Subscriber.java:177)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:50)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:33)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable.unsafeSubscribe(Observable.java:7507)
rx.internal.operators.OperatorMerge$MergeSubscriber.handleNewSource(OperatorMerge.java:215)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:185)
rx.internal.operators.OperatorMerge$MergeSubscriber.onNext(OperatorMerge.java:120)
rx.internal.operators.OnSubscribeFromIterable$IterableProducer.request(OnSubscribeFromIterable.java:98)
rx.Subscriber.setProducer(Subscriber.java:177)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:50)
rx.internal.operators.OnSubscribeFromIterable.call(OnSubscribeFromIterable.java:33)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable$1.call(Observable.java:144)
rx.Observable$1.call(Observable.java:136)
rx.Observable.subscribe(Observable.java:7597)
rx.observables.BlockingObservable.blockForSingle(BlockingObservable.java:442)
rx.observables.BlockingObservable.first(BlockingObservable.java:169)
wx.rarf.context.SyncContext.responseHandler(SyncContext.java:172)
wx.controller.user.LoginController.login(LoginController.java:115)
sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
java.lang.reflect.Method.invoke(Method.java:497)
org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221)
org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136)
org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:110)
org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:817)
org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:731)
org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)
org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:959)
org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:893)
org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:968)
org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:859)
javax.servlet.http.HttpServlet.service(HttpServlet.java:687)
org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:844)
javax.servlet.http.HttpServlet.service(HttpServlet.java:790)
org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:812)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1669)
org.eclipse.jetty.websocket.server.WebSocketUpgradeFilter.doFilter(WebSocketUpgradeFilter.java:224)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.boot.actuate.autoconfigure.EndpointWebMvcAutoConfiguration$ApplicationContextHeaderFilter.doFilterInternal(EndpointWebMvcAutoConfiguration.java:237)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
wx.application.filter.SystemFilter.doFilter(SystemFilter.java:95)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.boot.actuate.trace.WebRequestTraceFilter.doFilterInternal(WebRequestTraceFilter.java:112)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:87)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:77)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.springframework.boot.actuate.autoconfigure.MetricsFilter.doFilterInternal(MetricsFilter.java:103)
org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)
org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)
org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:577)
org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:223)
org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)
org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)
org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)
org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
org.eclipse.jetty.server.Server.handle(Server.java:499)
org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:311)
org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)
org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:544)
org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)
org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)
java.lang.Thread.run(Thread.java:745)
&#34;,    &#34;desc&#34;: &#34;内部错误&#34;}
</code></pre><h1 id="features--motivation">Features &amp; Motivation</h1>
<p>首先，我们需要考虑现在的问题是什么，以及改进的目标是什么。笔者最早萌生出要做出一些改进的动因，是看到了下面这一个 Controller，因为代码过多，如果有碍阅读可以直接拉到下面看。一个 Controller 写了 600 多行，这绝不是一件令人骄傲的事情，这种代码的可读性、可维护性基本上为零。而这种代码的产生，正如笔者在<a href="https://segmentfault.com/a/1190000004600730" target="_blank" rel="noopener">RARF</a>中分析的，并不一定是因为程序猿的能力和整体代码规范的问题。下面的这个代码还算是规范的吧(笔者已经删去了很多的注释)，但是因为在一个快速演进迭代地业务系统中，我们不可避免的要以打补丁的方式来修正逻辑。但是打补丁的可能后果之一就是因为在一条业务逻辑线中的分支过多而导致 N 层的内嵌选择。最佳的方式，肯定是在系统规划之初就把这个逻辑线再细分一下，但是 PM 说好的不会改需求呢？</p>
<pre tabindex="0"><code>    @RequestMapping(&#34;doShareCreateWithAt&#34;)
    public void doShareCreateWithAt(HttpServletRequest request, PrintWriter out)
            throws Exception {
        HJSONObject rtn = new HJSONObject();

        int code = ErrorConfig.CODE_SUCCESS;
        String desc = &#34;返回成功&#34;;
        int subCode = -1;
        HJSONObject json = new HJSONObject();
        String user_id = null;
        String share_id = &#34;10&#34;;//默认的分享创建成功之后
        try {
            //鉴权：判断用户Token是否有效
            json = requestHandler(request, new String[]{&#34;user_token&#34;, &#34;share_img_path&#34;});
            String user_token = json.getString(&#34;user_token&#34;);
            user_id = userTokenServiceImpl.queryUserIdByToken(user_token);
            if (user_id == null) {
                code = ErrorConfig.CODE_1006;
                subCode = 1;
                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],用户鉴权失败&#34;;
                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                return;
            } else {
                //提取分享的基本信息
                String share_category = json.getString(&#34;share_category&#34;, &#34;0&#34;);
                String share_description = json.getString(&#34;share_description&#34;, &#34;&#34;);
                String share_img_path = json.getString(&#34;share_img_path&#34;);
                String share_city = json.getString(&#34;share_city&#34;, &#34;0&#34;);
                String share_county = json.getString(&#34;share_county&#34;, &#34;0&#34;);
                String share_lon = json.getString(&#34;share_lon&#34;, &#34;0.0&#34;);
                String share_lat = json.getString(&#34;share_lat&#34;, &#34;0.0&#34;);
                //活动IDs
                String activity_ids = json.getString(&#34;activity_ids&#34;, &#34;&#34;);
                //群组IDs
                String group_ids = json.getString(&#34;group_ids&#34;, &#34;&#34;);
                //用户IDs
                String user_ids = json.getString(&#34;user_ids&#34;, &#34;&#34;);
                String share_img_path_with_lables = json.getString(&#34;share_img_path_with_lables&#34;, &#34;&#34;);
                String share_img_path_with_pasters = json.getString(&#34;share_img_path_with_pasters&#34;, &#34;&#34;);
                String share_location = json.getString(&#34;share_location&#34;, &#34;&#34;);
                String sport_ids = json.getString(&#34;sport_ids&#34;, &#34;&#34;);
                //这个是抽出来的贴纸信息
                String share_paster_ids = &#34;&#34;;


                HashMap&lt;String, String&gt; activityMap = null;
                HashMap&lt;String, String&gt; groupMap = null;


                //检查活动的参数-Json数组-只允许@一个活动
                if (StringUtil.isBlank(activity_ids) || StringUtil.isEmpty(activity_ids)) {
                    activity_ids = null;
                } else {
                    if (!isJSONArray(activity_ids)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 2;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],activity_ids格式不符合&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        JSONArray activityIds = JSONArray.parseArray(activity_ids);
                        //获取传来的id的个数
                        int idsSize = activityIds.size();
                        if (idsSize != 1) {
                            code = ErrorConfig.CODE_1005;
                            subCode = 3;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一条分享只允许@一个活动&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                            //throw new RequestException(code, subCode,desc);
                        } else {
                            //目前只让@一个活动
                            //鉴别活动id
                            String activity_id = activityIds.getString(0);
                            String group_id = null;
                            if (StringUtil.isBlank(activity_id) || StringUtil.isEmpty(activity_id)) {
                                code = ErrorConfig.CODE_1005;
                                subCode = 4;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],activity_id有误,活动不存在&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            } else {
                                Map&lt;String, Object&gt; groupInfo = socialActivityServiceImpl.queryActivityByIdV(activity_id);
                                if (groupInfo == null) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 4;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],activity_id有误,活动不存在&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                } else {
                                    //活动存在，看看是不是官方活动？官方活动没有群：group_id为空
                                    if (groupInfo.get(&#34;group_id&#34;) != null)
                                        group_id = groupInfo.get(&#34;group_id&#34;).toString();
                                    activityMap = new HashMap&lt;String, String&gt;();
                                    activityMap.put(&#34;group_id&#34;, null);//默认放个null进去
                                    //查看用户是否已经参加了该活动：1-已参加、-1-未参加、0-已退出
                                    String attendState = socialActivityServiceImpl.queryUserAttendStateV(user_id, activity_id);
                                    if (!attendState.equals(&#34;1&#34;)) {
                                        activityMap.put(&#34;hasAttend&#34;, &#34;0&#34;);
                                    } else {
                                        activityMap.put(&#34;hasAttend&#34;, &#34;1&#34;);
                                    }
                                    if (StringUtil.isBlank(group_id) || StringUtil.isEmpty(group_id)) {
                                        //官方活动，参加不参加都能@，没参加的先参加
                                        //activity_ids = activity_id;
                                        activityMap.put(&#34;isOfficial&#34;, &#34;1&#34;);
                                    } else {
                                        //非官方活动，看参加没，没参加不能@
                                        //TODO-直接参加？
                                        activityMap.put(&#34;isOfficial&#34;, &#34;0&#34;);
                                        if (!attendState.equals(&#34;1&#34;)) {
                                            code = ErrorConfig.CODE_1006;
                                            subCode = 5;
                                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],非官方活动，没有参加不能@&#34;;
                                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                            return;
                                            //throw new RequestException(code, subCode,desc);
                                        } else {
                                            //参加了让@
                                            //activity_ids = activity_id;
                                            activityMap.put(&#34;group_id&#34;, group_id);
                                        }
                                    }
                                    //TODO-两个？
                                    activityMap.put(&#34;activity_id&#34;, activity_id);
                                    activityMap.put(&#34;activity_ids&#34;, activity_ids);
                                }
                            }
                        }
                    }
                }




                //检查群组的参数-Json-只允许@一个群组
                if (StringUtil.isBlank(group_ids) || StringUtil.isEmpty(group_ids)) {
                    group_ids = null;
                } else {
                    if (!isJSONArray(group_ids)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 6;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],group_ids格式不符合&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        JSONArray groupIds = JSONArray.parseArray(group_ids);
                        //获取传来的id的个数
                        int idsSize = groupIds.size();
                        if (idsSize != 1) {
                            code = ErrorConfig.CODE_1005;
                            subCode = 7;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一条分享只允许@一个群组&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                            //throw new RequestException(code, subCode,desc);
                        } else {
                            //目前只让@一个群组
                            //看看群组存在么
                            String group_id = groupIds.getString(0);
                            groupMap = new HashMap&lt;String, String&gt;();
                            if (StringUtil.isBlank(group_id) || StringUtil.isEmpty(group_id)) {
                                code = ErrorConfig.CODE_1005;
                                subCode = 8;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],group_id有误,群组不存在&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            } else {
                                //根据群组ID获取群组详情
                                Map&lt;String, String&gt; groupInfo = socialGroupServiceImpl.queryGroupInfo(group_id);
                                if (groupInfo == null) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 8;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],group_id有误，群组不存在&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                } else {
                                    //群组存在,看看参加没有
                                    boolean isJoin = socialGroupServiceImpl.queryIdByGroupAndUserIdV(group_id, user_id);
                                    if (isJoin == false) {
                                        code = ErrorConfig.CODE_1005;
                                        subCode = 9;
                                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],@了未加入的群组&#34;;
                                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                        return;
                                        //throw new RequestException(code, subCode,desc);
                                    } else {
                                        //group_ids = group_id;
                                        groupMap.put(&#34;group_ids&#34;, group_ids);//这是存的，为了不该群相册接口，还是存一个array,以后如果可以关联多个群组什么的也可以
                                        groupMap.put(&#34;group_id&#34;, group_id);//这是拿到service层做比较的，不用再从array转化一次
                                    }
                                }
                            }
                        }
                    }
                }


                //@用户
                if (StringUtil.isBlank(user_ids) || StringUtil.isEmpty(user_ids)) {
                    user_ids = null;
                } else {
                    if (!isJSONArray(user_ids)) {
                        code = ErrorConfig.CODE_1005;
                        subCode = 10;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],user_ids不符合&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        JSONArray userIds = JSONArray.parseArray(user_ids);
                        //获取传来的id的个数
                        int idsSize = userIds.size();
                        if (idsSize &lt; 1 || idsSize &gt; 3) {
                            code = ErrorConfig.CODE_1005;
                            subCode = 11;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一条分享只允许1-3个好友&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                            //throw new RequestException(code, subCode,desc);
                        } else {
                            //看看重不重复
                            Set&lt;String&gt; userIdSet = new HashSet&lt;String&gt;();
                            for (int i = 0; i &lt; idsSize; i++) {
                                userIdSet.add(userIds.getString(i));
                            }
                            if (idsSize != userIdSet.size()) {
                                code = ErrorConfig.CODE_1005;
                                subCode = 12;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一个好友只能@一次&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            }


                            //TODO-批量查询数据库
                            //看看好友存在么
                            for (int i = 0; i &lt; idsSize; i++) {
                                String userId = userIds.getString(i);
                                //存在性
                                boolean isUser = userServiceImpl.queryUserIdById(userId);
                                if (isUser == false) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 13;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],@了一个不存在的用户&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                }


                                //是否好友
                                boolean isAttention = socialFollowingServiceImpl.queryFollowingIdV(user_id, userId);
                                boolean isAttention1 = socialFollowingServiceImpl.queryFollowingIdV(userId, user_id);
                                if (isAttention == false || isAttention1 == false) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 14;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],@了一个不是好友的用户&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                }
                            }
                        }
                    }
                }


                //图片标签-&#34;share_img_path_with_lables&#34;:[{&#34;pic1_url&#34;:[]},{&#34;pic2_url&#34;:[]},{&#34;pic3_url&#34;:[]}]
                //键key:存图片的Url，值Value:存图片对应的标签
                if (!&#34;&#34;.equals(share_img_path_with_lables)) {
                    //判断是否是json格式
                    if (!isJSONArray(share_img_path_with_lables)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 15;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_lables&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    }
                    //解析share_img_path_with_lables的值，真实的图片，总共有9张图片
                    JSONArray shareImgLableArr = JSONArray.parseArray(share_img_path_with_lables);
                    int urlSize = shareImgLableArr.size();
                    if (urlSize &gt; 9) {
                        code = ErrorConfig.CODE_1005;
                        subCode = 16;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],分享不能超过9张图,检查share_img_path_with_lables&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        //遍历，看看必填的参数是不是都填了。
                        //遍历每个图片附带的标签属性
                        for (int i = 0; i &lt; urlSize; i++) {
                            String shareImgLables = shareImgLableArr.getString(i);//&#34;pic1_url&#34;:[&#34;&#34;:&#34;&#34;,&#34;&#34;:&#34;&#34;]
                            HJSONObject shareImgLablesJson = new HJSONObject(JSONObject.parseObject(shareImgLables));
                            //获取第i张图片的键key，存放的是pic_url的Url路径，所以key的size为1
                            Set&lt;String&gt; keyset = shareImgLablesJson.keySet();
                            if (keyset.size() != 1) {
                                code = ErrorConfig.CODE_1006;
                                subCode = 15;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_lables&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            } else {
                                String url = keyset.iterator().next();
                                if (!isUrl(url)) {
                                    code = ErrorConfig.CODE_1006;
                                    subCode = 15;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_lables&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                }
                                //根据键key获取对应的值value，其中存放的是图片对应的标签信息
                                String shareImgLablesStr = shareImgLablesJson.getString(url);
                                JSONArray shareImgLablesArr = JSONArray.parseArray(shareImgLablesStr);
                                int lableSize = shareImgLablesArr.size();
                                if (lableSize &gt; 6) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 17;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一张图片不能超过6个标签&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                } else {
                                    for (int j = 0; j &lt; lableSize; j++) {
                                        String shareImgLable = shareImgLablesArr.getString(j);
                                        //标签在图片上的位置，还有牌子信息必填
                                        HJSONObject shareImgLableJson = HJSONHandler(shareImgLable, new String[]{&#34;offset_x&#34;, &#34;offset_y&#34;, &#34;brand&#34;, &#34;direction&#34;});
                                        String offset_x = shareImgLableJson.getString(&#34;offset_x&#34;);
                                        try {
                                            Double.parseDouble(offset_x);
                                        } catch (Exception e) {
                                            code = ErrorConfig.CODE_1005;
                                            subCode = 18;
                                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],非法的x偏移参数&#34;;
                                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                            return;
                                            //throw new RequestException(code, subCode,desc);
                                        }


                                        String offset_y = shareImgLableJson.getString(&#34;offset_y&#34;);
                                        try {
                                            Double.parseDouble(offset_y);
                                        } catch (Exception e) {
                                            code = ErrorConfig.CODE_1005;
                                            subCode = 19;
                                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],非法的y偏移参数&#34;;
                                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                            return;
                                            //throw new RequestException(code, subCode,desc);
                                        }


                                        String direction = shareImgLableJson.getString(&#34;direction&#34;);
                                        String brand = shareImgLableJson.getString(&#34;brand&#34;);
                                        //这个需要一个brand数据表
                                        String altitude = shareImgLableJson.getString(&#34;altitude&#34;, &#34;&#34;);
                                        String number = shareImgLableJson.getString(&#34;number&#34;, &#34;&#34;);
                                        String img_label_type = shareImgLableJson.getString(&#34;img_label_type&#34;, &#34;&#34;);


                                        shareImgLableJson.clear();


                                        shareImgLableJson.put(&#34;offset_x&#34;, offset_x);
                                        shareImgLableJson.put(&#34;offset_y&#34;, offset_y);
                                        shareImgLableJson.put(&#34;brand&#34;, brand);
                                        shareImgLableJson.put(&#34;altitude&#34;, altitude);
                                        shareImgLableJson.put(&#34;number&#34;, number);
                                        shareImgLableJson.put(&#34;img_label_type&#34;, img_label_type);
                                        shareImgLableJson.put(&#34;direction&#34;, direction);


                                        shareImgLablesArr.set(j, shareImgLableJson);
                                    }
                                }
                                shareImgLablesJson.put(url, shareImgLablesArr);
                            }
                            shareImgLableArr.set(i, shareImgLablesJson);


                            share_img_path_with_lables = shareImgLableArr.toString();
                        }
                    }
                }


                //贴纸，类似标签的数据结构，&#34;share_paster_ids&#34;:[{&#34;url1&#34;:[&#34;1&#34;,&#34;2&#34;]},{&#34;url2&#34;:[&#34;1&#34;,&#34;2&#34;]}]
                if (!&#34;&#34;.equals(share_img_path_with_pasters)) {
                    //判断是否是json格式
                    if (!isJSONArray(share_img_path_with_pasters)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 20;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_pasters&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    }
                    JSONArray shareImgPasterUrlsArr = JSONArray.parseArray(share_img_path_with_pasters);
                    Set&lt;String&gt; shareImgPasterIdsSet = new HashSet&lt;String&gt;();
                    int urlSize = shareImgPasterUrlsArr.size();
                    if (urlSize &gt; 9) {
                        code = ErrorConfig.CODE_1005;
                        subCode = 21;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],分享不能超过9张图,检查share_img_path_with_pasters&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        for (int i = 0; i &lt; urlSize; i++) {
                            String shareImgPasterIdsArrStr = shareImgPasterUrlsArr.getString(i);
                            HJSONObject shareImgPasterIdsArrJson = new HJSONObject(JSONObject.parseObject(shareImgPasterIdsArrStr));
                            Set&lt;String&gt; keyset = shareImgPasterIdsArrJson.keySet();
                            if (keyset.size() != 1) {
                                code = ErrorConfig.CODE_1006;
                                subCode = 20;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_pasters&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            } else {
                                String url = keyset.iterator().next();
                                if (!isUrl(url)) {
                                    code = ErrorConfig.CODE_1006;
                                    subCode = 20;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_pasters&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                }
                                String shareImgPasterIdsStr = shareImgPasterIdsArrJson.getString(url);
                                JSONArray shareImgPasterIdsArr = JSONArray.parseArray(shareImgPasterIdsStr);
                                int idsSize = shareImgPasterIdsArr.size();
                                if (idsSize &gt; 5) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 22;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一张图不能超过5个贴纸&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                } else {
                                    for (int j = 0; j &lt; idsSize; j++) {
                                        String paster_id = shareImgPasterIdsArr.getString(j);


                                        try {
                                            int paster_id_int = Integer.parseInt(paster_id);
                                            shareImgPasterIdsSet.add(String.valueOf(paster_id_int));
                                        } catch (Exception e) {
                                            e.printStackTrace();
                                            subCode = 20;
                                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path_with_pasters&#34;;
                                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                            return;
                                            //throw new RequestException(code, subCode,desc);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }


                //运动类型 &#34;sport_ids&#34;:[&#34;1&#34;]-json-一个分享智能关联一个运动类型
                if (StringUtil.isBlank(sport_ids) || StringUtil.isEmpty(sport_ids)) {
                    sport_ids = null;
                } else {
                    if (!isJSONArray(sport_ids)) {
                        code = ErrorConfig.CODE_1005;
                        subCode = 26;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],sport_ids不符合&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        JSONArray sportIds = JSONArray.parseArray(sport_ids);
                        //获取传来的id的个数
                        int idsSize = sportIds.size();
                        if (idsSize != 1) {
                            code = ErrorConfig.CODE_1005;
                            subCode = 27;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一条分享只关联1个运动类型&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                            //throw new RequestException(code, subCode,desc);
                        } else {
                            //看看运动类型存在么
                            for (int i = 0; i &lt; idsSize; i++) {
                                String sportId = sportIds.getString(i);
                                //存在性
                                String sport_id = sportIds.getString(i);
                                try {
                                    int sport_id_i = Integer.parseInt(sport_id);
                                    Boolean is_user_sport_id_exist = userPersonServiceImpl.queryUserSportBySportId(String.valueOf(sport_id_i));
                                    if (!is_user_sport_id_exist) {
                                        throw new Exception();
                                    }
                                    sportIds.set(i, String.valueOf(sport_id_i));
                                } catch (Exception e) {
                                    code = ErrorConfig.CODE_1005;
                                    subCode = 28;
                                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],用户运动类型有误&#34;;
                                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                    return;
                                    //throw new RequestException(code, subCode,desc);
                                }
                            }


                            sport_ids = sportIds.toString();
                        }
                    }
                }


                if (!&#34;&#34;.equals(share_location)) {
                    if (StringUtil.isBlank(share_location) || StringUtil.isEmpty(share_location)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 25;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请检查share_location是否为空&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    }
                }


                if (StringUtil.isBlank(share_img_path) || StringUtil.isEmpty(share_img_path) || Integer.parseInt(share_category) &lt; 0 || Integer.parseInt(share_category) &gt; 1 || !isJSONArray(share_img_path)) {
                    code = ErrorConfig.CODE_1006;
                    subCode = 23;
                    desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path和share_category&#34;;
                    errorInfo.setErrorInfo(code, subCode, desc, request, out);
                    return;
                    //throw new RequestException(code, subCode,desc);
                } else {
                    if (isJsonEmpty(share_img_path)) {
                        code = ErrorConfig.CODE_1006;
                        subCode = 23;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数格式不符,检查share_img_path和share_category&#34;;
                        throw new RequestException(code, subCode, desc);
                    }
                    JSONArray share_img_path_json = JSONArray.parseArray(share_img_path);
                    //获取传来的id的个数
                    int idsSize = share_img_path_json.size();
                    if (idsSize &gt; 9) {
                        code = ErrorConfig.CODE_1005;
                        subCode = 29;
                        desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],一条分享最多关联9张图片&#34;;
                        errorInfo.setErrorInfo(code, subCode, desc, request, out);
                        return;
                        //throw new RequestException(code, subCode,desc);
                    } else {
                        for (int i = 0; i &lt; idsSize; i++) {
                            String url = share_img_path_json.getString(i);
                            if (!isUrl(url)) {
                                code = ErrorConfig.CODE_1005;
                                subCode = 30;
                                desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],分享图片中有不合法的url&#34;;
                                errorInfo.setErrorInfo(code, subCode, desc, request, out);
                                return;
                                //throw new RequestException(code, subCode,desc);
                            }
                        }


                        share_img_path = share_img_path_json.toString();
                    }


                    if (share_category.equals(&#34;0&#34;)) {
                        try {
                            //调用创建分享的服务,成功则返回分享的编号
                            share_id = socialShareServiceImpl.insertShareWithAt(user_id, share_category, share_description,
                                    share_img_path, share_city, share_county, share_lon, share_lat, activityMap, groupMap, user_ids,
                                    share_img_path_with_lables, share_paster_ids, share_img_path_with_pasters, share_location, sport_ids);
                        } catch (Exception e) {
                            e.printStackTrace();
                            code = ErrorConfig.CODE_1006;
                            subCode = 24;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],数据库更新失败&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                        }
                    } else if (share_category.equals(&#34;1&#34;)) {
                        //Promises的实现还没写
                        try {
                            socialShareServiceImpl.insertPromiseWithAt(user_id, share_category, share_description,
                                    share_img_path, share_city, share_county, share_lon, share_lat, activityMap, groupMap, user_ids, share_img_path_with_lables);
                        } catch (Exception e) {
                            code = ErrorConfig.CODE_1006;
                            subCode = 24;
                            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],数据库更新失败&#34;;
                            errorInfo.setErrorInfo(code, subCode, desc, request, out);
                            return;
                        }
                    }
                }
            }


        } catch (ParamException e) {
            code = ErrorConfig.CODE_1005;
            subCode = 0;
            desc = &#34;[&#34; + code + &#34;]+&#34; + &#34;[&#34; + subCode + &#34;],请求参数缺失&#34;;
            rtn.put(&#34;subCode&#34;, subCode);
            rtn.put(&#34;desc&#34;, desc);
            errorInfo.setErrorInfo(code, subCode, desc, request, out);
            return;
        }
        rtn.put(&#34;code&#34;, code);


        //Todo 添加真实的返回share_id
        rtn.put(&#34;share_id&#34;, share_id);


        request.setAttribute(&#34;user_id&#34;, user_id);


        out.print(responseHandler(rtn, request));
        out.close();
    }
</code></pre><h2 id="清晰的业务代码逻辑">清晰的业务代码逻辑</h2>
<p>一般来说，一个 Controller 是进行一个业务流程的处理，而该流程可能根据输入参数的不同、当前状态的不同导致走不同的逻辑流线。正如上文中列举的代码，正是因为存在着多个可选参数导致存在着大量的 if-else 分支。而用面条式的、瀑布流式的代码是最好的逻辑表现，但是一旦分支多了，if-else 多了之后，就变成了一团乱麻。笔者不是否认在充分的注释情况下可以完全理解原有代码，但是这样的可读性依然很差。笔者之前一直在测试中比较喜欢 BDD 方式，譬如：</p>
<pre tabindex="0"><code>  Scenario: 两数相加
    Given 我有一个计算器
    And 我向计算器输入50
    And 我向计算器输入70
    When 我点击累加
    Then 我应该看到结果120
</code></pre><p>在 OverView 部分，笔者呈现出的代码也希望能符合这个特性:</p>
<pre tabindex="0"><code>requestHandler().
step(&#34;我是本步骤的描述&#34;).
reducer(&#34;我是本步骤的第一个可能情况&#34;).
reducer(&#34;我是本步骤的第二个可能情况&#34;)
</code></pre><h2 id="全局状态与局部状态的分割">全局状态与局部状态的分割</h2>
<p>在 Redux 中，会把所有的状态放在 Store 中进行统一管理，这样就把状态变量和临时变量区分了开来，即把全局状态与局部状态分割了开来。笔者没有真实的大公司的工作经验，不过在一个可能几百行的逻辑处理中，很有可能出现大量的 a,b,c,d 这样临时的变量，然后在最后构造返回数据时，随手把之前的某个临时变量封装进去。此外，整个逻辑线的不同步骤中的局部变量可能相互干扰，可能在步骤一中定义了某个临时变量，步骤二中没用到，然后步骤三中突然拿来进行某个条件的判断，然后步骤四中再重新赋予其他用法。然后在维护的时候，大家都懵逼了。</p>
<h2 id="可回溯性">可回溯性</h2>
<p>Redux 有一个非常诱人的特性叫时空旅行，即可以回溯整个应用生命周期中的所有状态。这个特性主要是基于其状态树，可以回溯出每个操作之后的状态。笔者认为可回溯性在业务逻辑开发中的表现即是全局状态的记录与每次业务处理中的局部状态的记录。之前进行 Log 的时候，有很大的随意性，而有了一个全局状态之后，可以对于输入、输出进行统一的记录。而对于中间状态，因为划分了 Step 和不同 Step 之间统一的 Action，也可以方便的记录下来。在这种情况下，只要了解每个 Step 具体执行了哪个 Reducer，并且每个 Reducer 的输出值，可以很快定位到问题代码所在的地方。</p>
<h2 id="可容错性">可容错性</h2>
<p>上文中已经提及，因为 RARF 是记录了每个 Step 的情况，那么可以很快的定位到错误代码。此外，由于全部的代码是包裹在了 Observable 之中，那么任何的未知错误也都可以进行妥善处理，而不用担心不可回溯。</p>
<h2 id="并发编程与异步实现">并发编程与异步实现</h2>
<p>随着计算机硬件，笔者比较推崇响应式流这种异步模型，在本部分的实现中，笔者也是优先考虑了并发的易实现性。RARF 将整个业务处理逻辑分成了数个 Step，如果你发现哪个 Step 是 IO 密集型或者计算密集型，简言之，就需要耗费较长的时间，那么完全可以放到新线程中执行，而把 Main 线程流出来响应新的请求。
RxJava 这种链式调用形式的异步写法很是清晰明了，不过需要注意的是 RxJava 本身并不一定是并发地，默认情况下所有的 Observable 与 Subscriber 都是在一个线程里运行，但是可以简单的使用<code>subscribeOn</code>方法将某个 Observable 扔到子线程中运行。</p>
<h1 id="terminology">Terminology</h1>
<h2 id="context">Context</h2>
<p>Context 即对应一个业务处理流程，包含多个逻辑线。一个 Context 会被划分为输入处理、一到多个中间过程以及最后的输出处理。</p>
<h2 id="step">Step</h2>
<p>一个 Step 即是某个具体的业务处理块，一个 Step 包含一到多个 Reducer，每个 Reducer 表示该步骤可能的一个逻辑线。一般来说，一起请求中一个 Step 中只有一个 Reducer 会有效执行，即返回有效的 Action。如果某个 Step 中所有 Action 都没有执行，那么会返回一个错误代码。</p>
<h2 id="uniresourcebag">UniResourceBag</h2>
<p>资源包即是上文描述的全局状态存放的地方，包括输入、输出。</p>
<h2 id="reducer--action">Reducer &amp; Action</h2>
<p>每个 Reducer 的执行块都会返回一个 Action 对象，如果 Action 的 isValid 值为 True，表示要把该 Action 发射到下一个 Observable，否则不进行发射。每个 Reducer 首先会对上一步 Step 传入的 Action 类型进行判断，只有在是自己需要的类型的情况下才会进行执行。每个 Reducer 在有效执行后会发射有效地 Action 到下一步中。</p>
<h3 id="requesthandler对于请求数据进行预处理">RequestHandler:对于请求数据进行预处理</h3>
<p>请求方式基于 RARF 中的 URFP，即是 PathVariable 与 RequestData 混合的方式，一个典型的登录请求为：</p>
<pre tabindex="0"><code>/login/{verifyCode}?requestData={&#34;username&#34;:chevalier,&#34;password&#34;:123456}
</code></pre><h3 id="responsehandler对于输出数据进行处理">ResponseHandler:对于输出数据进行处理</h3>
<p>ResponseHandler 会对 ResourceBag 中的数据进行最终的处理校验，同时负责处理日志啊、消息推送啊等等非必须逻辑的异步实现。</p>

          </div>

          



          
          
          <div class="article-widget">
            
<div class="container-xl row post-nav">
  
  
  
  <div class="col-6 post-nav-item">
    <div class="meta-nav">上一页</div>
    <a href="/books/architecture-series/2.%E9%A3%8E%E6%A0%BC%E4%B8%8E%E6%A8%A1%E5%BC%8F/udlma/rarf/rarf.en/" rel="next">RARF.en</a>
  </div>
  
  
</div>

          </div>
          

        <div class="body-footer">
          <p>最近更新于 0001-01-01</p>

          



          


  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); 
    s.async = true;
    
    s.src = "https://ngte-website.oss-accelerate.aliyuncs.com/disqus/embed.js";
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </section>
  



          


        </div>

      </article>

      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2017-2022 NGTE all rights reserved</p>
        </div>
    </div>
  </div>

</footer>


    </main>
  </div>
</div>
<script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
<script>
  const heti = new Heti('.article');
  heti.autoSpacing();
</script>
<script type="text/javascript">
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "12adcc35-9621-4313-8262-62dc654b29d8";
  (function () {
    setTimeout(function() {
      d = document;
      s = d.createElement("script");
      s.src = "https://client.crisp.chat/l.js";
      s.async = 1;
      d.getElementsByTagName("head")[0].appendChild(s);
    }, 2500);
  })();
</script>
  </div>

  <div class="page-footer">
    
    
  </div>

      

    
    <script src="/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js"></script>

    
    
    
      

      
      

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
      

    

    
    
    

    
    
    
      
      <script id="search-hit-algolia-template" type="text/html">
        <div class="search-hit">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a>
            </div>
            <div class="article-metadata search-hit-type">{{type}}</div>
            <p class="search-hit-description">{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p>
          </div>
        </div>
      </script>
      
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js" crossorigin="anonymous"></script>
      
      
    

    
    

    
    
    
    
      
      <script id="dsq-count-scr" src="https://ngte-website.oss-accelerate.aliyuncs.com/disqus/count.js" async></script>
    

    
    
      
      
      
      
      
      
      
    

    
    <script src="/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js" type="module"></script>
    

    
    
    
    <script id="page-data" type="application/json">{"use_headroom":false}</script>

    
    
    
    
    
    
    
    
    
    
    <script src="/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js"></script>

    
    
    
    
    
    
    <script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>


    

    
    
    <script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    <script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>

    


</body>
</html>
