<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>典型案例 | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/</link><atom:link href="https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/index.xml" rel="self" type="application/rss+xml"/><description>典型案例</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>典型案例</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/</link></image><item><title>Caddy</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/caddy/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/caddy/</guid><description/></item><item><title>DokuWiki</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/dokuwiki/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/dokuwiki/</guid><description>&lt;h1 id="dokuwiki">DokuWiki&lt;/h1>
&lt;p>DokuWiki 是一个针对小公司文件需求而开发的 Wiki 引擎，用 PHP 语言开发。DokuWiki 基于文本存储，不需要数据库。使用 helm install 进行一键部署，并通过 ingress.enabled=true 和 ingress.hosts[0].name=wiki.hi-linux.com 参数启用 Ingress 特性和设置对应的主机名。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /home/k8s/charts/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ helm install --name dokuwiki --set &lt;span class="s2">&amp;#34;ingress.enabled=true,ingress.hosts[0].name=wiki.hi-linux.com,persistence.enabled=false&amp;#34;&lt;/span> dokuwiki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: DEPLOYED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RESOURCES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki wiki.hi-linux.com &lt;span class="m">80&lt;/span> &lt;span class="nv">53s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Pod&lt;span class="o">(&lt;/span>related&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki-747b45cddb-qt8l2 1/1 Running &lt;span class="m">0&lt;/span> &lt;span class="nv">53s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki Opaque &lt;span class="m">1&lt;/span> &lt;span class="nv">54s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki LoadBalancer 10.254.235.137 &amp;lt;pending&amp;gt; 80:8430/TCP,443:8848/TCP &lt;span class="nv">54s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 54s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">** Please be patient &lt;span class="k">while&lt;/span> the chart is being deployed **
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. Get the DokuWiki URL indicated on the Ingress Rule and associate it to your cluster external IP:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CLUSTER_IP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>minikube ip&lt;span class="k">)&lt;/span> &lt;span class="c1"># On Minikube. Use: `kubectl cluster-info` on others K8s clusters&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">HOSTNAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get ingress --namespace default dokuwiki-dokuwiki -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.spec.rules[0].host}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Dokuwiki URL: http://&lt;/span>&lt;span class="nv">$HOSTNAME&lt;/span>&lt;span class="s2">/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$CLUSTER_IP&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="nv">$HOSTNAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sudo tee -a /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. Login with the following credentials
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Username: user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Password: &lt;span class="k">$(&lt;/span>kubectl get secret --namespace default dokuwiki-dokuwiki -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.data.dokuwiki-password}&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 --decode&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署完成后，根据提示生成相应的登陆用户名和密码。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> Username: user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Username: user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> Password: &lt;span class="k">$(&lt;/span>kubectl get secret --namespace default dokuwiki-dokuwiki -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.data.dokuwiki-password}&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 --decode&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Password: e2GrABBkwF
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>测试从各节点的宿主机 IP 访问应用，这里我们直接使用 Curl 命令进行访问。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ curl -I http://wiki.hi-linux.com/doku.php -x 192.168.100.211:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP/1.1 &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: nginx/1.13.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed, &lt;span class="m">25&lt;/span> Jul &lt;span class="m">2018&lt;/span> 05:16:02 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-Type: text/html&lt;span class="p">;&lt;/span> &lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection: keep-alive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X-Powered-By: PHP/7.0.31
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Cookie,Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DokuWiki&lt;/span>&lt;span class="o">=&lt;/span>k2clt6f2qe472ehsq6tcmh6v20&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Expires: Thu, &lt;span class="m">19&lt;/span> Nov &lt;span class="m">1981&lt;/span> 08:52:00 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Cache-Control: no-store, no-cache, must-revalidate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pragma: no-cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DW68700bfd16c2027de7de74a5a8202a6f&lt;/span>&lt;span class="o">=&lt;/span>deleted&lt;span class="p">;&lt;/span> &lt;span class="nv">expires&lt;/span>&lt;span class="o">=&lt;/span>Thu, 01-Jan-1970 00:00:01 GMT&lt;span class="p">;&lt;/span> Max-Age&lt;span class="o">=&lt;/span>0&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X-UA-Compatible: &lt;span class="nv">IE&lt;/span>&lt;span class="o">=&lt;/span>edge,chrome&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -I http://wiki.hi-linux.com/doku.php -x 192.168.100.212:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP/1.1 &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: nginx/1.13.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed, &lt;span class="m">25&lt;/span> Jul &lt;span class="m">2018&lt;/span> 05:18:13 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-Type: text/html&lt;span class="p">;&lt;/span> &lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection: keep-alive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X-Powered-By: PHP/7.0.31
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Cookie,Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DokuWiki&lt;/span>&lt;span class="o">=&lt;/span>ork8sv8qpurteblasuq3eb3nt2&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Expires: Thu, &lt;span class="m">19&lt;/span> Nov &lt;span class="m">1981&lt;/span> 08:52:00 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Cache-Control: no-store, no-cache, must-revalidate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pragma: no-cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DW68700bfd16c2027de7de74a5a8202a6f&lt;/span>&lt;span class="o">=&lt;/span>deleted&lt;span class="p">;&lt;/span> &lt;span class="nv">expires&lt;/span>&lt;span class="o">=&lt;/span>Thu, 01-Jan-1970 00:00:01 GMT&lt;span class="p">;&lt;/span> Max-Age&lt;span class="o">=&lt;/span>0&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -I http://wiki.hi-linux.com/doku.php -x 192.168.100.213:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP/1.1 &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: nginx/1.13.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed, &lt;span class="m">25&lt;/span> Jul &lt;span class="m">2018&lt;/span> 05:18:30 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-Type: text/html&lt;span class="p">;&lt;/span> &lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection: keep-alive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X-Powered-By: PHP/7.0.31
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Cookie,Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DokuWiki&lt;/span>&lt;span class="o">=&lt;/span>6ulgtsddqq3rlo0mriavj64jc4&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Expires: Thu, &lt;span class="m">19&lt;/span> Nov &lt;span class="m">1981&lt;/span> 08:52:00 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Cache-Control: no-store, no-cache, must-revalidate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pragma: no-cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Set-Cookie: &lt;span class="nv">DW68700bfd16c2027de7de74a5a8202a6f&lt;/span>&lt;span class="o">=&lt;/span>deleted&lt;span class="p">;&lt;/span> &lt;span class="nv">expires&lt;/span>&lt;span class="o">=&lt;/span>Thu, 01-Jan-1970 00:00:01 GMT&lt;span class="p">;&lt;/span> Max-Age&lt;span class="o">=&lt;/span>0&lt;span class="p">;&lt;/span> &lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/&lt;span class="p">;&lt;/span> HttpOnly
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Curl 用法很多，你也可以使用下面方式来达到相同的效果。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ curl -H &lt;span class="s2">&amp;#34;Host:wiki.hi-linux.com&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://192.168.100.211/doku.php&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>当然你也可以在本地 hosts 文件中对 IP 和域名进行绑定后，通过浏览器访问该应用。&lt;/p></description></item><item><title>ELK</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/elk/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/elk/</guid><description/></item><item><title>MEAN</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/mean/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/mean/</guid><description>&lt;h1 id="mean">MEAN&lt;/h1>
&lt;p>MEAN 是用来构建网站和 web 应用的免费开源的 JavaScript 软件栈，该软件栈包括 MongoDB、Express.js、Angular 和 Node.js。&lt;/p>
&lt;h1 id="helm">Helm&lt;/h1>
&lt;p>首先我们下载 charts：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="links">Links&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://jimmysong.io/kubernetes-handbook/practice/helm.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/practice/helm.html&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Minio</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/minio/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/minio/</guid><description>&lt;h1 id="minio">Minio&lt;/h1>
&lt;p>Minio 是一个基于 Apache License v2.0 开源协议的对象存储服务，Minio 使用 Go 语言开发，具有良好的跨平台性，同样是一个非常轻量的服务。它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如：图片、视频、日志文件、备份数据和容器/虚拟机镜像等。&lt;/p>
&lt;p>使用 helm install 进行一键部署，并通过 ingress.enabled=true 参数启用 Ingress 特性。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ helm install --name minio --set &lt;span class="s2">&amp;#34;ingress.enabled=true,persistence.enabled=false&amp;#34;&lt;/span> minio
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: DEPLOYED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RESOURCES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio minio.hi-linux.com &lt;span class="m">80&lt;/span> &lt;span class="nv">1m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Pod&lt;span class="o">(&lt;/span>related&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio-7c7cf49d4-gqf8p 1/1 Running &lt;span class="m">0&lt;/span> &lt;span class="nv">1m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio Opaque &lt;span class="m">2&lt;/span> &lt;span class="nv">1m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/ConfigMap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio &lt;span class="m">2&lt;/span> &lt;span class="nv">1m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio ClusterIP None &amp;lt;none&amp;gt; 9000/TCP &lt;span class="nv">1m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta2/Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 1m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Minio can be accessed via port &lt;span class="m">9000&lt;/span> on the following DNS name from within your cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio-svc.default.svc.cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To access Minio from localhost, run the below commands:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. &lt;span class="nb">export&lt;/span> &lt;span class="nv">POD_NAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get pods --namespace default -l &lt;span class="s2">&amp;#34;release=minio&amp;#34;&lt;/span> -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.items[0].metadata.name}&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. kubectl port-forward &lt;span class="nv">$POD_NAME&lt;/span> &lt;span class="m">9000&lt;/span> --namespace default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Read more about port forwarding here: http://kubernetes.io/docs/user-guide/kubectl/kubectl_port-forward/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You can now access Minio server on http://localhost:9000. Follow the below steps to connect to Minio server with mc client:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. mc config host add minio-local http://localhost:9000 AKIAIOSFODNN7EXAMPLE wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY S3v4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. mc ls minio-local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Alternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署完成后，我们在本地 hosts 文件中对 IP 和域名进行绑定，并通过浏览器访问该应用。登陆用户名和密码在部署完成后的提示信息中。最后我们在 Kubernetes 上来查看下部署成功后的 Ingress 信息。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dokuwiki-dokuwiki wiki.hi-linux.com &lt;span class="m">80&lt;/span> 44m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minio minio.hi-linux.com &lt;span class="m">80&lt;/span> 50s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>MySQL</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/mysql/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/mysql/</guid><description>&lt;h1 id="mysql-部署">MySQL 部署&lt;/h1>
&lt;h1 id="persistent-volume">Persistent Volume&lt;/h1>
&lt;h1 id="chart">Chart&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">root@kube-master:# helm install --name mysql --set &lt;span class="nv">mysqlRootPassword&lt;/span>&lt;span class="o">=&lt;/span>rootpassword,mysqlUser&lt;span class="o">=&lt;/span>mysql,mysqlPassword&lt;span class="o">=&lt;/span>my-password,mysqlDatabase&lt;span class="o">=&lt;/span>mydatabase,persistence.existingClaim&lt;span class="o">=&lt;/span>mysql-pvc stable/mysql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: mysql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Thu Jan &lt;span class="m">10&lt;/span> 16:18:31 &lt;span class="m">2019&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: DEPLOYED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RESOURCES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="nv">1s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Pod&lt;span class="o">(&lt;/span>related&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql-7b688448b9-pxml5 0/1 Pending &lt;span class="m">0&lt;/span> &lt;span class="nv">1s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql Opaque &lt;span class="m">2&lt;/span> &lt;span class="nv">1s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/ConfigMap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql-test &lt;span class="m">1&lt;/span> &lt;span class="nv">1s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql ClusterIP 10.100.139.57 &amp;lt;none&amp;gt; 3306/TCP 1s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MySQL can be accessed via port &lt;span class="m">3306&lt;/span> on the following DNS name from within your cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql.default.svc.cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To get your root password run:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace default mysql -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.data.mysql-root-password}&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 --decode&lt;span class="p">;&lt;/span> &lt;span class="nb">echo&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To connect to your database:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. Run an Ubuntu pod that you can use as a client:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kubectl run -i --tty ubuntu --image&lt;span class="o">=&lt;/span>ubuntu:16.04 --restart&lt;span class="o">=&lt;/span>Never -- bash -il
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. Install the mysql client:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $ apt-get update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt-get install mysql-client -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. Connect using the mysql cli, &lt;span class="k">then&lt;/span> provide your password:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $ mysql -h mysql -p
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To connect to your database directly from outside the K8s cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">MYSQL_HOST&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">MYSQL_PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3306&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Execute the following command to route the connection:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kubectl port-forward svc/mysql &lt;span class="m">3306&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mysql -h &lt;span class="si">${&lt;/span>&lt;span class="nv">MYSQL_HOST&lt;/span>&lt;span class="si">}&lt;/span> -P&lt;span class="si">${&lt;/span>&lt;span class="nv">MYSQL_PORT&lt;/span>&lt;span class="si">}&lt;/span> -u root -p&lt;span class="si">${&lt;/span>&lt;span class="nv">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Prometheus</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/prometheus/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/prometheus/</guid><description/></item><item><title>Traefik</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/traefik/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/traefik/</guid><description>&lt;h1 id="traefik">Traefik&lt;/h1></description></item><item><title>Web 应用</title><link>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/web-%E5%BA%94%E7%94%A8/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/1.%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%83%A8%E7%BD%B2/%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/web-%E5%BA%94%E7%94%A8/</guid><description>&lt;h1 id="http-服务部署">HTTP 服务部署&lt;/h1>
&lt;h1 id="deployment--service">Deployment &amp;amp; Service&lt;/h1>
&lt;p>在 &lt;a href="https://github.com/wx-chevalier/Backend-Boilerplates/tree/master/K8s" target="_blank" rel="noopener">K8s Boilerplates&lt;/a> 中我们定义了简单的 Nginx 的部署与服务，分别用于集群构建与对外的服务暴露：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># nginx-deployment-service.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># for versions before 1.9.0 use apps/v1beta2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Recreate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># tells deployment to run 1 pods matching the template&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># create pods using pod definition in this template&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">externalTrafficPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Local&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl create -f nginx-deployment-service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-56db997f77-2q6qz 1/1 Running &lt;span class="m">0&lt;/span> 3m21s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-56db997f77-fv2zs 1/1 Running &lt;span class="m">0&lt;/span> 3m21s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-56db997f77-wx2q5 1/1 Running &lt;span class="m">0&lt;/span> 3m21s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx 3/3 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 3m36s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get svc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes ClusterIP 10.43.0.1 &amp;lt;none&amp;gt; 443/TCP 21h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx NodePort 10.43.8.50 &amp;lt;none&amp;gt; 80:32356/TCP 4m5s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://i.postimg.cc/6qQZRXwh/image.png" alt="Pod 列表" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;h1 id="ingress">Ingress&lt;/h1>
&lt;p>Ingress 是一种 Kubernetes 资源，也是将 Kubernetes 集群内服务暴露到外部的一种方式。ngress 只是一个统称，其由 Ingress 和 Ingress Controller 两部分组成。Ingress 用作将原来需要手动配置的规则抽象成一个 Ingress 对象，使用 YAML 格式的文件来创建和管理。Ingress Controller 用作通过与 Kubernetes API 交互，动态的去感知集群中 Ingress 规则变化。&lt;/p>
&lt;p>目前可用的 Ingress Controller 类型有很多，比如：Nginx、HAProxy、Traefik 等，Nginx Ingress 使用 ConfigMap 来管理 Nginx 配置。&lt;/p>
&lt;h2 id="helm-安装-ingress">Helm 安装 Ingress&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ helm install --name nginx-ingress --set &lt;span class="s2">&amp;#34;rbac.create=true,controller.service.externalIPs[0]=172.19.157.1,controller.service.externalIPs[1]=172.19.157.2,controller.service.e
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">xternalIPs[2]=172.19.157.3&amp;#34;&lt;/span> stable/nginx-ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: nginx-ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Tue Aug &lt;span class="m">20&lt;/span> 14:50:13 &lt;span class="m">2019&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: DEPLOYED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RESOURCES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/ConfigMap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller &lt;span class="m">1&lt;/span> &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Pod&lt;span class="o">(&lt;/span>related&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller-5f874f7bf4-nvsvv 0/1 ContainerCreating &lt;span class="m">0&lt;/span> 0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-default-backend-6f598d9c4c-vj4v8 0/1 ContainerCreating &lt;span class="m">0&lt;/span> &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller LoadBalancer 10.43.115.59 172.19.157.1,172.19.157.2,172.19.157.3 80:32122/TCP,443:32312/TCP 0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-default-backend ClusterIP 10.43.8.65 &amp;lt;none&amp;gt; 80/TCP &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1/ServiceAccount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME SECRETS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress &lt;span class="m">1&lt;/span> &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/ClusterRole
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/ClusterRoleBinding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller 0/1 &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-default-backend 0/1 &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/PodDisruptionBudget
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MIN AVAILABLE MAX UNAVAILABLE ALLOWED DISRUPTIONS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller &lt;span class="m">1&lt;/span> N/A &lt;span class="m">0&lt;/span> 0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-default-backend &lt;span class="m">1&lt;/span> N/A &lt;span class="m">0&lt;/span> 0s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署完成后我们可以看到 Kubernetes 服务中增加了 nginx-ingress-controller 和 nginx-ingress-default-backend 两个服务。nginx-ingress-controller 为 Ingress Controller，主要做为一个七层的负载均衡器来提供 HTTP 路由、粘性会话、SSL 终止、SSL 直通、TCP 和 UDP 负载平衡等功能。nginx-ingress-default-backend 为默认的后端，当集群外部的请求通过 Ingress 进入到集群内部时，如果无法负载到相应后端的 Service 上时，这种未知的请求将会被负载到这个默认的后端上。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get svc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes ClusterIP 10.43.0.1 &amp;lt;none&amp;gt; 443/TCP 20h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller LoadBalancer 10.43.115.59 172.19.157.1,172.19.157.2,172.19.157.3 80:32122/TCP,443:32312/TCP 77m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-default-backend ClusterIP 10.43.8.65 &amp;lt;none&amp;gt; 80/TCP 77m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl --namespace default get services -o wide -w nginx-ingress-controller
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE SELECTOR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress-controller LoadBalancer 10.43.115.59 172.19.157.1,172.19.157.2,172.19.157.3 80:32122/TCP,443:32312/TCP 77m &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>nginx-ingress,component&lt;span class="o">=&lt;/span>controller,release&lt;span class="o">=&lt;/span>nginx-ingress
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>由于我们采用了 ExternalIP 方式对外暴露服务，所以 nginx-ingress-controller 会在三台节点宿主机上的 暴露 80/443 端口。我们可以在任意节点上进行访问，因为我们还没有在 Kubernetes 集群中创建 Ingress 资源，所以直接对 ExternalIP 的请求被负载到了 nginx-ingress-default-backend 上。nginx-ingress-default-backend 默认提供了两个 URL 进行访问，其中的 /healthz 用作健康检查返回 200，而 / 返回 404 错误。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ curl 127.0.0.1/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># default backend - 404&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl 127.0.0.1/healthz/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 返回的是 200&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>后续我们如果需要创建自身的 Ingress 配置，可以参考如下方式：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kubernetes.io/ingress.class&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">foo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">www.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">serviceName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">exampleService&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">servicePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># This section is only required if TLS is to be enabled for the Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">www.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果希望使用 TLS，那么需要创建包含证书与 Key 的 Secret：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">foo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tls.crt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;base64 encoded cert&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tls.key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;base64 encoded key&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes.io/tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wordpress">WordPress&lt;/h2>
&lt;p>Helm 安装完毕后，我们来测试部署一个 WordPress 应用：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ helm install --name wordpress-test --set &lt;span class="s2">&amp;#34;ingress.enabled=true,persistence.enabled=false,mariadb.persistence.enabled=false&amp;#34;&lt;/span> stable/wordpress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: wordpress-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这里我们使用 Ingress 负载均衡进行访问，可以通过如下方式访问到服务：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wordpress.local-wordpress-test wordpress.local 172.19.157.1,172.19.157.2,172.19.157.3 &lt;span class="m">80&lt;/span> 59m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ curl -I http://wordpress.local -x 127.0.0.1:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP/1.1 &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: nginx/1.15.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Tue, &lt;span class="m">20&lt;/span> Aug &lt;span class="m">2019&lt;/span> 07:55:21 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-Type: text/html&lt;span class="p">;&lt;/span> &lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection: keep-alive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Vary: Accept-Encoding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">X-Powered-By: PHP/7.0.27
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Link: &amp;lt;http://wordpress.local/wp-json/&amp;gt;&lt;span class="p">;&lt;/span> &lt;span class="nv">rel&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://api.w.org/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>也可以根据 Charts 的说明，利用如下命令获得 WordPress 站点的管理员用户和密码：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Username: user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Password: &lt;span class="k">$(&lt;/span>kubectl get secret --namespace default wordpress-test-wordpress -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;{.data.wordpress-password}&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 --decode&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/Role
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress &lt;span class="nv">0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&lt;/span>&amp;gt; v1beta1/RoleBinding
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-ingress 0s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="滚动升级">滚动升级&lt;/h1>
&lt;blockquote>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/JX8Sw828e0Gv8ndYn3KXvQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/JX8Sw828e0Gv8ndYn3KXvQ&lt;/a> 在Kubernetes中部署网站的综合指南 Todos&lt;/p>
&lt;/blockquote></description></item></channel></rss>