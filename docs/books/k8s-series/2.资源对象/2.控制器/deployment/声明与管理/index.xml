<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>声明与管理 | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/</link><atom:link href="https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/index.xml" rel="self" type="application/rss+xml"/><description>声明与管理</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>声明与管理</title><link>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/</link></image><item><title>DaemonSet</title><link>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/</guid><description>&lt;h1 id="daemonset">DaemonSet&lt;/h1>
&lt;p>** DaemonSet ** is basically the same as ReplicaSet, with the difference that when you use DaemonSet you do not specify the number of replicas, it will go up one pod per node in your cluster.&lt;/p>
&lt;p>It is always interesting when creating, using and abusing labels, so you will be able to have better flexibility in the most appropriate distribution of your application.&lt;/p>
&lt;p>It is very interesting for services that need to run on all nodes in the cluster, such as log collectors and monitoring agents.&lt;/p>
&lt;p>Let&amp;rsquo;s create our first DaemonSet:&lt;/p>
&lt;p>&lt;code>I came first daemonset.yaml&lt;/code>&lt;/p>
&lt;p>The content should be as follows:&lt;/p>
&lt;p>&lt;code>yaml apiVersion: apps / v1 kind: DaemonSet metadata: name: daemon-set-first spec: selector: matchLabels: system: Strigus template: metadata: labels: system: Strigus spec: containers: - name: nginx image: nginx: 1.7.9 ports: - containerPort: 80&lt;/code>&lt;/p>
&lt;p>But first let’s allow all of our nodes to run pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl taint nodes --all node-role.kubernetes.io/master-
node / elliot-01 untainted
taint &amp;#34;node-role.kubernetes.io/master:&amp;#34; not found
taint &amp;#34;node-role.kubernetes.io/master:&amp;#34; not found
&lt;/code>&lt;/pre>&lt;p>Now we can create our DaemonSet:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl create -f first-daemonset.yaml
daemonset.extensions / daemon-set-first created
&lt;/code>&lt;/pre>&lt;p>Let&amp;rsquo;s list our DaemonSet:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get daemonset
NAME DESIRED CURRENT READY UP-TO-DATE ... AGE
daemon-set-first 3 3 3 3 30s
&lt;/code>&lt;/pre>&lt;p>Viewing the DaemonSet details:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe ds daemon-set-first
Name: daemon-set-first
Selector: system = Strigus
Node-Selector: &amp;lt;none&amp;gt;
Labels: system = Strigus
Annotations: &amp;lt;none&amp;gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = Strigus
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
Events:
Type Reason Age From Message
---
Normal SuccessfulCreate 41s daemonset-controller Created pod: daemon-set-first-jl6f5
Normal SuccessfulCreate 412 daemonset-controller Created pod: daemon-set-first-jh2sp
Normal SuccessfulCreate 412 daemonset-controller Created pod: daemon-set-first-t9rv9
&lt;/code>&lt;/pre>&lt;p>Viewing pod details:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods -o wide
NAME READY STATUS RESTARTS AGE .. NODE
daemon-set-first .. 1/1 Running 0 1m elliot-01
daemon-set-first .. 1/1 Running 0 1m elliot-02
daemon-set-first .. 1/1 Running 0 1m elliot-03
&lt;/code>&lt;/pre>&lt;p>As we can see we have one pod per node running our &lt;code> daemon-set-first&lt;/code>.&lt;/p>
&lt;p>Let&amp;rsquo;s change the image of this pod directly in DaemonSet, using the command &lt;code> kubectl set&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl set image ds daemon-set-first nginx = nginx: 1.15.0
daemonset.extensions / daemon-set-first image updated
&lt;/code>&lt;/pre>&lt;p>Let&amp;rsquo;s confirm that the image has really been changed:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe ds daemon-set-first
Name: daemon-set-first
Selector: system = Strigus
Node-Selector: &amp;lt;none&amp;gt;
Labels: system = Strigus
Annotations: &amp;lt;none&amp;gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 0
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = Strigus
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
Events:
Type Reason Age From Message
---
Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-jl6f5
Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-jh2sp
Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-t9rv9
&lt;/code>&lt;/pre>&lt;p>Now let&amp;rsquo;s check if the pod images are up to date:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods
NAME READY STATUS RESTARTS AGE
daemon-set-first-jh2sp 1/1 Running 0 2m
daemon-set-first-jl6f5 1/1 Running 0 2m
daemon-set-first-t9rv9 1/1 running 0 2m
&lt;/code>&lt;/pre>&lt;p>As we can see, we had no restart on the pods.&lt;/p>
&lt;p>Let&amp;rsquo;s check the image running on one of the pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-jh2sp | grep -i image:
Image: nginx: 1.7.9
&lt;/code>&lt;/pre>&lt;p>Exactly, we were unable to change information from the running DaemonSet.&lt;/p>
&lt;p>What if the pod is deleted?&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl delete pod daemon-set-first-jh2sp
pod &amp;#34;daemon-set-first-jh2sp&amp;#34; deleted
&lt;/code>&lt;/pre>&lt;p>Viewing the pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods
NAME READY STATUS RESTARTS AGE
daemon-set-first-hp4qc 1/1 Running 0 3s
daemon-set-first-jl6f5 1/1 running 0 10m
daemon-set-first-t9rv9 1/1 running 0 10m
&lt;/code>&lt;/pre>&lt;p>Let&amp;rsquo;s list the new Pod that was created, after deleting the old Pod:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-hp4qc | grep -i image:
Image: nginx: 1.15.0
&lt;/code>&lt;/pre>&lt;p>Now a Pod that was already running:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-jl6f5 | grep -i image:
Image: nginx: 1.7.9
&lt;/code>&lt;/pre>&lt;p>As we can see, to update all the pods in DaemonSet we need to recreate it or destroy all the pods related to it, but isn&amp;rsquo;t that too bad? Yes, it&amp;rsquo;s really bad. To improve our lives we have the option &lt;code> RollingUpdate&lt;/code> that we will see in the next chapter.&lt;/p>
&lt;h1 id="rollouts-and-rollbacks">Rollouts and Rollbacks&lt;/h1>
&lt;p>Now let&amp;rsquo;s imagine that our last edition using the command &lt;code> kubectl set&lt;/code> in DaemonSet was not correct and we need to go back to the previous configuration, where the image version was different, how do we do it?&lt;/p>
&lt;p>It&amp;rsquo;s very simple, for that there is &lt;em>Rollout&lt;/em>. With it you can check what were the changes that happened in your Deployment or DaemonSet, as if it were a version. Look! (With the voice of Nelson Rubens)&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first
daemonsets &amp;#34;daemon-set-first&amp;#34;
REVISION CHANGE-CAUSE
1 &amp;lt;none&amp;gt;
2 &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>It will show two lines, the first which is the original, with the image of &lt;code> nginx: 1.7.9&lt;/code> and the second already with the image &lt;code> nginx: 1.15.0&lt;/code>. The information is not very detailed, do you agree?&lt;/p>
&lt;p>Here&amp;rsquo;s how to check the details of each of these entries, which are called ** revision **.&lt;/p>
&lt;p>Viewing revision 1:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first --revision = 1
daemonsets &amp;#34;daemon-set-first&amp;#34; with revision # 1
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Viewing revision 2:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first --revision = 2
daemonsets &amp;#34;daemon-set-first&amp;#34; with revision # 2
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>To return to the desired revision, simply do the following:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout undo ds daemon-set-first --to-revision = 1
daemonset.extensions / daemon-set-first rolled back
&lt;/code>&lt;/pre>&lt;p>Notice that we changed the &lt;code> history&lt;/code> for &lt;code> undo&lt;/code> and the &lt;code> revision&lt;/code> for &lt;code> to-revision&lt;/code>, so we will do the ** rollback ** in our DaemonSet, and return the version of the image that we wish. 😃&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>NOTE: By default, DaemonSet stores only the last 10 revisions. To change the maximum number of revisions in our Daemonset, run the following command.
Source: &lt;a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;hr>
&lt;p>&lt;code>kubectl edit daemonsets.apps daemon-set-first&lt;/code>&lt;/p>
&lt;p>Change the quantity in the &lt;code> revisionHistoryLimit&lt;/code> parameter:&lt;/p>
&lt;p>&lt;code>yaml revisionHistoryLimit: 10&lt;/code>&lt;/p>
&lt;hr>
&lt;p>Returning to our line of reasoning, to follow the rollout, execute the following command:&lt;/p>
&lt;p>&lt;code>kubectl rollout status ds daemon-set-first&lt;/code>&lt;/p>
&lt;p>Let&amp;rsquo;s confirm that we are already running the new image and one of our pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-hp4qc | grep -i image:
Image: nginx: 1.15.0
&lt;/code>&lt;/pre>&lt;p>It didn&amp;rsquo;t work, why? Because we will have to kill the Pod to be recreated with the new settings.&lt;/p>
&lt;p>Let&amp;rsquo;s fine-tune our DaemonSet, add the RollingUpdate and this guy will automatically update the Pods when there are changes.&lt;/p>
&lt;p>Come on, first let&amp;rsquo;s remove the &lt;code> DaemonSet&lt;/code>, add two new information to our yaml manifest and then create another DaemonSet instead:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl delete -f first-daemonset.yaml
daemonset.extensions &amp;#34;daemon-set-first&amp;#34; deleted
&lt;/code>&lt;/pre>&lt;p>Edit the &lt;code> first-daemonset.yaml&lt;/code> file.&lt;/p>
&lt;p>&lt;code>I came first daemonset.yaml&lt;/code>&lt;/p>
&lt;p>The content should be as follows:&lt;/p>
&lt;p>&lt;code>yaml apiVersion: apps / v1 kind: DaemonSet metadata: name: daemon-set-first spec: selector: matchLabels: system: Strigus template: metadata: labels: system: Strigus spec: containers: - name: nginx image: nginx: 1.7.9 ports: - containerPort: 80 updateStrategy: type: RollingUpdate&lt;/code>&lt;/p>
&lt;p>Create the DaemonSet:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl create -f first-daemonset.yaml
daemonset.extensions / daemon-set-first created
&lt;/code>&lt;/pre>&lt;p>Success, let&amp;rsquo;s check if our DaemonSet has started up correctly.&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get daemonset
NAME DESIRED CURRENT READY ... AGE
daemon-set-first 3 3 3 ... 5m
&lt;/code>&lt;/pre>&lt;p>Viewing the DaemonSet details:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe ds daemon-set-first
Name: daemon-set-first
Selector: system = DaemonOne
Node-Selector: &amp;lt;none&amp;gt;
Labels: system = DaemonOne
Annotations: &amp;lt;none&amp;gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
Events:
Type Reason Age From Message
---
Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-52k8k
Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-6sln2
Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-9v2w9
daemonset-controller Created pod: daemon-set-first-9dktj
&lt;/code>&lt;/pre>&lt;p>Let&amp;rsquo;s check out our newly added &lt;code> RollingUpdate&lt;/code> configuration:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get ds daemon-set-first -o yaml | grep -A 2 Strategy
updateStrategy:
rollingUpdate:
maxUnavailable: 1
&lt;/code>&lt;/pre>&lt;p>Now with our DaemonSet already configured, let&amp;rsquo;s change that same &lt;code> nginx&lt;/code> image and see what actually happens:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl set image ds daemon-set-first nginx = nginx: 1.15.0
daemonset.extensions / daemon-set-first image updated
&lt;/code>&lt;/pre>&lt;p>Let&amp;rsquo;s list the DaemonSet and the Pods to make sure nothing is broken:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get daemonset
NAME DESIRED CURRENT READY ... AGE
daemon-set-first 3 3 3 ... 6m
&lt;/code>&lt;/pre>&lt;p>Viewing the pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods -o wide
NAME READY STATUS RESTARTS AGE NODE
daemon-set-first-7m ... 1/1 Running 0 10s elliot-02
daemon-set-first-j7 ... 1/1 Running 0 10s elliot-03
daemon-set-first-v5 ... 1/1 Running 0 10s elliot-01
&lt;/code>&lt;/pre>&lt;p>As we can see, our DaemonSet has remained the same, but the Pods have been recreated, we will detail the DaemonSet to see the changes made.&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe ds daemon-set-first
Name: daemon-set-first
Selector: system = DaemonOne
Node-Selector: &amp;lt;none&amp;gt;
Labels: system = DaemonOne
Annotations: &amp;lt;none&amp;gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
Events:
Type Reason Age From Message
---
Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-52k8k
Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-6sln2
Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-9v2w9
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-6sln2
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-j788v
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-52k8k
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-7mpwr
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-9v2w9
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-v5m47
&lt;/code>&lt;/pre>&lt;p>Look how cool! If we look at the ** Events ** field we can see that the &lt;code> RollingUpdate&lt;/code> killed the old pods and recreated with the new image that we changed using the &lt;code> kubectl set&lt;/code>.&lt;/p>
&lt;p>We can also check in one of the Pods if this change really happened.&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-j788v | grep -i image:
Image: nginx: 1.15.0
&lt;/code>&lt;/pre>&lt;p>See? Very sensational this business of &lt;code> RollingUpdate&lt;/code>.&lt;/p>
&lt;p>Let&amp;rsquo;s check out our change history:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first
daemonsets &amp;#34;daemon-set-first&amp;#34;
REVISION CHANGE-CAUSE
1 &amp;lt;none&amp;gt;
2 &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Yes, we have two changes. Let&amp;rsquo;s drill down to see which is which.&lt;/p>
&lt;p>Viewing revision 1:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first --revision = 1
daemonsets &amp;#34;daemon-set-first&amp;#34; with revision # 1
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Viewing revision 2:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout history ds daemon-set-first --revision = 2
daemonsets &amp;#34;daemon-set-first&amp;#34; with revision # 2
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &amp;lt;none&amp;gt;
Mounts: &amp;lt;none&amp;gt;
Volumes: &amp;lt;none&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Now let&amp;rsquo;s rollback our DaemonSet to revision 1:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout undo ds daemon-set-first --to-revision = 1
daemonset.extensions / daemon-set-first rolled back
kubectl rollout undo ds daem kubectl rollout undo ds daem
&lt;/code>&lt;/pre>&lt;p>Viewing the pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods
NAME READY STATUS RESTARTS AGE
daemon-set-first-c2jjk 1/1 Running 0 19s
daemon-set-first-hrn48 1/1 Running 0 19s
daemon-set-first-t6mr9 1/1 Running 0 19s
&lt;/code>&lt;/pre>&lt;p>Viewing pod details:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-c2jjk | grep -i image:
Image: nginx: 1.7.9
&lt;/code>&lt;/pre>&lt;p>Sensational isn&amp;rsquo;t it?&lt;/p>
&lt;p>Did it go bad?&lt;/p>
&lt;p>Just return to the other setting:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout undo ds daemon-set-first --to-revision = 2
daemonset.extensions / daemon-set-first rolled back
&lt;/code>&lt;/pre>&lt;p>Viewing the rollout status:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl rollout status ds daemon-set-first
daemon set &amp;#34;daemon-set-first&amp;#34; successfully rolled out
&lt;/code>&lt;/pre>&lt;p>Viewing the pods:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl get pods
NAME READY STATUS RESTARTS AGE
daemon-set-first-jzck9 1/1 Running 0 32s
daemon-set-first-td7h5 1/1 Running 0 29s
daemon-set-first-v5c86 1/1 Running 0 40s
&lt;/code>&lt;/pre>&lt;p>Viewing pod details:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl describe pod daemon-set-first-jzck9 | grep -i image:
Image: nginx: 1.15.0
&lt;/code>&lt;/pre>&lt;p>Now let&amp;rsquo;s delete our DaemonSet:&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl delete ds daemon-set-first
daemonset.extensions &amp;#34;daemon-set-first&amp;#34; deleted
&lt;/code>&lt;/pre></description></item><item><title>Deployment</title><link>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/deployment/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/deployment/</guid><description>&lt;h1 id="deployment-操作">Deployment 操作&lt;/h1>
&lt;p>当你使用 &lt;code>kubectl create deployment&lt;/code> 时，你正在部署一个名为 Deployment 的对象。与其他对象一样，Deployment 也可以使用 YAML 或 JSON 文件（即 manifests）创建。如果你想改变对象的任何配置，例如 pod，你可以使用 kubectl apply，通过 manifest，甚至通过 kubectl edit。通常情况下，当您对 Deployment 进行更改时，会创建一个新版本的 ReplicaSet，它将成为资产并导致其前身被禁用。较早版本的 ReplicaSets 将被保留，从而在发生故障时可以回滚。&lt;/p>
&lt;p>标签对于集群的管理是很重要的，因为有了标签就可以搜索或选择集群中的资源，使你能够以小类来组织，从而方便你的搜索和组织你的豆荚和集群资源。标签不是 API 服务器的功能，它们是以键值格式存储在元数据中的。&lt;/p>
&lt;h1 id="生命周期管理">生命周期管理&lt;/h1>
&lt;h2 id="创建">创建&lt;/h2>
&lt;p>比如一个简单的 Nginx 应用可以定义为：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">extensions/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx-deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:1.7.9&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后通过如下操作进行创建：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl create -f https://raw.githubusercontent.com/kubernetes-client/python/master/examples/nginx-deployment.yaml --record
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get deployments
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment &lt;span class="m">3&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 1s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 等待一段时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get deployments
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 18s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到 Deployment 已经创建了 3 个 replica，所有的 replica 都已经是最新的了（包含最新的 pod template），可用的（根据 Deployment 中的.spec.minReadySeconds 声明，处于已就绪状态的 pod 的最少个数）。执行 kubectl get rs 和 kubectl get pods 会显示 Replica Set（RS）和 Pod 已创建。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ReplicaSet 的名字总是&amp;lt;Deployment的名字&amp;gt;-&amp;lt;pod template的hash值&amp;gt;。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-2035384211 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">0&lt;/span> 18s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="扩容">扩容&lt;/h2>
&lt;p>您可以使用以下命令扩容 Deployment：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl scale deployment nginx-deployment --replicas &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> scaled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>假设您的集群中启用了 horizontal pod autoscaling，您可以给 Deployment 设置一个 autoscaler，基于当前 Pod 的 CPU 利用率选择最少和最多的 Pod 数。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl autoscale deployment nginx-deployment --min&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span> --max&lt;span class="o">=&lt;/span>&lt;span class="m">15&lt;/span> --cpu-percent&lt;span class="o">=&lt;/span>&lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> autoscaled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>RollingUpdate Deployment 支持同时运行一个应用的多个版本。或者 autoscaler 扩 容 RollingUpdate Deployment 的时候，正在中途的 rollout（进行中或者已经暂停的），为了降低风险，Deployment controller 将会平衡已存在的活动中的 ReplicaSet（有 Pod 的 ReplicaSet）和新加入的 replica。这被称为比例扩容。&lt;/p>
&lt;p>譬如正在运行中含有 10 个 replica 的 Deployment。maxSurge=3，maxUnavailable=2：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment &lt;span class="m">10&lt;/span> &lt;span class="m">10&lt;/span> &lt;span class="m">10&lt;/span> &lt;span class="m">10&lt;/span> 50s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 更新了错误的镜像&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl &lt;span class="nb">set&lt;/span> image deploy/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:sometag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> image updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动了一个包含 ReplicaSet nginx-deployment-1989198191 的新的 rollout，但是它被阻塞&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-1989198191 &lt;span class="m">5&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> 9s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-618515232 &lt;span class="m">8&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">8&lt;/span> 1m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>autoscaler 将 Deployment 的 repllica 数目增加到了 15 个。Deployment controller 需要判断在哪里增加这 5 个新的 replica。如果我们没有谁用比例扩容，所有的 5 个 replica 都会加到一个新的 ReplicaSet 中。如果使用比例扩容，新添加的 replica 将传播到所有的 ReplicaSet 中。大的部分加入 replica 数最多的 ReplicaSet 中，小的部分加入到 replica 数少的 ReplciaSet 中。0 个 replica 的 ReplicaSet 不会被扩容。在我们上面的例子中，3 个 replica 将添加到旧的 ReplicaSet 中，2 个 replica 将添加到新的 ReplicaSet 中。rollout 进程最终会将所有的 replica 移动到新的 ReplicaSet 中，假设新的 replica 成为健康状态。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment &lt;span class="m">15&lt;/span> &lt;span class="m">18&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span> 7m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-1989198191 &lt;span class="m">7&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">0&lt;/span> 7m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-618515232 &lt;span class="m">11&lt;/span> &lt;span class="m">11&lt;/span> &lt;span class="m">11&lt;/span> 7m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="更新">更新&lt;/h2>
&lt;p>Kubernetes 提供了多种升级方案，Recreate 即删除所有已存在的 pod,重新创建新的; RollingUpdate 即滚动升级，逐步替换的策略，同时滚动升级时，支持更多的附加参数，例如设置最大不可用 Pod 数量，最小升级间隔时间等等。Deployment 的 rollout 当且仅当 Deployment 的 pod template（例如.spec.template）中的 label 更新或者镜像更改时被触发。其他更新，例如扩容 Deployment 不会触发 rollout。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 让 nginx pod 使用nginx:1.9.1的镜像来代替原来的nginx:1.7.9的镜像&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl &lt;span class="nb">set&lt;/span> image deployment/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> image updated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们可以使用 edit 命令来编辑 Deployment，修改 .spec.template.spec.containers[0].image，将 nginx:1.7.9 改写成 nginx:1.9.1。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl edit deployment/nginx-deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> edited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看 rollout 的状态&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl rollout status deployment/nginx-deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> rollout to finish: &lt;span class="m">2&lt;/span> out of &lt;span class="m">3&lt;/span> new replicas have been updated...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> successfully rolled out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看关联的 ReplicaSet 信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-1564180365 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">0&lt;/span> 6s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-deployment-2035384211 &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 36s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们通过执行 kubectl get rs 可以看到 Deployment 更新了 Pod，通过创建一个新的 ReplicaSet 并扩容了 3 个 replica，同时将原来的 ReplicaSet 缩容到了 0 个 replica。执行 get pods 只会看到当前的新的 pod。&lt;/p>
&lt;p>Deployment 可以保证在升级时只有一定数量的 Pod 是 down 的。默认的，它会确保至少有比期望的 Pod 数量少一个是 up 状态（最多一个不可用）。Deployment 同时也可以确保只创建出超过期望数量的一定数量的 Pod。默认的，它会确保最多比期望的 Pod 数量多一个的 Pod 是 up 的（最多 1 个 surge）。&lt;/p>
&lt;h2 id="回滚">回滚&lt;/h2>
&lt;p>有时候您可能想回退一个 Deployment，例如，当 Deployment 不稳定时，比如一直 crash looping。默认情况下，kubernetes 会在系统中保存前两次的 Deployment 的 rollout 历史记录，以便您可以随时回退（您可以修改 revision history limit 来更改保存的 revision 数）。&lt;/p>
&lt;p>只要 Deployment 的 rollout 被触发就会创建一个 revision。也就是说当且仅当 Deployment 的 Pod template（如.spec.template）被更改，例如更新 template 中的 label 和容器镜像时，就会创建出一个新的 revision。其他的更新，比如扩容 Deployment 不会创建 revision，因此我们可以很方便的手动或者自动扩容。这意味着当您回退到历史 revision 时，只有 Deployment 中的 Pod template 部分才会回退。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 检查下 Deployment 的 revision&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl rollout &lt;span class="nb">history&lt;/span> deployment/nginx-deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployments &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION CHANGE-CAUSE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> kubectl create -f https://kubernetes.io/docs/user-guide/nginx-deployment.yaml--record
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> kubectl &lt;span class="nb">set&lt;/span> image deployment/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">3&lt;/span> kubectl &lt;span class="nb">set&lt;/span> image deployment/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.91
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>因为我们创建 Deployment 的时候使用了&amp;ndash;record 参数可以记录命令，我们可以很方便的查看每次 revision 的变化。查看单个 revision 的详细信息：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl rollout &lt;span class="nb">history&lt;/span> deployment/nginx-deployment --revision&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployments &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> revision &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Labels: &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pod-template-hash&lt;span class="o">=&lt;/span>&lt;span class="m">1159050644&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Annotations: kubernetes.io/change-cause&lt;span class="o">=&lt;/span>kubectl &lt;span class="nb">set&lt;/span> image deployment/nginx-deployment &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nginx:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Image: nginx:1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Port: 80/TCP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> QoS Tier:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: BestEffort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: BestEffort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Environment Variables: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> No volumes.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>同样可以通过 rollout 命令来回退版本：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 回退当前的 rollout 到之前的版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl rollout undo deployment/nginx-deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> rolled back
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 使用 --revision参数指定某个历史版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl rollout undo deployment/nginx-deployment --to-revision&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> rolled back
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以通过设置 &lt;code>.spec.revisonHistoryLimit&lt;/code> 项来指定 deployment 最多保留多少 revision 历史记录。默认的会保留所有的 revision；如果将该项设置为 0，Deployment 就不允许回退了。&lt;/p>
&lt;h2 id="暂停和恢复">暂停和恢复&lt;/h2>
&lt;p>您可以在发出一次或多次更新前暂停一个 Deployment，然后再恢复它。这样您就能在 Deployment 暂停期间进行多次修复工作，而不会发出不必要的 rollout。例如使用刚刚创建 Deployment：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 1m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>mkargaki@dhcp129-211 kubernetes&lt;span class="o">]&lt;/span>$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-2142116321 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 1m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用以下命令暂停 Deployment：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl rollout pause deployment/nginx-deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> paused
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后更新 Deplyment 中的镜像：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl &lt;span class="nb">set&lt;/span> image deploy/nginx &lt;span class="nv">nginx&lt;/span>&lt;span class="o">=&lt;/span>nginx:1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx-deployment&amp;#34;&lt;/span> image updated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意新的 rollout 启动了：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl rollout &lt;span class="nb">history&lt;/span> deploy/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployments &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION CHANGE-CAUSE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get rs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-2142116321 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 2m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>您可以进行任意多次更新，例如更新使用的资源：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl &lt;span class="nb">set&lt;/span> resources deployment nginx -c&lt;span class="o">=&lt;/span>nginx --limits&lt;span class="o">=&lt;/span>&lt;span class="nv">cpu&lt;/span>&lt;span class="o">=&lt;/span>200m,memory&lt;span class="o">=&lt;/span>512Mi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span> resource requirements updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Deployment 暂停前的初始状态将继续它的功能，而不会对 Deployment 的更新产生任何影响，只要 Deployment是暂停的。
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后，恢复这个 Deployment，观察完成更新的 ReplicaSet 已经创建出来了：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl rollout resume deploy nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span> resumed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="过滤与选择">过滤与选择&lt;/h1>
&lt;h2 id="根据标签过滤">根据标签过滤&lt;/h2>
&lt;p>当我们创建 Deployments 时，我们添加了以下标签：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">UK&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Netherlands&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Labels 是用来组织集群的，让我们列出我们的 Pods 寻找 Labels。首先让我们用 dc=UK 和 dc=Netherlands 这两个标签进行搜索。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get pods -l &lt;span class="nv">dc&lt;/span>&lt;span class="o">=&lt;/span>UK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">primeiro-deployment-68c9dbf8b8-kjqpt 1/1 Running &lt;span class="m">0&lt;/span> 3m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pods -l &lt;span class="nv">dc&lt;/span>&lt;span class="o">=&lt;/span>Netherlands
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">segundo-deployment-59db86c584-cf9pp 1/1 Running &lt;span class="m">0&lt;/span> 4m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果你想要更个性化的输出，我们可以列举如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">kubectl get pod -L dc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE DC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">primeiro-deployment-68c9... 1/1 Running &lt;span class="m">0&lt;/span> 5m UK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">segundo-deployment-59db ... 1/1 Running &lt;span class="m">0&lt;/span> 5m Netherlands
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ReplicaSet</title><link>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/replicaset/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-series/2.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/2.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/replicaset/</guid><description>&lt;h1 id="replicaset">ReplicaSet&lt;/h1>
&lt;p>ReplicaSet 可以保证 Deployment 所需的 pod 和资源数量。一旦创建了部署，ReplicaSet 就会控制运行的 pod 数量，如果有任何 pod 完成，它将检测并请求执行另一个 pod，从而保证请求的复制数量。让我们创建第一个 ReplicaSet：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">vim primeiro-replicaset.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps / v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ReplicaSet&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">replica-set-first&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selector &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">system &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Giropops&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">system &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Giropops&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image : nginx&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1.7.9&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">containerPort &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从 manifest 中创建 ReplicaSet：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl create -f primeiro-replicaset.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replicaset.extensions/replica-set-primeiro created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get replicaset
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME DESIRED CURRENT READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span> 2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pods
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-6drmt 1/1 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-7j59w 1/1 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-mg8q9 1/1 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl describe rs replica-set-primeiro
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Name: replica-set-primeiro
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Namespace: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Selector: &lt;span class="nv">system&lt;/span>&lt;span class="o">=&lt;/span>Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Labels: &lt;span class="nv">system&lt;/span>&lt;span class="o">=&lt;/span>Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Annotations: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Replicas: &lt;span class="m">3&lt;/span> current / &lt;span class="m">3&lt;/span> desired
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pods Status: &lt;span class="m">3&lt;/span> Running / &lt;span class="m">0&lt;/span> Waiting / &lt;span class="m">0&lt;/span> Succeeded / &lt;span class="m">0&lt;/span> Failed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pod Template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Labels: &lt;span class="nv">system&lt;/span>&lt;span class="o">=&lt;/span>Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nginx:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Image: nginx:1.7.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Port: 80/TCP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Host Port: 0/TCP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Environment: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Mounts: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Volumes: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Events:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type Reason Age From Message
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ---- ------ ---- ---- -------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Normal SuccessfulCreate 31s replicaset-controller Created pod: replica-set-primeiro-mg8q9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Normal SuccessfulCreate 31s replicaset-controller Created pod: replica-set-primeiro-6drmt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Normal SuccessfulCreate 31s replicaset-controller Created pod: replica-set-primeiro-7j59w
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>因此，我们可以看到所有与 ReplicaSet 相关联的 Pods，如果我们删除其中一个 Pods，会发生什么？让我们测试一下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl delete pod replica-set-primeiro-6drmt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod &lt;span class="s2">&amp;#34;replica-set-primeiro-6drmt&amp;#34;&lt;/span> deleted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pods -l &lt;span class="nv">system&lt;/span>&lt;span class="o">=&lt;/span>Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-7j59w 1/1 Running &lt;span class="m">0&lt;/span> 1m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-mg8q9 1/1 Running &lt;span class="m">0&lt;/span> 1m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-s5dz2 1/1 Running &lt;span class="m">0&lt;/span> 15s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>你有没有注意到他又重新制作了一个 Pod？ReplicaSet 的原因总是有三个 Pod 可用。我们将改为 4 个副本并重新创建 ReplicaSet，为此我们将使用之前的 kubectl edit，这样我们就可以更改已经运行的 ReplicaSet。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl edit rs replica-set-primeiro
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion : apps / v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind : ReplicaSet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> creationTimestamp : 2018-07-05T04: 32: 42Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> generation : &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> system : Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name : replica-set-first
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace : default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resourceVersion : &lt;span class="s2">&amp;#34; 471758 &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selfLink : / apis / extensions / v1beta1 / namespaces / default / replicasets / replica-set-first
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uid : 753290c1-800c-11e8-b889-42010a8a0002
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> system : Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> creationTimestamp : null
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> system : Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replicaset.extensions / replica-set-first edited
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看 Pod 详情。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ kubectl get pods -l &lt;span class="nv">system&lt;/span>&lt;span class="o">=&lt;/span>Giropops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-7j59w 1/1 Running &lt;span class="m">0&lt;/span> 2m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-96hj7 1/1 Running &lt;span class="m">0&lt;/span> 10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-mg8q9 1/1 Running &lt;span class="m">0&lt;/span> 2m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">replica-set-primeiro-s5dz2 1/1 Running &lt;span class="m">0&lt;/span> 1m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>