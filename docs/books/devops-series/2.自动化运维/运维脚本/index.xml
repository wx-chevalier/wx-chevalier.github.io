<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>运维脚本 | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/devops-series/2.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/</link><atom:link href="https://ng-tech.icu/books/devops-series/2.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/index.xml" rel="self" type="application/rss+xml"/><description>运维脚本</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>运维脚本</title><link>https://ng-tech.icu/books/devops-series/2.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/</link></image><item><title>数据库</title><link>https://ng-tech.icu/books/devops-series/2.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/%E6%95%B0%E6%8D%AE%E5%BA%93/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/devops-series/2.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/%E6%95%B0%E6%8D%AE%E5%BA%93/</guid><description>&lt;h1 id="mysql">MySQL&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ show full processlist&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ SELECT HOST FROM information_schema.processlist where &lt;span class="nv">user&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;dbname&amp;#39;&lt;/span> and INFO like &lt;span class="s1">&amp;#39;%tbname%&amp;#39;&lt;/span>&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">COUNTER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">tmp_file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$COUNTER&lt;/span> -lt &lt;span class="m">10000&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">ss&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>mysql -uroot -N -e&lt;span class="s2">&amp;#34;SELECT HOST FROM information_schema.processlist where user=&amp;#39;dbname&amp;#39; and INFO like &amp;#39;%tbname%&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$ss&lt;/span>&amp;gt;&amp;gt;&lt;span class="si">${&lt;/span>&lt;span class="nv">tmp_file&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> &lt;span class="nv">COUNTER&lt;/span>&lt;span class="o">=&lt;/span>COUNTER+1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 然后使用 awk 命令检索&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># awk -F&amp;#34;:&amp;#34; &amp;#39;{print $1}&amp;#39; ${tmp_file}| sort | uniq&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="数据库备份">数据库备份&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#auto backup mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#wugk 2012-07-14&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#PATH DEFINE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">BAKDIR&lt;/span>&lt;span class="o">=&lt;/span>/data/backup/mysql/&lt;span class="sb">`&lt;/span>date +%Y-%m-%d&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MYSQLDB&lt;/span>&lt;span class="o">=&lt;/span>www
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MYSQLPW&lt;/span>&lt;span class="o">=&lt;/span>backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MYSQLUSR&lt;/span>&lt;span class="o">=&lt;/span>backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span>&lt;span class="o">[&lt;/span> &lt;span class="nv">$UID&lt;/span> -ne &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> This script must use administrator or root user ,please exit!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sleep &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span>&lt;span class="o">[&lt;/span> ! -d &lt;span class="nv">$BAKDIR&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p &lt;span class="nv">$BAKDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> This is &lt;span class="nv">$BAKDIR&lt;/span> exists ,please &lt;span class="nb">exit&lt;/span> ….
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sleep &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">###mysqldump backup mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/mysqldump -u&lt;span class="nv">$MYSQLUSR&lt;/span> -p&lt;span class="nv">$MYSQLPW&lt;/span> -d &lt;span class="nv">$MYSQLDB&lt;/span> &amp;gt;/data/backup/mysql/&lt;span class="sb">`&lt;/span>date +%Y-%m-%d&lt;span class="sb">`&lt;/span>/www_db.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> &lt;span class="nv">$BAKDIR&lt;/span> &lt;span class="p">;&lt;/span> tar -czf www_mysql_db.tar.gz *.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> &lt;span class="nv">$BAKDIR&lt;/span> &lt;span class="p">;&lt;/span>find . -name “*.sql” &lt;span class="p">|&lt;/span>xargs rm -rf&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -eq &lt;span class="m">0&lt;/span> &lt;span class="o">]&amp;amp;&amp;amp;&lt;/span>&lt;span class="nb">echo&lt;/span> “This &lt;span class="sb">`&lt;/span>date +%Y-%m-%d&lt;span class="sb">`&lt;/span> RESIN BACKUP is SUCCESS”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /data/backup/mysql/ &lt;span class="p">;&lt;/span>find . -mtime +30 &lt;span class="p">|&lt;/span>xargs rm -rf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>