<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="多个提高 Node.js 应用吞吐量的小优化技巧介绍翻译自 InfoQ 英文站的 node-micro-optimizations-javascript 一文，从属于笔者的Web 前端入门与工程实践。 多个提高 Node.js 应用吞吐量的小优化技巧介绍 内容提点 尽可能地使用聚合 IO 操作，以批量写的方式来最小化系统调用的次"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%8C%96/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%8C%96/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%8C%96/"><meta property="og:title" content="吞吐量优化 | Next-gen Tech Edu"><meta property="og:description" content="多个提高 Node.js 应用吞吐量的小优化技巧介绍翻译自 InfoQ 英文站的 node-micro-optimizations-javascript 一文，从属于笔者的Web 前端入门与工程实践。 多个提高 Node.js 应用吞吐量的小优化技巧介绍 内容提点 尽可能地使用聚合 IO 操作，以批量写的方式来最小化系统调用的次"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>吞吐量优化 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=b0ba39515c9609523623739e4c4bcfad><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">生产调优</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idee5f28cdb449a3b865d84854bbdbb5ba")' href=#idee5f28cdb449a3b865d84854bbdbb5ba aria-expanded=false aria-controls=idee5f28cdb449a3b865d84854bbdbb5ba aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/>02.工程实践</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idee5f28cdb449a3b865d84854bbdbb5ba aria-expanded=false aria-controls=idee5f28cdb449a3b865d84854bbdbb5ba><i class="fa-solid fa-angle-down" id=caret-idee5f28cdb449a3b865d84854bbdbb5ba></i></a></div><ul class="nav docs-sidenav collapse show" id=idee5f28cdb449a3b865d84854bbdbb5ba><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id619739e248cfd8121bc256a1872f7c1b")' href=#id619739e248cfd8121bc256a1872f7c1b aria-expanded=false aria-controls=id619739e248cfd8121bc256a1872f7c1b aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id281f299d13f5810e74d31ece8829d913")' href=#id281f299d13f5810e74d31ece8829d913 aria-expanded=false aria-controls=id281f299d13f5810e74d31ece8829d913 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id39d94840c327028ae3d9525804e39e0b")' href=#id39d94840c327028ae3d9525804e39e0b aria-expanded=false aria-controls=id39d94840c327028ae3d9525804e39e0b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/>权限认证</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id39d94840c327028ae3d9525804e39e0b aria-expanded=false aria-controls=id39d94840c327028ae3d9525804e39e0b><i class="fa-solid fa-angle-right" id=caret-id39d94840c327028ae3d9525804e39e0b></i></a></div><ul class="nav docs-sidenav collapse" id=id39d94840c327028ae3d9525804e39e0b><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/jwt/>JWT</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/passport/>Passport</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/rbac/>RBAC</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ida6f3aef3dcf395bd8e1963a5da61a7d9")' href=#ida6f3aef3dcf395bd8e1963a5da61a7d9 aria-expanded=false aria-controls=ida6f3aef3dcf395bd8e1963a5da61a7d9 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%97%A5%E5%BF%97/>日志</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ida6f3aef3dcf395bd8e1963a5da61a7d9 aria-expanded=false aria-controls=ida6f3aef3dcf395bd8e1963a5da61a7d9><i class="fa-solid fa-angle-right" id=caret-ida6f3aef3dcf395bd8e1963a5da61a7d9></i></a></div><ul class="nav docs-sidenav collapse" id=ida6f3aef3dcf395bd8e1963a5da61a7d9><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%97%A5%E5%BF%97/winston/>winston</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id1c7ae759dfba989daa49efee1420bc40")' href=#id1c7ae759dfba989daa49efee1420bc40 aria-expanded=false aria-controls=id1c7ae759dfba989daa49efee1420bc40 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/>生产调优</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id1c7ae759dfba989daa49efee1420bc40 aria-expanded=false aria-controls=id1c7ae759dfba989daa49efee1420bc40><i class="fa-solid fa-angle-down" id=caret-id1c7ae759dfba989daa49efee1420bc40></i></a></div><ul class="nav docs-sidenav collapse show" id=id1c7ae759dfba989daa49efee1420bc40><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/>安全加固</a></li><li class="child level active"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%8C%96/>吞吐量优化</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>性能优化</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id1a2f213367090c30ccad8a65e846fe79")' href=#id1a2f213367090c30ccad8a65e846fe79 aria-expanded=false aria-controls=id1a2f213367090c30ccad8a65e846fe79 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/>实时通信</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id1a2f213367090c30ccad8a65e846fe79 aria-expanded=false aria-controls=id1a2f213367090c30ccad8a65e846fe79><i class="fa-solid fa-angle-right" id=caret-id1a2f213367090c30ccad8a65e846fe79></i></a></div><ul class="nav docs-sidenav collapse" id=id1a2f213367090c30ccad8a65e846fe79><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/socketio/>SocketIO</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/%E8%81%8A%E5%A4%A9%E5%AE%A4/>聊天室</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/>实时通信</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3b2b65d85e2e0696dae835e646373f58")' href=#id3b2b65d85e2e0696dae835e646373f58 aria-expanded=false aria-controls=id3b2b65d85e2e0696dae835e646373f58 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B/>系统进程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id3b2b65d85e2e0696dae835e646373f58 aria-expanded=false aria-controls=id3b2b65d85e2e0696dae835e646373f58><i class="fa-solid fa-angle-right" id=caret-id3b2b65d85e2e0696dae835e646373f58></i></a></div><ul class="nav docs-sidenav collapse" id=id3b2b65d85e2e0696dae835e646373f58><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B/%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84/>多进程架构</a></li><li class="child level"><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/>命令执行</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#内容提点>内容提点</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>吞吐量优化</h1><div class=article-style><ul><li><a href=https://zhuanlan.zhihu.com/p/25276558 target=_blank rel=noopener>多个提高 Node.js 应用吞吐量的小优化技巧介绍</a>翻译自 InfoQ 英文站的 <a href=https://www.infoq.com/articles/node-micro-optimizations-javascript target=_blank rel=noopener>node-micro-optimizations-javascript</a> 一文，从属于笔者的<a href=https://github.com/wx-chevalier/Web-Frontend-Introduction-And-Engineering-Practices target=_blank rel=noopener>Web 前端入门与工程实践</a>。</li></ul><h1 id=多个提高-nodejs-应用吞吐量的小优化技巧介绍>多个提高 Node.js 应用吞吐量的小优化技巧介绍</h1><h2 id=内容提点>内容提点</h2><ul><li>尽可能地使用聚合 IO 操作，以批量写的方式来最小化系统调用的次数。</li><li>需要将发布的开销考虑进内，清除应用中不同的定时器。</li><li>CPU 分析器能够给你提高一些有用信息，但是并不能完整地反馈整个流程。</li><li>谨慎使用 ECMAScript 高级语法，特别是你还未使用最新的 JavaScript 引擎或者类似于 Babel 这样的转换器的时候。</li><li>要洞察你的依赖树的组成并且对你使用的依赖进行适当的性能评测</li></ul><p>当我们希望去优化某个包含了 IO 功能的应用性能时，我们需要对于应用耗费的 CPU 周期以及那些妨碍到应用并行化执行的因素了如指掌。本文则是分享我在提升 Apache Cassandra 项目中的<a href=https://github.com/datastax/nodejs-driver target=_blank rel=noopener>DataStax Node.js 驱动</a>时的一些思考与总结出的导致应用吞吐量降级的关键因素。</p><h1 id=背景>背景</h1><p>Node.js 使用的标准 JavaScript 引擎 V8 会将 JavaScript 代码编译为机器码然后以本地代码的方式运行。V8 引擎使用了如下三个组件来同时保证较低的启动时间与最佳性能表现：</p><ul><li>能够快速将 JavaScript 代码编译为机器码的通用编译器。</li><li>能够自动追踪应用中代码执行时间并且决定应该优化哪些代码模块的运行时分析器。</li><li>能够自动优化被分析器标注的待优化代码的优化编译器；并且如果操作被认为是过优化，该编译器还能自动地进行逆优化操作。</li></ul><p>尽管优化编译器能够保证最佳的性能表现，但是它并不会对所有的代码进行优化，特别是那些不合适的代码编写模式。你可以参考<a href=https://github.com/GoogleChrome/devtools-docs/issues/53 target=_blank rel=noopener>来自 Google Chrome DevTools 团队的建议</a>来了解哪些代码模式是 V8 拒绝优化的，典型的包括：</p><ul><li>包含<code>try-catch</code>语句的函数</li><li>使用<code>arguments</code>对象对函数参数进行重新赋值</li></ul><p>虽然优化编译器能够显著提升代码允许速度，但是对于典型的 IO 密集型的应用，大部分的性能优化还是依赖于指令重排以及避免高占用的调用来提高每秒的操作执行数目；这也会是我们在接下来的章节中需要讨论的部分。</p><h1 id=测试基准>测试基准</h1><p>为了能够更好地发现那些可以惠及最多用户的优化技巧，我们需要模拟真实用户场景，根据常用任务执行的工作量来定义测试基准。首先我们需要测试 API 入口点的吞吐量与时延；除此之外如果希望获取更多的信息，你也可以选择对于内部调用方法进行性能评测。推荐使用<code>process.hrtime()</code>来获取实时解析与执行时长。虽然可能会对项目开发造成些许不便，但我还是建议尽可能早地在开发周期中引入性能评测。可以选择先从一些方法调用进行吞吐量测试，然后再慢慢地增加譬如时延分布这些相对复杂的测试。</p><h1 id=cpu-分析>CPU 分析</h1><p>目前有多种 CPU 分析器可供我们使用，其中 Node.js 本身提供的开箱即用的 CPU 分析器已经能应付大部分的使用场景。<a href=https://nodejs.org/en/docs/guides/simple-profiling/ target=_blank rel=noopener>内建的 Node.js 分析器</a>源于 V8 内置的分析器，它能够以固定地频率对栈信息进行采样；你可以在运行 node 命令时使用<code>--prof</code>参数来创建 V8 标记文件。然后你可以对分析结果进行聚合转化处理，通过使用<code>--prof-process</code>参数将其转化为可读性更好的文本：</p><pre tabindex=0><code>$ node --prof-process isolate-0xnnnnnnnnnnnn-v8.log &gt; processed.txt
</code></pre><p>在编辑器中打开经过处理的记录文件，你可以看到整个记录被划分为了部分，首先我们来看下<code>Summary</code>部分，其格式如下所示：</p><pre tabindex=0><code> [Summary]:

  ticks   total   nonlib  name

  20109   41.2%   45.7%  JavaScript

  23548   48.3%   53.5%  C++

    805    1.7%    1.8%  GC

   4774    9.8%          Shared libraries

    356    0.7%          Unaccounted
</code></pre><p>上面的值分别代表了在 JavaScript/C++代码以及垃圾收集器中的采样频次，其会随着分析代码的不同而变化。然后你可以根据需要分别查看具体的子部分(譬如[JavaScript], [C++], &mldr;)来了解具体的采样信息。除此之外，分析文件中还包含一个叫做<code>[Bottom up (heavy) profile]</code>的非常有用的部分，它以树形结构展示了买个函数的调用者，其基本格式如下：</p><pre tabindex=0><code>223  32%      LazyCompile: *function1 lib/file1.js:223:20

221  99%        LazyCompile: ~function2 lib/file2.js:70:57

221  100%         LazyCompile: *function3 /lib/file3.js:58:74
</code></pre><p>上面的百分比代表该层调用者占目标函数所有调用者数目的比重，而函数之前的星号意味着该函数是经过优化处理的，而波浪号代表该函数是未经过优化的。在上面的例子中，<code>function1</code>99%的调用是由<code>function2</code>发起的，而<code>function3</code>占据了<code>function2</code>100%的调用占比。CPU 分析结果与<a href=http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html target=_blank rel=noopener>火焰图</a>是非常有用的分析栈占用与 CPU 耗时的工具。不过需要注意的是，这些分析结果并不意味着全部，大量的异步 IO 操作会让分析变得不那么容易。</p><h1 id=系统调用>系统调用</h1><p>Node.js 利用 Libuv 提供的平台无关的接口来实现非阻塞型 IO，应用程序中所有的 IO 操作(sockets, 文件系统, &mldr;)都会被转化为系统调用。而调度这些系统调用会耗费大量的时间，因此我们需要尽可能地聚合 IO 操作，以批量写的方式来最小化系统调用的次数。具体而言，我们应该将 Socket 或者文件流放入到缓冲中然后一次性处理而不是对每个操作进行单独处理。你可以使用写队列来管理你的所有写操作，常用的写队列的实现逻辑如下：</p><ul><li>当我们需要进行写操作并且在某个处理窗口期内：<ul><li>将该缓冲区添加到待写列表中</li></ul></li><li>连接所有的缓冲区并且一次性的写入到目标管道中。</li></ul><p>你可以基于总的缓冲区长度或者第一个元素进入队列的时间来定义窗口尺寸，不过在定义窗口尺寸时我们需要权衡考虑单个写操作的时延与整体写操作的时延，不能厚此薄彼。你也需要同时考虑能够聚合的写操作的最大数目以及单个写请求的开销。你可能会以千字节为单位决定一个写队列的上限，我们的经验发现 8 千字节左右是个不错的临界点；当然根据你应用的具体场景这个值肯定会有变化，你可以参考<a href=https://github.com/datastax/nodejs-driver/blob/v3.1.6/lib/writers.js#L159 target=_blank rel=noopener>我们的这个写队列的完整实现</a>。总结而言，当我们采用了批量写之后系统调用的数目大大降低了，最终提升了应用的整体吞吐量。</p><h1 id=nodejs-定时器>Node.js 定时器</h1><p>Node.js 中的定时器与 window 中的定时器具有相同的 API，可以很方便地实现简单的调度操作；在整个生态系统中有很广泛的应用，因此我们的应用中可能充斥着大量的延时调用。类似于其他<a href=http://cseweb.ucsd.edu/users/varghese/PAPERS/twheel.ps.Z target=_blank rel=noopener>基于哈希的轮转调度器</a>，Node.js 使用哈希表与链表来维护定时器实例。不过有别于其他的轮转调度器，Node.js 并没有维持固定长度的哈希表，而是根据触发时间对定时器建立索引。添加新的定时器实例时，如果 Node.js 发现已经存在了相同的键值(有相同触发事件的定时器)，那么会以 O(1)复杂度完成添加操作。如果还不存在该键值，则会创建新的桶然后将定时器添加到该桶中。需要铭记于心的是，我们应该尽可能地重用已存在的定时器存放桶，避免移除整个桶然后再创建一个新的这种耗时的操作。举例而言，如果你使用滑动延时，那么应该在使用<code>clearTimeout()</code>移除定时器之前使用<code>setTimeout()</code>创建新的定时器。我们对于心跳包的处理中在移除上一个定时器之前会先确定下以 O(1)复杂度调度空闲的定时器。</p><h1 id=ecmascript-语言特性>Ecmascript 语言特性</h1><p>当我们着眼于整体的性能保障时，我们需要避免使用部分 Ecmascript 中的高级语言特性，典型的譬如:<a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Function/bind target=_blank rel=noopener>Function.prototype.bind()</a>, <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty target=_blank rel=noopener>Object.defineProperty()</a> 以及 <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperties target=_blank rel=noopener>Object.defineProperties()</a>。我们可以在 JavaScript 引擎的实现描述或者问题中发现这些特性的性能缺陷所在，譬如<a href=http://v8project.blogspot.com.es/2016/07/v8-release-53.html target=_blank rel=noopener>Improvement in </a><a href=http://v8project.blogspot.com.es/2016/07/v8-release-53.html target=_blank rel=noopener>Promise</a><a href=http://v8project.blogspot.com.es/2016/07/v8-release-53.html target=_blank rel=noopener> performance in V8 5.3</a> 以及 <a href=http://benediktmeurer.de/2015/12/25/a-new-approach-to-function-prototype-bind/ target=_blank rel=noopener>Function.prototype.bind</a><a href=http://benediktmeurer.de/2015/12/25/a-new-approach-to-function-prototype-bind/ target=_blank rel=noopener> performance in V8 5.4</a>。另外你也需要谨慎使用 ES2015 或者 ESNext 中的新的语言特性，它们相较于 ECMAScript 5 中的语法会慢很多。<a href=https://fhinkel.github.io/six-speed target=_blank rel=noopener>six-speed 项目网站</a>就追踪了这些语言特性在不同的 JavaScript 引擎上的性能表现，如果你尚未发现某些特性的性能评测你也可以自己进行一些测试。V8 团队也一直致力于提高新的语言特性的性能表现，最终使其与底层实现保持一致。我们可以在<a href=https://docs.google.com/document/d/1EA9EbfnydAmmU_lM8R_uEMQ-U_v4l9zulePSBkeYWmY target=_blank rel=noopener>性能规划</a>中随时了解他们对于 ES2015 性能优化的工作进展，这里他们会收集使用者对于提升点的建议并且发布新的设计文档来阐述他们的解决方案。你也可以在<a href=http://v8project.blogspot.com/ target=_blank rel=noopener>这个博客</a>随时了解 V8 的实现进展，不过考虑到 V8 的提升可能需要较长的时间才能合并入 LTS 版本的 Node.js: 根据<a href=https://github.com/nodejs/LTS target=_blank rel=noopener>LTS 规划</a>只有在 Node.js 大版本迭代时才会合并进最新的 V8 版本。你可能要等待 6-12 月才能发现新的 V8 引擎被合并进入 Node.js 的运行环境中，而目前 Node.js 的新的发布版本只会包含<a href=https://nodejs.org/en/download/releases/ target=_blank rel=noopener>V8 引擎中的部分修复</a>。</p><h1 id=依赖>依赖</h1><p>Node.js 运行时为我们提供了完整的 IO 操作库，但是 ECMAScript 语法标准则仅提供了寥寥无几的内建数据类型，很多时候我们不得不依赖第三方的库来进行某些基本任务。没有人能保证这些第三方的库可以准确高效地工作，即使那些流行的明星模块也可能存在问题。Node.js 的生态系统是如此的繁荣茂盛，可能很多依赖模块中只包含几个你自己很方便就能实现的方法。我们需要在重复造轮子的代价与依赖带来的性能不可控之间做一个权衡。我们团队会尽可能地避免引入新的依赖，并且对所有的依赖持保守态度。不过对于<a href=https://github.com/petkaantonov/bluebird/blob/master/docs/docs/benchmarks.md target=_blank rel=noopener>bluebird</a>这样本身发布了可信赖的性能评测的库我们是很欢迎的。我们的项目中使用<a href=https://github.com/caolan/async target=_blank rel=noopener>async</a>来处理异步操作，在代码库中广泛地使用了<a href=https://caolan.github.io/async/docs.html#series target=_blank rel=noopener>async.series()</a>, <a href=https://caolan.github.io/async/docs.html#waterfall target=_blank rel=noopener>async.waterfall()</a> 以及 <a href=https://caolan.github.io/async/docs.html#whilst target=_blank rel=noopener>async.whilst()</a>。确实我们很难说这样连接了多个层次的异步处理库就是性能受损的罪魁祸首，幸好有很多其他开发者定位了其中存在的问题。我们也可以选择类似于<a href=https://github.com/suguru03/neo-async target=_blank rel=noopener>neo-async</a>这样的替代库，它的运行效率明显提高并且也有公开的性能评测结果。</p><h1 id=总结>总结</h1><p>本文中提及的优化技巧有的属于常识，有的则是涉及到 Node.js 生态系统以及 JavaScript 核心引擎的实现细节与工作原理。在我们开发的客户端驱动中，通过引入这些优化手段我们达成了两倍的吞吐量的提升。考虑到我们的 Node.js 应用以单线程方式运行，我们应用占据 CPU 的时间片与指令的排布顺序会大大影响整体的吞吐量与高平行的实现程度。</p><h1 id=关于作者>关于作者</h1><p>Jorge Bay 是 Apache Cassandra 项目中 Node.js 以及 C#客户端驱动的核心工程师，同时还是 DataStax 的 DSE。他乐于解决问题与提供服务端解决方案，Jorge 拥有超过 15 年的专业软件开发经验，他为 Apache Cassandra 实现的 Node.js 客户端驱动同样也是 DataStax 官方驱动的基础</p></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/ rel=next>安全加固</a></div><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/node-notes/02.%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ rel=prev>性能优化</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>