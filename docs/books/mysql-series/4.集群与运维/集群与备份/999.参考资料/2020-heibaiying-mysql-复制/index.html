<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="MySQL 复制 一、日志格式 1.1 二进制日志格式 MySQL 二进制日志是进行主从复制的基础，它记录了所有对 MySQL 数据库的修改事件，包括增删改查和表结构修改。当前 MySQL 一共支持三种二进制日志格式，可以通过 binlog-format 参数来进行控制，其可选值如下"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-mysql-%E5%A4%8D%E5%88%B6/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-mysql-%E5%A4%8D%E5%88%B6/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-mysql-%E5%A4%8D%E5%88%B6/"><meta property="og:title" content="2020-heibaiying-MySQL 复制 | Next-gen Tech Edu"><meta property="og:description" content="MySQL 复制 一、日志格式 1.1 二进制日志格式 MySQL 二进制日志是进行主从复制的基础，它记录了所有对 MySQL 数据库的修改事件，包括增删改查和表结构修改。当前 MySQL 一共支持三种二进制日志格式，可以通过 binlog-format 参数来进行控制，其可选值如下"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>2020-heibaiying-MySQL 复制 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=c1a86f7a2383ba88a3a754107603c5e7><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">999.参考资料</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id77f3e921ea019ff8ef4c3b6c1acefe6e")' href=#id77f3e921ea019ff8ef4c3b6c1acefe6e aria-expanded=false aria-controls=id77f3e921ea019ff8ef4c3b6c1acefe6e aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/>集群与备份</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id77f3e921ea019ff8ef4c3b6c1acefe6e aria-expanded=false aria-controls=id77f3e921ea019ff8ef4c3b6c1acefe6e><i class="fa-solid fa-angle-down" id=caret-id77f3e921ea019ff8ef4c3b6c1acefe6e></i></a></div><ul class="nav docs-sidenav collapse show" id=id77f3e921ea019ff8ef4c3b6c1acefe6e><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idbcf5941f450f622faaeb39e04ea1862c")' href=#idbcf5941f450f622faaeb39e04ea1862c aria-expanded=false aria-controls=idbcf5941f450f622faaeb39e04ea1862c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idbcf5941f450f622faaeb39e04ea1862c aria-expanded=false aria-controls=idbcf5941f450f622faaeb39e04ea1862c><i class="fa-solid fa-angle-right" id=caret-idbcf5941f450f622faaeb39e04ea1862c></i></a></div><ul class="nav docs-sidenav collapse" id=idbcf5941f450f622faaeb39e04ea1862c><li class="child level"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-mysql-%E5%A4%8D%E5%88%B6/>2020-heibaiying-MySQL 复制</a></li><li class="child level"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/>2020-heibaiying-数据备份与恢复</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idc9f62afd64ea9a5751009a7f566b7c28")' href=#idc9f62afd64ea9a5751009a7f566b7c28 aria-expanded=false aria-controls=idc9f62afd64ea9a5751009a7f566b7c28 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>999.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idc9f62afd64ea9a5751009a7f566b7c28 aria-expanded=false aria-controls=idc9f62afd64ea9a5751009a7f566b7c28><i class="fa-solid fa-angle-down" id=caret-idc9f62afd64ea9a5751009a7f566b7c28></i></a></div><ul class="nav docs-sidenav collapse show" id=idc9f62afd64ea9a5751009a7f566b7c28><li class="child level active"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-mysql-%E5%A4%8D%E5%88%B6/>2020-heibaiying-MySQL 复制</a></li><li class="child level"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/>2020-heibaiying-数据备份与恢复</a></li></ul></div><li class="child level"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/binlog/>Binlog</a></li><li class="child level"><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/%E4%B8%BB%E5%A4%87%E5%A4%8D%E5%88%B6/>主备复制</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#一日志格式>一、日志格式</a><ul><li><a href=#11-二进制日志格式>1.1 二进制日志格式</a></li><li><a href=#12-binlog_row_image>1.2 binlog_row_image</a></li></ul></li><li><a href=#二基于二进制日志的复制>二、基于二进制日志的复制</a><ul><li><a href=#21-复制原理>2.1 复制原理</a></li><li><a href=#22-配置步骤>2.2 配置步骤</a></li><li><a href=#23-优缺点>2.3 优缺点</a></li></ul></li><li><a href=#三基于-gtid-的复制>三、基于 GTID 的复制</a><ul><li><a href=#21-gtid-简介>2.1 GTID 简介</a></li><li><a href=#22-配置步骤-1>2.2 配置步骤</a></li><li><a href=#23-优缺点-1>2.3 优缺点</a></li></ul></li><li><a href=#四半同步复制>四、半同步复制</a><ul><li></li></ul></li><li><a href=#五高可用架构>五、高可用架构</a><ul><li><a href=#51-mmm>5.1 MMM</a></li><li><a href=#52-mha>5.2 MHA</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>2020-heibaiying-MySQL 复制</h1><div class=article-style><h1 id=mysql-复制>MySQL 复制</h1><h2 id=一日志格式>一、日志格式</h2><h3 id=11-二进制日志格式>1.1 二进制日志格式</h3><p>MySQL 二进制日志是进行主从复制的基础，它记录了所有对 MySQL 数据库的修改事件，包括增删改查和表结构修改。当前 MySQL 一共支持三种二进制日志格式，可以通过 binlog-format 参数来进行控制，其可选值如下：</p><ul><li><strong>STATEMENT</strong>：段格式。是 MySQL 最早支持的二进制日志格式。其记录的是实际执行修改的 SQL 语句，因此在进行批量修改时其所需要记录的数据量比较小，但对于 UUID() 或者其他依赖上下文的执行语句，可能会在主备上产生不一样的结果。</li><li><strong>ROW</strong>：行格式，是 MySQL 5.7 版本之后默认的二进制日志格式。其记录的是修改前后的数据，因此在批量修改时其需要记录的数据量比较大，但其安全性比较高，不会导致主备出现不一致的情况。同时因为 ROW 格式是在从库上直接应用更改后的数据，其还能减少锁的使用。</li><li><strong>MIXED</strong>：是以上两种日志的混合方式，默认采用段格式进行记录，当段格式不适用时 (如 UUID() )，则默认采用 ROW 格式。</li></ul><p>通常在主备之间网络情况良好的时，可以优先考虑使用 ROW 格式，此时数据一致性最高，其次是 MIXED 格式。在设置 ROW 格式时，还有一个非常重要的参数 binlog_row_image ：</p><h3 id=12-binlog_row_image>1.2 binlog_row_image</h3><p>binlog_row_image 有以下三个可选值：</p><ul><li><p><strong>full</strong>：默认值，记录行在修改前后所有列的值。</p></li><li><p><strong>minimal</strong>：只记录修改涉及列的值。</p></li><li><p><strong>noblob</strong>：与 full 类似，但如果 BLOB 或 TEXT 列没有修改，则不对其进行记录。</p></li></ul><p>binlog-format 和 binlog_row_image 的默认值可能在不同版本存在差异，可以使用以下命令进行查看。通常情况下，为了减少在主备复制中需要传输的数据量，可以将 binlog_row_image 的值设置为 minimal 或 noblob。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;binlog_format&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;binlog_row_image&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=二基于二进制日志的复制>二、基于二进制日志的复制</h2><h3 id=21-复制原理>2.1 复制原理</h3><p>MySQL 的复制原理如下图所示：</p><ul><li>主库首先将变更写入到自己的二进制日志中；</li><li>备库会启动一个 IO 线程，然后主动去主库节点上获取变更日志，并写入到自己的中继日志中。</li><li>之后从中继日志中读取变更事件，在从库上执行变更。</li><li>当备库与主库数据状态一致，备库的 IO 线程就会进入睡眠。当主库再次发生变更时，其会向备库发出信号，唤醒 IO 线程并再次进行工作。</li></ul><p>如果没有进行任何配置，主库在将变更写入到二进制日志后，就会返回对客户端的响应，因此默认情况下的复制是完全异步进行的，主备之间可能会短暂存在数据不一致的情况。</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/mysql-replication.jpg></div><h3 id=22-配置步骤>2.2 配置步骤</h3><p>首先主节点需要开启二进制日志，并且在同一个复制环境下，主备节点的 server-id 需要不一样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=err>[mysqld]</span>
</span></span><span class=line><span class=cl><span class=na>server-id</span> <span class=o>=</span> <span class=s>226</span>
</span></span><span class=line><span class=cl><span class=c1># 开启二进制日志</span>
</span></span><span class=line><span class=cl><span class=na>log-bin</span><span class=o>=</span><span class=s>mysql-bin</span>
</span></span></code></pre></div><p>在备份节点配置中继日志：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=err>[mysqld]</span>
</span></span><span class=line><span class=cl><span class=na>server-id</span> <span class=o>=</span> <span class=s>227</span>
</span></span><span class=line><span class=cl><span class=c1># 配置中继日志</span>
</span></span><span class=line><span class=cl><span class=na>relay_log</span>  <span class=o>=</span> <span class=s>mysql-relay-bin</span>
</span></span><span class=line><span class=cl><span class=c1># 为了保证数据的一致性，从节点应该设置为只读</span>
</span></span><span class=line><span class=cl><span class=na>read_only</span> <span class=o>=</span> <span class=s>1</span>
</span></span><span class=line><span class=cl><span class=c1># 以下两个配置代表是否开启二进制日志，如果该从节点还作为其他备库的主节点，则开启，否则不用配置</span>
</span></span><span class=line><span class=cl><span class=na>log-bin</span> <span class=o>=</span> <span class=s>mysql-bin</span>
</span></span><span class=line><span class=cl><span class=c1># 是否将中继节点收到的复制事件写到自己的二进制日志中</span>
</span></span><span class=line><span class=cl><span class=na>log_slave_updates</span> <span class=o>=</span> <span class=s>1</span>
</span></span></code></pre></div><p>登录主节点 MySQL 服务，创建用于进行复制账号，并为其授予权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CREATE USER <span class=s1>&#39;repl&#39;</span>@<span class=s1>&#39;192.168.0.%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class=s1>&#39;123456&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT REPLICATION SLAVE on *.* TO <span class=s1>&#39;repl&#39;</span>@<span class=s1>&#39;192.168.0.%&#39;</span> <span class=p>;</span>
</span></span></code></pre></div><p>查看主节点二进制日志的状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql&gt; SHOW MASTER STATUS<span class=p>;</span>
</span></span><span class=line><span class=cl>+------------------+----------+--------------+------------------+-------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> File             <span class=p>|</span> Position <span class=p>|</span> Binlog_Do_DB <span class=p>|</span> Binlog_Ignore_DB <span class=p>|</span> Executed_Gtid_Set <span class=p>|</span>
</span></span><span class=line><span class=cl>+------------------+----------+--------------+------------------+-------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> mysql-bin.000001 <span class=p>|</span>      <span class=m>887</span> <span class=p>|</span>              <span class=p>|</span>                  <span class=p>|</span>                   <span class=p>|</span>
</span></span><span class=line><span class=cl>+------------------+----------+--------------+------------------+-------------------+
</span></span></code></pre></div><p>基于日志和偏移量，建立复制链路：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CHANGE MASTER TO <span class=nv>MASTER_HOST</span><span class=o>=</span><span class=s1>&#39;192.168.0.226&#39;</span>,<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         <span class=nv>MASTER_USER</span><span class=o>=</span><span class=s1>&#39;repl&#39;</span>,    <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nv>MASTER_PASSWORD</span><span class=o>=</span><span class=s1>&#39;123456&#39;</span>,<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nv>MASTER_LOG_FILE</span><span class=o>=</span><span class=s1>&#39;mysql-bin.000001&#39;</span>,<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nv>MASTER_LOG_POS</span><span class=o>=</span>887<span class=p>;</span>
</span></span></code></pre></div><p>开始复制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>START SLAVE<span class=p>;</span>
</span></span></code></pre></div><p>查看从节点复制状态，主要参数有 Slave_IO_Running 和 Slave_SQL_Running，其状态都为 Yes 表示用于复制的 IO 进程已经开启。Seconds_Behind_Master 参数表示从节点复制的延迟量。此时可以在主库上进行任意更改，并在备库上查看情况。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql&gt; SHOW SLAVE STATUS<span class=se>\G</span>
</span></span><span class=line><span class=cl>*************************** 1. row ***************************
</span></span><span class=line><span class=cl>               Slave_IO_State: Waiting <span class=k>for</span> master to send event
</span></span><span class=line><span class=cl>                  Master_Host: 192.168.0.226
</span></span><span class=line><span class=cl>                  Master_User: repl
</span></span><span class=line><span class=cl>                  Master_Port: <span class=m>3306</span>
</span></span><span class=line><span class=cl>                Connect_Retry: <span class=m>60</span>
</span></span><span class=line><span class=cl>              Master_Log_File: mysql-bin.000001
</span></span><span class=line><span class=cl>          Read_Master_Log_Pos: <span class=m>887</span>
</span></span><span class=line><span class=cl>               Relay_Log_File: mysql-relay-bin.000002
</span></span><span class=line><span class=cl>                Relay_Log_Pos: <span class=m>322</span>
</span></span><span class=line><span class=cl>        Relay_Master_Log_File: mysql-bin.000001
</span></span><span class=line><span class=cl>        <span class=c1>#    Slave_IO_Running: Yes</span>
</span></span><span class=line><span class=cl>        <span class=c1>#   Slave_SQL_Running: Yes</span>
</span></span><span class=line><span class=cl>              Replicate_Do_DB:
</span></span><span class=line><span class=cl>          Replicate_Ignore_DB:
</span></span><span class=line><span class=cl>           Replicate_Do_Table:
</span></span><span class=line><span class=cl>       Replicate_Ignore_Table:
</span></span><span class=line><span class=cl>      Replicate_Wild_Do_Table:
</span></span><span class=line><span class=cl>  Replicate_Wild_Ignore_Table:
</span></span><span class=line><span class=cl>                   Last_Errno: <span class=m>0</span>
</span></span><span class=line><span class=cl>                   Last_Error:
</span></span><span class=line><span class=cl>                 Skip_Counter: <span class=m>0</span>
</span></span><span class=line><span class=cl>          Exec_Master_Log_Pos: <span class=m>887</span>
</span></span><span class=line><span class=cl>              Relay_Log_Space: <span class=m>530</span>
</span></span><span class=line><span class=cl>              Until_Condition: None
</span></span><span class=line><span class=cl>               Until_Log_File:
</span></span><span class=line><span class=cl>                Until_Log_Pos: <span class=m>0</span>
</span></span><span class=line><span class=cl>           Master_SSL_Allowed: No
</span></span><span class=line><span class=cl>           Master_SSL_CA_File:
</span></span><span class=line><span class=cl>           Master_SSL_CA_Path:
</span></span><span class=line><span class=cl>              Master_SSL_Cert:
</span></span><span class=line><span class=cl>            Master_SSL_Cipher:
</span></span><span class=line><span class=cl>               Master_SSL_Key:
</span></span><span class=line><span class=cl>     <span class=c1>#  Seconds_Behind_Master: 0</span>
</span></span><span class=line><span class=cl>Master_SSL_Verify_Server_Cert: No
</span></span><span class=line><span class=cl>                Last_IO_Errno: <span class=m>0</span>
</span></span><span class=line><span class=cl>                Last_IO_Error:
</span></span><span class=line><span class=cl>               Last_SQL_Errno: <span class=m>0</span>
</span></span><span class=line><span class=cl>               Last_SQL_Error:
</span></span><span class=line><span class=cl>  Replicate_Ignore_Server_Ids:
</span></span><span class=line><span class=cl>             Master_Server_Id: <span class=m>226</span>
</span></span><span class=line><span class=cl>   <span class=c1>#              Master_UUID: e1148574-bdd0-11e9-8873-0800273acbfd</span>
</span></span><span class=line><span class=cl>             Master_Info_File: mysql.slave_master_info
</span></span><span class=line><span class=cl>                    SQL_Delay: <span class=m>0</span>
</span></span><span class=line><span class=cl>          SQL_Remaining_Delay: NULL
</span></span><span class=line><span class=cl>      Slave_SQL_Running_State: Slave has <span class=nb>read</span> all relay log<span class=p>;</span> waiting <span class=k>for</span> more updates
</span></span><span class=line><span class=cl>           Master_Retry_Count: <span class=m>86400</span>
</span></span><span class=line><span class=cl>                  Master_Bind:
</span></span><span class=line><span class=cl>      Last_IO_Error_Timestamp:
</span></span><span class=line><span class=cl>     Last_SQL_Error_Timestamp:
</span></span><span class=line><span class=cl>               Master_SSL_Crl:
</span></span><span class=line><span class=cl>           Master_SSL_Crlpath:
</span></span><span class=line><span class=cl>           Retrieved_Gtid_Set:
</span></span><span class=line><span class=cl>            Executed_Gtid_Set:
</span></span><span class=line><span class=cl>                Auto_Position: <span class=m>0</span>
</span></span><span class=line><span class=cl>         Replicate_Rewrite_DB:
</span></span><span class=line><span class=cl>                 Channel_Name:
</span></span><span class=line><span class=cl>           Master_TLS_Version:
</span></span><span class=line><span class=cl>       Master_public_key_path:
</span></span><span class=line><span class=cl>        Get_master_public_key: <span class=m>0</span>
</span></span><span class=line><span class=cl>            Network_Namespace:
</span></span><span class=line><span class=cl><span class=m>1</span> row in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span></code></pre></div><h3 id=23-优缺点>2.3 优缺点</h3><p>基于二进制日志的复制是 MySQL 最早使用的复制技术，因此 MySQL 对其的支持比较完善，对执行修改的 SQL 语句几乎没有任何限制。其主要的缺点是在一主多从的高可用复制架构中，如果主库发生宕机，此时想要自动通过从库的日志和偏移量来确定新的主库比较困难。</p><h2 id=三基于-gtid-的复制>三、基于 GTID 的复制</h2><h3 id=21-gtid-简介>2.1 GTID 简介</h3><p>MySQL 5.6 版本之后提供了一个新的复制模式：基于 GTID 的复制。GTID 全称为 Global Transaction ID，即全局事务 ID。它由每个服务节点的唯一标识和其上的事务 ID 共同组成，格式为： <em>server_uuid : transaction_id</em> 。通过 GTID ，可以保证在主库上的每一个事务都能在备库上得到执行，不会存在任何疏漏。</p><h3 id=22-配置步骤-1>2.2 配置步骤</h3><p>主从服务器均增加以下 GTID 的配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>gtid-mode</span> <span class=o>=</span> <span class=s>ON</span>
</span></span><span class=line><span class=cl><span class=c1># 防止执行不受支持的语句，下文会有说明</span>
</span></span><span class=line><span class=cl><span class=na>enforce-gtid-consistency</span> <span class=o>=</span> <span class=s>ON</span>
</span></span></code></pre></div><p>如果配置过上面的基于二进制日志的复制，还需要在从服务器上执行以下命令，关闭原有复制链路：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>STOP SLAVE IO_THREAD FOR CHANNEL <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>建立新的基于 GTID 复制链路，指定 <code>MASTER_AUTO_POSITION = 1</code> 表示由程序来自动确认开始同步的 GTID 的位置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CHANGE MASTER TO <span class=nv>MASTER_HOST</span><span class=o>=</span><span class=s1>&#39;192.168.0.226&#39;</span>,<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nv>MASTER_USER</span><span class=o>=</span><span class=s1>&#39;repl&#39;</span>,
</span></span><span class=line><span class=cl>        <span class=nv>MASTER_PASSWORD</span><span class=o>=</span><span class=s1>&#39;123456&#39;</span>,
</span></span><span class=line><span class=cl>        <span class=nv>MASTER_AUTO_POSITION</span><span class=o>=</span>1<span class=p>;</span>
</span></span></code></pre></div><p>开始复制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>START SLAVE<span class=p>;</span>
</span></span></code></pre></div><p>在主节点上执行任意修改操作，并查看从节点状态，关键的输出如下：Retrieved_Gtid_Set 代表从主节点上接收到的两个事务，Executed_Gtid_Set 表示这两个事务已经在从库上得到执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=n>STATUS</span><span class=err>\</span><span class=k>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master_UUID</span><span class=w>            </span><span class=p>:</span><span class=w> </span><span class=n>e1148574</span><span class=o>-</span><span class=n>bdd0</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=mi>8873</span><span class=o>-</span><span class=mi>0800273</span><span class=n>acbfd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Retrieved_Gtid_Set</span><span class=w>    </span><span class=p>:</span><span class=w> </span><span class=n>e1148574</span><span class=o>-</span><span class=n>bdd0</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=mi>8873</span><span class=o>-</span><span class=mi>0800273</span><span class=n>acbfd</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Executed_Gtid_Set</span><span class=w>    </span><span class=p>:</span><span class=w> </span><span class=n>e1148574</span><span class=o>-</span><span class=n>bdd0</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=mi>8873</span><span class=o>-</span><span class=mi>0800273</span><span class=n>acbfd</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.....</span><span class=w>
</span></span></span></code></pre></div><h3 id=23-优缺点-1>2.3 优缺点</h3><p>GTID 复制的优点在于程序可以自动确认开始复制的 GTID 点。但其仍然存在以下限制：</p><ul><li><p>不支持 CREATE TABLE &mldr; SELECT 语句。 因为在 ROW 格式下，该语句将会被记录为具有不同 GTID 的两个事务，此时从服务器将无法正确处理。</p></li><li><p>事务，过程，函数和触发器内部的 CREATE TEMPORARY TABLE 和 DROP TEMPORARY TABLE 语句均不受支持。</p></li></ul><p>为防止执行不受支持的语句，建议配置和上文配置一样，开启 enforce-gtid-consistency 属性， 开启后在主库上执行以上不受支持的语句都将抛出异常并提示。</p><h2 id=四半同步复制>四、半同步复制</h2><p>在上面我们介绍过，不论是基于二进制日志的复制还是基于 GTID 的复制，其本质上都是异步复制，假设从节点还没有获取到二进制日志信息时主节点就宕机了，那么就会存在数据不一致的问题。想要解决这个问题可以通过配置半同步复制来实现：进行半同步复制时，主节点会等待至少一个从节点获取到二进制日志后才将事务的执行结果返回给客户端。具体配置步骤如下：</p><h4 id=1-安装插件>1. 安装插件</h4><p>MySQL 从 5.5 之后开始以插件的形式支持半同步复制，所以先需要先进行插件的安装，命令如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 主节点上执行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>INSTALL</span><span class=w> </span><span class=n>PLUGIN</span><span class=w> </span><span class=n>rpl_semi_sync_master</span><span class=w> </span><span class=n>SONAME</span><span class=w> </span><span class=s1>&#39;semisync_master.so&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 从节点上执行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=n>INSTALL</span><span class=w> </span><span class=n>PLUGIN</span><span class=w> </span><span class=n>rpl_semi_sync_slave</span><span class=w> </span><span class=n>SONAME</span><span class=w> </span><span class=s1>&#39;semisync_slave.so&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>如果你的复制是基于高可用架构的，即从节点可能会在主节点宕机后成为新的主节点，而原主节点可能在失败恢复后成为从节点，那么为了保证半同步复制仍然有效，此时可以在主从节点上都安装主从插件。安装后使用以下命令查看是否安装成功：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME LIKE <span class=s1>&#39;%semi%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>+----------------------+---------------+
</span></span><span class=line><span class=cl><span class=p>|</span> PLUGIN_NAME          <span class=p>|</span> PLUGIN_STATUS <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------+---------------+
</span></span><span class=line><span class=cl><span class=p>|</span> rpl_semi_sync_master <span class=p>|</span> ACTIVE        <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> rpl_semi_sync_slave  <span class=p>|</span> ACTIVE        <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------+---------------+
</span></span></code></pre></div><h4 id=2-配置半同步复制>2. 配置半同步复制</h4><p>半同步复制可以基于日志复制或 GTID 复制开启，只需要在其原有配置上增加以下配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># 主节点上增加如下配置：</span>
</span></span><span class=line><span class=cl><span class=na>plugin-load</span><span class=o>=</span><span class=s>rpl_semi_sync_master=semisync_master.so</span>
</span></span><span class=line><span class=cl><span class=na>rpl_semi_sync_master_enabled</span><span class=o>=</span><span class=s>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点上增加如下配置：</span>
</span></span><span class=line><span class=cl><span class=na>plugin-load</span><span class=o>=</span><span class=s>rpl_semi_sync_slave=semisync_slave.so</span>
</span></span><span class=line><span class=cl><span class=na>rpl_semi_sync_slave_enabled</span><span class=o>=</span><span class=s>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 和上面提到的一样，如果是高可用架构下，则主从节点都可以增加主从配置：</span>
</span></span><span class=line><span class=cl><span class=na>plugin-load</span> <span class=o>=</span> <span class=s>&#34;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so&#34;</span>
</span></span><span class=line><span class=cl><span class=na>rpl-semi-sync-master-enabled</span> <span class=o>=</span> <span class=s>1</span>
</span></span><span class=line><span class=cl><span class=na>rpl-semi-sync-slave-enabled</span> <span class=o>=</span> <span class=s>1</span>
</span></span></code></pre></div><h4 id=3-启动复制>3. 启动复制</h4><p>按照二进制日志或 GTID 的方式正常启动复制即可，此时可以使用如下命令查看半同步日志是否正在执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 主节点</span>
</span></span><span class=line><span class=cl>mysql&gt; SHOW STATUS LIKE <span class=s1>&#39;Rpl_semi_sync_master_status&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>+-----------------------------+-------+
</span></span><span class=line><span class=cl><span class=p>|</span> Variable_name               <span class=p>|</span> Value <span class=p>|</span>
</span></span><span class=line><span class=cl>+-----------------------------+-------+
</span></span><span class=line><span class=cl><span class=p>|</span> Rpl_semi_sync_master_status <span class=p>|</span> ON    <span class=p>|</span>
</span></span><span class=line><span class=cl>+-----------------------------+-------+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点</span>
</span></span><span class=line><span class=cl>mysql&gt; SHOW STATUS LIKE <span class=s1>&#39;Rpl_semi_sync_slave_status&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>+----------------------------+-------+
</span></span><span class=line><span class=cl><span class=p>|</span> Variable_name              <span class=p>|</span> Value <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------------+-------+
</span></span><span class=line><span class=cl><span class=p>|</span> Rpl_semi_sync_slave_status <span class=p>|</span> ON    <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------------+-------+
</span></span></code></pre></div><p>值为 ON 代表半同步复制配置成功。</p><h4 id=4-可选配置>4. 可选配置</h4><p>半同步日志还有以下两个可选配置：一个是 <code>rpl_semi_sync_master_wait_for_slave_count</code>，它表示主节点需要至少等待几个从节点复制完成，默认值为 1，因为等待过多从节点可能会导致长时间的延迟，所以通常使用默认值即可。另一个常用参数是 <code>rpl_semi_sync_master_wait_point</code> ，它主要是用于控制等待的时间点，它有以下两个可选值：</p><ul><li><strong>AFTER_SYNC</strong>（默认值）：主服务器将每个事务写入其二进制日志，并将二进制日志同步到磁盘后开始进行等待。在收到从节点的确认后，才将事务提交给存储引擎并将结果返回给客户端。</li><li><strong>AFTER_COMMIT</strong>：主服务器将每个事务写入其二进制日志并同步到磁盘，然后将事务提交到存储引擎，提交后再进行等待。在收到从节点的确认后，才将结果返回给客户端。</li></ul><p>第二种方式是 MySQL 5.7.2 之前默认方式，但这种方式会导致数据的丢失，所以在 5.7.2 版本后就引入了第一种方式作为默认方式，它可以实现无损复制 (lossless replication)，数据基本无丢失，因此 <code>rpl_semi_sync_master_wait_point</code> 参数通常也不用进行修改，采用默认值即可。想要查看当前版本该参数的值，可以使用如下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql&gt; SHOW VARIABLES LIKE <span class=s1>&#39;rpl_semi_sync_master_wait_point&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>+---------------------------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span> Variable_name                   <span class=p>|</span> Value      <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------------------------+------------+
</span></span><span class=line><span class=cl><span class=p>|</span> rpl_semi_sync_master_wait_point <span class=p>|</span> AFTER_SYNC <span class=p>|</span>
</span></span><span class=line><span class=cl>+---------------------------------+------------+
</span></span></code></pre></div><p>虽然半同步复制能够最大程度的避免数据的丢失，但是因为网络通讯会导致额外的等待时间的开销，所以尽量在低延迟的网络环境下使用，如处于同一机房的主机之间。</p><h2 id=五高可用架构>五、高可用架构</h2><p>不论是主主复制结构，还是一主多从复制结构，单存依靠复制只能解决数据可靠性的问题，并不能解决系统高可用的问题，想要保证高可用，系统必须能够自动进行故障转移，即在主库宕机时，主动将其它备库升级为主库。常用的有以下两种解决方案：</p><h3 id=51-mmm>5.1 MMM</h3><p>MMM (Master-Master replication manager for MySQL) 是由 Perl 语言开发的一套支持双主故障切换以及双主日常管理的第三方软件。它包含两类角色：<code>writer</code> 和 <code>reader</code>，分别对应读写节点和只读节点。使用 MMM 管理的双主节点在同一时间上只允许一个进行写入操作，当 <code>writer</code> 节点出现宕机（假设是 Master1），程序会自动移除该节点上的读写 VIP，然后切换到 Master2 ，并设置 Master2 的 read_only = 0，即关闭只读限制，同时将所有 Slave 节点重新指向 Master2。</p><p>除了管理双主节点，MMM 也负责管理所有 Slave 节点，在出现宕机、复制延迟或复制错误，MMM 会移除该节点的 VIP，直至节点恢复正常。MMM 高可用的架构示例图如下：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/mysql-MMM架构.png></div>MMM 架构的缺点在于虽然其能实现自动切换，但却不会主动补齐丢失的数据，所以会存在数据不一致性的风险。另外 MMM 的发布时间比较早，所以其也不支持 MySQL 最新的基于 GTID 的复制，如果你使用的是基于 GTID 的复制，则只能采用 MHA。<h3 id=52-mha>5.2 MHA</h3><p>MHA (Master High Availability) 是由 Perl 实现的一款高可用程序，相对于 MMM ，它能尽量避免数据不一致的问题。它监控的是一主多从的复制架构，架构如下图所示：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/mysql-MHA架构.png></div>在 Master 节点宕机后，其处理流程如下：<ol><li>尝试从宕机 Master 中保存二进制日志；</li><li>找到含有最新中继日志的 Slave；</li><li>把最新中继日志应用到其他实例，保证各实例数据一致；</li><li>应用从 Master 保存的二进制日志事件；</li><li>提升一个 Slave 为 Master ；</li><li>其他 Slave 向该新 Master 同步。</li></ol><p>按照以上的处理流程，MHA 能够最大程序的避免数据不一致的问题。但如果 Master 所在的服务器也宕机了，那么过程的第一步就会失败。在 MySQL 5.5 后，可以开启半同步复制后来避免这个问题，从而可以保证数据的一致性和几乎无丢失。当然 MHA 集群也存在一下一些缺点：</p><ul><li>集群中所有节点之间需要开启 SSH 服务，所以会存在一定的安全影响。</li><li>没有实现 Slave 的高可用。</li><li>自带的脚本不足，例如虚拟 IP 的配置需要自己通过命令或者其他第三方软件来实现。</li><li>需要手动清理中继日志。</li></ul><p>以上就是 MMM 和 MHA 架构的简单介绍，关于其具体搭建步骤，可以参考以下两篇博客： <a href=https://segmentfault.com/a/1190000017286307 target=_blank rel=noopener>MySQL 集群搭建(3)-MMM 高可用架构</a> 和 <a href=https://segmentfault.com/a/1190000017486693 target=_blank rel=noopener>MySQL 集群搭建(5)-MHA 高可用架构</a>。</p><h2 id=参考资料>参考资料</h2><ul><li><a href=https://dev.mysql.com/doc/refman/8.0/en/replication.html target=_blank rel=noopener>Chapter 17 Replication</a></li><li><a href=https://dev.mysql.com/doc/refman/8.0/en/replication-gtids-concepts.html target=_blank rel=noopener>GTID Format and Storage</a></li><li><a href=https://www.cnblogs.com/ivictor/p/5735580.html target=_blank rel=noopener>MySQL 半同步复制</a></li><li><a href=https://segmentfault.com/a/1190000017286307 target=_blank rel=noopener>MySQL 集群搭建(3)-MMM 高可用架构</a></li><li><a href=https://segmentfault.com/a/1190000017486693 target=_blank rel=noopener>MySQL 集群搭建(5)-MHA 高可用架构</a></li></ul></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/mysql-series/4.%E9%9B%86%E7%BE%A4%E4%B8%8E%E8%BF%90%E7%BB%B4/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%87%E4%BB%BD/999.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/ rel=prev>2020-heibaiying-数据备份与恢复</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>