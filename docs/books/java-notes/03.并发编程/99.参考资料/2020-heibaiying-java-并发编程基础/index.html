<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="Java 并发编程基础 一、线程 1.1 创建线程 创建线程通常有以下三种方式： 实现 Runnable 接口，并重写其 run 方法： public class J1_Method01 { public static void main(String[] args) { System.out.println(&#34;Main线程的ID为：&#34; + Thread.currentThread().getId()); Thread thread = new"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.fab3cd1900ae35687457073b2d518207.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><meta property="og:title" content="2020-heibaiying-Java 并发编程基础 | Next-gen Tech Edu"><meta property="og:description" content="Java 并发编程基础 一、线程 1.1 创建线程 创建线程通常有以下三种方式： 实现 Runnable 接口，并重写其 run 方法： public class J1_Method01 { public static void main(String[] args) { System.out.println(&#34;Main线程的ID为：&#34; + Thread.currentThread().getId()); Thread thread = new"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>2020-heibaiying-Java 并发编程基础 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=c748f0e3945ec273bdb1c99f90daf87f><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">99.参考资料</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idba7815767eb0e11975f0299ddecaadf6")' href=#idba7815767eb0e11975f0299ddecaadf6 aria-expanded=false aria-controls=idba7815767eb0e11975f0299ddecaadf6 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/>03.并发编程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idba7815767eb0e11975f0299ddecaadf6 aria-expanded=false aria-controls=idba7815767eb0e11975f0299ddecaadf6><i class="fa-solid fa-angle-down" id=caret-idba7815767eb0e11975f0299ddecaadf6></i></a></div><ul class="nav docs-sidenav collapse show" id=idba7815767eb0e11975f0299ddecaadf6><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idccca0addee9a65ebd8a09b52b1eaa9ce")' href=#idccca0addee9a65ebd8a09b52b1eaa9ce aria-expanded=false aria-controls=idccca0addee9a65ebd8a09b52b1eaa9ce aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/00.juc-%E6%A6%82%E8%A7%88/>00.JUC 概览</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idccca0addee9a65ebd8a09b52b1eaa9ce aria-expanded=false aria-controls=idccca0addee9a65ebd8a09b52b1eaa9ce><i class="fa-solid fa-angle-right" id=caret-idccca0addee9a65ebd8a09b52b1eaa9ce></i></a></div><ul class="nav docs-sidenav collapse" id=idccca0addee9a65ebd8a09b52b1eaa9ce><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/00.juc-%E6%A6%82%E8%A7%88/j.u.c-%E6%A6%82%E8%A7%88/>J.U.C 概览</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idcba5b2f6edfda517e85fbd0be5e6a852")' href=#idcba5b2f6edfda517e85fbd0be5e6a852 aria-expanded=false aria-controls=idcba5b2f6edfda517e85fbd0be5e6a852 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/>01.线程与线程池</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idcba5b2f6edfda517e85fbd0be5e6a852 aria-expanded=false aria-controls=idcba5b2f6edfda517e85fbd0be5e6a852><i class="fa-solid fa-angle-right" id=caret-idcba5b2f6edfda517e85fbd0be5e6a852></i></a></div><ul class="nav docs-sidenav collapse" id=idcba5b2f6edfda517e85fbd0be5e6a852><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-iddc2ec75c80f81d5fbc18f578491d5e75")' href=#iddc2ec75c80f81d5fbc18f578491d5e75 aria-expanded=false aria-controls=iddc2ec75c80f81d5fbc18f578491d5e75 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/>01.线程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#iddc2ec75c80f81d5fbc18f578491d5e75 aria-expanded=false aria-controls=iddc2ec75c80f81d5fbc18f578491d5e75><i class="fa-solid fa-angle-right" id=caret-iddc2ec75c80f81d5fbc18f578491d5e75></i></a></div><ul class="nav docs-sidenav collapse" id=iddc2ec75c80f81d5fbc18f578491d5e75><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id6e04f2c5e135348f50dba925eb688114")' href=#id6e04f2c5e135348f50dba925eb688114 aria-expanded=false aria-controls=id6e04f2c5e135348f50dba925eb688114 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/threadlocal/>ThreadLocal</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id6e04f2c5e135348f50dba925eb688114 aria-expanded=false aria-controls=id6e04f2c5e135348f50dba925eb688114><i class="fa-solid fa-angle-right" id=caret-id6e04f2c5e135348f50dba925eb688114></i></a></div><ul class="nav docs-sidenav collapse" id=id6e04f2c5e135348f50dba925eb688114><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idb6854ab952da787fdbd2b6b02229cc50")' href=#idb6854ab952da787fdbd2b6b02229cc50 aria-expanded=false aria-controls=idb6854ab952da787fdbd2b6b02229cc50 aria-hidden=false data-toggle=collapse></div></div><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/threadlocal/threadlocal/>ThreadLocal</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/threadlocal/threadlocalrandom/>ThreadLocalRandom</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd1910a90816b81b467d43afecb6f5f31")' href=#idd1910a90816b81b467d43afecb6f5f31 aria-expanded=false aria-controls=idd1910a90816b81b467d43afecb6f5f31 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/>线程管理</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idd1910a90816b81b467d43afecb6f5f31 aria-expanded=false aria-controls=idd1910a90816b81b467d43afecb6f5f31><i class="fa-solid fa-angle-right" id=caret-idd1910a90816b81b467d43afecb6f5f31></i></a></div><ul class="nav docs-sidenav collapse" id=idd1910a90816b81b467d43afecb6f5f31><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/thread-%E4%B8%8E-runnable/>Thread 与 Runnable</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/>生命周期</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B/>守护线程</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/01.%E7%BA%BF%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86/%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA/>线程创建</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id9d05005360faf1af817dd95ce78a07d8")' href=#id9d05005360faf1af817dd95ce78a07d8 aria-expanded=false aria-controls=id9d05005360faf1af817dd95ce78a07d8 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/02.%E7%BA%BF%E7%A8%8B%E6%B1%A0/>02.线程池</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id9d05005360faf1af817dd95ce78a07d8 aria-expanded=false aria-controls=id9d05005360faf1af817dd95ce78a07d8><i class="fa-solid fa-angle-right" id=caret-id9d05005360faf1af817dd95ce78a07d8></i></a></div><ul class="nav docs-sidenav collapse" id=id9d05005360faf1af817dd95ce78a07d8><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/02.%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E8%B0%83%E4%BC%98/>线程调优</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/02.%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0/>自定义线程池</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id5fd0ceefdf2a12120e609bd57252e59a")' href=#id5fd0ceefdf2a12120e609bd57252e59a aria-expanded=false aria-controls=id5fd0ceefdf2a12120e609bd57252e59a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/>03.Executors</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id5fd0ceefdf2a12120e609bd57252e59a aria-expanded=false aria-controls=id5fd0ceefdf2a12120e609bd57252e59a><i class="fa-solid fa-angle-right" id=caret-id5fd0ceefdf2a12120e609bd57252e59a></i></a></div><ul class="nav docs-sidenav collapse" id=id5fd0ceefdf2a12120e609bd57252e59a><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id7246ea05a980a2f2073d8f564b2c3ba5")' href=#id7246ea05a980a2f2073d8f564b2c3ba5 aria-expanded=false aria-controls=id7246ea05a980a2f2073d8f564b2c3ba5 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/executorservice/>ExecutorService</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id7246ea05a980a2f2073d8f564b2c3ba5 aria-expanded=false aria-controls=id7246ea05a980a2f2073d8f564b2c3ba5><i class="fa-solid fa-angle-right" id=caret-id7246ea05a980a2f2073d8f564b2c3ba5></i></a></div><ul class="nav docs-sidenav collapse" id=id7246ea05a980a2f2073d8f564b2c3ba5><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/executorservice/executors/>Executors</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/executorservice/threadpoolexecutor/>ThreadPoolExecutor</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/executorservice/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>快速开始</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/executorservice/%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/>任务执行</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3823d40f7c36bfba9e009e28ff2e9868")' href=#id3823d40f7c36bfba9e009e28ff2e9868 aria-expanded=false aria-controls=id3823d40f7c36bfba9e009e28ff2e9868 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/future/>Future</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id3823d40f7c36bfba9e009e28ff2e9868 aria-expanded=false aria-controls=id3823d40f7c36bfba9e009e28ff2e9868><i class="fa-solid fa-angle-right" id=caret-id3823d40f7c36bfba9e009e28ff2e9868></i></a></div><ul class="nav docs-sidenav collapse" id=id3823d40f7c36bfba9e009e28ff2e9868><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/future/callable-%E4%B8%8E-future/>Callable 与 Future</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/03.executors/future/completablefuture/>CompletableFuture</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id84aed8981dca86470769d46cc94d29b8")' href=#id84aed8981dca86470769d46cc94d29b8 aria-expanded=false aria-controls=id84aed8981dca86470769d46cc94d29b8 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/04.forkjoin/>04.ForkJoin</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id84aed8981dca86470769d46cc94d29b8 aria-expanded=false aria-controls=id84aed8981dca86470769d46cc94d29b8><i class="fa-solid fa-angle-right" id=caret-id84aed8981dca86470769d46cc94d29b8></i></a></div><ul class="nav docs-sidenav collapse" id=id84aed8981dca86470769d46cc94d29b8><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/04.forkjoin/forkjoin-%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0/>ForkJoin 内部实现</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/04.forkjoin/forkjoin-%E8%AF%AD%E6%B3%95%E4%BD%BF%E7%94%A8/>ForkJoin 语法使用</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf96a49048a7a03312e31959798a9dc29")' href=#idf96a49048a7a03312e31959798a9dc29 aria-expanded=false aria-controls=idf96a49048a7a03312e31959798a9dc29 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/05.%E5%AE%9A%E6%97%B6%E5%99%A8/>05.定时器</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf96a49048a7a03312e31959798a9dc29 aria-expanded=false aria-controls=idf96a49048a7a03312e31959798a9dc29><i class="fa-solid fa-angle-right" id=caret-idf96a49048a7a03312e31959798a9dc29></i></a></div><ul class="nav docs-sidenav collapse" id=idf96a49048a7a03312e31959798a9dc29><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/05.%E5%AE%9A%E6%97%B6%E5%99%A8/%E5%AE%9A%E6%97%B6%E5%99%A8/>定时器</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf6ebf64f416bae2cd70e558aa1fe4ab5")' href=#idf6ebf64f416bae2cd70e558aa1fe4ab5 aria-expanded=false aria-controls=idf6ebf64f416bae2cd70e558aa1fe4ab5 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/10.%E5%8D%8F%E7%A8%8B/>10.协程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf6ebf64f416bae2cd70e558aa1fe4ab5 aria-expanded=false aria-controls=idf6ebf64f416bae2cd70e558aa1fe4ab5><i class="fa-solid fa-angle-right" id=caret-idf6ebf64f416bae2cd70e558aa1fe4ab5></i></a></div><ul class="nav docs-sidenav collapse" id=idf6ebf64f416bae2cd70e558aa1fe4ab5><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2241bb16a711e82aa10e1f9b23108ed4")' href=#id2241bb16a711e82aa10e1f9b23108ed4 aria-expanded=false aria-controls=id2241bb16a711e82aa10e1f9b23108ed4 aria-hidden=false data-toggle=collapse></div></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ideedeaacd73e0f43c2f5a1b0f82309a51")' href=#ideedeaacd73e0f43c2f5a1b0f82309a51 aria-expanded=false aria-controls=ideedeaacd73e0f43c2f5a1b0f82309a51 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ideedeaacd73e0f43c2f5a1b0f82309a51 aria-expanded=false aria-controls=ideedeaacd73e0f43c2f5a1b0f82309a51><i class="fa-solid fa-angle-right" id=caret-ideedeaacd73e0f43c2f5a1b0f82309a51></i></a></div><ul class="nav docs-sidenav collapse" id=ideedeaacd73e0f43c2f5a1b0f82309a51><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/01.%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-%E8%87%B4%E8%BF%9C-java-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%8F%8A%E5%85%B6%E5%9C%A8%E7%BE%8E%E5%9B%A2%E4%B8%9A%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5/>2020-致远-Java 线程池实现原理及其在美团业务中的实践</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id9aaaa2a191c19e31bc2141d70894962e")' href=#id9aaaa2a191c19e31bc2141d70894962e aria-expanded=false aria-controls=id9aaaa2a191c19e31bc2141d70894962e aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/>02.线程安全</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id9aaaa2a191c19e31bc2141d70894962e aria-expanded=false aria-controls=id9aaaa2a191c19e31bc2141d70894962e><i class="fa-solid fa-angle-right" id=caret-id9aaaa2a191c19e31bc2141d70894962e></i></a></div><ul class="nav docs-sidenav collapse" id=id9aaaa2a191c19e31bc2141d70894962e><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id292be30345890b0b5a6c2713b2d4d2e6")' href=#id292be30345890b0b5a6c2713b2d4d2e6 aria-expanded=false aria-controls=id292be30345890b0b5a6c2713b2d4d2e6 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/>并发容器</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id292be30345890b0b5a6c2713b2d4d2e6 aria-expanded=false aria-controls=id292be30345890b0b5a6c2713b2d4d2e6><i class="fa-solid fa-angle-right" id=caret-id292be30345890b0b5a6c2713b2d4d2e6></i></a></div><ul class="nav docs-sidenav collapse" id=id292be30345890b0b5a6c2713b2d4d2e6><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idb91eb6f8c090d09248392fdcb73a01c4")' href=#idb91eb6f8c090d09248392fdcb73a01c4 aria-expanded=false aria-controls=idb91eb6f8c090d09248392fdcb73a01c4 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/>ConcurrentHashMap</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idb91eb6f8c090d09248392fdcb73a01c4 aria-expanded=false aria-controls=idb91eb6f8c090d09248392fdcb73a01c4><i class="fa-solid fa-angle-right" id=caret-idb91eb6f8c090d09248392fdcb73a01c4></i></a></div><ul class="nav docs-sidenav collapse" id=idb91eb6f8c090d09248392fdcb73a01c4><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84-hashmap/>不安全的 HashMap</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E8%AF%AD%E6%B3%95%E4%BD%BF%E7%94%A8/>语法使用</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd94c42434189ddd0ac652c8589479427")' href=#idd94c42434189ddd0ac652c8589479427 aria-expanded=false aria-controls=idd94c42434189ddd0ac652c8589479427 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>源码分析</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idd94c42434189ddd0ac652c8589479427 aria-expanded=false aria-controls=idd94c42434189ddd0ac652c8589479427><i class="fa-solid fa-angle-right" id=caret-idd94c42434189ddd0ac652c8589479427></i></a></div><ul class="nav docs-sidenav collapse" id=idd94c42434189ddd0ac652c8589479427><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/jdk-7-%E4%B8%8E-jdk-8-%E5%AF%B9%E6%AF%94/>JDK 7 与 JDK 8 对比</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E6%9E%84%E9%80%A0%E4%B8%8E%E6%89%A9%E5%AE%B9/>构造与扩容</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%80%BC%E5%AD%98%E5%8F%96/>值存取</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrenthashmap/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E9%87%8D%E8%A6%81%E7%9A%84%E5%86%85%E9%83%A8%E7%B1%BB/>重要的内部类</a></li></ul></div></ul></div><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/concurrentskiplistmap/>ConcurrentSkipListMap</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/copyonwrite/>CopyOnWrite</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id424c7a4a21ae2b5ea6bc95d07f99ee3a")' href=#id424c7a4a21ae2b5ea6bc95d07f99ee3a aria-expanded=false aria-controls=id424c7a4a21ae2b5ea6bc95d07f99ee3a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/>同步器</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id424c7a4a21ae2b5ea6bc95d07f99ee3a aria-expanded=false aria-controls=id424c7a4a21ae2b5ea6bc95d07f99ee3a><i class="fa-solid fa-angle-right" id=caret-id424c7a4a21ae2b5ea6bc95d07f99ee3a></i></a></div><ul class="nav docs-sidenav collapse" id=id424c7a4a21ae2b5ea6bc95d07f99ee3a><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/countdownlatch/>CountDownLatch</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/cyclicbarrier/>CyclicBarrier</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/exchanger/>Exchanger</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/semaphore/>Semaphore</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idefd8acae8db90da2d0b7bb7cc6586eea")' href=#idefd8acae8db90da2d0b7bb7cc6586eea aria-expanded=false aria-controls=idefd8acae8db90da2d0b7bb7cc6586eea aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/>内存模型</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idefd8acae8db90da2d0b7bb7cc6586eea aria-expanded=false aria-controls=idefd8acae8db90da2d0b7bb7cc6586eea><i class="fa-solid fa-angle-right" id=caret-idefd8acae8db90da2d0b7bb7cc6586eea></i></a></div><ul class="nav docs-sidenav collapse" id=idefd8acae8db90da2d0b7bb7cc6586eea><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/volatile/>volatile</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id8f95446a917631703e45543f94ba846b")' href=#id8f95446a917631703e45543f94ba846b aria-expanded=false aria-controls=id8f95446a917631703e45543f94ba846b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/>锁</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id8f95446a917631703e45543f94ba846b aria-expanded=false aria-controls=id8f95446a917631703e45543f94ba846b><i class="fa-solid fa-angle-right" id=caret-id8f95446a917631703e45543f94ba846b></i></a></div><ul class="nav docs-sidenav collapse" id=id8f95446a917631703e45543f94ba846b><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idaa2e3c8293df6f867c78e4d95be97888")' href=#idaa2e3c8293df6f867c78e4d95be97888 aria-expanded=false aria-controls=idaa2e3c8293df6f867c78e4d95be97888 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idaa2e3c8293df6f867c78e4d95be97888 aria-expanded=false aria-controls=idaa2e3c8293df6f867c78e4d95be97888><i class="fa-solid fa-angle-right" id=caret-idaa2e3c8293df6f867c78e4d95be97888></i></a></div><ul class="nav docs-sidenav collapse" id=idaa2e3c8293df6f867c78e4d95be97888><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2021-%E4%BA%92%E6%96%A5%E9%94%81mutex%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%85%B7%E4%BD%93%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84/>2021-互斥锁（mutex）的底层原理是什么？ 操作系统具体是怎么实现的？？</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf2656ea2e555e8adbb1a3f5787553953")' href=#idf2656ea2e555e8adbb1a3f5787553953 aria-expanded=false aria-controls=idf2656ea2e555e8adbb1a3f5787553953 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/aqs/>AQS</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf2656ea2e555e8adbb1a3f5787553953 aria-expanded=false aria-controls=idf2656ea2e555e8adbb1a3f5787553953><i class="fa-solid fa-angle-right" id=caret-idf2656ea2e555e8adbb1a3f5787553953></i></a></div><ul class="nav docs-sidenav collapse" id=idf2656ea2e555e8adbb1a3f5787553953><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/aqs/aqs-%E6%A1%86%E6%9E%B6/>AQS 框架</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/aqs/reentrantlock-%E5%AE%9E%E7%8E%B0/>ReentrantLock 实现</a></li></ul></div><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/java-%E4%B8%AD%E9%94%81%E6%A6%82%E8%A7%88/>Java 中锁概览</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id03746fd8937450d312a7abe0771960d8")' href=#id03746fd8937450d312a7abe0771960d8 aria-expanded=false aria-controls=id03746fd8937450d312a7abe0771960d8 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/reentrantlock/>ReentrantLock</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id03746fd8937450d312a7abe0771960d8 aria-expanded=false aria-controls=id03746fd8937450d312a7abe0771960d8><i class="fa-solid fa-angle-right" id=caret-id03746fd8937450d312a7abe0771960d8></i></a></div><ul class="nav docs-sidenav collapse" id=id03746fd8937450d312a7abe0771960d8><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/reentrantlock/condition/>Condition</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/reentrantlock/locksupport/>LockSupport</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/reentrantlock/readwritelock/>ReadWriteLock</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/reentrantlock/reentrantlock/>ReentrantLock</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf10b8cf5f7f7f7ee1efb7d8423e2d841")' href=#idf10b8cf5f7f7f7ee1efb7d8423e2d841 aria-expanded=false aria-controls=idf10b8cf5f7f7f7ee1efb7d8423e2d841 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/synchronized/>synchronized</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf10b8cf5f7f7f7ee1efb7d8423e2d841 aria-expanded=false aria-controls=idf10b8cf5f7f7f7ee1efb7d8423e2d841><i class="fa-solid fa-angle-right" id=caret-idf10b8cf5f7f7f7ee1efb7d8423e2d841></i></a></div><ul class="nav docs-sidenav collapse" id=idf10b8cf5f7f7f7ee1efb7d8423e2d841><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/synchronized/%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/>实现原理</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/synchronized/%E9%94%81%E7%9A%84%E5%8D%87%E7%BA%A7/>锁的升级</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idfecfe21390400bb1fc1d69d2fb37d6b5")' href=#idfecfe21390400bb1fc1d69d2fb37d6b5 aria-expanded=false aria-controls=idfecfe21390400bb1fc1d69d2fb37d6b5 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81/>死锁</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idfecfe21390400bb1fc1d69d2fb37d6b5 aria-expanded=false aria-controls=idfecfe21390400bb1fc1d69d2fb37d6b5><i class="fa-solid fa-angle-right" id=caret-idfecfe21390400bb1fc1d69d2fb37d6b5></i></a></div><ul class="nav docs-sidenav collapse" id=idfecfe21390400bb1fc1d69d2fb37d6b5><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81/%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81/>避免死锁</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81/%E6%AD%BB%E9%94%81%E6%A1%88%E4%BE%8B/>死锁案例</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide038d00228250e0189c195f000fe2584")' href=#ide038d00228250e0189c195f000fe2584 aria-expanded=false aria-controls=ide038d00228250e0189c195f000fe2584 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/>锁优化</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ide038d00228250e0189c195f000fe2584 aria-expanded=false aria-controls=ide038d00228250e0189c195f000fe2584><i class="fa-solid fa-angle-right" id=caret-ide038d00228250e0189c195f000fe2584></i></a></div><ul class="nav docs-sidenav collapse" id=ide038d00228250e0189c195f000fe2584><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/01.%E5%87%8F%E5%B0%8F%E9%94%81%E7%9A%84%E6%8C%81%E6%9C%89%E6%97%B6%E9%97%B4/>01.减小锁的持有时间</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/02.%E9%94%81%E7%B2%92%E5%BA%A6%E7%9A%84%E4%BC%98%E5%8C%96/>02.锁粒度的优化</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/03.%E9%94%81%E5%88%86%E7%A6%BB/>03.锁分离</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/04.%E6%97%A0%E9%94%81/>04.无锁</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf78af7d0b97f894a00cbfb11a7336b0a")' href=#idf78af7d0b97f894a00cbfb11a7336b0a aria-expanded=false aria-controls=idf78af7d0b97f894a00cbfb11a7336b0a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F/>原子变量</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf78af7d0b97f894a00cbfb11a7336b0a aria-expanded=false aria-controls=idf78af7d0b97f894a00cbfb11a7336b0a><i class="fa-solid fa-angle-right" id=caret-idf78af7d0b97f894a00cbfb11a7336b0a></i></a></div><ul class="nav docs-sidenav collapse" id=idf78af7d0b97f894a00cbfb11a7336b0a><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/02.%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F/atomicreference/>AtomicReference</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2e91edefd4d6573a203119df54781f5b")' href=#id2e91edefd4d6573a203119df54781f5b aria-expanded=false aria-controls=id2e91edefd4d6573a203119df54781f5b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/>03.并发框架</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id2e91edefd4d6573a203119df54781f5b aria-expanded=false aria-controls=id2e91edefd4d6573a203119df54781f5b><i class="fa-solid fa-angle-right" id=caret-id2e91edefd4d6573a203119df54781f5b></i></a></div><ul class="nav docs-sidenav collapse" id=id2e91edefd4d6573a203119df54781f5b><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide5f851dc9103d68ce029d29ee8033f0c")' href=#ide5f851dc9103d68ce029d29ee8033f0c aria-expanded=false aria-controls=ide5f851dc9103d68ce029d29ee8033f0c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/>Akka</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ide5f851dc9103d68ce029d29ee8033f0c aria-expanded=false aria-controls=ide5f851dc9103d68ce029d29ee8033f0c><i class="fa-solid fa-angle-right" id=caret-ide5f851dc9103d68ce029d29ee8033f0c></i></a></div><ul class="nav docs-sidenav collapse" id=ide5f851dc9103d68ce029d29ee8033f0c><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/actor-%E5%9F%BA%E7%A1%80/>Actor 基础</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/websocket/>WebSocket</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E4%B8%8E%E4%BA%8B%E5%8A%A1/>并发控制与事务</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/>异常处理与持久化</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/akka/%E9%82%AE%E7%AE%B1%E4%B8%8E%E8%B7%AF%E7%94%B1/>邮箱与路由</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idbd668cde6d265ff840cdcd4d28665ea6")' href=#idbd668cde6d265ff840cdcd4d28665ea6 aria-expanded=false aria-controls=idbd668cde6d265ff840cdcd4d28665ea6 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/>RxJava</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idbd668cde6d265ff840cdcd4d28665ea6 aria-expanded=false aria-controls=idbd668cde6d265ff840cdcd4d28665ea6><i class="fa-solid fa-angle-right" id=caret-idbd668cde6d265ff840cdcd4d28665ea6></i></a></div><ul class="nav docs-sidenav collapse" id=idbd668cde6d265ff840cdcd4d28665ea6><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idb250c2969ba083e4b069b5c34188f71c")' href=#idb250c2969ba083e4b069b5c34188f71c aria-expanded=false aria-controls=idb250c2969ba083e4b069b5c34188f71c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/>操作符</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idb250c2969ba083e4b069b5c34188f71c aria-expanded=false aria-controls=idb250c2969ba083e4b069b5c34188f71c><i class="fa-solid fa-angle-right" id=caret-idb250c2969ba083e4b069b5c34188f71c></i></a></div><ul class="nav docs-sidenav collapse" id=idb250c2969ba083e4b069b5c34188f71c><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E5%8F%98%E6%8D%A2%E6%93%8D%E4%BD%9C/>变换操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E5%88%9B%E5%BB%BA%E6%93%8D%E4%BD%9C/>创建操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/>错误处理</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E8%BE%85%E5%8A%A9%E6%93%8D%E4%BD%9C/>辅助操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E8%BF%87%E6%BB%A4%E6%93%8D%E4%BD%9C/>过滤操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E7%BB%93%E5%90%88%E6%93%8D%E4%BD%9C/>结合操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C/>聚合操作</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%93%8D%E4%BD%9C%E7%AC%A6/%E6%9D%A1%E4%BB%B6%E5%92%8C%E5%B8%83%E5%B0%94%E6%93%8D%E4%BD%9C/>条件和布尔操作</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idad90ef4dac271424bc0b98d6139d679a")' href=#idad90ef4dac271424bc0b98d6139d679a aria-expanded=false aria-controls=idad90ef4dac271424bc0b98d6139d679a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%8F%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/>反应式编程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idad90ef4dac271424bc0b98d6139d679a aria-expanded=false aria-controls=idad90ef4dac271424bc0b98d6139d679a><i class="fa-solid fa-angle-right" id=caret-idad90ef4dac271424bc0b98d6139d679a></i></a></div><ul class="nav docs-sidenav collapse" id=idad90ef4dac271424bc0b98d6139d679a><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%8F%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E5%8F%8D%E5%BA%94%E5%BC%8F%E5%BA%93%E6%AF%94%E8%BE%83/>反应式库比较</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id5f1ec8faf53c3d9a350fd3ddd7c0e5cf")' href=#id5f1ec8faf53c3d9a350fd3ddd7c0e5cf aria-expanded=false aria-controls=id5f1ec8faf53c3d9a350fd3ddd7c0e5cf aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/>工程实践</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id5f1ec8faf53c3d9a350fd3ddd7c0e5cf aria-expanded=false aria-controls=id5f1ec8faf53c3d9a350fd3ddd7c0e5cf><i class="fa-solid fa-angle-right" id=caret-id5f1ec8faf53c3d9a350fd3ddd7c0e5cf></i></a></div><ul class="nav docs-sidenav collapse" id=id5f1ec8faf53c3d9a350fd3ddd7c0e5cf><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6/>线程调度</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B/>应用案例</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id93eadcbfa6ef6d0757a3ae5e958c7d3e")' href=#id93eadcbfa6ef6d0757a3ae5e958c7d3e aria-expanded=false aria-controls=id93eadcbfa6ef6d0757a3ae5e958c7d3e aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/>基础使用</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id93eadcbfa6ef6d0757a3ae5e958c7d3e aria-expanded=false aria-controls=id93eadcbfa6ef6d0757a3ae5e958c7d3e><i class="fa-solid fa-angle-right" id=caret-id93eadcbfa6ef6d0757a3ae5e958c7d3e></i></a></div><ul class="nav docs-sidenav collapse" id=id93eadcbfa6ef6d0757a3ae5e958c7d3e><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/completable/>Completable</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/flowable/>Flowable</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/observable/>Observable</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>快速开始</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3a4221ee03fbca8311b02867e04fadcc")' href=#id3a4221ee03fbca8311b02867e04fadcc aria-expanded=false aria-controls=id3a4221ee03fbca8311b02867e04fadcc aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%9E%B6%E6%9E%84%E6%9C%BA%E5%88%B6/>架构机制</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id3a4221ee03fbca8311b02867e04fadcc aria-expanded=false aria-controls=id3a4221ee03fbca8311b02867e04fadcc><i class="fa-solid fa-angle-right" id=caret-id3a4221ee03fbca8311b02867e04fadcc></i></a></div><ul class="nav docs-sidenav collapse" id=id3a4221ee03fbca8311b02867e04fadcc><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/03.%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6/rxjava/%E6%9E%B6%E6%9E%84%E6%9C%BA%E5%88%B6/%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/>原理浅析</a></li></ul></div></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2b4bb6bac2562ec3b1f679ac615cb105")' href=#id2b4bb6bac2562ec3b1f679ac615cb105 aria-expanded=false aria-controls=id2b4bb6bac2562ec3b1f679ac615cb105 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/>04.并发 IO</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id2b4bb6bac2562ec3b1f679ac615cb105 aria-expanded=false aria-controls=id2b4bb6bac2562ec3b1f679ac615cb105><i class="fa-solid fa-angle-right" id=caret-id2b4bb6bac2562ec3b1f679ac615cb105></i></a></div><ul class="nav docs-sidenav collapse" id=id2b4bb6bac2562ec3b1f679ac615cb105><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/java-%E4%B8%AD%E7%9A%84bionio-%E4%B8%8E-aio/>Java 中的BIO，NIO 与 AIO</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idfbcd9316e23da12d7d28ef68220c9eb7")' href=#idfbcd9316e23da12d7d28ef68220c9eb7 aria-expanded=false aria-controls=idfbcd9316e23da12d7d28ef68220c9eb7 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/netty/>Netty</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idfbcd9316e23da12d7d28ef68220c9eb7 aria-expanded=false aria-controls=idfbcd9316e23da12d7d28ef68220c9eb7><i class="fa-solid fa-angle-right" id=caret-idfbcd9316e23da12d7d28ef68220c9eb7></i></a></div><ul class="nav docs-sidenav collapse" id=idfbcd9316e23da12d7d28ef68220c9eb7><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/netty/http/>HTTP</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id01d10266dd78c00e9bbfaff6d03ecd17")' href=#id01d10266dd78c00e9bbfaff6d03ecd17 aria-expanded=false aria-controls=id01d10266dd78c00e9bbfaff6d03ecd17 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/>NIO</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id01d10266dd78c00e9bbfaff6d03ecd17 aria-expanded=false aria-controls=id01d10266dd78c00e9bbfaff6d03ecd17><i class="fa-solid fa-angle-right" id=caret-id01d10266dd78c00e9bbfaff6d03ecd17></i></a></div><ul class="nav docs-sidenav collapse" id=id01d10266dd78c00e9bbfaff6d03ecd17><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide8afc7317de4f7c78d0613696a4d3aab")' href=#ide8afc7317de4f7c78d0613696a4d3aab aria-expanded=false aria-controls=ide8afc7317de4f7c78d0613696a4d3aab aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ide8afc7317de4f7c78d0613696a4d3aab aria-expanded=false aria-controls=ide8afc7317de4f7c78d0613696a4d3aab><i class="fa-solid fa-angle-right" id=caret-ide8afc7317de4f7c78d0613696a4d3aab></i></a></div><ul class="nav docs-sidenav collapse" id=ide8afc7317de4f7c78d0613696a4d3aab><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-nio/>2020-heibaiying-Java NIO</a></li></ul></div><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/buffers/>Buffers</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/channel/>Channel</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/http/>HTTP</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/04.%E5%B9%B6%E5%8F%91-io/nio/selector/>Selector</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ided22adc84e7a109f73d8a28f76970412")' href=#ided22adc84e7a109f73d8a28f76970412 aria-expanded=false aria-controls=ided22adc84e7a109f73d8a28f76970412 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/05.%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/>05.典型案例</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ided22adc84e7a109f73d8a28f76970412 aria-expanded=false aria-controls=ided22adc84e7a109f73d8a28f76970412><i class="fa-solid fa-angle-right" id=caret-ided22adc84e7a109f73d8a28f76970412></i></a></div><ul class="nav docs-sidenav collapse" id=ided22adc84e7a109f73d8a28f76970412><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/05.%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/%E8%AE%A1%E6%95%B0%E5%99%A8/>计数器</a></li><li class="child level"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/05.%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B/%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85/>生产者-消费者</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id9fd4ff638c8506979239f4b332f6f6e6")' href=#id9fd4ff638c8506979239f4b332f6f6e6 aria-expanded=false aria-controls=id9fd4ff638c8506979239f4b332f6f6e6 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id9fd4ff638c8506979239f4b332f6f6e6 aria-expanded=false aria-controls=id9fd4ff638c8506979239f4b332f6f6e6><i class="fa-solid fa-angle-down" id=caret-id9fd4ff638c8506979239f4b332f6f6e6></i></a></div><ul class="nav docs-sidenav collapse show" id=id9fd4ff638c8506979239f4b332f6f6e6><li class="child level active"><a href=/books/java-notes/03.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-heibaiying-java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/>2020-heibaiying-Java 并发编程基础</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id4925425fa1e665c28e1cf69da45a46b4")' href=#id4925425fa1e665c28e1cf69da45a46b4 aria-expanded=false aria-controls=id4925425fa1e665c28e1cf69da45a46b4 aria-hidden=false data-toggle=collapse></div></div></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#一线程>一、线程</a><ul><li><a href=#11-创建线程>1.1 创建线程</a></li><li><a href=#12-线程属性>1.2 线程属性</a></li><li><a href=#13-线程状态>1.3 线程状态</a></li><li><a href=#14-线程终止>1.4 线程终止</a></li><li><a href=#15-线程中断>1.5 线程中断</a></li></ul></li><li><a href=#二基本概念>二、基本概念</a><ul><li><a href=#21-变量分类>2.1 变量分类</a></li><li><a href=#22-竞态>2.2 竞态</a></li></ul></li><li><a href=#三原子性>三、原子性</a><ul><li><a href=#31-定义>3.1 定义</a></li><li><a href=#32-非原子性协定>3.2 非原子性协定</a></li><li><a href=#33-保证原子性>3.3 保证原子性</a></li></ul></li><li><a href=#四可见性>四、可见性</a><ul><li><a href=#41-定义>4.1 定义</a></li><li><a href=#42-高速缓存>4.2 高速缓存</a></li><li><a href=#43-缓存一致性协议>4.3 缓存一致性协议</a></li><li><a href=#44-写缓冲器与无效化队列>4.4 写缓冲器与无效化队列</a></li><li><a href=#45-内存屏障>4.5 内存屏障</a></li><li><a href=#46-保证可见性>4.6 保证可见性</a></li><li><a href=#47-java-内存模型>4.7 Java 内存模型</a></li></ul></li><li><a href=#五有序性>五、有序性</a><ul><li><a href=#51-顺序语义>5.1 顺序语义</a></li><li><a href=#52-重排序类型>5.2 重排序类型</a></li><li><a href=#53-貌似串行语义>5.3 貌似串行语义</a></li><li><a href=#54-内存重排序>5.4 内存重排序</a></li><li><a href=#55-保证顺序性>5.5 保证顺序性</a></li></ul></li><li><a href=#六锁机制>六、锁机制</a><ul><li><a href=#61-内部锁>6.1 内部锁</a></li><li><a href=#62-显示锁>6.2 显示锁</a></li><li><a href=#63-读写锁>6.3 读写锁</a></li><li><a href=#64-锁优化>6.4 锁优化</a></li></ul></li><li><a href=#七无锁并行>七、无锁并行</a><ul><li><a href=#71-cas>7.1 CAS</a></li><li><a href=#72-引用型>7.2 引用型</a></li><li><a href=#73-数组型>7.3 数组型</a></li><li><a href=#74-字段更新型>7.4 字段更新型</a></li></ul></li><li><a href=#八线程间的协作>八、线程间的协作</a><ul><li><a href=#81-等待与通知>8.1 等待与通知</a></li><li><a href=#82-条件变量>8.2 条件变量</a></li><li><a href=#83-join>8.3 Join</a></li><li><a href=#84-countdownlatch>8.4 CountDownLatch</a></li><li><a href=#85-cyclicbarrier>8.5 CyclicBarrier</a></li><li><a href=#86-semaphore>8.6 Semaphore</a></li><li><a href=#87-locksupport>8.7 LockSupport</a></li></ul></li><li><a href=#九线程池>九、线程池</a><ul><li><a href=#91-线程池分类>9.1 线程池分类</a></li><li><a href=#92-定时任务>9.2 定时任务</a></li><li><a href=#93-线程池内部实现>9.3 线程池内部实现</a></li><li><a href=#94-线程池扩展>9.4 线程池扩展</a></li><li><a href=#95-线程池大小>9.5 线程池大小</a></li></ul></li><li><a href=#十future>十、Future</a><ul><li><a href=#101-future>10.1 Future</a></li><li><a href=#102-futuretask>10.2 FutureTask</a></li><li><a href=#103-completablefuture>10.3 CompletableFuture</a></li></ul></li><li><a href=#十一threadlocal>十一、ThreadLocal</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>2020-heibaiying-Java 并发编程基础</h1><div class=article-style><h1 id=java-并发编程基础>Java 并发编程基础</h1><h2 id=一线程>一、线程</h2><h3 id=11-创建线程>1.1 创建线程</h3><p>创建线程通常有以下三种方式：</p><ul><li>实现 Runnable 接口，并重写其 run 方法：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_Method01</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Main线程的ID为：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>CustomRunner</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>CustomRunner</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;CustomRunner线程的ID为：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li>继承自 Thread 类，并重写其 run 方法：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_Method02</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Main线程的ID为：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>CustomThread</span> <span class=n>customThread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CustomThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>customThread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>CustomThread</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;CustomThread线程的ID为：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li>以上两种方式都无法获取线程的返回值，如果想要获取线程的返回值，需要实现 Callable 接口：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_Method03</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Task</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Task</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>futureTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FutureTask</span><span class=o>&lt;&gt;(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>futureTask</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;获得线程返回值：&#34;</span> <span class=o>+</span> <span class=n>futureTask</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Integer</span> <span class=nf>call</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>获得线程返回值：</span><span class=mi>100</span>
</span></span></code></pre></div><h3 id=12-线程属性>1.2 线程属性</h3><ul><li><p><strong>编号 (ID)</strong> ：用于标识线程的唯一编号，只读属性。</p></li><li><p><strong>名称 (Name)</strong>：用于定义线程名称，可读可写。</p></li><li><p><strong>线程类别 (Daemon)</strong>：通过线程的 <code>setDaemon(boolean on)</code> 方法进行设置，为 true 表示设置为守护线程，否则为用户线程。用户线程会阻止 Java 虚拟机正常停止，守护线程则不会。通常可以把一些不重要的线程设置为守护线程，比如监控其他线程状态的监控线程，当其他工作线程停止后，虚拟机就可以正常退出。</p></li><li><p><strong>优先级 (Priority)</strong>：Java 线程支持 1 到 10 十个优先级，默认值为 5 。Java 线程的优先级本质上只是给线程调度器一个提示信息，它并不能保证线程一定按照优先级的高低顺序运行，所以它是不可靠的，需要谨慎使用。在 Java 平台中，子线程的优先级默认与其父线程相同。</p></li></ul><h3 id=13-线程状态>1.3 线程状态</h3><p>Java 线程的生命周期分为以下五类状态：</p><ul><li><p><strong>RUNABLE</strong>：该状态包括两个子状态：READY 和 RUNING 。处于 READY 状态的线程被称为活跃线程，被线程调度器选中后才开始运行，转化为 RUNING 状态。</p></li><li><p><strong>BLOCKED</strong>：一个线程发起一个阻塞式 IO 操作后（如文件读写或者阻塞式 Socket 读写），或者申请一个由其他线程持有的独占资源（比如锁）时，相应的线程就会处于该状态。</p></li><li><p><strong>WAITING</strong>：线程处于无时间限制的等待状态。</p></li><li><p><strong>TIMED_WAITING</strong>：有时间限制的等待状态，如果在指定时间内并没有执行的特定的操作，则该线程自动转换为 RUNABLE。</p></li><li><p><strong>TERMINATED</strong>：<code>Thread.run()</code>正常返回或者由于抛出异常而提前终止，则对应的线程都会处于该终止状态。</p></li></ul><p>各个状态之间的转换关系如下图：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/线程完整生命周期.jpg></div><h3 id=14-线程终止>1.4 线程终止</h3><p>通常线程会随着代码的运行完成而终止，但如果你在线程中进行了死循环操作，此时就需要考虑如何安全地停止线程？虽然 Thread 类提供了 <code>stop()</code> 方法，但其已经被标识为废弃，因为 <code>stop()</code> 只是暴力的停止线程， 但此时线程中的操作仍可能处于中间状态，此时暴力地停止就可能会产生非预期的结果。想要安全的停止线程，可以通过改变终止标志位的方式来实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadStop</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>stopFlag</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>stopFlag</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;持续输出&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3</span> <span class=o>*</span> <span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>stopFlag</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程终止&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=15-线程中断>1.5 线程中断</h3><p>除了终止线程外，JDK 中提供了以下方法用于实现线程中断：</p><ul><li><code>Thread.interrupt() </code>：用于给目标线程设置中断标志位，但实际上并不能中断线程；</li><li><code>Thread.isInterrupted()</code>：通过检查中断标志位，判断当前线程是否被中断；</li><li><code>Thread.interrupted()</code>：用来判断当前线程的中断状态，同时会清除当前线程的中断标志位。</li></ul><p>线程中断与线程终止的区别在于：线程中断只是告诉目标线程，我希望你停止运行，即设置标志位，而线程是否真的停止则是由其自行决定。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * interrupt() 只是设置中断标志位，并不能中断线程，所以子线程会持续打印
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_Interrupt</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程打印&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * isInterrupted() 用于检查当前线程是否存在中断标志位，配合interrupt()使用可以中断线程
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_IsInterrupted</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>isInterrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程打印&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * interrupted() 用于判断当前线程的中断状态，并清除当前线程的中断标志位
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_Interrupted</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 此时由于标志位被清除，此时子线程依然会持续打印
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>isInterrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程打印&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=二基本概念>二、基本概念</h2><h3 id=21-变量分类>2.1 变量分类</h3><p><strong>状态变量 (State Variable)</strong> ：即类的实例变量，非共享的静态变量。</p><p><strong>共享变量 (Shared Variable)</strong> : 即可以被多个线程共同访问的变量。</p><h3 id=22-竞态>2.2 竞态</h3><p>如果多个线程并发的操作共享变量，并且这些操作不全是只读操作，那么它们彼此之间就会存在竞争，这种状态就称为竞态。由于竞态的存在，此时可能存在一个类在单线程的环境下能够正常运转，但在多线程的环境下却运行出错，此时就称这个类是线程不安全的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_ThreadUnsafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待线程结束再打印返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span> <span class=c1>// 线程不安全，输出总是小于：200000
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>void</span> <span class=nf>inc</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=三原子性>三、原子性</h2><h3 id=31-定义>3.1 定义</h3><p>对于涉及共享变量的操作，若该操作从其执行线程以外的任意线程来看都是不可分割的，那么我们就说该操作具有原子性。它包含以下两层含义：</p><ul><li>访问（读、写）某个共享变量的操作从其执行线程以外的其他任何线程来看，该操作要么已经执行结束要么尚未发生，即其他线程不会看到该操作的中间部分的结果。</li><li>访问同一组共享变量的原子操作不能被交错执行。</li></ul><h3 id=32-非原子性协定>3.2 非原子性协定</h3><p>在 Java 语言中，除了 long 类型 和 double 类型以外的任何类型的变量的写操作都是具有原子性的，但对于没有使用 volatile 关键字修饰的 64 位的 long 类型和 double 类型，允许将其的读写操作划分为两次 32 位的操作来进行，这就是 long 和 double 类型的非原子性协定 ( Nonatomic Treatment of double and long Variables ) 。</p><h3 id=33-保证原子性>3.3 保证原子性</h3><p>通过 Java 虚拟机规范和非原子性协定， Java 语言可以保证对基本数据类型的访问具有原子性，如果想要保证更大范围内的原子性（如多行操作的原子性），此时可以使用字节码指令 monitorenter 和 monitorexit 来隐式执行 lock 和 unlock 操作，从而将串行变成并行来保证原子性；monitorenter 和 monitorexit 这两个字节码指令反映到 Java 代码中就是 synchronized 关键字。</p><h2 id=四可见性>四、可见性</h2><h3 id=41-定义>4.1 定义</h3><p>如果一个线程对某个共享变量进行更新之后，后续访问该变量的其他线程可以读取到这个更新结果，那么我们就称该更新对其他线程可见，反之则是不可见，这种特性就是可见性。出现可见性问题，往往意味着线程读取到了旧数据，这会导致更新丢失，从而导致运行结果与预期结果存在差异。可见性问题与计算机的存储结构和 Java 的内存模型都有着密切的关系。</p><h3 id=42-高速缓存>4.2 高速缓存</h3><p>由于现代处理器对数据的处理能力远高于主内存（DRAM）的访问速率，为了弥补它们之间在处理能力上的鸿沟，通常在处理器和主内存之间都会存在高速缓存（Cache）。高速缓存相当于一个由硬件实现的容量极小的散列表（Hash Table），其键是一个内存地址，其值是内存数据的副本或者准备写入内存的数据。</p><p>现代处理器一般具有多个层次的高速缓存，如：一级缓存（L1 Cache）、二级缓存（L2 Cache）、三级缓存（L3 Cache）等。其中一级缓存通常包含两部分，其中一部分用于存储指令（L1i），另外一部分用于存储数据（L1d）。距离处理器越近的高速缓存，其存储速率越快，制造成本越高，因此其容量也越小。在 Linux 系统中，可以使用 <code>lscpu</code> 命令查看其高速缓存的情况：</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/cahce.png></div><h3 id=43-缓存一致性协议>4.3 缓存一致性协议</h3><p>在多线程环境下，每个线程运行在不同的处理器上，当多个线程并发访问同一个共享变量时，这些线程的执行处理器都会在自己的高速缓存中保留一个该共享变量的副本，这种情况下如何让一个处理器对数据的更改能被其他处理器感知到？为了解决这个问题，需要引入一种新的通讯机制，这就是缓存一致性协议。</p><p>缓存一致性协议有着多种不同的实现，这里以广泛使用的 MESI (Modified-Exclusive-Shared-Invalid) 协议为例，和其名字一样，它将高速缓存中的缓存条目分为以下四种状态：</p><ul><li><strong>Invalid</strong>：该状态表示相应的缓存行中不包含任何内存地址对应的有效副本数据。</li><li><strong>Shared</strong>：该状态表示相应的缓存行中包含相应内存地址所对应的副本数据，并且其他处理器的高速缓存中也可能存在该相同内存地址所对应的副本数据。</li><li><strong>Exclusive</strong>：该状态表示相应的缓存行中包含相应内存地址所对应的副本数据，但其他处理器的高速缓存中不应存在该相同内存地址所对应的副本数据，即独占的。</li><li><strong>Modified</strong>：该状态表示相应的缓存行中包含对相应内存地址所做的更新的结果。MESI 协议限制任意一个时刻只能有一个处理器能对同一内存地址上的数据进行更新，因此同一内存地址在任意一个时刻只能有一个缓存条目处于该状态。</li></ul><p>根据以上状态，当某个处理器对共享变量进行读写操作时，其具体的行为如下：</p><ul><li><strong>读取共享变量</strong>：处理器首先在高速缓存上进行查找，如果对应缓存条目的状态为 M，E 或者 S，此时则直接读取；如果缓存条目为无效状态 I，此时需要向总线发送 Read 消息，其他处理器或主内存则需要回复 Read Response 来提供相应的数据，处理器在获取到数据后，将其存储到相应的缓存条目，并将状态更新为 S 。</li><li><strong>写入共享变量</strong>：此时处理器首先需要判断是否拥有对该数据的所有权，如果对应缓存条目的状态为 E 或者 M，代表此时均处于独占状态，此时可以直接写入，并将其状态变更为 M 。如果不为 E 或 M，此时处理器需要往总线上发送 Invalidate 消息来通知其他处理器将对应的缓存条目失效，之后在收到其他处理器的 Invalidate Acknowledge 响应后再进行更改，并将其状态变更为 M。</li></ul><p>在只有高速缓存的情况下，通过缓存一致性协议能够保证一个线程对共享变量的更新对于其他线程是可见的。如果只是这样，多线程编程就不会存在可见性问题了，但实际上缓存一致性协议并不能保证最终的可见性，这是由于写缓冲器和无效化队列导致的。</p><h3 id=44-写缓冲器与无效化队列>4.4 写缓冲器与无效化队列</h3><p>在上面的缓存一致性协议中，处理器必须等待其他处理器的应答（Read Response \ Invalidate Acknowledge）后才去执行后续的操作，这会带来一定的时间开销，为了解决这个问题，现代计算机架构又引入了写缓冲器和无效化队列：</p><ul><li><strong>写缓冲器</strong>：当处理器发现缓存条目的状态不为 E 或 M 时，此时不再等待其他处理器返回 Invalidate Acknowledge 消息，而是直接将变更写入到写缓冲器就认为操作完成。当收到对应的 Invalidate Acknowledge 消息，再将变更写入到对应的缓存条目中，此时写操作对于其他处理器而言，才算完成。</li><li><strong>无效化队列</strong>：当其他处理器接收到 Invalidate 消息后，不再等待删除指定缓存条目中的副本数据后再回复 Invalidate Acknowledge ，而是将消息存入到无效化队列中后就直接回复，之后处理器再根据无效化队列中的消息来重置缓存行的状态到 Invalid 。</li></ul><p>写缓冲器是处理器的私有部件，一个处理器的写缓冲器所存储的内容是不能被其他处理器所读取的，这就会导致一个更新即便已经发生并写入到写缓冲器，但是其他处理器上的线程读取到的还是旧值，从而导致可见性问题。除了写缓冲器外，无效化队列也会导致可见性问题，当某个写入发生后，其他处理器上的对应缓存条目应该都立即失效，但是由于无效化队列的存在，Invalidate 操作不会立即执行，导致其他处理器仍然读取到的仍然是未失效的旧值。</p><h3 id=45-内存屏障>4.5 内存屏障</h3><p>想要解决写缓存器和无效化队列带来的问题，需要引入一个新的机制 —— 内存屏障：</p><ul><li><strong>Store Barrier</strong>：存储屏障，可以使执行该指令的处理器冲刷其写缓冲器。</li><li><strong>Load Barrier</strong>：加载屏障，将无效化队列中所指定的缓存条目的状态都标志位 I ，并清空无效化队列，从而保证处理器在读取共享变量时必须发送 Read 消息去获取更新后的值。</li></ul><p>冲刷写缓冲器和清空无效化队列都是存在时间消耗的，所以只有在必须要保证可见性的场景下，才应该去使用内存屏障。何种场景下必须要保证可见性，这是由用户来决定的，这也是多线程编程所需要考虑的问题。</p><h3 id=46-保证可见性>4.6 保证可见性</h3><p>在 Java 语言中，保证可见性的典型实现是 volatile 关键字，它在 Java 语言中一共有三种作用：</p><ul><li><strong>保证可见性</strong>：Java 虚拟机（JIT 编译器）会在 volatile 变量写操作之后插入一个通用的 StoreLoad 屏障，它可以充当存储屏障来清空执行处理器的写缓冲器；同时 JIT 编译器还会在变量的读操作前插入一个加载屏障来清空无效化队列。</li><li><strong>禁止指令重排序</strong>：通过内存屏障， Java 虚拟机可以保证 volatile 变量之前的任何读写操作都先于这个 volatile 写操作之前被提交，而 volatile 变量的读操作先于之后任何变量的读写操作被提交。</li><li>除了以上两类语义外，Java 虚拟机规范还特别规定了对于使用 volatile 修饰的 64 的 long 类型和 double 类型的变量的读写操作具有原子性。</li></ul><p>除了 volatile 外，synchronized 和 final 关键字都能保证可见性：</p><ul><li><strong>synchronized</strong> ：synchronized 关键字规定了对其所修饰的变量执行 unlock 操作前，必须先把此变量同步回主内存中。</li><li><strong>final</strong> ：被 final 修饰的字段在构造器中一旦初始化完成，并且构造器没有把 <code>this</code> 的引用逃逸到外部，那么其他线程中就能看到 final 字段的值，即可见性得到保证。</li></ul><h3 id=47-java-内存模型>4.7 Java 内存模型</h3><p>以上主要介绍计算机的内存模型对可见性的影响，但是不同架构的处理器在内存模型和支持的指令集上都存在略微的差异。 Java 作为一种跨平台的语言，必须尽量屏蔽这种差异，而且还要尽量利用硬件的各种特性（如寄存器，高速缓存和指令集中的某些特有指令）来获取更好的执行速度，这就是 Java 的内存模型：</p><ul><li><strong>Main Memory</strong>：主内存，Java 内存模型规定了所有的变量都存储在主内存中，主内存可以类比为计算机的主内存，但其只是虚拟机内存的一部分，并不能代表整个计算机内存。</li><li><strong>Work Memory</strong>：工作内存，Java 内存模型规定了每条线程都有自己的工作内存，工作内存可以类比为计算机的高速缓存。工作内存中保存了被该线程使用到的变量的拷贝副本。</li></ul><p>线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的变量；不同的线程之间也无法直接访问对方工作内存中的变量，线程间变量值的传递需要通过主内存来完成。</p><div align=center><img src=https://gitee.com/heibaiying/Full-Stack-Notes/raw/master/pictures/java内存模型.png></div><h2 id=五有序性>五、有序性</h2><h3 id=51-顺序语义>5.1 顺序语义</h3><p>Java 语言中的顺序语义可以分为以下四类：</p><ul><li><strong>源代码顺序</strong>：程序员编写的代码的执行顺序；</li><li><strong>程序顺序</strong>：编译后的代码的执行顺序；</li><li><strong>执行顺序</strong>：给定代码在处理器上的实际执行顺；</li><li><strong>感知顺序</strong>：处理器感知到的其他处理器上代码的执行顺序。</li></ul><h3 id=52-重排序类型>5.2 重排序类型</h3><p>编译器和处理器出于性能考虑，通常会改变代码的实际执行顺序，这种情况就称为重排序，具体分为以下两类：</p><table><tr><th>重排序类型</th><th>重排序表现</th><th>重排序主体(原因)</th></tr><tr><td rowspan=2>指令重排序</td><td>程序顺序和源代码顺序不一致</td><td>编译器</td></tr><tr><td>执行顺序和程序顺序不一致</td><td>JIT 编译器、处理器</td></tr><tr><td>存储子系统重排序<br>（内存重排序）</td><td>源代码顺序、程序顺序和执行顺序这三者保持一致，<br>但是感知顺序与执行顺序不一致</td><td>高速缓存、写缓冲器</td></tr></table><h3 id=53-貌似串行语义>5.3 貌似串行语义</h3><p>尽管编译器和处理器都能够进行指令重排序，但它们都必须遵循 貌似串行语义（As-if-serial Semantics），即重排序不能影响程序在单线程上执行结果的正确性。按照 As-if-serial 原则，只有不存在数据依赖关系的语句才会被重排序，存在数据依赖关系的语句不会被重排序，示例如下。此时第 1，2 行语句彼此之间可以进行重排序，但是第 3 行语句不能被重排序到 1 和 2 行语句之前：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=o>;</span>
</span></span></code></pre></div><p>同时为了保证单线下执行的正确性，处理器会将重排序指令的执行结果先写入到重排序缓冲器（ROB，Recorder Buffer）中，之后再按照这些指令被处理器读取的顺序提交到寄存器或者主内存中，因此虽然指令是乱序执行的，但结果却是顺序提交的，从而能够保证在单线程下的正确性。</p><h3 id=54-内存重排序>5.4 内存重排序</h3><p>由于写缓冲器和高速缓存的存在，并且写缓冲器是不能被其他处理器所访问的，因此其他处理器感知到的顺序可能仍然与执行顺序不同，这种情况就叫做内存重排序。但需要说明的是：指令重排序是一种实实在在的重排序，它改变了指令的执行顺序；但内存重排序只是一种现象，只是其他处理器的错觉。</p><h3 id=55-保证顺序性>5.5 保证顺序性</h3><p>在 Java 语言中，volatile 和 synchronized 都能够保证有序性：</p><ul><li><strong>volatile</strong>：通过内存屏障来禁止指令重排序，通过加载屏障和存储屏障来冲刷写缓冲器和清空无效化队列，从而可以避免内存重排序的现象；</li><li><strong>synchronized</strong> ：使用 synchronized 修饰的变量在同一时刻只允许一个线程对其进行 lock 操作，这种限制决定了持有同一个锁的两个同步块只能串行执行，也就避免了乱序问题。</li></ul><h2 id=六锁机制>六、锁机制</h2><h3 id=61-内部锁>6.1 内部锁</h3><p>Java 平台中的任何一个对象都有着唯一一个与之相关联的锁，这种锁被称为监视器或内部锁，内部锁是一种非公平的排它锁，它能够保障原子性、可见性和有序性。内部锁通过 <code>synchronized</code> 关键字来实现，可以用于修饰方法以及代码块， 被修饰的方法称为同步方法，被修饰的代码块称为同步代码块。示例如下：</p><p>线程不安全的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_ThreadUnsafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待线程结束再打印返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>void</span> <span class=nf>inc</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>使用 synchronized 修饰 <code>inr()</code> 方法来保证线程安全：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_SynchronizedSafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 两个线程调用的是同一个IncreaseTask实例，此时是线程安全的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//等待结束后 才打印返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//并打印返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>inc</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>inc</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>通常我们把被修饰的方法体和代码块称为临界区，需要注意的是必须保证多线程锁住的是同一个临界区，否则依然是线程不安全的。如果将上面创建线程的方法修改为如下所示，此时 synchronized 锁住的是不同 IncreaseTask 对象的 <code>inc()</code> 方法，所以仍然是线程不安全的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span></code></pre></div><p>synchronized 除了可以修饰方法外，还可以用于修饰代码块，此时可以使用 this 关键字作为句柄，但仍然需要保证两个线程调用的是同一个 IncreaseTask 实例，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_SynchronizedSafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 锁住的是同一个对象，此时也是线程安全的
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>如果想要调用不同的 <code>IncreaseTask()</code> 实例，又想保证线程安全，此时可以使用同一个对象作为 synchronized 关键字的句柄。为避免竞态，作为句柄的对象通常使用 <code>private final</code> 关键字进行修饰，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J4_SynchronizedSafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>s</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 虽然调用的是不同的 IncreaseTask() 实例，但锁住的仍然是同一个对象，此时也是线程安全的
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kd>synchronized</span> <span class=o>(</span><span class=n>s</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=62-显示锁>6.2 显示锁</h3><p>显示锁是 <code>java.util.concurrent.locks.Lock</code> 接口的实例，该接口对显示锁进行了抽象，定义了如下方法：</p><ul><li><strong>lock()</strong>：获取锁；</li><li><strong>lockInterruptibly()</strong>：如果当前线程未被中断，则获取锁；</li><li><strong>tryLock()</strong>：仅在调用时锁为空闲状态才获取该锁；</li><li><strong>tryLock(long time, TimeUnit unit)</strong>：如果锁在给定的等待时间内存在空闲，并且当前线程未被中断，则获取锁；</li><li><strong>unlock()</strong>：释放锁；</li><li><strong>newCondition()</strong>：返回绑定到此 Lock 实例的新的 Condition 实例。</li></ul><p><code>java.util.concurrent.locks.ReentrantLock</code> 类是 <code>Lock</code> 接口的默认实现，它是一种可重入锁，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 利用ReentrantLock实现线程安全
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_ThreadSafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantLock</span> <span class=n>reentrantLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>thread2</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>thread1</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>thread2</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ReentrantLock 是一种可重入的锁， 它能够对共享资源进行重复加锁，即持有该锁的线程再次获取该锁时不会被阻塞，但解锁次数与加锁次数必须要保持一致，此时才能完全解锁：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reentrantLock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ReentrantLock 即支持公平锁也支持非公平锁，公平锁在调度时候往往需要频繁切换上下文来保证在等待时间上的公平性，所以默认的 ReentrantLock 锁是非公平的，如果想要使用公平锁，可以在创建时进行指定：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 参数为true,代表使用公平锁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantLock</span> <span class=n>fairLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span></code></pre></div><p>显示锁相比于内部锁提供了更高的灵活性，但容易存在锁泄露（某个线程持有锁后因为异常而导致锁无法被释放）等问题。而内部锁虽然灵活性不足，但不会存在锁泄露，并且虚拟机也会在编译时对内部锁进行适当的锁优化。</p><h3 id=63-读写锁>6.3 读写锁</h3><p>由于锁的排它性，导致多个线程无法以安全的方式并发地读取共享变量，这不利于提高系统的并发能力，因此产生了读写锁：</p><ul><li><strong>读锁</strong>：读锁是共享的，可以被多个线程所持有，即一个线程持有读锁时并不妨碍其他线程获得相应锁的读锁；</li><li><strong>写锁</strong>：写锁是独占的，一个线程持有写锁时，其他线程无法获取相应锁的写锁或读锁。</li></ul><p>基于读写锁的特性，其非常适合于读多写少的场景，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ReadWriteLock</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 可重入锁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantLock</span> <span class=n>reentrantLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读写锁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantReadWriteLock</span> <span class=n>readWriteLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantReadWriteLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读锁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantReadWriteLock</span><span class=o>.</span><span class=na>ReadLock</span> <span class=n>readLock</span> <span class=o>=</span> <span class=n>readWriteLock</span><span class=o>.</span><span class=na>readLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 写锁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantReadWriteLock</span><span class=o>.</span><span class=na>WriteLock</span> <span class=n>writeLock</span> <span class=o>=</span> <span class=n>readWriteLock</span><span class=o>.</span><span class=na>writeLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 待赋值的变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>String</span> <span class=n>i</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//写方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Write</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Lock</span> <span class=n>lock</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>String</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Write</span><span class=o>(</span><span class=n>Lock</span> <span class=n>lock</span><span class=o>,</span> <span class=n>String</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>lock</span> <span class=o>=</span> <span class=n>lock</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;写入值&#34;</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//读方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Read</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Lock</span> <span class=n>lock</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Read</span><span class=o>(</span><span class=n>Lock</span> <span class=n>lock</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>lock</span> <span class=o>=</span> <span class=n>lock</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;读取到值&#34;</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 写锁是排它的，但读锁是共享的，耗时3秒左右
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Write</span><span class=o>(</span><span class=n>writeLock</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>j</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>18</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Read</span><span class=o>(</span><span class=n>readLock</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 使用重入锁时耗时20秒左右
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Write</span><span class=o>(</span><span class=n>reentrantLock</span><span class=o>,</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>j</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>18</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Read</span><span class=o>(</span><span class=n>reentrantLock</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=64-锁优化>6.4 锁优化</h3><p><strong>1. 锁消除</strong></p><p>锁消除（Lock Elision）是 JIT 编译器对内部锁所做的一种优化。在编译时，JIT 编译器会通过逃逸分析（Escape Analysis）来判断同步块所使用的锁对象是否只能被一个线程访问而没有逃逸到其他线程，如果是，则编译器在编译这个同步块时就不生成 synchronized 锁所对应的机器码，这种编译器优化就被称为锁消除。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LockElision</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=nf>toJson</span><span class=o>(</span><span class=n>Employee</span> <span class=n>employee</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StringBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;name:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>employee</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;age:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>employee</span><span class=o>.</span><span class=na>getAge</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;birthday:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>employee</span><span class=o>.</span><span class=na>getBirthday</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>此时的 StringBuffer 实例对象只是一个局部变量，并且该对象并没有被发布到其他线程，因此其对应的内部锁会被消除。</p><p><strong>2. 锁粗化</strong></p><p>对于相邻的几个同步块，如果这些同步块锁使用的是同一个锁的实例，那么 JIT 编译器就会将这些同步块合并为一个大同步块，从而避免一个线程反复申请、释放同一个锁而导致的开销。</p><p><strong>3. 偏向锁</strong></p><p>Java 虚拟机在实现 monitorenter 字节码（申请锁）和 monitorexit 字节码（释放锁）时需要借助一个原子操作（CAS 操作），这个操作是比较昂贵的，因此内部锁在每次被线程获取时，它都会将对应的线程记录为偏好线程（Biased Thread），之后此线程无论是再次申请该锁还是获取该锁，都无须借助原先昂贵的原子操作，从而减少了锁的申请与释放的开销。</p><p>因为锁在每次都获取时，都需要刷新偏好线程的值，这个过程也是需要额外开销的，所以偏向锁只适用于系统中大部分锁争用较少的情况，如果系统中大部分锁的竞争都比较激烈，此时可以考虑在 Java 程序的启动命令行中增加 <code>-XX:-UseBiasedLocking</code> 参数来关闭偏向锁。</p><p><strong>4. 适应性锁</strong></p><p>如果一个线程在申请锁时，该锁恰好被其他线程所持有，那么该线程就需要等待持有锁的线程释放该锁，此时常用的方案有两种：</p><ul><li>暂停该线程进行等待，但暂停操作会导致上下文切换，这会导致额外的开销；</li><li>持续执行空循环，进行忙等（Busy Wait）。这不会导致上下文的切换，但是会持续消耗处理器的资源。</li></ul><p>暂停策略适用于等待时间较长的场景，此时可以抵消上下文切换带来的开销；忙等策略适用于等待时间较短的场景，此时可以避免持续消耗处理器的资源。Java 虚拟机会根据运行过程中收集到的信息来判断这个锁被线程持有的时间，从而选取最优的策略来进行等待，这就是适应性锁。</p><h2 id=七无锁并行>七、无锁并行</h2><h3 id=71-cas>7.1 CAS</h3><p>锁是一种悲观的策略，它假设每一次临界区内的访问都会存在冲突，因此它在同一时刻只允许一个线程进入临界区，而无锁则是一种乐观的策略，它假设临界区内资源的访问很少存在冲突，并采用 CAS 方案来避免这种偶发冲突而导致的线程不安全。CAS 的全称是 Compare And Swap （比较交换），其核心思想如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span> <span class=nf>compareAndSwap</span> <span class=o>(</span><span class=n>Variable</span> <span class=n>V</span><span class=o>,</span> <span class=n>Object</span> <span class=n>A</span><span class=o>,</span> <span class=n>Object</span> <span class=n>B</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>(</span><span class=n>A</span> <span class=o>==</span> <span class=n>V</span><span class=o>.</span><span class=na>get</span><span class=o>()){</span>  <span class=c1>// 检查变量值是否被其他线程修改过
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>V</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>B</span><span class=o>);</span> <span class=c1>// 更新变量值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span> <span class=c1>// 更新成功
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span> <span class=c1>//变量值已被其他线程修改，更新失败
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><p>如果变量 V 的当前值和调用 CAS 时所提供的变量值 A (即变量的旧值) 一致，那么就说明其他线程并没有修改过变量 V 的值，此时就可以进行更新操作，否则操作失败，整个 CAS 操作的原子性由处理器来进行保证。由于 CAS 操作并不需要频繁的线程调度，因此其通常有着更好的性能表现，为了充分利用 CAS 的特性，JDK 提供了原子包来满足各种场景下的使用需求：</p><table><thead><tr><th>分组</th><th>类</th></tr></thead><tbody><tr><td>基础数据型</td><td>AtomicBoolean、AtomicInteger、AtomicLong</td></tr><tr><td>引用型</td><td>AtomicReference、AtomicStampedReference、AtomicMarkableReference</td></tr><tr><td>数组型</td><td>AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</td></tr><tr><td>字段更新型</td><td>AtomicIntegerFieldUpdater、AtomicLongFieldUpdater、AtomicReferenceFieldUpdater</td></tr></tbody></table><h3 id=72-引用型>7.2 引用型</h3><p>除了使用原子包中提供的 AtomicBoolean、AtomicInteger、AtomicLong 来保证基本数据类型操作的原子性外，还可以使用 AtomicReference&lt;V> 来保证任意类型操作原子性，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_SimpleType</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>j</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*使用AtomicReference对普通对象进行封装*/</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicReference</span><span class=o>&lt;&gt;(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Task</span><span class=o>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>latch</span> <span class=o>=</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>            <span class=n>j</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span><span class=o>.</span><span class=na>getAndUpdate</span><span class=o>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>latch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>number</span> <span class=o>=</span> <span class=mi>10000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>CountDownLatch</span> <span class=n>latch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>number</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Semaphore</span> <span class=n>semaphore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Semaphore</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Task</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=n>latch</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>number</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>semaphore</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>semaphore</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>latch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;输出i的值&#34;</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;输出j的值&#34;</span> <span class=o>+</span> <span class=n>j</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;输出K的值&#34;</span> <span class=o>+</span> <span class=n>k</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在使用 CAS 的过程中，一个比较常见的隐患是 <strong>A-B-A 问题</strong>：如果其他线程在将共享变量的值修改为 B 后，又立即修改回原值，此时这次变更对于其他线程而言可能无法感知到。这对于计数等场景而言，是没有问题的，但在一些特别的场景下，就会导致错误。想要解决这个问题，可以在比较时候除了比较变量的值外，还应进行时间戳的比较，AtomicStampedReference 就是这种比较思路的一种实现。其更新值的方法定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>compareAndSet</span><span class=o>(</span><span class=n>V</span> <span class=n>expectedReference</span><span class=o>,</span> <span class=n>V</span> <span class=n>newReference</span><span class=o>,</span> <span class=kt>int</span> <span class=n>expectedStamp</span><span class=o>,</span> <span class=kt>int</span> <span class=n>newStamp</span><span class=o>)</span>
</span></span></code></pre></div><h3 id=73-数组型>7.3 数组型</h3><p>数组型可以保证对数据内元素的操作是线程安全的，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_ArrayElementThreadUnsafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>capacity</span> <span class=o>=</span> <span class=mi>10</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 保证对集合内元素的操作具有原子性
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicIntegerArray</span> <span class=n>atomicIntegerArray</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicIntegerArray</span><span class=o>(</span><span class=n>capacity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 对集合内元素的操作线程不安全
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Vector</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>vector</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Vector</span><span class=o>&lt;&gt;(</span><span class=n>capacity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 对集合内元素的操作线程不安全
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>arrayList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>capacity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>capacity</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>vector</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Task</span><span class=o>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>latch</span> <span class=o>=</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=n>i</span> <span class=o>%</span> <span class=n>capacity</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>atomicIntegerArray</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>(</span><span class=n>num</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>vector</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>num</span><span class=o>,</span> <span class=n>vector</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>num</span><span class=o>)</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>arrayList</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>num</span><span class=o>,</span> <span class=n>arrayList</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>num</span><span class=o>)</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>latch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>number</span> <span class=o>=</span> <span class=mi>1000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>CountDownLatch</span> <span class=n>latch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>number</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>number</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=n>latch</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>latch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;集合内元素的线程安全：&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;atomicIntegerArray size : &#34;</span> <span class=o>+</span> <span class=n>atomicIntegerArray</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;vector size : &#34;</span> <span class=o>+</span> <span class=n>vector</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;arrayList size : &#34;</span> <span class=o>+</span> <span class=n>arrayList</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出如下:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>集合内元素的线程安全：</span>
</span></span><span class=line><span class=cl><span class=n>atomicIntegerArray</span> <span class=n>size</span> <span class=o>:</span> <span class=o>[</span><span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>,</span> <span class=mi>100000</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=n>vector</span> <span class=n>size</span> <span class=o>:</span> <span class=o>[</span><span class=mi>69966</span><span class=o>,</span> <span class=mi>81954</span><span class=o>,</span> <span class=mi>78605</span><span class=o>,</span> <span class=mi>79144</span><span class=o>,</span> <span class=mi>66532</span><span class=o>,</span> <span class=mi>75082</span><span class=o>,</span> <span class=mi>77324</span><span class=o>,</span> <span class=mi>78723</span><span class=o>,</span> <span class=mi>78022</span><span class=o>,</span> <span class=mi>76294</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=n>arrayList</span> <span class=n>size</span> <span class=o>:</span> <span class=o>[</span><span class=mi>99045</span><span class=o>,</span> <span class=mi>99173</span><span class=o>,</span> <span class=mi>99251</span><span class=o>,</span> <span class=mi>98609</span><span class=o>,</span> <span class=mi>99248</span><span class=o>,</span> <span class=mi>99191</span><span class=o>,</span> <span class=mi>98848</span><span class=o>,</span> <span class=mi>99181</span><span class=o>,</span> <span class=mi>99212</span><span class=o>,</span> <span class=mi>99083</span><span class=o>]</span>
</span></span></code></pre></div><h3 id=74-字段更新型>7.4 字段更新型</h3><p>如果某个类的基本类型的字段在某一环境中存在线程安全，但该字段在多个环境中都有引用，此时直接修改该字段可能会导致多个环境都需要重新验证，在这种情况下可以使用字段更新型来保证其在特定环境下的线程安全：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J5_AtomicIntegerFieldUpdater</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Candidate</span> <span class=n>candidate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>AtomicIntegerFieldUpdater</span> <span class=n>fieldUpdater</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Task</span><span class=o>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>,</span> <span class=n>Candidate</span> <span class=n>candidate</span><span class=o>,</span> <span class=n>AtomicIntegerFieldUpdater</span> <span class=n>fieldUpdater</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>candidate</span> <span class=o>=</span> <span class=n>candidate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>latch</span> <span class=o>=</span> <span class=n>latch</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>fieldUpdater</span> <span class=o>=</span> <span class=n>fieldUpdater</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>fieldUpdater</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>(</span><span class=n>candidate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>latch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>number</span> <span class=o>=</span> <span class=mi>100000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>CountDownLatch</span> <span class=n>latch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>number</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Candidate</span> <span class=n>candidate</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Candidate</span><span class=o>(</span><span class=s>&#34;候选人&#34;</span><span class=o>,</span> <span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 使用字段更新型来保证其线程安全
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>AtomicIntegerFieldUpdater</span><span class=o>&lt;</span><span class=n>Candidate</span><span class=o>&gt;</span> <span class=n>fieldUpdater</span> <span class=o>=</span> <span class=n>AtomicIntegerFieldUpdater</span><span class=o>.</span><span class=na>newUpdater</span><span class=o>(</span><span class=n>Candidate</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=s>&#34;score&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>number</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=n>latch</span><span class=o>,</span> <span class=n>candidate</span><span class=o>,</span> <span class=n>fieldUpdater</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>latch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>candidate</span><span class=o>.</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;获得票数:&#34;</span> <span class=o>+</span> <span class=n>candidate</span><span class=o>.</span><span class=na>getScore</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Candidate</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 不能声明为private  2. 必须用volatile关键字修饰
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>public</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>score</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>.....</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>需要注意的是由于 CAS 只能保证可见性，不能保证原子性，所以该变量必须使用 volatile 关键字修饰，并且由于 FieldUpdater 是采用反射机制来获取该变量的值，所以其也不能声明为 private 。另外 FieldUpdater 也不能用于 static 类型的变量。</p><h2 id=八线程间的协作>八、线程间的协作</h2><h3 id=81-等待与通知>8.1 等待与通知</h3><p>为了支持多线程之间的协作，JDK 中提供了两个非常重要的方法：<code>wait()</code> 和 <code>notify()</code> ，这两个方法定义在 <code>Object</code> 类中，这意味着任何 Java 对象都可以调用者两个方法。如果一个线程调用了 <code>object.wait()</code> 方法，那么它就会进入该对象的等待队列中，这个队列中可能包含了多个线程，此时代表多个线程都在等待同一个对象；当 <code>object.notify()</code> 方法被调用时，它就会从这个等待队列中<strong>随机</strong>唤醒一个线程。</p><p>需要特别注意的是在调用这两个方法时，它们都必须位于对应对象的 synchronzied 语句中，因为这两个方法在调用前都需要获得对应对象的监视器（内部锁），过程如下：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=D:%5cFull-Stack-Notes%5cpictures%5cobject-wait-notify-process.png alt=object-wait-notify-process loading=lazy data-zoomable></div></div></figure></p><p>使用示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_WaitAndNotify</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;对象object等待&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>object</span><span class=o>.</span><span class=na>wait</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程1后续操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程2开始操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;对象object唤醒&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>object</span><span class=o>.</span><span class=na>notify</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>对象</span><span class=n>object</span><span class=err>等待</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>2</span><span class=err>开始操作</span>
</span></span><span class=line><span class=cl><span class=err>对象</span><span class=n>object</span><span class=err>唤醒</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>1</span><span class=err>后续操作</span>
</span></span></code></pre></div><p><code>notify()</code> 表示随机唤醒任意一个等待线程，如果想要唤醒所有等待线程，则可以使用 <code>notifyAll()</code> 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J5_NotifyAll</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;对象object在线程1等待&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>object</span><span class=o>.</span><span class=na>wait</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程1后续操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;对象object在线程2等待&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>object</span><span class=o>.</span><span class=na>wait</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程2后续操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>synchronized</span> <span class=o>(</span><span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程3开始操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;对象object唤醒&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>object</span><span class=o>.</span><span class=na>notifyAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>对象</span><span class=n>object</span><span class=err>在线程</span><span class=mi>1</span><span class=err>等待</span>
</span></span><span class=line><span class=cl><span class=err>对象</span><span class=n>object</span><span class=err>在线程</span><span class=mi>2</span><span class=err>等待</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>3</span><span class=err>开始操作</span>
</span></span><span class=line><span class=cl><span class=err>对象</span><span class=n>object</span><span class=err>唤醒</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>2</span><span class=err>后续操作</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>1</span><span class=err>后续操作</span>
</span></span></code></pre></div><p>在上面的示例中，由于有两个线程处于等待状态，所以 <code>notifyAll()</code> 的效果等价于调用 <code>notify()</code> 两次：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>object</span><span class=o>.</span><span class=na>notify</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>object</span><span class=o>.</span><span class=na>notify</span><span class=o>();</span>
</span></span></code></pre></div><h3 id=82-条件变量>8.2 条件变量</h3><p>综上所述可以使用 <code>wait()</code> 和 <code>notify()</code> 配合内部锁 synchronized 可以实现线程间的等待与唤醒，如果你使用的是显示锁而不是内部锁，此时可以使用 Condition 来实现同样的效果。Condition 接口中定义了如下方法：</p><ul><li><strong>await()</strong>：使得当前线程进入等待状态，类似于 <code>object.wait()</code>；</li><li><strong>awaitUninterruptibly()</strong>：与 <code>await()</code> 类似，但它不会在等待过程中响应中断；</li><li><strong>awaitNanos(long nanosTimeout) & await(long time, TimeUnit unit) & awaitUntil(Date deadline)</strong>：有时间限制的等待；</li><li><strong>signal()</strong>：用于随机唤醒一个等待；</li><li><strong>signalAll()</strong>：用于唤醒所有等待。</li></ul><p>和 object 的 <code>wait()\notify()\notifyAll()</code> 一样，在使用 condition 的 <code>await()\signal()\signalAll()</code> 前，也要求线程必须持有相关的重入锁， 示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AwaitAndSignal</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ReentrantLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReentrantLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Condition</span> <span class=n>condition</span> <span class=o>=</span> <span class=n>lock</span><span class=o>.</span><span class=na>newCondition</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>threadName</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>threadName</span> <span class=o>+</span> <span class=s>&#34;线程等待通知...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>condition</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>threadName</span> <span class=o>+</span> <span class=s>&#34;线程后续操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>thread1</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程开始操作&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程唤醒&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>condition</span><span class=o>.</span><span class=na>signal</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span><span class=err>线程等待通知</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=err>主线程开始操作</span>
</span></span><span class=line><span class=cl><span class=err>主线程唤醒</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span><span class=err>线程后续操作</span>
</span></span></code></pre></div><h3 id=83-join>8.3 Join</h3><p><code>Thread.join()</code> 可以让当前线程等待目标线程结束后再开始运行，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_Normal</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span>  <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>j</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>j</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 此时主线程不等待子线程运行完成，通常输出结果为：0
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_Join</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>j</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>j</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 此时主线程需要等待子线程运行完成，输出结果为：100000
</span></span></span></code></pre></div><h3 id=84-countdownlatch>8.4 CountDownLatch</h3><p><code>Thread.join()</code> 可以让当前线程等待目标线程结束后再开始运行，但大多数时候，你只需要等待目标线程完成特定的操作，而不必等待其完全终止。此时可以使用条件变量 Condition 来实现，也可以使用更为简单的工具类 CountDownLatch 。CountDownLatch 会在内部维护一个计数器，每次完成一个任务，则计数器减 1，当计数器为 0 时，则唤醒所有的等待线程，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>j1_Normal</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>integer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 假设这是一个耗时的任务
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>integer</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;integer：&#34;</span> <span class=o>+</span> <span class=n>integer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 不使用CountDownLatch 时，主线程不会子线程等待计算完成，此时输出通常为: 0
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_CountDown</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>number</span> <span class=o>=</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 指定计数器的初始值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>CountDownLatch</span> <span class=n>latch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>number</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>integer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 假设这是一个耗时的任务
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>integer</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 计数器减1
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>latch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>number</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待计数器为0时唤醒所有等待的线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>latch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;integer：&#34;</span> <span class=o>+</span> <span class=n>integer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用CountDownLatch 时，主线程需要等待所有的子线程计算完成后再输出，计算结果为：100
</span></span></span></code></pre></div><h3 id=85-cyclicbarrier>8.5 CyclicBarrier</h3><p>CyclicBarrier 和 CountDownLatch 类似，都是用于等待一个或者多个线程完成特定的任务后再执行某项操作，但不同的是它可以循环使用，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 每五个人完成任务后,则算一个小组已完成
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_CyclicBarrier</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>CyclicBarrier</span> <span class=n>cyclicBarrier</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=o>(</span><span class=mi>5</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;五人小组任务执行完成&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>long</span> <span class=n>l</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Double</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>()</span> <span class=o>*</span> <span class=mi>5000</span><span class=o>).</span><span class=na>longValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>l</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;任务&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;执行完成&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>cyclicBarrier</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>BrokenBarrierException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>20</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出如下：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>任务</span><span class=mi>21</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>20</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>15</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>14</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>22</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>五人小组任务执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>17</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>13</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>19</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>18</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>任务</span><span class=mi>16</span><span class=err>执行完成</span>
</span></span><span class=line><span class=cl><span class=err>五人小组任务执行完成</span>
</span></span></code></pre></div><p>基于 CyclicBarrier 的特性，通常可以用于在测试环境来模仿高并发，如每次等待一万个线程启动后再让其并发执行某项压力测试。</p><h3 id=86-semaphore>8.6 Semaphore</h3><p>信号量（Semaphore）可以看做是锁的扩展，由于锁的排它性，所以一次只允许一个线程来访问某个特定的资源， 而 Semaphore 则允许多个线程并发的访问某个特定的资源，并且可以通过配置许可证的数量来限制并发访问的线程数，因此其可以用于流量控制等场景中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_Semaphore</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 限制并发访问的线程的数量为5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Semaphore</span> <span class=n>semaphore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Semaphore</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>IncreaseTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>semaphore</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;获得锁!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>5000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>semaphore</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IncreaseTask</span> <span class=n>task</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IncreaseTask</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>task</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出如下，至多只能有五个线程并发获得锁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>13</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>15</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>16</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>18</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>17</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span><span class=line><span class=cl><span class=mi>19</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>20</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>21</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>22</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=mi>23</span><span class=err>获得锁</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span></code></pre></div><h3 id=87-locksupport>8.7 LockSupport</h3><p>LockSupport 可以在线程内的任意位置实现阻塞。它采用和 Semaphore 类似的信号量机制：它为每个线程准备一个许可，如果许可可用，则 <code>park()</code> 方法会立即返回，并且消费掉这个许可，让许可不可用；此时因为许可不可用，相应的线程就会被阻塞。而 <code>unpark()</code> 则会使得一个许可从不可用变为可用。但和 Semaphore 不同的是：它的许可不能累加，你不可能拥有超过一个许可，它永远只有一个：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_LockSupport</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;开始阻塞&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>LockSupport</span><span class=o>.</span><span class=na>park</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;解除阻塞&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread01</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread02</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>thread01</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread02</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程干预&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>LockSupport</span><span class=o>.</span><span class=na>unpark</span><span class=o>(</span><span class=n>thread01</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>LockSupport</span><span class=o>.</span><span class=na>unpark</span><span class=o>(</span><span class=n>thread02</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>线程</span><span class=mi>13</span><span class=err>开始阻塞</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>14</span><span class=err>开始阻塞</span>
</span></span><span class=line><span class=cl><span class=err>主线程干预</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>13</span><span class=err>解除阻塞</span>
</span></span><span class=line><span class=cl><span class=err>线程</span><span class=mi>14</span><span class=err>解除阻塞</span>
</span></span></code></pre></div><h2 id=九线程池>九、线程池</h2><h3 id=91-线程池分类>9.1 线程池分类</h3><p>为了避免重复创建和销毁线程而导致额外的性能开销，JDK 提供了线程池功能来实现线程的复用，具体分为以下几类：</p><ul><li><strong>newFixedThreadPool()</strong>：该方法返回一个固定线程数量的线程池。该线程池中的线程数量始终不变。当有一个新任务提交时，如果线程池中存在空闲的线程，则立即执行；如果没有，则新任务会被暂时存在一个任务队列中，待有线程空闲时再进行处理。</li><li><strong>newSingleThreadExecutor()</strong>： 该方法返回一个只有一个线程的线程池。若多个任务被提交到该线程池，则多余的任务会被保存在一个任务队列中，待线程空闲，按照先入先出的顺序被执行。</li><li><strong>newCachedThreadPool()</strong>：根据实际情况动态调整线程数量。当新任务提交时，会优先复用空闲的线程；如果所有线程均处于工作状态，则会创建新的线程来进行处理。</li><li><strong>newSingleThreadScheduledExecutor()</strong>：该方法返回一个 ScheduledExecutorService 对象，线程池大小为 1 。SeheduledExectorService 在继承 ExecutorService 的基础上还额外支持定时任务的执行。</li><li><strong>newScheduledThreadPool()</strong>：与 newSingleThreadScheduledExecutor 方法类似，但可以指定线程池中线程的数量。</li></ul><p>线程池的基本使用如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_ThreadPool</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;正在执行&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建线程池
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 提交任务到线程池
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 关闭线程池，此时不再接受新任务，但仍会等待原有的任务执行完成，如果想要立即关闭，则可以使用shutdownNow()
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=92-定时任务>9.2 定时任务</h3><p>上面线程池分类中的 <code>newSingleThreadScheduledExecutor()</code> 和 <code>newScheduledThreadPool()</code> 都可以用于创建支持定时任务的线程池，它们返回的都是 ScheduledExecutorService 接口的实例。ScheduledExecutorService 接口中定义了如下三类定时方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*在给定的时间，对任务进行一次性调度*/</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>schedule</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>ScheduledFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=nf>schedule</span><span class=o>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>callable</span><span class=o>,</span><span class=kt>long</span> <span class=n>delay</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 以上一个任务开始执行时间为起点,等待period时间后开始调度下一次任务，
</span></span></span><span class=line><span class=cl><span class=cm> * 如果任务耗时大于period，则上一次任务结束后立即执行下一次任务
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>scheduleAtFixedRate</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span><span class=kt>long</span> <span class=n>initialDelay</span><span class=o>,</span><span class=kt>long</span> <span class=n>period</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                              <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 以上一个任务开始执行时间为起点再经过delay时间后开始调度下一次任务，
</span></span></span><span class=line><span class=cl><span class=cm> * 不论任务耗时如何，上一次任务结束后都需要等待delay时间之后才可以执行下一次任务
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>scheduleWithFixedDelay</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span> <span class=kt>long</span> <span class=n>initialDelay</span><span class=o>,</span><span class=kt>long</span> <span class=n>delay</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>);</span>
</span></span></code></pre></div><p>使用示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_ScheduledTask</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>long</span> <span class=n>cacheTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>String</span> <span class=n>type</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Task</span><span class=o>(</span><span class=n>String</span> <span class=n>type</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>type</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>5000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>long</span> <span class=n>nowTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>type</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;执行耗时&#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>nowTime</span> <span class=o>-</span> <span class=n>cacheTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34;毫秒&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>cacheTime</span> <span class=o>=</span> <span class=n>nowTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 为避免相互间的影响，以下各种场景最好分别测试：
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ScheduledExecutorService</span> <span class=n>pool</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newScheduledThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 任务只会被执行一次
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pool</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=s>&#34;schedule&#34;</span><span class=o>),</span> <span class=mi>2</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 指定2秒为固定周期执行，因为项目执行耗时5秒，此时项目结束会立马执行下一次任务，所以输出的时间间隔为5秒
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pool</span><span class=o>.</span><span class=na>scheduleAtFixedRate</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=s>&#34;FixedRate&#34;</span><span class=o>),</span> <span class=mi>0</span><span class=o>,</span> <span class=mi>2</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 总是在上一次项目结束后间隔指定周期执行，因为项目耗时5秒，还需要间隔2秒执行，所以输出的时间间隔为7秒
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pool</span><span class=o>.</span><span class=na>scheduleWithFixedDelay</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>(</span><span class=s>&#34;WithFixedDelay&#34;</span><span class=o>),</span> <span class=mi>0</span><span class=o>,</span> <span class=mi>2</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// pool.shutdown();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=93-线程池内部实现>9.3 线程池内部实现</h3><p>不管是使用 <code>newFixedThreadPool()</code> 还是使用 <code>newCachedThreadPool()</code> 来创建线程池，其最终调用的都是 ThreadPoolExecutor 的构造器，定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>ThreadPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>                      <span class=c1>//核心线程数量
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=kt>int</span> <span class=n>maximumPoolSize</span><span class=o>,</span>                   <span class=c1>//最大线程数量
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=kt>long</span> <span class=n>keepAliveTime</span><span class=o>,</span>                    <span class=c1>//超过核心线程数的线程的存活时间
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>,</span>                       <span class=c1>//存活时间的单位
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>workQueue</span><span class=o>,</span>     <span class=c1>//任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>,</span>           <span class=c1>//线程工厂
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=n>RejectedExecutionHandler</span> <span class=n>handler</span><span class=o>)</span>      <span class=c1>//拒绝策略
</span></span></span></code></pre></div><p><strong>1. 线程工厂</strong></p><p>ThreadFactory 用于指定线程的创建方式，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>ThreadFactory</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Thread</span> <span class=nf>newThread</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将所有线程都设置为守护线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>thread</span><span class=o>.</span><span class=na>setDaemon</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;create&#34;</span> <span class=o>+</span> <span class=n>thread</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>thread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><strong>2. 拒绝策略</strong></p><p>当线程池中可用线程的数量为 0，并且等待队列已满的情况下，线程池需要按照 RejectedExecutionHandler 指定的拒绝策略来决定如何处理后续提交任务，JDK 中默认提供了以下四种拒绝策略：</p><ul><li><strong>ThreadPoolExecutor.AbortPolicy</strong>：直接拒绝新提交的任务，并抛出异常；</li><li><strong>ThreadPoolExecutor.DiscardPolicy</strong>：静默拒绝新提交的任务，并不抛出异常；</li><li><strong>ThreadPoolExecutor.DiscardOldestPolicy</strong>：丢弃等待时间最长的任务，然后再尝试执行新提交的任务；</li><li><strong>ThreadPoolExecutor.CallerRunsPolicy</strong>：直接在调用 execute 方法的线程中运行新提交的任务。</li></ul><h3 id=94-线程池扩展>9.4 线程池扩展</h3><p>ThreadPoolExecutor 除了提供丰富的参数来满足多样化的需求外，还支持重载其生命周期方法来进行更加灵活的扩展：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadPoolExecutor</span><span class=o>(</span><span class=mi>10</span><span class=o>,</span> <span class=mi>20</span><span class=o>,</span> <span class=mi>0</span><span class=n>L</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                         <span class=k>new</span> <span class=n>LinkedBlockingQueue</span><span class=o>&lt;&gt;())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>beforeExecute</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>r</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程&#34;</span> <span class=o>+</span> <span class=n>t</span><span class=o>.</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;准备执行&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>afterExecute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程&#34;</span> <span class=o>+</span> <span class=n>r</span> <span class=o>+</span> <span class=s>&#34;执行结束&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>terminated</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;线程池退出&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></div><h3 id=95-线程池大小>9.5 线程池大小</h3><p>线程池的大小可以通过以下公式进行估算：</p><div align=center>N<sub>cpu</sub> = CPU的数量</br>U<sub>cpu</sub> = 目标CPU的使用率， 0 <= U<sub>cpu</sub> <= 1</br>W/C = 等待时间与计算时间的比率</br></br>为保证处理器达到期望的使用率，最优的线程池的大小等于：</br>N<sub>threads</sub> = N<sub>cpu</sub> x U<sub>cpu</sub> x (1+W/C)</br></div><h2 id=十future>十、Future</h2><h3 id=101-future>10.1 Future</h3><p>如果你在创建线程时，使用的是 Runnable 接口，那么此时你是无法获取线程执行结果的，如果想要获取线程的执行结果，需要实现 Callable 接口，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J0_Callable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Integer</span> <span class=nf>call</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executors</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newSingleThreadExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Future</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>submit</span> <span class=o>=</span> <span class=n>executors</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;计算结果为:&#34;</span> <span class=o>+</span> <span class=n>submit</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>executors</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>此时通过 <code>ExecutorService.submit()</code> 进行提交，得到的是一个 Future 对象，它包含了线程的执行结果，当你调用其 <code>get()</code> 方法时，它会阻塞直至获取到线程的返回结果。</p><h3 id=102-futuretask>10.2 FutureTask</h3><p>使用 Callable 接口的限制是：其只能使用线程池提交，而不能使用单独的线程进行提交。如果想要使用单独的线程提交，可以使用 FutureTask 对其进行包装，FutureTask 是 Runnable 接口的实现类，可以用于任何场景下的提交，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Callable</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Integer</span> <span class=nf>call</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>futureTask01</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FutureTask</span><span class=o>&lt;&gt;(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>futureTask02</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FutureTask</span><span class=o>&lt;&gt;(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用独立的线程执行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>futureTask01</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newSingleThreadExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用线程池提交
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>executorService</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=n>futureTask02</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;futureTask01 计算结果为：&#34;</span> <span class=o>+</span> <span class=n>futureTask01</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;futureTask02 计算结果为：&#34;</span> <span class=o>+</span> <span class=n>futureTask01</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=103-completablefuture>10.3 CompletableFuture</h3><p>CompletableFuture 是 JDK 8 提供的增强后 Future ，它支持流式调用，等待唤醒等一系列新的功能：</p><p><strong>1. 等待唤醒</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_CompletableFuture</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Compute</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>future</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Compute</span><span class=o>(</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>future</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span> <span class=n>future</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程等待主线程运算完成····&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>Integer</span> <span class=n>integer</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程完成后续运算:&#34;</span> <span class=o>+</span> <span class=n>integer</span> <span class=o>*</span> <span class=n>integer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>ExecutionException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>intermediateResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>future</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CompletableFuture</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动子线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>new</span> <span class=n>Compute</span><span class=o>(</span><span class=n>future</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;启动主线程&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程计算完成&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 假设主线程计算结果为 100
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>intermediateResult</span> <span class=o>=</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 传递主线程的计算结果给子线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>future</span><span class=o>.</span><span class=na>complete</span><span class=o>(</span><span class=n>intermediateResult</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>启动主线程</span>
</span></span><span class=line><span class=cl>    <span class=err>子线程等待主线程运算完成····</span>
</span></span><span class=line><span class=cl>    <span class=err>主线程计算完成</span>
</span></span><span class=line><span class=cl>    <span class=err>子线程完成后续运算</span><span class=o>:</span><span class=mi>10000</span>
</span></span></code></pre></div><p><strong>2. supplyAsync</strong></p><p>CompletableFuture 的 supplyAsync 可以将一个正常的方法以异步的方式来执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J3_SupplyAsync</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;子线程计算完成&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>supplyAsync</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(</span><span class=n>J3_SupplyAsync</span><span class=o>::</span><span class=n>compute</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程等待子线程计算完成&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Integer</span> <span class=n>integer</span> <span class=o>=</span> <span class=n>supplyAsync</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;主线程计算完成:&#34;</span> <span class=o>+</span> <span class=n>integer</span> <span class=o>*</span> <span class=n>integer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><strong>3. 流式调用</strong></p><p>CompletableFuture 支持大部分流式处理的特性，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J4_StreamingCall</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;compute所在线程：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=nf>multi</span><span class=o>(</span><span class=n>Integer</span> <span class=n>integer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;multi所在线程：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>integer</span> <span class=o>*</span> <span class=n>integer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>accept</span><span class=o>(</span><span class=n>Integer</span> <span class=n>integer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;accept所在线程：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;accept方法消费掉计算结果:&#34;</span> <span class=o>+</span> <span class=n>integer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>future</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(</span><span class=n>J4_StreamingCall</span><span class=o>::</span><span class=n>compute</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>thenApply</span><span class=o>(</span><span class=n>J4_StreamingCall</span><span class=o>::</span><span class=n>multi</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>thenAccept</span><span class=o>(</span><span class=n>J4_StreamingCall</span><span class=o>::</span><span class=n>accept</span><span class=o>)</span>   <span class=c1>//值在这一步被消费掉了
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>.</span><span class=na>thenAccept</span><span class=o>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;运算结果:&#34;</span> <span class=o>+</span> <span class=n>x</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>future</span><span class=o>.</span><span class=na>get</span><span class=o>();</span> <span class=c1>//类似于流式计算的惰性求值，如果缺少这一步，不会有任何输出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><strong>4. 组合多个 CompletableFuture</strong></p><p>除了使用单个的 CompletableFuture，还可以通过 thenCompose 或 thenCombineAsync 来组合多个 CompletableFuture：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J6_Combination</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;compute 所在线程：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>100</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Integer</span> <span class=nf>multi</span><span class=o>(</span><span class=n>Integer</span> <span class=n>integer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;epr 所在线程：&#34;</span> <span class=o>+</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>integer</span> <span class=o>*</span> <span class=n>integer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ExecutionException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 组合实现方式1 thenCompose 一个计算的输入依赖另外一个计算的结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>future01</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(</span><span class=n>J6_Combination</span><span class=o>::</span><span class=n>compute</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>thenCompose</span><span class=o>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>multi</span><span class=o>(</span><span class=n>x</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>thenAccept</span><span class=o>(</span><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;运算结果:&#34;</span> <span class=o>+</span> <span class=n>x</span><span class=o>));</span>    <span class=c1>// 运算结果:10000
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>future01</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 组合实现方式2 thenCombineAsync 两个计算之间不依赖
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>future02</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(</span><span class=n>J6_Combination</span><span class=o>::</span><span class=n>compute</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>future03</span> <span class=o>=</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>J6_Combination</span><span class=o>.</span><span class=na>multi</span><span class=o>(</span><span class=mi>100</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>futureAll</span> <span class=o>=</span> <span class=n>future02</span><span class=o>.</span><span class=na>thenCombineAsync</span><span class=o>(</span><span class=n>future03</span><span class=o>,</span> <span class=o>(</span><span class=n>x</span><span class=o>,</span> <span class=n>y</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;运算结果:&#34;</span> <span class=o>+</span> <span class=n>futureAll</span><span class=o>.</span><span class=na>get</span><span class=o>());</span> <span class=c1>// 运算结果:10100
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=十一threadlocal>十一、ThreadLocal</h2><p>ThreadLocal 是以增加资源的方式来避免竞态，它会为每一个线程创建一份私有的资源，从而避免对公共资源的竞争。实例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 线程不安全的SimpleDateFormat
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J1_ThreadUnsafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>SimpleDateFormat</span> <span class=n>sdf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>sum</span> <span class=o>=</span> <span class=mi>1000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>CountDownLatch</span> <span class=n>countDownLatch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>sum</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>atomicInteger</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Date</span> <span class=n>parse</span> <span class=o>=</span> <span class=n>sdf</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=s>&#34;2018-08-08 08:08:08&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>parse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>atomicInteger</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ParseException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>countDownLatch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sum</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>countDownLatch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;格式化成功次数为：&#34;</span> <span class=o>+</span> <span class=n>atomicInteger</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>因为 SimpleDateFormat 是线程不安全的，因此其格式化成功的次数总是小于 100 次，此时可以使用 ThreadLocal 进行改写，让每个线程都持有自己独立的格式化器，具体如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>J2_ThreadSafe</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span> <span class=n>threadLocal</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>sum</span> <span class=o>=</span> <span class=mi>1000</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>CountDownLatch</span> <span class=n>countDownLatch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>sum</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>atomicInteger</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Task</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果当前线程中不存在该值，则创建一个
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 使用线程私有的SimpleDateFormat
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Date</span> <span class=n>parse</span> <span class=o>=</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>parse</span><span class=o>(</span><span class=s>&#34;2018-08-08 08:08:08&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>parse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>atomicInteger</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ParseException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>countDownLatch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ExecutorService</span> <span class=n>executorService</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newFixedThreadPool</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sum</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>executorService</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Task</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>countDownLatch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;格式化成功次数为：&#34;</span> <span class=o>+</span> <span class=n>atomicInteger</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=参考资料>参考资料</h2><ol><li>黄文海 . Java 多线程编程实战指南（核心篇）. 电子工业出版社 . 2017-04</li><li>葛一鸣 . 实战 Java 高并发程序设计（第 2 版）. 电子工业出版社 . 2018-10</li><li>周志明 . 深入理解 Java 虚拟机（第 2 版）. 机械工业出版社 . 2013-09-01</li><li>汪文君 . Java 高并发编程详解 . 机械工业出版社 . 2018-06</li></ol></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>