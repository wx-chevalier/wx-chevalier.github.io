<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="Originalï¼Œä¸­æ–‡ç¿»è¯‘ Stale props and zombie children in Redux å¦‚æœä½ è¯»äº† react-redux v7 å‘è¡Œç‰ˆæœ¬çš„æ–‡æ¡£ï¼Œä½ å¯èƒ½ä¼šç¢°åˆ°è¿‡æ—¶çš„ props å’Œâ€œåƒµå°¸å­èŠ‚ç‚¹â€è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„éƒ¨åˆ†é—®é¢˜ã€‚å³ä½¿å®ƒå·²ç»å†™çš„éå¸¸æ¸…æ™°æ˜äº†ï¼Œä½†å¯¹äºä¸ç†Ÿæ‚‰è¿™ä¸ªé—®é¢˜çš„äººæ¥è¯´ä¼šæ„Ÿåˆ°è¿·èŒ«ã€‚"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-stale-props-and-zombie-children-in-redux/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.fab3cd1900ae35687457073b2d518207.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-stale-props-and-zombie-children-in-redux/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-stale-props-and-zombie-children-in-redux/"><meta property="og:title" content="2020-Stale props and zombie children in Redux | Next-gen Tech Edu"><meta property="og:description" content="Originalï¼Œä¸­æ–‡ç¿»è¯‘ Stale props and zombie children in Redux å¦‚æœä½ è¯»äº† react-redux v7 å‘è¡Œç‰ˆæœ¬çš„æ–‡æ¡£ï¼Œä½ å¯èƒ½ä¼šç¢°åˆ°è¿‡æ—¶çš„ props å’Œâ€œåƒµå°¸å­èŠ‚ç‚¹â€è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„éƒ¨åˆ†é—®é¢˜ã€‚å³ä½¿å®ƒå·²ç»å†™çš„éå¸¸æ¸…æ™°æ˜äº†ï¼Œä½†å¯¹äºä¸ç†Ÿæ‚‰è¿™ä¸ªé—®é¢˜çš„äººæ¥è¯´ä¼šæ„Ÿåˆ°è¿·èŒ«ã€‚"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>2020-Stale props and zombie children in Redux | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=3327b066db820bfd24e462308d640ff9><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>æœç´¢</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=å…³é—­><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=åˆ‡æ¢å¯¼èˆª>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>ç¬”è®°ï¼ˆä¸‡ç¯‡ï¼‰</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>çŸ¥è¯†å›¾è°±</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>å®éªŒå®¤</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft æ–¹å—ä¸–ç•Œ</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D çŸ¥è¯†å¡ç‰Œ</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>å…¶ä»–é˜…è¯»æ¸ é“</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>çŸ¥ä¹</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>æ˜é‡‘</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=æœç´¢><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">99.å‚è€ƒèµ„æ–™</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>æœç´¢...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id7eaf8fa3142381bed6b6df34a0d29f69")' href=#id7eaf8fa3142381bed6b6df34a0d29f69 aria-expanded=false aria-controls=id7eaf8fa3142381bed6b6df34a0d29f69 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/>Redux</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id7eaf8fa3142381bed6b6df34a0d29f69 aria-expanded=false aria-controls=id7eaf8fa3142381bed6b6df34a0d29f69><i class="fa-solid fa-angle-down" id=caret-id7eaf8fa3142381bed6b6df34a0d29f69></i></a></div><ul class="nav docs-sidenav collapse show" id=id7eaf8fa3142381bed6b6df34a0d29f69><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id65cd0ba16a3f1e791d42fdbac5eb843a")' href=#id65cd0ba16a3f1e791d42fdbac5eb843a aria-expanded=false aria-controls=id65cd0ba16a3f1e791d42fdbac5eb843a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.å‚è€ƒèµ„æ–™</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id65cd0ba16a3f1e791d42fdbac5eb843a aria-expanded=false aria-controls=id65cd0ba16a3f1e791d42fdbac5eb843a><i class="fa-solid fa-angle-down" id=caret-id65cd0ba16a3f1e791d42fdbac5eb843a></i></a></div><ul class="nav docs-sidenav collapse show" id=id65cd0ba16a3f1e791d42fdbac5eb843a><li class="child level active"><a href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-stale-props-and-zombie-children-in-redux/>2020-Stale props and zombie children in Redux</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id27d5b9909e1c54c10fedab783dbacee3")' href=#id27d5b9909e1c54c10fedab783dbacee3 aria-expanded=false aria-controls=id27d5b9909e1c54c10fedab783dbacee3 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/dva/>Dva</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id27d5b9909e1c54c10fedab783dbacee3 aria-expanded=false aria-controls=id27d5b9909e1c54c10fedab783dbacee3><i class="fa-solid fa-angle-right" id=caret-id27d5b9909e1c54c10fedab783dbacee3></i></a></div><ul class="nav docs-sidenav collapse" id=id27d5b9909e1c54c10fedab783dbacee3><li class="child level"><a href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/dva/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>å¿«é€Ÿå¼€å§‹</a></li></ul></div><li class="child level"><a href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/redux-hooks/>Redux Hooks</a></li><li class="child level"><a href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/redux-form/>redux-form</a></li><li class="child level"><a href=/books/react-notes/03.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/redux/state-%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/>State ç»“æ„è®¾è®¡</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>ç›®å½•</a></li></ul><nav id=TableOfContents><ul><li><a href=#ç†è§£-react-redux>ç†è§£ <code>react-redux</code></a></li><li><a href=#é—®é¢˜>é—®é¢˜</a></li><li><a href=#ä¸€ä¸ªä¾‹å­>ä¸€ä¸ªä¾‹å­</a></li><li><a href=#ç¬¬ä¸€ç§æ–¹æ³•>ç¬¬ä¸€ç§æ–¹æ³•</a></li><li><a href=#unstable_batchedupdates><code>unstable_batchedUpdates</code></a></li><li><a href=#åµŒå¥—è®¢é˜…æ¨¡å‹>åµŒå¥—è®¢é˜…æ¨¡å‹</a></li><li><a href=#react-ä¸Šä¸‹æ–‡>React ä¸Šä¸‹æ–‡</a></li><li><a href=#hooks>Hooks</a></li><li><a href=#æ”¶è·>æ”¶è·</a></li><li><a href=#å‚è€ƒæ–‡ç« >å‚è€ƒæ–‡ç« </a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=ç‹ä¸‹é‚€æœˆç†Šçš„å¾®ä¿¡å…¬ä¼—å·></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>2020-Stale props and zombie children in Redux</h1><div class=article-style><blockquote><p><a href=https://kaihao.dev/posts/Stale-props-and-zombie-children-in-Redux target=_blank rel=noopener>Original</a>ï¼Œ<a href=https://github.com/xitu/gold-miner/blob/master/article/2020/Stale-props-and-zombie-children-in-Redux.md target=_blank rel=noopener>ä¸­æ–‡ç¿»è¯‘</a></p></blockquote><h1 id=stale-props-and-zombie-children-in-redux>Stale props and zombie children in Redux</h1><p>å¦‚æœä½ è¯»äº† <code>react-redux</code> v7 å‘è¡Œç‰ˆæœ¬çš„æ–‡æ¡£ï¼Œä½ å¯èƒ½ä¼šç¢°åˆ°<a href=https://react-redux.js.org/api/hooks#stale-props-and-zombie-children target=_blank rel=noopener>è¿‡æ—¶çš„ props å’Œâ€œåƒµå°¸å­èŠ‚ç‚¹â€</a>è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„éƒ¨åˆ†é—®é¢˜ã€‚å³ä½¿å®ƒå·²ç»å†™çš„éå¸¸æ¸…æ™°æ˜äº†ï¼Œä½†å¯¹äºä¸ç†Ÿæ‚‰è¿™ä¸ªé—®é¢˜çš„äººæ¥è¯´ä¼šæ„Ÿåˆ°è¿·èŒ«ã€‚è¿™ç¯‡æ–‡ç« æ·±å…¥æ¢ç©¶äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶è®²è§£äº† <code>react-redux</code> æ˜¯å¦‚ä½•è§£å†³çš„ã€‚</p><h2 id=ç†è§£-react-redux>ç†è§£ <code>react-redux</code></h2><p>è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆç†è§£ <code>Redux</code>ï¼Œæˆ–è€…æ›´å…·ä½“çš„æ¥è¯´æ˜¯ <code>react-redux</code>ã€‚æˆ‘ä»¬å°†é€šè¿‡é‡æ–°å®ç° <code>Redux</code> å’Œ <code>react-redux</code> çš„æ ¸å¿ƒåŠŸèƒ½æ¥è¿›è¡Œç†è§£ã€‚æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸ºäº†æ¼”ç¤ºçš„ç›®çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šé‡æ„æ¯ä¸€ä¸ªåŠŸèƒ½å¹¶å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œåªæ˜¯è¶³ä»¥è®©æˆ‘ä»¬ç†è§£æˆ‘ä»¬éœ€è¦è§£å†³çš„é—®é¢˜ã€‚</p><p><code>Redux</code> çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåœ¨å…¨å±€çŠ¶æ€çº§åˆ«ä¸Šå¼ºåˆ¶ä½¿ç”¨ Flux æ¨¡å¼æ“ä½œçš„è®¢é˜…æ¨¡å‹ã€‚åœ¨ JavaScript ä¸­ä¸€ä¸ªè®¢é˜…æ¨¡å‹é€šå¸¸é€šè¿‡åˆ©ç”¨äº‹ä»¶ç›‘å¬å™¨æ¥å®ç°çš„ã€‚æˆ‘ä»¬ <code>subscribe</code> æ›´æ”¹å¹¶é€šè¿‡ <code>reducers</code> æ”¹å˜çŠ¶æ€ï¼Œå¹¶å‘å¸ƒç»“æœç»™æ¯ä¸€ä¸ªç›‘å¬è€…ä»¥æ‰§è¡Œæ›´æ–°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createStore</span> <span class=o>=</span> <span class=p>(</span><span class=nx>reducer</span><span class=p>,</span> <span class=nx>initialState</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=nx>initialState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>listeners</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getState</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>subscribe</span><span class=p>(</span><span class=nx>listener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>listeners</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>listener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Returns an unsubscribe function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>index</span> <span class=o>=</span> <span class=nx>listeners</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>listener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>listeners</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>index</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>dispatch</span><span class=p>(</span><span class=nx>action</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>state</span> <span class=o>=</span> <span class=nx>reducer</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>action</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>listeners</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>listener</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>listener</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>ä¸Šé¢æ˜¯ä¸€ä¸ª <code>Redux</code> çš„ <code>createStore</code> API çš„ç®€å•å®ç°ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ <code>store</code> å¯ä»¥ä½¿ç”¨ <code>getState()</code> æ¥è·å–çŠ¶æ€ï¼Œé€šè¿‡ <code>subscribe(listener)</code> æ¥è®¢é˜…ç›‘å¬å™¨ï¼Œä»¥åŠé€šè¿‡ <code>dispatch(action)</code> æ¥åˆ†å‘åŠ¨ä½œï¼ˆdispatch actionï¼‰ï¼Œå°±åƒæˆ‘ä»¬ä¹ æƒ¯ä½¿ç”¨çš„å®˜æ–¹ API ä¸€æ ·ã€‚</p><p>ä¸‹ä¸€æ­¥æ˜¯å¼„æ˜ç™½å¦‚ä½•å°†å…¶å’Œ <code>React</code> é›†æˆã€‚æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ª <a href=https://react-redux.js.org/api/provider target=_blank rel=noopener><code>&lt;Provider></code></a> ç»„ä»¶é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ <code>store</code>ï¼Œä¸€ä¸ª <a href=https://react-redux.js.org/api/connect target=_blank rel=noopener><code>connect</code></a> é«˜é˜¶ç»„ä»¶ç”¨äºåŒ…è£…å±•ç¤ºç»„ä»¶ï¼Œæœ€è¿‘çš„ç‰ˆæœ¬ä¸­ï¼Œ<a href=https://react-redux.js.org/api/hooks#useselector target=_blank rel=noopener><code>useSelector</code></a> é’©å­åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å–ä»£ <code>connect</code>ã€‚</p><p><code>&lt;Provider></code> API ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ <code>React</code> ä¸Šä¸‹æ–‡ä¼ é€’ç”± <code>createStore</code> åˆ›å»ºçš„ <code>store</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Context</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>createContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Provider</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>store</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Context.Provider</span> <span class=na>value</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>}&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>Context.Provider</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></div><p>åœ¨æˆ‘ä»¬è¿›å…¥ <code>connect</code> å’Œ <code>useSelector</code> çš„å®ç°ä¹‹å‰ï¼Œæœ€å¥½é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„é—®é¢˜ã€‚å®ç°ç»†èŠ‚å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äº <code>Redux</code> çš„å†å²ï¼Œå¦‚æœæˆ‘ä»¬å¯¹è¦è§£å†³çš„é—®é¢˜æœ‰æ‰å®çš„èƒŒæ™¯ä¼šæ›´å¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ›´è½»æ¾çš„è®¨è®ºå®ç°çš„æ¼”å˜ã€‚</p><h2 id=é—®é¢˜>é—®é¢˜</h2><p>è®©æˆ‘ä»¬å¿«é€Ÿå›é¡¾ä¸€ä¸‹æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜çš„<a href=https://react-redux.js.org/api/hooks#stale-props-and-zombie-children target=_blank rel=noopener>å®šä¹‰</a>ã€‚</p><blockquote><p><strong>è¿‡æ—¶çš„ props</strong> æ„å‘³ç€åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼š</p><ul><li>é€‰æ‹©å™¨å‡½æ•°ä¾èµ–äºæ­¤ç»„ä»¶çš„ props æ¥æå–æ•°æ®</li><li>åŠ¨ä½œçš„ç»“æœä¼šå¯¼è‡´çˆ¶ç»„ä»¶<strong>å°†</strong>é‡æ–°æ¸²æŸ“å¹¶ä¼ é€’æ–°çš„ props</li><li>ä½†æ˜¯ï¼Œåœ¨è¯¥ç»„ä»¶æœ‰æœºä¼šä½¿ç”¨é‚£äº›æ–°çš„ props é‡æ¸²æŸ“ä¹‹å‰ï¼Œè¿™ä¸ªç»„ä»¶çš„é€‰æ‹©å™¨å‡½æ•°å°±ä¼šæ‰§è¡Œ</li></ul><p><strong>åƒµå°¸å­èŠ‚ç‚¹</strong>ä¸“é—¨æŒ‡ä»¥ä¸‹æƒ…å†µï¼š</p><ul><li>é¦–å…ˆï¼ŒæŒ‚è½½äº†å¤šä¸ªåµŒå¥—ä¸”ç›¸å…³è”çš„ç»„ä»¶ï¼Œå¯¼è‡´å­ç»„ä»¶åœ¨çˆ¶ç»„ä»¶å‰è®¢é˜…äº† <code>store</code></li><li>åˆ†å‘ä¸€ä¸ªä» <code>store</code> ä¸­åˆ é™¤æ•°æ®çš„åŠ¨ä½œï¼Œä¾‹å¦‚åˆ é™¤ä¸€ä¸ª todo é¡¹</li><li>çˆ¶ç»„ä»¶å°†å› æ­¤åœæ­¢æ¸²æŸ“è¯¥å­ç»„ä»¶</li><li>ä½†æ˜¯ï¼Œç”±äºå­ç»„ä»¶å…ˆè¿›è¡Œäº†è®¢é˜…ï¼Œå®ƒçš„è®¢é˜…æ‰§è¡Œäºçˆ¶ç»„ä»¶åœæ­¢æ¸²æŸ“å®ƒä¹‹å‰ï¼Œå½“å®ƒåŸºäº props ä» <code>store</code> ä¸­è¯»å–ä¸€ä¸ªå€¼æ—¶ï¼Œè¿™ä¸ªæ•°æ®ä¸å¤å­˜åœ¨ï¼Œå¹¶ä¸”å¦‚æœè¯»å–é€»è¾‘ä¸å®Œå–„çš„è¯ï¼Œåˆ™å¯èƒ½å¼•å‘é”™è¯¯ã€‚</li></ul></blockquote><p>å¦‚æœä½ ä»”ç»†çš„é˜…è¯»ä»¥ä¸Šå†…å®¹ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œè¿™äº›é—®é¢˜ä¸æ˜¯ä¸¤ä¸ªåˆ†å¼€çš„é—®é¢˜ï¼Œè€Œæ˜¯ä¸€ä¸ªå•ç‹¬çš„é—®é¢˜ã€‚ä»–ä»¬éƒ½æ˜¯<strong>è¿‡æ—¶çš„ props</strong> é—®é¢˜ï¼Œ<strong>åƒµå°¸å­èŠ‚ç‚¹</strong>æè¿°äº†ä¸€ä¸ªç‰¹å®šåœºæ™¯å¸¸è§çš„å­é—®é¢˜ã€‚</p><p>æˆ‘ä»¬ç°åœ¨è¿˜ä¸å¿…äº†è§£æ‰€æœ‰å®šä¹‰ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œæä¾›ä¸€ä¸ªç¤ºä¾‹æ¥æ¼”ç¤ºä»£ç é—®é¢˜ã€‚</p><h2 id=ä¸€ä¸ªä¾‹å­>ä¸€ä¸ªä¾‹å­</h2><p>æˆ‘ä»¬å°†æ„å»ºçš„ç¤ºä¾‹æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ Todo åº”ç”¨ç¨‹åºï¼ˆæˆ‘çŸ¥é“ï¼Œduhï¼‰ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°†ç®€å•çš„æ¸²æŸ“ä¸€ç»„ <code>todos</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†å‘ <code>DELETE</code> åŠ¨ä½œæ¥åˆ é™¤å…¶ä¸­çš„ä¸€ä¸ªã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç»§ç»­ï¼Œåˆ›å»ºä¸€ä¸ª <code>store</code> å’Œå¯¹åº”çš„ <code>reducer</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>reducer</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s2>&#34;DELETE&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>todos</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>todos</span><span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>todo</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>todo</span><span class=p>.</span><span class=nx>id</span> <span class=o>!==</span> <span class=nx>action</span><span class=p>.</span><span class=nx>payload</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>createStore</span><span class=p>(</span><span class=nx>reducer</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>todos</span><span class=o>:</span> <span class=p>[{</span> <span class=nx>id</span><span class=o>:</span> <span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=nx>content</span><span class=o>:</span> <span class=s2>&#34;A&#34;</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>ç„¶åï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>&lt;todo></code> ç»„ä»¶ï¼Œå¹¶ä½¿ç”¨ <code>connect</code> è¿›è¡ŒåŒ…è£…ï¼ˆ<strong>æˆ‘ä»¬åœ¨è¿™ä»…ä½¿ç”¨ <code>connect</code> é«˜é˜¶ç»„ä»¶æ„å»º APIã€‚ç¨åå†è®¨è®º <code>useSelector</code></strong>ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Todo</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>content</span><span class=p>,</span> <span class=nx>dispatch</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>li</span>
</span></span><span class=line><span class=cl>    <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>dispatch</span><span class=p>({</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;DELETE&#34;</span><span class=p>,</span> <span class=nx>payload</span><span class=o>:</span> <span class=nx>id</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>TodoContainer</span> <span class=o>=</span> <span class=nx>connect</span><span class=p>((</span><span class=nx>state</span><span class=p>,</span> <span class=nx>ownProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>content</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>todos</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>todo</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>todo</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>ownProps</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}))(</span><span class=nx>Todo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>TodoList</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>todos</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>todos</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>todo</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>TodoContainer</span> <span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>todo</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span> <span class=na>id</span><span class=o>=</span><span class=p>{</span><span class=nx>todo</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>))}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>TodoListContainer</span> <span class=o>=</span> <span class=nx>connect</span><span class=p>((</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>todos</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>todos</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}))(</span><span class=nx>TodoList</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ReactDOM</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Provider</span> <span class=na>store</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>}&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TodoListContainer</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>Provider</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;root&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></div><p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸¤ä¸ªå±•ç¤ºç»„ä»¶ <code>&lt;Todo></code> å’Œ <code>&lt;TodoList></code>ï¼Œç„¶åç”¨ <code>connect</code> é«˜é˜¶ç»„ä»¶è¿›è¡ŒåŒ…è£…ã€‚è¿™åªæ˜¯ä½¿ç”¨ <code>Redux</code> æ¨¡å¼è¿›è¡Œç¼–å†™çš„ä¸€ä¸ªéå¸¸ç®€å•åŸºç¡€çš„ Todo åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åºå¹¶ç‚¹å‡»ä»»ä½• <code>&lt;Todo></code> é¡¹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶åˆ é™¤ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬äº†è§£äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè§„èŒƒï¼Œæˆ‘ä»¬å°†åœ¨ <code>react-redux</code> ä¸­æ„å»ºæˆ‘ä»¬çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶ã€‚</p><h2 id=ç¬¬ä¸€ç§æ–¹æ³•>ç¬¬ä¸€ç§æ–¹æ³•</h2><p>æˆ‘ä»¬å…ˆä» <code>react-redux</code> v4 ç‰ˆæœ¬å¼€å§‹ï¼Œè¿™æ—¶äº‹æƒ…å˜å¾—æ›´ç®€å•ï¼Œå¹¶ä¸” API é¦–æ¬¡æ˜¯<strong>å®Œæ•´</strong>å’Œ<strong>ç¨³å®š</strong>çš„ã€‚è®©æˆ‘ä»¬æ„å»ºæ›´ç®€å•ç‰ˆæœ¬çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶ APIã€‚<strong>æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨é’©å­å’Œå…¶ä»–ç°ä»£çš„ React ç‰¹æ€§æ¥å®ç°ï¼Œä½†æ˜¯åº”è¯¥ä¸åŸºäºç±»çš„ API å¤§è‡´ç›¸åŒã€‚æ˜¯å…³äºæœªæ¥ç”Ÿæ´»çš„ä¸€ä»¶å¥½äº‹ï¼Œå¯¹å§ï¼Ÿ</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// For demonstration purpose, we intentionally omit `mapDispatchToProps`,
</span></span></span><span class=line><span class=cl><span class=c1>// since it&#39;s almost the same as `mapStateToProps`.
</span></span></span><span class=line><span class=cl><span class=c1>// Instead, we just pass down `dispatch` as a prop.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>connect</span> <span class=o>=</span> <span class=p>(</span><span class=nx>mapStateToProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>WrappedComponent</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>state</span><span class=p>,</span> <span class=nx>setState</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useState</span><span class=p>(()</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>(),</span> <span class=nx>props</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>propsRef</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useRef</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>propsRef</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setState</span><span class=p>(</span><span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>(),</span> <span class=nx>propsRef</span><span class=p>.</span><span class=nx>current</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>setState</span><span class=p>,</span> <span class=nx>propsRef</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>WrappedComponent</span> <span class=p>{</span><span class=na>...props</span><span class=p>}</span> <span class=p>{</span><span class=na>...state</span><span class=p>}</span> <span class=na>dispatch</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>}</span> <span class=p>/&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>å¦‚æœä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„è¯ï¼Œè¿™å¯èƒ½æ˜¯ <code>connect</code> æœ€ç›´æ¥çš„å®ç°ã€‚</p><p>è®©æˆ‘ä»¬ç‚¹å‡» Todo é¡¹å»åˆ é™¤å®ƒï¼Œçœ‹æ˜¯å¦æœ‰æ•ˆå·¥ä½œã€‚å—¯ï¼Œå¥½å§ï¼Œä¸€åˆ‡éƒ½å´©æºƒäº†ã€‚å®ƒä¸èƒ½å·¥ä½œäº†ï¼Œå‡ºä»€ä¹ˆé—®é¢˜äº†ï¼Ÿ</p><p>æˆ‘ä»¬åƒ JavaScript è¿è¡Œæ—¶ä¸€æ ·ä¸€æ­¥ä¸€æ­¥å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œçœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><ol><li>åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œ<code>&lt;TodoList></code> å’Œ <code>&lt;Todo></code> åœ¨ <code>useEffect</code> ä¸­è®¢é˜…äº† <code>store</code>ã€‚å› ä¸º <code>useEffect</code> ï¼ˆæˆ–è€… <code>componentDidMount</code>ï¼‰ä»ä¸‹å¾€ä¸Šè§¦å‘ï¼Œ<code>&lt;Todo></code> é¦–å…ˆè¿›è¡Œè®¢é˜…ï¼Œç„¶åæ˜¯ <code>&lt;TodoList></code>ã€‚</li><li>ç”¨æˆ·ç‚¹å‡» <code>&lt;Todo></code> ç»„ä»¶ï¼Œå‘ <code>store</code> åˆ†å‘äº†ä¸€ä¸ª <code>DELETE</code> åŠ¨ä½œï¼ŒæœŸå¾…è¯¥é¡¹è¢«åˆ é™¤ã€‚</li><li><code>store</code> æ¥æ”¶åˆ°è¿™ä¸ªåŠ¨ä½œåï¼Œé€šè¿‡ <strong>reducer</strong> æ¥è¿è¡Œï¼Œç„¶åæŠŠ <code>todos</code> çš„çŠ¶æ€æ”¹ä¸ºç©ºæ•°ç»„ <code>{ todos: [] }</code>ã€‚</li><li>ç„¶å <code>store</code> è°ƒç”¨å·²è®¢é˜…çš„ç›‘å¬å™¨ã€‚å› ä¸º <code>&lt;Todo></code> å…ˆè¿›è¡Œçš„è®¢é˜…ï¼Œå› æ­¤ä¹Ÿä¼šå…ˆè°ƒç”¨ç›‘å¬å™¨ã€‚</li><li><code>&lt;Todo></code> ä¸­çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶è§¦å‘ç›‘å¬å™¨ï¼Œè°ƒç”¨å¸¦æœ‰æœ€æ–°çš„ stateï¼ˆ<code>store.getState()</code>ï¼‰å’Œæœ€æ–°çš„ propsï¼ˆ<code>propsRef.current</code>ï¼‰çš„ <code>mapStateToProps</code>ã€‚</li><li><strong>å› ä¸ºæœ€æ–°çš„ state ä¸å†æœ‰ <code>todos</code> çš„ stateï¼Œå°è¯•å»è®¿é—® <code>state.todos[ownProps.id]</code> å¯¼è‡´ä¸º <code>undefined</code>ã€‚è°ƒç”¨ <code>(undefined).content</code> å°†å¯¼è‡´é”™è¯¯ ğŸ’¥ã€‚</strong></li></ol><p>è¿™å°±æ˜¯åœ¨åŠ¨ä½œä¸­è‘—åçš„<code>åƒµå°¸å­èŠ‚ç‚¹</code>é—®é¢˜ã€‚<strong>åœ¨ Redux åˆ†å‘åï¼Œstate ä¼šåŒæ­¥æ”¹å˜ï¼Œä½†æ˜¯æ¸²æŸ“åˆ™ä¸ä¼šã€‚å½“æˆ‘ä»¬å°è¯•åœ¨ <code>mapStateToProps</code> å‡½æ•°ä¸­è®¿é—® <code>ownProps</code>ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨å…¶ä¸­è¿è¡Œè¿‡æ—¶çš„ props</strong>ã€‚è¿™æ˜¯ç±»ä¼¼çš„åŸå› ï¼ˆä¹‹ä¸€ï¼‰<a href=https://github.com/facebook/react/issues/11527#issuecomment-360199710 target=_blank rel=noopener>ä¸ºä»€ä¹ˆ <code>setState</code> ä¸æ˜¯åŒæ­¥çš„</a>ï¼Œç®¡ç† <code>React</code> ä¸–ç•Œä¹‹å¤–çš„ä¸€äº›çŠ¶æ€é€šå¸¸éœ€è¦æ³¨æ„ä¸€äº›é™·é˜±ã€‚</p><p>æˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œä¿®å¤ï¼Ÿå¦‚æœæ˜¯å› ä¸ºæˆ‘ä»¬ç®¡ç†äº† <code>React</code> <strong>ä¹‹å¤–</strong>çš„çŠ¶æ€ï¼Œæ˜¯å¦æˆ‘ä»¬å¯èƒ½æŠŠçŠ¶æ€æ”¾åˆ° <code>React</code> <strong>å†…éƒ¨</strong>ï¼Ÿæˆ‘ä»¬å¸Œæœ› <code>props</code> å§‹ç»ˆä¿æŒæœ€æ–°ï¼Œè¿™ä»…åœ¨ <code>React</code> ä½¿ç”¨æœ€æ–°çš„ props æ¸²æŸ“ç»„ä»¶æ—¶å‘ç”Ÿã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¸è¿™æ ·åšå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠ <code>mapStateToProps</code> æ”¹åˆ°æ¸²æŸ“é˜¶æ®µï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç›‘å¬å™¨å›è°ƒä¸­è§¦å‘æ›´æ–°æ¥å¼ºåˆ¶é‡æ–°æ¸²æŸ“ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>connect</span> <span class=o>=</span> <span class=p>(</span><span class=nx>mapStateToProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>WrappedComponent</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>(),</span> <span class=nx>props</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>forceUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>forceUpdate</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>WrappedComponent</span> <span class=p>{</span><span class=na>...props</span><span class=p>}</span> <span class=p>{</span><span class=na>...state</span><span class=p>}</span> <span class=na>dispatch</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>}</span> <span class=p>/&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»è¯¥é¡¹æ—¶ï¼Œä»–æˆåŠŸåˆ é™¤äº†è‡ªå·±ï¼Œä¸‡å² ğŸ‰ï¼</p><p>ç¨åï¼ŒPM æ¥è¯¢é—®æˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†åˆ é™¤å»¶è¿Ÿåˆ° 1 ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå•å‡»è¯¥é¡¹åä¸ä¼šç«‹å³åˆ é™¤ï¼Œè€Œæ˜¯ 1 ç§’åå°†å…¶åˆ é™¤ã€‚</p><p>å—¯ï¼Œå¬èµ·æ¥å¾ˆç®€å•ï¼æ˜¯å§ï¼Ÿ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>const Todo = ({ id, content, dispatch }) =&gt; (
</span></span><span class=line><span class=cl>  &lt;li
</span></span><span class=line><span class=cl>    onClick={() =&gt; {
</span></span><span class=line><span class=cl><span class=gd>-      dispatch({ type: &#39;DELETE&#39;, payload: id });
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+      setTimeout(() =&gt; {
</span></span></span><span class=line><span class=cl><span class=gi>+        dispatch({ type: &#39;DELETE&#39;, payload: id });
</span></span></span><span class=line><span class=cl><span class=gi>+      }, 1000);
</span></span></span><span class=line><span class=cl><span class=gi></span>    }}
</span></span><span class=line><span class=cl>  &gt;
</span></span><span class=line><span class=cl>    {content}
</span></span><span class=line><span class=cl>  &lt;/li&gt;
</span></span><span class=line><span class=cl>);
</span></span></code></pre></div><p>æˆ‘ä»¬éå¸¸æœ‰ä¿¡å¿ƒå®ƒä¼šå·¥ä½œï¼Œæˆ‘ä»¬è¿›è¡Œä¿å­˜ï¼Œæäº¤ï¼Œç”šè‡³æ²¡æœ‰æµ‹è¯•ï¼ˆä½ æ°¸è¿œä¸è¦è¿™æ ·åšï¼‰ç›´æ¥å‘å¸ƒã€‚æ­¤åä¸ä¹…ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†å¤§é‡çš„æŠ•è¯‰ï¼Œæ¯ä¸ªäººéƒ½æƒŠæ…Œå¤±æªã€‚å½“ç”¨æˆ·ç‚¹å‡»å¹¶ç­‰å¾… 1 ç§’åï¼Œåº”ç”¨ç¨‹åºå´©æºƒäº†ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½å´©æºƒäº†</p><h2 id=unstable_batchedupdates><code>unstable_batchedUpdates</code></h2><p>ä¸ºä»€ä¹ˆæ·»åŠ ä¸€ä¸ªç®€å•çš„ <code>setTimeout</code> ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨ç¨‹åºå´©æºƒå‘¢ï¼Ÿè¦ç ”ç©¶è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›å¹¶å†æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ã€æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä»£ç ä¸­æ·»åŠ ä¸€å † <code>console.log</code> æ¥éªŒè¯è¾“å‡ºï¼Œä½†æ˜¯ä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œåœ¨è¿™é‡Œåªæä¾›ç»“æœã€‚å‰ 4 æ­¥å’Œä¹‹å‰ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ä»ç¬¬ 5 æ­¥å¼€å§‹ã€‚</p><p><strong>åœ¨æ·»åŠ  <code>setTimeout</code> ä¹‹å‰ï¼š</strong></p><ol start=5><li><code>&lt;Todo></code> ä¸­çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶è§¦å‘ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>forceUpdate()</code> æ¥è°ƒåº¦é‡æ¸²æŸ“ã€‚</li><li><code>&lt;TodoList></code> ä¸­çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶è§¦å‘ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>forceUpdate()</code> æ¥è°ƒåº¦é‡æ¸²æŸ“ã€‚</li><li><code>&lt;TodoList></code> æ¸²æŸ“ï¼Œè¿”å›çš„å…ƒç´ æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ <code>[]</code>ï¼Œåªæ¸²æŸ“ <code>&lt;ul></code> å®¹å™¨ï¼Œ<code>&lt;Todo></code> ç»„ä»¶ä¸ä¼šæ¸²æŸ“ã€‚</li></ol><p>æ²¡æœ‰é”™è¯¯ï¼Œå®ƒæ­£å¸¸å·¥ä½œã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å½“æˆ‘ä»¬æ·»åŠ  <code>setTimeout</code> åï¼Œä½•æ—¶ä¼šåˆ†å‘åŠ¨ä½œã€‚å‰ 4 æ­¥ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨ <strong>ï¼ˆ1ï¼‰</strong> å’Œ <strong>ï¼ˆ2ï¼‰</strong> ç›´æ¥å­˜åœ¨ 1 ç§’å»¶è¿Ÿã€‚</p><p><strong>åœ¨æ·»åŠ  <code>setTimeout</code> ä¹‹åï¼š</strong></p><ol start=5><li><code>&lt;Todo></code> ä¸­çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶è§¦å‘ç›‘å¬å™¨ï¼Œè°ƒç”¨ <code>forceUpdate()</code> æ¥è°ƒåº¦é‡æ¸²æŸ“ã€‚</li><li><code>&lt;Todo></code> æ¸²æŸ“ï¼Œè°ƒç”¨å¸¦æœ‰æœ€æ–°çš„ state å’Œæœ€æ–°çš„ props çš„ <code>mapStateToProps</code>ã€‚</li><li>å› ä¸ºçˆ¶ç»„ä»¶ï¼ˆ<code>&lt;TodoList></code>ï¼‰è¿˜æ²¡æœ‰æ¸²æŸ“ï¼Œ<code>&lt;Todo></code> ä¸­çš„ props å®é™…ä¸Šæ˜¯<strong>è¿‡æ—¶çš„ props</strong>ï¼Œä½†æ˜¯ state å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚è°ƒç”¨ <code>state.todos[ownProps.id]</code> å¯¼è‡´ä¸º <code>undefined</code>ï¼Œè°ƒç”¨ <code>(undefined).content</code> å¯¼è‡´ä¸€ä¸ªé”™è¯¯ã€‚</li></ol><p>è¯·æ³¨æ„ï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œç¬¬å…­æ­¥æ˜¯ä¸åŒçš„ã€‚å‰è€…åœ¨çˆ¶ç»„ä»¶ï¼ˆ<code>&lt;TodoList></code>ï¼‰ä¸­è°ƒç”¨å¦ä¸€ä¸ªç›‘è§†å™¨ï¼Œè€Œåè€…é¦–å…ˆæ¸²æŸ“å­ç»„ä»¶ï¼ˆ<code>&lt;Todo></code>ï¼‰ã€‚ <strong>ä¼¼ä¹æ˜¯è°ƒç”¨ <code>forceUpdate()</code> ä¸ä¹…åï¼Œ<code>&lt;Todo></code> åŒæ­¥é‡æ¸²æŸ“äº†ï¼</strong></p><p>â€œç­‰ç­‰ï¼Œæˆ‘ä»¥ä¸º <code>setState</code> æ˜¯å¼‚æ­¥çš„ï¼Ÿâ€ æ˜¯çš„ï¼Œå½“ç„¶ä¸ä¼šã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ <code>setState</code> å®é™…ä¸Šæ˜¯å¼‚æ­¥çš„ï¼Œ<a href=https://twitter.com/dan_abramov/status/959507572951797761 target=_blank rel=noopener>åªè¦ <code>setState</code> åœ¨ React äº‹ä»¶å¤„ç†å›è°ƒä¸­è°ƒç”¨å³å¯</a>ï¼ŒReact å°†ç¡®ä¿åœ¨äº‹ä»¶å¤„ç†å›è°ƒä¸­<strong>æ‰¹å¤„ç†</strong>æ‰€æœ‰çš„æ›´æ–°ï¼Œå¹¶ä¸€æ¬¡å¼‚æ­¥æ‰§è¡Œæ‰€æœ‰çš„æ¸²æŸ“ã€‚é€šè¿‡åœ¨ <code>setTimeout</code> å›è°ƒä¸­åŒ…è£… <code>setState</code>ï¼Œæˆ‘ä»¬<strong>é€‰æ‹©å–æ¶ˆ</strong> è¿™ä¸ªç‰¹æ€§ï¼Œå¹¶ä½¿ <code>setState</code> åŒæ­¥ã€‚</p><p>åœ¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒReact æŠŠ <code>&lt;Todo></code> ç»„ä»¶çš„ <code>forceUpdate()</code> å’Œ <code>&lt;TodoList></code> ç»„ä»¶çš„ <code>forceUpdate()</code> æ”¾åœ¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å›è°ƒä¸­ï¼Œç„¶åæœ€ç»ˆè®©å®ƒä»¬ä¸€æ¬¡è¿›è¡Œæ¸²æŸ“ã€‚**è¿™é‡Œå¦ä¸€ä¸ªé‡è¦çš„è¯´æ˜æ˜¯ï¼Œåœ¨é‡æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼ŒReact å°†ç¡®ä¿ä»ä¸‹åˆ°ä¸Šæ‰§è¡Œã€‚**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆçˆ¶ç»„ä»¶ï¼ˆ<code>&lt;TodoList></code>ï¼‰é¦–å…ˆè¿›è¡Œé‡æ¸²æŸ“ï¼Œç„¶åè·³è¿‡ <code>&lt;Todo></code> æ¸²æŸ“çš„åŸå› ã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œåœ¨å°†æ¥çš„æŸä¸ªç‰ˆæœ¬ä¸­ï¼Œ<a href=https://twitter.com/dan_abramov/status/959557687158689792 target=_blank rel=noopener>React å°†å¯èƒ½ç¡®ä¿æ‰€æœ‰çš„ <code>setState</code> éƒ½æ˜¯å¼‚æ­¥çš„</a>ï¼Œè¿™æ„å‘³ç€å³ä½¿æˆ‘ä»¬æŠŠ <code>setState</code> æ”¾åˆ° <code>setTimeout</code> é‡Œé¢ï¼Œæ›´æ–°ä»ç„¶å°†åˆ†æ‰¹è¿›è¡Œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ä»…ä»…æ˜¯è¿›è¡Œç­‰å¾…å—ï¼Ÿå½“ç„¶ä¸æ˜¯ã€‚ç°åœ¨è¿˜æœ‰å¦ä¸€ç§è§£å†³æ–¹æ³•ã€‚</p><p>Reactï¼Œæˆ–è€…æ›´å‡†ç¡®çš„è¯´ï¼Œ<code>react-dom</code>ï¼Œæœ‰ä¸€ä¸ªéšè—ç‰¹æ€§ï¼š<code>unstable_batchedUpdates</code>ï¼Œèƒ½å¤Ÿç²¾ç¡®çš„å®ç°æˆ‘ä»¬æƒ³è¦ç¡®ä¿çš„æ›´æ–°åœ¨ä¸€èµ·æ‰¹å¤„ç†ã€‚<a href=https://react-redux.js.org/api/batch target=_blank rel=noopener>React ä¸­äº‹ä»¶å¤„ç†ç¨‹åºå·²ç»åœ¨å†…éƒ¨ä½¿ç”¨æ­¤ API</a>ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆåœ¨äº‹ä»¶å¤„ç†ä¸­ <code>setState</code> å°†æ˜¯å¼‚æ­¥çš„ã€‚<strong>(æ­£å¦‚ä»–çš„åå­—æš—ç¤ºçš„é‚£æ ·ï¼Œæˆ‘ä»¬åº”è¯¥å®Œå…¨ç†è§£åå†ä½¿ç”¨å®ƒã€‚æˆ‘ä»¬å·²ç»è¢«è­¦å‘Šäº†ã€‚</strong>)</p><p>æˆ‘ä»¬ç®€å•çš„åœ¨ <code>unstable_batchedUpdates</code> å›è°ƒä¸­æ¥åŒ…è£…æˆ‘ä»¬çš„ <code>dispatch</code> æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gi>+import { unstable_batchedUpdates } from &#39;react-dom&#39;;
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>const Todo = ({ id, content, dispatch }) =&gt; (
</span></span><span class=line><span class=cl>  &lt;li
</span></span><span class=line><span class=cl>    onClick={() =&gt; {
</span></span><span class=line><span class=cl>      setTimeout(() =&gt; {
</span></span><span class=line><span class=cl><span class=gd>-        dispatch({ type: &#39;DELETE&#39;, payload: id });
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+        unstable_batchedUpdates(() =&gt; {
</span></span></span><span class=line><span class=cl><span class=gi>+          dispatch({ type: &#39;DELETE&#39;, payload: id });
</span></span></span><span class=line><span class=cl><span class=gi>+        });
</span></span></span><span class=line><span class=cl><span class=gi></span>      }, 1000);
</span></span><span class=line><span class=cl>    }}
</span></span><span class=line><span class=cl>  &gt;
</span></span><span class=line><span class=cl>    {content}
</span></span><span class=line><span class=cl>  &lt;/li&gt;
</span></span><span class=line><span class=cl>);
</span></span></code></pre></div><p>è¿˜æœ‰å¦ä¸€ä¸ªåœ°æ–¹æˆ‘ä»¬å¯ä»¥æ·»åŠ  <code>unstable_batchedUpdates</code>ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•çš„åŒ…è£…æˆ‘ä»¬ store åˆ†å‘æ–¹æ³•ï¼Œæ¥ä»£æ›¿åŒ…è£…æ¯ä¸ªå¸¦æœ‰ <code>unstable_batchedUpdates</code> çš„ <code>dispatch</code> è°ƒç”¨ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>dispatch(action) {
</span></span><span class=line><span class=cl>  state = reducer(state, action);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+  unstable_batchedUpdates(() =&gt; {
</span></span></span><span class=line><span class=cl><span class=gi></span>    listeners.forEach(listener =&gt; {
</span></span><span class=line><span class=cl>      listener();
</span></span><span class=line><span class=cl>    });
</span></span><span class=line><span class=cl><span class=gi>+  });
</span></span></span><span class=line><span class=cl><span class=gi></span>},
</span></span></code></pre></div><p>å®ƒå·¥ä½œè‰¯å¥½ã€‚è¿™å®é™…ä¸Šå°±æ˜¯ <code>react-redux</code> v4 çš„å®ç°ï¼Œæ²¡æœ‰è®¸å¤šå…¶ä»–å¿…è¦çš„ä¼˜åŒ–ï¼Œåƒ<a href=https://github.com/reduxjs/react-redux/blob/v4.4.0/src/components/connect.js#L238-L270 target=_blank rel=noopener>è®°ä½è¿”å›çš„å…ƒç´ </a>ï¼Œæˆ–è€…<a href=https://github.com/reduxjs/react-redux/pull/348 target=_blank rel=noopener>å¦‚æœ <code>mapStateToProps</code> å‡½æ•°ä¸ä¾èµ–äº <code>ownProps</code>ï¼Œåˆ™å°½æ—©è¿›è¡Œæ›´æ–°</a>ã€‚ å³ä½¿è¿›è¡Œäº†è¿™äº›ä¼˜åŒ–ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡çŠ¶æ€æ›´æ”¹æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶ä¼šå¼ºåˆ¶å®¹å™¨ç»„ä»¶è¿›è¡Œé‡æ¸²æŸ“ã€‚å¯¹äºä¸€ä¸ªå¾ˆå°çš„åº”ç”¨ç¨‹åºï¼Œå®ƒåº”è¯¥è¿˜ä¸é”™ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªå¯æ‰©å±•çš„å…¨å±€çŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒå¾ˆå¿«å°±å˜å¾—æ— æ³•æ¥å—ã€‚</p><h2 id=åµŒå¥—è®¢é˜…æ¨¡å‹>åµŒå¥—è®¢é˜…æ¨¡å‹</h2><p>æˆ‘ä»¬å¸Œæœ›æœ€å°åŒ–å®¹å™¨ç»„ä»¶ä¸­çš„æ¸²æŸ“è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬æƒ³å‡ºä¸€ç§æ–¹æ³•æ¥åœ¨ <code>forceUpdate()</code> è°ƒç”¨ä¹‹å‰çš„ç›‘å¬å™¨å›è°ƒä¸­å°½æ—©è·³è¿‡æ›´æ–°ã€‚æˆ‘ä»¬è¿˜æƒ³å¼ºåˆ¶æ‰§è¡Œ<strong>è‡ªä¸Šè€Œä¸‹çš„å‘½ä»¤</strong>ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå†æå‡ºè¿‡æ—¶çš„ props å’Œåƒµå°¸å­èŠ‚ç‚¹é—®é¢˜ã€‚</p><p>Redux å›¢é˜Ÿæå‡ºäº†ä¸€ç§æœ‰è¶£çš„æ–¹æ³•æ¥è§£å†³ <code>react-redux</code> v5 ä¸­çš„é—®é¢˜ã€‚é€šè¿‡ä½¿ç”¨<strong>åµŒå¥—è®¢é˜…æ¨¡å‹</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å°½æ—©è·³è¿‡æ›´æ–°ï¼Œè¿˜å¯ä»¥é¿å…è¿‡æ—¶çš„ props é—®é¢˜ã€‚</p><p><strong>åŸºæœ¬æ€æƒ³æ˜¯ï¼Œæˆ‘ä»¬å»¶è¿Ÿç›‘å¬å™¨å›è°ƒçš„è§¦å‘ï¼Œç›´åˆ°çˆ¶çº§å®Œå…¨é‡æ¸²æŸ“ä¸ºæ­¢ï¼Œç”¨æ¥ä»£æ›¿åˆ†æ‰¹åœ°è¿›è¡Œæ›´æ–°ä»¥ä½¿å…¶è‡ªä¸Šè€Œä¸‹</strong>ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ›´æ–°å§‹ç»ˆæ˜¯è‡ªä¸Šè€Œä¸‹çš„ï¼Œå­©å­ä¸ä¼šåœ¨ç›‘å¬å™¨å›è°ƒä¸­è·å¾—<strong>è¿‡æ—¶çš„ props</strong>ï¼Œå› ä¸ºå½“æˆ‘ä»¬è§¦å‘å›è°ƒæ—¶ï¼Œprops å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚</p><p>ä¸€ä¸ªä»£ç ç‰‡æ®µä»·å€¼ä¸€åƒå¥è¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createSubscription</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>listeners</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>subscribe</span><span class=p>(</span><span class=nx>listener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>listeners</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>listener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Returns an unsubscribe function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>index</span> <span class=o>=</span> <span class=nx>listeners</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>listener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>listeners</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>index</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>notifyUpdates</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>listeners</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>listener</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>listener</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>createSubscription</code>ï¼Œå®ƒå’Œ <code>createStore</code> å‡½æ•°éå¸¸åƒï¼Œå®ƒä¹Ÿæœ‰ç›‘å¬å™¨ï¼Œå’Œ <code>subscribe</code> å‡½æ•°ã€‚ä¸åŒä¹‹å¤„æ˜¯å®ƒä¸ä¿å­˜ä»»ä½•çš„çŠ¶æ€ï¼Œä¹Ÿæœ‰ä¸€ä¸ª <code>notifyUpdates()</code> æ–¹æ³•ã€‚è¿™ä¸ª <code>notifyUpdates()</code> æ–¹æ³•ç”¨æ¥é€šçŸ¥å®ƒçš„æ‰€æœ‰çš„å­©å­èŠ‚ç‚¹ï¼Œæ¥è§¦å‘å®ƒä»¬çš„ç›‘å¬å™¨å›è°ƒï¼Œæˆ‘ä»¬å°†åœ¨ä¹‹åè¿›è¡Œæ›´å¤šçš„è®¨è®ºã€‚</p><p>ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œè¿™åªæ˜¯åˆ›å»ºäº‹ä»¶è§¦å‘å™¨çš„å‡½æ•°ï¼Œè¿™æ˜¯éå¸¸æ­£ç¡®çš„ï¼Œå¹¶ä¸”å®ƒå°±è¿™ä¹ˆçš„ç®€å•ã€‚ä¸‹ä¸€æ­¥æ˜¯ç¼–å†™æ–°çš„ <code>connect</code> é«˜é˜¶ç»„ä»¶ï¼Œå¹¶å°†å…¶ <code>mapStateToProps</code> æ”¾å…¥ç›‘å¬å™¨å›è°ƒä¸­ï¼Œä»¥å°½æ—©è·³è¿‡æ›´æ–°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>connect</span> <span class=o>=</span> <span class=p>(</span><span class=nx>mapStateToProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>WrappedComponent</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>subStore</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useMemo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>store</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>createSubscription</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>store</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[,</span> <span class=nx>forceUpdate</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useReducer</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>stateRef</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useRef</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>stateRef</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>(),</span> <span class=nx>props</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>propsRef</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useRef</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>propsRef</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>nextState</span> <span class=o>=</span> <span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>(),</span> <span class=nx>propsRef</span><span class=p>.</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>shallowEqual</span><span class=p>(</span><span class=nx>stateRef</span><span class=p>.</span><span class=nx>current</span><span class=p>,</span> <span class=nx>nextState</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Bail out updates early, immediately notify updates to children
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>subStore</span><span class=p>.</span><span class=nx>notifyUpdates</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>forceUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>propsRef</span><span class=p>,</span> <span class=nx>stateRef</span><span class=p>,</span> <span class=nx>forceUpdate</span><span class=p>,</span> <span class=nx>subStore</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>subStore</span><span class=p>.</span><span class=nx>notifyUpdates</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span> <span class=c1>// Don&#39;t pass dependencies so that it will run after every re-render
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Provider</span> <span class=na>store</span><span class=o>=</span><span class=p>{</span><span class=nx>subStore</span><span class=p>}&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>WrappedComponent</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=na>...props</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=na>...stateRef.current</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dispatch</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Provider</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>è¿™é‡Œæœ‰å¾ˆå¤šäº‹æƒ…ï¼Œè®©æˆ‘ä»¬ä¸€ä¸€åˆ†è§£ã€‚åŸºæœ¬å®ç°æœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬çš„ç¬¬ä¸€ç§æ–¹æ³•ã€‚æˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬åˆšåˆšå®ç°çš„ <code>subscription</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>subStore</code>ï¼Œå¹¶å°†å…¶ä¸åŸå§‹çš„ <code>store</code> åˆå¹¶ã€‚ç»“æœï¼Œè¯¥ <code>subscribe</code> æ–¹æ³•å°†è¦†ç›– <code>store</code> ä¸­åŸå§‹çš„ <code>subscribe</code> æ–¹æ³•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªåä¸ºçš„ <code>notifyUpdates</code> çš„æ–°æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬åœ¨ 2 ä¸ªåœ°æ–¹è¿è¡Œ <code>mapStateToProps</code> é€‰æ‹©å™¨ã€‚æˆ‘ä»¬åœ¨æ¸²æŸ“é˜¶æ®µè¿è¡Œæˆ‘ä»¬çš„ <code>mapStateToProps</code>ï¼Œä»¥ä¾¿åœ¨å›è°ƒä¸­è°ƒç”¨ <code>forceUpdate()</code> ä¹‹åæ€»æ˜¯è·å¾—æœ€æ–°çš„ propsã€‚åœ¨æˆ‘ä»¬çš„ç›‘å¬å™¨å›è°ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹Ÿç›´æ¥åœ¨å®ƒå†…éƒ¨ä½¿ç”¨ <code>mapStateToProps</code>ï¼Œå¹¶ä¸”è¿›è¡Œäº†ä¸€ä¸ªæµ…å¯¹æ¯”ï¼Œä»¥ç¡®å®šå¦‚æœæ˜ å°„çŠ¶æ€ä¸å˜ï¼Œæ˜¯å¦å¯ä»¥è·³è¿‡æ›´æ–°ã€‚</p><p>åœ¨ return è¯­å¥ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡ç”¨è¯¥ <code>&lt;Provider></code> ç»„ä»¶åŒ…è£…æˆ‘ä»¬çš„ç»„ä»¶ï¼Œå¹¶ç”¨æ–°åˆ›å»ºçš„ <code>subStore</code> æ¥æ˜¾å¼è¦†ç›– store ä¸Šä¸‹æ–‡ã€‚è¿™æ ·ç»„ä»¶æ ‘ä¸‹çš„æ¯ä¸ªç»„ä»¶éƒ½å°†è·å¾— <code>subStore</code> è€Œä¸æ˜¯æœ€é¡¶å±‚çš„ <code>store</code>ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºå¦ä¸€ä¸ªå«åš <code>subStore.notifyUpdates()</code> çš„å‰¯ä½œç”¨ï¼Œä»¥ä¾¿<strong>åœ¨æ¯æ¬¡æ¸²æŸ“ä¹‹å</strong>è°ƒç”¨ç»„ä»¶æ ‘ä¸‹çš„æ‰€æœ‰å­çº§ã€‚<strong>ç›´åˆ°ä¸‹ä¸€ä¸ªæ¸²æŸ“ä¸­æœ€æ–°çš„ props å·²ç»ä¼ é€’ç»™å­èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šè°ƒç”¨å­èŠ‚ç‚¹çš„å›è°ƒ</strong>ï¼Œä»è€Œæ¶ˆé™¤äº†<strong>è¿‡æ—¶çš„ props</strong> é—®é¢˜ã€‚</p><p>å†æ¬¡å•å‡»è¯¥é¡¹ï¼Œè¯¥é¡¹ç°åœ¨å°†æˆåŠŸåˆ é™¤è€Œä¸ä¼šå¼•å‘ä»»ä½•é”™è¯¯ã€‚ä¸ºäº†ä½¿æµç¨‹æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼Œä»¥ç¡®ä¿å…¶æŒ‰é¢„æœŸå·¥ä½œã€‚</p><ol><li>åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åï¼Œ<code>&lt;Todo></code> è®¢é˜… <code>&lt;TodoList></code> åˆ›å»ºçš„ <code>subStore</code> ç„¶åé€šè¿‡ <code>useEffect</code> ä¸­çš„ <code>Provider</code> å‘ä¸‹ä¼ é€’ã€‚</li><li>ç„¶å <code>&lt;TodoList></code> è®¢é˜…åœ¨å®ƒçš„ <code>useEffect</code> ä¸­é€šè¿‡ <code>createStore</code> åˆ›å»ºçš„å…¨å±€çš„ <code>store</code>ã€‚</li><li>ç”¨æˆ·ç‚¹å‡» <code>&lt;Todo></code>ï¼Œå‘ store åˆ†å‘ä¸€ä¸ª <code>DELETE</code> åŠ¨ä½œï¼ŒæœŸæœ›è¯¥é¡¹è¢«åˆ é™¤ã€‚</li><li>store æ”¶åˆ°è¿™ä¸ªåŠ¨ä½œï¼Œé€šè¿‡ <strong>reducer</strong> è¿è¡Œå®ƒã€‚å¹¶å°† <code>todos</code> çŠ¶æ€æ›´æ”¹ä¸ºä¸€ä¸ªç©ºæ•°ç»„ <code>{ todos: [] }</code>ã€‚</li><li><code>store</code> ç„¶åè°ƒç”¨è®¢é˜…ç›‘å¬å™¨ã€‚å› ä¸ºä»…æœ‰ä¸€ä¸ªç›‘å¬å™¨è®¢é˜…äº† <code>store</code>ï¼Œä»…ä»… <code>&lt;TodoList></code> çš„ç›‘å¬å™¨å°†è°ƒç”¨ï¼Œ<code>&lt;Todo></code> çš„åˆ™ä¸ä¼šã€‚</li><li><code>&lt;TodoList></code> è°ƒç”¨ç›‘å¬å™¨å›è°ƒï¼Œè°ƒç”¨å¸¦æœ‰æœ€æ–°çŠ¶æ€ï¼ˆ<code>store.getState()</code>ï¼‰å’Œæœ€æ–° props ï¼ˆ<code>propsRef.current</code>ï¼‰çš„ <code>mapStateToProps</code>ã€‚</li><li>æ˜ å°„çŠ¶æ€å¹¶ä¸å®Œå…¨ç›¸ç­‰ï¼Œå› æ­¤æˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ <code>forceUpdate()</code> è¿›è¡Œæ›´æ–°ã€‚<code>&lt;TodoList></code> ç„¶ååœ¨æ¸²æŸ“é˜¶æ®µå†æ¬¡è°ƒç”¨ <code>mapStateToProps</code> å¹¶è¿”å›ä¸€ä¸ªç©ºçš„ <code>&lt;ul></code> å› ä¸ºåˆ—è¡¨ä¸­ä¸å†æœ‰ä»»ä½•é¡¹ã€‚</li><li><code>&lt;Todo></code> å°†ä¼šå¸è½½ï¼Œå› æ­¤å®ƒå°†è°ƒç”¨å‰¯ä½œç”¨ä¸­çš„ <code>unsubscribe</code> å‡½æ•°ï¼Œä» <code>subStore</code> ä¸­çš„ <code>listeners</code> æ•°ç»„ä¸­ç§»é™¤å®ƒçš„ç›‘å¬å™¨å›è°ƒã€‚</li><li><code>&lt;TodoList></code> è°ƒç”¨å‰¯ä½œç”¨å¹¶åœ¨æ¸²æŸ“åè¿è¡Œ <code>subStore.notifyUpdates()</code>ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨ <code>subStore</code> ä¸­ç•™ä¸‹ä»»ä½•è¦è°ƒç”¨çš„ä¾¦å¬å™¨ï¼Œå› æ­¤æ•´ä¸ªè¿‡ç¨‹æˆåŠŸå®Œæˆã€‚</li></ol><p>å¯¹äºä»ç„¶å‰©ä¸‹ä¸€äº›å­èŠ‚ç‚¹çš„æƒ…å†µï¼Œæ¯ä¸ªå­èŠ‚ç‚¹å°†éšåè°ƒç”¨å®ƒä»¬çš„ç›‘å¬å™¨å›è°ƒã€‚å› ä¸ºå®ƒä»¬å°†åœ¨æ¸²æŸ“åè¢«è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒä»¬å°†ä»çˆ¶ç»„ä»¶é‚£é‡Œè·å¾—æœ€æ–°çš„ propsã€‚</p><p>æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å­ç»„ä»¶ä¸­è¿è¡Œäº†ä¸¤æ¬¡ <code>mapStateToProps</code>ï¼Œä¸€æ¬¡æ˜¯åœ¨ç›‘å¬å™¨å›è°ƒå†…ï¼Œè€Œå¦ä¸€æ¬¡æ˜¯ç”±çˆ¶ç»„ä»¶çš„é‡æ¸²æŸ“è§¦å‘çš„ã€‚åè€…åº”è¯¥åœ¨å‰è€…ä¹‹å‰å‘ç”Ÿï¼Œä½†æ˜¯çŠ¶æ€å’Œ props éƒ½åº”è¯¥æ˜¯æœ€æ–°çš„ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡è¿è¡Œä¸­éƒ½åº”è¯¥ç›¸åŒã€‚ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è®°ä½è¿™ä¸ª <code>mapStateToProps</code> å‡½æ•°ï¼Œä»¥ä¾¿åœ¨è¿™ç§æƒ…å†µä¸‹ä¸å¿…è°ƒç”¨ä¸¤æ¬¡ã€‚</p><p>æ³¨æ„ï¼Œæˆ‘ä»¬ç”šè‡³ä¸å¿…åœ¨ <code>notifyUpdates</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>unstable_batchedUpdates</code>ã€‚åŒä¸€å±‚æ¬¡ç»“æ„è°ƒç”¨ä¸­çš„æ›´æ–°è¢«<strong>åˆ’åˆ†</strong>åˆ°ä¸åŒçš„ <code>subStore</code>ï¼Œå­ç»„ä»¶ä»…åœ¨çˆ¶ç»„ä»¶å®Œæˆé‡æ¸²æŸ“åæ‰è°ƒç”¨ç›‘å¬å™¨å›è°ƒï¼Œå› æ­¤æ— éœ€å°†å®ƒä»¬ä¸€èµ·æ‰¹å¤„ç†ã€‚</p><p>è¿™æ˜¯ <code>react-redux</code> åœ¨ v5 å’Œ v7 ä¸­å®ç°åµŒå¥—è®¢é˜…æ¨¡å‹çš„åŸºæœ¬æ€æƒ³ï¼ˆå½“ç„¶ï¼Œç¼ºå°‘å¤§é‡çš„ä¼˜åŒ–ï¼‰ã€‚<a href=https://github.com/reduxjs/react-redux/pull/416 target=_blank rel=noopener>å½“æˆ‘ä»¬å¯ä»¥ææ—©æ‰¹å‡†æ›´æ–°å¹¶ä¸”ä¸å¿…å°½å¯èƒ½è°ƒç”¨ React çš„æ—¶å€™ï¼Œç»“æœå°†å¤§å¤§æé«˜æ€§èƒ½</a>ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ‘†è„± <code>unstable_batchedUpdates</code>ï¼Œè¿™æ˜¯å¾ˆéš¾åŒ…å«åœ¨ <code>react-redux</code>ä¸­çš„ï¼ˆå®ƒæ¥è‡ª <code>react-dom</code> ä½† <code>react-redux</code> ä¹Ÿå¯ä»¥åœ¨å…¶ä»–æ¸²æŸ“å™¨ä¸­ä½¿ç”¨ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©ï¼</p><h2 id=react-ä¸Šä¸‹æ–‡>React ä¸Šä¸‹æ–‡</h2><p>æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•å¯ä»¥é€šè¿‡ä½¿ç”¨ React ä¸Šä¸‹æ–‡æ¥è§£å†³ã€‚æˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨å®ƒæ¥ä¼ é€’ <code>store</code> å®ä¾‹ï¼Œä¸ºä»€ä¹ˆä¸è®©å®ƒä¹Ÿå¯¹çŠ¶æ€æ›´æ”¹åšå‡ºååº”ï¼Ÿå½“ React ä¸Šä¸‹æ–‡çš„ç¨³å®šç‰ˆæœ¬é¦–æ¬¡å‡ºç°æ—¶ï¼Œ<code>react-context</code> v6 é‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼¼ä¹å®¹æ˜“å¾—å¤šï¼Œå¹¶ä¸”ç”±äºçŠ¶æ€æ¸²æŸ“ä¼ æ’­æ˜¯ç”± React å¤„ç†çš„ï¼Œå› æ­¤æˆ‘ä»¬è½»æ¾è·å¾—äº†è‡ªä¸Šè€Œä¸‹çš„æ›´æ–°ã€‚æ²¡æœ‰æ›´å¤šçš„ <code>unstable_batchedUpdates</code>ï¼Œæ²¡æœ‰æ›´å¤šçš„åµŒå¥—è®¢é˜…æ¨¡å‹ã€‚äº‹ä»¶ç›‘å¬å™¨çš„æ•°é‡ä¹Ÿå‡å°‘åˆ°äº†ä¸€ä¸ªï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è®¢é˜…æ¯ä¸ª connect é«˜é˜¶ç»„ä»¶ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// Again, there&#39;re lack of many optimizations and error handlings
</span></span></span><span class=line><span class=cl><span class=c1>// in this implementation for demonstration purpose.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Provider</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>store</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>state</span><span class=p>,</span> <span class=nx>setState</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useState</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setState</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>setState</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>context</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useMemo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>store</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>state</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>Context.Provider</span> <span class=na>value</span><span class=o>=</span><span class=p>{</span><span class=nx>context</span><span class=p>}&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>Context.Provider</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>connect</span> <span class=o>=</span> <span class=p>(</span><span class=nx>mapStateToProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>WrappedComponent</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>dispatch</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mappedState</span> <span class=o>=</span> <span class=nx>mapStateToProps</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>props</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>WrappedComponent</span> <span class=p>{</span><span class=na>...props</span><span class=p>}</span> <span class=p>{</span><span class=na>...mappedState</span><span class=p>}</span> <span class=na>dispatch</span><span class=o>=</span><span class=p>{</span><span class=nx>dispatch</span><span class=p>}</span> <span class=p>/&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¦‚æ­¤å®Œç¾ï¼Œå®ç°çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥åƒç¬¬ä¸€ç§æ–¹æ³•ï¼ˆ<code>react-redux</code> v4ï¼‰ä¸€æ ·è¿›è¡Œä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦å¤„ç†è¿‡æ—¶çš„ props å’Œåƒµå°¸å­èŠ‚ç‚¹é—®é¢˜ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é€šå¸¸åœ¨ç”¨æˆ·åŒºåŸŸä¸­æ‰€åšçš„äº‹æƒ…ï¼Œä»¥åŠä¸€äº›å—æ¬¢è¿çš„åº“ï¼Œåƒ <a href=https://github.com/jamiebuilds/unstated-next target=_blank rel=noopener><code>unstated-next</code></a> ä¸ºæˆ‘ä»¬æ‰€åšçš„äº‹æƒ…ã€‚ä¸è¿‡ï¼Œå¯¹äºåªæœ‰ä¸€ä¸ªå…¨å±€ store çš„ <code>Redux</code> æ¥è¯´ï¼Œæ‹¥æœ‰å¤šä¸ªæ›´å°çš„ store å¯èƒ½æ˜¯ä¸€ä¸ªå®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚æ€§èƒ½æˆæœ¬éå¸¸é«˜ï¼Œè¶³ä»¥è¿«ä½¿æˆ‘ä»¬å†æ¬¡å¯¹å…¶è¿›è¡Œè¿­ä»£ã€‚</p><p>è¿˜è®°å¾—ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä»ç¬¬ä¸€ç§æ–¹æ³•è¿­ä»£åˆ°åµŒå¥—è®¢é˜…æ¨¡å‹å—ï¼Ÿè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨è°ƒç”¨ <code>setState</code> å’Œé‡æ¸²æŸ“ç»„ä»¶ä¹‹å‰å°±å°½æ—©è·³è¿‡æ›´æ–°ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œç”±äºæˆ‘ä»¬åªèƒ½åœ¨æ¸²æŸ“é˜¶æ®µè·å¾—æ•´ä¸ªçŠ¶æ€ï¼Œ<strong>å› æ­¤è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»å§‹ç»ˆå…ˆè°ƒç”¨ <code>setState</code> ç„¶åé‡æ¸²æŸ“ç»„ä»¶æ‰èƒ½åœ¨ä¹‹åè·å¾—æœ€æ–°çŠ¶æ€</strong>ã€‚åªæœ‰åˆ°é‚£æ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½è°ƒç”¨ <code>mapStateToProps</code> æ¥è·å¾—ç»„ä»¶å…³å¿ƒçš„æ˜ å°„çŠ¶æ€ã€‚å®é™…ä¸Šï¼Œåœ¨ <code>react-redux</code> v6 é¦–æ¬¡å‘å¸ƒæ—¶ï¼Œæœ‰ä¸€äº›<a href=https://github.com/reduxjs/react-redux/issues/1164 target=_blank rel=noopener>æ€§èƒ½ä¸‹é™äº‹ä»¶</a>ã€‚æ­¤å¤–ï¼Œ<a href=https://github.com/facebook/react/issues/14110#issuecomment-448074060 target=_blank rel=noopener>React å›¢é˜Ÿç”šè‡³æåˆ°ä»–ä»¬ä¸å»ºè®®å½“æ—¶ä½¿ç”¨ React ä¸Šä¸‹æ–‡è¿›è¡Œç±»ä¼¼ flux çš„çŠ¶æ€ä¼ æ’­</a>ã€‚</p><h2 id=hooks>Hooks</h2><p>React ä¸Šä¸‹æ–‡ä¸æ˜¯ React å®¶æ—ä¸­çš„æœ€æ–°æˆå‘˜ï¼Œæˆ‘ä»¬è¿˜æœ‰ hookï¼ˆé’©å­ï¼‰ï¼<code>react-redux</code> v7 å¼•å…¥äº†æ–°çš„åŸºäºé’©å­çš„ APIï¼Œè¿™äº› API ä½¿ä»£ç æ›´åŠ ç®€å•æ˜“æ‡‚ã€‚æœ€é‡è¦çš„é’©å­å¯èƒ½æ˜¯ <code>useSelector</code> é’©å­ã€‚</p><p>ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬å°†é‡å†™æˆ‘ä»¬çš„ Todo åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨é’©å­ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œ<code>&lt;Todo></code> å’Œ <code>&lt;TodoList></code> ç»„ä»¶ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Todo</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>id</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>content</span> <span class=o>=</span> <span class=nx>useSelector</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>todos</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>todo</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>todo</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>).</span><span class=nx>content</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>dispatch</span> <span class=o>=</span> <span class=nx>useDispatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>li</span>
</span></span><span class=line><span class=cl>      <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dispatch</span><span class=p>({</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;DELETE&#34;</span><span class=p>,</span> <span class=nx>payload</span><span class=o>:</span> <span class=nx>id</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>TodoList</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>todos</span> <span class=o>=</span> <span class=nx>useSelector</span><span class=p>((</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>todos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>todos</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>todo</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Todo</span> <span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>todo</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span> <span class=na>id</span><span class=o>=</span><span class=p>{</span><span class=nx>todo</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>))}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä¸å†éœ€è¦é‚£äº›å¸¦æœ‰é’©å­çš„é«˜é˜¶å‡½æ•°å®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>useSelector</code> å’Œ <code>useDispatch</code> æ¥è·å–é€‰å®šçš„çŠ¶æ€å’Œåˆ†å‘æ–¹æ³•ã€‚è¯·æ³¨æ„ä¸€ä¸ªå¾®å°çš„å·®åˆ«åœ¨æ™®é€šçš„æ—§çš„ <code>mapStateToProps</code> å’Œ <code>useSelector</code> ä¹‹é—´çš„æ˜¯æˆ‘ä»¬ä¸å†è·å–çŠ¶æ€ï¼ˆstateï¼‰çš„<strong>å¯¹è±¡</strong>ï¼Œå¹¶å°†å…¶ä¼ æ’­åˆ° propsï¼Œè€Œæ˜¯ä»…ä»…å¾—åˆ°çŠ¶æ€æœ¬èº«ã€‚å› æ­¤ä»£æ›¿è·å¾— <code>{ content }</code>ï¼Œæˆ‘ä»¬åªéœ€è¦å¾—åˆ° <code>content</code>ã€‚åœ¨æˆ‘ä»¬çš„ <code>setState</code> ä¸­ä¼šç¨å¾®æ”¹å˜æˆ‘ä»¬çš„ç›¸ç­‰æ€§æ£€æŸ¥ã€‚</p><p><code>useDispatch</code> é’©å­å®ç°ä¹Ÿå¾ˆç®€å•ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>useDispatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Content</span><span class=p>).</span><span class=nx>dispatch</span><span class=p>;</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è½»æ¾åˆ›å»ºæˆ‘ä»¬çš„ <code>useSelector</code> é’©å­ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>useSelector</span> <span class=o>=</span> <span class=p>(</span><span class=nx>selector</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[,</span> <span class=nx>forceUpdate</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useReducer</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=nx>selector</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>forceUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>forceUpdate</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>ä½†æ˜¯ï¼Œå®ƒç”šè‡³è¿˜ä¸èƒ½ç«‹å³ä½¿ç”¨ã€‚æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šé‡æ¸²æŸ“æ‰€æœ‰çš„ <strong>connected</strong> ç»„ä»¶ã€‚ä½¿ç”¨é’©å­ API ä¼šæ›´åŠ ç³Ÿç³•ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªä¸­é—´å®¹å™¨ç»„ä»¶ï¼Œè¯¥ç»„ä»¶é€šå¸¸èƒ½è¿›è¡Œå»‰ä»·çš„æ¸²æŸ“ï¼Œå¯ä»¥æŒ½æ•‘é€šå¸¸æ›´æ˜‚è´µçš„åŒ…è£…ç»„ä»¶çš„æ›´æ–°ã€‚ä¸ä»¥å‰çš„æƒè¡¡å–èˆä¸åŒï¼Œæˆ‘ä»¬æœ‰ç‚¹å¿…é¡»æŠŠ <code>selector</code> æ”¾å…¥ç›‘å¬å™¨å›è°ƒä¸­ä»¥å°½æ—©è·³è¿‡æ›´æ–°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>useSelector</span> <span class=o>=</span> <span class=p>(</span><span class=nx>selector</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>state</span><span class=p>,</span> <span class=nx>setState</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useState</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>selector</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setState</span><span class=p>(</span><span class=nx>selector</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>setState</span><span class=p>,</span> <span class=nx>selector</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>è¿™ä¸ªç‰ˆæœ¬åªæ˜¯ç®€å•çš„æ‰“ç ´ã€‚æˆ‘ä»¬åœ¨æ•´ä¸ªæ–‡ç« ä¸­å†æ¬¡æåˆ°<strong>è¿‡æ—¶çš„ props å’Œåƒµå°¸å­èŠ‚ç‚¹</strong>é—®é¢˜ã€‚ä¸å¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬å°†éå†æ¯ä¸ªæ­¥éª¤ï¼Œä»¥æŸ¥çœ‹é”™è¯¯çš„å‡ºå¤„å’ŒåŸå› ã€‚</p><ol><li>åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åï¼Œ<code>&lt;TodoList></code> å’Œ <code>&lt;Todo></code> ç»„ä»¶åœ¨ <code>useEffect</code> ä¸­è®¢é˜… storeã€‚å› ä¸º <code>useEffect</code> è‡ªä¸Šè€Œä¸‹è§¦å‘ï¼Œ<code>&lt;Todo></code> é¦–å…ˆè®¢é˜…ï¼Œç„¶åæ˜¯ <code>&lt;TodoList></code>ã€‚</li><li>ç”¨æˆ·ç‚¹å‡» <code>&lt;Todo></code>ï¼Œå‘ store åˆ†å‘ä¸€ä¸ª <code>DELETE</code> åŠ¨ä½œï¼ŒæœŸå¾…è¯¥é¡¹è¢«åˆ é™¤ã€‚</li><li>store æ”¶åˆ°è¿™ä¸ªåŠ¨ä½œ,é€šè¿‡ <strong>reducer</strong> è¿è¡Œå®ƒï¼Œç„¶åå°† <code>todos</code> çŠ¶æ€æ›´æ”¹ä¸ºç©ºæ•°ç»„ <code>{ todos: [] }</code>ã€‚</li><li>ç„¶åï¼Œstore è°ƒç”¨å·²è®¢é˜…çš„ç›‘å¬å™¨ã€‚ç”±äº <code>&lt;Todo></code> å…ˆè®¢é˜…ï¼Œå› æ­¤ä¹Ÿä¼šå…ˆè°ƒç”¨å®ƒçš„ç›‘å¬å™¨ã€‚</li><li><strong>ç”±äºæˆ‘ä»¬åœ¨æ¸²æŸ“é˜¶æ®µä¼ é€’ <code>props</code> ç»™ <code>listener</code>ï¼Œåœ¨é‚£æ—¶å…¶å½¢æˆäº†å°é—­çš„ <code>props</code>ã€‚å®ƒä»¬æ˜¯è¿‡æ—¶çš„ props</strong>ã€‚è®¿é—® <code>state.todos[ownProps.id]</code> å°†å¯¼è‡´ <code>undefined</code>ï¼Œç„¶åè°ƒç”¨ <code>(undefined).content</code> å°†å¯¼è‡´ä¸€ä¸ªé”™è¯¯ ğŸ’¥ã€‚</li></ol><p>å›æƒ³ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¯¹è¿‡æ—¶çš„ props é—®é¢˜çš„äº†è§£ã€‚<strong>å½“å­èŠ‚ç‚¹ä»¬ä½¿ç”¨ä» store æ´¾ç”Ÿçš„ props æ—¶ï¼Œè¿‡æ—¶çš„ props å°†åœ¨åŒæ­¥è®¢é˜…æ¨¡å‹ä¸­å‘ç”Ÿ</strong>ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ‰ 2 ä¸ªè§£å†³æ–¹æ¡ˆã€‚</p><ol><li>ç§»åŠ¨ <code>selector</code> åˆ°æ¸²æŸ“é˜¶æ®µå’Œä½¿ç”¨ <code>unstable_batchedUpdates</code></li><li>ä½¿ç”¨åµŒå¥—è®¢é˜…æ¨¡å‹</li></ol><p>é’©å­æ— æ³•æ›´æ”¹æ¸²æŸ“æ ‘ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ä¸ºæ¯ä¸ªç»„ä»¶æ·»åŠ ä¸€ä¸ªæ–°çš„ <code>&lt;Provider></code>ï¼Œä»¥ä½¿å…¶ä¼ æ’­åˆ°æœ€è¿‘çš„çˆ¶çº§ subStoreã€‚æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ’é™¤ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆã€‚</p><p>å¯¹äºç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå½“æˆ‘ä»¬ä»…åœ¨æ¸²æŸ“é˜¶æ®µä½¿ç”¨ <code>selector</code>ï¼Œå®ƒçš„æ€§èƒ½ä¸ä½³ï¼Œä¼šå¯¼è‡´æ¯æ¬¡æ›´æ”¹éƒ½éœ€è¦é‡æ¸²æŸ“ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»åœ¨ç›‘å¬å™¨å›è°ƒä¸­å°½æ—©è·³è¿‡æ›´æ–°ã€‚å†è€…ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç›‘å¬å™¨å›è°ƒä¸­è°ƒç”¨è¿‡æ—¶çš„ props åˆ™å¯èƒ½ä¼šå¯¼è‡´ <code>selector</code> æŠ›å‡ºé”™è¯¯ã€‚</p><p>æˆ‘ä»¬çš„åŒæ‰‹è¢«æŸç¼šï¼Œå°šæ— è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¿…é¡»åšå‡ºä¸€äº›å¦¥åã€‚</p><p>å¦‚æœæˆ‘ä»¬å¿½ç•¥è¯¥é”™è¯¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæˆ‘ä»¬é¦–å…ˆè¦é—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼šä½•æ—¶ä¼šå‘ç”Ÿé”™è¯¯ï¼Ÿå¤§çº¦æœ‰ 2 ç§æƒ…å†µã€‚é”™è¯¯å¯èƒ½æ˜¯ç”±äºé€‰æ‹©å™¨æœ¬èº«çš„é”™è¯¯è€Œå¼•èµ·çš„ï¼Œæˆ–è€…å› ä¸ºåƒµå°¸å­èŠ‚ç‚¹é—®é¢˜å¯¼è‡´äº†æ„å¤–é”™è¯¯ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›é€šè¿‡é‡æ–°æ¸²æŸ“ç»„ä»¶å¹¶åœ¨æ¸²æŸ“é˜¶æ®µåº”ç”¨ <code>selector(store.getState())</code> ä»¥è·å–æœ€æ–°çŠ¶æ€æ¥å®‰å…¨åœ°å¤„ç†å®ƒä»¬ã€‚å‰ä¸€ç§æƒ…å†µå°†åœ¨æ¸²æŸ“é˜¶æ®µ<strong>é‡æ–°å¼•å‘</strong>é”™è¯¯ï¼Œè€Œåè€…å°†ä¸ä¼šäº§ç”Ÿä»»ä½•é”™è¯¯ã€‚</p><p>é‚£ç§ä¸ä¼šæŠ›å‡ºè¿‡æ—¶çš„ props é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ä»ç„¶å¯ä»¥å¾—åˆ°ä¸ä¸€è‡´çŠ¶æ€ä½†æ²¡æœ‰é”™è¯¯çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ— è®ºå¦‚ä½•ç»„ä»¶ä»ç„¶ä¼šåœ¨ä»¥åé‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºæˆ‘ä»¬ä»å°†å¤„äº <code>selector(store.getState())</code> æ¸²æŸ“é˜¶æ®µï¼Œå› æ­¤ç”±äºæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œé—®é¢˜å°†æ¶ˆå¤±ã€‚</p><p>çœ‹èµ·æ¥æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ 5 æ­¥ä¸­å®‰å…¨åœ°å¿½ç•¥è¯¥é”™è¯¯ï¼Œè€Œåœ¨æ¸²æŸ“é˜¶æ®µé‡è¯•è¯¥é”™è¯¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>useSelector</span> <span class=o>=</span> <span class=p>(</span><span class=nx>selector</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useContext</span><span class=p>(</span><span class=nx>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[,</span> <span class=nx>forceUpdate</span><span class=p>]</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useReducer</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>currentState</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>useRef</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Try to get the state in the render phase to safely get the latest props
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currentState</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>selector</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>React</span><span class=p>.</span><span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>store</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>nextState</span> <span class=o>=</span> <span class=nx>selector</span><span class=p>(</span><span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>nextState</span> <span class=o>===</span> <span class=nx>currentState</span><span class=p>.</span><span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Bail out updates early
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Ignore errors
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Either way we want to force a re-render
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>forceUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>store</span><span class=p>,</span> <span class=nx>forceUpdate</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>currentState</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>currentState</span><span class=p>.</span><span class=nx>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>ç»“åˆ <code>unstable_batchedUpdates</code> çš„æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é€‰å®šçŠ¶æ€ä¸å˜çš„æƒ…å†µä¸‹å°½æ—©è·³è¿‡æ›´æ–°ï¼Œå¹¶å®‰å…¨åœ°é˜²æ­¢è¿‡æ—¶çš„ props å’Œåƒµå°¸å­èŠ‚ç‚¹é—®é¢˜ã€‚æˆ‘ä»¬å†æ¬¡è¿è¡Œä»£ç ï¼Œå¹¶æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚å‰ 4 ä¸ªæ­¥éª¤ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬ä»ç¬¬ 5 æ­¥å¼€å§‹ã€‚</p><ol start=5><li>ç”±äºæˆ‘ä»¬åœ¨æ¸²æŸ“é˜¶æ®µä¼ é€’ <code>props</code> ç»™ <code>listener</code>ï¼Œåœ¨é‚£æ—¶ï¼Œå…¶å½¢æˆäº†å°é—­çš„ <code>props</code>ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯<strong>è¿‡æ—¶çš„ props</strong>ã€‚è®¿é—® <code>state.todos[ownProps.id]</code> å°†å¯¼è‡´ <code>undefined</code>ï¼Œç„¶åè°ƒç”¨ <code>(undefined).content</code> å°†å¯¼è‡´é”™è¯¯ã€‚<strong>æˆ‘ä»¬æ•…æ„æ•è·å¹¶éšè—é”™è¯¯ï¼Œè¿™æ˜¯å½“æˆ‘ä»¬çŸ¥é“è¦åœ¨æ¸²æŸ“é˜¶æ®µé€‰æ‹©çŠ¶æ€ï¼Œä»è€Œè§¦å‘é‡æ¸²æŸ“æ—¶</strong>ã€‚</li><li>ç”±äºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ <code>unstable_batchedUpdates</code>ï¼Œæ¸²æŸ“å·²è¢«æ‰¹å¤„ç†ã€‚<code>&lt;TodoList></code> è§¦å‘å…¶ç›‘å¬å™¨å›è°ƒï¼Œ<code>selector(store.getState())</code> çš„ç»“æœä¸º <code>[]</code>ï¼Œä¹Ÿè®¡åˆ’é‡æ¸²æŸ“ã€‚</li><li>æ¸²æŸ“ä»ä¸Šå‘ä¸‹è¿›è¡Œæ“ä½œï¼Œ<code>&lt;TodoList></code> å…ˆæ¸²æŸ“ï¼Œç„¶åå†æ¬¡è°ƒç”¨ <code>selector(store.getState())</code>ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„ <code>&lt;ul></code>ï¼Œå®Œæˆæ¸²æŸ“ã€‚</li></ol><p>åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·æä¾›çš„ <code>selector</code> å‡½æ•°å¿…é¡»éµå¾ª 2 æ¡è§„åˆ™ã€‚</p><ol><li><code>selector</code> æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚</li><li>ä»£ç ä¸ä¾èµ–ä¹Ÿä¸æœŸæœ› <code>selector</code> æŠ›å‡ºé”™è¯¯ã€‚</li></ol><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>selector</code> å¿…é¡»æ˜¯ä¸€ä¸ª<strong>çº¯å‡½æ•°</strong>ã€‚åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿è¡Œ <code>selector</code> å¤šæ¬¡ã€‚åªè¦ <code>selector</code> æ˜¯çº¯çš„ï¼Œé‚£ä¹ˆå¤šæ¬¡è¿è¡Œå®ƒä»¬å°±ä¸æˆé—®é¢˜ã€‚è€Œä¸”ï¼Œ<code>React.StrictMode</code> å·²ç»æ‰§è¡Œäº†ä¸€æ®µæ—¶é—´çš„æ¸²æŸ“è§„åˆ™ï¼Œåœ¨ <code>selector</code> ä¸­ï¼Œè¿™æ ·åšä¹Ÿæ˜¯ä¸€ç§æ›´å¥½çš„åšæ³•ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å†³å®šä»¥ç”¨æˆ·èº«ä»½è‡ªè¡Œå¤„ç†é—®é¢˜ã€‚è°¨æ…åœ°ä¿æŠ¤ <code>selecto</code> å‡½æ•°å¹¶é€‚å½“åœ°å¤„ç†é”™è¯¯ï¼Œè™½ç„¶æœ‰ç‚¹å¤šï¼Œä½†æ˜¯ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>æˆ‘ä»¬å¯ä»¥åšæ›´å¤šçš„ä¼˜åŒ–æ¥å¢å¼ºæ€§èƒ½ï¼Œä¾‹å¦‚ä»…åœ¨éœ€è¦æ—¶ï¼ˆå½“å®ƒæœ‰è¿‡æ—¶çš„ props æˆ–é€‰æ‹©å™¨å‘ç”Ÿæ›´æ”¹æ—¶ï¼‰åœ¨æ¸²æŸ“é˜¶æ®µæ‰å¼ºåˆ¶å…¶è°ƒç”¨ <code>selector</code>ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯ <code>useSelector</code> åœ¨åå°å¦‚ä½•å·¥ä½œä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬å¿…é¡»ä¿æŒé€‰æ‹©å™¨ä¸º<strong>çº¯çš„</strong>åŸºæœ¬æ€æƒ³ã€‚</p><h2 id=æ”¶è·>æ”¶è·</h2><p>Phewï¼è¿™æ˜¯ä¸€æ®µæ¼«é•¿çš„æ—…ç¨‹ã€‚ç»™è‡ªå·±ä¸€ä¸ªèµ°åˆ°æœ€åçš„æŒå£°ã€‚è·Ÿç€èµ°å¹¶ä¸å®¹æ˜“ï¼</p><p>é‡æ–°åˆ›å»º <code>Redux</code> çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä½†è¦å°å¿ƒå¤„ç†è®¸å¤šé™·é˜±ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³æ²¡æœ‰æåˆ°å¤§é‡çš„ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†ã€‚</p><p>å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æ›´å¥½åœ°äº†è§£ <code>Redux</code> å’Œ <code>react-redux</code> çš„èƒŒåçš„å·¥ä½œåŸç†å¾ˆæœ‰å¸®åŠ©ã€‚ä¹Ÿèµæ‰¬æ‰€æœ‰ç»´æŠ¤è€…å’Œè´¡çŒ®è€…åˆ›å»ºäº†å¦‚æ­¤å‡ºè‰²çš„åº“å¹¶ä¸æ–­åœ°å¯¹å…¶è¿›è¡Œæ”¹è¿›ã€‚å³ä½¿æˆ‘åŒæ„ä½ å¯èƒ½ä¸éœ€è¦ <code>Redux</code>ï¼Œå®ƒä»ç„¶ä¸ºä¸­å‹ä¹ƒè‡³å¤§å‹å›¢é˜Ÿæä¾›äº†ä¸€ç§æœ‰ç”¨çš„æ¨¡å¼ï¼Œä½¿ä»–ä»¬å¯ä»¥é¡ºåˆ©åœ°è¿›è¡Œåä½œã€‚</p><p>ä¸‹æ¬¡ï¼Œå½“ä½ å‘ç°å…¶å®ƒäººå°† <code>Redux</code> è§†ä¸ºç†æ‰€å½“ç„¶æ—¶ï¼Œè¯·é—®ä»–/ä»–å¦‚ä½•è§£å†³<strong>è¿‡æ—¶çš„ props å’Œåƒµå°¸å­èŠ‚ç‚¹</strong>é—®é¢˜ï¼Œå¹¶å‘å¥¹/ä»–å±•ç¤ºæ­¤å¸–å­ ğŸ˜‰ã€‚</p><h2 id=å‚è€ƒæ–‡ç« >å‚è€ƒæ–‡ç« </h2><ul><li><a href=https://blog.isquaredsoftware.com/2018/11/react-redux-history-implementation/ target=_blank rel=noopener>Idiomatic Redux: The History and Implementation of React-Redux</a></li><li><a href=https://github.com/reduxjs/react-redux/pull/99 target=_blank rel=noopener>reduxjs/react-redux#99 (Fix issues with stale props #99) Where the stale props first fixed back in v4</a></li><li><a href=https://github.com/reduxjs/react-redux/issues/292 target=_blank rel=noopener>reduxjs/react-redux#292 (Can we avoid inconsistencies on non-batched dispatches?) Where Dan found that the order doesn&rsquo;t matter, but batching updates does</a></li><li><a href=https://github.com/reduxjs/react-redux/issues/1177 target=_blank rel=noopener>reduxjs/react-redux#1177 (React-Redux Roadmap: v6, Context, Subscriptions, and Hooks)</a><ul><li><a href=https://github.com/reduxjs/react-redux/issues/1177#issuecomment-468765242 target=_blank rel=noopener>Mark explains that <code>unstable_batchedUpdates</code> isn&rsquo;t sufficient for fixing stale props due to performance reason</a></li></ul></li><li><a href=https://github.com/reduxjs/react-redux/issues/1179 target=_blank rel=noopener>reduxjs/react-redux#1179 (Discussion: Potential hooks API design)</a><ul><li><a href=https://github.com/reduxjs/react-redux/issues/1179#issuecomment-482164630 target=_blank rel=noopener>A comment by the author of the hooks API proposal</a></li><li><a href=https://github.com/reduxjs/react-redux/issues/1179#issuecomment-483617153 target=_blank rel=noopener>Example test cases for stale props with hooks</a></li></ul></li><li>&mldr;, and many more which I simply cannot recall where I read them.</li></ul></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>æœ€è¿‘æ›´æ–°äº 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>Â© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"å·²å¤åˆ¶")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>