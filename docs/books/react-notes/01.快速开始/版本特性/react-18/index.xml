<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>React 18 | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/</link><atom:link href="https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/index.xml" rel="self" type="application/rss+xml"/><description>React 18</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>React 18</title><link>https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/</link></image><item><title>2022-ä»Žç”¨æ³•åˆ°å®žçŽ°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18</title><link>https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/</guid><description>&lt;blockquote>
&lt;p>&lt;a href="https://juejin.cn/post/7095185674151821348#heading-14" target="_blank" rel="noopener">åŽŸæ–‡åœ°å€&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="ä»Žç”¨æ³•åˆ°å®žçŽ°ä¸€æ–‡å¸¦ä½ æ‹¥æŠ±-react-18">ä»Žç”¨æ³•åˆ°å®žçŽ°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18&lt;/h1>
&lt;h1 id="å‰è¨€">å‰è¨€&lt;/h1>
&lt;p>React å›¢é˜Ÿåœ¨æ‰“é€ å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ä¸Šå…¶å®žä¸€ç›´åœ¨æŽ¢ç´¢ï¼Œæœ€ç»ˆç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯æ•´åˆäº†äººæœºäº¤äº’ç ”ç©¶æˆæžœï¼ˆåŽæ–‡ä¼šå…·ä½“ä»‹ç»ï¼‰çš„ Concurrent Renderingã€‚&lt;/p>
&lt;p>ç„¶è€Œå› ä¸ºè¿™èƒŒåŽçš„å¤æ‚æ€§ã€ç¨³å®šæ€§ã€å…¼å®¹æ€§ç­‰é—®é¢˜ï¼Œä»Ž 16 ç‰ˆæœ¬çš„ Async Mode å¼€å§‹å°±åœ¨ä¸æ–­æ‰“ç£¨ï¼Œè€—æ—¶å¤šå¹´ï¼Œç»åŽ†äº† 17 ç‰ˆæœ¬è¿‡æ¸¡ï¼Œæœ€ç»ˆä¼´éšç€ 18 ç‰ˆæœ¬æ­£å¼ä¸Šçº¿ï¼Œè¿™ä¸€ç‰ˆæœ¬ä¸­å¼€å‘è€…å¯ä»¥å®Œå…¨å¹³æ»‘çš„å¼€å¯å¹¶å‘ç‰¹æ€§ã€‚&lt;/p>
&lt;p>ä»Šå¤©å¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« å¸¦å¤§å®¶ä¸€èµ·æ·±å…¥äº†è§£ä¸€ä¸‹ React 18 ä¸­çš„æ–°ç‰¹æ€§ã€æ–°èƒ½åŠ›ã€‚&lt;/p>
&lt;h1 id="concurrent-rendering">Concurrent Rendering&lt;/h1>
&lt;p>Concurrency æ˜¯ React 18 çš„å…³é”®è¯ï¼Œå¯ä»¥ç†è§£æˆæ˜¯ä¸€ç§èƒŒåŽçš„æœºåˆ¶ï¼Œä¿è¯ React èƒ½å¤ŸåŒæ—¶å‡†å¤‡å¤šå¥— UIã€‚å…·ä½“åˆ°è¡¨çŽ°ä¸ŠåŒºåˆ«äºŽä»¥å¾€çš„æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ¸²æŸ“æ˜¯å¯ä¸­æ–­çš„ã€‚è¿™æ„å‘³ç€å½“ä½ çš„åº”ç”¨æ­£åœ¨è¿›è¡Œå¤æ‚æ›´æ–°çš„æ—¶å€™ï¼Œä»ç„¶å¯ä»¥ä¸Žé¡µé¢è¿›è¡Œäº¤äº’ï¼Œä¿è¯ä¸€ä¸ªæµç•…çš„ç”¨æˆ·ä½“éªŒã€‚ æ—¢ç„¶æ˜¯ä¸€ç§èƒŒåŽçš„æœºåˆ¶ï¼Œå®žé™…ä¸Šå¼€å‘è€…å¹¶éžéœ€è¦å…ˆå­¦ä¹ å¹¶å‘æ¸²æŸ“æ‰èƒ½ä½¿ç”¨ React18ï¼Œä½†æ˜¯èƒ½å¤ŸæŽŒæ¡å¹¶å‘æ¸²æŸ“å¯¹äºŽæ–°ç‰¹æ€§çš„ç†è§£æœ‰éžå¸¸å¤§çš„ä½œç”¨ã€‚&lt;/p>
&lt;p>æ ¸å¿ƒå®žçŽ°æ˜¯é€šè¿‡ç»„ä»¶ä½œä¸ºä¸€ä¸ªåŸºæœ¬çš„å·¥ä½œå•å…ƒå°†ä¸€ä¸ªå¤§çš„æ›´æ–°ä»»åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åŽä»¥æ—¶é—´åˆ‡ç‰‡çš„æ–¹å¼ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„æ—¶é—´ç‰‡æ¥æ‰§è¡Œï¼Œæ¯ä¸ªæ—¶é—´ç‰‡æ‰§è¡Œå®ŒæˆåŽéƒ½ä¼šä¸»åŠ¨é‡Šæ”¾æŽ§åˆ¶æƒï¼Œä½¿å¾—æµè§ˆå™¨èƒ½å¤Ÿå¤„ç†å…¶å®ƒç”¨æˆ·äº‹ä»¶ã€‚è€Œå…·ä½“æ—¶é—´ç‰‡ä¸Šæ‰§è¡Œå“ªä¸ªä»»åŠ¡æ˜¯ç”±ä»»åŠ¡ä¸Šçš„ç›¸å…³ä¼˜å…ˆçº§å†³å®šçš„ï¼Œå½“é«˜ä¼˜å…ˆçº§çš„æ›´æ–°åˆ°æ¥æ—¶ï¼Œä¼šä¸­æ–­æ—§çš„æ›´æ–°ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¾…å®ŒæˆåŽç»§ç»­æ‰§è¡Œä½Žä¼˜å…ˆçº§æ›´æ–°ï¼Œå› æ­¤åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œæˆ‘ä»¬çœ‹ React åœ¨å¹¶å‘çš„æ‰§è¡Œå¤šä¸ªæ¸²æŸ“ä»»åŠ¡ã€‚&lt;/p>
&lt;h2 id="auto-batching">Auto Batching&lt;/h2>
&lt;p>é¦–å…ˆæ‰¹å¤„ç†æ˜¯æŒ‡ React å°†å¤šæ¬¡çŠ¶æ€æ›´æ–°åˆå¹¶æˆä¸€æ¬¡é‡æ¸²æŸ“æ¥æå‡æ€§èƒ½ï¼Œæ—©åœ¨ 16 çš„ç‰ˆæœ¬ä¸­å…¶å®žå°±å·²ç»åŒ…å«äº†æ‰¹å¤„ç†èƒ½åŠ›ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">App&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">setCount&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">flag&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">setFlag&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">function&lt;/span> &lt;span class="nx">handleClick&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setCount&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// Does not re-render yet
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setFlag&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// Does not re-render yet
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// React will only re-render once at the end (that&amp;#39;s batching!)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">div&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">button&lt;/span> &lt;span class="nx">onClick&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">handleClick&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="nx">Next&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/button&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">h1&lt;/span> &lt;span class="nx">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">flag&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="s2">&amp;#34;blue&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;black&amp;#34;&lt;/span> &lt;span class="p">}}&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/h1&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/div&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶è€Œå¦‚æžœæ›´æ–°å‘ç”Ÿåœ¨ timeouts, promises, native event handlers ç­‰éž React events äº‹ä»¶ä¸­ï¼ŒReact 18 ä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤éƒ½ä¸ä¼šè¿›è¡Œåˆå¹¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">handleClick&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fetchSomething&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// React 17 and earlier does NOT batch these because
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// they run *after* the event in a callback, not *during* it
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setCount&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// Causes a re-render
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setFlag&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// Causes a re-render
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ React 18 ä¸­ï¼Œä¸ä¼šæ›´æ–°å‘ç”Ÿåœ¨å“ªé‡Œï¼Œéƒ½ä¼šè‡ªåŠ¨åˆå¹¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§è‡ªåŠ¨åˆå¹¶æ˜¯å®Œå…¨å®‰å…¨ä¸”æ— æ„ŸçŸ¥çš„ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€äº› bad case éœ€è¦ç‰¹æ®Šå¤„ç†ä»¥ä¿æŒå‘å‰å…¼å®¹ï¼Œæ¯”å¦‚ä¸‹é¢çš„ caseï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">handleClick&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setState&lt;/span>&lt;span class="p">(({&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">({&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">}));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// { count: 1, flag: false } before 18
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// { count: 0, flag: false } in 18
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">state&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setState&lt;/span>&lt;span class="p">(({&lt;/span> &lt;span class="nx">flag&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">({&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">flag&lt;/span> &lt;span class="p">}));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ 18 ä¹‹å‰ï¼Œç”±äºŽæ›´æ–°ä¼šåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤ŸèŽ·å¾—ä¸­é—´çŠ¶æ€ã€‚ç„¶è€Œåœ¨ 18 ä¸­ï¼Œå³ä½¿æ˜¯ setTimeout ä¸­çš„æ›´æ–°ä¹Ÿä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¹¶åœ¨ next tick ä¸­åˆå¹¶æ‰§è¡Œï¼Œæ‰“å°çš„çŠ¶æ€ä¸ºåˆå§‹åŒ–çŠ¶æ€ï¼Œä»Žè€Œå‰åŽä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React 18 ä¸­æä¾›çš„ ReactDOM.flushSync æ¥ä¿æŒå‘å‰å…¼å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">handleClick&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactDOM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">flushSync&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setState&lt;/span>&lt;span class="p">(({&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">({&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">}));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// { count: 1, flag: false }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">state&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setState&lt;/span>&lt;span class="p">(({&lt;/span> &lt;span class="nx">flag&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">({&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">flag&lt;/span> &lt;span class="p">}));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="deep-dive">Deep dive&lt;/h3>
&lt;p>è‡ªåŠ¨æ‰¹å¤„ç†å®žçŽ°çš„å…³é”®åœ¨äºŽ React18 ä¸­æ›´æ–°æ˜¯åŸºäºŽä¼˜å…ˆçº§çš„ï¼Œæˆ‘ä»¬ç»“åˆä¸‹é¢æºç çœ‹ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•æ˜¯ 18 ä¸­æ¯ä¸€æ¬¡æ›´æ–°è°ƒåº¦çš„å¿…ç»ä¹‹è·¯ï¼Œæ‰¹å¤„ç†çš„å®žçŽ°çš„æ ¸å¿ƒåœ¨äºŽå½“ç›¸åŒä¼˜å…ˆçº§çš„æ›´æ–°å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸ä¼šç”Ÿæˆæ–°çš„ä»»åŠ¡ï¼Œè€Œæ˜¯å¤ç”¨ä¸Šä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä»Žè€Œå®žçŽ°åˆå¹¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">ensureRootIsScheduled&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">root&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">FiberRoot&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentTime&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Determine the next lanes to work on, and their priority.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">nextLanes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">getNextLanes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">root&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// We use the highest priority lane to represent the priority of the callback.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">newCallbackPriority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">getHighestPriorityLane&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nextLanes&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Check if there&amp;#39;s an existing task. We may be able to reuse it.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">existingCallbackPriority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">root&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callbackPriority&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">existingCallbackPriority&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">newCallbackPriority&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// The priority hasn&amp;#39;t changed. We can reuse the existing task. Exit.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Cancel the existing callback.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cancelCallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">existingCallbackNode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// schedule a new one.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">newCallbackPriority&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">SyncLane&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">scheduleSyncCallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">performSyncWorkOnRoot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">root&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">newCallbackNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">scheduleCallback&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">schedulerPriorityLevel&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">performConcurrentWorkOnRoot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">root&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æžœç†è§£äº†è¿™ä¸ªï¼Œé‚£ä¸ª FlushSync çš„å®žçŽ°ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œæ— éžæ˜¯å°†å†…éƒ¨æ›´æ–°çš„ä¼˜å…ˆçº§å¼ºåˆ¶æŒ‡å®šä¸º SyncLaneï¼Œå³æŒ‡å®šä¸ºåŒæ­¥ä¼˜å…ˆçº§ï¼Œå…·ä½“æ•ˆæžœå°±æ˜¯æ¯ä¸€æ¬¡æ›´æ–°æ—¶éƒ½ä¼šåŒæ­¥çš„æ‰§è¡Œæ¸²æŸ“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">flushSync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// DiscreteEventPriority === SyncLane
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setCurrentUpdatePriority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">DiscreteEventPriority&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fn&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setCurrentUpdatePriority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">previousPriority&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="transition">Transition&lt;/h2>
&lt;p>transition æ˜¯ 18 ç‰ˆæœ¬ä¸­æ–°æå‡ºçš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯æœ€èƒ½ä½“çŽ°å¹¶å‘æ¸²æŸ“ä¼˜åŠ¿çš„ä¸Šå±‚åº”ç”¨ã€‚å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå½“æ»‘å—æ»‘åŠ¨æ—¶ï¼Œä¸‹æ–¹çš„å›¾è¡¨ä¼šä¸€èµ·æ›´æ–°ï¼Œç„¶è€Œå›¾è¡¨æ›´æ–°æ˜¯ä¸€ä¸ª CPU å¯†é›†åž‹æ“ä½œï¼Œæ¯”è¾ƒè€—æ—¶ã€‚ç”±äºŽé˜»å¡žäº†æ¸²æŸ“å¯¼è‡´é¡µé¢å¤±åŽ»å“åº”ï¼Œç”¨æˆ·èƒ½å¤Ÿéžå¸¸æ˜Žæ˜¾çš„æ„Ÿå—åˆ°å¡é¡¿ã€‚&lt;/p>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/gif/14f828dc58f84e729acf6343bfcc7d7c%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp" alt="" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;p>å®žé™…ä¸Šï¼Œå½“æˆ‘ä»¬æ‹–åŠ¨æ»‘å—çš„æ—¶å€™ï¼Œéœ€è¦åšä¸¤æ¬¡æ›´æ–°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Urgent: Show what was typed
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">setSliderValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Not urgent: Show the results
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">setGraphValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªæ˜¯æ¯”è¾ƒç´§æ€¥éœ€è¦ç«‹åˆ»ååº”åœ¨ç•Œé¢ä¸Šï¼Œå¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—é‡åˆ°äº† bugã€‚è€Œå¦ä¸€ä¸ªå¯¹äºŽç”¨æˆ·è€Œè¨€ï¼ŒæŸ¥è¯¢ç»“æžœçš„æ˜¾ç¤ºï¼Œå³ä½¿å­˜åœ¨ä¸€äº›å»¶è¿Ÿä¹Ÿæ˜¯å¯æŽ¥å—çš„ã€‚è¿™ç§æŽ¥å—ç¨‹åº¦æ­£æ˜¯äººæœºç ”ç©¶çš„æˆæžœï¼š&lt;/p>
&lt;blockquote>
&lt;p>we know from research that interactions like hover and text input need to be handled within a very short period of time, while clicks and page transitions can wait a little longer without feeling laggy. â€”â€” Putting Research into Production&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ React 18 ä¹‹å‰æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç¼ºä¹ä¸€ç§æœºåˆ¶ï¼Œæ¥å£°æ˜Žè¿™ç§ä¸åŒç´§æ€¥ç¨‹åº¦çš„æ›´æ–°ï¼ŒTransition å°±ç”¨æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚React 18 ä¸­æä¾›äº† startTransition æ¥è®©å¼€å‘è€…æ˜¾ç¤ºçš„å£°æ˜Žéžç´§æ€¥æ›´æ–°ã€‚transition å–åçš„å«ä¹‰æ˜¯ï¼ŒReact ä¸­ä»Žå¼€å‘è€…è§’åº¦å°†çŠ¶æ€æ›´æ–°åˆ†æˆäº†ä¸¤ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸€ç±»æ˜¯ç”¨æˆ·è¾“å…¥ã€ç‚¹å‡»ç­‰ç´§æ€¥æ›´æ–°ï¼Œå¦ä¸€ç±»æ˜¯å°† UI ä»Žä¸€ä¸ªè§†å›¾è½¬å˜æˆå¦å¤–ä¸€ä¸ª&lt;/li>
&lt;li>transition ä¸­å¯¹åº”çš„æ›´æ–°ç±»åž‹ä¸ºç¬¬äºŒç§ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="starttransition">startTransition&lt;/h3>
&lt;p>é€šè¿‡ starTransition å¯ä»¥æ ‡è®°éžç´§æ€¥çš„æ›´æ–°ï¼Œå…·ä½“çš„æ‰§è¡Œæ—¶æœºä¼šæ ¹æ®å½“å‰ç©ºé—²ç¨‹åº¦åŠ¨æ€å†³å®šã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">startTransition&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Urgent
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">setSliderValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Mark any state updates inside as transitions
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Transition: Show the results
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setGraphValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="usetransition">useTransition&lt;/h3>
&lt;p>å¯ä»¥é€šè¿‡ useTransition ä¸­çš„ pending æ¥ç¡®å®šå½“å‰æ›´æ–°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå¹¶æ¸²æŸ“ä¸€äº› loadingï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">useTransition&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">isPending&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">startTransition&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useTransition&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">isPending&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">Spinner&lt;/span> &lt;span class="o">/&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶è€Œå³ä½¿æˆ‘ä»¬æ ¹æ® isPending è®¾ç½®äº† loading ç•Œé¢ï¼Œè¿™ä¸ª loading ä¹Ÿå¹¶éžä¸€å®šä¼šå‡ºçŽ°ï¼Œæ ¹æ®äººæœºäº¤äº’çš„ç ”ç©¶æˆæžœï¼Œè¿‡å¤šçš„æ˜¾ç¤ºä¸€äº›ä¸­é—´è§†å›¾ä¼šè®©ç”¨æˆ·æ„Ÿè§‰å¾—æ›´æ…¢ï¼Œå› æ­¤åœ¨æ€§èƒ½æ¯”è¾ƒå¥½æ—¶ï¼Œtransition ä¸­çš„æ›´æ–°å¾ˆå¿«æ‰§è¡Œï¼Œloading ç•Œé¢å°†ä¸ä¼šå±•ç¤ºï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå‡ºçŽ°â€œé—ªä¸€ä¸‹â€çš„æƒ…å†µï¼Œæ¥æå‡ç”¨æˆ·ä½“éªŒï¼š&lt;/p>
&lt;blockquote>
&lt;p>research shows that displaying too many intermediate loading states when transitioning between screens makes a transition feel slower. â€”â€” Putting Research into Production&lt;/p>
&lt;/blockquote>
&lt;p>æˆ‘ä»¬å†æ¥æ„Ÿå—ä¸€ä¸‹ä½¿ç”¨äº† transition ä¹‹åŽçš„æ•ˆæžœï¼š&lt;/p>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/gif/82e2121398404324a61f9d215ff1b348%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp" alt="" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;p>åº”è¯¥å¯ä»¥æ˜Žæ˜¾çš„æ„Ÿå—åˆ°ï¼Œè™½ç„¶å›¾è¡¨çš„æ›´æ–°è¿˜æ˜¯ä¼šæœ‰äº›å»¶è¿Ÿï¼Œä½†æ˜¯æ•´ä½“çš„ç”¨æˆ·ä½“éªŒç›¸å¯¹ä¹‹å‰æ˜¯éžå¸¸å¥½çš„ã€‚&lt;/p>
&lt;h3 id="ä¸Žä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«">ä¸Žä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«&lt;/h3>
&lt;p>è™½ç„¶åœ¨ 18 ç‰ˆæœ¬ä¹‹å‰ React æœ¬èº«å¹¶æ²¡æœ‰æä¾›å£°æ˜Žæ›´æ–°ä¼˜å…ˆçº§çš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡ JS æ¥ä¼˜åŒ–è¿™ä¸€é—®é¢˜ï¼Œæ¯”å¦‚é€šè¿‡ setTimeout / throttle / debounce&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">setSliderValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setGraphValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">},&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Žä¹‹ç›¸æ¯”ï¼Œ&lt;code>transition&lt;/code>çš„åŒºåˆ«ä¸»è¦è¡¨çŽ°åœ¨:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ‰§è¡Œæ—¶æœº&lt;/strong>ï¼Œ&lt;code>setTimout/throttle/debounce&lt;/code> å‡ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè€Œ&lt;code>transition&lt;/code>ä¸ºåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤ä¼šæ¯”ä»–ä»¬æ›´æ—©çš„è§¦å‘æ›´æ–°è°ƒåº¦ï¼Œåœ¨æ€§èƒ½è¾ƒå¥½æ—¶å¯èƒ½åœ¨åŒä¸€å¸§å®Œæˆæ›´æ–°ï¼Œè€Œè¿™ç§æƒ…å†µåœ¨æ¯”å¦‚&lt;code>throttle&lt;/code>ä¸­è¢«å¼ºåˆ¶æ‹‰å¤§ï¼Œæ¯”å¦‚ 100ms&lt;/li>
&lt;li>&lt;strong>äº¤äº’ä½“éªŒ&lt;/strong>ï¼Œä¸ç®¡æ˜¯å»¶è¿Ÿè¿˜æ˜¯å‡é¢‘ï¼Œå½“çœŸæ­£è§¦å‘æ›´æ–°ï¼Œå¦‚æžœæ¸²æŸ“æ—¶é—´æ¯”è¾ƒä¹…ï¼Œä¾ç„¶ä¼šå‘ç”Ÿç•Œé¢å¡é¡¿ï¼Œè€Œé€šè¿‡&lt;code>transition&lt;/code>è§¦å‘çš„æ›´æ–°å¹¶ä¸ä¼šé˜»å¡žç”¨æˆ·ç•Œé¢ï¼Œèƒ½å¤Ÿä¸€ç›´ä¿æŒå“åº”&lt;/li>
&lt;li>&lt;strong>ç²¾ç¡®æŽ§åˆ¶&lt;/strong>ï¼Œéœ€è¦é¢å¤–å®žçŽ° loading æŽ§åˆ¶ï¼Œè€Œä¸”å¾€å¾€ä¸å¤Ÿç²¾ç¡®ï¼ŒçŽ°åœ¨&lt;code>transition&lt;/code>å†…éƒ¨ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç»´æŠ¤è¿™ä¸ª loading çŠ¶æ€ï¼Œå¹¶ä¸”è¶³å¤Ÿç²¾ç¡®&lt;/li>
&lt;/ul>
&lt;h3 id="deep-dive-1">Deep dive&lt;/h3>
&lt;p>æˆ‘ä»¬ç»“åˆæºç çœ‹ä¸€ä¸‹ transition æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œå¯ä»¥çœ‹åˆ°æœ¬èº«çš„å®žçŽ°å¹¶ä¸å¤æ‚ï¼Œåœ¨ startTransition å†…éƒ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå…¶åŽæ‰§è¡Œçš„æ›´æ–°éƒ½ä¼šæ ¹æ®è¯¥å¼€å…³é»˜è®¤å¼€å¯ transition ä¼˜å…ˆçº§ï¼Œè€Œè¿™ä¸ªä¼˜å…ˆçº§è¦æ¯”ä¸€èˆ¬çš„ä¼˜å…ˆçº§æ›´ä½Žä¸€äº›ï¼Œå› æ­¤æ‰§è¡Œæ—¶é—´è¦æ¯”æ™®é€šæ›´æ–°æ™šï¼ŒåŒæ—¶å³ä½¿æ›´æ–°å‘ç”Ÿæ—¶ï¼Œä¹Ÿå¯ä»¥è¢«é«˜ä¼˜å…ˆçº§çš„æ›´æ–°æ‰“æ–­ï¼Œä»Žè€Œä¸é˜»å¡žç”¨æˆ·æ¸²æŸ“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">setPending&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prevTransition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Tag We are inside transition
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">callback&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Recovery
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">prevTransition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Request priority when fiber update
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">requestUpdateLane&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fiber&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">Fiber&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// requestCurrentTransition =&amp;gt; ReactCurrentBatchConfig.transition
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">isTransition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">requestCurrentTransition&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">isTransition&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">claimNextTransitionLane&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>useTransition çš„å®žçŽ°æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ useState+startTransitionï¼Œå®žçŽ°å…³é”®ç‚¹åœ¨äºŽä¸¤æ¬¡ setPendingï¼Œè™½ç„¶æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä½†ä¸¤è€…çš„åŒºåˆ«åœ¨äºŽç¬¬ä¸€æ¬¡çš„ setPending ä¸ºæ™®é€šä¼˜å…ˆçº§ï¼Œè€Œç¬¬äºŒæ¬¡å› ä¸ºå…¨å±€å¼€å…³æ‰“å¼€ï¼Œä¼šè¢«æŽˆäºˆ transition ä¼˜å…ˆçº§ï¼Œä¸Ž callback ä¸­çš„æ›´æ–°è‡ªåŠ¨åˆå¹¶ï¼Œå› æ­¤ pending ä¼šé¦–å…ˆè¢«ç½®æˆ trueï¼Œåœ¨ transition æ›´æ–°å®Œæˆæ—¶ï¼Œé‡ç½®ä¸º falseï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">mountTransition&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">isPending&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">setPending&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mountState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">callback&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setPending&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prevTransition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Tag We are inside transition
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setPending&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">callback&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Recovery
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">prevTransition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">isPending&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼ŒðŸ¤” ä¸‹é¢è¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å—&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setValue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setValue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setValue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setValue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»Žæ‰§è¡Œçš„æ•ˆæžœçœ‹ï¼Œç”±äºŽç›®å‰æ‰€æœ‰çš„ transition ä¸­çš„æ›´æ–°ä¼šè¢«æ ‡è®°æˆåŒæ ·çš„ä¼˜å…ˆçº§ï¼ŒåŒæ ·çš„ä¼˜å…ˆçº§æ„å‘³ç€ä¼šåœ¨åŒä¸€æ¬¡è°ƒåº¦ä¸­ä¸€èµ·æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸¤ç§ç”¨æ³•ç›®å‰æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ä»Žåˆç†æ€§çš„è§’åº¦ï¼Œä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ transition åº”è¯¥æ˜¯å¯ä»¥ç‹¬ç«‹åŽ»æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«èµ‹äºˆæ›´ç»†ç²’åº¦çš„ä¼˜å…ˆçº§ï¼Œè¿™ä¹Ÿæ˜¯ transition åŽç»­æ›´æ–°çš„æ–¹å‘ã€‚è€Œå¦‚ä½•è®¤ä¸ºå®Œå…¨ç‹¬ç«‹ï¼Œå¹¶ä¸æ˜¯ä»…ä»…ä½¿ç”¨äº†ä¸¤ä¸ªå•ç‹¬ startTransitionï¼ŒReact ä¼šä»Žå†…éƒ¨è‡ªåŠ¨è¿›è¡Œæ£€æµ‹æ›´æ–°çš„çŠ¶æ€æ˜¯å¦æœ‰ä¾èµ–ï¼Œå› ä¸ºå¦‚æžœä¸¤ä¸ªæ›´æ–°æœ‰é‡å çš„è¯ï¼Œå®žé™…ä¸Šè¿›è¡Œæ‹†åˆ†ä¼šæœ‰æµªè´¹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸‹æ‹‰æ¡†ï¼Œæˆ‘åˆ‡æ¢äº†å¾ˆå¤šæ¬¡ä¹‹åŽï¼Œä¸­é—´çŠ¶æ€å†å±•ç¤ºå¹¶æ²¡æœ‰æ„ä¹‰äº†ï¼Œåªéœ€è¦æ¸²æŸ“æœ€ç»ˆçŠ¶æ€å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h3 id="usedeferredvalue">useDeferredValue&lt;/h3>
&lt;p>çŽ°åœ¨æˆ‘ä»¬çŸ¥é“æ›´æ–°å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ startTransition æ¥æ ‡è®°ä½Žä¼˜å…ˆçš„æ›´æ–°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">startTransition&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">Comp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">handleChange&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setSliderValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">startTransition&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setGraphValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‚£å¦‚æžœæ›´æ–°è§¦å‘çš„å®žé™…æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œæ¯”å¦‚ä»Ž parent compnent / other hooks / å¤šä¸ª handler / URL æ”¹å˜ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒReact æä¾›äº†å¦ä¸€ä¸ª hook updateDeferredValue æ¥æ ‡è®°éžç´§æ€¥æ›´æ–°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">useDeferredValue&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">Comp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">graphValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useDeferredValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...updating depends on graphValue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šæ–¹ä»£ç çš„å…·ä½“æ•ˆæžœæ˜¯å½“ input æ”¹å˜æ—¶ï¼Œè¿”å›žçš„ graphValue å¹¶ä¸ä¼šç«‹å³æ”¹å˜ï¼Œä¼šé¦–å…ˆè¿”å›žä¸Šä¸€æ¬¡çš„ input å€¼ï¼Œä¸å­˜åœ¨æ›´ç´§æ€¥çš„æ›´æ–°æ—¶ï¼Œæ‰ä¼šå˜æˆæœ€æ–°çš„ inputï¼Œå› æ­¤å¯ä»¥é€šè¿‡ graphValue æ˜¯å¦æ”¹å˜æ¥è¿›è¡Œä¸€äº›ä½Žä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæ‰€ä»¥æ•ˆæžœæ˜¯åŸºæœ¬ä¸Šæ˜¯å’Œ transition æ˜¯ä¸€è‡´çš„ã€‚&lt;/p>
&lt;p>è€Œå®žçŽ°ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®žå°±æ˜¯å°è£…äº† useState + useEffect + startTransitionï¼Œè°ƒåº¦ä¸€ä¸ª Effect å‘èµ·ä¸€ä¸ª startTransition æ¥æ›´æ–°å…·ä½“çš„ value&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">updateDeferredValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">prevValue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">setValue&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">updateState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updateEffect&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prevTransition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReactCurrentBatchConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">transition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">prevTransition&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">prevValue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ä¸Šé¢çš„å®žçŽ°æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚å½“æŽ¥å—çš„ value å¹¶éžä¸€ä¸ª memorizedValueï¼Œå³æ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ŒstartTransition æ›´æ–°å‘ç”Ÿçš„æ—¶å€™ä¼šå†æ¬¡è§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œåˆä¼šå‘èµ·ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œä»Žè€Œé€ æˆæ­»å¾ªçŽ¯ã€‚å› æ­¤å‰ä¸ä¹…ï¼Œå¯¹è¿™ä¸ªè¿™ä¸ª hook çš„å®žçŽ°åšäº†ä¸€ç‰ˆæ›´æ–° PRï¼Œæ–°çš„å®žçŽ°å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">updateDeferredValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">shouldDeferValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">includesOnlyNonUrgentLanes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">renderLanes&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">shouldDeferValue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// This is an urgent update. If the value has changed, keep using the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// previous value and spawn a deferred render to update it later.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prevValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">currentHook&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">memoizedState&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">is&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prevValue&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Mark an Transition Update
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">deferredLane&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">claimNextTransitionLane&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentlyRenderingFiber&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lanes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mergeLanes&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentlyRenderingFiber&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lanes&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deferredLane&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">prevValue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hook&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">memoizedState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æ–°çš„å®žçŽ°ä¸ä¼šä¾èµ– effectï¼Œè€Œæ˜¯æ ¹æ®å½“å‰æ›´æ–°çš„ä¼˜å…ˆçº§æ¥ï¼Œå¦‚æžœæ˜¯ä¸€ä¸ªç´§æ€¥æ›´æ–°åˆ™ç›´æŽ¥è¿”å›ž prevValueï¼Œå¹¶ä¸”åœ¨å½“å‰ fiber ä¸­æ ‡è®°ä¸€ä¸ª transition æ›´æ–°ã€‚å½“éžç´§æ€¥æ›´æ–°å‘ç”Ÿæ—¶ï¼Œç›´æŽ¥è¿”å›žæœ€æ–°çš„å€¼ã€‚&lt;/p>
&lt;h1 id="upgrade">Upgrade&lt;/h1>
&lt;h2 id="upgrade-root-api">Upgrade Root API&lt;/h2>
&lt;p>åŒæ—¶è¿˜éœ€è¦å‡çº§ä¸€ä¸‹ root api æ‰èƒ½ä½¿ç”¨æœ€æ–°çš„å¹¶å‘ç‰¹æ€§ã€‚&lt;/p>
&lt;ul>
&lt;li>Legacy Root API&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">ReactDOM&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;react-dom&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">App&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;App&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">container&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Initial render.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ReactDOM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">(&amp;lt;&lt;/span>&lt;span class="nt">App&lt;/span> &lt;span class="p">/&amp;gt;,&lt;/span> &lt;span class="nx">container&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>New Root API&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;react-dom/client&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">App&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;App&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">container&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Create a root.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRoot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">container&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Initial render: Render an element to the root.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">root&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">(&amp;lt;&lt;/span>&lt;span class="nt">App&lt;/span> &lt;span class="p">/&amp;gt;);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºäº†ä»£ç çš„å¹³æ»‘å‡çº§ï¼Œä¸¤ç§æ–¹å¼éƒ½å°†ä¼šä¿ç•™ï¼Œä¸ç„¶æ•ˆæžœä¼šæ˜¯ï¼Œå‡çº§å®Œ 18 çš„åŒ…å‘çŽ°è¿è¡Œç›´æŽ¥å´©æºƒ= =ï¼Œä½†æ˜¯ä½¿ç”¨æ—§çš„ render æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§ä¸”ä¼šèŽ·å¾— warningï¼Œå¼•å¯¼è¿›è¡Œ root å‡çº§&lt;/p>
&lt;p>æ–°æ—§ RootAPI è¿˜æœ‰ä¸€ç‚¹æ”¹åŠ¨æ˜¯ï¼ŒåŽŸå…ˆ render ä¼šåŒ…å«ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå›žè°ƒï¼Œæ–°çš„ api ç§»é™¤äº†&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">ReactDOM&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;react-dom&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">App&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;App&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">container&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;app&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ReactDOM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">container&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">App&lt;/span> &lt;span class="na">tab&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;home&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;,&lt;/span> &lt;span class="kd">function&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Called after inital render or any update.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;rendered&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¥ä»£æ›¿ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡ ref&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react-dom/client&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">App&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">callback&lt;/span> &lt;span class="p">})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Callback will be called when the div is first created.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">div&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">callback&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">h1&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="nx">Hello&lt;/span> &lt;span class="nx">World&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/h1&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/div&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">rootElement&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRoot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rootElement&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">root&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">App&lt;/span> &lt;span class="nx">callback&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;renderered&amp;#34;&lt;/span>&lt;span class="p">)}&lt;/span> &lt;span class="o">/&amp;gt;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>é€šè¿‡ useEffect&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">useEffect&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s2">&amp;#34;react-dom/client&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">App&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">useEffect&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Callback will be called when the div is first created.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;renderered&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="p">[]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">div&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">h1&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="nx">Hello&lt;/span> &lt;span class="nx">World&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/h1&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="err">/div&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">rootElement&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ReactDOMClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRoot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rootElement&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">root&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">App&lt;/span> &lt;span class="o">/&amp;gt;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸¤è€…çš„åŒºåˆ«åœ¨äºŽ&lt;/p>
&lt;ul>
&lt;li>Ref ä¼šåœ¨åº”ç”¨æ·»åŠ åˆ° dom ä¹‹åŽåŒæ­¥çš„æ‰§è¡Œ&lt;/li>
&lt;li>Effects ç”±äºŽæœ¬èº«çš„å®žçŽ°æ˜¯å¼‚æ­¥çš„ï¼Œä¼šæœ‰ä¸€ä¸ªå°çš„å»¶è¿Ÿ&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨å“ªç§æ–¹å¼å–å†³äºŽä½ å…·ä½“çš„ä¸šåŠ¡åœºæ™¯&lt;/p>
&lt;h2 id="fix-tearing--usesyncexternalstore">Fix Tearing &amp;amp; useSyncExternalStore&lt;/h2>
&lt;p>ç»å¤§å¤šæ•°ç±»åº“ä¸éœ€è¦åšä»»ä½•æ”¹åŠ¨å°±èƒ½å¤Ÿå…¼å®¹ React 18ï¼Œç„¶è€Œç”±äºŽå¹¶å‘æ¸²æŸ“çš„åŽŸå› ä½¿ç”¨éƒ¨åˆ†ç±»åº“ä¼šå¼•å‘ tearing çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œä¸€äº›å‡çº§æ‰èƒ½å…¼å®¹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Screen tearing is a visual artifact in video display where a display device shows information from multiple frames in a single screen draw - wiki&lt;/p>
&lt;/blockquote>
&lt;p>ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨å±å¹•ä¸Šçœ‹åˆ°äº†åŒä¸€ä¸ªç‰©ä½“çš„ä¸åŒå¸§çš„å½±åƒï¼Œç”»é¢ä»¿ä½›æ˜¯â€œæ’•è£‚çš„â€ï¼Œå¯¹åº”çš„ react ä¸­ï¼ŒæŒ‡ä½¿ç”¨äº†è¿‡åŽ»ç‰ˆæœ¬çš„çŠ¶æ€è¿›è¡Œç”»é¢æ¸²æŸ“å¼•èµ·çš„ UI ä¸ä¸€è‡´æˆ–è€…å´©æºƒã€‚ç”±äºŽ JS æ˜¯å•çº¿ç¨‹çš„ï¼Œå…¶å®ž web å¼€å‘ä¸­ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥å¹¶å‘æ¸²æŸ“åŽï¼Œæ¸²æŸ“æ˜¯å¯èƒ½è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¸­æ–­ï¼Œè¿™ä¹Ÿä½¿å¾— tearing æˆä¸ºå¯èƒ½ã€‚ ä½† React æœ¬èº«å¯¹äºŽ state çš„æ›´æ–°åšäº†å¾ˆå¤šçš„å·¥ä½œæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬çš„ä¾èµ–äº†å¤–éƒ¨çš„çŠ¶æ€ï¼ŒReact å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸ºå®ƒå¹¶ä¸çŸ¥é“ä½ ä»€ä¹ˆæ—¶å€™æ›´æ–°äº†å¤–éƒ¨çš„çŠ¶æ€ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼š&lt;/p>
&lt;ul>
&lt;li>åŒæ­¥æ¸²æŸ“&lt;/li>
&lt;/ul>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/item/20230503153747.png" alt="åŒæ­¥æ¸²æŸ“" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;ul>
&lt;li>å¹¶å‘æ¸²æŸ“&lt;/li>
&lt;/ul>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/item/20230503153823.png" alt="å¹¶å‘æ¸²æŸ“" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>&lt;/p>
&lt;p>è¿™é‡Œ externalStore å°±æ˜¯æˆ‘ä»¬ä¾èµ–çš„ä¸€äº›å¤–éƒ¨çŠ¶æ€ï¼Œæ¯”å¦‚å¸¸è§çš„ reduxï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä½¿ç”¨ react-redux 7 çš„ä¾‹å­ï¼Œå¯ä»¥ç›´è§‚çš„æ„Ÿå—åˆ° tearing çš„å­˜åœ¨ã€‚å› æ­¤ 18 ä¸­ä¸“é—¨é’ˆå¯¹è¿™éƒ¨åˆ†ç±»åº“æä¾›ç›¸å…³çš„ API - useSyncExternalStoreï¼Œæ¯”å¦‚ react-redux 8.0.0 å®žé™…ä¸Šå°±å·²ç»é›†æˆè¿›åŽ»äº†ï¼Œå¤§å®¶å¯ä»¥æŠŠä¸Šé¢ demo ä¸­çš„ä¾èµ–æ”¹æˆè¿™ä¸ªç‰ˆæœ¬å†è¯•ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>å…·ä½“ç”¨æ³•çš„è¯ï¼Œè¿™è¾¹ç›´æŽ¥åšäº†ä¸€ä¸ª demoï¼Œä¸ºäº†ä½“çŽ°å…·ä½“çš„æ”¹åŠ¨ï¼Œå®žçŽ°äº†ä¸€ä¸ª redux-likeï¼Œé‡ç‚¹å…³æ³¨ä¸¤ä¸ª useSelectorï¼Œçœ‹ä¸€ä¸‹&lt;a href="https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fusesyncexternalstore-demo-671587" target="_blank" rel="noopener">ä½¿ç”¨ä¸¤ä¸ªä¸åŒ selector çš„æ•ˆæžœ&lt;/a>ã€‚&lt;/p>
&lt;p>ç›¸ä¿¡å¤§å®¶åº”è¯¥å¯ä»¥æ„Ÿå—åˆ°åŒºåˆ«ï¼Œä¸è¿‡æˆ‘ä»¬çœ‹åˆ°è™½ç„¶ä½¿ç”¨äº† useSyncExternalStore é€šè¿‡æŽ¥å…¥ useSyncExternalStore å¯ä»¥è¾¾åˆ° ã€Œâœ… Make it rightã€çš„æ•ˆæžœï¼Œä½†æ˜¯ä¹Ÿèƒ½æ„Ÿå—åˆ°è¦æ¯”æ²¡æœ‰ä½¿ç”¨ä¹‹å‰æ›´å¡äº†ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°ã€ŒðŸš€ Make it fastã€çš„æ•ˆæžœï¼Œå…¶å®žåŽŸå› è·Ÿè¿™ä¸ªæ–¹æ³•æœ¬èº«çš„å®žçŽ°æœ‰å…³ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span> &lt;span class="nx">updateSyncExternalStore&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">subscribe&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="k">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="k">void&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">getSnapshot&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">getServerSnapshot&lt;/span>&lt;span class="o">?:&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">T&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">T&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">nextSnapshot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">getSnapshot&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prevSnapshot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">hook&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">memoizedState&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">snapshotChanged&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">is&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">prevSnapshot&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">nextSnapshot&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// storeå†…å€¼æ›´æ–°æ—¶ï¼Œè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updateEffect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">subscribeToStore&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fiber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">subscribe&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">subscribe&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// commitçŽ¯å¢ƒå¼€å§‹ä¹‹å‰ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getSnapshot&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="nx">getSnapshot&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">snapshotChanged&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pushEffect&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HookHasEffect&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="nx">HookPassive&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updateStoreInstance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fiber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">nextSnapshot&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">getSnapshot&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kc">undefined&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kc">null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// renderçŽ¯èŠ‚ç»“æŸæ—¶ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nx">includesBlockingLane&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">renderLanes&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pushStoreConsistencyCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fiber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">getSnapshot&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">nextSnapshot&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸€è‡´æ€§æ£€æŸ¥æ–¹æ³•å†…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">checkIfSnapshotChanged&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Force a sync re-render.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">scheduleUpdateOnFiber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fiber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">SyncLane&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">NoTimestamp&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œå®žçŽ°çš„æ ¸å¿ƒæ˜¯åŠ äº†ä¸‰é‡ä¿éšœæ¥è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œå½“å‡ºçŽ°ä¸ä¸€è‡´æ—¶å°±å‘èµ·ä¸€ä¸ªåŒæ­¥æ›´æ–°çš„è°ƒåº¦ï¼Œå› æ­¤ transition çš„æ•ˆæžœå°±å¤±çµäº†ï¼Œæ‰€ä»¥ä¼šé˜»å¡žé¡µé¢äº¤äº’å‡ºçŽ°äº†å¡é¡¿ã€‚å¯¹äºŽè¿™ä¸ªé—®é¢˜ React å›¢é˜Ÿè¿˜åœ¨ç ”ç©¶å’ŒæŽ¢ç´¢ï¼Œä»ç„¶è¿˜æœ‰ä¸€æ®µè·¯è¦èµ°ã€‚&lt;/p>
&lt;p>å¦å¤–å¯¹äºŽç±»åº“å¼€å‘è€…æ¥è¯´ï¼Œåœ¨ç¤¾åŒºå¹¶å‘ç‰¹æ€§å…¨é¢é“ºå¼€å‰ï¼Œä¸é¼“åŠ±åœ¨ç±»åº“ä¸­ä½¿ç”¨ Concurrent Featuresï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ä¾èµ–æˆ‘ä»¬ç±»åº“çš„ä¸Šå±‚åº”ç”¨é»˜è®¤å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œè€Œè¿™å¯èƒ½ä¸æ˜¯ä»–ä»¬æ‰€æœŸæœ›çš„ã€‚&lt;/p></description></item></channel></rss>