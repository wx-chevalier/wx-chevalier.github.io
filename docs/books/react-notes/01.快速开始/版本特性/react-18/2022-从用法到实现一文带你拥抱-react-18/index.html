<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="åŸæ–‡åœ°å€ ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18 å‰è¨€ React å›¢é˜Ÿåœ¨æ‰“é€ å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ä¸Šå…¶å®ä¸€ç›´åœ¨æ¢ç´¢ï¼Œæœ€ç»ˆç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯æ•´åˆäº†äººæœºäº¤äº’ç ”ç©¶æˆæœï¼ˆåæ–‡ä¼šå…·ä½“ä»‹ç»ï¼‰çš„ Concurrent Renderingã€‚ ç„¶è€Œå› ä¸ºè¿™èƒŒåçš„å¤æ‚æ€§ã€ç¨³å®š"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/"><meta property="og:title" content="2022-ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18 | Next-gen Tech Edu"><meta property="og:description" content="åŸæ–‡åœ°å€ ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18 å‰è¨€ React å›¢é˜Ÿåœ¨æ‰“é€ å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ä¸Šå…¶å®ä¸€ç›´åœ¨æ¢ç´¢ï¼Œæœ€ç»ˆç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯æ•´åˆäº†äººæœºäº¤äº’ç ”ç©¶æˆæœï¼ˆåæ–‡ä¼šå…·ä½“ä»‹ç»ï¼‰çš„ Concurrent Renderingã€‚ ç„¶è€Œå› ä¸ºè¿™èƒŒåçš„å¤æ‚æ€§ã€ç¨³å®š"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>2022-ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=083842b5b7a3593ad4cf54c46cfd152b><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>æœç´¢</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=å…³é—­><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=åˆ‡æ¢å¯¼èˆª>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>ç¬”è®°ï¼ˆä¸‡ç¯‡ï¼‰</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>çŸ¥è¯†å›¾è°±</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>å®éªŒå®¤</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft æ–¹å—ä¸–ç•Œ</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D çŸ¥è¯†å¡ç‰Œ</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>å…¶ä»–é˜…è¯»æ¸ é“</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>çŸ¥ä¹</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>æ˜é‡‘</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=æœç´¢><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">React 18</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>æœç´¢...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd8641a5a6f03015adc69d61373ff1d57")' href=#idd8641a5a6f03015adc69d61373ff1d57 aria-expanded=false aria-controls=idd8641a5a6f03015adc69d61373ff1d57 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/>ç‰ˆæœ¬ç‰¹æ€§</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idd8641a5a6f03015adc69d61373ff1d57 aria-expanded=false aria-controls=idd8641a5a6f03015adc69d61373ff1d57><i class="fa-solid fa-angle-down" id=caret-idd8641a5a6f03015adc69d61373ff1d57></i></a></div><ul class="nav docs-sidenav collapse show" id=idd8641a5a6f03015adc69d61373ff1d57><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id83788bf07de712b6561883e9994fe249")' href=#id83788bf07de712b6561883e9994fe249 aria-expanded=false aria-controls=id83788bf07de712b6561883e9994fe249 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id6bb00c357ed3e138b4bbb8010e863dd2")' href=#id6bb00c357ed3e138b4bbb8010e863dd2 aria-expanded=false aria-controls=id6bb00c357ed3e138b4bbb8010e863dd2 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idba12e12f8c7424ea993fad645ad3efd1")' href=#idba12e12f8c7424ea993fad645ad3efd1 aria-expanded=false aria-controls=idba12e12f8c7424ea993fad645ad3efd1 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id1307b72d97811505bcbd6c36a3031cc0")' href=#id1307b72d97811505bcbd6c36a3031cc0 aria-expanded=false aria-controls=id1307b72d97811505bcbd6c36a3031cc0 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/>React 18</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id1307b72d97811505bcbd6c36a3031cc0 aria-expanded=false aria-controls=id1307b72d97811505bcbd6c36a3031cc0><i class="fa-solid fa-angle-down" id=caret-id1307b72d97811505bcbd6c36a3031cc0></i></a></div><ul class="nav docs-sidenav collapse show" id=id1307b72d97811505bcbd6c36a3031cc0><li class="child level active"><a href=/books/react-notes/01.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/react-18/2022-%E4%BB%8E%E7%94%A8%E6%B3%95%E5%88%B0%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E6%8B%A5%E6%8A%B1-react-18/>2022-ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>ç›®å½•</a></li></ul><nav id=TableOfContents><ul><li><a href=#auto-batching>Auto Batching</a><ul><li><a href=#deep-dive>Deep dive</a></li></ul></li><li><a href=#transition>Transition</a><ul><li><a href=#starttransition>startTransition</a></li><li><a href=#usetransition>useTransition</a></li><li><a href=#ä¸ä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«>ä¸ä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«</a></li><li><a href=#deep-dive-1>Deep dive</a></li><li><a href=#usedeferredvalue>useDeferredValue</a></li></ul></li></ul><ul><li><a href=#upgrade-root-api>Upgrade Root API</a></li><li><a href=#fix-tearing--usesyncexternalstore>Fix Tearing & useSyncExternalStore</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=ç‹ä¸‹é‚€æœˆç†Šçš„å¾®ä¿¡å…¬ä¼—å·></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>2022-ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18</h1><div class=article-style><blockquote><p><a href=https://juejin.cn/post/7095185674151821348#heading-14 target=_blank rel=noopener>åŸæ–‡åœ°å€</a></p></blockquote><h1 id=ä»ç”¨æ³•åˆ°å®ç°ä¸€æ–‡å¸¦ä½ æ‹¥æŠ±-react-18>ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18</h1><h1 id=å‰è¨€>å‰è¨€</h1><p>React å›¢é˜Ÿåœ¨æ‰“é€ å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ä¸Šå…¶å®ä¸€ç›´åœ¨æ¢ç´¢ï¼Œæœ€ç»ˆç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯æ•´åˆäº†äººæœºäº¤äº’ç ”ç©¶æˆæœï¼ˆåæ–‡ä¼šå…·ä½“ä»‹ç»ï¼‰çš„ Concurrent Renderingã€‚</p><p>ç„¶è€Œå› ä¸ºè¿™èƒŒåçš„å¤æ‚æ€§ã€ç¨³å®šæ€§ã€å…¼å®¹æ€§ç­‰é—®é¢˜ï¼Œä» 16 ç‰ˆæœ¬çš„ Async Mode å¼€å§‹å°±åœ¨ä¸æ–­æ‰“ç£¨ï¼Œè€—æ—¶å¤šå¹´ï¼Œç»å†äº† 17 ç‰ˆæœ¬è¿‡æ¸¡ï¼Œæœ€ç»ˆä¼´éšç€ 18 ç‰ˆæœ¬æ­£å¼ä¸Šçº¿ï¼Œè¿™ä¸€ç‰ˆæœ¬ä¸­å¼€å‘è€…å¯ä»¥å®Œå…¨å¹³æ»‘çš„å¼€å¯å¹¶å‘ç‰¹æ€§ã€‚</p><p>ä»Šå¤©å¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« å¸¦å¤§å®¶ä¸€èµ·æ·±å…¥äº†è§£ä¸€ä¸‹ React 18 ä¸­çš„æ–°ç‰¹æ€§ã€æ–°èƒ½åŠ›ã€‚</p><h1 id=concurrent-rendering>Concurrent Rendering</h1><p>Concurrency æ˜¯ React 18 çš„å…³é”®è¯ï¼Œå¯ä»¥ç†è§£æˆæ˜¯ä¸€ç§èƒŒåçš„æœºåˆ¶ï¼Œä¿è¯ React èƒ½å¤ŸåŒæ—¶å‡†å¤‡å¤šå¥— UIã€‚å…·ä½“åˆ°è¡¨ç°ä¸ŠåŒºåˆ«äºä»¥å¾€çš„æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ¸²æŸ“æ˜¯å¯ä¸­æ–­çš„ã€‚è¿™æ„å‘³ç€å½“ä½ çš„åº”ç”¨æ­£åœ¨è¿›è¡Œå¤æ‚æ›´æ–°çš„æ—¶å€™ï¼Œä»ç„¶å¯ä»¥ä¸é¡µé¢è¿›è¡Œäº¤äº’ï¼Œä¿è¯ä¸€ä¸ªæµç•…çš„ç”¨æˆ·ä½“éªŒã€‚ æ—¢ç„¶æ˜¯ä¸€ç§èƒŒåçš„æœºåˆ¶ï¼Œå®é™…ä¸Šå¼€å‘è€…å¹¶ééœ€è¦å…ˆå­¦ä¹ å¹¶å‘æ¸²æŸ“æ‰èƒ½ä½¿ç”¨ React18ï¼Œä½†æ˜¯èƒ½å¤ŸæŒæ¡å¹¶å‘æ¸²æŸ“å¯¹äºæ–°ç‰¹æ€§çš„ç†è§£æœ‰éå¸¸å¤§çš„ä½œç”¨ã€‚</p><p>æ ¸å¿ƒå®ç°æ˜¯é€šè¿‡ç»„ä»¶ä½œä¸ºä¸€ä¸ªåŸºæœ¬çš„å·¥ä½œå•å…ƒå°†ä¸€ä¸ªå¤§çš„æ›´æ–°ä»»åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åä»¥æ—¶é—´åˆ‡ç‰‡çš„æ–¹å¼ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„æ—¶é—´ç‰‡æ¥æ‰§è¡Œï¼Œæ¯ä¸ªæ—¶é—´ç‰‡æ‰§è¡Œå®Œæˆåéƒ½ä¼šä¸»åŠ¨é‡Šæ”¾æ§åˆ¶æƒï¼Œä½¿å¾—æµè§ˆå™¨èƒ½å¤Ÿå¤„ç†å…¶å®ƒç”¨æˆ·äº‹ä»¶ã€‚è€Œå…·ä½“æ—¶é—´ç‰‡ä¸Šæ‰§è¡Œå“ªä¸ªä»»åŠ¡æ˜¯ç”±ä»»åŠ¡ä¸Šçš„ç›¸å…³ä¼˜å…ˆçº§å†³å®šçš„ï¼Œå½“é«˜ä¼˜å…ˆçº§çš„æ›´æ–°åˆ°æ¥æ—¶ï¼Œä¼šä¸­æ–­æ—§çš„æ›´æ–°ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¾…å®Œæˆåç»§ç»­æ‰§è¡Œä½ä¼˜å…ˆçº§æ›´æ–°ï¼Œå› æ­¤åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œæˆ‘ä»¬çœ‹ React åœ¨å¹¶å‘çš„æ‰§è¡Œå¤šä¸ªæ¸²æŸ“ä»»åŠ¡ã€‚</p><h2 id=auto-batching>Auto Batching</h2><p>é¦–å…ˆæ‰¹å¤„ç†æ˜¯æŒ‡ React å°†å¤šæ¬¡çŠ¶æ€æ›´æ–°åˆå¹¶æˆä¸€æ¬¡é‡æ¸²æŸ“æ¥æå‡æ€§èƒ½ï¼Œæ—©åœ¨ 16 çš„ç‰ˆæœ¬ä¸­å…¶å®å°±å·²ç»åŒ…å«äº†æ‰¹å¤„ç†èƒ½åŠ›ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>App</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>count</span><span class=p>,</span> <span class=nx>setCount</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>flag</span><span class=p>,</span> <span class=nx>setFlag</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>handleClick</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setCount</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// Does not re-render yet
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>setFlag</span><span class=p>((</span><span class=nx>f</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=o>!</span><span class=nx>f</span><span class=p>);</span> <span class=c1>// Does not re-render yet
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// React will only re-render once at the end (that&#39;s batching!)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>button</span> <span class=nx>onClick</span><span class=o>=</span><span class=p>{</span><span class=nx>handleClick</span><span class=p>}</span><span class=o>&gt;</span><span class=nx>Next</span><span class=o>&lt;</span><span class=err>/button&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>h1</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>color</span><span class=o>:</span> <span class=nx>flag</span> <span class=o>?</span> <span class=s2>&#34;blue&#34;</span> <span class=o>:</span> <span class=s2>&#34;black&#34;</span> <span class=p>}}</span><span class=o>&gt;</span><span class=p>{</span><span class=nx>count</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/h1&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ç„¶è€Œå¦‚æœæ›´æ–°å‘ç”Ÿåœ¨ timeouts, promises, native event handlers ç­‰é React events äº‹ä»¶ä¸­ï¼ŒReact 18 ä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤éƒ½ä¸ä¼šè¿›è¡Œåˆå¹¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleClick</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fetchSomething</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// React 17 and earlier does NOT batch these because
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// they run *after* the event in a callback, not *during* it
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>setCount</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// Causes a re-render
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>setFlag</span><span class=p>((</span><span class=nx>f</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=o>!</span><span class=nx>f</span><span class=p>);</span> <span class=c1>// Causes a re-render
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>åœ¨ React 18 ä¸­ï¼Œä¸ä¼šæ›´æ–°å‘ç”Ÿåœ¨å“ªé‡Œï¼Œéƒ½ä¼šè‡ªåŠ¨åˆå¹¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§è‡ªåŠ¨åˆå¹¶æ˜¯å®Œå…¨å®‰å…¨ä¸”æ— æ„ŸçŸ¥çš„ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€äº› bad case éœ€è¦ç‰¹æ®Šå¤„ç†ä»¥ä¿æŒå‘å‰å…¼å®¹ï¼Œæ¯”å¦‚ä¸‹é¢çš„ caseï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>handleClick</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>(({</span> <span class=nx>count</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>({</span> <span class=nx>count</span><span class=o>:</span> <span class=nx>count</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// { count: 1, flag: false } before 18
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// { count: 0, flag: false } in 18
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>(({</span> <span class=nx>flag</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>({</span> <span class=nx>flag</span><span class=o>:</span> <span class=o>!</span><span class=nx>flag</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>åœ¨ 18 ä¹‹å‰ï¼Œç”±äºæ›´æ–°ä¼šåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿè·å¾—ä¸­é—´çŠ¶æ€ã€‚ç„¶è€Œåœ¨ 18 ä¸­ï¼Œå³ä½¿æ˜¯ setTimeout ä¸­çš„æ›´æ–°ä¹Ÿä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¹¶åœ¨ next tick ä¸­åˆå¹¶æ‰§è¡Œï¼Œæ‰“å°çš„çŠ¶æ€ä¸ºåˆå§‹åŒ–çŠ¶æ€ï¼Œä»è€Œå‰åä¸ä¸€è‡´ã€‚</p><p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React 18 ä¸­æä¾›çš„ ReactDOM.flushSync æ¥ä¿æŒå‘å‰å…¼å®¹ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>handleClick</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ReactDOM</span><span class=p>.</span><span class=nx>flushSync</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>(({</span> <span class=nx>count</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>({</span> <span class=nx>count</span><span class=o>:</span> <span class=nx>count</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// { count: 1, flag: false }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>(({</span> <span class=nx>flag</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>({</span> <span class=nx>flag</span><span class=o>:</span> <span class=o>!</span><span class=nx>flag</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 id=deep-dive>Deep dive</h3><p>è‡ªåŠ¨æ‰¹å¤„ç†å®ç°çš„å…³é”®åœ¨äº React18 ä¸­æ›´æ–°æ˜¯åŸºäºä¼˜å…ˆçº§çš„ï¼Œæˆ‘ä»¬ç»“åˆä¸‹é¢æºç çœ‹ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•æ˜¯ 18 ä¸­æ¯ä¸€æ¬¡æ›´æ–°è°ƒåº¦çš„å¿…ç»ä¹‹è·¯ï¼Œæ‰¹å¤„ç†çš„å®ç°çš„æ ¸å¿ƒåœ¨äºå½“ç›¸åŒä¼˜å…ˆçº§çš„æ›´æ–°å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸ä¼šç”Ÿæˆæ–°çš„ä»»åŠ¡ï¼Œè€Œæ˜¯å¤ç”¨ä¸Šä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°åˆå¹¶ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>ensureRootIsScheduled</span><span class=p>(</span><span class=nx>root</span><span class=o>:</span> <span class=nx>FiberRoot</span><span class=p>,</span> <span class=nx>currentTime</span><span class=o>:</span> <span class=nx>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Determine the next lanes to work on, and their priority.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>nextLanes</span> <span class=o>=</span> <span class=nx>getNextLanes</span><span class=p>(</span><span class=nx>root</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// We use the highest priority lane to represent the priority of the callback.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>newCallbackPriority</span> <span class=o>=</span> <span class=nx>getHighestPriorityLane</span><span class=p>(</span><span class=nx>nextLanes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Check if there&#39;s an existing task. We may be able to reuse it.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>existingCallbackPriority</span> <span class=o>=</span> <span class=nx>root</span><span class=p>.</span><span class=nx>callbackPriority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>existingCallbackPriority</span> <span class=o>===</span> <span class=nx>newCallbackPriority</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The priority hasn&#39;t changed. We can reuse the existing task. Exit.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Cancel the existing callback.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>cancelCallback</span><span class=p>(</span><span class=nx>existingCallbackNode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// schedule a new one.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>newCallbackPriority</span> <span class=o>===</span> <span class=nx>SyncLane</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>scheduleSyncCallback</span><span class=p>(</span><span class=nx>performSyncWorkOnRoot</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>root</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>newCallbackNode</span> <span class=o>=</span> <span class=nx>scheduleCallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>schedulerPriorityLevel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>performConcurrentWorkOnRoot</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>root</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¦‚æœç†è§£äº†è¿™ä¸ªï¼Œé‚£ä¸ª FlushSync çš„å®ç°ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œæ— éæ˜¯å°†å†…éƒ¨æ›´æ–°çš„ä¼˜å…ˆçº§å¼ºåˆ¶æŒ‡å®šä¸º SyncLaneï¼Œå³æŒ‡å®šä¸ºåŒæ­¥ä¼˜å…ˆçº§ï¼Œå…·ä½“æ•ˆæœå°±æ˜¯æ¯ä¸€æ¬¡æ›´æ–°æ—¶éƒ½ä¼šåŒæ­¥çš„æ‰§è¡Œæ¸²æŸ“ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>flushSync</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// DiscreteEventPriority === SyncLane
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>setCurrentUpdatePriority</span><span class=p>(</span><span class=nx>DiscreteEventPriority</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fn</span> <span class=o>&amp;&amp;</span> <span class=nx>fn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setCurrentUpdatePriority</span><span class=p>(</span><span class=nx>previousPriority</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=transition>Transition</h2><p>transition æ˜¯ 18 ç‰ˆæœ¬ä¸­æ–°æå‡ºçš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯æœ€èƒ½ä½“ç°å¹¶å‘æ¸²æŸ“ä¼˜åŠ¿çš„ä¸Šå±‚åº”ç”¨ã€‚å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå½“æ»‘å—æ»‘åŠ¨æ—¶ï¼Œä¸‹æ–¹çš„å›¾è¡¨ä¼šä¸€èµ·æ›´æ–°ï¼Œç„¶è€Œå›¾è¡¨æ›´æ–°æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹æ“ä½œï¼Œæ¯”è¾ƒè€—æ—¶ã€‚ç”±äºé˜»å¡äº†æ¸²æŸ“å¯¼è‡´é¡µé¢å¤±å»å“åº”ï¼Œç”¨æˆ·èƒ½å¤Ÿéå¸¸æ˜æ˜¾çš„æ„Ÿå—åˆ°å¡é¡¿ã€‚</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/gif/14f828dc58f84e729acf6343bfcc7d7c%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp alt loading=lazy data-zoomable></div></div></figure></p><p>å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬æ‹–åŠ¨æ»‘å—çš„æ—¶å€™ï¼Œéœ€è¦åšä¸¤æ¬¡æ›´æ–°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Urgent: Show what was typed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setSliderValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Not urgent: Show the results
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setGraphValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span></code></pre></div><p>ä¸€ä¸ªæ˜¯æ¯”è¾ƒç´§æ€¥éœ€è¦ç«‹åˆ»ååº”åœ¨ç•Œé¢ä¸Šï¼Œå¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—é‡åˆ°äº† bugã€‚è€Œå¦ä¸€ä¸ªå¯¹äºç”¨æˆ·è€Œè¨€ï¼ŒæŸ¥è¯¢ç»“æœçš„æ˜¾ç¤ºï¼Œå³ä½¿å­˜åœ¨ä¸€äº›å»¶è¿Ÿä¹Ÿæ˜¯å¯æ¥å—çš„ã€‚è¿™ç§æ¥å—ç¨‹åº¦æ­£æ˜¯äººæœºç ”ç©¶çš„æˆæœï¼š</p><blockquote><p>we know from research that interactions like hover and text input need to be handled within a very short period of time, while clicks and page transitions can wait a little longer without feeling laggy. â€”â€” Putting Research into Production</p></blockquote><p>åœ¨ React 18 ä¹‹å‰æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç¼ºä¹ä¸€ç§æœºåˆ¶ï¼Œæ¥å£°æ˜è¿™ç§ä¸åŒç´§æ€¥ç¨‹åº¦çš„æ›´æ–°ï¼ŒTransition å°±ç”¨æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚React 18 ä¸­æä¾›äº† startTransition æ¥è®©å¼€å‘è€…æ˜¾ç¤ºçš„å£°æ˜éç´§æ€¥æ›´æ–°ã€‚transition å–åçš„å«ä¹‰æ˜¯ï¼ŒReact ä¸­ä»å¼€å‘è€…è§’åº¦å°†çŠ¶æ€æ›´æ–°åˆ†æˆäº†ä¸¤ç±»ï¼š</p><ul><li>ä¸€ç±»æ˜¯ç”¨æˆ·è¾“å…¥ã€ç‚¹å‡»ç­‰ç´§æ€¥æ›´æ–°ï¼Œå¦ä¸€ç±»æ˜¯å°† UI ä»ä¸€ä¸ªè§†å›¾è½¬å˜æˆå¦å¤–ä¸€ä¸ª</li><li>transition ä¸­å¯¹åº”çš„æ›´æ–°ç±»å‹ä¸ºç¬¬äºŒç§ã€‚</li></ul><h3 id=starttransition>startTransition</h3><p>é€šè¿‡ starTransition å¯ä»¥æ ‡è®°éç´§æ€¥çš„æ›´æ–°ï¼Œå…·ä½“çš„æ‰§è¡Œæ—¶æœºä¼šæ ¹æ®å½“å‰ç©ºé—²ç¨‹åº¦åŠ¨æ€å†³å®šã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>startTransition</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;react&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Urgent
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setSliderValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mark any state updates inside as transitions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>startTransition</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Transition: Show the results
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>setGraphValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h3 id=usetransition>useTransition</h3><p>å¯ä»¥é€šè¿‡ useTransition ä¸­çš„ pending æ¥ç¡®å®šå½“å‰æ›´æ–°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå¹¶æ¸²æŸ“ä¸€äº› loadingï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTransition</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;react&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>[</span><span class=nx>isPending</span><span class=p>,</span> <span class=nx>startTransition</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useTransition</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>isPending</span> <span class=o>&amp;&amp;</span> <span class=o>&lt;</span><span class=nx>Spinner</span> <span class=o>/&gt;</span><span class=p>;</span>
</span></span></code></pre></div><p>ç„¶è€Œå³ä½¿æˆ‘ä»¬æ ¹æ® isPending è®¾ç½®äº† loading ç•Œé¢ï¼Œè¿™ä¸ª loading ä¹Ÿå¹¶éä¸€å®šä¼šå‡ºç°ï¼Œæ ¹æ®äººæœºäº¤äº’çš„ç ”ç©¶æˆæœï¼Œè¿‡å¤šçš„æ˜¾ç¤ºä¸€äº›ä¸­é—´è§†å›¾ä¼šè®©ç”¨æˆ·æ„Ÿè§‰å¾—æ›´æ…¢ï¼Œå› æ­¤åœ¨æ€§èƒ½æ¯”è¾ƒå¥½æ—¶ï¼Œtransition ä¸­çš„æ›´æ–°å¾ˆå¿«æ‰§è¡Œï¼Œloading ç•Œé¢å°†ä¸ä¼šå±•ç¤ºï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå‡ºç°â€œé—ªä¸€ä¸‹â€çš„æƒ…å†µï¼Œæ¥æå‡ç”¨æˆ·ä½“éªŒï¼š</p><blockquote><p>research shows that displaying too many intermediate loading states when transitioning between screens makes a transition feel slower. â€”â€” Putting Research into Production</p></blockquote><p>æˆ‘ä»¬å†æ¥æ„Ÿå—ä¸€ä¸‹ä½¿ç”¨äº† transition ä¹‹åçš„æ•ˆæœï¼š</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/gif/82e2121398404324a61f9d215ff1b348%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp alt loading=lazy data-zoomable></div></div></figure></p><p>åº”è¯¥å¯ä»¥æ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œè™½ç„¶å›¾è¡¨çš„æ›´æ–°è¿˜æ˜¯ä¼šæœ‰äº›å»¶è¿Ÿï¼Œä½†æ˜¯æ•´ä½“çš„ç”¨æˆ·ä½“éªŒç›¸å¯¹ä¹‹å‰æ˜¯éå¸¸å¥½çš„ã€‚</p><h3 id=ä¸ä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«>ä¸ä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«</h3><p>è™½ç„¶åœ¨ 18 ç‰ˆæœ¬ä¹‹å‰ React æœ¬èº«å¹¶æ²¡æœ‰æä¾›å£°æ˜æ›´æ–°ä¼˜å…ˆçº§çš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡ JS æ¥ä¼˜åŒ–è¿™ä¸€é—®é¢˜ï¼Œæ¯”å¦‚é€šè¿‡ setTimeout / throttle / debounce</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setSliderValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setGraphValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></div><p>ä¸ä¹‹ç›¸æ¯”ï¼Œ<code>transition</code>çš„åŒºåˆ«ä¸»è¦è¡¨ç°åœ¨:</p><ul><li><strong>æ‰§è¡Œæ—¶æœº</strong>ï¼Œ<code>setTimout/throttle/debounce</code> å‡ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè€Œ<code>transition</code>ä¸ºåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤ä¼šæ¯”ä»–ä»¬æ›´æ—©çš„è§¦å‘æ›´æ–°è°ƒåº¦ï¼Œåœ¨æ€§èƒ½è¾ƒå¥½æ—¶å¯èƒ½åœ¨åŒä¸€å¸§å®Œæˆæ›´æ–°ï¼Œè€Œè¿™ç§æƒ…å†µåœ¨æ¯”å¦‚<code>throttle</code>ä¸­è¢«å¼ºåˆ¶æ‹‰å¤§ï¼Œæ¯”å¦‚ 100ms</li><li><strong>äº¤äº’ä½“éªŒ</strong>ï¼Œä¸ç®¡æ˜¯å»¶è¿Ÿè¿˜æ˜¯å‡é¢‘ï¼Œå½“çœŸæ­£è§¦å‘æ›´æ–°ï¼Œå¦‚æœæ¸²æŸ“æ—¶é—´æ¯”è¾ƒä¹…ï¼Œä¾ç„¶ä¼šå‘ç”Ÿç•Œé¢å¡é¡¿ï¼Œè€Œé€šè¿‡<code>transition</code>è§¦å‘çš„æ›´æ–°å¹¶ä¸ä¼šé˜»å¡ç”¨æˆ·ç•Œé¢ï¼Œèƒ½å¤Ÿä¸€ç›´ä¿æŒå“åº”</li><li><strong>ç²¾ç¡®æ§åˆ¶</strong>ï¼Œéœ€è¦é¢å¤–å®ç° loading æ§åˆ¶ï¼Œè€Œä¸”å¾€å¾€ä¸å¤Ÿç²¾ç¡®ï¼Œç°åœ¨<code>transition</code>å†…éƒ¨ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç»´æŠ¤è¿™ä¸ª loading çŠ¶æ€ï¼Œå¹¶ä¸”è¶³å¤Ÿç²¾ç¡®</li></ul><h3 id=deep-dive-1>Deep dive</h3><p>æˆ‘ä»¬ç»“åˆæºç çœ‹ä¸€ä¸‹ transition æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¯ä»¥çœ‹åˆ°æœ¬èº«çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œåœ¨ startTransition å†…éƒ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå…¶åæ‰§è¡Œçš„æ›´æ–°éƒ½ä¼šæ ¹æ®è¯¥å¼€å…³é»˜è®¤å¼€å¯ transition ä¼˜å…ˆçº§ï¼Œè€Œè¿™ä¸ªä¼˜å…ˆçº§è¦æ¯”ä¸€èˆ¬çš„ä¼˜å…ˆçº§æ›´ä½ä¸€äº›ï¼Œå› æ­¤æ‰§è¡Œæ—¶é—´è¦æ¯”æ™®é€šæ›´æ–°æ™šï¼ŒåŒæ—¶å³ä½¿æ›´æ–°å‘ç”Ÿæ—¶ï¼Œä¹Ÿå¯ä»¥è¢«é«˜ä¼˜å…ˆçº§çš„æ›´æ–°æ‰“æ–­ï¼Œä»è€Œä¸é˜»å¡ç”¨æˆ·æ¸²æŸ“ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>startTransition</span><span class=p>(</span><span class=nx>setPending</span><span class=p>,</span> <span class=nx>callback</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>prevTransition</span> <span class=o>=</span> <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Tag We are inside transition
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>callback</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Recovery
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=nx>prevTransition</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Request priority when fiber update
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>requestUpdateLane</span><span class=p>(</span><span class=nx>fiber</span><span class=o>:</span> <span class=nx>Fiber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// requestCurrentTransition =&gt; ReactCurrentBatchConfig.transition
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isTransition</span> <span class=o>=</span> <span class=nx>requestCurrentTransition</span><span class=p>()</span> <span class=o>!==</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTransition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>claimNextTransitionLane</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>useTransition çš„å®ç°æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ useState+startTransitionï¼Œå®ç°å…³é”®ç‚¹åœ¨äºä¸¤æ¬¡ setPendingï¼Œè™½ç„¶æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä½†ä¸¤è€…çš„åŒºåˆ«åœ¨äºç¬¬ä¸€æ¬¡çš„ setPending ä¸ºæ™®é€šä¼˜å…ˆçº§ï¼Œè€Œç¬¬äºŒæ¬¡å› ä¸ºå…¨å±€å¼€å…³æ‰“å¼€ï¼Œä¼šè¢«æˆäºˆ transition ä¼˜å…ˆçº§ï¼Œä¸ callback ä¸­çš„æ›´æ–°è‡ªåŠ¨åˆå¹¶ï¼Œå› æ­¤ pending ä¼šé¦–å…ˆè¢«ç½®æˆ trueï¼Œåœ¨ transition æ›´æ–°å®Œæˆæ—¶ï¼Œé‡ç½®ä¸º falseï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>mountTransition</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>isPending</span><span class=p>,</span> <span class=nx>setPending</span><span class=p>]</span> <span class=o>=</span> <span class=nx>mountState</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>start</span> <span class=o>=</span> <span class=p>(</span><span class=nx>callback</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setPending</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevTransition</span> <span class=o>=</span> <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Tag We are inside transition
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>setPending</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>callback</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Recovery
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=nx>prevTransition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>[</span><span class=nx>isPending</span><span class=p>,</span> <span class=nx>start</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼ŒğŸ¤” ä¸‹é¢è¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å—</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>startTransition</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setValue1</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>setValue2</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>startTransition</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setValue1</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>startTransition</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setValue2</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>ä»æ‰§è¡Œçš„æ•ˆæœçœ‹ï¼Œç”±äºç›®å‰æ‰€æœ‰çš„ transition ä¸­çš„æ›´æ–°ä¼šè¢«æ ‡è®°æˆåŒæ ·çš„ä¼˜å…ˆçº§ï¼ŒåŒæ ·çš„ä¼˜å…ˆçº§æ„å‘³ç€ä¼šåœ¨åŒä¸€æ¬¡è°ƒåº¦ä¸­ä¸€èµ·æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸¤ç§ç”¨æ³•ç›®å‰æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>ä½†æ˜¯ä»åˆç†æ€§çš„è§’åº¦ï¼Œä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ transition åº”è¯¥æ˜¯å¯ä»¥ç‹¬ç«‹å»æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«èµ‹äºˆæ›´ç»†ç²’åº¦çš„ä¼˜å…ˆçº§ï¼Œè¿™ä¹Ÿæ˜¯ transition åç»­æ›´æ–°çš„æ–¹å‘ã€‚è€Œå¦‚ä½•è®¤ä¸ºå®Œå…¨ç‹¬ç«‹ï¼Œå¹¶ä¸æ˜¯ä»…ä»…ä½¿ç”¨äº†ä¸¤ä¸ªå•ç‹¬ startTransitionï¼ŒReact ä¼šä»å†…éƒ¨è‡ªåŠ¨è¿›è¡Œæ£€æµ‹æ›´æ–°çš„çŠ¶æ€æ˜¯å¦æœ‰ä¾èµ–ï¼Œå› ä¸ºå¦‚æœä¸¤ä¸ªæ›´æ–°æœ‰é‡å çš„è¯ï¼Œå®é™…ä¸Šè¿›è¡Œæ‹†åˆ†ä¼šæœ‰æµªè´¹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸‹æ‹‰æ¡†ï¼Œæˆ‘åˆ‡æ¢äº†å¾ˆå¤šæ¬¡ä¹‹åï¼Œä¸­é—´çŠ¶æ€å†å±•ç¤ºå¹¶æ²¡æœ‰æ„ä¹‰äº†ï¼Œåªéœ€è¦æ¸²æŸ“æœ€ç»ˆçŠ¶æ€å°±å¯ä»¥äº†ã€‚</p><h3 id=usedeferredvalue>useDeferredValue</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“æ›´æ–°å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ startTransition æ¥æ ‡è®°ä½ä¼˜å…ˆçš„æ›´æ–°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>startTransition</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;react&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Comp</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>handleChange</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setSliderValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>startTransition</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setGraphValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></div><p>é‚£å¦‚æœæ›´æ–°è§¦å‘çš„å®é™…æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œæ¯”å¦‚ä» parent compnent / other hooks / å¤šä¸ª handler / URL æ”¹å˜ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒReact æä¾›äº†å¦ä¸€ä¸ª hook updateDeferredValue æ¥æ ‡è®°éç´§æ€¥æ›´æ–°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useDeferredValue</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;react&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Comp</span> <span class=o>=</span> <span class=p>(</span><span class=nx>input</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>graphValue</span> <span class=o>=</span> <span class=nx>useDeferredValue</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...updating depends on graphValue
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></div><p>ä¸Šæ–¹ä»£ç çš„å…·ä½“æ•ˆæœæ˜¯å½“ input æ”¹å˜æ—¶ï¼Œè¿”å›çš„ graphValue å¹¶ä¸ä¼šç«‹å³æ”¹å˜ï¼Œä¼šé¦–å…ˆè¿”å›ä¸Šä¸€æ¬¡çš„ input å€¼ï¼Œä¸å­˜åœ¨æ›´ç´§æ€¥çš„æ›´æ–°æ—¶ï¼Œæ‰ä¼šå˜æˆæœ€æ–°çš„ inputï¼Œå› æ­¤å¯ä»¥é€šè¿‡ graphValue æ˜¯å¦æ”¹å˜æ¥è¿›è¡Œä¸€äº›ä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæ‰€ä»¥æ•ˆæœæ˜¯åŸºæœ¬ä¸Šæ˜¯å’Œ transition æ˜¯ä¸€è‡´çš„ã€‚</p><p>è€Œå®ç°ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å°±æ˜¯å°è£…äº† useState + useEffect + startTransitionï¼Œè°ƒåº¦ä¸€ä¸ª Effect å‘èµ·ä¸€ä¸ª startTransition æ¥æ›´æ–°å…·ä½“çš„ value</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>updateDeferredValue</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>prevValue</span><span class=p>,</span> <span class=nx>setValue</span><span class=p>]</span> <span class=o>=</span> <span class=nx>updateState</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>updateEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevTransition</span> <span class=o>=</span> <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>setValue</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ReactCurrentBatchConfig</span><span class=p>.</span><span class=nx>transition</span> <span class=o>=</span> <span class=nx>prevTransition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>value</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>prevValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ä½†æ˜¯ä¸Šé¢çš„å®ç°æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚å½“æ¥å—çš„ value å¹¶éä¸€ä¸ª memorizedValueï¼Œå³æ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ŒstartTransition æ›´æ–°å‘ç”Ÿçš„æ—¶å€™ä¼šå†æ¬¡è§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œåˆä¼šå‘èµ·ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œä»è€Œé€ æˆæ­»å¾ªç¯ã€‚å› æ­¤å‰ä¸ä¹…ï¼Œå¯¹è¿™ä¸ªè¿™ä¸ª hook çš„å®ç°åšäº†ä¸€ç‰ˆæ›´æ–° PRï¼Œæ–°çš„å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>updateDeferredValue</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>shouldDeferValue</span> <span class=o>=</span> <span class=o>!</span><span class=nx>includesOnlyNonUrgentLanes</span><span class=p>(</span><span class=nx>renderLanes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>shouldDeferValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This is an urgent update. If the value has changed, keep using the
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// previous value and spawn a deferred render to update it later.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevValue</span> <span class=o>=</span> <span class=nx>currentHook</span><span class=p>.</span><span class=nx>memoizedState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>prevValue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Mark an Transition Update
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>deferredLane</span> <span class=o>=</span> <span class=nx>claimNextTransitionLane</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>currentlyRenderingFiber</span><span class=p>.</span><span class=nx>lanes</span> <span class=o>=</span> <span class=nx>mergeLanes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>currentlyRenderingFiber</span><span class=p>.</span><span class=nx>lanes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>deferredLane</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>prevValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>hook</span><span class=p>.</span><span class=nx>memoizedState</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æ–°çš„å®ç°ä¸ä¼šä¾èµ– effectï¼Œè€Œæ˜¯æ ¹æ®å½“å‰æ›´æ–°çš„ä¼˜å…ˆçº§æ¥ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç´§æ€¥æ›´æ–°åˆ™ç›´æ¥è¿”å› prevValueï¼Œå¹¶ä¸”åœ¨å½“å‰ fiber ä¸­æ ‡è®°ä¸€ä¸ª transition æ›´æ–°ã€‚å½“éç´§æ€¥æ›´æ–°å‘ç”Ÿæ—¶ï¼Œç›´æ¥è¿”å›æœ€æ–°çš„å€¼ã€‚</p><h1 id=upgrade>Upgrade</h1><h2 id=upgrade-root-api>Upgrade Root API</h2><p>åŒæ—¶è¿˜éœ€è¦å‡çº§ä¸€ä¸‹ root api æ‰èƒ½ä½¿ç”¨æœ€æ–°çš„å¹¶å‘ç‰¹æ€§ã€‚</p><ul><li>Legacy Root API</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ReactDOM</span> <span class=kr>from</span> <span class=s2>&#34;react-dom&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>App</span> <span class=kr>from</span> <span class=s2>&#34;App&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;app&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initial render.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>ReactDOM</span><span class=p>.</span><span class=nx>render</span><span class=p>(&lt;</span><span class=nt>App</span> <span class=p>/&gt;,</span> <span class=nx>container</span><span class=p>);</span>
</span></span></code></pre></div><ul><li>New Root API</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>ReactDOMClient</span> <span class=kr>from</span> <span class=s2>&#34;react-dom/client&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>App</span> <span class=kr>from</span> <span class=s2>&#34;App&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;app&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a root.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>root</span> <span class=o>=</span> <span class=nx>ReactDOMClient</span><span class=p>.</span><span class=nx>createRoot</span><span class=p>(</span><span class=nx>container</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initial render: Render an element to the root.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>root</span><span class=p>.</span><span class=nx>render</span><span class=p>(&lt;</span><span class=nt>App</span> <span class=p>/&gt;);</span>
</span></span></code></pre></div><p>ä¸ºäº†ä»£ç çš„å¹³æ»‘å‡çº§ï¼Œä¸¤ç§æ–¹å¼éƒ½å°†ä¼šä¿ç•™ï¼Œä¸ç„¶æ•ˆæœä¼šæ˜¯ï¼Œå‡çº§å®Œ 18 çš„åŒ…å‘ç°è¿è¡Œç›´æ¥å´©æºƒ= =ï¼Œä½†æ˜¯ä½¿ç”¨æ—§çš„ render æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§ä¸”ä¼šè·å¾— warningï¼Œå¼•å¯¼è¿›è¡Œ root å‡çº§</p><p>æ–°æ—§ RootAPI è¿˜æœ‰ä¸€ç‚¹æ”¹åŠ¨æ˜¯ï¼ŒåŸå…ˆ render ä¼šåŒ…å«ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå›è°ƒï¼Œæ–°çš„ api ç§»é™¤äº†</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>ReactDOM</span> <span class=kr>from</span> <span class=s1>&#39;react-dom&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>App</span> <span class=kr>from</span> <span class=s1>&#39;App&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ReactDOM</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=nx>container</span><span class=p>,</span> <span class=p>&lt;</span><span class=nt>App</span> <span class=na>tab</span><span class=o>=</span><span class=s>&#34;home&#34;</span> <span class=p>/&gt;,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Called after inital render or any update.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;rendered&#39;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>ä½†æ˜¯å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¥ä»£æ›¿ï¼Œæ¯”å¦‚ï¼š</p><ul><li>é€šè¿‡ ref</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=nx>as</span> <span class=nx>ReactDOMClient</span> <span class=nx>from</span> <span class=s2>&#34;react-dom/client&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>App</span><span class=p>({</span> <span class=nx>callback</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Callback will be called when the div is first created.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>ref</span><span class=o>=</span><span class=p>{</span><span class=nx>callback</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>h1</span><span class=o>&gt;</span><span class=nx>Hello</span> <span class=nx>World</span><span class=o>&lt;</span><span class=err>/h1&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>rootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;root&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>root</span> <span class=o>=</span> <span class=nx>ReactDOMClient</span><span class=p>.</span><span class=nx>createRoot</span><span class=p>(</span><span class=nx>rootElement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>root</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>App</span> <span class=nx>callback</span><span class=o>=</span><span class=p>{()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;renderered&#34;</span><span class=p>)}</span> <span class=o>/&gt;</span><span class=p>);</span>
</span></span></code></pre></div><ul><li>é€šè¿‡ useEffect</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useEffect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;react&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=nx>as</span> <span class=nx>ReactDOMClient</span> <span class=nx>from</span> <span class=s2>&#34;react-dom/client&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>App</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Callback will be called when the div is first created.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;renderered&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>h1</span><span class=o>&gt;</span><span class=nx>Hello</span> <span class=nx>World</span><span class=o>&lt;</span><span class=err>/h1&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>rootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;root&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>root</span> <span class=o>=</span> <span class=nx>ReactDOMClient</span><span class=p>.</span><span class=nx>createRoot</span><span class=p>(</span><span class=nx>rootElement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>root</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>App</span> <span class=o>/&gt;</span><span class=p>);</span>
</span></span></code></pre></div><p>ä¸¤è€…çš„åŒºåˆ«åœ¨äº</p><ul><li>Ref ä¼šåœ¨åº”ç”¨æ·»åŠ åˆ° dom ä¹‹ååŒæ­¥çš„æ‰§è¡Œ</li><li>Effects ç”±äºæœ¬èº«çš„å®ç°æ˜¯å¼‚æ­¥çš„ï¼Œä¼šæœ‰ä¸€ä¸ªå°çš„å»¶è¿Ÿ</li></ul><p>ä½¿ç”¨å“ªç§æ–¹å¼å–å†³äºä½ å…·ä½“çš„ä¸šåŠ¡åœºæ™¯</p><h2 id=fix-tearing--usesyncexternalstore>Fix Tearing & useSyncExternalStore</h2><p>ç»å¤§å¤šæ•°ç±»åº“ä¸éœ€è¦åšä»»ä½•æ”¹åŠ¨å°±èƒ½å¤Ÿå…¼å®¹ React 18ï¼Œç„¶è€Œç”±äºå¹¶å‘æ¸²æŸ“çš„åŸå› ä½¿ç”¨éƒ¨åˆ†ç±»åº“ä¼šå¼•å‘ tearing çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œä¸€äº›å‡çº§æ‰èƒ½å…¼å®¹ã€‚</p><blockquote><p>Screen tearing is a visual artifact in video display where a display device shows information from multiple frames in a single screen draw - wiki</p></blockquote><p>ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨å±å¹•ä¸Šçœ‹åˆ°äº†åŒä¸€ä¸ªç‰©ä½“çš„ä¸åŒå¸§çš„å½±åƒï¼Œç”»é¢ä»¿ä½›æ˜¯â€œæ’•è£‚çš„â€ï¼Œå¯¹åº”çš„ react ä¸­ï¼ŒæŒ‡ä½¿ç”¨äº†è¿‡å»ç‰ˆæœ¬çš„çŠ¶æ€è¿›è¡Œç”»é¢æ¸²æŸ“å¼•èµ·çš„ UI ä¸ä¸€è‡´æˆ–è€…å´©æºƒã€‚ç”±äº JS æ˜¯å•çº¿ç¨‹çš„ï¼Œå…¶å® web å¼€å‘ä¸­ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥å¹¶å‘æ¸²æŸ“åï¼Œæ¸²æŸ“æ˜¯å¯èƒ½è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¸­æ–­ï¼Œè¿™ä¹Ÿä½¿å¾— tearing æˆä¸ºå¯èƒ½ã€‚ ä½† React æœ¬èº«å¯¹äº state çš„æ›´æ–°åšäº†å¾ˆå¤šçš„å·¥ä½œæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„ä¾èµ–äº†å¤–éƒ¨çš„çŠ¶æ€ï¼ŒReact å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸ºå®ƒå¹¶ä¸çŸ¥é“ä½ ä»€ä¹ˆæ—¶å€™æ›´æ–°äº†å¤–éƒ¨çš„çŠ¶æ€ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><ul><li>åŒæ­¥æ¸²æŸ“</li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/item/20230503153747.png alt=åŒæ­¥æ¸²æŸ“ loading=lazy data-zoomable></div></div></figure></p><ul><li>å¹¶å‘æ¸²æŸ“</li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/item/20230503153823.png alt=å¹¶å‘æ¸²æŸ“ loading=lazy data-zoomable></div></div></figure></p><p>è¿™é‡Œ externalStore å°±æ˜¯æˆ‘ä»¬ä¾èµ–çš„ä¸€äº›å¤–éƒ¨çŠ¶æ€ï¼Œæ¯”å¦‚å¸¸è§çš„ reduxï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä½¿ç”¨ react-redux 7 çš„ä¾‹å­ï¼Œå¯ä»¥ç›´è§‚çš„æ„Ÿå—åˆ° tearing çš„å­˜åœ¨ã€‚å› æ­¤ 18 ä¸­ä¸“é—¨é’ˆå¯¹è¿™éƒ¨åˆ†ç±»åº“æä¾›ç›¸å…³çš„ API - useSyncExternalStoreï¼Œæ¯”å¦‚ react-redux 8.0.0 å®é™…ä¸Šå°±å·²ç»é›†æˆè¿›å»äº†ï¼Œå¤§å®¶å¯ä»¥æŠŠä¸Šé¢ demo ä¸­çš„ä¾èµ–æ”¹æˆè¿™ä¸ªç‰ˆæœ¬å†è¯•ä¸€ä¸‹ã€‚</p><p>å…·ä½“ç”¨æ³•çš„è¯ï¼Œè¿™è¾¹ç›´æ¥åšäº†ä¸€ä¸ª demoï¼Œä¸ºäº†ä½“ç°å…·ä½“çš„æ”¹åŠ¨ï¼Œå®ç°äº†ä¸€ä¸ª redux-likeï¼Œé‡ç‚¹å…³æ³¨ä¸¤ä¸ª useSelectorï¼Œçœ‹ä¸€ä¸‹<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fusesyncexternalstore-demo-671587" target=_blank rel=noopener>ä½¿ç”¨ä¸¤ä¸ªä¸åŒ selector çš„æ•ˆæœ</a>ã€‚</p><p>ç›¸ä¿¡å¤§å®¶åº”è¯¥å¯ä»¥æ„Ÿå—åˆ°åŒºåˆ«ï¼Œä¸è¿‡æˆ‘ä»¬çœ‹åˆ°è™½ç„¶ä½¿ç”¨äº† useSyncExternalStore é€šè¿‡æ¥å…¥ useSyncExternalStore å¯ä»¥è¾¾åˆ° ã€Œâœ… Make it rightã€çš„æ•ˆæœï¼Œä½†æ˜¯ä¹Ÿèƒ½æ„Ÿå—åˆ°è¦æ¯”æ²¡æœ‰ä½¿ç”¨ä¹‹å‰æ›´å¡äº†ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°ã€ŒğŸš€ Make it fastã€çš„æ•ˆæœï¼Œå…¶å®åŸå› è·Ÿè¿™ä¸ªæ–¹æ³•æœ¬èº«çš„å®ç°æœ‰å…³ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>updateSyncExternalStore</span><span class=o>&lt;</span><span class=nx>T</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>subscribe</span><span class=o>:</span> <span class=p>(()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>getSnapshot</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>T</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>getServerSnapshot</span><span class=o>?:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>T</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>nextSnapshot</span> <span class=o>=</span> <span class=nx>getSnapshot</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>prevSnapshot</span> <span class=o>=</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>memoizedState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>snapshotChanged</span> <span class=o>=</span> <span class=o>!</span><span class=nx>is</span><span class=p>(</span><span class=nx>prevSnapshot</span><span class=p>,</span> <span class=nx>nextSnapshot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// storeå†…å€¼æ›´æ–°æ—¶ï¼Œè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>updateEffect</span><span class=p>(</span><span class=nx>subscribeToStore</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>fiber</span><span class=p>,</span> <span class=nx>inst</span><span class=p>,</span> <span class=nx>subscribe</span><span class=p>),</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>subscribe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// commitç¯å¢ƒå¼€å§‹ä¹‹å‰ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>inst</span><span class=p>.</span><span class=nx>getSnapshot</span> <span class=o>!==</span> <span class=nx>getSnapshot</span> <span class=o>||</span> <span class=nx>snapshotChanged</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pushEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>HookHasEffect</span> <span class=o>|</span> <span class=nx>HookPassive</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>updateStoreInstance</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>fiber</span><span class=p>,</span> <span class=nx>inst</span><span class=p>,</span> <span class=nx>nextSnapshot</span><span class=p>,</span> <span class=nx>getSnapshot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// renderç¯èŠ‚ç»“æŸæ—¶ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>includesBlockingLane</span><span class=p>(</span><span class=nx>root</span><span class=p>,</span> <span class=nx>renderLanes</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pushStoreConsistencyCheck</span><span class=p>(</span><span class=nx>fiber</span><span class=p>,</span> <span class=nx>getSnapshot</span><span class=p>,</span> <span class=nx>nextSnapshot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// ä¸€è‡´æ€§æ£€æŸ¥æ–¹æ³•å†…
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>checkIfSnapshotChanged</span><span class=p>(</span><span class=nx>inst</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Force a sync re-render.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>scheduleUpdateOnFiber</span><span class=p>(</span><span class=nx>fiber</span><span class=p>,</span> <span class=nx>SyncLane</span><span class=p>,</span> <span class=nx>NoTimestamp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ç°çš„æ ¸å¿ƒæ˜¯åŠ äº†ä¸‰é‡ä¿éšœæ¥è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œå½“å‡ºç°ä¸ä¸€è‡´æ—¶å°±å‘èµ·ä¸€ä¸ªåŒæ­¥æ›´æ–°çš„è°ƒåº¦ï¼Œå› æ­¤ transition çš„æ•ˆæœå°±å¤±çµäº†ï¼Œæ‰€ä»¥ä¼šé˜»å¡é¡µé¢äº¤äº’å‡ºç°äº†å¡é¡¿ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ React å›¢é˜Ÿè¿˜åœ¨ç ”ç©¶å’Œæ¢ç´¢ï¼Œä»ç„¶è¿˜æœ‰ä¸€æ®µè·¯è¦èµ°ã€‚</p><p>å¦å¤–å¯¹äºç±»åº“å¼€å‘è€…æ¥è¯´ï¼Œåœ¨ç¤¾åŒºå¹¶å‘ç‰¹æ€§å…¨é¢é“ºå¼€å‰ï¼Œä¸é¼“åŠ±åœ¨ç±»åº“ä¸­ä½¿ç”¨ Concurrent Featuresï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ä¾èµ–æˆ‘ä»¬ç±»åº“çš„ä¸Šå±‚åº”ç”¨é»˜è®¤å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œè€Œè¿™å¯èƒ½ä¸æ˜¯ä»–ä»¬æ‰€æœŸæœ›çš„ã€‚</p></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>æœ€è¿‘æ›´æ–°äº 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>Â© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"å·²å¤åˆ¶")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>