<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="并发的优化 避免共享的可变状态 避免共享状态理想的情况是构造无状态的程序，没有状态自然也就不会共享。一个典型的例子就是 Servlet 程序，各 Servlet 自身并不持有状态，彼此隔离，互不相扰。如果持有状态不可避免，则可以使用线程"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96/%E5%B9%B6%E5%8F%91%E7%9A%84%E4%BC%98%E5%8C%96/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96/%E5%B9%B6%E5%8F%91%E7%9A%84%E4%BC%98%E5%8C%96/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96/%E5%B9%B6%E5%8F%91%E7%9A%84%E4%BC%98%E5%8C%96/"><meta property="og:title" content="并发的优化 | Next-gen Tech Edu"><meta property="og:description" content="并发的优化 避免共享的可变状态 避免共享状态理想的情况是构造无状态的程序，没有状态自然也就不会共享。一个典型的例子就是 Servlet 程序，各 Servlet 自身并不持有状态，彼此隔离，互不相扰。如果持有状态不可避免，则可以使用线程"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>并发的优化 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=d094f02483a93b324f792cf23d69d53c><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">并发优化</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id750cddf5218997b403346b2f661b5b48")' href=#id750cddf5218997b403346b2f661b5b48 aria-expanded=false aria-controls=id750cddf5218997b403346b2f661b5b48 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/>线程安全</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id750cddf5218997b403346b2f661b5b48 aria-expanded=false aria-controls=id750cddf5218997b403346b2f661b5b48><i class="fa-solid fa-angle-down" id=caret-id750cddf5218997b403346b2f661b5b48></i></a></div><ul class="nav docs-sidenav collapse show" id=id750cddf5218997b403346b2f661b5b48><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide3e494cdb7389c821e6f65e2b60c2bb2")' href=#ide3e494cdb7389c821e6f65e2b60c2bb2 aria-expanded=false aria-controls=ide3e494cdb7389c821e6f65e2b60c2bb2 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id439d7ad4206f47a1d95e6975fe147769")' href=#id439d7ad4206f47a1d95e6975fe147769 aria-expanded=false aria-controls=id439d7ad4206f47a1d95e6975fe147769 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96/>并发优化</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id439d7ad4206f47a1d95e6975fe147769 aria-expanded=false aria-controls=id439d7ad4206f47a1d95e6975fe147769><i class="fa-solid fa-angle-down" id=caret-id439d7ad4206f47a1d95e6975fe147769></i></a></div><ul class="nav docs-sidenav collapse show" id=id439d7ad4206f47a1d95e6975fe147769><li class="child level active"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96/%E5%B9%B6%E5%8F%91%E7%9A%84%E4%BC%98%E5%8C%96/>并发的优化</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id76c20db6adb675c155be353d9e251fe4")' href=#id76c20db6adb675c155be353d9e251fe4 aria-expanded=false aria-controls=id76c20db6adb675c155be353d9e251fe4 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/>锁</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id76c20db6adb675c155be353d9e251fe4 aria-expanded=false aria-controls=id76c20db6adb675c155be353d9e251fe4><i class="fa-solid fa-angle-right" id=caret-id76c20db6adb675c155be353d9e251fe4></i></a></div><ul class="nav docs-sidenav collapse" id=id76c20db6adb675c155be353d9e251fe4><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd576e4a40031a59e8365597d5ff9366a")' href=#idd576e4a40031a59e8365597d5ff9366a aria-expanded=false aria-controls=idd576e4a40031a59e8365597d5ff9366a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idd576e4a40031a59e8365597d5ff9366a aria-expanded=false aria-controls=idd576e4a40031a59e8365597d5ff9366a><i class="fa-solid fa-angle-right" id=caret-idd576e4a40031a59e8365597d5ff9366a></i></a></div><ul class="nav docs-sidenav collapse" id=idd576e4a40031a59e8365597d5ff9366a><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2021-an-introduction-to-lockless-algorithms/>2021-An introduction to lockless algorithms</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ida380e6bb70ede64c41d7407a972641ba")' href=#ida380e6bb70ede64c41d7407a972641ba aria-expanded=false aria-controls=ida380e6bb70ede64c41d7407a972641ba aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ida8df9beb197d6c8cb1c21390dae03b3d")' href=#ida8df9beb197d6c8cb1c21390dae03b3d aria-expanded=false aria-controls=ida8df9beb197d6c8cb1c21390dae03b3d aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E4%BA%92%E6%96%A5%E9%94%81/>互斥锁</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ida8df9beb197d6c8cb1c21390dae03b3d aria-expanded=false aria-controls=ida8df9beb197d6c8cb1c21390dae03b3d><i class="fa-solid fa-angle-right" id=caret-ida8df9beb197d6c8cb1c21390dae03b3d></i></a></div><ul class="nav docs-sidenav collapse" id=ida8df9beb197d6c8cb1c21390dae03b3d><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E4%BA%92%E6%96%A5%E9%94%81/%E8%AF%BB%E5%86%99%E9%94%81/>读写锁</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E4%BA%92%E6%96%A5%E9%94%81/%E4%BA%92%E6%96%A5%E9%94%81/>互斥锁</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E4%BA%92%E6%96%A5%E9%94%81/%E9%94%81%E4%BC%98%E5%8C%96/>锁优化</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id9591f39accb676042eff439bddc57c6c")' href=#id9591f39accb676042eff439bddc57c6c aria-expanded=false aria-controls=id9591f39accb676042eff439bddc57c6c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81%E6%B4%BB%E9%94%81%E4%B8%8E%E9%A5%A5%E9%A5%BF/>死锁，活锁与饥饿</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id9591f39accb676042eff439bddc57c6c aria-expanded=false aria-controls=id9591f39accb676042eff439bddc57c6c><i class="fa-solid fa-angle-right" id=caret-id9591f39accb676042eff439bddc57c6c></i></a></div><ul class="nav docs-sidenav collapse" id=id9591f39accb676042eff439bddc57c6c><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81%E6%B4%BB%E9%94%81%E4%B8%8E%E9%A5%A5%E9%A5%BF/%E6%B4%BB%E9%94%81/>活锁</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81%E6%B4%BB%E9%94%81%E4%B8%8E%E9%A5%A5%E9%A5%BF/%E9%A5%A5%E9%A5%BF/>饥饿</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E9%94%81/%E6%AD%BB%E9%94%81%E6%B4%BB%E9%94%81%E4%B8%8E%E9%A5%A5%E9%A5%BF/%E6%AD%BB%E9%94%81/>死锁</a></li></ul></div></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ideb608728fe8eb65811d3f18e004f44a0")' href=#ideb608728fe8eb65811d3f18e004f44a0 aria-expanded=false aria-controls=ideb608728fe8eb65811d3f18e004f44a0 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/>同步器</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ideb608728fe8eb65811d3f18e004f44a0 aria-expanded=false aria-controls=ideb608728fe8eb65811d3f18e004f44a0><i class="fa-solid fa-angle-right" id=caret-ideb608728fe8eb65811d3f18e004f44a0></i></a></div><ul class="nav docs-sidenav collapse" id=ideb608728fe8eb65811d3f18e004f44a0><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/semaphore/>Semaphore</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/tencentos-%E4%B8%AD%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/>TencentOS 中信号量的实现</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/>进程间通信</a></li><li class="child level"><a href=/books/concurrent-notes/01.%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/%E5%90%8C%E6%AD%A5%E5%99%A8/%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5/>线程同步</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#栈封闭>栈封闭</a></li><li><a href=#线程局部变量>线程局部变量</a></li><li><a href=#避免可变状态>避免可变状态</a></li></ul><ul><li><a href=#减小锁的持有时间>减小锁的持有时间</a></li><li><a href=#锁粒度的优化>锁粒度的优化</a></li><li><a href=#锁分离>锁分离</a><ul><li><a href=#读写分离锁替代独占锁>读写分离锁替代独占锁</a></li><li><a href=#重入锁和内部锁>重入锁和内部锁</a></li><li><a href=#自旋锁>自旋锁</a></li></ul></li><li><a href=#无锁>无锁</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>并发的优化</h1><div class=article-style><h1 id=并发的优化>并发的优化</h1><h1 id=避免共享的可变状态>避免共享的可变状态</h1><p>避免共享状态理想的情况是构造无状态的程序，没有状态自然也就不会共享。一个典型的例子就是 Servlet 程序，各 Servlet 自身并不持有状态，彼此隔离，互不相扰。如果持有状态不可避免，则可以使用线程封闭技术，将状态&rsquo;隐藏起来，不让别的线程访问到。常见的有栈封闭和 ThreadLocal 类两种形式。</p><h2 id=栈封闭>栈封闭</h2><p>栈封闭是线程封闭的一种特例，在栈封闭中，只能通过局部变量访问对象，这些局部变量被封闭在执行线程的栈内部，其它线程无法访问到它们。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>int</span> <span class=nf>loadTheArk</span><span class=o>(</span><span class=n>Collection</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;</span> <span class=n>candidates</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SortedSet</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;</span> <span class=n>animals</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>numPairs</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Animal</span> <span class=n>candidate</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// animals confined to method, don&#39;t let them escape!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>animals</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TreeSet</span><span class=o>&lt;</span><span class=n>Animal</span><span class=o>&gt;(</span><span class=k>new</span> <span class=n>SpeciesGenderComparator</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>animals</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>candidates</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Animal</span> <span class=n>a</span> <span class=o>:</span> <span class=n>animals</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>numPairs</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在上面的代码中，animals 和 candidate 是函数的局部变量，被封闭在栈帧内部，不会逸出，被其它线程访问到，所以该方法是线程安全的。</p><h2 id=线程局部变量>线程局部变量</h2><p>ThreadLocal 类能使线程中的某个值与保存值的对象关联起来，在单个线程内部共享这个变量，而其它线程无法访问。一个典型的示例是数据库连接会话，将连接会话存储为 ThreadLocal 对象，线程内部共享同一个连接会话，不同线程之间的连接会话互不影响。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;</span> <span class=n>connectionHolder</span>
</span></span><span class=line><span class=cl>        <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=n>Connection</span> <span class=nf>initialValue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>DB_URL</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>Connection</span> <span class=nf>getConnection</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>connectionHolder</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=避免可变状态>避免可变状态</h2><p>线程安全性是不可变对象的固有属性，对于不可变对象，所有线程看到状态必然是一致的。纯函数式编程语言中，没有变量，只有常量，状态不能被持有，只能通过函数参数来传递，所以是天然的线程安全。Java 没有这样得天独厚的基因，不可变类型需要自己实现，具体的实现方式可以参考《Effective Java》 &ldquo;最小化可变性"这一节，概括来讲需要遵循以下 5 条原则:</p><ul><li>不要提供修改对象状态的方法</li><li>确保这个类不能被继承</li><li>把所有属性设置为 final</li><li>把所有的属性设置为 private</li><li>禁止访问类内部的可变域</li></ul><p>Guava 库也提供了一组不可变类，比如 ImmutabelList、ImmutableSet 这些，我们应该在代码中尽可能地使用它们。</p><h1 id=锁优化>锁优化</h1><p>锁是在高并发的环境下为了保证数据的正确性而产生的同步手段，为了进一步提升性能，我们就需要对锁进行优化。锁的优化思路有：从减小锁的持有时间、锁的粒度的优化、锁分离、锁消除、无锁等等。</p><h2 id=减小锁的持有时间>减小锁的持有时间</h2><p>减小锁的持有时间是为了降低锁的冲突的可能性，提高体系的并发能力。</p><ul><li>只在必要时进行同步加锁操作</li></ul><p>例如下的代码：在加锁时先判断是否满足同步代码逻辑的要求，以达到减小锁的占有几率的目的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 使用条件判断减少锁持有时间提高效率。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kt>void</span> <span class=nf>matcher</span><span class=o>(</span><span class=n>Char</span> <span class=n>input</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>compiled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>compiled</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>compile</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li>只在必须加锁的代码段加锁</li></ul><p>下面的代码的执行只针对必须要加锁的代码段进行加锁操作，减少锁的占有的时间。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>syncMethod</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>method1</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>method2</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>method3</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>syncMethod</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>method1</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>method2</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=n>method3</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=锁粒度的优化>锁粒度的优化</h2><p>优化锁的粒度是根据实际的代码逻辑来进行判断，分为锁粒度的细化和锁粒度的粗化 2 种优化方式。</p><ul><li>锁粒度的细化</li></ul><p>举个简单的例子，JDK 自带的工具类 ConcurrentHashMap 就是一个典型的实现场景，它对锁的拆分方式提高了大大提高了它的吞吐量，ConcurrentHashMap 将自身分成若干个段，每一段都是一个子 HashMap。当需要新增一个的时候，并不是对整个对象进行加锁，而是先根据 hashcode 计算该数据应该被加入到哪个段中，然后对该段加锁，默认情况下 ConcurrentHashMap 有 16 个段，因此运气足够好的时候可以接受 16 个线程同时插入，大大提高了吞吐量。</p><p>但是减小锁的粒度也带来了新的问题，当锁粒度过于小的时候，获取全局锁消耗的资源也相应增加，以 ConcurrentHashMap 为例，如果它需要获取当前的 size 就需要对每一个段都加锁。</p><ul><li>锁粒度的粗化</li></ul><p>在一般情况下，为了保证多线程之间的高效并发，会要求线程持有锁的时间尽量短，但是过度的细化会产生大量的申请和释放锁的操作，这对性能的影响也是非常大的。如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>synchronized</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>todo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=kd>synchronized</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>todo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=锁分离>锁分离</h2><p>根据实际的操作来选择加上不同的锁也是提升性能的重要方式之一。</p><h3 id=读写分离锁替代独占锁>读写分离锁替代独占锁</h3><p>ReadWriteLock 使用读写分离锁来替代独占锁，它也是减小锁的粒度的一种方式，上面讲的是对数据结构层面的减小锁持有时间的，这里是根据业务来划分锁的持有，在读多写少的场景使用读写分离锁会大大提高系统的并发性能。</p><h3 id=重入锁和内部锁>重入锁和内部锁</h3><p>重入锁的使用相较于内部锁更加复杂，重入锁必须手动显示释放锁，内部锁则可以自动释放，重入锁提供了一套提高性能的功能和 Condition 机制，重入锁可以设置锁的等待时间 boolean tryLock(long time)，锁中断 lockInterruptibly() 和快速锁轮询 tryLock() 等可以有效的避免死锁的产生。内部锁则是通过 wait() 和 notfiy() 实现锁的控制。</p><h3 id=自旋锁>自旋锁</h3><p>自旋锁是 JVM 为了解决对多线程并发时频繁的挂起和恢复线程的操作问题的锁，当访问共享资源的时候，锁的等待时间可能很短，可能会比线程的挂起和恢复时间还要短，因此在这段时间里做线程的切换时不值得的。自旋锁可以使线程没有取得锁时不被挂起，而去执行一个空的循环，当线程获取了锁就会继续执行代码。</p><p>但是自旋锁只适用于线程竞争相对小、锁占用时间短的代码，对于锁竞争激烈的系统中不仅浪费了 CPU 资源，也免不了被挂起。JVM 可以设置自旋锁的开启和等待次数，防止一直执行空循环。</p><h2 id=无锁>无锁</h2><p>锁是一种对操作的同步手段，但是也不是唯一的手段，例如使用空间换时间的思路同样可以解决问题，非阻塞的同步方式也可以达到并发的目的。最简单的一种非阻塞的同步就是 ThreadLocal 了，每个线程有各自独立的 ThreadLocalMap，在并行计算时无需相互等待。另一种更为乐观的方式是使用 CAS 算法，它有 3 个参数（V，E，N），它总是认为自己的操作可以成功，因此只有在 V 的值等于 E 时，把 V 的值设置成 N；当 V 的值不等于 E，就返回 V 的当前值，然后什么也不做，当多个线程同时使用 CAS 时，只有一个线程会执行成功。</p><p>在 java.util.concurrent.atomic 包中有很多支持原子操作的类，都是基于无锁算法实现的，它的性能远远超过普通的有锁操作，例如使用 CAS 算法实现原子操作中的 getAndSet() 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>getAndSet</span><span class=o>(</span><span class=kt>int</span> <span class=n>newValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>                                       <span class=c1>// 不停循环直到成功
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>current</span> <span class=o>=</span> <span class=n>get</span><span class=o>();</span>                         <span class=c1>// 获取当前的值
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSet</span><span class=o>(</span><span class=n>current</span><span class=o>,</span> <span class=n>newValue</span><span class=o>))</span> <span class=o>{</span>      <span class=c1>// 若当前的值未受其他线程影响，则设置为新值
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>current</span><span class=o>;</span>                          <span class=c1>// 返回新值
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>以时间换空间、以空间换时间都是实现代码的常用思路，在不同的地方应该使用不同的方式去达到业务需求。</p></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>