<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>_index | Next-gen Tech Edu</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/</link><atom:link href="https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/index.xml" rel="self" type="application/rss+xml"/><description>_index</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><image><url>https://ng-tech.icu/media/sharing.png</url><title>_index</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/</link></image><item><title>advance-developer</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/advance-developer/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/advance-developer/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 112
title: 高级开发指南
date: &amp;ldquo;2022-05-21T00:00:00+08:00&amp;rdquo;
type: book&lt;/h2>
&lt;p>本页假定您已经熟悉 Kubernetes 的核心概念并可以轻松的部署自己的应用程序。在浏览了本页面及其链接的内容后，您将会更好的理解如下部分：&lt;/p>
&lt;ul>
&lt;li>可以在应用程序中使用的高级功能&lt;/li>
&lt;li>扩展 Kubernetes API 的各种方法&lt;/li>
&lt;/ul>
&lt;h2 id="使用高级功能部署应用">使用高级功能部署应用&lt;/h2>
&lt;p>现在您知道了 Kubernetes 中提供的一组 API 对象。理解了 daemonset 和 deployment 之间的区别对于应用程序部署通常是足够的。也就是说，熟悉 Kubernetes 中其它的鲜为人知的功能也是值得的。因为这些功能有时候对于特别的用例是非常强大的。&lt;/p>
&lt;h4 id="容器级功能">容器级功能&lt;/h4>
&lt;p>如您所知，将整个应用程序（例如容器化的 Rails 应用程序，MySQL 数据库以及所有应用程序）迁移到单个 Pod 中是一种反模式。这就是说，有一些非常有用的模式超出了容器和 Pod 之间的 1:1 的对应关系：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Sidecar 容器&lt;/strong>：虽然 Pod 中依然需要有一个主容器，你还可以添加一个副容器作为辅助（见 &lt;a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/#using-a-sidecar-container-with-the-logging-agent" target="_blank" rel="noopener">日志示例&lt;/a>)。单个 Pod 中的两个容器可以&lt;a href="https://kubernetes.io/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/" target="_blank" rel="noopener">通过共享卷&lt;/a>进行通信。&lt;/li>
&lt;li>&lt;strong>Init 容器&lt;/strong>：Init 容器在 Pod 的应用容器（如主容器和 sidecar 容器）之前运行。&lt;/li>
&lt;/ul>
&lt;h4 id="pod-配置">Pod 配置&lt;/h4>
&lt;p>通常，您可以使用 label 和 annotation 将元数据附加到资源上。将数据注入到资源，您可以会创建 ConfigMap（用于非机密数据）或 Secret（用于机密数据）。&lt;/p>
&lt;p>下面是一些其他不太为人所知的配置资源 Pod 的方法：&lt;/p>
&lt;ul>
&lt;li>Taint（污点）和 Toleration（容忍）：这些为节点“吸引”或“排斥” Pod 提供了一种方法。当需要将应用程序部署到特定硬件（例如用于科学计算的 GPU）时，经常使用它们。&lt;a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener">阅读更多&lt;/a>。&lt;/li>
&lt;li>&lt;strong>向下 API&lt;/strong>：这允许您的容器使用有关自己或集群的信息，而不会过度耦合到 Kubernetes API server。这可以通过&lt;a href="https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/" target="_blank" rel="noopener">环境变量&lt;/a> 或者 &lt;a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/" target="_blank" rel="noopener">DownwardAPIVolumeFiles&lt;/a>。&lt;/li>
&lt;li>&lt;strong>Pod 预设&lt;/strong>：通常，要将运行时需求（例如环境变量、ConfigMap 和 Secret）安装到资源中，可以在资源的配置文件中指定它们。PodPresets 允许您在创建资源时动态注入这些需求。例如，这允许团队 A 将任意数量的新 Secret 安装到团队 B 和 C 创建的资源中，而不需要 B 和 C 的操作。&lt;/li>
&lt;/ul>
&lt;h4 id="其他-api-对象">其他 API 对象&lt;/h4>
&lt;p>在设置以下资源之前，请检查这是否属于您组织的集群管理员的责任。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Horizontal Pod Autoscaler (HPA)&lt;/strong> ：这些资源是在 CPU 使用率或其他&lt;a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/custom-metrics-api.md" target="_blank" rel="noopener">自定义度量&lt;/a>标准“秒杀”时自动化扩展应用程序的好方法。*&lt;a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">查看示例&lt;/a>*以了解如何设置 HPA。&lt;/li>
&lt;li>&lt;strong>联合集群对象&lt;/strong>：如果使用 &lt;em>federation&lt;/em> 在多个 Kubernetes 集群上运行应用程序，则需要部署标准 Kubernetes API 对象的联合版本。&lt;/li>
&lt;/ul>
&lt;h2 id="扩展-kubernetes-api">扩展 Kubernetes API&lt;/h2>
&lt;p>Kubernetes 在设计之初就考虑到了可扩展性。如果上面提到的 API 资源和功能不足以满足您的需求，则可以自定义其行为，而无需修改核心 Kubernetes 代码。&lt;/p>
&lt;h4 id="理解-kubernetes-的默认行为">理解 Kubernetes 的默认行为&lt;/h4>
&lt;p>在进行任何自定义之前，了解 Kubernetes API 对象背后的一般抽象很重要。虽然 Deployment 和 Secret 看起来可能完全不同，但对于&lt;em>任何&lt;/em>对象来说，以下概念都是正确的：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Kubernetes 对象是存储有关您的集群的结构化数据的一种方式。&lt;/strong>&lt;/p>
&lt;p>在 Deployment 的情况下，该数据代表期望的状态（例如“应该运行多少副本？”），但也可以是通用的元数据（例如数据库凭证）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Kubernetes 对象通过 Kubernetes API&lt;/strong> 修改。&lt;/p>
&lt;p>换句话说，您可以对特定的资源路径（例如 &lt;code>&amp;lt;api-server-url&amp;gt;/api/v1/namespaces/default/deployments&lt;/code> ）执行 &lt;code>GET&lt;/code> 和 &lt;code>POST&lt;/code> 请求来读取或修改对应的对象类型。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>利用 &lt;a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#custom-controllers" target="_blank" rel="noopener">Controller 模式&lt;/a>，Kubernetes 对象可被确保达到期望的状态&lt;/strong>。为了简单起见，您可以将 Controller 模式看作以下连续循环：&lt;/p>
&lt;ol>
&lt;li>检查当前状态（副本数、容器镜像等）&lt;/li>
&lt;li>对比当前状态和期望状态&lt;/li>
&lt;li>如果不匹配则更新当前状态&lt;/li>
&lt;/ol>
&lt;p>这些状态是通过 Kubernetes API 来获取的。&lt;/p>
&lt;p>并非所有的 Kubernetes 对象都需要一个 Controller。尽管 Deployment 触发集群进行状态更改，但 ConfigMaps 纯粹作为存储。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="创建自定义资源">创建自定义资源&lt;/h4>
&lt;p>基于上述想法，您可以定义与 Deployment 一样合法的&lt;a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#custom-resources" target="_blank" rel="noopener">自定义资源&lt;/a>。例如，如果 &lt;code>CronJobs&lt;/code> 不能提供所有您需要的功能，您可能需要定义 &lt;code>Backup&lt;/code> 对象以进行定期备份。&lt;/p>
&lt;p>创建自定义资源有以下两种方式：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>自定义资源定义（CRD）&lt;/strong>：这种实现方式的工作量最小。参考&lt;a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/" target="_blank" rel="noopener">示例&lt;/a>。&lt;/li>
&lt;li>&lt;strong>API 聚合&lt;/strong>：在实际设置单独的&lt;a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/" target="_blank" rel="noopener">扩展 API server&lt;/a> 之前，此方法需要一些&lt;a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer/" target="_blank" rel="noopener">预配置&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>请注意，与依赖内置的 &lt;a href="https://kubernetes.io/docs/reference/generated/kube-controller-manager/" target="_blank" rel="noopener">&lt;code>kube-controller-manager&lt;/code>&lt;/a> 不同，您需要编写并运行&lt;a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">自定义控制器&lt;/a>。&lt;/p>
&lt;p>下面是一些有用的链接：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#should-i-use-a-configmap-or-a-custom-resource" target="_blank" rel="noopener">如何才知道自定义资源是否符合您的使用场景&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/#choosing-a-method-for-adding-custom-resources" target="_blank" rel="noopener">CRD 还是 API 聚合，如何选择？&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="service-catalog">Service Catalog&lt;/h4>
&lt;p>如果您想要使用或提供完整的服务（而不是单个资源），&lt;strong>Service Catalog&lt;/strong> 为此提供了一个&lt;a href="https://github.com/openservicebrokerapi/servicebroker" target="_blank" rel="noopener">规范&lt;/a>。这些服务使用 Service Broker 注册（请参阅 &lt;a href="https://github.com/openservicebrokerapi/servicebroker/blob/master/gettingStarted.md#example-service-brokers" target="_blank" rel="noopener">示例&lt;/a>）。&lt;/p>
&lt;p>如果您没有集群管理员来管理 Service Catalog 的安装，您可以使用 &lt;a href="https://kubernetes.io/docs/tasks/service-catalog/install-service-catalog-using-helm/" target="_blank" rel="noopener">Helm&lt;/a> 或 &lt;a href="https://kubernetes.io/docs/tasks/service-catalog/install-service-catalog-using-sc/" target="_blank" rel="noopener">二进制安装器&lt;/a>。&lt;/p>
&lt;h2 id="探索其他资源">探索其他资源&lt;/h2>
&lt;h4 id="参考">参考&lt;/h4>
&lt;p>以下主题对构建更复杂的应用程序也很有用：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/overview/extending/" target="_blank" rel="noopener">Kubernetes 中的其他扩展点&lt;/a> - 在哪里可以挂勾到 Kubernetes 架构的概念性的概述&lt;/li>
&lt;li>Kubernetes 客户端库 - 用于构建需要与 Kubernetes API 大量交互的应用程序。&lt;/li>
&lt;/ul>
&lt;h4 id="下一步">下一步&lt;/h4>
&lt;p>恭喜您完成了应用开发者之旅！您已经了解了 Kubernetes 提供的大部分功能。现在怎么办？&lt;/p>
&lt;ul>
&lt;li>如果您想推荐新功能或跟上 Kubernetes 应用开发的最新进展，请考虑加入 SIG，如 &lt;a href="https://github.com/kubernetes/community/tree/master/sig-apps" target="_blank" rel="noopener">SIG Apps&lt;/a>。&lt;/li>
&lt;/ul></description></item><item><title>client-go-sample</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/client-go-sample/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/client-go-sample/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 107
title: client-go 示例
date: &amp;ldquo;2022-05-21T00:00:00+08:00&amp;rdquo;
type: book&lt;/h2>
&lt;p>访问 kubernetes 集群有以下几种方式：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">方式&lt;/th>
&lt;th style="text-align:left">特点&lt;/th>
&lt;th style="text-align:left">支持者&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">Kubernetes dashboard&lt;/td>
&lt;td style="text-align:left">直接通过 Web UI 进行操作，简单直接，可定制化程度低&lt;/td>
&lt;td style="text-align:left">官方支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">kubectl&lt;/td>
&lt;td style="text-align:left">命令行操作，功能最全，但是比较复杂，适合对其进行进一步的分装，定制功能，版本适配最好&lt;/td>
&lt;td style="text-align:left">官方支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">client-go&lt;/a>&lt;/td>
&lt;td style="text-align:left">从 kubernetes 的代码中抽离出来的客户端包，简单易用，但需要小心区分 kubernetes 的 API 版本&lt;/td>
&lt;td style="text-align:left">官方支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/kubernetes-incubator/client-python" target="_blank" rel="noopener">client-python&lt;/a>&lt;/td>
&lt;td style="text-align:left">python 客户端，kubernetes-incubator&lt;/td>
&lt;td style="text-align:left">官方支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/fabric8io/kubernetes-client" target="_blank" rel="noopener">Java client&lt;/a>&lt;/td>
&lt;td style="text-align:left">fabric8 中的一部分，kubernetes 的 java 客户端&lt;/td>
&lt;td style="text-align:left">Red Hat&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>下面，我们基于 &lt;a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">client-go&lt;/a>，对 Deployment 升级镜像的步骤进行了定制，通过命令行传递一个 Deployment 的名字、应用容器名和新 image 名字的方式来升级。&lt;/p>
&lt;p>&lt;a href="https://github.com/rootsongjc/kubernetes-client-go-sample" target="_blank" rel="noopener">kubernetes-client-go-sample&lt;/a> 项目的 &lt;code>main.go&lt;/code> 代码如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;path/filepath&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/apimachinery/pkg/api/errors&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span> &lt;span class="s">&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/kubernetes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">home&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">homeDir&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">home&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">home&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.kube&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;config&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;(optional) absolute path to the kubeconfig file&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;absolute path to the kubeconfig file&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deploymentName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;deployment&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;deployment name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">imageName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;image&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;new image name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">appName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;application name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">deploymentName&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;You must specify the deployment name.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">imageName&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;You must specify the new image name.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// use the current context in kubeconfig
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientcmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BuildConfigFromFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// create the clientset
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">kubernetes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewForConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deployment&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AppsV1beta1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Deployments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">deploymentName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetOptions&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotFound&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Deployment not found\n&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">statusError&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">isStatus&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusError&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">isStatus&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Error getting deployment%v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">statusError&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrStatus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Found deployment\n&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">name&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">deployment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetName&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name -&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">containers&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">deployment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Template&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Containers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">found&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">containers&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">containers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Name&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">appName&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">found&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Old image -&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;New image -&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">imageName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Image&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">imageName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">found&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The application container not exist in the deployment pods.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AppsV1beta1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Deployments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">deployment&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">homeDir&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">h&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;HOME&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">h&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;USERPROFILE&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// windows
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们使用 &lt;code>kubeconfig&lt;/code> 文件认证连接 Kubernetes 集群，该文件默认的位置是 &lt;code>$HOME/.kube/config&lt;/code>。&lt;/p>
&lt;p>该代码编译后可以直接在 Kubernetes 集群之外，任何一个可以连接到 API server 的机器上运行。&lt;/p>
&lt;p>&lt;strong>编译运行&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ go get github.com/rootsongjc/kubernetes-client-go-sample
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> &lt;span class="nv">$GOPATH&lt;/span>/src/github.com/rootsongjc/kubernetes-client-go-sample
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ go build main.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>该命令的用法如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> $ ./main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -app string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> application name &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -deployment string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> deployment name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -image string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> new image name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -kubeconfig string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>optional&lt;span class="o">)&lt;/span> absolute path to the kubeconfig file &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;/Users/jimmy/.kube/config&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>使用不存在的 image 更新&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> $ ./main -deployment filebeat-test -image harbor-001.jimmysong.io/library/analytics-docker-test:Build_9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name -&amp;gt; filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Old image -&amp;gt; harbor-001.jimmysong.io/library/analytics-docker-test:Build_8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">New image -&amp;gt; harbor-001.jimmysong.io/library/analytics-docker-test:Build_9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看 Deployment 的 event。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl describe deployment filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Name: filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Namespace: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CreationTimestamp: Fri, &lt;span class="m">19&lt;/span> May &lt;span class="m">2017&lt;/span> 15:12:28 +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Labels: k8s-app&lt;span class="o">=&lt;/span>filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Selector: k8s-app&lt;span class="o">=&lt;/span>filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Replicas: &lt;span class="m">2&lt;/span> updated &lt;span class="p">|&lt;/span> &lt;span class="m">3&lt;/span> total &lt;span class="p">|&lt;/span> &lt;span class="m">2&lt;/span> available &lt;span class="p">|&lt;/span> &lt;span class="m">2&lt;/span> unavailable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">StrategyType: RollingUpdate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MinReadySeconds: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RollingUpdateStrategy: &lt;span class="m">1&lt;/span> max unavailable, &lt;span class="m">1&lt;/span> max surge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Conditions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type Status Reason
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ---- ------ ------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Available True MinimumReplicasAvailable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Progressing True ReplicaSetUpdated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OldReplicaSets: filebeat-test-2365467882 &lt;span class="o">(&lt;/span>2/2 replicas created&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NewReplicaSet: filebeat-test-2470325483 &lt;span class="o">(&lt;/span>2/2 replicas created&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Events:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> FirstSeen LastSeen Count From SubObjectPath Type ReasoMessage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --------- -------- ----- ---- ------------- -------- ------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2h 1m 3 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled down replica &lt;span class="nb">set&lt;/span> filebeat-test-2365467882 to &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1m 1m 1 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled up replica &lt;span class="nb">set&lt;/span> filebeat-test-2470325483 to &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1m 1m 1 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled up replica &lt;span class="nb">set&lt;/span> filebeat-test-2470325483 to &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到老的 ReplicaSet 从 3 个 replica 减少到了 2 个，有 2 个使用新配置的 replica 不可用，目前可用的 replica 是 2 个。&lt;/p>
&lt;p>这是因为我们指定的镜像不存在，查看 Deployment 的 pod 的状态。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl get pods -l k8s-app&lt;span class="o">=&lt;/span>filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">filebeat-test-2365467882-4zwx8 2/2 Running &lt;span class="m">0&lt;/span> 33d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">filebeat-test-2365467882-rqskl 2/2 Running &lt;span class="m">0&lt;/span> 33d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">filebeat-test-2470325483-6vjbw 1/2 ImagePullBackOff &lt;span class="m">0&lt;/span> 4m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">filebeat-test-2470325483-gc14k 1/2 ImagePullBackOff &lt;span class="m">0&lt;/span> 4m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们可以看到有两个 pod 正在拉取 image。&lt;/p>
&lt;p>&lt;strong>还原为原先的镜像&lt;/strong>&lt;/p>
&lt;p>将 image 设置为原来的镜像。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ./main -deployment filebeat-test -image harbor-001.jimmysong.io/library/analytics-docker-test:Build_8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name -&amp;gt; filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Old image -&amp;gt; harbor-001.jimmysong.io/library/analytics-docker-test:Build_9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">New image -&amp;gt; harbor-001.jimmysong.io/library/analytics-docker-test:Build_8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在再查看 Deployment 的状态。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl describe deployment filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Name: filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Namespace: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CreationTimestamp: Fri, &lt;span class="m">19&lt;/span> May &lt;span class="m">2017&lt;/span> 15:12:28 +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Labels: k8s-app&lt;span class="o">=&lt;/span>filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Selector: k8s-app&lt;span class="o">=&lt;/span>filebeat-test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Replicas: &lt;span class="m">3&lt;/span> updated &lt;span class="p">|&lt;/span> &lt;span class="m">3&lt;/span> total &lt;span class="p">|&lt;/span> &lt;span class="m">3&lt;/span> available &lt;span class="p">|&lt;/span> &lt;span class="m">0&lt;/span> unavailable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">StrategyType: RollingUpdate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MinReadySeconds: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RollingUpdateStrategy: &lt;span class="m">1&lt;/span> max unavailable, &lt;span class="m">1&lt;/span> max surge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Conditions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type Status Reason
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ---- ------ ------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Available True MinimumReplicasAvailable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Progressing True NewReplicaSetAvailable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OldReplicaSets: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NewReplicaSet: filebeat-test-2365467882 &lt;span class="o">(&lt;/span>3/3 replicas created&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Events:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> FirstSeen LastSeen Count From SubObjectPath Type ReasoMessage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --------- -------- ----- ---- ------------- -------- ------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2h 8m 3 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled down replica &lt;span class="nb">set&lt;/span> filebeat-test-2365467882 to &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8m 8m 1 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled up replica &lt;span class="nb">set&lt;/span> filebeat-test-2470325483 to &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8m 8m 1 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled up replica &lt;span class="nb">set&lt;/span> filebeat-test-2470325483 to &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2h 1m 3 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled up replica &lt;span class="nb">set&lt;/span> filebeat-test-2365467882 to &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1m 1m 1 &lt;span class="o">{&lt;/span>deployment-controller &lt;span class="o">}&lt;/span> Normal ScalingReplicaSet Scaled down replica &lt;span class="nb">set&lt;/span> filebeat-test-2470325483 to &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到 available 的 replica 个数恢复成 3 了。&lt;/p>
&lt;p>其实在使用该命令的过程中，通过 kubernetes dashboard 的页面上查看 Deployment 的状态更直观，更加方便故障排查。&lt;/p>
&lt;p>
&lt;figure id="figure-使用-kubernetes-dashboard-进行故障排查">
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/book/kubernetes-handbook/kubernetes-client-go-sample-update.jpg" alt="使用 kubernetes dashboard 进行故障排查" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;figcaption>
使用 kubernetes dashboard 进行故障排查
&lt;/figcaption>&lt;/figure>&lt;/p>
&lt;p>这也是 dashboard 最大的优势，简单、直接、高效。&lt;/p></description></item><item><title>contribute</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/contribute/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/contribute/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 113
title: 参与 Kubernetes 社区贡献
date: &amp;lsquo;2022-05-21T00:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>如果您想参与 Kubernetes 社区，请先阅读下&lt;a href="https://github.com/kubernetes/community" target="_blank" rel="noopener">Kubernetes Community&lt;/a>这个 GitHub Repo中的文档，该文档中包括社区的治理形式、社区成员资格申请、提交 Issue、查找问题和提交 PR 的指导等。&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes/community" target="_blank" rel="noopener">Kubernetes Community&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/community/tree/master/contributors/devel" target="_blank" rel="noopener">Kubernetes Developer Guide&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/features" target="_blank" rel="noopener">Enhencement Tracking and Backlog&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/website" target="_blank" rel="noopener">Kubernetes 官方网站项目&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>developing-environment</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/developing-environment/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/developing-environment/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 105
title: 配置 Kubernetes 开发环境
date: &amp;lsquo;2022-05-21T00:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>我们将在 Mac 上使用 docker 环境编译 kuberentes。&lt;/p>
&lt;h2 id="安装依赖">安装依赖&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">brew install gnu-tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Docker 环境，至少需要给容器分配 4G 内存，在低于 3G 内存的时候可能会编译失败。&lt;/p>
&lt;h2 id="执行编译">执行编译&lt;/h2>
&lt;p>切换目录到 kuberentes 源码的根目录下执行：&lt;/p>
&lt;p>&lt;code>./build/run.sh make&lt;/code> 可以在 docker 中执行跨平台编译出二进制文件。&lt;/p>
&lt;p>需要用的的 docker 镜像：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">gcr.io/google_containers/kube-cross:v1.7.5-2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>该镜像基于 Ubuntu 构建，大小 2.15G，编译环境中包含以下软件：&lt;/p>
&lt;ul>
&lt;li>Go1.7.5&lt;/li>
&lt;li>etcd&lt;/li>
&lt;li>protobuf&lt;/li>
&lt;li>g++&lt;/li>
&lt;li>其他 golang 依赖包&lt;/li>
&lt;/ul>
&lt;p>在我自己的电脑上的整个编译过程大概要半个小时。&lt;/p>
&lt;p>编译完成的二进制文件在 &lt;code>/_output/local/go/bin/&lt;/code> 目录下。&lt;/p></description></item><item><title>kubebuilder</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/kubebuilder/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/kubebuilder/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 110
title: Kubebuilder
date: &amp;lsquo;2022-05-21T00:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>Kubebuilder 是一个基于 CRD 来构建 Kubernetes API 的框架，可以使用 CRD 来构建 API、Controller 和 Admission Webhook。&lt;/p>
&lt;h2 id="动机">动机&lt;/h2>
&lt;p>目前扩展 Kubernetes 的 API 的方式有创建 CRD、使用 Operator SDK 等方式，都需要写很多的样本文件（boilerplate），使用起来十分麻烦。为了能够更方便构建 Kubernetes API 和工具，就需要一款能够事半功倍的工具，与其他 Kubernetes API 扩展方案相比，kubebuilder 更加简单易用，并获得了社区的广泛支持。&lt;/p>
&lt;h2 id="工作流程">工作流程&lt;/h2>
&lt;p>Kubebuilder 的工作流程如下：&lt;/p>
&lt;ol>
&lt;li>创建一个新的工程目录&lt;/li>
&lt;li>创建一个或多个资源 API CRD 然后将字段添加到资源&lt;/li>
&lt;li>在控制器中实现协调循环（reconcile loop），watch 额外的资源&lt;/li>
&lt;li>在集群中运行测试（自动安装 CRD 并自动启动控制器）&lt;/li>
&lt;li>更新引导集成测试测试新字段和业务逻辑&lt;/li>
&lt;li>使用用户提供的 Dockerfile 构建和发布容器&lt;/li>
&lt;/ol>
&lt;h2 id="设计哲学">设计哲学&lt;/h2>
&lt;p>Kubebuilder 提供基于简洁的精心设计的示例 godoc 来提供整洁的库抽象。&lt;/p>
&lt;ul>
&lt;li>能使用 go 接口和库，就不使用代码生成&lt;/li>
&lt;li>能使用代码生成，就不用使用多于一次的存根初始化&lt;/li>
&lt;li>能使用一次存根，就不 fork 和修改 boilerplate&lt;/li>
&lt;li>绝不 fork 和修改 boilerplate&lt;/li>
&lt;/ul>
&lt;h2 id="示例">示例&lt;/h2>
&lt;p>下面是一个使用 kubebuilder 创建 Kubernetes Operator 的示例。&lt;/p>
&lt;h2 id="准备">准备&lt;/h2>
&lt;p>本文中的示例运行环境及相关软件版本如下：&lt;/p>
&lt;ul>
&lt;li>Kubernetes MiniKube v1.9.2&lt;/li>
&lt;li>Kubernetes v1.18.0&lt;/li>
&lt;li>Go 1.14&lt;/li>
&lt;li>Kubebuilder 2.3.1&lt;/li>
&lt;li>kustomize 3.6.1&lt;/li>
&lt;li>Docker 19.03.8&lt;/li>
&lt;/ul>
&lt;p>使用 Minikube 安装 Kubernetes 集群，Kubernetes 安装好后，检查集群是否可用。&lt;/p>
&lt;h3 id="minikube-的-dns-解析问题">Minikube 的 DNS 解析问题&lt;/h3>
&lt;p>如果遇到 Kubernetes 集群无法拉取镜像，DNS 解析出现问题，解决方式见 &lt;a href="https://github.com/kubernetes/minikube/issues/1674" target="_blank" rel="noopener">DNS lookup not working when starting minikube with &amp;ndash;dns-domain #1674&lt;/a>。&lt;/p>
&lt;p>使用 &lt;code>minikube ssh&lt;/code> 进入 minikube 主机，修改 &lt;code>/etc/systemd/resolved.conf&lt;/code> 文件，将其中的 DNS 配置字段修改为 &lt;code>DNS=8.8.8.8&lt;/code>，然后执行 &lt;code>sudo systemctl restart systemd-resolved&lt;/code> 即可更改 DNS，切勿直接修改 &lt;code>/etc/resolv.conf&lt;/code> 文件。&lt;/p>
&lt;p>修正 Minikube 的 DNS 配置，请执行下面的命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">minikube ssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sed -i &lt;span class="s1">&amp;#39;s/#DNS=/DNS=8.8.8.8/g&amp;#39;&lt;/span> /etc/systemd/resolved.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl restart systemd-resolved
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="名词解释">名词解释&lt;/h2>
&lt;p>在阅读下面的文章前，需要先明确以下两个名词的含义。&lt;/p>
&lt;ul>
&lt;li>CRD：自定义资源定义，Kubernetes 中的资源类型。&lt;/li>
&lt;li>CR：Custom Resource，对使用 CRD 创建出来的自定义资源的统称。&lt;/li>
&lt;/ul>
&lt;h2 id="安装-kubebuilder">安装 kubebuilder&lt;/h2>
&lt;p>到 kubebuilder 的 &lt;a href="https://github.com/kubernetes-sigs/kubebuilder/releases" target="_blank" rel="noopener">GitHub release 页面&lt;/a>上下载与您操作系统对应的 kubebuilder 安装包。&lt;/p>
&lt;p>&lt;strong>MacOS&lt;/strong>&lt;/p>
&lt;p>对于 Mac 系统，将下载好的安装包解压后将其移动到 &lt;code>/usr/local/kubebuilder&lt;/code> 目录下，并将 &lt;code>/usr/local/kubebuilder/bin&lt;/code> 添加到您的 &lt;code>$PATH&lt;/code> 路径下。&lt;/p>
&lt;h2 id="创建项目">创建项目&lt;/h2>
&lt;p>我们首先将使用自动配置创建一个项目，该项目在创建 CR 时不会触发任何资源生成。&lt;/p>
&lt;h3 id="初始化和创建-api">初始化和创建 API&lt;/h3>
&lt;p>创建的项目路径位于 &lt;code>$GOPATH/jimmysong.io/kubebuilder-example&lt;/code>。下文中的操作没有明确说明的话都是在该项目路径下运行。&lt;/p>
&lt;p>在项目路径下使用下面的命令初始化项目。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubebuilder init --domain jimmysong.io
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在项目根目录下执行下面的命令创建 API。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubebuilder create api --group webapp --version v1 --kind Guestbook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create Resource under pkg/apis &lt;span class="o">[&lt;/span>y/n&lt;span class="o">]&lt;/span>?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create Controller under pkg/controller &lt;span class="o">[&lt;/span>y/n&lt;span class="o">]&lt;/span>?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Writing scaffold &lt;span class="k">for&lt;/span> you to edit...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">api/v1/guestbook_types.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">controllers/guestbook_controller.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running make:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/Users/jimmysong/Workspace/go/bin/controller-gen object:headerFile&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;hack/boilerplate.go.txt&amp;#34;&lt;/span> &lt;span class="nv">paths&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;./...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go fmt ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go vet ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go: finding github.com/onsi/ginkgo v1.11.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go: finding github.com/onsi/gomega v1.8.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go: finding github.com/hpcloud/tail v1.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go: finding gopkg.in/tomb.v1 v1.0.0-20141024135613-dd632973f1e7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go build -o bin/manager main.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>API 创建完成后，在项目根目录下查看目录结构。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Dockerfile &lt;span class="c1"># 用于构建 Operator 镜像&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── Makefile &lt;span class="c1"># 构建时使用&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── PROJECT &lt;span class="c1"># 项目配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── groupversion_info.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── guestbook_types.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── zz_generated.deepcopy.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── certmanager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── certificate.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── kustomizeconfig.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── crd &lt;span class="c1"># 新增 CRD 定义&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomizeconfig.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── patches
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── manager_auth_proxy_patch.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── manager_webhook_patch.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── webhookcainjection_patch.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── manager.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── monitor.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── rbac
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── auth_proxy_client_clusterrole.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── auth_proxy_role.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── auth_proxy_role_binding.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── auth_proxy_service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── guestbook_editor_role.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── guestbook_viewer_role.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── leader_election_role.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   ├── leader_election_role_binding.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── role_binding.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── samples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   │   └── webapp_v1_guestbook.yaml &lt;span class="c1"># CRD 示例&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── webhook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── kustomization.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── kustomizeconfig.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── controllers &lt;span class="c1"># 新增 controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── guestbook_controller.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── suite_test.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── go.mod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── go.sum
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── hack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── boilerplate.go.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── main.go &lt;span class="c1"># 新增处理逻辑&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">15&lt;/span> directories, &lt;span class="m">40&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上就是自动初始化出来的文件。&lt;/p>
&lt;h3 id="安装-crd">安装 CRD&lt;/h3>
&lt;p>执行下面的命令安装 CRD。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/Users/jimmysong/Workspace/go/bin/controller-gen &lt;span class="s2">&amp;#34;crd:trivialVersions=true&amp;#34;&lt;/span> rbac:roleName&lt;span class="o">=&lt;/span>manager-role webhook &lt;span class="nv">paths&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;./...&amp;#34;&lt;/span> output:crd:artifacts:config&lt;span class="o">=&lt;/span>config/crd/bases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kustomize build config/crd &lt;span class="p">|&lt;/span> kubectl apply -f -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/guestbooks.webapp.jimmysong.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get crd &lt;span class="p">|&lt;/span>grep jimmysong.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">guestbooks.webapp.jimmysong.io 2020-06-06T21:58:17Z
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="部署-controller">部署 controller&lt;/h3>
&lt;p>在开始部署 controller 之前，我们需要先检查 kubebuilder 自动生成的 YAML 文件。&lt;/p>
&lt;p>&lt;strong>修改使用 gcr.io 镜像仓库的镜像地址&lt;/strong>&lt;/p>
&lt;p>对于中国大陆用户，可能无法访问 Google 镜像仓库 gcr.io，因此需要修改 &lt;code>config/default/manager_auth_proxy_patch.yaml&lt;/code> 文件中的镜像地址，将其中 &lt;code>gcr.io/kube-rbac-proxy:v0.5.0&lt;/code> 修改为 &lt;code>jimmysong/kubebuilder-kube-rbac-proxy:v0.5.0&lt;/code>。&lt;/p>
&lt;p>有两种方式运行 controller：&lt;/p>
&lt;ul>
&lt;li>本地运行，用于调试&lt;/li>
&lt;li>部署到 Kubernetes 上运行，作为生产使用&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>本地运行 controller&lt;/strong>&lt;/p>
&lt;p>要想在本地运行 controller，只需要执行下面的命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>你将看到 controller 启动和运行时输出。&lt;/p>
&lt;p>&lt;strong>将 controller 部署到 Kubernetes&lt;/strong>&lt;/p>
&lt;p>执行下面的命令部署 controller 到 Kubernetes 上，这一步将会在本地构建 controller 的镜像，并推送到 DockerHub 上，然后在 Kubernetes 上部署 Deployment 资源。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make docker-build docker-push &lt;span class="nv">IMG&lt;/span>&lt;span class="o">=&lt;/span>jimmysong/kubebuilder-example:latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make deploy &lt;span class="nv">IMG&lt;/span>&lt;span class="o">=&lt;/span>jimmysong/kubebuilder-example:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在初始化项目时，kubebuilder 会自动根据项目名称创建一个 Namespace，如本文中的 &lt;code>kubebuilder-example-system&lt;/code>，查看 Deployment 对象和 Pod 资源。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl get deployment -n kubebuilder-example-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubebuilder-example-controller-manager 1/1 &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 3h26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pod -n kubebuilder-example-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubebuilder-example-controller-manager-77b4c685f9-2npz8 2/2 Running &lt;span class="m">0&lt;/span> 3h16m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-cr">创建 CR&lt;/h3>
&lt;p>Kubebuilder 在初始化项目的时候已生成了示例 CR，执行下面的命令部署 CR。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">kubectl apply -f config/samples/webapp_v1_guestbook.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>执行下面的命令查看新创建的 CR。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl get guestbooks.webapp.jimmysong.io guestbook-sample -o yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>你将看到类似如下的输出。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Guestbook&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="s2">&amp;#34;apiVersion&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;webapp.jimmysong.io/v1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;kind&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Guestbook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;metadata&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{&lt;span class="s2">&amp;#34;annotations&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{}&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;guestbook-sample&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;namespace&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;kubebuilder-example-system&amp;#34;&lt;/span>}&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;spec&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{&lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>}}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-06-07T01:04:48Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">generation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">managedFields&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FieldsV1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsV1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">.&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">.&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:foo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">manager&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Update&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-06-07T01:04:48Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">guestbook-sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubebuilder-example-system&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;1795834&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selfLink&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/apis/webapp.jimmysong.io/v1/namespaces/kubebuilder-example-system/guestbooks/guestbook-sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">051a4266-7f5a-4c57-8180-64222d462bba&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">foo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bar&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>至此一个基本的 Operator 框架已经创建完成，但这个 Operator 只是修改了 etcd 中的数据而已，实际上什么事情也没做，因为我们没有在 Operator 中的增加业务逻辑。&lt;/p>
&lt;h2 id="增加业务逻辑">增加业务逻辑&lt;/h2>
&lt;p>下面我们将修改 CRD 的数据结构并在 controller 中增加一些日志输出。&lt;/p>
&lt;h3 id="修改-crd">修改 CRD&lt;/h3>
&lt;p>我们将修改上文中使用 kubebuilder 命令生成的默认 CRD 配置，在 CRD 中增加 &lt;code>FirstName&lt;/code>、&lt;code>LastName&lt;/code> 和 &lt;code>Status&lt;/code> 字段。&lt;/p>
&lt;p>下面是修改后的 &lt;code>api/v1/guestbook_types.go&lt;/code> 文件的内容，对应修改的地方已在代码中注释说明。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">Licensed under the Apache License, Version 2.0 (the &amp;#34;License&amp;#34;);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">you may not use this file except in compliance with the License.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">You may obtain a copy of the License at
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> http://www.apache.org/licenses/LICENSE-2.0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">Unless required by applicable law or agreed to in writing, software
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">distributed under the License is distributed on an &amp;#34;AS IS&amp;#34; BASIS,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">See the License for the specific language governing permissions and
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">limitations under the License.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">v1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span> &lt;span class="s">&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// EDIT THIS FILE! THIS IS SCAFFOLDING FOR YOU TO OWN!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// NOTE: json tags are required. Any new fields you add must have json tags for the fields to be serialized.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// GuestbookSpec defines the desired state of Guestbook
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">GuestbookSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// Important: Run &amp;#34;make&amp;#34; to regenerate code after modifying this file
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Foo is an example field of Guestbook. Edit Guestbook_types.go to remove/update
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 添加两个新的字段
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">FirstName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;firstname&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LastName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;lastname&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// GuestbookStatus defines the observed state of Guestbook
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">GuestbookStatus&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// Important: Run &amp;#34;make&amp;#34; to regenerate code after modifying this file
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">Status&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;Status&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:object:root=true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 在这里增加 status 的说明
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:subresource:status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Guestbook is the Schema for the guestbooks API
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Guestbook&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span> &lt;span class="s">`json:&amp;#34;,inline&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span> &lt;span class="s">`json:&amp;#34;metadata,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Spec&lt;/span> &lt;span class="nx">GuestbookSpec&lt;/span> &lt;span class="s">`json:&amp;#34;spec,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Status&lt;/span> &lt;span class="nx">GuestbookStatus&lt;/span> &lt;span class="s">`json:&amp;#34;status,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:object:root=true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// GuestbookList contains a list of Guestbook
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">GuestbookList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span> &lt;span class="s">`json:&amp;#34;,inline&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListMeta&lt;/span> &lt;span class="s">`json:&amp;#34;metadata,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Items&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Guestbook&lt;/span> &lt;span class="s">`json:&amp;#34;items&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">SchemeBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Guestbook&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GuestbookList&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面的代码比原先使用 kubebuilder 生成的默认代码增加了以下内容：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">FirstName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;firstname&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LastName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;lastname&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Status&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;Status&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:subresource:status
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="修改-reconcile-函数">修改 Reconcile 函数&lt;/h3>
&lt;p>Reconcile 函数是 Operator 的核心逻辑，Operator 的业务逻辑都位于 &lt;code>controllers/guestbook_controller.go&lt;/code> 文件的 &lt;code>func (r *GuestbookReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error)&lt;/code> 函数中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:rbac:groups=webapp.jimmysong.io,resources=guestbooks,verbs=get;list;watch;create;update;patch;delete
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +kubebuilder:rbac:groups=webapp.jimmysong.io,resources=guestbooks/status,verbs=get;update;patch
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GuestbookReconciler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Reconcile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;guestbook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamespacedName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// your logic here
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;apiexamplea&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamespacedName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 获取当前的 CR，并打印
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">webappv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Guestbook&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamespacedName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Unable to fetch object&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Geeting from Kubebuilder to&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FirstName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LastName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 初始化 CR 的 Status 为 Running
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Status&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;Running&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Status&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;unable to update status&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这段代码的业务逻辑是当发现有 &lt;code>guestbooks.webapp.jimmysong.io&lt;/code> 的 CR 变更时，在控制台中输出日志。&lt;/p>
&lt;h3 id="运行测试">运行测试&lt;/h3>
&lt;p>修改好 Operator 的业务逻辑后，再测试一下新的逻辑是否可以正常运行。&lt;/p>
&lt;p>&lt;strong>部署 CRD&lt;/strong>&lt;/p>
&lt;p>跟上文的做法一样，执行下面的命令部署 CRD。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>运行 controller&lt;/strong>&lt;/p>
&lt;p>跟上文的做法一样，执行下面的命令运行 controller。为了方便起见，我们将在本地运行 controller，当然您也可以将其部署到 Kubernetes 上运行。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>保持该窗口在前台运行。&lt;/p>
&lt;p>&lt;strong>部署 CR&lt;/strong>&lt;/p>
&lt;p>修改 &lt;code>config/samples/webapp_v1_guestbook.yaml&lt;/code> 文件中的配置。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Guestbook&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">guestbook-sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Add fields here&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">firstname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Jimmy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">lastname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Song&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将其应用到 Kubernetes。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">kubectl apply -f config/samples/webapp_v1_guestbook.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此时转到上文中运行 controller 的窗口，将在命令行前台中看到如下输出。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">go fmt ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go vet ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/Users/jimmysong/Workspace/go/bin/controller-gen &lt;span class="s2">&amp;#34;crd:trivialVersions=true&amp;#34;&lt;/span> rbac:roleName&lt;span class="o">=&lt;/span>manager-role webhook &lt;span class="nv">paths&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;./...&amp;#34;&lt;/span> output:crd:artifacts:config&lt;span class="o">=&lt;/span>config/crd/bases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run ./main.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:29.966+0800 INFO controller-runtime.metrics metrics server is starting to listen &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;addr&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:29.967+0800 INFO setup starting manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:29.967+0800 INFO controller-runtime.manager starting metrics server &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;path&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/metrics&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:29.967+0800 INFO controller-runtime.controller Starting EventSource &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;controller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;guestbook&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;source&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;kind source: /, Kind=&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:30.068+0800 INFO controller-runtime.controller Starting Controller &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;controller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;guestbook&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:30.068+0800 INFO controller-runtime.controller Starting workers &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;controller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;guestbook&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;worker count&amp;#34;&lt;/span>: 1&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/06/07 16:48:30 Geeting from Kubebuilder to Jimmy Song
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T16:48:30.080+0800 DEBUG controller-runtime.controller Successfully Reconciled &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;controller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;guestbook&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;request&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;kubebuilder-example-system/guestbook-sample&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从上面的日志中，可以看到这条输出。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2020/06/07 16:48:30 Geeting from Kubebuilder to Jimmy Song
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这正是在 &lt;code>Reconcile&lt;/code> 函数中的输出。&lt;/p>
&lt;p>&lt;strong>获取当前的 CR&lt;/strong>&lt;/p>
&lt;p>使用下面的命令获取当前的 CR。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># kubectl get guestbooks.webapp.jimmysong.io guestbook-sample -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将看到如下输出。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Guestbook&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="s2">&amp;#34;apiVersion&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;webapp.jimmysong.io/v1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;kind&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Guestbook&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;metadata&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{&lt;span class="s2">&amp;#34;annotations&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{}&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;guestbook-sample&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;namespace&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;kubebuilder-example-system&amp;#34;&lt;/span>}&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;spec&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>{&lt;span class="s2">&amp;#34;firstname&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Jimmy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;lastname&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Song&amp;#34;&lt;/span>}}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-06-07T02:54:46Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">generation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">managedFields&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FieldsV1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsV1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">.&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">.&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:firstname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:lastname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">manager&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubectl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Update&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-06-07T02:54:46Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">webapp.jimmysong.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FieldsV1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fieldsV1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">.&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">f:Status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">manager&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Update&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-06-07T02:56:38Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">guestbook-sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubebuilder-example-system&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;1813769&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selfLink&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/apis/webapp.jimmysong.io/v1/namespaces/kubebuilder-example-system/guestbooks/guestbook-sample&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">17da5eae-1020-40d2-821a-9a1f990dd767&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">firstname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Jimmy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">lastname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Song&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Running&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们输出的最后部分：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">firstname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Jimmy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">lastname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Song&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Running&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这正是我们在 CRD 里定义的字段。&lt;/p>
&lt;p>&lt;strong>删除 CR&lt;/strong>&lt;/p>
&lt;p>使用下面的命令删除 CR。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">kubectl delete guestbooks.webapp.jimmysong.io guestbook-sample
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此时在 controller 的前台输出中可以看到以下内容。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2020/06/07 20:09:50 Guestbook.webapp.jimmysong.io &lt;span class="s2">&amp;#34;guestbook-sample&amp;#34;&lt;/span> not found Unable to fetch object
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/06/07 20:09:50 resource name may not be empty unable to update status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-06-07T20:09:50.380+0800 DEBUG controller-runtime.controller Successfully Reconciled &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;controller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;guestbook&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;request&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;kubebuilder-example-system/guestbook-sample&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>因为该 CR 被删除，因此日志中会提示资源找不到。&lt;/p>
&lt;h2 id="更多">更多&lt;/h2>
&lt;p>本示例仅展示了使用 kubebuilder 创建 Operator 的基本逻辑，步骤为：&lt;/p>
&lt;ul>
&lt;li>初始化项目和 API&lt;/li>
&lt;li>安装 CRD&lt;/li>
&lt;li>部署 Controller&lt;/li>
&lt;li>创建 CR&lt;/li>
&lt;/ul>
&lt;p>Operator 的核心逻辑都在 controller 的 &lt;code>Reconcile&lt;/code> 函数中，请参考 &lt;a href="https://jimmysong.io/awesome-cloud-native/#kubernetes-operators" target="_blank" rel="noopener">Awesome Cloud Native&lt;/a> 中的 Operator 实现，本书后续将会讨论。&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes-sigs/kubebuilder/" target="_blank" rel="noopener">kubebuilder - github.com&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://book.kubebuilder.io" target="_blank" rel="noopener">kubebuilder book - book.kubebuilder.io&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloudnative.to/kubebuilder/" target="_blank" rel="noopener">Kubebuilder 中文文档 - cloudnative.to&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://chenshaowen.com/blog/how-to-develop-a-operator-using-kubebuilder.html" target="_blank" rel="noopener">如何使用 KubeBuilder 开发一个 Operator - chenshaowen.com&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubebuilder.io/quick-start.html" target="_blank" rel="noopener">Kubebuilder book - kubebuilder.io&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>minikube</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/minikube/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/minikube/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 114
title: Minikube
date: &amp;lsquo;2022-05-21T00:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>Minikube 用于在本地运行 kubernetes 环境，用来开发和测试。&lt;/p>
&lt;h2 id="安装-minikube">安装 Minikube&lt;/h2>
&lt;p>到 &lt;a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="noopener">GitHub&lt;/a> 下载 minikube，我安装的是 minikube v1.11.0。&lt;/p>
&lt;p>下载完成后修改文件名为 &lt;code>minikube&lt;/code>，然后 &lt;code>chmod +x minikube&lt;/code>，移动到 &lt;code>$PATH&lt;/code> 目录下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo mv ~/Download/minikube-darwin-adm64 /usr/local/bin/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo chmod +x /usr/local/bin/minikube
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="安装-kubectl">安装 kubectl&lt;/h2>
&lt;p>&lt;strong>方式一&lt;/strong>&lt;/p>
&lt;p>参考 &lt;a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">Install and Set Up kubectl&lt;/a>，直接使用二进制文件安装即可。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">curl -LO https://storage.googleapis.com/kubernetes-release/release/&lt;span class="sb">`&lt;/span>curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt&lt;span class="sb">`&lt;/span>/bin/darwin/amd64/kubectl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>方式二&lt;/strong>&lt;/p>
&lt;p>先访问 &lt;a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/stable.txt&lt;/a>
得到返回值，假设为 &lt;code>v1.18.4&lt;/code>，然后拼接网址，直接在浏览器访问：
&lt;a href="https://storage.googleapis.com/kubernetes-release/release/v1.18.4/bin/darwin/amd64/kubectl" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/v1.18.4/bin/darwin/amd64/kubectl&lt;/a> 直接下载 kubectl 文件。&lt;/p>
&lt;p>若第一种方式访问多次超时，可以使用上述的第二种方式访问。&lt;/p>
&lt;h2 id="启动-minikube">启动 Minikube&lt;/h2>
&lt;p>对于 macOS，执行 &lt;code>minikube start --vm-driver=hyperkit&lt;/code> （使用 hyperkit 作为虚拟机，不需要安装 docker）即可自动下载依赖文件，开始安装和启动 minikube。该过程中将自动执行以下步骤：&lt;/p>
&lt;ol>
&lt;li>下载 &lt;code>docker-machine-driver-hyperkit&lt;/code>（10.9 M）&lt;/li>
&lt;li>下载虚拟机镜像（近 200M）&lt;/li>
&lt;li>下载 Kubernetes 安装包（500 多 M）&lt;/li>
&lt;/ol>
&lt;p>安装完成后将生成默认的 &lt;code>~/.kube/config&lt;/code> 文件，自动指向 minikube 集群。&lt;/p>
&lt;p>注意：在安装过程中建议&lt;a href="https://minikube.sigs.k8s.io/docs/handbook/vpn_and_proxy/" target="_blank" rel="noopener">配置代理&lt;/a>，否则将会有的镜像无法下载。&lt;/p>
&lt;h2 id="常用命令">常用命令&lt;/h2>
&lt;p>下面是 minkube 的常用命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入集群节点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minikube ssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看节点 IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minikube ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 停止集群&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minikube stop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 删除集群&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">minikube delete
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://kubernetes.io/docs/tasks/tools/install-minikube/" target="_blank" rel="noopener">Install minikube - kubernetes.io&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>operator</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/operator/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/operator/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 108
title: Operator
summary: &amp;ldquo;关于 Kubernetes Operator 的原理、用途等基础知识介绍。&amp;rdquo;
date: &amp;lsquo;2022-09-05T11:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>Operator 最初是由 CoreOS（后被 Red Hat 收购） 开发的，下面是关于 Operator 的一些基础知识：&lt;/p>
&lt;ul>
&lt;li>Operator 是用来扩展 Kubernetes API 的特定的应用程序控制器；&lt;/li>
&lt;li>Operator 用来创建、配置和管理复杂的有状态应用，如数据库、缓存和监控系统；&lt;/li>
&lt;li>Operator 基于 Kubernetes 的资源和控制器概念之上构建，但同时又包含了应用程序特定的领域知识；&lt;/li>
&lt;li>创建 Operator 的关键是 CRD（自定义资源）的设计；&lt;/li>
&lt;li>Operator 通常作为 Deployment 资源部署在 Kubernetes 中，删掉 Operator 不会影响已使用它创建的自定义资源；&lt;/li>
&lt;li>&lt;a href="https://operatorhub.io/" target="_blank" rel="noopener">Operator Hub&lt;/a> 中罗列了目前已知的 Operator。&lt;/li>
&lt;/ul>
&lt;h2 id="工作原理">工作原理&lt;/h2>
&lt;p>Operator 是将运维人员对软件操作的知识给代码化，同时利用 Kubernetes 强大的抽象来管理大规模的软件应用。&lt;/p>
&lt;p>Operator 使用了 Kubernetes 的自定义资源扩展 API 机制，如使用 CRD（CustomResourceDefinition）来创建。Operator 通过这种机制来创建、配置和管理应用程序。&lt;/p>
&lt;p>Operator 基于 Kubernetes 的以下两个概念构建：&lt;/p>
&lt;ul>
&lt;li>资源：对象的状态定义&lt;/li>
&lt;li>控制器：观测、分析和行动，以调节资源的分布&lt;/li>
&lt;/ul>
&lt;h2 id="operator-用途">Operator 用途&lt;/h2>
&lt;p>若您有以下需求，可能会需要用到 Operator：&lt;/p>
&lt;ul>
&lt;li>按需部署一个应用程序&lt;/li>
&lt;li>需要备份和恢复应用程序的状态（如数据库）&lt;/li>
&lt;li>处理应用程序代码的升级以及相关更改，例如数据库架构或额外的配置设置&lt;/li>
&lt;li>发布一个服务，要让不支持 Kubernetes API 的应用程序能够发现&lt;/li>
&lt;li>模拟整个或部分集群中的故障以测试其弹性&lt;/li>
&lt;li>在没有内部成员选举程序的情况下为分布式应用程序选择领导者&lt;/li>
&lt;/ul>
&lt;h2 id="operator-用途的详细示例">Operator 用途的详细示例&lt;/h2>
&lt;p>下面是一个使用 Operator 的详细示例：&lt;/p>
&lt;ul>
&lt;li>将一个名为 SampleDB 的自定义资源其配置到集群中。&lt;/li>
&lt;li>确保正在运行的 Deployment 的 Pod 中包含 Operator 的控制器部分。&lt;/li>
&lt;li>Operator 代码的容器镜像。&lt;/li>
&lt;li>查询控制平面以找出配置了哪些 SampleDB 资源的控制器代码。&lt;/li>
&lt;li>Operator 的核心是告诉 API Server 如何使现实与代码里已配置的资源匹配：
&lt;ul>
&lt;li>如果添加新的 SampleDB，Operator 将设置 PersistentVolumeClaims 以提供持久的数据库存储，设置 StatefulSet 以运行 SampleDB，并设置 Job 来处理初始配置。&lt;/li>
&lt;li>如果删除它，Operator 将建立快照，然后确保删除了 StatefulSet 和卷。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Operator 还管理常规数据库备份。对于每个 SampleDB 资源，Operator 确定何时创建可以连接到数据库并进行备份的 Pod。这些 Pod 将依赖于 ConfigMap 和 / 或具有数据库连接详细信息和凭据的 Secret。&lt;/li>
&lt;li>由于 Operator 旨在为其管理的资源提供强大的自动化功能，因此会有其他支持代码。对于此示例，代码将检查数据库是否正在运行旧版本，如果是，则创建 Job 对象为您升级数据库。&lt;/li>
&lt;/ul>
&lt;h2 id="创建-operator">创建 Operator&lt;/h2>
&lt;p>Operator 本质上是与应用息息相关的，因为这是特定领域的知识的编码结果，这其中包括了资源配置的控制逻辑。下面是创建 Operator 的基本步骤：&lt;/p>
&lt;ol>
&lt;li>在单个 Deployment 中定义 Operator 且部署完成不需要进行任何操作；&lt;/li>
&lt;li>需要为 Operator 创建一个新的自定义类型 CRD，这样用户就可以使用该对象来创建实例；&lt;/li>
&lt;li>Operator 应该利用 Kubernetes 中内建的原语，如 Deployment、Service 这些经过充分测试的对象，这样也便于理解；&lt;/li>
&lt;li>Operator 应该向后兼容，始终了解用户在之前版本中创建的资源；&lt;/li>
&lt;li>当 Operator 被停止或删除时，Operator 创建的应用实例应该不受影响；&lt;/li>
&lt;li>Operator 应该让用户能够根据版本声明来选择所需版本和编排应用程序升级。不升级软件是操作错误和安全问题的常见来源，Operator 可以帮助用户更加自信地解决这一问题；&lt;/li>
&lt;li>Operator 应该进行 “Chaos Monkey” 测试，以模拟 Pod、配置和网络故障的情况下的行为。&lt;/li>
&lt;/ol>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://medium.com/@mtreacher/writing-a-kubernetes-operator-a9b86f19bfb9" target="_blank" rel="noopener">Writing a Kubernetes Operator in Golang - medium.com&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloud.redhat.com/blog/introducing-operators-putting-operational-knowledge-into-software" target="_blank" rel="noopener">Introducing Operators: Putting Operational Knowledge into Software - cloud.redhat.com&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://thenewstack.io/automating-kubernetes-cluster-operations-operators/" target="_blank" rel="noopener">Automating Kubernetes Cluster Operations with Operators - thenewstack.io&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener">Operator pattern - kubernetes.io&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>operator-sdk</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/operator-sdk/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/operator-sdk/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 109
title: Operator SDK
date: &amp;lsquo;2022-05-21T00:00:00+08:00&amp;rsquo;
type: book&lt;/h2>
&lt;p>&lt;a href="https://github.com/operator-framework/operator-sdk" target="_blank" rel="noopener">Operator SDK&lt;/a> 由 CoreOS 开源，它是用于构建 Kubernetes 原生应用的 SDK，它提供更高级别的 API、抽象和项目脚手架。在阅读本文前请先确认您已经了解 &lt;a href="operator.md">Operator&lt;/a>是什么。&lt;/p>
&lt;p>使用 Kubernetes 中原生的对象来部署和管理复杂的应用程序不是那么容易，尤其是要管理整个应用的生命周期、组件的扩缩容，我们之前通常是编写各种脚本，通过调用 Kubernetes 的命令行工具来管理 Kubernetes 上的应用。现在可以通过 CRD（CustomResourceDefinition）来自定义这些复杂操作，通过将运维的知识封装在自定义 API 里来减轻运维人员的负担。同时我们还可以像操作 Kubernetes 的原生资源对象一样，使用 &lt;code>kubectl&lt;/code> 来操作 CRD。&lt;/p>
&lt;p>下面我们将安装和试用一下 Operator SDK。&lt;/p>
&lt;h2 id="安装-operator-sdk">安装 Operator SDK&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mkdir -p &lt;span class="nv">$GOPATH&lt;/span>/src/github.com/operator-framework
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> &lt;span class="nv">$GOPATH&lt;/span>/src/github.com/operator-framework/operator-sdk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ dep ensure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/cmd/kubernetes-operator-sdk-tutorial/main.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/config/config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/deploy/rbac.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/deploy/cr.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/pkg/apis/jimmysong/v1alpha1/doc.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/pkg/apis/jimmysong/v1alpha1/register.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/pkg/apis/jimmysong/v1alpha1/types.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/pkg/stub/handler.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/tmp/build/build.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/tmp/build/docker_build.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/tmp/build/Dockerfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/tmp/codegen/boilerplate.go.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/tmp/codegen/update-generated.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/Gopkg.toml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Create kubernetes-operator-sdk-tutorial/Gopkg.lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Run dep ensure ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Root project is &lt;span class="s2">&amp;#34;github.com/rootsongjc/kubernetes-operator-sdk-tutorial&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> transitively valid internal packages
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">12&lt;/span> external packages imported from &lt;span class="m">4&lt;/span> projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>0&lt;span class="o">)&lt;/span> ✓ &lt;span class="k">select&lt;/span> &lt;span class="o">(&lt;/span>root&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span> ? attempt k8s.io/api with &lt;span class="m">1&lt;/span> pkgs&lt;span class="p">;&lt;/span> at least &lt;span class="m">1&lt;/span> versions to try
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span> try k8s.io/api@kubernetes-1.9.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span> ✓ &lt;span class="k">select&lt;/span> k8s.io/api@kubernetes-1.9.3 w/1 pkgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span> ? attempt k8s.io/apimachinery with &lt;span class="m">4&lt;/span> pkgs&lt;span class="p">;&lt;/span> at least &lt;span class="m">1&lt;/span> versions to try
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span> try k8s.io/apimachinery@kubernetes-1.9.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span> ✓ &lt;span class="k">select&lt;/span> k8s.io/apimachinery@kubernetes-1.9.3 w/22 pkgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ go install github.com/operator-framework/operator-sdk/commands/operator-sdk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>该过程需要几分钟，请耐心等待。确认 &lt;code>$GOPATH/bin/operator-sdk&lt;/code> 文件位于您的 &lt;code>$PATH&lt;/code> 目录下。&lt;/p>
&lt;h2 id="创建项目">创建项目&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> &lt;span class="nv">$GOPATH&lt;/span>/src/github.com/&amp;lt;your-github-repo&amp;gt;/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ operator-sdk new &amp;lt;operator-project-name&amp;gt; --api-version&lt;span class="o">=&lt;/span>&amp;lt;your-api-group&amp;gt;/&amp;lt;version&amp;gt; --kind&lt;span class="o">=&lt;/span>&amp;lt;custom-resource-kind&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> &amp;lt;operator-project-name&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>operator-project-name：创建的项目的名称&lt;/li>
&lt;li>your-api-group：Kubernetes 自定义 API 的组名，一般用域名如 &lt;code>jimmysong.io&lt;/code>&lt;/li>
&lt;li>version：Kubernetes 自定义资源的 API 版本&lt;/li>
&lt;li>custom-resource-kind：CRD 的名称&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">operator-sdk new kubernetes-operator-sdk-tutorial --api-version&lt;span class="o">=&lt;/span>jimmysong.io/v1alpha1 --kind&lt;span class="o">=&lt;/span>operator-sdk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://banzaicloud.com/blog/operator-sdk/" target="_blank" rel="noopener">A complete guide to Kubernetes Operator SDK&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>sigs-and-working-group</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/sigs-and-working-group/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/sigs-and-working-group/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 104
title: SIG 和工作组
date: &amp;ldquo;2022-05-21T00:00:00+08:00&amp;rdquo;
type: book&lt;/h2>
&lt;p>Kubernetes 的社区是以 SIG（Special Interest Group 特别兴趣小组）和工作组的形式组织起来的，每个工作组都会定期召开视频会议。&lt;/p>
&lt;p>所有的 SIG 和工作组都使用 slack 和邮件列表沟通。&lt;/p>
&lt;p>
&lt;figure id="figure-kubernetes-sig-组织结构">
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/book/kubernetes-handbook/kubernetes-sigs.jpg" alt="Kubernetes SIG" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;figcaption>
Kubernetes SIG 组织结构
&lt;/figcaption>&lt;/figure>&lt;/p>
&lt;h2 id="主要-sig-列表">主要 SIG 列表&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>api-machinery&lt;/strong>：所有 API 级别的功能，包括了 API server、API 注册和发现、通用的 API CRUD 语义，准入控制，编码 / 解码，转换，默认值，持久化层（etcd），OpenAPI，第三方资源，垃圾回收（gc）和客户端库的方方面面。&lt;/li>
&lt;li>&lt;strong>aws&lt;/strong>：如何在 AWS 上支持和使用 kubernetes。&lt;/li>
&lt;li>&lt;strong>apps&lt;/strong>：在 kubernetes 上部署和运维应用程序。关注开发者和 DevOps 在 kubernetes 上运行应用程序的体验。&lt;/li>
&lt;li>&lt;strong>architecture&lt;/strong>：维持 kubernetes 在架构设计上的一致性和原则。&lt;/li>
&lt;li>&lt;strong>auth&lt;/strong>：kubernetes 的认证授权、权限管理和安全性策略。&lt;/li>
&lt;li>&lt;strong>autoscaling&lt;/strong>：集群的自动缩放，pod 的水平和垂直自动缩放，pod 的资源初始化，pod 监控和指标收集等主题。&lt;/li>
&lt;li>&lt;strong>azure&lt;/strong>：如何在 Azure 上支持和使用 kubernetes。&lt;/li>
&lt;li>&lt;strong>big-data&lt;/strong>：在 kubernetes 上部署和运行大数据应用，如 Spark、Kafka、Hadoop、Flink、Storm 等。&lt;/li>
&lt;li>&lt;strong>CLI&lt;/strong>：kubectl 和相关工具。&lt;/li>
&lt;li>&lt;strong>cluster-lifecycle&lt;/strong>：部署和升级 kubernetes 集群。&lt;/li>
&lt;li>&lt;strong>cluster-ops&lt;/strong>：促进 kubernetes 集群本身的可操作性和集群间的互操作性，使不同的运营商之间协调一致。&lt;/li>
&lt;li>&lt;strong>contributor-experience&lt;/strong>：维持良好的开发者社区。&lt;/li>
&lt;li>&lt;strong>docs&lt;/strong>：文档，流程和出版物。&lt;/li>
&lt;li>&lt;strong>GCP&lt;/strong>：在 Google Cloud Platform 上使用 kubernetes。&lt;/li>
&lt;li>&lt;strong>instrumentation&lt;/strong>：集群可观测性的最佳实践，包括指标设置、日志收集、事件等。&lt;/li>
&lt;li>&lt;strong>multicluster&lt;/strong>：多 kubernetes 集群的用例和工具。&lt;/li>
&lt;li>&lt;strong>network&lt;/strong>：kubernetes 集群的网络。&lt;/li>
&lt;li>&lt;strong>node&lt;/strong>：node 节点、kubelet。&lt;/li>
&lt;li>&lt;strong>onprem&lt;/strong>：在非云供应商的环境下运行 kubernetes，例如 on premise、裸机等环境。&lt;/li>
&lt;li>&lt;strong>openstack&lt;/strong>：协调跨 OpenStack 和 Kubernetes 社区的努力。&lt;/li>
&lt;li>&lt;strong>product-management&lt;/strong>：侧重于产品管理方面。&lt;/li>
&lt;li>&lt;strong>release&lt;/strong>：发布、PR 和 bug 提交等。&lt;/li>
&lt;li>&lt;strong>scalability&lt;/strong>：负责回答可伸缩性相关的问题。&lt;/li>
&lt;li>&lt;strong>scheduling&lt;/strong>：资源调度。&lt;/li>
&lt;li>&lt;strong>service-catalog&lt;/strong>：为 CNCF service broker 和 Kubernetes broker 实现开发 API。&lt;/li>
&lt;li>&lt;strong>storage&lt;/strong>：存储和 volume 插件。&lt;/li>
&lt;li>&lt;strong>testing&lt;/strong>：测试。&lt;/li>
&lt;li>&lt;strong>ui&lt;/strong>：与 UI 相关的话题。&lt;/li>
&lt;li>&lt;strong>windows&lt;/strong>：在 kubernets 上运行 Windows Server Container。&lt;/li>
&lt;/ul>
&lt;h2 id="工作组列表">工作组列表&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>App Def&lt;/strong>：改进 API 中的声明性原语、客户端库、工具的用户体验。&lt;/li>
&lt;li>&lt;strong>Cloud Provider&lt;/strong>：云供应商工作组。&lt;/li>
&lt;li>&lt;strong>Cluster API&lt;/strong>：定义一个代表 Kubernetes 集群的可移植 API。API 将包含控制平面及其配置和底层基础设施（节点，节点池等）。&lt;/li>
&lt;li>&lt;strong>Container Identity&lt;/strong>：确保容器能够获得安全的身份认证并与外部连通的解决方案。&lt;/li>
&lt;li>&lt;strong>Kubeadm Adoption&lt;/strong>：提高 kubeadm 工具的采用率。&lt;/li>
&lt;li>&lt;strong>Resource Management&lt;/strong>J：资源隔离和提高资源利用率。&lt;/li>
&lt;/ul>
&lt;p>详细信息请参考 &lt;a href="https://github.com/kubernetes/community/blob/master/sig-list.md" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/sig-list.md&lt;/a>&lt;/p></description></item><item><title>testing</title><link>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/testing/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ng-tech.icu/books/k8s-notes/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2020-jimmysong-kubernetes-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/17.%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/testing/</guid><description>&lt;hr>
&lt;h2 id="type-book">weight: 106
title: 测试 Kubernetes
date: &amp;ldquo;2022-05-21T00:00:00+08:00&amp;rdquo;
type: book&lt;/h2>
&lt;p>这篇文章将指导你如何测试 Kubernetes。&lt;/p>
&lt;h2 id="单元测试">单元测试&lt;/h2>
&lt;p>单元测试仅依赖于源代码，是测试代码逻辑是否符合预期的最简单方法。&lt;/p>
&lt;p>&lt;strong>运行所有的单元测试&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code>make test
&lt;/code>&lt;/pre>&lt;p>&lt;strong>仅测试指定的 package&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 单个package&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make &lt;span class="nb">test&lt;/span> &lt;span class="nv">WHAT&lt;/span>&lt;span class="o">=&lt;/span>./pkg/api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 多个packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make &lt;span class="nb">test&lt;/span> &lt;span class="nv">WHAT&lt;/span>&lt;span class="o">=&lt;/span>./pkg/&lt;span class="o">{&lt;/span>api,kubelet&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者，也可以直接用 &lt;code>go test&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">go &lt;span class="nb">test&lt;/span> -v k8s.io/kubernetes/pkg/kubelet
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>仅测试指定 package 的某个测试 case&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code># Runs TestValidatePod in pkg/api/validation with the verbose flag set
make test WHAT=./pkg/api/validation KUBE_GOFLAGS=&amp;#34;-v&amp;#34; KUBE_TEST_ARGS=&amp;#39;-run ^TestValidatePod$&amp;#39;
# Runs tests that match the regex ValidatePod|ValidateConfigMap in pkg/api/validation
make test WHAT=./pkg/api/validation KUBE_GOFLAGS=&amp;#34;-v&amp;#34; KUBE_TEST_ARGS=&amp;#34;-run ValidatePod\|ValidateConfigMap$&amp;#34;
&lt;/code>&lt;/pre>&lt;p>或者直接用 &lt;code>go test&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>go test -v k8s.io/kubernetes/pkg/api/validation -run ^TestValidatePod$
&lt;/code>&lt;/pre>&lt;p>&lt;strong>并行测试&lt;/strong>&lt;/p>
&lt;p>并行测试是 root out flakes 的一种有效方法：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Have 2 workers run all tests 5 times each (10 total iterations).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make &lt;span class="nb">test&lt;/span> &lt;span class="nv">PARALLEL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ITERATION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>生成测试报告&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code>make test KUBE_COVER=y
&lt;/code>&lt;/pre>&lt;h2 id="benchmark-测试">Benchmark 测试&lt;/h2>
&lt;pre tabindex="0">&lt;code>go test ./pkg/apiserver -benchmem -run=XXX -bench=BenchmarkWatch
&lt;/code>&lt;/pre>&lt;h2 id="集成测试">集成测试&lt;/h2>
&lt;p>Kubernetes 集成测试需要安装 etcd（只要安装即可，不需要启动），比如&lt;/p>
&lt;pre tabindex="0">&lt;code>hack/install-etcd.sh # Installs in ./third_party/etcd
echo export PATH=&amp;#34;\$PATH:$(pwd)/third_party/etcd&amp;#34; &amp;gt;&amp;gt; ~/.profile # Add to PATH
&lt;/code>&lt;/pre>&lt;p>集成测试会在需要的时候自动启动 etcd 和 kubernetes 服务，并运行 &lt;a href="https://github.com/kubernetes/kubernetes/tree/master/test/integration" target="_blank" rel="noopener">test/integration&lt;/a> 里面的测试。&lt;/p>
&lt;p>&lt;strong>运行所有集成测试&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">make test-integration &lt;span class="c1"># Run all integration tests.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>指定集成测试用例&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Run integration test TestPodUpdateActiveDeadlineSeconds with the verbose flag set.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make test-integration &lt;span class="nv">KUBE_GOFLAGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-v&amp;#34;&lt;/span> &lt;span class="nv">KUBE_TEST_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-run ^TestPodUpdateActiveDeadlineSeconds&lt;/span>$&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="end-to-end-e2e-测试">End to end (e2e) 测试&lt;/h2>
&lt;p>End to end (e2e) 测试模拟用户行为操作 Kubernetes，用来保证 Kubernetes 服务或集群的行为完全符合设计预期。&lt;/p>
&lt;p>在开启 e2e 测试之前，需要先编译测试文件，并设置 KUBERNETES_PROVIDER（默认为 gce）：&lt;/p>
&lt;pre tabindex="0">&lt;code>make WHAT=&amp;#39;test/e2e/e2e.test&amp;#39;
make ginkgo
export KUBERNETES_PROVIDER=local
&lt;/code>&lt;/pre>&lt;p>&lt;strong>启动 cluster，测试，最后停止 cluster&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># build Kubernetes, up a cluster, run tests, and tear everything down&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --build --up --test --down
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>仅测试指定的用例&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -v -test --test_args&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;--ginkgo.focus=Kubectl\sclient\s\[k8s\.io\]\sKubectl\srolling\-update\sshould\ssupport\srolling\-update\sto\ssame\simage\s\[Conformance\]$&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>略过测试用例&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --test --test_args&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--ginkgo.skip=Pods.*env
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>并行测试&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Run tests in parallel, skip any that must be run serially&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GINKGO_PARALLEL&lt;/span>&lt;span class="o">=&lt;/span>y go run hack/e2e.go --v --test --test_args&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--ginkgo.skip=\[Serial\]&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Run tests in parallel, skip any that must be run serially and keep the test namespace if test failed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GINKGO_PARALLEL&lt;/span>&lt;span class="o">=&lt;/span>y go run hack/e2e.go --v --test --test_args&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--ginkgo.skip=\[Serial\] --delete-namespace-on-failure=false&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>清理测试&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --down
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>有用的 &lt;code>-ctl&lt;/code>&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -ctl can be used to quickly call kubectl against your e2e cluster. Useful for&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cleaning up after a failed test or viewing logs. Use -v to avoid suppressing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># kubectl output.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v -ctl&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;get events&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v -ctl&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;delete pod foobar&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="fedaration-e2e-测试">Fedaration e2e 测试&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">FEDERATION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">E2E_ZONES&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;us-central1-a us-central1-b us-central1-f&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># or export FEDERATION_PUSH_REPO_BASE=&amp;#34;quay.io/colin_hom&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">FEDERATION_PUSH_REPO_BASE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;gcr.io/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">GCE_PROJECT_NAME&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># build container images&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KUBE_RELEASE_RUN_TESTS&lt;/span>&lt;span class="o">=&lt;/span>n &lt;span class="nv">KUBE_FASTBUILD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span> go run hack/e2e.go -- -v -build
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># push the federation container images&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">build/push-federation-images.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Deploy federation control plane&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Finally, run the tests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --test --test_args&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--ginkgo.focus=\[Feature:Federation\]&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Don&amp;#39;t forget to teardown everything down&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">go run hack/e2e.go -- -v --down
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以用 &lt;code>cluster/log-dump.sh &amp;lt;directory&amp;gt;&lt;/code> 方便的下载相关日志，帮助排查测试中碰到的问题。&lt;/p>
&lt;h2 id="node-e2e-测试">Node e2e 测试&lt;/h2>
&lt;p>Node e2e 仅测试 Kubelet 的相关功能，可以在本地或者集群中测试&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBERNETES_PROVIDER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make test-e2e-node &lt;span class="nv">FOCUS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;InitContainer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make test_e2e_node &lt;span class="nv">TEST_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--experimental-cgroups-per-qos=true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="补充说明">补充说明&lt;/h2>
&lt;p>借助 kubectl 的模版可以方便获取想要的数据，比如查询某个 container 的镜像的方法为&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">kubectl get pods nginx-4263166205-ggst4 -o template &lt;span class="s1">&amp;#39;--template={{if (exists . &amp;#34;status&amp;#34; &amp;#34;containerStatuses&amp;#34;)}}{{range .status.containerStatuses}}{{if eq .name &amp;#34;nginx&amp;#34;}}{{.image}}{{end}}{{end}}{{end}}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubernetes-测试工具集-test-infra">kubernetes 测试工具集 test-infra&lt;/h2>
&lt;p>&lt;a href="https://github.com/kubernetes/test-infra" target="_blank" rel="noopener">test-infra&lt;/a> 是由 kubernetes 官方开源的测试框架，其中包括了 Kubernetes 测试工具集和测试结果展示。下图展示了 test-infra 的架构：&lt;/p>
&lt;p>
&lt;figure id="figure-test-infra架构图图片来自官方github">
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="https://assets.ng-tech.icu/book/kubernetes-handbook/kubernetes-test-architecture.jpg" alt="test-infra架构图（图片来自官方GitHub）" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;figcaption>
test-infra架构图（图片来自官方GitHub）
&lt;/figcaption>&lt;/figure>&lt;/p>
&lt;p>该测试框架主要是真多 Google 公有云做的，支持 kubernetes1.6 以上版本的测试。详见 &lt;a href="https://github.com/kubernetes/test-infra" target="_blank" rel="noopener">https://github.com/kubernetes/test-infra&lt;/a>。&lt;/p>
&lt;h2 id="参考文档">参考文档&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes/test-infra" target="_blank" rel="noopener">https://github.com/kubernetes/test-infra&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>