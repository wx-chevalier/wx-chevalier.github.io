<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="DaemonSet ** DaemonSet ** is basically the same as ReplicaSet, with the difference that when you use DaemonSet you do not specify the number of replicas, it will go up one pod per node in your cluster.
It is always interesting when creating, using and abusing labels, so you will be able to have better flexibility in the most appropriate distribution of your application.
It is very interesting for services that need to run on all nodes in the cluster, such as log collectors and monitoring agents.
Let&rsquo;s create our first DaemonSet:
I came first daemonset.yaml
The content should be as follows:"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.fab3cd1900ae35687457073b2d518207.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/"><meta property="og:title" content="DaemonSet | Next-gen Tech Edu"><meta property="og:description" content="DaemonSet ** DaemonSet ** is basically the same as ReplicaSet, with the difference that when you use DaemonSet you do not specify the number of replicas, it will go up one pod per node in your cluster.
It is always interesting when creating, using and abusing labels, so you will be able to have better flexibility in the most appropriate distribution of your application.
It is very interesting for services that need to run on all nodes in the cluster, such as log collectors and monitoring agents.
Let&rsquo;s create our first DaemonSet:
I came first daemonset.yaml
The content should be as follows:"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>DaemonSet | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=d53cf1bd21eb9e37d248183b50077db9><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">声明与管理</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id3deea3c14cdea93b81ebf50943b480f5")' href=#id3deea3c14cdea93b81ebf50943b480f5 aria-expanded=false aria-controls=id3deea3c14cdea93b81ebf50943b480f5 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/>Deployment</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id3deea3c14cdea93b81ebf50943b480f5 aria-expanded=false aria-controls=id3deea3c14cdea93b81ebf50943b480f5><i class="fa-solid fa-angle-down" id=caret-id3deea3c14cdea93b81ebf50943b480f5></i></a></div><ul class="nav docs-sidenav collapse show" id=id3deea3c14cdea93b81ebf50943b480f5><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idc064d7b030310d5597b2597b5c2cdcc0")' href=#idc064d7b030310d5597b2597b5c2cdcc0 aria-expanded=false aria-controls=idc064d7b030310d5597b2597b5c2cdcc0 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E6%A1%88%E4%BE%8B/>案例</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idc064d7b030310d5597b2597b5c2cdcc0 aria-expanded=false aria-controls=idc064d7b030310d5597b2597b5c2cdcc0><i class="fa-solid fa-angle-right" id=caret-idc064d7b030310d5597b2597b5c2cdcc0></i></a></div><ul class="nav docs-sidenav collapse" id=idc064d7b030310d5597b2597b5c2cdcc0><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E6%A1%88%E4%BE%8B/%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8/>集群应用</a></li><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E6%A1%88%E4%BE%8B/%E7%AE%80%E5%8D%95%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8/>简单无状态应用</a></li><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E6%A1%88%E4%BE%8B/%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8/>有状态应用</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id036bea786ec821b8143e9f1604cfdbf9")' href=#id036bea786ec821b8143e9f1604cfdbf9 aria-expanded=false aria-controls=id036bea786ec821b8143e9f1604cfdbf9 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/>声明与管理</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id036bea786ec821b8143e9f1604cfdbf9 aria-expanded=false aria-controls=id036bea786ec821b8143e9f1604cfdbf9><i class="fa-solid fa-angle-down" id=caret-id036bea786ec821b8143e9f1604cfdbf9></i></a></div><ul class="nav docs-sidenav collapse show" id=id036bea786ec821b8143e9f1604cfdbf9><li class="child level active"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/daemonset/>DaemonSet</a></li><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/deployment/>Deployment</a></li><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/replicaset/>ReplicaSet</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id097ec02762192176c10495d2f21aa6ff")' href=#id097ec02762192176c10495d2f21aa6ff aria-expanded=false aria-controls=id097ec02762192176c10495d2f21aa6ff aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E9%99%90%E5%88%B6%E4%B8%8E%E8%B0%83%E5%BA%A6/>限制与调度</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id097ec02762192176c10495d2f21aa6ff aria-expanded=false aria-controls=id097ec02762192176c10495d2f21aa6ff><i class="fa-solid fa-angle-right" id=caret-id097ec02762192176c10495d2f21aa6ff></i></a></div><ul class="nav docs-sidenav collapse" id=id097ec02762192176c10495d2f21aa6ff><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E9%99%90%E5%88%B6%E4%B8%8E%E8%B0%83%E5%BA%A6/%E8%8A%82%E7%82%B9%E8%B0%83%E5%BA%A6/>节点调度</a></li><li class="child level"><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E9%99%90%E5%88%B6%E4%B8%8E%E8%B0%83%E5%BA%A6/%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/>资源限制</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>DaemonSet</h1><div class=article-style><h1 id=daemonset>DaemonSet</h1><p>** DaemonSet ** is basically the same as ReplicaSet, with the difference that when you use DaemonSet you do not specify the number of replicas, it will go up one pod per node in your cluster.</p><p>It is always interesting when creating, using and abusing labels, so you will be able to have better flexibility in the most appropriate distribution of your application.</p><p>It is very interesting for services that need to run on all nodes in the cluster, such as log collectors and monitoring agents.</p><p>Let&rsquo;s create our first DaemonSet:</p><p><code>I came first daemonset.yaml</code></p><p>The content should be as follows:</p><p><code>yaml apiVersion: apps / v1 kind: DaemonSet metadata: name: daemon-set-first spec: selector: matchLabels: system: Strigus template: metadata: labels: system: Strigus spec: containers: - name: nginx image: nginx: 1.7.9 ports: - containerPort: 80</code></p><p>But first let’s allow all of our nodes to run pods:</p><pre tabindex=0><code>kubectl taint nodes --all node-role.kubernetes.io/master-

node / elliot-01 untainted
taint &#34;node-role.kubernetes.io/master:&#34; not found
taint &#34;node-role.kubernetes.io/master:&#34; not found
</code></pre><p>Now we can create our DaemonSet:</p><pre tabindex=0><code>kubectl create -f first-daemonset.yaml

daemonset.extensions / daemon-set-first created
</code></pre><p>Let&rsquo;s list our DaemonSet:</p><pre tabindex=0><code>kubectl get daemonset

NAME DESIRED CURRENT READY UP-TO-DATE ... AGE
daemon-set-first 3 3 3 3 30s
</code></pre><p>Viewing the DaemonSet details:</p><pre tabindex=0><code>kubectl describe ds daemon-set-first

Name: daemon-set-first
Selector: system = Strigus
Node-Selector: &lt;none&gt;
Labels: system = Strigus
Annotations: &lt;none&gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = Strigus
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
Events:
Type Reason Age From Message

---

Normal SuccessfulCreate 41s daemonset-controller Created pod: daemon-set-first-jl6f5
Normal SuccessfulCreate 412 daemonset-controller Created pod: daemon-set-first-jh2sp
Normal SuccessfulCreate 412 daemonset-controller Created pod: daemon-set-first-t9rv9
</code></pre><p>Viewing pod details:</p><pre tabindex=0><code>kubectl get pods -o wide

NAME READY STATUS RESTARTS AGE .. NODE
daemon-set-first .. 1/1 Running 0 1m elliot-01
daemon-set-first .. 1/1 Running 0 1m elliot-02
daemon-set-first .. 1/1 Running 0 1m elliot-03
</code></pre><p>As we can see we have one pod per node running our <code>daemon-set-first</code>.</p><p>Let&rsquo;s change the image of this pod directly in DaemonSet, using the command <code>kubectl set</code>:</p><pre tabindex=0><code>kubectl set image ds daemon-set-first nginx = nginx: 1.15.0

daemonset.extensions / daemon-set-first image updated
</code></pre><p>Let&rsquo;s confirm that the image has really been changed:</p><pre tabindex=0><code>kubectl describe ds daemon-set-first

Name: daemon-set-first
Selector: system = Strigus
Node-Selector: &lt;none&gt;
Labels: system = Strigus
Annotations: &lt;none&gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 0
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = Strigus
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
Events:
Type Reason Age From Message

---

Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-jl6f5
Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-jh2sp
Normal SuccessfulCreate 2m daemonset-controller Created pod: daemon-set-first-t9rv9
</code></pre><p>Now let&rsquo;s check if the pod images are up to date:</p><pre tabindex=0><code>kubectl get pods

NAME READY STATUS RESTARTS AGE
daemon-set-first-jh2sp 1/1 Running 0 2m
daemon-set-first-jl6f5 1/1 Running 0 2m
daemon-set-first-t9rv9 1/1 running 0 2m
</code></pre><p>As we can see, we had no restart on the pods.</p><p>Let&rsquo;s check the image running on one of the pods:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-jh2sp | grep -i image:

Image: nginx: 1.7.9
</code></pre><p>Exactly, we were unable to change information from the running DaemonSet.</p><p>What if the pod is deleted?</p><pre tabindex=0><code>kubectl delete pod daemon-set-first-jh2sp

pod &#34;daemon-set-first-jh2sp&#34; deleted
</code></pre><p>Viewing the pods:</p><pre tabindex=0><code>kubectl get pods

NAME READY STATUS RESTARTS AGE
daemon-set-first-hp4qc 1/1 Running 0 3s
daemon-set-first-jl6f5 1/1 running 0 10m
daemon-set-first-t9rv9 1/1 running 0 10m
</code></pre><p>Let&rsquo;s list the new Pod that was created, after deleting the old Pod:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-hp4qc | grep -i image:

    Image: nginx: 1.15.0
</code></pre><p>Now a Pod that was already running:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-jl6f5 | grep -i image:

    Image: nginx: 1.7.9
</code></pre><p>As we can see, to update all the pods in DaemonSet we need to recreate it or destroy all the pods related to it, but isn&rsquo;t that too bad? Yes, it&rsquo;s really bad. To improve our lives we have the option <code>RollingUpdate</code> that we will see in the next chapter.</p><h1 id=rollouts-and-rollbacks>Rollouts and Rollbacks</h1><p>Now let&rsquo;s imagine that our last edition using the command <code>kubectl set</code> in DaemonSet was not correct and we need to go back to the previous configuration, where the image version was different, how do we do it?</p><p>It&rsquo;s very simple, for that there is <em>Rollout</em>. With it you can check what were the changes that happened in your Deployment or DaemonSet, as if it were a version. Look! (With the voice of Nelson Rubens)</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first

daemonsets &#34;daemon-set-first&#34;
REVISION CHANGE-CAUSE
1 &lt;none&gt;
2 &lt;none&gt;
</code></pre><p>It will show two lines, the first which is the original, with the image of <code>nginx: 1.7.9</code> and the second already with the image <code>nginx: 1.15.0</code>. The information is not very detailed, do you agree?</p><p>Here&rsquo;s how to check the details of each of these entries, which are called ** revision **.</p><p>Viewing revision 1:</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first --revision = 1

daemonsets &#34;daemon-set-first&#34; with revision # 1
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
</code></pre><p>Viewing revision 2:</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first --revision = 2

daemonsets &#34;daemon-set-first&#34; with revision # 2
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
</code></pre><p>To return to the desired revision, simply do the following:</p><pre tabindex=0><code>kubectl rollout undo ds daemon-set-first --to-revision = 1

daemonset.extensions / daemon-set-first rolled back
</code></pre><p>Notice that we changed the <code>history</code> for <code>undo</code> and the <code>revision</code> for <code>to-revision</code>, so we will do the ** rollback ** in our DaemonSet, and return the version of the image that we wish. 😃</p><hr><blockquote><p>NOTE: By default, DaemonSet stores only the last 10 revisions. To change the maximum number of revisions in our Daemonset, run the following command.
Source: <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy target=_blank rel=noopener>https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy</a></p></blockquote><hr><p><code>kubectl edit daemonsets.apps daemon-set-first</code></p><p>Change the quantity in the <code>revisionHistoryLimit</code> parameter:</p><p><code>yaml revisionHistoryLimit: 10</code></p><hr><p>Returning to our line of reasoning, to follow the rollout, execute the following command:</p><p><code>kubectl rollout status ds daemon-set-first</code></p><p>Let&rsquo;s confirm that we are already running the new image and one of our pods:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-hp4qc | grep -i image:

Image: nginx: 1.15.0
</code></pre><p>It didn&rsquo;t work, why? Because we will have to kill the Pod to be recreated with the new settings.</p><p>Let&rsquo;s fine-tune our DaemonSet, add the RollingUpdate and this guy will automatically update the Pods when there are changes.</p><p>Come on, first let&rsquo;s remove the <code>DaemonSet</code>, add two new information to our yaml manifest and then create another DaemonSet instead:</p><pre tabindex=0><code>kubectl delete -f first-daemonset.yaml

daemonset.extensions &#34;daemon-set-first&#34; deleted
</code></pre><p>Edit the <code>first-daemonset.yaml</code> file.</p><p><code>I came first daemonset.yaml</code></p><p>The content should be as follows:</p><p><code>yaml apiVersion: apps / v1 kind: DaemonSet metadata: name: daemon-set-first spec: selector: matchLabels: system: Strigus template: metadata: labels: system: Strigus spec: containers: - name: nginx image: nginx: 1.7.9 ports: - containerPort: 80 updateStrategy: type: RollingUpdate</code></p><p>Create the DaemonSet:</p><pre tabindex=0><code>kubectl create -f first-daemonset.yaml

daemonset.extensions / daemon-set-first created
</code></pre><p>Success, let&rsquo;s check if our DaemonSet has started up correctly.</p><pre tabindex=0><code>kubectl get daemonset

NAME DESIRED CURRENT READY ... AGE
daemon-set-first 3 3 3 ... 5m
</code></pre><p>Viewing the DaemonSet details:</p><pre tabindex=0><code>kubectl describe ds daemon-set-first

Name: daemon-set-first
Selector: system = DaemonOne
Node-Selector: &lt;none&gt;
Labels: system = DaemonOne
Annotations: &lt;none&gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
Events:
Type Reason Age From Message

---

Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-52k8k
Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-6sln2
Normal SuccessfulCreate 5m daemonset-controller Created pod: daemon-set-first-9v2w9
daemonset-controller Created pod: daemon-set-first-9dktj
</code></pre><p>Let&rsquo;s check out our newly added <code>RollingUpdate</code> configuration:</p><pre tabindex=0><code>kubectl get ds daemon-set-first -o yaml | grep -A 2 Strategy

updateStrategy:
rollingUpdate:
maxUnavailable: 1
</code></pre><p>Now with our DaemonSet already configured, let&rsquo;s change that same <code>nginx</code> image and see what actually happens:</p><pre tabindex=0><code>kubectl set image ds daemon-set-first nginx = nginx: 1.15.0

daemonset.extensions / daemon-set-first image updated
</code></pre><p>Let&rsquo;s list the DaemonSet and the Pods to make sure nothing is broken:</p><pre tabindex=0><code>kubectl get daemonset

NAME DESIRED CURRENT READY ... AGE
daemon-set-first 3 3 3 ... 6m
</code></pre><p>Viewing the pods:</p><pre tabindex=0><code>kubectl get pods -o wide

NAME READY STATUS RESTARTS AGE NODE
daemon-set-first-7m ... 1/1 Running 0 10s elliot-02
daemon-set-first-j7 ... 1/1 Running 0 10s elliot-03
daemon-set-first-v5 ... 1/1 Running 0 10s elliot-01
</code></pre><p>As we can see, our DaemonSet has remained the same, but the Pods have been recreated, we will detail the DaemonSet to see the changes made.</p><pre tabindex=0><code>kubectl describe ds daemon-set-first

Name: daemon-set-first
Selector: system = DaemonOne
Node-Selector: &lt;none&gt;
Labels: system = DaemonOne
Annotations: &lt;none&gt;
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status: 3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
Events:
Type Reason Age From Message

---

Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-52k8k
Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-6sln2
Normal SuccessfulCreate 8m daemonset-controller Created pod: daemon-set-first-9v2w9
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-6sln2
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-j788v
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-52k8k
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-7mpwr
Normal SuccessfulDelete 10m daemonset-controller Deleted pod: daemon-set-first-9v2w9
Normal SuccessfulCreate 1m daemonset-controller Created pod: daemon-set-first-v5m47
</code></pre><p>Look how cool! If we look at the ** Events ** field we can see that the <code>RollingUpdate</code> killed the old pods and recreated with the new image that we changed using the <code>kubectl set</code>.</p><p>We can also check in one of the Pods if this change really happened.</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-j788v | grep -i image:

Image: nginx: 1.15.0
</code></pre><p>See? Very sensational this business of <code>RollingUpdate</code>.</p><p>Let&rsquo;s check out our change history:</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first

daemonsets &#34;daemon-set-first&#34;
REVISION CHANGE-CAUSE
1 &lt;none&gt;
2 &lt;none&gt;
</code></pre><p>Yes, we have two changes. Let&rsquo;s drill down to see which is which.</p><p>Viewing revision 1:</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first --revision = 1

daemonsets &#34;daemon-set-first&#34; with revision # 1
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.7.9
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
</code></pre><p>Viewing revision 2:</p><pre tabindex=0><code>kubectl rollout history ds daemon-set-first --revision = 2

daemonsets &#34;daemon-set-first&#34; with revision # 2
Pod Template:
Labels: system = DaemonOne
Containers:
nginx:
Image: nginx: 1.15.0
Port: 80 / TCP
Host Port: 0 / TCP
Environment: &lt;none&gt;
Mounts: &lt;none&gt;
Volumes: &lt;none&gt;
</code></pre><p>Now let&rsquo;s rollback our DaemonSet to revision 1:</p><pre tabindex=0><code>kubectl rollout undo ds daemon-set-first --to-revision = 1

daemonset.extensions / daemon-set-first rolled back
kubectl rollout undo ds daem kubectl rollout undo ds daem
</code></pre><p>Viewing the pods:</p><pre tabindex=0><code>kubectl get pods

NAME READY STATUS RESTARTS AGE
daemon-set-first-c2jjk 1/1 Running 0 19s
daemon-set-first-hrn48 1/1 Running 0 19s
daemon-set-first-t6mr9 1/1 Running 0 19s
</code></pre><p>Viewing pod details:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-c2jjk | grep -i image:

Image: nginx: 1.7.9
</code></pre><p>Sensational isn&rsquo;t it?</p><p>Did it go bad?</p><p>Just return to the other setting:</p><pre tabindex=0><code>kubectl rollout undo ds daemon-set-first --to-revision = 2

daemonset.extensions / daemon-set-first rolled back
</code></pre><p>Viewing the rollout status:</p><pre tabindex=0><code>kubectl rollout status ds daemon-set-first

daemon set &#34;daemon-set-first&#34; successfully rolled out
</code></pre><p>Viewing the pods:</p><pre tabindex=0><code>kubectl get pods

NAME READY STATUS RESTARTS AGE
daemon-set-first-jzck9 1/1 Running 0 32s
daemon-set-first-td7h5 1/1 Running 0 29s
daemon-set-first-v5c86 1/1 Running 0 40s
</code></pre><p>Viewing pod details:</p><pre tabindex=0><code>kubectl describe pod daemon-set-first-jzck9 | grep -i image:

Image: nginx: 1.15.0
</code></pre><p>Now let&rsquo;s delete our DaemonSet:</p><pre tabindex=0><code>kubectl delete ds daemon-set-first

daemonset.extensions &#34;daemon-set-first&#34; deleted
</code></pre></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/k8s-notes/02.%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/02.%E6%8E%A7%E5%88%B6%E5%99%A8/deployment/%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%AE%A1%E7%90%86/deployment/ rel=prev>Deployment</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>