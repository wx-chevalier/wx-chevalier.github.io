<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="本文由 简悦 SimpRead 转码， 原文地址 mp.weixin.qq.com int __fastcall bodyEncrypt(JNIEnv *a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8, int a9, int a10) { JNIEnv *v10; // r4 int v11; // r6 int v12; // r5 int v13; // r11 char *v14; // r9 int v15; // ST14_4 int v16; // r6 int v17; // r10 size_t v18; // r0 int v19; // r8 void *v20; // r5 int v21; // r4 int result; // r0 int v23; // [sp+1Ch] [bp-24h] int v24; // [sp+20h] [bp-20h] v10"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8B%E5%8D%B7/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8B%E5%8D%B7/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8B%E5%8D%B7/"><meta property="og:title" content="unidbg 算法还原术 · 某民宿 app 篇 · 下卷 | Next-gen Tech Edu"><meta property="og:description" content="本文由 简悦 SimpRead 转码， 原文地址 mp.weixin.qq.com int __fastcall bodyEncrypt(JNIEnv *a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8, int a9, int a10) { JNIEnv *v10; // r4 int v11; // r6 int v12; // r5 int v13; // r11 char *v14; // r9 int v15; // ST14_4 int v16; // r6 int v17; // r10 size_t v18; // r0 int v19; // r8 void *v20; // r5 int v21; // r4 int result; // r0 int v23; // [sp+1Ch] [bp-24h] int v24; // [sp+20h] [bp-20h] v10"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>unidbg 算法还原术 · 某民宿 app 篇 · 下卷 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=c3b46fc27f0df3c053bf34abccc27c80><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">99.参考资料</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ida13f9287bee731f41102d5bd6b06508c")' href=#ida13f9287bee731f41102d5bd6b06508c aria-expanded=false aria-controls=ida13f9287bee731f41102d5bd6b06508c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/>逆向工程</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ida13f9287bee731f41102d5bd6b06508c aria-expanded=false aria-controls=ida13f9287bee731f41102d5bd6b06508c><i class="fa-solid fa-angle-down" id=caret-ida13f9287bee731f41102d5bd6b06508c></i></a></div><ul class="nav docs-sidenav collapse show" id=ida13f9287bee731f41102d5bd6b06508c><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id86bfc41c09c9dc360469558f7d6c003b")' href=#id86bfc41c09c9dc360469558f7d6c003b aria-expanded=false aria-controls=id86bfc41c09c9dc360469558f7d6c003b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/>99.参考资料</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id86bfc41c09c9dc360469558f7d6c003b aria-expanded=false aria-controls=id86bfc41c09c9dc360469558f7d6c003b><i class="fa-solid fa-angle-down" id=caret-id86bfc41c09c9dc360469558f7d6c003b></i></a></div><ul class="nav docs-sidenav collapse show" id=id86bfc41c09c9dc360469558f7d6c003b><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2021-%E6%98%A5%E8%8A%82%E5%AE%89%E5%8D%93%E4%B8%AD%E7%BA%A7%E9%A2%98%E9%80%86%E5%90%91%E6%80%BB%E7%BB%93/>【2021 春节】安卓中级题逆向总结</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E8%BD%AC%E8%BD%BDunidbg-hook-%E5%A4%A7%E5%85%A8-seeflowerx/>【转载】Unidbg Hook 大全 - SeeFlowerX</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/2022-%E6%9F%90%E5%AE%89%E5%8D%93-crackme-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/>2022 某安卓 Crackme 流程分析</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/app-%E9%80%86%E5%90%91-%E5%B9%B3%E5%A4%B4%E5%93%A5%E5%AE%9E%E6%88%98%E6%9F%90%E5%86%9C%E4%BA%A7%E5%93%81-app/>app 逆向 平头哥实战（某农产品 app）</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/frida-android-hook-_-sakura-%E3%81%AE-blog/>Frida Android hook _ Sakura の blog</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/frida-%E5%85%8D-root-hook/>frida 免 root hook</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/getbyte-%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%BF%98%E5%8E%9F-seeflowerx/>getByte 算法分析与还原 - SeeFlowerX</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/js-ast-%E4%BA%8C%E9%83%A8%E6%9B%B2%E6%9F%90-v5-%E7%BB%9D%E5%AF%B9%E4%B8%8D%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86-%E4%B8%80%E6%8E%A2%E7%A9%B6%E7%AB%9F/>Js Ast 二部曲：某 V5 “绝对不可逆加密” 一探究竟</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/js-ast-%E4%B8%80%E9%83%A8%E6%9B%B2%E9%AB%98%E5%AE%8C%E6%95%B4%E5%BA%A6%E8%BF%98%E5%8E%9F%E6%9F%90-v5-%E7%9A%84%E5%8A%A0%E5%AF%86/>Js Ast 一部曲：高完整度还原某 V5 的加密</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/js-%E7%A0%B4%E8%A7%A3%E4%B9%8B%E8%A1%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%9B%91%E6%8E%A7%E6%96%B9%E5%BC%8F/>js 破解之补浏览器环境的两种监控方式</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/mtgsig2.1-%E7%89%88%E6%9C%AC%E4%B9%8B-a5-%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/>mtgsig2.1 版本之 a5 算法分析</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/protobuf-%E5%8D%8F%E8%AE%AE%E9%80%86%E5%90%91%E8%A7%A3%E6%9E%90-app-%E7%88%AC%E8%99%AB-/>Protobuf 协议逆向解析 - APP 爬虫</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/proxy-%E4%BB%A3%E7%90%86%E4%BA%8C%E6%AC%A1%E4%BF%AE%E6%94%B9/>Proxy 代理（二次修改）</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/python-%E7%88%AC%E8%99%AB%E8%BF%9B%E9%98%B6%E5%BF%85%E5%A4%87-_-js-%E9%80%86%E5%90%91%E4%B9%8B%E8%A1%A5%E7%8E%AF%E5%A2%83%E5%88%B0%E5%BA%95%E6%98%AF%E5%9C%A8%E8%A1%A5%E4%BB%80%E4%B9%88/>Python 爬虫进阶必备 _ Js 逆向之补环境到底是在补什么？</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8A%E5%8D%B7/>unidbg 算法还原术 · 某民宿 app 篇 · 上卷</a></li><li class="child level active"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8B%E5%8D%B7/>unidbg 算法还原术 · 某民宿 app 篇 · 下卷</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%AD%E5%8D%B7/>unidbg 算法还原术 · 某民宿 app 篇 · 中卷</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E5%A4%A7%E7%8C%BF%E6%90%9C%E9%A2%98-sign-so-%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90unidbg/>大猿搜题 sign so 加密参数分析｜unidbg</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA-android-%E9%80%9A%E7%94%A8-svc-%E8%B7%9F%E8%B8%AA%E4%BB%A5%E5%8F%8A-hook-%E6%96%B9%E6%A1%88frida-seccomp/>分享一个 Android 通用 svc 跟踪以及 hook 方案——Frida-Seccomp</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E6%9F%90%E4%B9%8E%E8%AF%B7%E6%B1%82%E5%A4%B4%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/>某乎请求头签名算法分析</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E6%9F%90%E5%92%96%E5%95%A1-app-%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90%E8%BF%9B%E9%98%B6%E7%89%88/>某咖啡 app 加密参数分析进阶版</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E5%8F%8D%E8%B0%83%E8%AF%95-+-ollvm-%E6%B7%B7%E6%B7%86%E7%9A%84-crackme/>逆向分析反调试 + ollvm 混淆的 Crackme</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E7%88%AC%E8%99%AB%E4%B9%8B-%E6%9F%90%E7%94%9F%E9%B2%9C-app-%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/>爬虫之 - 某生鲜 APP 加密参数逆向分析</a></li><li class="child level"><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90-ja3-%E6%8C%87%E7%BA%B9%E5%8F%8A%E7%AA%81%E7%A0%B4/>深度剖析 ja3 指纹及突破</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>unidbg 算法还原术 · 某民宿 app 篇 · 下卷</h1><div class=article-style><blockquote><p>本文由 <a href=http://ksria.com/simpread/ target=_blank rel=noopener>简悦 SimpRead</a> 转码， 原文地址 <a href="https://mp.weixin.qq.com/s?__biz=MzA4MjA5NDE1OQ==&mid=2247485139&idx=1&sn=6875f205e642ef27880c8935e7756217&chksm=9f8bb7f3a8fc3ee592dc4320a8996179b975214319ad8ba1434dff2c3c90f6bbbcc26137dd6a&mpshare=1&scene=1&srcid=1030u3BXGR0GFJ5hM59qxMBf&sharer_sharetime=1635588940320&sharer_shareid=56da189f782ce62249ab4f6494feca50&version=3.1.20.90367&platform=mac#rd" target=_blank rel=noopener>mp.weixin.qq.com</a></p></blockquote><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_jpg/icBZkwGO7uH7Gwg06nY3t8zv0Pz9icqpy3xBMR1a091Vb8Zxc7LcpA3Q6GDeLSF6NYbVPaAygKTuwSZh0Dk1IqPw/640?wx_fmt=jpeg" alt loading=lazy data-zoomable></div></div></figure><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_jpg/icBZkwGO7uH7Gwg06nY3t8zv0Pz9icqpy3wwia1uOgibv9l3txQaMYIUic4HpoefGKIy9d9xpGDgnBDcXmJEONBuNtQ/640?wx_fmt=jpeg" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>int __fastcall bodyEncrypt(JNIEnv *a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8, int a9, int a10)
{
  JNIEnv *v10; // r4
  int v11; // r6
  int v12; // r5
  int v13; // r11
  char *v14; // r9
  int v15; // ST14_4
  int v16; // r6
  int v17; // r10
  size_t v18; // r0
  int v19; // r8
  void *v20; // r5
  int v21; // r4
  int result; // r0
  int v23; // [sp+1Ch] [bp-24h]
  int v24; // [sp+20h] [bp-20h]
  v10 = a1;
  v11 = a9;
  v12 = a3;
  v13 = a7;
  if ( !a9 )
    v11 = ((*a1)-&gt;NewStringUTF)(a1, &amp;unk_13ECB);
  if ( !a7 )
    v13 = ((*v10)-&gt;NewStringUTF)(v10, &amp;unk_13ECB);
  if ( !v12 )
    v12 = ((*v10)-&gt;NewStringUTF)(v10, &amp;unk_13ECB);
  v14 = ((*v10)-&gt;GetStringUTFChars)(v10, v12, 0);
  v15 = v11;
  v16 = ((*v10)-&gt;GetStringUTFChars)(v10, v11, 0);
  v17 = ((*v10)-&gt;GetStringUTFChars)(v10, v13, 0);
  v23 = 0;
  v18 = strlen(v14);
  v19 = j_tj_crypt(v14, v18, a5, a6, v17, a8, v16, a10, &amp;v23);
  ((*v10)-&gt;ReleaseStringUTFChars)(v10, v12, v14);
  ((*v10)-&gt;ReleaseStringUTFChars)(v10, v13, v17);
  ((*v10)-&gt;ReleaseStringUTFChars)(v10, v15, v16);
  if ( v19 )
  {
    v20 = j_tjtxtutf8(v19, v23, 10);
    v21 = ((*v10)-&gt;NewStringUTF)(v10, v20);
    free(v20);
  }
  else
  {
    v21 = ((*v10)-&gt;NewStringUTF)(v10, &amp;unk_13ECB);
  }
   result = _stack_chk_guard - v24;
  if ( _stack_chk_guard == v24 )
    result = v21;
  return result;
}
</code></pre><p>流程如下</p><pre tabindex=0><code>v19 = j_tj_crypt(v14, v18, a5, a6, v17, a8, v16, a10, &amp;v23);
v20 = j_tjtxtutf8(v19, v23, 10);
v21 = ((*v10)-&gt;NewStringUTF)(v10, v20);
result = v21;
return result;
</code></pre><p>v19 是经过加密函数 j_tj_crypt  加密后生成的 bytes，再经过 j_tjtxtutf8（上篇知道第三个参数为 10 的时候是标准的 base64）base64 编码</p><p>可以打个断点验证下</p><p>j_tjtxtutf8：</p><p>0x38FC 下个断点</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4kBzMcllIeOMlWyRbvalfyvBhkSRRbxNX9aG2JVzbGNpvPAicTqbWcRcFv4riaoiawcDiaxr477qqSSQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>打印 r0 的值，长度是 0x31</p><p>mr0 0x31</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4kBzMcllIeOMlWyRbvalfyz6blLggE2nic2lUDZ4DSe4xhTHZ0xgj1JNHhBj76eQ1ru5nyWgEfQFQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>blr 添加函数结束后断点</p><p>c 跳到下个断点</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4kBzMcllIeOMlWyRbvalfyME1ZsG6CLcS9Rwib9emVuoqL5mOia855LibWJFdULLYbONmJ0O4rpM9ww/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>逆向之友验证</p><pre tabindex=0><code>https://gchq.github.io/CyberChef
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4kBzMcllIeOMlWyRbvalfyK73yjet1iafSVibtlwvGUoHlxiaribZskWia2IoODgHRzzY4YlSQvRkQQIQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>没毛病，接下来看 j_tj_crypt 是怎么生成 v19 的</p><p>进到 tj_crypt 函数</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4QXibVXWOQF6KOgCffrcxgKsAzVOA46uNDEI857Cg9ibn2F9Mfjtlvib2eYErqhQdG1kdUwiczXMAkww/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>看到熟悉的 key 了</p><p>然后这些 &ldquo;1&rdquo;,&ldquo;2&rdquo;,&ldquo;3&rdquo; 是代表加密模式</p><p>stmcmp 是 c 函数</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4QXibVXWOQF6KOgCffrcxgKGNjtslMXkPyEDYCNrQtRss9XtQ6kXmz0QuU3DEyCzEXmjetmvRJhcA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>也就是根据第一个参数的值才决定用哪种加密</p><p>我们可以在 unidbg 上修改第一个参数的值，可以看到三种加密的结果是不一样的</p><pre tabindex=0><code>    public void get_bodyencrypt() throws FileNotFoundException {
        List&lt;Object&gt; list = new ArrayList&lt;&gt;();
        DvmClass Native=vm.resolveClass(&#34;com/tujia/gundam/Gundam&#34;);
        DvmObject&lt;?&gt; jclass =Native.newObject(null);
        String arg0_str = &#34;1&#34;;
        Object arg0 = vm.addLocalObject(new StringObject(vm, arg0_str));
        long arg1 = 1630808396L;
        String arg2_str = &#34;YM0A2TMAIEWA3xMAMM1xTjQEUYGD0wZAYAh32AdgQATDzAZNZA33WAEIZAzzhAMMNAzyTDAkZMzTizYOYN11TTgMRcDThyNMZO44GTIAVQGDi5OONN2wWGMMUVWj1iMNOYxxGmUU&#34;;
        Object arg2 = vm.addLocalObject(new StringObject(vm, arg2_str));
        int arg3 = arg2_str.getBytes(StandardCharsets.UTF_8).length;
        String arg4_str = &#34;{\&#34;code\&#34;:null,\&#34;parameter\&#34;:{\&#34;activityTask\&#34;:{},\&#34;defa&#34;;//&#34;{\&#34;code\&#34;:null,\&#34;parameter\&#34;:{\&#34;activityTask\&#34;:{},\&#34;defaultKeyword\&#34;:\&#34;\&#34;,\&#34;abTest\&#34;:{\&#34;AppSearchHouseList\&#34;:\&#34;B\&#34;,\&#34;listabtest8\&#34;:\&#34;B\&#34;},\&#34;returnNavigations\&#34;:true,\&#34;returnFilterConditions\&#34;:true,\&#34;specialKeyType\&#34;:0,\&#34;returnGeoConditions\&#34;:true,\&#34;abTests\&#34;:{\&#34;T_login_831\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;A\&#34;},\&#34;searchhuojiatujia\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;D\&#34;},\&#34;listfilter_227\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;D\&#34;},\&#34;T_renshu_292\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;D\&#34;},\&#34;Tlisttest_45664\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;C\&#34;},\&#34;Tlist_168\&#34;:{\&#34;s\&#34;:true,\&#34;v\&#34;:\&#34;C\&#34;},\&#34;T_LIST27620\&#34;:{\&#34;s\&#34;:false,\&#34;v\&#34;:\&#34;A\&#34;}},\&#34;pageSize\&#34;:10,\&#34;excludeUnitIdSet\&#34;:null,\&#34;historyConditions\&#34;:[],\&#34;searchKeyword\&#34;:\&#34;\&#34;,\&#34;url\&#34;:\&#34;\&#34;,\&#34;isDirectSearch\&#34;:false,\&#34;sceneCondition\&#34;:null,\&#34;returnAllConditions\&#34;:true,\&#34;searchId\&#34;:null,\&#34;pageIndex\&#34;:0,\&#34;onlyReturnTotalCount\&#34;:false,\&#34;conditions\&#34;:[{\&#34;type\&#34;:2,\&#34;value\&#34;:\&#34;2021-09-05\&#34;},{\&#34;type\&#34;:3,\&#34;value\&#34;:\&#34;2021-09-06\&#34;},{\&#34;label\&#34;:\&#34;大理州\&#34;,\&#34;type\&#34;:1,\&#34;value\&#34;:\&#34;36\&#34;}]},\&#34;client\&#34;:{\&#34;abTest\&#34;:{},\&#34;abTests\&#34;:{},\&#34;adTest\&#34;:{\&#34;m1\&#34;:\&#34;Color OS V5.2.1\&#34;,\&#34;m2\&#34;:\&#34;ade40419318f085ff21b4776f2eef21f\&#34;,\&#34;m3\&#34;:\&#34;armeabi-v7a\&#34;,\&#34;m4\&#34;:\&#34;armeabi\&#34;,\&#34;m5\&#34;:\&#34;100\&#34;,\&#34;m6\&#34;:\&#34;2\&#34;,\&#34;m7\&#34;:\&#34;5\&#34;},\&#34;api_level\&#34;:260,\&#34;appFP\&#34;:\&#34;qA/Ch2zqjORBz90YV34sUZpcFXFV6vzhmAISdTjYAFeqMBTtMUukzQFXqkDokr+sMau0bWClwjtk36nbrVBWVrjmrPTCkXFIraNHdgRVW/QT6g4eLWuM3hhP8qsWgGnrErk2KA+GFxr/OBRMYfV4l0v+TYUDZ5k4bUCUawafdLY5b3aC02SuOrqjW3jjrXiB/dt6ErjrDv44vY4Y8/1r5Z6ut/2BmcErxM37MniKpW6EZc8F4CjJ9S1KRTtEPJ2Kkd2Sd8602jqdgtssJ6QKXyx2+qsKvybydVe+zSTXQGn/T86A6uW0oC+mJHwOLnP8HKN0q2Fu3rTcKZ+Prbs/dcBHaWJi1C1tHZFza2O+1gUQTgvg+Kq57BvE6IjEhveT\&#34;,\&#34;appId\&#34;:\&#34;com.tujia.hotel\&#34;,\&#34;appVersion\&#34;:\&#34;260_260\&#34;,\&#34;appVersionUpdate\&#34;:\&#34;rtag-20210803-183436-zhengyuan\&#34;,\&#34;batteryStatus\&#34;:\&#34;full\&#34;,\&#34;buildTag\&#34;:\&#34;rtag-20210803-183436-zhengyuan\&#34;,\&#34;buildVersion\&#34;:\&#34;8.38.0\&#34;,\&#34;ccid\&#34;:\&#34;51742042410923060391\&#34;,\&#34;channelCode\&#34;:\&#34;qq\&#34;,\&#34;crnVersion\&#34;:\&#34;254\&#34;,\&#34;devModel\&#34;:\&#34;OPPO R11st\&#34;,\&#34;devToken\&#34;:\&#34;\&#34;,\&#34;devType\&#34;:2,\&#34;dtt\&#34;:\&#34;\&#34;,\&#34;electricity\&#34;:\&#34;100\&#34;,\&#34;flutterPkgId\&#34;:\&#34;277\&#34;,\&#34;gps\&#34;:null,\&#34;kaTest\&#34;:{\&#34;k1\&#34;:\&#34;2_1_2\&#34;,\&#34;k2\&#34;:\&#34;sdm660\&#34;,\&#34;k3\&#34;:\&#34;ubuntu-16\&#34;,\&#34;k4\&#34;:\&#34;R11st_11_A.43_200402\&#34;,\&#34;k5\&#34;:\&#34;OPPO/R11st/R11s:8.1.0/OPM1.171019.011/1577198226:user/release-keys\&#34;,\&#34;k6\&#34;:\&#34;R11st\&#34;,\&#34;k7\&#34;:\&#34;OPM1.171019.011\&#34;},\&#34;latitude\&#34;:\&#34;23.105714\&#34;,\&#34;locale\&#34;:\&#34;zh-CN\&#34;,\&#34;longitude\&#34;:\&#34;113.470271\&#34;,\&#34;networkType\&#34;:\&#34;1\&#34;,\&#34;osVersion\&#34;:\&#34;8.1.0\&#34;,\&#34;platform\&#34;:\&#34;1\&#34;,\&#34;salt\&#34;:\&#34;ZMmADTBAMIzAzxMAYMkxWjVEFY2TkwNMZAh2WAdAFATzmAZMYA3wTAEckAzT2AMMMAz52DAIZMzThzYMMN1xWTgYMcDD0yNNMO41zTIQUQGDx5OOZN2wDGMMEVWjziMNZYxxDmUA\&#34;,\&#34;screenInfo\&#34;:\&#34;\&#34;,\&#34;sessionId\&#34;:\&#34;a3e57f1c-03a8-3bc4-8709-fb36e7698ae4_1630844995950\&#34;,\&#34;tId\&#34;:\&#34;21090509553913313246\&#34;,\&#34;tbTest\&#34;:{\&#34;j1\&#34;:\&#34;11d890e2\&#34;,\&#34;j2\&#34;:\&#34;R11s\&#34;,\&#34;j3\&#34;:\&#34;OPPO R11st\&#34;,\&#34;j4\&#34;:\&#34;OPPO\&#34;,\&#34;j5\&#34;:\&#34;OPPO\&#34;,\&#34;j6\&#34;:\&#34;unknown\&#34;,\&#34;j7\&#34;:\&#34;qcom\&#34;,\&#34;j8\&#34;:\&#34;2.1.0  (ART)\&#34;},\&#34;traceid\&#34;:\&#34;1630845462612_1630845462444_1630845358749\&#34;,\&#34;uID\&#34;:\&#34;a3e57f1c-03a8-3bc4-8709-fb36e7698ae4\&#34;,\&#34;version\&#34;:\&#34;260\&#34;,\&#34;wifi\&#34;:null,\&#34;wifimac\&#34;:\&#34;i5ZQ9aI14FDr9VMJ/ECIg7KAOE+Xev1/CrFoa53WLbE=\&#34;},\&#34;psid\&#34;:\&#34;76938405-a463-464a-9c49-752022daf516\&#34;,\&#34;type\&#34;:null,\&#34;user\&#34;:null,\&#34;usid\&#34;:null}&#34;;
        Object arg4 = vm.addLocalObject(new StringObject(vm, arg4_str));
        int arg5 = arg4_str.getBytes(StandardCharsets.UTF_8).length;
        list.add(vm.getJNIEnv());
        list.add(vm.addLocalObject(jclass));
        list.add(arg0);
        list.add(arg1);
        list.add(arg2);
        list.add(arg3);
        list.add(arg4);
        list.add(arg5);
        Number number = module.callFunction(emulator, 0x380c+1, list.toArray())[0];
        String result = vm.getObject(number.intValue()).getValue().toString();
        System.out.println(&#34;result: &#34; + result);
    }
</code></pre><p>当 String arg0_str = &ldquo;1&rdquo;</p><p>结果为</p><pre tabindex=0><code>2uEIVLrtvmHQ72DYG1+fFcCSo5obEd62UMKP+O7zFRx+K6u3FhLY0f3gYdZds/BMRA==
</code></pre><p>当 String arg0_str = &ldquo;2&rdquo;</p><p>结果为</p><pre tabindex=0><code>NO3dVW0Fr4yk5Xxoc64Nn903e6sSZK3Uif1TB8dHmVVlXXqzMuteseCb4hfd1/WUQFyHPmxIIRM86pCkymjlgQ==
</code></pre><p>当 String arg0_str = &ldquo;3&rdquo;</p><p>结果为</p><pre tabindex=0><code>HAT5BvN81B8PjW69r1sqCvf0cwN/Pey9XoAWBnkuGYEeVpqWTDBuyei8kaZ00XTJig/SKP4qThHwuGgWmlr4fg==
</code></pre><p>开始逐一击破</p><p><strong>加密模式 1</strong></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH4QXibVXWOQF6KOgCffrcxgK5jqNJqBMPAYwU7VHXCVkqEbxjlibJqNib3MBWj2QGnozQYSAS3d2ILEQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>strncmp &ldquo;1&rdquo; 和 v10 比较，v10=1 所以相等返回 0，!0 则是 true</p><p>所以跳到 LABEL_17</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI2icu8ccmwjNcPWEUo2ZLn2qqxtD5KUYjTGvrN4pbQ2VVQVJkicXoLYLA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>有三个函数，分别是 sub_3880、sub_302C、j_CCCrypt</p><p>显而易见，加密逻辑在 j_CCCrypt 函数里，而且因为最后 return 的 v11=v22，v22 就是放解密结果的地方</p><p>hook CCCrypt:</p><pre tabindex=0><code>    public void hook_CCCrypt(){
        IHookZz hookZz = HookZz.getInstance(emulator); // 加载HookZz
        hookZz.wrap(module.base + 0x4480 + 1, new WrapCallback&lt;HookZzArm32RegisterContext&gt;() {
            @Override
            // 方法执行前
            public void preCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                int arg0 = ctx.getIntArg(0);
                int arg1 = ctx.getIntArg(1);
                int arg2 = ctx.getIntArg(2);
                Pointer arg3 = ctx.getPointerArg(3);
                byte[] arg3_ = arg3.getByteArray(0, ctx.getIntArg(4));
                int arg4 = ctx.getIntArg(4);
                int arg5 = ctx.getIntArg(5);
                String arg6 = ctx.getPointerArg(6).getString(0);
                int arg7 = ctx.getIntArg(7);
                Pointer arg8 = ctx.getPointerArg(8);
                int arg9 = ctx.getIntArg(9);
                System.out.println(&#34;arg0:&#34;+arg0);
                System.out.println(&#34;arg1:&#34;+arg1);
                System.out.println(&#34;arg2:&#34;+arg2);
                Inspector.inspect(arg3_, &#34;arg3&#34;);
                System.out.println(&#34;arg4:&#34;+arg4);
                System.out.println(&#34;arg5:&#34;+arg5);
                System.out.println(&#34;arg6:&#34;+arg6);
                System.out.println(&#34;arg7:&#34;+arg7);
                ctx.push(arg8);
                ctx.push(arg9);
            };
            @Override
            // 方法执行后
            public void postCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                int length=ctx.pop();
                Pointer output = ctx.pop();
                byte[] outputhex = output.getByteArray(0, length);
                Inspector.inspect(outputhex, &#34;CCCrypt ret&#34;);
            }
        });
        hookZz.disable_arm_arm64_b_branch();
    }
</code></pre><p>hook 结果</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIcMAtV76Nico7rLvuial1xlcvvvrQXOBicUluYW9qDkYj0tT8oPsWSOK8g/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>大胆一点猜，arg3(v4) 就是密钥，是 sub_302C 函数生成的</p><p>arg6(a7) 就是明文，是什么加密还不知道，反正 99% 是对称加密</p><p>这时候是先看密钥怎么生成的还是先找出是什么加密算法呢？</p><p>都可以，我喜欢倒着推，所以先看 CCCrypt，双击进入函数</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHtr5I62m4IGmyKLF5auKcldIiaiaw6uet42WmvN665y62K6eC63j5dT1g/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>显而易见  j_CCCryptorCreate 是加密的初始化函数</p><p>双击进去 </p><pre tabindex=0><code>int __fastcall CCCryptorCreate(int a1, unsigned int a2, void *a3, int a4, int a5, int a6, _DWORD *a7)
{
  unsigned int v7; // r5
  void **v8; // r8
  int v9; // r9
  void *v10; // r11
  int v11; // r10
  int v12; // r4
  size_t v14; // r4
  _BYTE *v15; // r0
  int v16; // r0
  void *v17; // [sp+10h] [bp-28h]
  size_t v18; // [sp+14h] [bp-24h]
  int v19; // [sp+18h] [bp-20h]
  v11 = a1;
  v12 = 0xFFFFEF34;
  if ( a7 )
  {
    v7 = a2;
    if ( a2 &lt;= 5 )
    {
      v9 = a4;
      v10 = a3;
      v8 = off_1EB14[a2];
      v12 = (*v8)(a1);
      if ( !v12 )
        goto LABEL_6;
    }
  }
  while ( _stack_chk_guard != v19 )
  {
LABEL_6:
    v17 = v10;
    v14 = v18 + 20;
    v18 = v14;
    v15 = malloc(v14);
    if ( v15 )
    {
      v10 = v15;
      *(v15 + 1) = v14;
      *(v15 + 2) = v11;
      *(v15 + 3) = v7;
      *(v15 + 4) = v8;
      *v15 = 1;
      v16 = (v8[1])(v15 + 20, v11, v7, v17, v9, a5, a6);
      if ( v16 )
      {
        v12 = v16;
        free(v10);
      }
      else
      {
        v12 = 0;
        *a7 = v10;
      }
    }
    else
    {
      v12 = -4302;
    }
  }
  return v12;
}
</code></pre><p>这里伪代码看着有点懵？看上去好像没函数? 但是这里不对劲？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHVdqQTCaGsI2Mlb8elWicib3dBjVufVurFMKPbnBLRCbmpDeNHibuyk5yg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>这里 v8[1] 应该是个函数地址？后边是参数？</p><p>那 v8[1] 的地址是多少呢？</p><p>按 tab，转成汇编再看看</p><pre tabindex=0><code>.text:00004274                 EXPORT CCCryptorCreate
.text:00004274 CCCryptorCreate                         ; CODE XREF: j_CCCryptorCreate+8↑j
.text:00004274                                         ; DATA XREF: LOAD:00000450↑o ...
.text:00004274
.text:00004274 anonymous_0     = -0x34
.text:00004274 var_28          = -0x28
.text:00004274 var_24          = -0x24
.text:00004274 var_20          = -0x20
.text:00004274 anonymous_1     =  8
.text:00004274 arg_8           =  0x10
.text:00004274
.text:00004274 ; __unwind {
.text:00004274                 PUSH            {R4-R7,LR}
.text:00004276                 ADD             R7, SP, #0xC
.text:00004278                 PUSH.W          {R1-R11}
.text:0000427C                 MOV             R10, R0
.text:0000427E                 LDR             R0, =(__stack_chk_guard_ptr - 0x4284)
.text:00004280                 ADD             R0, PC  ; __stack_chk_guard_ptr
.text:00004282                 LDR             R6, [R0] ; __stack_chk_guard
.text:00004284                 LDR             R0, [R6]
.text:00004286                 STR             R0, [SP,#0x38+var_20]
.text:00004288                 LDR             R0, =0xFFFFEF32
.text:0000428A                 ADDS            R4, R0, #2
.text:0000428C                 LDR             R0, [R7,#arg_8]
.text:0000428E                 CBZ             R0, loc_42B2
.text:00004290                 MOV             R5, R1
.text:00004292                 CMP             R1, #5
.text:00004294                 BHI             loc_42B2
.text:00004296                 LDR             R0, =(off_1EB14 - 0x42A2) ; r0=0x1EB14 - 0x42A2 = 0x1A872
.text:00004298                 MOV             R9, R3
.text:0000429A                 MOV             R11, R2
.text:0000429C                 ADD             R2, SP, #0x38+var_24
.text:0000429E                 ADD             R0, PC  ; off_1EB14
.text:000042A0                 MOV             R1, R5
.text:000042A2                 LDR.W           R8, [R0,R5,LSL#2]
.text:000042A6                 MOV             R0, R10
.text:000042A8                 LDR.W           R3, [R8]
.text:000042AC                 BLX             R3
.text:000042AE                 MOV             R4, R0
.text:000042B0                 CBZ             R0, loc_42C8
.text:000042B2
.text:000042B2 loc_42B2                                ; CODE XREF: CCCryptorCreate+1A↑j
.text:000042B2                                         ; CCCryptorCreate+20↑j ...
.text:000042B2                 LDR             R0, [R6]
.text:000042B4                 LDR             R1, [SP,#0x38+var_20]
.text:000042B6                 SUBS            R0, R0, R1
.text:000042B8                 ITTTT EQ
.text:000042BA                 MOVEQ           R0, R4
.text:000042BC                 ADDEQ           SP, SP, #0x1C
.text:000042BE                 POPEQ.W         {R8-R11}
.text:000042C2                 POPEQ           {R4-R7,PC}
.text:000042C4                 BLX             __stack_chk_fail
.text:000042C8 ; ---------------------------------------------------------------------------
.text:000042C8
.text:000042C8 loc_42C8                                ; CODE XREF: CCCryptorCreate+3C↑j
.text:000042C8                 LDR             R0, [SP,#0x38+var_24]
.text:000042CA                 STR.W           R11, [SP,#0x38+var_28]
.text:000042CE                 ADD.W           R4, R0, #0x14
.text:000042D2                 STR             R4, [SP,#0x38+var_24]
.text:000042D4                 MOV             R0, R4  ; size
.text:000042D6                 BLX             malloc
.text:000042DA                 CBZ             R0, loc_4312
.text:000042DC                 MOV             R11, R0
.text:000042DE                 LDRD.W          R1, R0, [R7,#8]
.text:000042E2                 MOVS            R2, #1
.text:000042E4                 STRD.W          R4, R10, [R11,#4]
.text:000042E8                 STRD.W          R5, R8, [R11,#0xC]
.text:000042EC                 STRB.W          R2, [R11]
.text:000042F0                 MOV             R2, R5
.text:000042F2                 LDR.W           R4, [R8,#4]
.text:000042F6                 LDR             R3, [SP,#0x38+var_28]
.text:000042F8                 STRD.W          R9, R1, [SP]
.text:000042FC                 MOV             R1, R10
.text:000042FE                 STR             R0, [SP,#0x38+anonymous_0+4]
.text:00004300                 ADD.W           R0, R11, #0x14
.text:00004304                 BLX             R4
.text:00004306                 CBZ             R0, loc_4316
.text:00004308                 MOV             R4, R0
.text:0000430A                 MOV             R0, R11 ; ptr
.text:0000430C                 BLX             free
.text:00004310                 B               loc_42B2
.text:00004312 ; ---------------------------------------------------------------------------
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHLibOUuywicYraD9dRD8laMIwXA5tTxATMSJnwymibNc4GicPtXdERIr1Ag/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>按 tab 键，可以看到对应的汇编是这行，</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHTRmUOtGk4tqESIdrNcuicCr3wbfLFGqyGT0ibiaKrkRsbHb06Kiawb16jg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>汇编: BLX  R4</p><pre tabindex=0><code>指令BLX 
指令的格式为：BLX 目标地址BLX 
指令从ARM 指令集跳转到指令中所指定的目标地址，
并将处理器的工作状态有ARM 状态切换到Thumb 状态。
</code></pre><p>显而易见，这里是动态跳转的，也就是说 R4 的地址是计算出来的，不是写死的，所以我们得知道 R4 是多少；</p><p>这里有两种方法获得 R4 的值：</p><p>第一种方法很简单，用 unidbg 或 frida inline hook 0x4304，看 r4 寄存器的值不就行了嘛？</p><p>第二种方法就是静态分析，手动计算出来不就行了嘛？</p><p>先挑战一下第二种方法看看能出来不？</p><p>R4 哪来的？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI87A4xEjgiaU8GGejzWEWVQ3MR0ZFYgWd6ibPGQDpL3uSS5qzCgpBicZaQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>.text:000042F2                 LDR.W           R4, [R8,#4]
即：R4 = [R8 + 0x4]  []代表取R8+R4的指针
</code></pre><p>R8 哪来的？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI6m5BT2GpRSibWFBkVUkvBiawSfn89Ro86vm2iabOtj1RAM8OAABQL3qIQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>.text:000042A2                 LDR.W           R8, [R0,R5,LSL#2]
即：R8 = [R0 + (R5&lt;&lt;2)] ，[]代表取R0+(R5&lt;&lt;2)的指针
</code></pre><p>R0 哪来的？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWISIqsvQH2AKMqibKyOiaiaotlOAU68uibbpCibzjz5Rz866X6HQZWJXibfXJQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>.text:0000429E                 ADD             R0, PC  ; off_1EB14
即：R0 = R0+PC   这里ida已经算出R0=0x1EB14
</code></pre><p>R5 哪来的？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIkrhQeHJMhxPdNCiaFiaAtV4TryI8fcLguInQs5pKGlDfqjssCJanA9aw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>.text:00004290                 MOV             R5, R1
R5=R1 也就是函数的第二个参数,最后追到tj_crypt函数里的v25=v17 = 4
    if ( !strncmp(&#34;1&#34;, v10, n) )
    {
      v16 = v9;
      v17 = 4;
LABEL_15:
      v25 = v17;
      v9 = 0;
      goto LABEL_17;
    }
</code></pre><p>流程：</p><pre tabindex=0><code>.text:00004290                 MOV             R5, R1
.text:0000429E                 ADD             R0, PC  ; off_1EB14
.text:000042A2                 LDR.W           R8, [R0,R5,LSL#2]
.text:000042F2                 LDR.W           R4, [R8,#4]
</code></pre><p>R5 = 4</p><p>R0 = 0x1EB14</p><p>R8 = [R0+(4&#171;2)] = [0x1EB24]</p><p>R4 = [R8+4]</p><p>[0x1EB24] 表示取 0x1EB24 的指针，也就是指向的地址，怎么看</p><p>Ida 中按 g 输入 0x1EB24，回车</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAH3WLgG9zbRtxfZwbDkhTgglrp6GicRvXiajwZz6nSIXRV3Hh8ObXYBiaog/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>双击 ccRC4Callouts</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHiaiaXwyVxYfyPkianZKAMLiapjv1rVbF6rm6xP1KTJlb00iaJAYmO4xMCdA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>0x1EC3C 就是 0x1EB24 的指针</p><p>所以 R8 = 0x1EC3C</p><p>最后 R4 = [R8+0x4] = [0x1EC3C+4] = [0x1EC40]</p><p>[0x1EC40] 表示取 0x1EC40 的指针，就是 0x4E89</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHzsyynEYWxdP5ibQ7eJIwhz6PgP3PR73GjkxIpuUapT2QgHiaE1OcSSXQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>第二种获取 R4 地址得方法很简单</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIj4nZUQ8htC2icoKPzysfWHUnqzMVMSiavMWueHAZ9LO1MCJ3kwlxdvrA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>hook 0x4304</p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x4304);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWINvsgACiclz64F7KfgaEsRhz4J9XGJJzwibOAcXTMic3TW5mH70OxLcFibQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>笑死，直接就出来了，还静态分析个毛</p><p>所以 BLX R4 最终等价于 BLX 0x4E89</p><p>ida 中按 g 输入 0x4E89 跳转，也可以双击 sub_4E88</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6j2r8xlLLamev2aSYplQAHdicYKANK8auPia4lxBG80u95hRR6VykM329Z9icL2sgAaooSTsRkiauu3Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>咦，显而易见这是 rc4 算法初始化密钥的函数</p><p>Hook 这个函数就能拿到 rc4 的密钥</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIJc2I6FjBcWHdW4DYv0L6jVricXwWCG7BibxUzqX6nsA2pkUibkFHTS6icw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>打个断点</p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0xC244);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI8rIqXibJZ4oDJ1Ctd40NGySPjaenU86VUziaS1PUORpNVCblbOEuq4vA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>查看 r2 的值</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIiadPh4NUmKC5CKGf7QCic6Az2jDXnOQxDlKPuGlGzShY1jOibwMeoTyrQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>密钥是：f4c7fc5d61bdff1914c383b340958ef1</p><p>没毛病吧！就是上面说的 V9</p><p>然后最终加密的函数呢？</p><p>回到 CCCrypt 函数</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIibnoBdVtAFZhziaxBiaaaVKPzvQLV8X0yHy6gT65dbAec26ibS5ttxCEqw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>v12 = (*(*(v21 + 16) + 12))(v21 + 20);
</code></pre><p>有经验了，这一行一看跟上面差不多嘛，看看汇编</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIZU7YQaibDCBNWF1HFeO7C0uqZTAuFoCQNkTr8P3fI4o0d2zmpuB1Stg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>BLX R4</p><p>R4 地址又是算出来的，直接用 unidbg hook 拿到地址</p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x453A);
</code></pre><p>运行</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWInU9QhOmP3e7g3JoDB8WB2OF1Wv33a8tp99VzgrW2oL5Um2tCYCxh3Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>BLX R4 等价于 BLX 0x4ea5 </p><p>ida 中按 g 输入 0x4ea5  跳转</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIaaJ3iaT1a3vVIKPnLhVOibMnbmCMmlocibc05h4JKble1bZfl1OVGeYNg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFWdgIeHCd7j1zZ6fotroN4VECNrEdW4bo0Nicca7kZlMmHvyYib3ZCZTw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>二话不说 hook 这个函数</p><pre tabindex=0><code>    public void hook_CC_RC4(){
        //rc4密钥
        IHookZz hookZz = HookZz.getInstance(emulator); // 加载HookZz
        hookZz.wrap(module.base + 0xBEC8 + 1, new WrapCallback&lt;HookZzArm32RegisterContext&gt;() {
            @Override
            // 方法执行前
            public void preCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                Pointer arg0 = ctx.getPointerArg(3);
                int arg1 = ctx.getIntArg(1);
                Pointer arg2 = ctx.getPointerArg(2);
                System.out.println(&#34;arg1:&#34;+arg1);
                System.out.println(&#34;arg2:&#34;+arg2.getString(0));
                ctx.push(arg0);
                ctx.push(arg1);
            };
            @Override
            // 方法执行后
            public void postCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                int length=ctx.pop();
              //  System.out.println(length);
                Pointer output = ctx.pop();
                byte[] outputhex = output.getByteArray(0, length);
                Inspector.inspect(outputhex, &#34;CC_RC4 ret&#34;);
            }
        });
        hookZz.disable_arm_arm64_b_branch();
    }
</code></pre><p>hook 结果：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIBNVtvI6I0NEOicMqbhAEFiaic0P4NJ9qep1OatsGGceXuSCoxnB56c0ng/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>看来前面猜的都没错嘛,</p><p>现在就用逆向之友看看这个 rc4 是不是标准的 rc4 了</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWICAOibwcFYaB36C8tyCOp5vPBDTqkw2Zx2A43AZrRX2De6jV4r2jOVNA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>没毛病</p><p>现在明文知道了，也就是 bodyencrypt 的 第五个参数，</p><p>加密方式也知道了，对称算法 rc4</p><p>最后就要解决密钥是怎么生成的</p><p><strong>rc4 key</strong></p><p>回到 tj_crypt，LABEL_17</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWINIxPfMmcPs9uBZgIjC2WVa80u5E2NsLqK5DEG2ZQ81QwosYyp5GJNw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>显而易见！</p><p>我们要进入 sub_302 的身体里去探索</p><pre tabindex=0><code>char *__fastcall sub_302C(int a1, int a2, int a3, int a4)
{
  int v4; // r8
  char *result; // r0
  int v6; // r4
  int v7; // r9
  char *v8; // r6
  v4 = a1;
  result = 0;
  if ( a2 )
  {
    v6 = a4;
    if ( a4 )
    {
      v7 = a3;
      v8 = malloc(0x15u);
      result = 0;
      *(v8 + 13) = 0;
      *v8 = 0LL;
      *(v8 + 1) = 0LL;
      *(v8 + 17) = 0;
      if ( v8 )
      {
        j_CCHmac(0, v7, v6, v4);
        sub_33E4(v8, 20);
        result = v8;
      }
    }
  }
  return result;
}
</code></pre><p>先 hook 一下，看看参数和结果</p><pre tabindex=0><code>    public void hook_sub_302C(){
        IHookZz hookZz = HookZz.getInstance(emulator); // 加载HookZz
        hookZz.wrap(module.base + 0x302C + 1, new WrapCallback&lt;HookZzArm32RegisterContext&gt;() {
            @Override
            // 方法执行前
            public void preCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                Pointer arg0 = ctx.getPointerArg(0);
                int arg1 = ctx.getIntArg(1);
                int arg3 = ctx.getIntArg(3);
                Pointer arg2 = ctx.getPointerArg(2);
                System.out.println(&#34;arg0:&#34;+arg0.getString(0));
                System.out.println(&#34;arg1:&#34;+arg1);
                System.out.println(&#34;arg2:&#34;+arg2.getString(0));
                System.out.println(&#34;arg3:&#34;+arg3);
            };
            @Override
            // 方法执行后
            public void postCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                Pointer output = ctx.getR0Pointer();
                byte[] outputhex = output.getByteArray(0, 128);
                Inspector.inspect(outputhex, &#34;sub_302C ret&#34;);
            }
        });
        hookZz.disable_arm_arm64_b_branch();
    }
</code></pre><p>显而易见是个 hmac 哈希编码</p><p>hook 结果：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAF0c21kFm3IJ5TQ7LM9wpj0U2Kz3uJeHTXWCE6N53SqFNicUABN9Yu8LQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>arg0 是明文，可以发现是由 arg2_str+arg1 拼接而来</p><p>哪个函数拼接的？</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFA7CX5jKTeRIGhkcXC6XdUkb07qJBMmkTPjRnDeficPTN4siahAoYLdsA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFVEeRgTzNJVicv8zuq2I3yliby7TIZPic6yIS1JHh14MQvKHicRh4W0d4eg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFwjsmdJpO4DxKthicibAQZDpjGqeHNnxIcWQdnrQmdcuvvyDhTjUEQ4QQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>arg2 是密钥，结果是长度 20 个字节（00 00 00 00 是结束标志），可以盲猜是 hmacsha1，然后去逆向之友看看是不是 hmacsha1</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI6skLQEicEscQJcLfUtsOfiadayLuTBW0YN10oSokFPfGxatQfXm1bl5A/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>咦，不对呢，但是可以发现 hmacsha1 的结果出现在这里</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI595uBNN3TOW4fYKE0Vm5sCyCl1Vhsa9R9ibdiaKGibTyaDkvb5kd2MdDQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>j_CCHmac 下面还有个 sub_33E4(v8, 20)</p><p>应该是 sub_33E4 搞得鬼</p><p>hook hook 看</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIXqpRnJT9QvYug0ylfx221mkHa0ibLOXU9Nlf5Gb3GZdFcfNHk31dE5g/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>这次没错了</p><p>如果猜不出是 hmacsha1，那就进入 j_CCHmac、CCHmac</p><pre tabindex=0><code>int __fastcall CCHmac(int a1, int a2, int a3, int a4, int a5, int a6)
{
  int v6; // r11
  int v7; // r4
  char v9; // [sp+4h] [bp-194h]
  int v10; // [sp+Ch] [bp-18Ch]
  void (__fastcall *v11)(int *, int, int); // [sp+160h] [bp-38h]
  int v12; // [sp+184h] [bp-14h]
  int v13; // [sp+188h] [bp-10h]
  v13 = v6;
  v7 = a4;
  j_CCHmacInit(&amp;v9, a1, a2, a3);
  v11(&amp;v10, v7, a5);
  j_CCHmacFinal(&amp;v9, a6);
  return _stack_chk_guard - v12;
}
</code></pre><p>显而易见，又是个 init、update、Final 流程，在中卷已经说了，忘了的回去看看</p><p>进入 j_CCHmacInit、CCHmacInit</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIgnHqqHv9H8C5hb8xWP3LynDicrNkzNn1iabzibibxLXcqs7YsGeYWDWJzQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>看到有个控制流，根据 a2 的值来决定走哪个分支</p><p>这里 a2 是 0</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIAU615QtliaVOLECuN8gUX8zpvFVWEUWh7NicEHb5dSQM30F94bCOh6mQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>所以进到这里</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIsfSibOcw7dfexkWNKiae829B5nSlXZe7lztic3Z4v93u3g0NvlE8npJibA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>可以看到初始化常量</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIJ56hG6Y0gUgKfFM6zciam7kjc3WTia2hyT2adFzy0OvUicW1P9PK3A8OQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>回到上面</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIAXdlXwGAwMh8IqtMMOkoj1EH6hvvuibywp4KUZsBnibKNhCuaRhZJAaw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>这里的 v11 又是动态跳转，要看的自己 hook 下，不在细说</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWI7mZkpYQ5pstYNyuWDw9MgRTrQETfVdb57c4D0JVlviatfprluJS3ib1w/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>再回到上面，解决这个函数</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6TasXnTSrq21cYUkEIRGWIyGicV25ZgUMPmfrqRerMPBxvrz9gQudLKjykfMNpLFiaR8XicQ4cCGkaQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>进入 sub_33E4 函数</p><pre tabindex=0><code>const char *__fastcall sub_33E4(const char *result, unsigned int a2)
{
  unsigned int v2; // r6
  const char *v3; // r9
  _BYTE *v4; // r4
  int v5; // r2
  int v6; // r3
  signed int v7; // r2
  const char *v8; // r0
  const char *v9; // r1
  int v10; // r3
  char v11; // t1
  char v12; // t1
  int v13; // r2
  _BYTE *v14; // r0
  int v15; // r1
  _BYTE *v16; // r3
  char v17; // r5
  if ( a2 &gt;= 2 )
  {
    v2 = a2;
    v3 = result;
    result = strlen(result);
    if ( result &gt;= v2 )
    {
      v4 = malloc(v2 + 1);
      _aeabi_memclr(v4, v2 + 1, v5, v6);
      v7 = 1;
      v8 = &amp;v3[v2 - 1];
      v9 = v3;
      while ( 1 )
      {
        v10 = &amp;v4[v7];
        if ( v9 &gt;= v8 )
          break;
        v11 = *v9++;
        *(v10 - 1) = v11;
        v12 = *v8--;
        v4[v7] = v12;
        v7 += 2;
      }
      if ( v8 == v9 )
        *(v10 - 1) = *v9;
      v13 = v2 - 1;
      v14 = v3 + 1;
      v15 = 0;
      while ( 1 )
      {
        v16 = &amp;v4[v15];
        if ( &amp;v4[v15] &gt;= &amp;v4[v13] )
          break;
        v17 = v4[v13--];
        *(v14 - 1) = v17;
        ++v15;
        *v14 = *v16;
        v14 += 2;
      }
      if ( v13 == v15 )
        *(v14 - 1) = v4[v15];
      result = j_free(v4);
    }
  }
  return result;
}
</code></pre><p>就是对 hmacsha1 编码后的 byte 移位</p><p>看着 ida 反编译的伪代码不好翻译，可以伪代码为主，汇编为辅助去还原；</p><p>也可以汇编为主，伪代码和 unidbg 动态调试为辅助去还原；</p><p>都不会的还有个更简单的，只需要多搞几组数据对比下，找出规律自己实现就行了；</p><p>放出伪代码为主，汇编辅助的代码</p><pre tabindex=0><code>import hashlib
import hmac
from hexdump import hexdump
def CCHmac(key:str,input_str:str)-&gt;bytes:
    hmacsha1_ret = hmac.new(key.encode(), input_str.encode(), hashlib.sha1).digest()
    return hmacsha1_ret
def sub_33E4(hmacsha1_ret:bytes,size=20)-&gt;bytes:
    v4 = [0 for i in range(size)]
    v5 = 1
    v6 = size
    v7 = 0
    while (1):
        if (v7 &gt;= v6):
            break
        v9 = hmacsha1_ret[v7]
        v7 += 1
        v4[v5 - 1] = v9
        v6 -= 1
        v10 = v6
        v4[v5] = hmacsha1_ret[v10]
        v5 += 2
    if v6 == v7:
        hmacsha1_ret = v4
    v11 = size
    v13 = 0
    v12 = 1
    v4 = [0 for i in range(size)]
    while (1):
        if (v13 &gt;= v11):
            break
        v11 -= 1
        v10 = v11
        v4[v12 - 1] = hmacsha1_ret[v10]
        v9 = hmacsha1_ret[v13]
        v13 += 1
        v4[v12] = v9
        v12 += 2
    return bytes(v4)[:16]
if __name__ == &#39;__main__&#39;:
    input_str = &#34;YM0A2TMAIEWA3xMAMM1xTjQEUYGD0wZAYAh32AdgQATDzAZNZA33WAEIZAzzhAMMNAzyTDAkZMzTizYOYN11TTgMRcDThyNMZO44GTIAVQGDi5OONN2wWGMMUVWj1iMNOYxxGmUU1630808396&#34;
    Hmackey = &#34;dGp******dG8K&#34;
    v9 = CCHmac(Hmackey,input_str)
    key = sub_33E4(v9,20)
    hexdump(key)
</code></pre><p> rc4 自己写</p><p><strong>加密模式 2</strong></p><p><strong>其实后面两种加密模式流程都差不多，简单说一下吧。。文章已经太长了</strong></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAF483jRbCkDwI6Kr6LrCltWjIjdbXP5Q9RRbsDibRrNDo0RFm0Ou33rgg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>这里改成 2</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFUviaZp1wVJ1EUPMWJAssrGgbwribKbbqNcDrM821DDJNfwfkHOxkUpeA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>然后根据上面模式 1 分析的可以知道这个 v25 就是 R5（就忘了？划上去看）</p><p>R5=v25=v17=0</p><p>R8, [R0,R5,LSL#2]</p><p>即：R8=[R0+(0&#171;2)]=[0x1EB14]</p><p>同理可得 0x1EB14 的指针是 0x1EB2C</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFKRHTicjeGdLAlItMB4EjVA5wtPkeJNPP5rxGBdoOvAWMmtgf1Hnt8hw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>R4=[R8+4]</p><p>最后 R4=[R8+0x4]=[0x1EB2C+4] = [0x1EB30]</p><p>[0x1EB30] 表示取 0x1EB30 的指针，就是 0x4829</p><p>不信的话用 unidbg 打个断点</p><p>还是这个地方</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFdObEqtXsf9icow6BW3WicIkVAicLz3c5pae1pSEbe8ic3V9KV4MHBEgZEw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x4304);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFKzniakxtVKtDd4qSR5JSe6eSw0IQ4cHBibVuNyW01PDdrYfjib9Opicc5Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>废话不多说，直接 g 0x4829 跳过去</p><pre tabindex=0><code>signed int __fastcall sub_4828(int a1, int a2, int a3, char a4, int a5, unsigned int a6, int a7)
{
  int v7; // r5
  char v8; // r8
  int v9; // r6
  char *v10; // r0
  signed int v11; // r4
  int *v12; // r6
  char v13; // r3
  int v14; // r12
  v7 = a1;
  v8 = a4;
  v9 = a2;
  v10 = sub_4DE0(a3);
  v11 = -4300;
  if ( a5 &amp;&amp; v10 &amp;&amp; *((_DWORD *)v10 + 2) &lt;= a6 &amp;&amp; *((_DWORD *)v10 + 3) &gt;= a6 )
  {
    *(_DWORD *)v7 = v10;
    if ( v9 == 1 )
    {
      v12 = (int *)(v10 + 40);
      *(_DWORD *)(v7 + 4) = *((_DWORD *)v10 + 8);
      v13 = 0;
    }
    else
    {
      if ( v9 )
        return v11;
      v12 = (int *)(v10 + 36);
      *(_DWORD *)(v7 + 4) = *((_DWORD *)v10 + 7);
      v13 = 1;
    }
    v14 = *v12;
    *(_BYTE *)(v7 + 49) = v8 &amp; 1;
    *(_BYTE *)(v7 + 48) = v13;
    *(_DWORD *)(v7 + 8) = v14;
    if ( v8 &amp; 2 )
    {
      *(_WORD *)(v7 + 50) = 0;
    }
    else
    {
      *(_BYTE *)(v7 + 50) = 1;
      if ( v10[16] )
        *(_BYTE *)(v7 + 51) = 0;
      else
        *(_BYTE *)(v7 + 51) = 1;
    }
    *(_DWORD *)(v7 + 28) = 0;
    if ( !(*((int (__fastcall **)(int))v10 + 5))(v7 + 52) )
    {
      if ( *(_BYTE *)(v7 + 50) )
        sub_4E0C((unsigned __int8 *)v7, (int *)a7);
      v11 = 0;
    }
  }
  return v11;
}
</code></pre><p>这函数里只有 sub_4DE0 跟 sub_4E0C 两个函数，sub_4DE0 很短没什么信息</p><p>那肯定就再 sub_4E0C 函数里了</p><p>进去</p><pre tabindex=0><code>int __fastcall sub_4E0C(unsigned __int8 *a1, int *a2)
{
  int *v2; // r3
  JNIEnv *v3; // r2
  int v4; // r1
  int v5; // r2
  int v7; // [sp+0h] [bp-30h]
  __int64 v8; // [sp+8h] [bp-28h]
  __int64 v9; // [sp+10h] [bp-20h]
  __int64 v10; // [sp+18h] [bp-18h]
  int v11; // [sp+24h] [bp-Ch]
  v2 = a2;
  v3 = *a1;
  if ( *(*a1 + 16) )
  {
    if ( !a2 )
    {
      v2 = &amp;v7;
      *&amp;v7 = 0LL;
      v8 = 0LL;
      v9 = 0LL;
      v10 = 0LL;
    }
    (v3[6])(a1 + 52, a1[48], v2);
  }
  else
  {
    v4 = (a1 + 12);
    if ( !a1[48] )
      v4 = (a1 + 32);
    v5 = *(v3 + 4);
    if ( v2 )
      _aeabi_memmove(v4, v2, v5);
    else
      _aeabi_memclr(v4, v5, v5, 0);
  }
  return _stack_chk_guard - v11;
}
</code></pre><p>(v3[6])(a1 + 52, a1[48], v2);</p><p>这一行很熟悉了吧，看汇编</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFqa9cUCWia9oCwLdYjvA5tcgebE2cjV4FpVyO2UtEiaZzOW6d4hKu0rtg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>直接 hook，静态分析个毛，早 hook 早发表</p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x4E40);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFQdE78wCiaIicaduGMzbDo42SRIqaBXTvia8sPWibJiczNN8o6Mib3ey81RIw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>g 0x11a51</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFMOupiaLXRRLXRadsMyoWBZhzdiberfgUeqgFic2JNzicwT3uHpVOPHxbOw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>显而易见，这是 aes 算法，设置 iv 的地方</p><p>hook</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAF8rOl0Gw48PR2XTiaC2hlfrrO7TXDsbhsoYtr8QmTicJSVDPHUd3zU9Ew/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x11A50);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFyFGbgFFfYYLAMDAHgNdqK8ibuIXrHpdMMsNdHPxNiaY96icx2OFRUlKRg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>打印 iv</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFRG1RwPKr38Ktq3u4SltaZZ4jUChypAgLaVicfQmZ8D4m7Vzfw88by6Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>那 aes 的 key 是哪里初始化的？一般是先初始化 key 再 iv，前面是不是漏掉了什么关键的地方? 回去看看</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFQ6rLySzo59RmEZibHibLreQn0xZg1MCFaEWjQ8giciakpialuoPPOUXQMEg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>噢这里还有这 BLX</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFdRaqiaRV1DPW93MhanCu0VeeeIK6CuYskq6IEBHSyLiclv1kA82Uv69w/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>hook 之</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFAtueKZ16fKAibseL85b2jHzgco1L73EBV2h1xUa88KtEZa3KUDnibNYg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>ida g 0x119e9</p><p>unidbg b 0x119e9 </p><p>c</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFLgCCicUWgx8NAFWzmhc9tAvZyh8L0yKLuzribnM8cRJiaSDz1bqdQiawZw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFy0jfHOobB6LNMP689mQZK9wXHNX7Zt8tDBPKq54XQVRW73xSniaIVJw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>进去</p><p>hook 之</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAF0icOM8bUgNUACodPD8rcRmMgrjToxsAprlrkQ56jriciaC6SvcnYfYykQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>b0xE398 </p><p>c</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFx2Wd9qzWbeuHFtBcibG5vQ7ibT945mBiasWVHPibVKicibI2Lz2hWBc38ePQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>打印 r0</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFXnlH0YJXVVuowFgczhb6F71wC3mYWhPdDsQFLZjh0t4Vdq5m0gtq7Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>可以看到这个 key 跟 rc4 的 key 是一样的</p><pre tabindex=0><code>加密方式:aes_cbc
明文:{&#34;code&#34;:null,&#34;parameter&#34;:{&#34;activityTask&#34;:{},&#34;defa
aes_key:f4c7fc5d61bdff1914c383b340958ef1
aes_iv:00000000000000000000000000000000
</code></pre><p>逆向之友验证</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFPy5VAknia6kDibVyrYRCw8b1NwqBCva0ib2xIyyUD4qF6EFooPkdLcG3A/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>没毛病</p><p>还想知道 aes_encrypt 在哪的</p><p>hook 这里</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFCqw8zIzbZYRGRZtVcicbFc9ib7yb7tOZFYuTJqnzLOT23ojtK4fTEcibA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>拿到 R4 地址</p><p>再 hook 这里 </p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFVXmV3hUvTia9fT50qkiaBLFkHYlxeCyHXzVUhkx4AbnZ2rXC3PupfEPg/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>拿到 R5 地址</p><p>就是了</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFm7LhibqcZhZgjuia37P9jwZFESye2PoDAXrccPb0MAOolxRFW74ZNUzA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><strong>加密模式 3</strong></p><p><strong>跟模式 2 一样是 aes_cbc, 只是 iv 不一样，所以只说 iv 的生成</strong></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFWdj4PYsP4jK5yrODlN4Btficia24K3wicMI8gu1rOMKOjkFicLDN4q50pA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>改成 3</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFT5SEPYbUuXYf9OvHWiajCaKMaf3Kl2YYHefdlicQ1rptboJIe3fRWl5g/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>看样子就是比模式二多走了一个 sub_302c，</p><pre tabindex=0><code>public void hook_sub_302C(){
        IHookZz hookZz = HookZz.getInstance(emulator); // 加载HookZz
        hookZz.wrap(module.base + 0x302C + 1, new WrapCallback&lt;HookZzArm32RegisterContext&gt;() {
            @Override
            // 方法执行前
            public void preCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                Pointer arg0 = ctx.getPointerArg(0);
                int arg1 = ctx.getIntArg(1);
                int arg3 = ctx.getIntArg(3);
                Pointer arg2 = ctx.getPointerArg(2);
                System.out.println(&#34;arg0:&#34;+arg0.getString(0));
                System.out.println(&#34;arg1:&#34;+arg1);
                System.out.println(&#34;arg2:&#34;+arg2.getString(0));
                System.out.println(&#34;arg3:&#34;+arg3);
            };
            @Override
            // 方法执行后
            public void postCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) {
                Pointer output = ctx.getR0Pointer();
                byte[] outputhex = output.getByteArray(0, 128);
                Inspector.inspect(outputhex, &#34;sub_302C ret&#34;);
            }
        });
        hookZz.disable_arm_arm64_b_branch();
    }
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFiaTVWJyps8q6gbMmdnk6bTicGVs3doauo8gqg7Eo6IfhCpnCaPSu8wQQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>然后后边的流程就跟模式二就没区别了，就不说了</p><p>hook aes_cc_set_iv</p><pre tabindex=0><code>debugger.addBreakPoint(module.base+0x11A50);
</code></pre><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFUV3efpPAwLZZibDoDnlwraj0o6Kia9a6MZDEVCwicAEaAoAtGJHk1ibXGA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFISIPad3msBcucwHTDU6lQdnhmhUlIicvuyuQlLGs9AFGzY3Hb4o9o0Q/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>可以看到这个 iv 就是第一次 sub_302c 生成的值</p><p>这个 iv 和 key 的生成方式都是一样的，只是明文少了个时间戳而已</p><pre tabindex=0><code>加密方式:aes_cbc
明文:{&#34;code&#34;:null,&#34;parameter&#34;:{&#34;activityTask&#34;:{},&#34;defa
aes_key:f4c7fc5d61bdff1914c383b340958ef1
aes_iv:7b53e03485ddbbcf07bd9698718abc8a
</code></pre><p>逆向之友验证</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFJmY27BCqict3TuRMbtiac1EwaKq3wFrrsRU0A9I6qp1dDaVvDtgGXpHQ/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p>这些都是标准的算法，遇到魔改算法的时候，就需要对算法的原理非常熟悉了，这时就需要看这个男人的密码学专栏<figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFq4QzFib1kyspVcM3vKMgBeMpibmicPOGMznxribZZvM63aGs71P9g24Qvw/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFb6P5cAm09YK4FXXmeQsdoK5kFtUQibrEnKJgPBwPtoia6OTlnUYy6s3g/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_jpg/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAFMbJr6icmbiallGwbX4rjWuLJeBPSyug2vxIpL0YzULgmH3GlLbVnfSNA/640?wx_fmt=jpeg" alt loading=lazy data-zoomable></div></div></figure></p><p><strong><strong>完结！</strong></strong></p><p><strong>饮茶去了</strong></p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src="https://mmbiz.qpic.cn/mmbiz_png/icBZkwGO7uH6Tsm0MiceegNzEQmZCyXVAF3ctIAJQuhYibVRPyjnmTiclzkxEPr8HMgL3kTnM8TgK3tJibF2X6SB6qA/640?wx_fmt=png" alt loading=lazy data-zoomable></div></div></figure></p></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%8A%E5%8D%B7/ rel=next>unidbg 算法还原术 · 某民宿 app 篇 · 上卷</a></div><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/infosecurity-series/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/99.%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/unidbg-%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F%E6%9C%AF-%E6%9F%90%E6%B0%91%E5%AE%BF-app-%E7%AF%87-%E4%B8%AD%E5%8D%B7/ rel=prev>unidbg 算法还原术 · 某民宿 app 篇 · 中卷</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>