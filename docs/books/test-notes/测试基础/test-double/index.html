<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="Test Double 本部分主要介绍所谓的 Test Double 的概念，并且对其中容易被混用的 Mocks 与 Stubs 的概念进行一个阐述。在初期接触到的时候，很多人会把 Mock 对象与另一个单元测试中经常用到的 Stub 对象搞混掉。为了方便更好地理解，这里把所有的所谓的"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/test-double/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/test-double/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/test-double/"><meta property="og:title" content="Test Double | Next-gen Tech Edu"><meta property="og:description" content="Test Double 本部分主要介绍所谓的 Test Double 的概念，并且对其中容易被混用的 Mocks 与 Stubs 的概念进行一个阐述。在初期接触到的时候，很多人会把 Mock 对象与另一个单元测试中经常用到的 Stub 对象搞混掉。为了方便更好地理解，这里把所有的所谓的"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>Test Double | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=af295367f8ef217813264592341c9545><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">测试基础</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2829dfade385510532e28cb28bd5b319")' href=#id2829dfade385510532e28cb28bd5b319 aria-expanded=false aria-controls=id2829dfade385510532e28cb28bd5b319 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/test-notes/>Test-Notes</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id2829dfade385510532e28cb28bd5b319 aria-expanded=false aria-controls=id2829dfade385510532e28cb28bd5b319><i class="fa-solid fa-angle-down" id=caret-id2829dfade385510532e28cb28bd5b319></i></a></div><ul class="nav docs-sidenav collapse show" id=id2829dfade385510532e28cb28bd5b319><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idf35ffc9c97f5fd4c07357f0a6eae1a48")' href=#idf35ffc9c97f5fd4c07357f0a6eae1a48 aria-expanded=false aria-controls=idf35ffc9c97f5fd4c07357f0a6eae1a48 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/>测试基础</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idf35ffc9c97f5fd4c07357f0a6eae1a48 aria-expanded=false aria-controls=idf35ffc9c97f5fd4c07357f0a6eae1a48><i class="fa-solid fa-angle-down" id=caret-idf35ffc9c97f5fd4c07357f0a6eae1a48></i></a></div><ul class="nav docs-sidenav collapse show" id=idf35ffc9c97f5fd4c07357f0a6eae1a48><li class="child level"><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/bdd/>BDD</a></li><li class="child level"><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/tdd/>TDD</a></li><li class="child level active"><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/test-double/>Test Double</a></li><li class="child level"><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/%E6%B5%8B%E8%AF%95%E5%88%86%E7%B1%BB/>测试分类</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id49d9fe8aa6278f7f6d780af240c27ad2")' href=#id49d9fe8aa6278f7f6d780af240c27ad2 aria-expanded=false aria-controls=id49d9fe8aa6278f7f6d780af240c27ad2 aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd02981ec1fb77d28accbe40ccbe7a3aa")' href=#idd02981ec1fb77d28accbe40ccbe7a3aa aria-expanded=false aria-controls=idd02981ec1fb77d28accbe40ccbe7a3aa aria-hidden=false data-toggle=collapse></div></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id762a0a9e0e4df838e43ce8b15815e19c")' href=#id762a0a9e0e4df838e43ce8b15815e19c aria-expanded=false aria-controls=id762a0a9e0e4df838e43ce8b15815e19c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/test-notes/%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95/>端到端测试</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id762a0a9e0e4df838e43ce8b15815e19c aria-expanded=false aria-controls=id762a0a9e0e4df838e43ce8b15815e19c><i class="fa-solid fa-angle-right" id=caret-id762a0a9e0e4df838e43ce8b15815e19c></i></a></div><ul class="nav docs-sidenav collapse" id=id762a0a9e0e4df838e43ce8b15815e19c><li class="child level"><a href=/books/test-notes/%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95/cypress/>Cypress</a></li><li class="child level"><a href=/books/test-notes/%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95/nightwatch/>Nightwatch</a></li><li class="child level"><a href=/books/test-notes/%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95/testcafe/>TestCafe</a></li><li class="child level"><a href=/books/test-notes/%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95/watir/>Watir</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id40c9f5abf0ba9fc8ed2f572d5f9f72e0")' href=#id40c9f5abf0ba9fc8ed2f572d5f9f72e0 aria-expanded=false aria-controls=id40c9f5abf0ba9fc8ed2f572d5f9f72e0 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/test-notes/%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95/>服务测试</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id40c9f5abf0ba9fc8ed2f572d5f9f72e0 aria-expanded=false aria-controls=id40c9f5abf0ba9fc8ed2f572d5f9f72e0><i class="fa-solid fa-angle-right" id=caret-id40c9f5abf0ba9fc8ed2f572d5f9f72e0></i></a></div><ul class="nav docs-sidenav collapse" id=id40c9f5abf0ba9fc8ed2f572d5f9f72e0><li class="child level"><a href=/books/test-notes/%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95/jmeter/>JMeter</a></li><li class="child level"><a href=/books/test-notes/%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/>测试工具</a></li><li class="child level"><a href=/books/test-notes/%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95/%E6%B5%81%E9%87%8F%E5%A4%8D%E5%88%B6/>流量复制</a></li><li class="child level"><a href=/books/test-notes/%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/>压力测试</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id0a2d02fd024f202b82416538fc4e498d")' href=#id0a2d02fd024f202b82416538fc4e498d aria-expanded=false aria-controls=id0a2d02fd024f202b82416538fc4e498d aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/test-notes/%E5%9B%9E%E5%BD%92%E6%B5%8B%E8%AF%95/>回归测试</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id0a2d02fd024f202b82416538fc4e498d aria-expanded=false aria-controls=id0a2d02fd024f202b82416538fc4e498d><i class="fa-solid fa-angle-right" id=caret-id0a2d02fd024f202b82416538fc4e498d></i></a></div><ul class="nav docs-sidenav collapse" id=id0a2d02fd024f202b82416538fc4e498d><li class="child level"><a href=/books/test-notes/%E5%9B%9E%E5%BD%92%E6%B5%8B%E8%AF%95/%E6%A8%A1%E6%9D%BF%E5%8C%B9%E9%85%8D/>模板匹配</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idb3ab72602c424239650497dc08de1a98")' href=#idb3ab72602c424239650497dc08de1a98 aria-expanded=false aria-controls=idb3ab72602c424239650497dc08de1a98 aria-hidden=false data-toggle=collapse></div></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>Test Double</h1><div class=article-style><h1 id=test-double>Test Double</h1><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://res.cloudinary.com/dhttas9u5/image/upload/test-doubles_bmkusn.jpg alt loading=lazy data-zoomable></div></div></figure></p><p>本部分主要介绍所谓的 Test Double 的概念，并且对其中容易被混用的 Mocks 与 Stubs 的概念进行一个阐述。在初期接触到的时候，很多人会把 Mock 对象与另一个单元测试中经常用到的 Stub 对象搞混掉。为了方便更好地理解，这里把所有的所谓的 Test Double 的概念进行一个说明。我们先来看一个常用的单元测试的用例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>OrderEasyTester</span> <span class=kd>extends</span> <span class=n>TestCase</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>String</span> <span class=n>TALISKER</span> <span class=o>=</span> <span class=s>&#34;Talisker&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>MockControl</span> <span class=n>warehouseControl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Warehouse</span> <span class=n>warehouseMock</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span> <span class=o>=</span> <span class=n>MockControl</span><span class=o>.</span><span class=na>createControl</span><span class=o>(</span><span class=n>Warehouse</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseMock</span> <span class=o>=</span> <span class=o>(</span><span class=n>Warehouse</span><span class=o>)</span> <span class=n>warehouseControl</span><span class=o>.</span><span class=na>getMock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>testFillingRemovesInventoryIfInStock</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//setup - data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Order</span> <span class=n>order</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Order</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//setup - expectations
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>warehouseMock</span><span class=o>.</span><span class=na>hasInventory</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>setReturnValue</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseMock</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>replay</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//exercise
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>order</span><span class=o>.</span><span class=na>fill</span><span class=o>(</span><span class=n>warehouseMock</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//verify
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>verify</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertTrue</span><span class=o>(</span><span class=n>order</span><span class=o>.</span><span class=na>isFilled</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>testFillingDoesNotRemoveIfNotEnoughInStock</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Order</span> <span class=n>order</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Order</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>51</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>warehouseMock</span><span class=o>.</span><span class=na>hasInventory</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>51</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>setReturnValue</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>replay</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=na>fill</span><span class=o>((</span><span class=n>Warehouse</span><span class=o>)</span> <span class=n>warehouseMock</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertFalse</span><span class=o>(</span><span class=n>order</span><span class=o>.</span><span class=na>isFilled</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouseControl</span><span class=o>.</span><span class=na>verify</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>当我们进行单元测试的时候，我们会专注于软件中的一个小点，不过问题就是虽然我们只想进行一个单一模块的测试，但是不得不依赖于其他模块，就好像上面例子中的 warehouse。而在我提供的两种不同的测试用例的编写方案中，第一个是使用了真实的 warehouse 对象，而第二个使用了所谓的 mock 的 warehouse 对象，也意味着并不是一个真正的 warehouse。使用 Mock 对象也是一种常用的在测试中避免依赖真正的对象的方法，不过像这种在测试中不使用真正对象的方法也有很多。我们经常看到的类似的关联的名词会有：stub、mock、fake、dummy。本文中我是打算借鉴 Gerard Meszaros 的论述，可能并不是所有人都怎么描述，不过我觉得 Gerard Meszaros 说的不错。Gerard Meszaros 是用<code>Test Double</code>这个术语来称呼这一类用于替换真实对象的模拟对象。Gerard Meszaros 具体定义了以下几类 double:</p><ul><li>Dummy : 用于传递给调用者但是永远不会被真实使用的对象，通常它们只是用来填满参数列表。</li><li>Fake : Fake 对象常常与类的实现一起起作用，但是只是为了让其他程序能够正常运行，譬如内存数据库就是一个很好的例子。</li><li>Stubs : Stubs 通常用于在测试中提供封装好的响应，譬如有时候编程设定的并不会对所有的调用都进行响应。Stubs 也会记录下调用的记录，譬如一个 email gateway 就是一个很好的例子，它可以用来记录所有发送的信息或者它发送的信息的数目。简而言之，Stubs 一般是对一个真实对象的封装。</li><li>Mocks : Mocks 也就是 Fowler 这篇文章讨论的重点，即是针对设定好的调用方法与需要响应的参数封装出合适的对象。</li></ul><p>在上述这几种 doubles 中，只有 mocks 强调行为验证，其他的一般都是强调状态验证。为了更好地描述这种区别，我们会对上面的例子进行一些扩展。一般在真实对象不太好交互或者代码还没有写好的时候，我们会选择使用一个测试的 Double。譬如我们需要测试一个发送邮件的程序是不是能够在发送邮件的时候设定正确的顺序，而我们肯定不希望真的发邮件出去，这样会被打死的。因此我们会为我们的 email 系统来创建一个 test double。这里也是用例子来展示 mocks 与 stubs 区别的地方：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>MailService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>send</span><span class=o>(</span><span class=n>Message</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MailServiceStub</span> <span class=kd>implements</span> <span class=n>MailService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;</span> <span class=n>messages</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>send</span><span class=o>(</span><span class=n>Message</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=nf>numberSent</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>messages</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>然后就可以进行状态验证了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>OrderStateTester</span><span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>testOrderSendsMailIfUnfilled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Order</span> <span class=n>order</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Order</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>51</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>MailServiceStub</span> <span class=n>mailer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MailServiceStub</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=na>setMailer</span><span class=o>(</span><span class=n>mailer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=na>fill</span><span class=o>(</span><span class=n>warehouse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>assertEquals</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=n>mailer</span><span class=o>.</span><span class=na>numberSent</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></div><p>当然这是一个非常简单的测试，我们并没有测试它是否发给了正确的人或者发出了正确的内容。而如果使用 Mock 的话写法就很不一样了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>OrderInteractionTester</span><span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>testOrderSendsMailIfUnfilled</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Order</span> <span class=n>order</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Order</span><span class=o>(</span><span class=n>TALISKER</span><span class=o>,</span> <span class=mi>51</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Mock</span> <span class=n>warehouse</span> <span class=o>=</span> <span class=n>mock</span><span class=o>(</span><span class=n>Warehouse</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Mock</span> <span class=n>mailer</span> <span class=o>=</span> <span class=n>mock</span><span class=o>(</span><span class=n>MailService</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=na>setMailer</span><span class=o>((</span><span class=n>MailService</span><span class=o>)</span> <span class=n>mailer</span><span class=o>.</span><span class=na>proxy</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mailer</span><span class=o>.</span><span class=na>expects</span><span class=o>(</span><span class=n>once</span><span class=o>()).</span><span class=na>method</span><span class=o>(</span><span class=s>&#34;send&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>warehouse</span><span class=o>.</span><span class=na>expects</span><span class=o>(</span><span class=n>once</span><span class=o>()).</span><span class=na>method</span><span class=o>(</span><span class=s>&#34;hasInventory&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>withAnyArguments</span><span class=o>()</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=na>will</span><span class=o>(</span><span class=n>returnValue</span><span class=o>(</span><span class=kc>false</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=na>fill</span><span class=o>((</span><span class=n>Warehouse</span><span class=o>)</span> <span class=n>warehouse</span><span class=o>.</span><span class=na>proxy</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在两个例子中我们都是用了 test double 来替代真正的 mail 服务，不同的在于 stub 是用的状态验证而 mock 使用的是行为验证。如果要基于 stub 编写状态验证的方法，需要写一些额外的代码来进行验证。而 Mock 对象用的是行为验证，并不需要写太多的额外代码。</p><h1 id=测试中-fakesmocks-以及-stubs-概念明晰>测试中 Fakes、Mocks 以及 Stubs 概念明晰</h1><p>自动化测试中，我们常会使用一些经过简化的，行为与表现类似于生产环境下的对象的复制品。引入这样的复制品能够降低构建测试用例的复杂度，允许我们独立而解耦地测试某个模块，不再担心受到系统中其他部分的影响；这类型对象也就是所谓的 Test Double。实际上对于 Test Double 的定义与阐述也是见仁见智，Gerard Meszaros 在<a href=http://xunitpatterns.com/Test%20Double.html target=_blank rel=noopener>这篇文章</a>中就介绍了五个不同的 Double 类型；而人们更倾向于使用 Mock 来统一描述不同的 Test Doubles。不过对于 Test Doubles 实现的误解还是可能会影响到测试的设计，使测试用例变得混乱和脆弱，最终带来不必要的重构。本文则是从作者个人的角度描述了常见的 Test Doubles 类型及其具体的实现：Fake、Stub 与 Mock，并且给出了不同的 Double 的使用场景。</p><h1 id=fake>Fake</h1><blockquote><p>Fakes are objects that have working implementations, but not same as production one. Usually they take some shortcut and have simplified version of production code.
Fake 是那些包含了生产环境下具体实现的简化版本的对象。</p></blockquote><p>如下图所示，Fake 可以是某个 Data Access Object 或者 Repository 的基于内存的实现；该实现并不会真的去进行数据库操作，而是使用简单的 HashMap 来存放数据。这就允许了我们能够在并没有真的启动数据库或者执行耗时的外部请求的情况下进行服务的测试。</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://res.cloudinary.com/practicaldev/image/fetch/s--KVtUzSi6--/c_limit,f_auto,fl_progressive,q_auto,w_880/https://thepracticaldev.s3.amazonaws.com/i/8iym8jnai3zno15i5uvi.png alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>@Profile(&#34;transient&#34;)
public class FakeAccountRepository implements AccountRepository {

   Map&lt;User, Account&gt; accounts = new HashMap&lt;&gt;();

   public FakeAccountRepository() {
       this.accounts.put(new User(&#34;john@bmail.com&#34;), new UserAccount());
       this.accounts.put(new User(&#34;boby@bmail.com&#34;), new AdminAccount());
   }

   String getPasswordHash(User user) {
       return accounts.get(user).getPasswordHash();
   }
}
</code></pre><p>除了应用到测试，Fake 还能够用于进行原型设计或者峰值模拟中；我们能够迅速地实现系统原型，并且基于内存存储来运行整个系统，推迟有关数据库设计所用到的一些决定。另一个常见的使用场景就是利用 Fake 来保证在测试环境下支付永远返回成功结果。</p><h1 id=stub>Stub</h1><blockquote><p>Stub is an object that holds predefined data and uses it to answer calls during tests. It is used when we cannot or don’t want to involve objects that would answer with real data or have undesirable side effects.
Stub 代指那些包含了预定义好的数据并且在测试时返回给调用者的对象。Stub 常被用于我们不希望返回真实数据或者造成其他副作用的场景。</p></blockquote><p>Stub 的典型应用场景即是当某个对象需要从数据库抓取数据时，我们并不需要真实地与数据库进行交互或者像 Fake 那样从内存中抓取数据，而是直接返回预定义好的数据。<figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://res.cloudinary.com/practicaldev/image/fetch/s--teEfYNfN--/c_limit,f_auto,fl_progressive,q_auto,w_880/https://thepracticaldev.s3.amazonaws.com/i/2v592ht59ksiprwgzjzq.png alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>public class GradesService {

   private final Gradebook gradebook;

   public GradesService(Gradebook gradebook) {
       this.gradebook = gradebook;
   }

   Double averageGrades(Student student) {
       return average(gradebook.gradesFor(student));
   }
}
</code></pre><p>我们在编写测试用例时并没有从 Gradebook 存储中抓取数据，而是在 Stub 中直接定义好需要返回的成绩列表；我们只需要足够的数据来保证对平均值计算函数进行测试就好了。</p><pre tabindex=0><code>public class GradesServiceTest {

   private Student student;
   private Gradebook gradebook;

   @Before
   public void setUp() throws Exception {
       gradebook = mock(Gradebook.class);
       student = new Student();
   }

   @Test
   public void calculates_grades_average_for_student() {
       when(gradebook.gradesFor(student)).thenReturn(grades(8, 6, 10)); //stubbing gradebook

       double averageGrades = new GradesService(gradebook).averageGrades(student);

       assertThat(averageGrades).isEqualTo(8.0);
   }
}
</code></pre><h1 id=command-query-separation>Command Query Separation</h1><p>仅返回部分结果而并没有真实改变系统状态的的方法被称作查询(Query)。譬如 <code>avarangeGrades</code>，用于返回学生成绩平均值的函数就是非常典型的例子：<code>Double getAverageGrades(Student student);</code>。该函数仅返回了某个值，而没有其他的任何副作用。正如我们上文中介绍的，我们可以使用 Stubs 来替换提供实际成绩值的函数，从而简化了整个测试用例的编写。不过除了 Query 之外还有另一个类别的方法，被称作 Command。即当某个函数在执行某些操作的时候还改变了系统状态，不过该类型函数往往没有什么返回值：void sendReminderEmail(Student student);。这种对于方法的划分方式也就是 Bertrand Meyer 在 <a href=https://www.amazon.com/Object-Oriented-Software-Construction-Book-CD-ROM/dp/0136291554 target=_blank rel=noopener>Object Oriented Software Construction</a> 一书中介绍的 Command Query 分割法。
对于 Query 类型的方法我们会优先考虑使用 Stub 来代替方法的返回值，而对于 Command 类型的方法的测试则需要依赖于 Mock。</p><h1 id=mock>Mock</h1><blockquote><p>Mocks are objects that register calls they receive. In test assertion we can verify on Mocks that all expected actions were performed.
Mocks 代指那些仅记录它们的调用信息的对象，在测试断言中我们需要验证 Mocks 被进行了符合期望的调用。</p></blockquote><p>当我们并不希望真的调用生产环境下的代码或者在测试中难于验证真实代码执行效果的时候，我们会用 Mock 来替代那些真实的对象。典型的例子即是对邮件发送服务的测试，我们并不希望每次进行测试的时候都发送一封邮件，毕竟我们很难去验证邮件是否真的被发出了或者被接收了。我们更多地关注于邮件服务是否按照我们的预期在合适的业务流中被调用，其概念如下图所示：<figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://res.cloudinary.com/practicaldev/image/fetch/s--VOv4blDO--/c_limit,f_auto,fl_progressive,q_auto,w_880/https://thepracticaldev.s3.amazonaws.com/i/4axggbc9kiqrvl1fguju.png alt loading=lazy data-zoomable></div></div></figure></p><pre tabindex=0><code>public class SecurityCentral {

   private final Window window;
   private final Door door;

   public SecurityCentral(Window window, Door door) {
       this.window = window;
       this.door = door;
   }

   void securityOn() {
       window.close();
       door.close();
   }
}
</code></pre><p>在上述代码中，我们并不想真的去关门来测试 securityOn 方法，因此我们可以设置合适的 Mock 对象：</p><pre tabindex=0><code>public class SecurityCentralTest {

   Window windowMock = mock(Window.class);
   Door doorMock = mock(Door.class);

   @Test
   public void enabling_security_locks_windows_and_doors() {
       SecurityCentral securityCentral = new SecurityCentral(windowMock, doorMock);

       securityCentral.securityOn();

       verify(doorMock).close();
       verify(windowMock).close();
   }
}
</code></pre><p>在 <code>securityOn</code> 方法执行之后，window 与 door 的 Mock 对象已经记录了所有的交互信息，这就允许我们能够去验证 Window 与 Door 是否被真实的调用。或许有人会疑问是否在真实环境下门与窗是否被真的关闭了？其实我们并不能保证，不过这也不是我们关注的点，也不是 <code>SecurityCentral</code> 这个类关注的目标。门与窗是否能被正常的关闭应该是由 <code>Door</code> 与 <code>Window</code> 这两个类所关注的。</p></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/tdd/ rel=next>TDD</a></div><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/test-notes/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/%E6%B5%8B%E8%AF%95%E5%88%86%E7%B1%BB/ rel=prev>测试分类</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div><script type=text/javascript id=clstr_globe async src="//clustrmaps.com/globe.js?d=kgpJG5sWZQpKujBmD-uW1B54-WBPol-DuDtrB2KFjKs"></script></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>