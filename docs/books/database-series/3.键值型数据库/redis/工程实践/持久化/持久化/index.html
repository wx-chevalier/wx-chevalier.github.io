<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="持久化备份与迁移 持久化方式 原理 特点 启用方式 RDB(快照持久化) 当符合快照条件时，会自动将内存中的所有数据进行快照并且存储到硬盘上 针对热数据，记录和恢复效率高，恢复不完整 默认启用 AOF(追加持久化) 将发"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%8C%81%E4%B9%85%E5%8C%96/%E6%8C%81%E4%B9%85%E5%8C%96/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%8C%81%E4%B9%85%E5%8C%96/%E6%8C%81%E4%B9%85%E5%8C%96/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%8C%81%E4%B9%85%E5%8C%96/%E6%8C%81%E4%B9%85%E5%8C%96/"><meta property="og:title" content="持久化 | Next-gen Tech Edu"><meta property="og:description" content="持久化备份与迁移 持久化方式 原理 特点 启用方式 RDB(快照持久化) 当符合快照条件时，会自动将内存中的所有数据进行快照并且存储到硬盘上 针对热数据，记录和恢复效率高，恢复不完整 默认启用 AOF(追加持久化) 将发"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>持久化 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=1c717bd76244ef423ac45562620c724a><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">持久化</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id0cbb3c360be90b56914f53994099f096")' href=#id0cbb3c360be90b56914f53994099f096 aria-expanded=false aria-controls=id0cbb3c360be90b56914f53994099f096 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/>工程实践</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id0cbb3c360be90b56914f53994099f096 aria-expanded=false aria-controls=id0cbb3c360be90b56914f53994099f096><i class="fa-solid fa-angle-down" id=caret-id0cbb3c360be90b56914f53994099f096></i></a></div><ul class="nav docs-sidenav collapse show" id=id0cbb3c360be90b56914f53994099f096><li class="child level"><a href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE/>部署与配置</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idcb0c740d9c2acd053878782e9d83603c")' href=#idcb0c740d9c2acd053878782e9d83603c aria-expanded=false aria-controls=idcb0c740d9c2acd053878782e9d83603c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%8C%81%E4%B9%85%E5%8C%96/>持久化</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idcb0c740d9c2acd053878782e9d83603c aria-expanded=false aria-controls=idcb0c740d9c2acd053878782e9d83603c><i class="fa-solid fa-angle-down" id=caret-idcb0c740d9c2acd053878782e9d83603c></i></a></div><ul class="nav docs-sidenav collapse show" id=idcb0c740d9c2acd053878782e9d83603c><li class="child level active"><a href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%8C%81%E4%B9%85%E5%8C%96/%E6%8C%81%E4%B9%85%E5%8C%96/>持久化</a></li></ul></div><li class="child level"><a href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>性能优化</a></li><li class="child level"><a href=/books/database-series/3.%E9%94%AE%E5%80%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%84%9A%E6%9C%AC/>自定义脚本</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><ul><li><a href=#rdb>RDB</a></li><li><a href=#arf>ARF</a></li></ul></li><li><a href=#1-在新服务器上启动一个-redis-实例>1. 在新服务器上启动一个 redis 实例</a></li><li><a href=#2-使新的-redis-服务成为-slave>2. 使新的 redis 服务成为 slave</a></li><li><a href=#3-完成迁移>3. 完成迁移</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>持久化</h1><div class=article-style><h1 id=持久化备份与迁移>持久化备份与迁移</h1><table><thead><tr><th><strong>持久化方式</strong></th><th><strong>原理</strong></th><th><strong>特点</strong></th><th><strong>启用方式</strong></th></tr></thead><tbody><tr><td>RDB(快照持久化)</td><td>当符合快照条件时，会自动将内存中的所有数据进行快照并且存储到硬盘上</td><td>针对热数据，记录和恢复效率高，恢复不完整</td><td>默认启用</td></tr><tr><td>AOF(追加持久化)</td><td>将发送到服务端的每一条请求都记录下来,并且保存在硬盘的 AOF 文件中</td><td>针对所有请求，记录和恢复效率低，恢复完整</td><td>配置文件</td></tr></tbody></table><p>Redis 提供了多种不同级别的持久化方式:一种是 RDB,另一种是 AOF。</p><ul><li>RDB 持久化可以在指定的时间间隔内生成数据集的时间点快照(point-in-time snapshot)。</li></ul><ul><li>AOF 持久化记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。AOF 文件中的命令全部以 Redis 协议的格式来保存，新命令会被追加到文件的末尾。Redis 还可以在后台对 AOF 文件进行重写(rewrite)，使得 AOF 文件的体积不会超出保存数据集状态所需的实际大小。Redis 还可以同时使用 AOF 持久化和 RDB 持久化。在这种情况下，当 Redis 重启时，它会优先使用 AOF 文件来还原数据集，因为 AOF 文件保存的数据集通常比 RDB 文件所保存的数据集更完整。你甚至可以关闭持久化功能，让数据只在服务器运行时存在。</li></ul><p>一般来说,如果想达到足以媲美 PostgreSQL 的数据安全性，你应该同时使用两种持久化功能。如果你非常关心你的数据,但仍然可以承受数分钟以内的数据丢失，那么你可以只使用 RDB 持久化。有很多用户都只使用 AOF 持久化，但我们并不推荐这种方式: 因为定时生成 RDB 快照(snapshot)非常便于进行数据库备份，并且 RDB 恢复数据集的速度也要比 AOF 恢复的速度要快，除此之外，使用 RDB 还可以避免之前提到的 AOF 程序的 bug。因为以上提到的种种原因，未来我们可能会将 AOF 和 RDB 整合成单个持久化模型。(这是一个长期计划。)</p><pre tabindex=0><code># The filename where to dump the DB
dbfilename dump.rdb

# The working directory.
#
# The DB will be written inside this directory, with the filename specified
# above using the &#39;dbfilename&#39; configuration directive.
#
# Also the Append Only File will be created inside this directory.
#
# Note that you must specify a directory here, not a file name.
dir /var/lib/redis
</code></pre><h3 id=rdb>RDB</h3><p>RDB 的优点:</p><p>RDB</p><p>是一个非常紧凑(compact)的文件，它保存了 Redis 在某个时间点上的数据集。这种文件非常适合用于进行备份: 比如说，你可以在最近的</p><p>24 小时内，每小时备份一次 RDB 文件，并且在每个月的每一天，也备份一个 RDB 文件。</p><p>这样的话，即使遇上问题，也可以随时将数据集还原到不同的版本。RDB 非常适用于灾难恢复(disaster</p><p>recovery)：它只有一个文件，并且内容都非常紧凑，可以(在加密后)将它传送到别的数据中心，或者亚马逊 S3 中。RDB 可以最大化</p><p>Redis 的性能：父进程在保存 RDB 文件时唯一要做的就是 fork</p><p>出一个子进程，然后这个子进程就会处理接下来的所有保存工作，父进程无须执行任何磁盘 IO 操作。RDB 在恢复大数据集时的速度比 AOF</p><p>的恢复速度要快。</p><p>RDB 的缺点:</p><p>如果你需要尽量避免在服务器故障时丢失数据，那么 RDB 不适合你。虽然 Redis 允许你设置不同的保存点(save point)来控制保存</p><p>RDB 文件的频率，但是，因为 RDB 文件需要保存整个数据集的状态，所以它并不是一个轻松的操作。因此你可能会至少 5 分钟才保存一次</p><p>RDB 文件。在这种情况下，一旦发生故障停机，你就可能会丢失好几分钟的数据。每次保存 RDB 的时候，Redis 都要 fork()</p><p>出一个子进程，并由子进程来进行实际的持久化工作。在数据集比较庞大时，fork() 可能会非常耗时，造成服务器在某某毫秒内停止处理客户端；</p><p>如果数据集非常巨大，并且 CPU 时间非常紧张的话，那么这种停止时间甚至可能会长达整整一秒。虽然 AOF 重写也需要进行 fork()</p><p>，但无论 AOF 重写的执行间隔有多长，数据的耐久性都不会有任何损失。</p><p>RDB 快照:</p><p>在默认情况下，Redis</p><p>将数据库快照保存在名字为 dump.rdb 的二进制文件中。你可以对 Redis 进行设置，让它在“ N 秒内数据集至少有 M</p><p>个改动”这一条件被满足时，自动保存一次数据集。你也可以通过调用 SAVE 或者 BGSAVE，手动让 Redis</p><p>进行数据集保存操作。比如说，以下设置会让 Redis 在满足“ 60 秒内有至少有 1000 个键被改动”这一条件时，自动保存一次数据集：</p><p>save 60 1000</p><p>这种持久化方式被称为快照(snapshot)。</p><p>快照的运作方式:</p><p>当 Redis 需要保存 dump.rdb 文件时，服务器执行以下操作：</p><p>Redis 调用 fork()，同时拥有父进程和子进程。</p><p>子进程将数据集写入到一个临时 RDB 文件中。</p><p>当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件。</p><p>这种工作方式使得 Redis 可以从写时复制(copy-on-write)机制中获益。</p><p>只进行追加操作的文件(append-only file，AOF)</p><p>快照功能并不是非常耐久(durable): 如果 Redis 因为某些原因而造成故障停机，</p><p>那么服务器将丢失最近写入、且仍未保存到快照中的那些数据。尽管对于某些程序来说，数据的耐久性并不是最重要的考虑因素，</p><p>但是对于那些追求完全耐久能力(full durability)的程序来说，快照功能就不太适用了。</p><p>从 1.1 版本开始，Redis 增加了一种完全耐久的持久化方式: AOF 持久化。</p><p>你可以通过修改配置文件来打开 AOF 功能：</p><p>appendonly yes</p><p>从现在开始，每当 Redis 执行一个改变数据集的命令时(比如 SET)，这个命令就会被追加到 AOF 文件的末尾。</p><p>这样的话，当 Redis 重新启时，程序就可以通过重新执行 AOF 文件中的命令来达到重建数据集的目的。</p><h3 id=arf>ARF</h3><p>AOF 的优点:</p><p>使用 AOF 持久化会让 Redis</p><p>变得非常耐久(much more durable)：你可以设置不同的 fsync 策略，比如无 fsync，每秒钟一次 fsync</p><p>，或者每次执行写入命令时 fsync。AOF 的默认策略为每秒钟 fsync 一次，在这种配置下，Redis</p><p>仍然可以保持良好的性能，并且就算发生故障停机，也最多只会丢失一秒钟的数据( fsync</p><p>会在后台线程执行，所以主线程可以继续努力地处理命令请求)。AOF 文件是一个只进行追加操作的日志文件(append only log)，因此对</p><p>AOF 文件的写入不需要进行 seek，即使日志因为某些原因而包含了未写入完整的命令(比如写入时磁盘已满，写入中途停机，等等)，</p><p>redis-check-aof 工具也可以轻易地修复这种问题。</p><p>Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF</p><p>进行重写: 重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。整个重写操作是绝对安全的，因为 Redis 在创建新 AOF</p><p>文件的过程中，会继续将命令追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。而一旦新 AOF</p><p>文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作。AOF</p><p>文件有序地保存了对数据库执行的所有写入操作，这些写入操作以 Redis 协议的格式保存，因此 AOF 文件的内容非常容易被人读懂，</p><p>对文件进行分析(parse)也很轻松。导出(export) AOF 文件也非常简单: 举个例子，如果你不小心执行了 FLUSHALL 命令，</p><p>但只要 AOF 文件未被重写，那么只要停止服务器，移除 AOF 文件末尾的 FLUSHALL 命令，并重启 Redis，</p><p>就可以将数据集恢复到 FLUSHALL 执行之前的状态。</p><p>AOF 的缺点:</p><p>对于相同的数据集来说，AOF</p><p>文件的体积通常要大于 RDB 文件的体积。根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB。在一般情况下，每秒</p><p>fsync 的性能依然非常高，而关闭 fsync 可以让 AOF 的速度和 RDB 一样快，即使在高负荷之下也是如此。</p><p>不过在处理巨大的写入载入时，RDB 可以提供更有保证的最大延迟时间(latency)。AOF 在过去曾经发生过这样的 bug</p><p>因为个别命令的原因，导致 AOF 文件在重新载入时，无法将数据集恢复成保存时的原样。(举个例子，阻塞命令 BRPOPLPUSH</p><p>就曾经引起过这样的 bug。) 测试套件里为这种情况添加了测试: 它们会自动生成随机的、复杂的数据集，并通过重新载入这些数据来确保一切正常。</p><p>虽然这种 bug 在 AOF 文件中并不常见，但是对比来说，RDB 几乎是不可能出现这种 bug 的。</p><p>AOF 重写:</p><p>因为 AOF</p><p>的运作方式是不断地将命令追加到文件的末尾，所以随着写入命令的不断增加，AOF 文件的体积也会变得越来越大。举个例子，</p><p>如果你对一个计数器调用了 100 次 INCR，那么仅仅是为了保存这个计数器的当前值，AOF 文件就需要使用 100</p><p>条记录(entry)。然而在实际上，只使用一条 SET 命令已经足以保存计数器的当前值了，其余 99</p><p>条记录实际上都是多余的。为了处理这种情况，Redis 支持一种有趣的特性: 可以在不打断服务客户端的情况下，对 AOF</p><p>文件进行重建(rebuild)。执行 BGREWRITEAOF 命令，Redis 将生成一个新的 AOF 文件，</p><p>这个文件包含重建当前数据集所需的最少命令。</p><p>AOF 有多耐久？</p><p>你可以配置 Redis 多久才将数据 fsync 到磁盘一次。</p><p>有三个选项：</p><p>每次有新命令追加到 AOF 文件时就执行一次 fsync：非常慢，也非常安全。</p><p>每秒 fsync 一次：足够快(和使用 RDB 持久化差不多)，并且在故障时只会丢失 1 秒钟的数据。</p><p>从不 fsync：将数据交给操作系统来处理。更快，也更不安全的选择。</p><p>推荐(并且也是默认)的措施为每秒 fsync 一次，这种 fsync 策略可以兼顾速度和安全性。</p><p>总是 fsync 的策略在实际使用中非常慢，即使在 Redis 2.0 对相关的程序进行了改进之后仍是如此：频繁调用 fsync 注定了这种策略不可能快得起来。</p><p>如果 AOF 文件出错了，怎么办？</p><p>服务器可能在程序正在对 AOF 文件进行写入时停机，如果停机造成了 AOF 文件出错(corrupt)，那么 Redis 在重启时会拒绝载入这个 AOF 文件，从而确保数据的一致性不会被破坏。</p><p>当发生这种情况时，可以用以下方法来修复出错的 AOF 文件：</p><p>为现有的 AOF 文件创建一个备份。</p><p>使用 Redis 附带的 redis-check-aof 程序，对原来的 AOF 文件进行修复。</p><p>$ redis-check-aof &ndash;fix</p><p>(可选)使用 diff -u 对比修复后的 AOF 文件和原始 AOF 文件的备份，查看两个文件之间的不同之处。</p><p>重启 Redis 服务器，等待服务器载入修复后的 AOF 文件，并进行数据恢复。</p><p>AOF 的运作方式</p><p>AOF 重写和 RDB 创建快照一样，都巧妙地利用了写时复制机制。</p><p>以下是 AOF 重写的执行步骤:</p><p>Redis 执行 fork()，现在同时拥有父进程和子进程。</p><p>子进程开始将新 AOF 文件的内容写入到临时文件。对于所有新执行的写入命令，父进程一边将它们累积到一个内存缓存中，一边将这些改动追加到现有</p><p>AOF 文件的末尾: 这样即使在重写的中途发生停机，现有的 AOF</p><p>文件也还是安全的。当子进程完成重写工作时，它给父进程发送一个信号，父进程在接收到信号之后，将内存缓存中的所有数据追加到新 AOF</p><p>文件的末尾。现在 Redis 原子地用新文件替换旧文件，之后所有命令都会直接追加到新 AOF 文件的末尾。</p><p>为最新的 dump.rdb 文件创建一个备份。</p><p>将备份放到一个安全的地方。</p><p>执行以下两条命令：</p><p>redis-cli> CONFIG SET appendonly yes</p><p>redis-cli> CONFIG SET save ""</p><p>确保命令执行之后，数据库的键的数量没有改变。</p><p>确保写命令会被正确地追加到 AOF 文件的末尾。</p><p>步骤 3 执行的第一条命令开启了 AOF 功能: Redis 会阻塞直到初始 AOF 文件创建完成为止，之后 Redis 会继续处理命令请求，并开始将写入命令追加到 AOF 文件末尾。</p><p>步骤 3 执行的第二条命令用于关闭 RDB 功能。这一步是可选的，如果你愿意的话，也可以同时使用 RDB 和 AOF 这两种持久化功能。</p><p>别忘了在 redis.conf 中打开 AOF 功能！ 否则的话，服务器重启之后，之前通过 CONFIG SET 设置的配置就会被遗忘，程序会按原来的配置来启动服务器。</p><p><a href=http://www.bitstech.net/2016/03/03/redis-migration/ target=_blank rel=noopener>redis-migration：独创的 redis 在线数据迁移工具</a></p><p>最近需要把一个 redis 服务从一台服务器上迁移到另外一台上，所以找了一下迁移的方案，有说在第一台 把数据 Dump 完然后复制数据文件过去，之后在新机器上起来 redis 实例，但是这样 redis 将会有一段无法 使用的时间。</p><p>后来发现使用 redis 的 <a href=http://redis.io/topics/replication target=_blank rel=noopener>replication</a> 可以极其简单的实现 redis 从一个地方到另外一个地方的迁移。</p><h2 id=1-在新服务器上启动一个-redis-实例>1. 在新服务器上启动一个 redis 实例</h2><p>首先我们先在需要迁移到的服务器上启动一个新的 redis 实例，配置没有什么特别的地方，值得注意的是，从 redis2.6 以后，redis 的 slave 默认变得不再接受写操作，所以我们需要修改 conf 中的</p><pre tabindex=0><code>#slave-read-only yes
slave-read-only no
</code></pre><p>这样 slave 才能正常的接受写操作，不然之后写的时候会报错。</p><h2 id=2-使新的-redis-服务成为-slave>2. 使新的 redis 服务成为 slave</h2><p>当新的 redis 起来后，我们使用 redis-cli 连进去，然后使用 <a href=http://redis.io/commands/slaveof target=_blank rel=noopener>slaveof</a> 命令使这个 redis 成为我们的旧 redis 的 slave:</p><pre tabindex=0><code>redis 127.0.0.1:6379&gt; SLAVEOF 192.168.1.100 6379
OK
</code></pre><p>在这之后，这两个 redis 会自动开始同步，如果需要查看同步的状态，可以使用 info 命令。</p><h2 id=3-完成迁移>3. 完成迁移</h2><p>等 master 和 slave 之间的同步完成后，我们就可以修改我们的应用，让它们使用新的 redis server 地址了。把地址全部修改完以后，在新的 redis 上执行</p><pre tabindex=0><code>redis 127.0.0.1:6379&gt; SLAVEOF no one
</code></pre><p>让它重新变成老大，这样整个迁移就完成了。之后关闭调旧的 redis 旧 ok 了</p></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte-website.oss-accelerate.aliyuncs.com/disqus/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte-website.oss-accelerate.aliyuncs.com/disqus/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>