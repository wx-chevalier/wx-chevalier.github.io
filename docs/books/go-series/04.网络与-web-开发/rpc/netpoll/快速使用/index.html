<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="2. Tutorial 2.1 编写 NIO Server 现在我们开始编写一个 server 吧，首先我们先给出一个完整的 server 范例，然后分解其编写逻辑。 package main import ( &#34;context&#34; &#34;time&#34; &#34;github.com/cloudwego/netpoll&#34; ) func main() { network, address := &#34;tcp&#34;, &#34;127.0.0.1:8888&#34; // 创建 listener listener, err := netpoll.CreateListener(network, address) if err != nil { panic(&#34;create netpoll listener fail&#34;) } // handle: 连接读数据和处理逻辑 var onRequest netpoll.OnRequest = handler // options:"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/netpoll/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/netpoll/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/netpoll/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8/"><meta property="og:title" content="快速使用 | Next-gen Tech Edu"><meta property="og:description" content="2. Tutorial 2.1 编写 NIO Server 现在我们开始编写一个 server 吧，首先我们先给出一个完整的 server 范例，然后分解其编写逻辑。 package main import ( &#34;context&#34; &#34;time&#34; &#34;github.com/cloudwego/netpoll&#34; ) func main() { network, address := &#34;tcp&#34;, &#34;127.0.0.1:8888&#34; // 创建 listener listener, err := netpoll.CreateListener(network, address) if err != nil { panic(&#34;create netpoll listener fail&#34;) } // handle: 连接读数据和处理逻辑 var onRequest netpoll.OnRequest = handler // options:"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>快速使用 | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=cfcc890c6ad8335d750e3d6f4593d1a5><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">Netpoll</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id759f5a4364bc3f89d1bcc0c60a740feb")' href=#id759f5a4364bc3f89d1bcc0c60a740feb aria-expanded=false aria-controls=id759f5a4364bc3f89d1bcc0c60a740feb aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/>RPC</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id759f5a4364bc3f89d1bcc0c60a740feb aria-expanded=false aria-controls=id759f5a4364bc3f89d1bcc0c60a740feb><i class="fa-solid fa-angle-down" id=caret-id759f5a4364bc3f89d1bcc0c60a740feb></i></a></div><ul class="nav docs-sidenav collapse show" id=id759f5a4364bc3f89d1bcc0c60a740feb><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id6c2f086b0a5823d173a07741afb3f722")' href=#id6c2f086b0a5823d173a07741afb3f722 aria-expanded=false aria-controls=id6c2f086b0a5823d173a07741afb3f722 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/netpoll/>Netpoll</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id6c2f086b0a5823d173a07741afb3f722 aria-expanded=false aria-controls=id6c2f086b0a5823d173a07741afb3f722><i class="fa-solid fa-angle-down" id=caret-id6c2f086b0a5823d173a07741afb3f722></i></a></div><ul class="nav docs-sidenav collapse show" id=id6c2f086b0a5823d173a07741afb3f722><li class="child level active"><a href=/books/go-series/04.%E7%BD%91%E7%BB%9C%E4%B8%8E-web-%E5%BC%80%E5%8F%91/rpc/netpoll/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8/>快速使用</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#21-编写-nio-server>2.1 编写 NIO Server</a><ul><li><a href=#211-创建-listener>2.1.1 创建 Listener</a></li><li><a href=#212-创建-eventloop>2.1.2 创建 EventLoop</a></li><li><a href=#213-运行-server>2.1.3 运行 Server</a></li><li><a href=#214-关闭-server>2.1.4 关闭 Server</a></li></ul></li><li><a href=#22-使用编写-dialer>2.2 使用/编写 Dialer</a><ul><li><a href=#221-缺省方式创建连接>2.2.1 缺省方式创建连接</a></li><li><a href=#222-创建-dialer>2.2.2 创建 Dialer</a></li></ul></li><li><a href=#23-使用-connection>2.3 使用 Connection</a><ul><li><a href=#231-使用-zero-copy-api>2.3.1 使用 zero-copy API</a></li><li><a href=#232-继承-zero-copy-能力>2.3.2 继承 zero-copy 能力</a></li></ul></li></ul><ul><li><a href=#31-如何配置-poller-个数>3.1 如何配置 poller 个数</a></li><li><a href=#32-如何配置-poller-连接负载均衡策略>3.2 如何配置 poller 连接负载均衡策略</a></li><li><a href=#33-如何配置-gopool-协程池>3.3 如何配置 gopool 协程池</a></li><li><a href=#34-如何初始化新连接>3.4 如何初始化新连接</a></li><li><a href=#35-如何配置连接超时>3.5 如何配置连接超时</a></li><li><a href=#36-如何配置连接读事件回调>3.6 如何配置连接读事件回调</a></li><li><a href=#37-如何配置连接关闭回调>3.7 如何配置连接关闭回调</a></li><li><a href=#38-如何使用-linkbuffer>3.8 如何使用 LinkBuffer</a></li></ul><ul><li><a href=#41-错误设置-numloops>4.1 错误设置 NumLoops</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>快速使用</h1><div class=article-style><h1 id=2-tutorial>2. Tutorial</h1><h2 id=21-编写-nio-server>2.1 编写 NIO Server</h2><p>现在我们开始编写一个 server 吧，首先我们先给出一个完整的 server 范例，然后分解其编写逻辑。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/cloudwego/netpoll&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>network</span><span class=p>,</span> <span class=nx>address</span> <span class=o>:=</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.1:8888&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建 listener
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>CreateListener</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;create netpoll listener fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// handle: 连接读数据和处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>onRequest</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>OnRequest</span> <span class=p>=</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// options: EventLoop 初始化自定义配置项
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>opts</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>netpoll</span><span class=p>.</span><span class=nx>Option</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithReadTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithIdleTimeout</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithOnPrepare</span><span class=p>(</span><span class=kc>nil</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建 EventLoop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLoop</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewEventLoop</span><span class=p>(</span><span class=nx>onRequest</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;create netpoll event-loop fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 运行 Server
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>eventLoop</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>listener</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;netpoll server exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读事件处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>connection</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>Connection</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>connection</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=211-创建-listener>2.1.1 创建 Listener</h3><p>首先我们先创建一个 <code>netpoll.Listener</code>，和 <code>net.Listener</code> 创建方式相似，通过 <code>network</code> 和 <code>address</code> 构建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>CreateListener</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;create netpoll listener fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=212-创建-eventloop>2.1.2 创建 EventLoop</h3><p><code>EventLoop</code> 是 NIO Server 的事件驱动调度器，负责连接管理、事件调度等。创建过程如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// handle: 连接读数据和处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>handle</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>OnRequest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// options: EventLoop 初始化自定义配置项
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>opts</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>netpoll</span><span class=p>.</span><span class=nx>Option</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithReadTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithIdleTimeout</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithOnPrepare</span><span class=p>(</span><span class=kc>nil</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建 EventLoop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>eventLoop</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewEventLoop</span><span class=p>(</span><span class=nx>handle</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;create netpoll event-loop fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=213-运行-server>2.1.3 运行 Server</h3><p><code>EventLoop</code> 通过绑定 <code>Listener</code> 来提供对外服务，范例如下。其中 <code>Serve()</code> 方法只在异常下退出，如 panic 异常中断，或者用户主动关闭 server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 运行 Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>err</span> <span class=p>=</span> <span class=nx>eventLoop</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>listener</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;netpoll server exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=214-关闭-server>2.1.4 关闭 Server</h3><p>Server 允许主动关闭退出，关闭阶段支持优雅退出（处理完正在执行的连接事件）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 关闭 Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>eventLoop</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=22-使用编写-dialer>2.2 使用/编写 Dialer</h2><p><a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 同时具备在 Client 端使用的能力，通过提供 <code>Dialer</code> 的方式，与 <code>net.Dialer</code> 相似。同样我们先给出完整使用范例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/cloudwego/netpoll&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>network</span><span class=p>,</span> <span class=nx>address</span> <span class=o>:=</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.1:8888&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 直接创建连接
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>DialConnection</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>,</span> <span class=mi>50</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;dial netpoll connection fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过 dialer 创建连接
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dialer</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewDialer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>dialer</span><span class=p>.</span><span class=nf>DialConnection</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>,</span> <span class=mi>50</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;dialer netpoll connection fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// conn write &amp; flush message
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>WriteBinary</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>conn</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=221-缺省方式创建连接>2.2.1 缺省方式创建连接</h3><p><a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 提供了快速建立连接的 API，如下所示，缺省配置项，适合绝大多数常规需求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 创建任意连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>DialConnection</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>timeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>(</span><span class=nx>connection</span> <span class=nx>Connection</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建 TCP 连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>DialTCP</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>network</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>laddr</span><span class=p>,</span> <span class=nx>raddr</span> <span class=o>*</span><span class=nx>TCPAddr</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TCPConnection</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建 Unix 连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>DialUnix</span><span class=p>(</span><span class=nx>network</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>laddr</span><span class=p>,</span> <span class=nx>raddr</span> <span class=o>*</span><span class=nx>UnixAddr</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UnixConnection</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=222-创建-dialer>2.2.2 创建 Dialer</h3><p><a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 也支持通过 <code>Dialer</code> 对象创建连接，支持可扩展的自定义配置（目前尚未开放）。使用方式如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 通过 dialer 创建连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>dialer</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewDialer</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>dialer</span><span class=p>.</span><span class=nf>DialConnection</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>,</span> <span class=mi>50</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;dialer netpoll connection fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=23-使用-connection>2.3 使用 Connection</h2><p><code>Connection</code> 专为 NIO 设计，提供了强大的 zero-copy 读写能力。相比 <code>net.Conn</code> 性能更高，内存和 gc 开销更小。（同时也实现了 <code>net.Conn</code>，但不推荐使用）。</p><p>API 定义如下进行分类和说明，配置相关部分详见 <a href=#3-how-to>How To</a>，以下仅介绍 zero-copy 使用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Connection</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span> <span class=c1>// API 对齐，不推荐使用
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=c1>// 推荐使用的 zero-copy API
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>Reader</span><span class=p>()</span> <span class=nx>Reader</span>
</span></span><span class=line><span class=cl>   <span class=nf>Writer</span><span class=p>()</span> <span class=nx>Writer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=o>...</span> <span class=c1>// 更多参见注释部分
</span></span></span></code></pre></div><h3 id=231-使用-zero-copy-api>2.3.1 使用 zero-copy API</h3><p>推荐使用 <code>Connection</code> 的零拷贝 API 来处理连接读写，其使用说明如下（更多说明参见代码注释）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 读取 n 字节, 返回底层缓存切片, 同时缓存减少 n 字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Reader</span><span class=p>().</span><span class=nf>Next</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 预读取 n 字节, 返回底层缓存切片, 缓存大小不变, 可重复预读
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Reader</span><span class=p>().</span><span class=nf>Peek</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 丢弃缓存最前的 n 字节, 不可找回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Reader</span><span class=p>().</span><span class=nf>Skip</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 释放已读部分的底层缓存, (在此之前读取的)上层读缓存切片将全部失效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Reader</span><span class=p>().</span><span class=nf>Release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在连接写缓存区顺序分配 n 字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Malloc</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 将已分配的写缓存全部发送到连接对端, (在此之前分配的)上层写缓存切片将全部失效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conn</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Flush</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=232-继承-zero-copy-能力>2.3.2 继承 zero-copy 能力</h3><p>连接提供了一些高级能力，不仅可以在连接上做零拷贝读写，而且还可以将零拷贝读写能力传递下去。</p><p>我们开发了一种 <code>LinkBuffer</code>，不仅支持 zero-copy API，同时还支持 zero-copy 读写自身类型的分片。
通过 <code>Slice/Append</code> 接口，<code>LinkBuffer</code> 支持逻辑上的任意切分和拼接，实际仅基于同一个底层缓存，切分和拼接的过程是 zero-copy 的。
我们在连接层面也提供了 <code>Slice/Append</code> 接口，可以读写整个的 <code>LinkBuffer</code> 分片。
使得上层逻辑可以基于 <code>LinkBuffer</code> 分片继续 zero-copy 读写。范例代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 读取 n 字节 LinkBuffer 切片
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>Slice</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=nx>r</span> <span class=nx>Reader</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 拼接(写) LinkBuffer 切片
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>Append</span><span class=p>(</span><span class=nx>w</span> <span class=nx>Writer</span><span class=p>)</span> <span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 持续继承 zero-copy 读写
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>buf1</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Reader</span><span class=p>().</span><span class=nf>Slice</span><span class=p>(</span><span class=nx>n1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>buf2</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>buf1</span><span class=p>.</span><span class=nf>Slice</span><span class=p>(</span><span class=nx>n2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>buf1</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>buf2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>conn</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Append</span><span class=p>(</span><span class=nx>buf1</span><span class=p>)</span>
</span></span></code></pre></div><h1 id=3-how-to>3. How To</h1><h2 id=31-如何配置-poller-个数>3.1 如何配置 poller 个数</h2><p><code>NumLoops</code> 是 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 底层的 epoll 线程数量。
实践数据表明，单个 poller 大约可以负载 20core CPU，<a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 默认已经根据 <code>runtime.GOMAXPROCS(0)</code>
动态调整了 poller 数量，一般用户不需要关心。如果想自行调整，可以通过如下方式配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 设置合适的 poller 数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>netpoll</span><span class=p>.</span><span class=nf>SetNumLoops</span><span class=p>(</span><span class=nx>num_you_want</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=32-如何配置-poller-连接负载均衡策略>3.2 如何配置 poller 连接负载均衡策略</h2><p>一般情况下，<a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 底层存在多个 poller，整个进程里的所有连接，会通过负载均衡策略分配给各个 poller 维护和调度。
目前共支持以下负载均衡策略：</p><ol><li>Random<ul><li>新建立的连接将被简单随机地，分配给任意一个 poller</li></ul></li><li>RoundRobin<ul><li>新建立的连接将被循环式的，依次分配给有序排列的 poller Netpoll 默认使用 RoundRobin 策略，用户可以通过以下方式自定义改变该策略</li></ul></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 负载均衡策略设置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>netpoll</span><span class=p>.</span><span class=nf>SetLoadBalance</span><span class=p>(</span><span class=nx>netpoll</span><span class=p>.</span><span class=nx>Random</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// or
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>netpoll</span><span class=p>.</span><span class=nf>SetLoadBalance</span><span class=p>(</span><span class=nx>netpoll</span><span class=p>.</span><span class=nx>RoundRobin</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=33-如何配置-gopool-协程池>3.3 如何配置 gopool 协程池</h2><p><a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 默认开启 <a href=https://github.com/bytedance/gopkg/util/gopool target=_blank rel=noopener>gopool</a> 协程池，
因为基于 epoll 的读写事件调度模式（多 worker 协作），特别适合使用 <a href=https://github.com/bytedance/gopkg/util/gopool target=_blank rel=noopener>gopool</a> 。
目前尚不支持配置 <a href=https://github.com/bytedance/gopkg/util/gopool target=_blank rel=noopener>gopool</a> ，后续会考虑开放这部分能力。</p><h2 id=34-如何初始化新连接>3.4 如何初始化新连接</h2><p>Server 端和 Client 端通过不同的方式初始化新建立的连接。</p><ol><li>在 Server 端，定义了 <code>OnPrepare</code> 用于自定义初始化连接，同时支持初始化一个 <code>context</code>，提供给后续的读事件处理时重复使用。
<code>OnPrepare</code> 需要在创建 <code>EventLoop</code> 时，通过 <code>option</code> <code>WithOnPrepare</code> 注入。
Server 端在 <code>Accept</code> 新连接时，会自动调度执行注册的 <code>OnPrepare</code> 方法，完成连接初始化工作，代码范例如下。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// EventLoop 注册连接初始化逻辑 范例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>InitEventLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// handle: 连接读数据和处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>onRequest</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>OnRequest</span> <span class=p>=</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl>	<span class=c1>// prepare: 连接初始化, 返回读事件处理时使用的 context
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>onPrepare</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>OnPrepare</span> <span class=p>=</span> <span class=nx>prepare</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建 EventLoop 时, 注册 OnPrepare
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>eventLoop</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewEventLoop</span><span class=p>(</span><span class=nx>onRequest</span><span class=p>,</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithOnPrepare</span><span class=p>(</span><span class=nx>onPrepare</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;create netpoll event-loop fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 连接初始化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>prepare</span><span class=p>(</span><span class=nx>connection</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>Connection</span><span class=p>)</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读事件处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>connection</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>Connection</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>connection</span><span class=p>.</span><span class=nf>Writer</span><span class=p>().</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=2><li>在 Client 端，连接初始化需要自行额外完成。一般认为，当通过 <code>Dialer</code> 创建新的连接后，不存在需要连接来感知的初始化工作，
因此这部分(初始化)工作由上层逻辑完成，最后在需要时注册读事件回调即可（参见 <a href=#36-%e5%a6%82%e4%bd%95%e9%85%8d%e7%bd%ae%e8%bf%9e%e6%8e%a5%e8%af%bb%e4%ba%8b%e4%bb%b6%e5%9b%9e%e8%b0%83>How To - 3.6 如何配置连接读事件回调</a>）</li></ol><h2 id=35-如何配置连接超时>3.5 如何配置连接超时</h2><p>目前支持两种超时配置</p><ol><li>连接异步读超时 <code>read timeout</code><ul><li>为了保持和 <code>net.Conn</code> 相同的操作风格，<code>Connection</code> 在读数据是也是阻塞读取的，允许使用 <code>conn.Reader().Next(n)</code> 的方式阻塞读取足额的 n 字节。
而由于 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 是异步回调模型，连接读等待唤醒取决于对端是否返回了数据，并且读事件被调度。
因此这里支持读阻塞到指定超时时间后主动返回。</li><li><code>read timeout</code> 没有默认值(无限等待)，可以通过 <code>Connection</code> API 或者 <code>EventLoop</code> <code>option</code> 配置</li></ul></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// option 方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithReadTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// api 方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>connection</span><span class=p>.</span><span class=nf>SetReadTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span></code></pre></div><ol start=2><li>连接空闲超时 <code>idle timeout</code><ul><li>空闲超时即 <code>TCP KeepAlive</code> 机制，目的是踢出死连，降低 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 维护的开销。
在使用 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 时，一般来说不需要频繁的创建和关闭连接，
不用考虑未使用的连接会造成额外开销（基于 epoll 的事件调度机制，对于无事件连接不会被调度）。
（当然，epoll 监听不活跃的连接也会有一定的额外开销）当连接长时间不活跃时，为防止假死、对端 hung 住、对端异常掉线 等情况导致的死连接，
<a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 会在连接一定空闲时间后主动关闭。</li><li><code>idle timeout</code> 系统默认最小值为 <code>10min</code>，可以通过 <code>Connection</code> API 或者 <code>EventLoop</code> <code>option</code> 配置</li></ul></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// option 方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>netpoll</span><span class=p>.</span><span class=nf>WithIdleTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// api 方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>connection</span><span class=p>.</span><span class=nf>SetIdleTimeout</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=36-如何配置连接读事件回调>3.6 如何配置连接读事件回调</h2><p>读事件回调 <code>OnRequest</code> 是指，连接在底层读事件到来时，由 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 底层调度触发的回调。
该回调是以 NIO 的方式读取和处理连接上的数据。在 Server 端，创建 <code>EventLoop</code> 时强制需要 <code>OnRequest</code>，并在每个连接数据到来时触发，用于执行 server 业务逻辑。
在 Client 端，默认没有读事件回调，支持在需要时通过 API 设置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// handle: 连接读数据和处理逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>onRequest</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>OnRequest</span> <span class=p>=</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl><span class=c1>// Server 端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>eventLoop</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nf>NewEventLoop</span><span class=p>(</span><span class=nx>onRequest</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Client 端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>connection</span><span class=p>.</span><span class=nf>SetOnRequest</span><span class=p>(</span><span class=nx>onRequest</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=37-如何配置连接关闭回调>3.7 如何配置连接关闭回调</h2><p>连接关闭回调 <code>CloseCallback</code> 是指，连接在被关闭时，由 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 底层调度触发的回调。
该回调用以在连接被关闭后，执行额外的处理逻辑。<a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 能够感知连接状态，当连接对端关闭、清理死连
等情况下，底层会主动触发连接关闭，此时 <code>CloseCallback</code> 起到通知的作用。触发主动的处理连接关闭，而不是在下一次读写连接时报错（<code>net.Conn</code> 的做法）。
<code>Connection</code> 提供了 API 用于添加 <code>CloseCallback</code>，已被添加的回调不可以移除，支持添加多个回调。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 添加 CloseCallback 范例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>addCloseCallback</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 回调方法定义
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kd>var</span> <span class=nx>cb</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>CloseCallback</span> <span class=p>=</span> <span class=nx>callback</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 添加回调
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>conn</span><span class=p>.</span><span class=nf>AddCloseCallback</span><span class=p>(</span><span class=nx>cb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>callback</span><span class=p>(</span><span class=nx>connection</span> <span class=nx>netpoll</span><span class=p>.</span><span class=nx>Connection</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=38-如何使用-linkbuffer>3.8 如何使用 LinkBuffer</h2><p><a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 提供的 <code>LinkBuffer</code> 支持并发的单个读和单个写操作，有较小的 atomic 锁开销，是一种效率高、内存开销小的 buffer。</p><h1 id=4-attention>4. Attention</h1><h2 id=41-错误设置-numloops>4.1 错误设置 NumLoops</h2><p><code>NumLoops</code> 是 <a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 底层的 poller 线程数量。
实践数据表明，单个 poller 大约可以负载 20core CPU，<a href=https://github.com/cloudwego/netpoll target=_blank rel=noopener>Netpoll</a> 默认已经根据 <code>runtime.GOMAXPROCS(0)</code> 动态调整了 poller 数量，一般用户不需要关心。
但对于物理机部署来说，<code>runtime.GOMAXPROCS(0)</code> 拿到的是物理机核心数，可能会导致性能下降。解决办法有以下几种：</p><ol><li>使用 <code>taskset</code> 命令来限制 CPU 的使用</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>taskset 0-3 ./output/bootstrap.sh
</span></span></code></pre></div><ol start=2><li>主动设置 P 的数量</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>runtime</span><span class=p>.</span><span class=nf>GOMAXPROCS</span><span class=p>(</span><span class=nx>num_you_want</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=3><li>主动设置 poller 数量</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>netpoll</span><span class=p>.</span><span class=nf>SetNumLoops</span><span class=p>(</span><span class=nx>num_you_want</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>{&ldquo;mode&rdquo;:&ldquo;full&rdquo;,&ldquo;isActive&rdquo;:false}</p></div><div class=article-widget><div class="container-xl row post-nav"></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>