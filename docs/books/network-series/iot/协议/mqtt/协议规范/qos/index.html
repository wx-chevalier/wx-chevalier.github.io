<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="MQTT 的 QoS 介绍 MQTT 中的 QoS 等级 MQTT 设计了一套保证消息稳定传输的机制，包括消息应答、存储和重传。在这套机制下，提供了三种不同层次 QoS（Quality of Service）： QoS0，At most once，至多一次； QoS"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/qos/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/qos/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/qos/"><meta property="og:title" content="QoS | Next-gen Tech Edu"><meta property="og:description" content="MQTT 的 QoS 介绍 MQTT 中的 QoS 等级 MQTT 设计了一套保证消息稳定传输的机制，包括消息应答、存储和重传。在这套机制下，提供了三种不同层次 QoS（Quality of Service）： QoS0，At most once，至多一次； QoS"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>QoS | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=a8794663ff5e31f66973bdccf966985a><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">协议规范</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idda8cde05aae69c8f47bc962d1a9d98ea")' href=#idda8cde05aae69c8f47bc962d1a9d98ea aria-expanded=false aria-controls=idda8cde05aae69c8f47bc962d1a9d98ea aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/>MQTT</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idda8cde05aae69c8f47bc962d1a9d98ea aria-expanded=false aria-controls=idda8cde05aae69c8f47bc962d1a9d98ea><i class="fa-solid fa-angle-down" id=caret-idda8cde05aae69c8f47bc962d1a9d98ea></i></a></div><ul class="nav docs-sidenav collapse show" id=idda8cde05aae69c8f47bc962d1a9d98ea><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idc3273cdec55fd5af9f5b3beacde2471b")' href=#idc3273cdec55fd5af9f5b3beacde2471b aria-expanded=false aria-controls=idc3273cdec55fd5af9f5b3beacde2471b aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/>版本特性</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idc3273cdec55fd5af9f5b3beacde2471b aria-expanded=false aria-controls=idc3273cdec55fd5af9f5b3beacde2471b><i class="fa-solid fa-angle-right" id=caret-idc3273cdec55fd5af9f5b3beacde2471b></i></a></div><ul class="nav docs-sidenav collapse" id=idc3273cdec55fd5af9f5b3beacde2471b><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/mqtt-5.0-%E6%96%B0%E7%89%B9%E6%80%A7/>MQTT 5.0 新特性</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide464c82fa5924fd80b77677f5b8ebbab")' href=#ide464c82fa5924fd80b77677f5b8ebbab aria-expanded=false aria-controls=ide464c82fa5924fd80b77677f5b8ebbab aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>框架与库</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ide464c82fa5924fd80b77677f5b8ebbab aria-expanded=false aria-controls=ide464c82fa5924fd80b77677f5b8ebbab><i class="fa-solid fa-angle-right" id=caret-ide464c82fa5924fd80b77677f5b8ebbab></i></a></div><ul class="nav docs-sidenav collapse" id=ide464c82fa5924fd80b77677f5b8ebbab><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/>快速开始</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id2257e0e315419ee38c6815f81e9c1ee5")' href=#id2257e0e315419ee38c6815f81e9c1ee5 aria-expanded=false aria-controls=id2257e0e315419ee38c6815f81e9c1ee5 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/>协议规范</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id2257e0e315419ee38c6815f81e9c1ee5 aria-expanded=false aria-controls=id2257e0e315419ee38c6815f81e9c1ee5><i class="fa-solid fa-angle-down" id=caret-id2257e0e315419ee38c6815f81e9c1ee5></i></a></div><ul class="nav docs-sidenav collapse show" id=id2257e0e315419ee38c6815f81e9c1ee5><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/1.%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/>1.基本概念</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/2.%E6%8A%A5%E6%96%87%E5%8D%8F%E8%AE%AE/>2.报文协议</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/3.%E8%BF%9E%E6%8E%A5%E4%B8%8E%E6%96%AD%E5%BC%80/>3.连接与断开</a></li><li class="child level active"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/qos/>QoS</a></li><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id64f530ea6f74bab35b00b9b048e4dda6")' href=#id64f530ea6f74bab35b00b9b048e4dda6 aria-expanded=false aria-controls=id64f530ea6f74bab35b00b9b048e4dda6 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/retained-%E6%B6%88%E6%81%AF/>Retained 消息</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id64f530ea6f74bab35b00b9b048e4dda6 aria-expanded=false aria-controls=id64f530ea6f74bab35b00b9b048e4dda6><i class="fa-solid fa-angle-right" id=caret-id64f530ea6f74bab35b00b9b048e4dda6></i></a></div><ul class="nav docs-sidenav collapse" id=id64f530ea6f74bab35b00b9b048e4dda6><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/retained-%E6%B6%88%E6%81%AF/%E4%BB%A3%E7%A0%81paho-retained-%E6%B6%88%E6%81%AF%E4%BB%A3%E7%A0%81/>代码：paho Retained 消息代码</a></li></ul></div><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/retained-%E6%B6%88%E6%81%AF%E5%92%8C-lwt-%E5%92%8C-keep-alive/>Retained 消息和 LWT 和 Keep Alive</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/%E6%8A%A5%E6%96%87%E5%8D%8F%E8%AE%AE/>报文协议</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/>基本概念</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/%E8%BF%9E%E6%8E%A5%E4%B8%8E%E6%96%AD%E5%BC%80/>连接与断开</a></li><li class="child level"><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%91%E5%B8%83%E5%92%8C%E8%AE%A2%E9%98%85/>消息的发布和订阅</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>QoS</h1><div class=article-style><h1 id=mqtt-的-qos-介绍>MQTT 的 QoS 介绍</h1><h1 id=mqtt-中的-qos-等级>MQTT 中的 QoS 等级</h1><p>MQTT 设计了一套保证消息稳定传输的机制，包括消息应答、存储和重传。在这套机制下，提供了三种不同层次 QoS（Quality of Service）：</p><ul><li>QoS0，At most once，至多一次；</li><li>QoS1，At least once，至少一次；</li><li>QoS2，Exactly once，确保只有一次。</li></ul><p>QoS 是消息的发送方（Sender）和接受方（Receiver）之间达成的一个协议：</p><ul><li>QoS0 代表，Sender 发送的一条消息，Receiver 最多能收到一次，也就是说 Sender 尽力向 Receiver 发送消息，如果发送失败，也就算了；</li><li>QoS1 代表，Sender 发送的一条消息，Receiver 至少能收到一次，也就是说 Sender 向 Receiver 发送消息，如果发送失败，会继续重试，直到 Receiver 收到消息为止，但是因为重传的原因，Receiver 有可能会收到重复的消息；</li><li>QoS2 代表，Sender 发送的一条消息，Receiver 确保能收到而且只收到一次，也就是说 Sender 尽力向 Receiver 发送消息，如果发送失败，会继续重试，直到 Receiver 收到消息为止，同时保证 Receiver 不会因为消息重传而收到重复的消息。</li></ul><p>QoS 是 Sender 和 Receiver 之间的协议，而不是 Publisher 和 Subscriber 之间的协议。换句话说，Publisher 发布了一条 QoS1 的消息，只能保证 Broker 能至少收到一次这个消息；而对于 Subscriber 能否至少收到一次这个消息，还要取决于 Subscriber 在 Subscibe 的时候和 Broker 协商的 QoS 等级。</p><h1 id=qos0>QoS0</h1><p>QoS0 等级下，Sender 和 Receiver 之间一次消息的传递流程如下：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/item/20221222145706.png alt="QoS0 消息" loading=lazy data-zoomable></div></div></figure></p><p>Sender 向 Receiver 发送一个包含消息数据的 PUBLISH 包，然后不管结果如何，丢掉已发送的 PUBLISH 包，一条消息的发送完成。</p><h1 id=qos1>QoS1</h1><p>QoS1 要保证消息至少到达一次，所以有一个应答的机制。Sender 和 Receiver 的一次消息的传递流程如下：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/item/20221222150050.png alt="QoS1 应答机制" loading=lazy data-zoomable></div></div></figure></p><ol><li>Sender 向 Receiver 发送一个带有数据的 PUBLISH 包，并在本地保存这个 PUBLISH 包；</li><li>Receiver 收到 PUBLISH 包以后，向 Sender 发送一个 PUBACK 数据包，PUBACK 数据包没有消息体（Payload），在可变头中有一个包标识（Packet Identifier），和它收到的 PUBLISH 包中的 Packet Identifier 一致。</li><li>Sender 收到 PUBACK 之后，根据 PUBACK 包中的 Packet Identifier 找到本地保存的 PUBLISH 包，然后丢弃掉，一次消息的发送完成。</li></ol><p>但是消息传递流程中可能会出现问题：</p><ul><li>如果 Sender 在一段时间内没有收到 PUBLISH 包对应的 PUBACK，它将该 PUBLISH 包的 DUP 标识设为 1（代表是重新发送的 PUBLISH 包），然后重新发送该 PUBLISH 包。</li><li>Receiver 可能会重复收到消息，需自行去重。</li></ul><h1 id=qos2>QoS2</h1><p>相比 QoS0 和 QoS1,QoS2 不仅要确保 Receiver 能收到 Sender 发送的消息，还需要确保消息不重复。它的重传和应答机制就要复杂一些，同时开销也是最大的。QoS2 下，一次消息的传递流程如下所示：</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=https://assets.ng-tech.icu/item/20221222150524.png alt=QoS2 loading=lazy data-zoomable></div></div></figure></p><ol><li>Sender 发送 QoS 为 2 的 PUBLISH 数据包，数据包 Packet Identifier 为 P，并在本地保存该 PUBLISH 包；</li><li>Receiver 收到 PUBLISH 数据包后，<strong>在本地保存 PUBLISH 包的 Packet Identifier P</strong>，并回复 Sender 一个 PUBREC 数据包，PUBREC 数据包可变头中的 Packet Identifier 为 P，没有消息体（Payload）；</li><li>当 Sender 收到 PUBREC，它就可以安全的丢弃掉初始 Packet Identifier 为 P 的 PUBLISH 数据包。同时保存该 PUBREC 数据包，并回复 Receiver 一个 PUBREL 数据包，PUBREL 数据包可变头中的 Packet Identifier 为 P，没有消息体；</li><li>当 Receiver 收到 PUBREL 数据包，它可以丢掉保存的 PUBLISH 包的 Packet Identifier P，并回复 Sender 一个可变头中 Packet Identifier 为 P，没有消息体（Payload）的 PUBCOMP 数据包；</li><li>当 Sender 收到 PUBCOMP 包，那么认为传输已完成，则丢掉对应的 PUBREC 数据包；</li></ol><p>上面是一次完整无误的传输过程，然而传输过程中可能会出现以下情况：</p><ul><li>情况 1：Sender 发送 PUBLISH 数据包给 Receiver 的时候，发送失败；</li><li>情况 2：Sender 已经成功发送 PUBLISH 数据包给 Receiver 了，但是 Receiver 发送 PUBREC 数据包失败；</li><li>情况 3：Sender 已经成功收到了 PUBREC 数据包，但是 PUBREL 数据包发送失败；</li><li>情况 4：Receiver 已经收到了 PUBREL 数据包，但是发送 PUBCOMP 数据包时发送失败</li></ul><p>针对上述的问题，较为详细的处理方法如下：</p><ul><li>不管是情况 1 还是情况 2，因为 Sender 在一定时间内没有收到 PUBREC，那么它会把 PUBLISH 包的 DUP 标识设为 1，重新发送该 PUBLISH 数据包；</li><li>不管是情况 3 还是情况 4，因为 Sender 在一定时间内没有收到 PUBCOMP 包，那么它会重新发送 PUBREL 数据包；</li><li>针对情况 2，Receiver 可能会收到多个重复的 PUBLISH 包，更加完善的处理如下：
Receiver 在收到 PUBLISH 数据包之后，马上回复一个 PUBREC 数据包。并会在本地保存 PUBLISH 包的 Packet Identifier P，不管之后因为重传多少次这个 Packet Identifier 为 P 的数据包，Receiver 都认为是重复的，丢弃。同时 Receiver 接收到 QoS 为 2 的 PUBLISH 数据包后，**并不马上投递给上层，**而是在本地做持久化，将消息保存起来（这里需要是持久化而不是保存在内存）。</li><li>针对情况 4，更加完善的处理如下：
Receiver 收到 PUBREL 数据包后，正式将消息递交给上层应用层，投递之后销毁 Packet Identifier P，并发送 PUBCOMP 数据包，销毁之前的持久化消息。之后不管接收到多少个 PUBREL 数据包，因为没有 Packet Identifier P，直接回复 PUBCOMP 数据包即可。</li></ul><h1 id=qos-降级>QoS 降级</h1><p>在 MQTT 协议中，从 Broker 到 Subscriber 这段消息传递的实际 QoS 等于：Publisher 发布消息时指定的 QoS 等级和 Subscriber 在订阅时与 Broker 协商的 QoS 等级，这两个 QoS 等级中的最小那一个。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=n>Actual</span> <span class=n>Subscribe</span> <span class=n>QoS</span> <span class=o>=</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>Publish</span> <span class=n>QoS</span><span class=p>,</span> <span class=n>Subscribe</span> <span class=n>QoS</span><span class=p>)</span>
</span></span></code></pre></div><p>如下面代码所示：该 subscriber 订阅消息时指定的 QoS 为 1</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paho.mqtt.client</span> <span class=k>as</span> <span class=nn>mqtt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>当代理响应订阅请求时被调用
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_subscribe</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>mid</span><span class=p>,</span> <span class=n>granted_qos</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;granted_qos:&#34;</span><span class=p>,</span> <span class=n>granted_qos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>当收到关于客户订阅的主题的消息时调用
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message qos&#34;</span><span class=p>,</span> <span class=n>message</span><span class=o>.</span><span class=n>qos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message topic&#34;</span><span class=p>,</span> <span class=n>message</span><span class=o>.</span><span class=n>topic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message payload&#34;</span><span class=p>,</span> <span class=n>message</span><span class=o>.</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_connect</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>rc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;subscribing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;connection failed &#34;</span><span class=p>,</span> <span class=n>rc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span> <span class=o>=</span> <span class=n>mqtt</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>client_id</span><span class=o>=</span><span class=s2>&#34;demo_mqtt_sub&#34;</span><span class=p>,</span> <span class=n>clean_session</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>on_connect</span> <span class=o>=</span> <span class=n>on_connect</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>on_subscribe</span> <span class=o>=</span> <span class=n>on_subscribe</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>on_message</span> <span class=o>=</span> <span class=n>on_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;192.168.10.239&#34;</span><span class=p>,</span> <span class=mi>1883</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>loop_forever</span><span class=p>()</span>
</span></span></code></pre></div><p>运行上述代码输出的结果为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>subscribing
</span></span><span class=line><span class=cl>granted_qos: <span class=o>(</span>1,<span class=o>)</span>
</span></span></code></pre></div><p>之后运行下面的 publisher 代码，指定发送的 PUBLISH 数据包的 QoS 等级为 0</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paho.mqtt.client</span> <span class=k>as</span> <span class=nn>mqtt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_connect</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>rc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=o>=</span><span class=s2>&#34;hello world&#34;</span><span class=p>,</span> <span class=n>qos</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;connection failed &#34;</span><span class=p>,</span> <span class=n>rc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span> <span class=o>=</span> <span class=n>mqtt</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>client_id</span><span class=o>=</span><span class=s2>&#34;demo_mqtt_pub&#34;</span><span class=p>,</span> <span class=n>clean_session</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>on_connect</span> <span class=o>=</span> <span class=n>on_connect</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;192.168.10.239&#34;</span><span class=p>,</span> <span class=mi>1883</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mqtt_client</span><span class=o>.</span><span class=n>loop_forever</span><span class=p>()</span>
</span></span></code></pre></div><p>结果上面运行 subscriber 代码的终端输出如下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>message qos <span class=m>0</span>
</span></span><span class=line><span class=cl>message topic <span class=nb>test</span>
</span></span><span class=line><span class=cl>message payload b<span class=s1>&#39;hello world&#39;</span>
</span></span></code></pre></div><p>上述的结果表示，订阅者收到的消息的 qos 等级为 0。同样如果修改 subscriber 中的订阅主题的 QoS 等级为 0，publisher 中发布的 PUBLISH 包的 QoS 为 1，那么输出结果同上。</p><h1 id=qos-和会话>QoS 和会话</h1><p>如果 Client 想接收离线消息，必须使用持久化的会话（Clean Session = 0）连接到 Broker，这样 Broker 才会存储 Client 在离线期间没有确认接收的 QoS 大于 等于 1 的消息。在发送 QoS 为 1 或 2 的情况，Broker（此时为 Sender）会将发送的 PUBLISH 数据包保存到本地，直到收到一系列回复的数据包，然而 Client（此时为 Receiver）在离线期间无法回复相应的数据包，所以会一直存储。</p><h1 id=qos-等级使用建议>QoS 等级使用建议</h1><p><strong>在以下情况下你可以选择 QoS0</strong>：</p><ul><li>Client 和 Broker 之间的网络连接非常稳定，例如一个通过有线网络连接到 Broker 的测试用 Client；</li><li>可以接受丢失部分消息，比如你有一个传感器以非常短的间隔发布状态数据，所以丢一些也可以接受；</li><li>你不需要离线消息。</li></ul><p><strong>在以下情况下你应该选择 QoS1：</strong></p><ul><li>你需要接收所有的消息，而且你的应用可以接受并处理重复的消息；</li><li>你无法接受 QoS2 带来的额外开销，QoS1 发送消息的速度比 QoS2 快很多。</li></ul><p><strong>在以下情况下你应该选择 QoS2：</strong></p><ul><li>你的应用必须接收到所有的消息，而且你的应用在重复的消息下无法正常工作，同时你也能接受 QoS2 带来的额外开销。</li></ul></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/3.%E8%BF%9E%E6%8E%A5%E4%B8%8E%E6%96%AD%E5%BC%80/ rel=next>3.连接与断开</a></div><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/network-series/iot/%E5%8D%8F%E8%AE%AE/mqtt/%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83/retained-%E6%B6%88%E6%81%AF%E5%92%8C-lwt-%E5%92%8C-keep-alive/ rel=prev>Retained 消息和 LWT 和 Keep Alive</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte.disqus.com/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>