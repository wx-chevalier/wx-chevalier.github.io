<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.5.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=google-site-verification content="google69a5cccb61297807"><meta name=baidu-site-verification content="cqmZHEleVh"><meta name=description content="ScopedProxyMode 首先查看下 @Scope 注解的定义信息，其共有三个方法，分别为 value、scopeName、proxyMode，其中 value 和 scopeName 利用了 Spring 的显性覆盖，这两个方法的作用是一样的，只不过 scopeName 要比 value 更具有语义性。重点是 proxyMode 方法"><link rel=alternate hreflang=zh href=https://ng-tech.icu/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/scopedproxymode/><meta name=theme-color content="#0a55a7"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.63df6ae9fc2b4cc71b83f1774d780209.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-40NYXJ8823"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-40NYXJ8823")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?56df1177bce405601b0ecdd7208f75c6",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://ng-tech.icu/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/scopedproxymode/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wx-chevalier"><meta property="twitter:creator" content="@wx-chevalier"><meta property="og:site_name" content="Next-gen Tech Edu"><meta property="og:url" content="https://ng-tech.icu/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/scopedproxymode/"><meta property="og:title" content="ScopedProxyMode | Next-gen Tech Edu"><meta property="og:description" content="ScopedProxyMode 首先查看下 @Scope 注解的定义信息，其共有三个方法，分别为 value、scopeName、proxyMode，其中 value 和 scopeName 利用了 Spring 的显性覆盖，这两个方法的作用是一样的，只不过 scopeName 要比 value 更具有语义性。重点是 proxyMode 方法"><meta property="og:image" content="https://ng-tech.icu/media/sharing.png"><meta property="twitter:image" content="https://ng-tech.icu/media/sharing.png"><meta property="og:locale" content="zh"><title>ScopedProxyMode | Next-gen Tech Edu</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=31d6c9f102846c38180a9427131faf33><button onclick=topFunction() id=backTopBtn title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden=true></i></button>
<script src=/js/wowchemy-init.min.14a0ed61c6dbd594b9c75193b25be179.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class="col-6 search-title"><p>搜索</p></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=关闭><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div><div id=search-common-queries></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label=切换导航>
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Next-gen Tech Edu</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/books-gallery><span>笔记（万篇）</span></a></li><li class=nav-item><a class=nav-link href=/#knowledge-map><span>知识图谱</span></a></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>实验室</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=/galaxy-home/gh-craft><span>Craft 方块世界</span></a>
<a class=dropdown-item href=/galaxy-home/glossary-cards><span>3D 知识卡牌</span></a></div></li><style>.dropdown-item{display:inline-flex}</style><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>其他阅读渠道</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230218234451.png></img><span>知乎</span></a>
<a class=dropdown-item href=https://segmentfault.com/blog/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113556.png></img><span>SegmentFault</span></a>
<a class=dropdown-item href=https://zhuanlan.zhihu.com/wxyyxc1992><img style=width:16px;height:16px;display:inline-block;margin-right:8px src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230219113519.png></img><span>掘金</span></a></div></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=搜索><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class=nav-link href=https://github.com/wx-chevalier aria-label=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a></li><div></div><style>@media only screen and (max-width:600px){.jimmysong-template{display:none!important}}</style><li class=jimmysong-template style=color:#fff;font-size:12px><a href=https://jimmysong.io style=color:#fff>By Jimmy Song's Template</a></li></ul></div></nav></header></div><div class=page-body><link rel=stylesheet href=//unpkg.com/heti/umd/heti.min.css><div class="container-xl docs"><div class="row flex-xl-nowrap"><div class=docs-sidebar><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">依赖机制</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>搜索...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li style=display:inline-flex><a style=cursor:pointer onclick=window.history.back()><i class="fas fa-arrow-left pr-1"></i>
Back</a>
<span>|</span>
<a href=/books/><i class="fa-solid fa-house" style=margin-right:4px></i>
Books</a></li></ul><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id45e945db63105c7142d5cb458796d62c")' href=#id45e945db63105c7142d5cb458796d62c aria-expanded=false aria-controls=id45e945db63105c7142d5cb458796d62c aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/>3.依赖注入</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id45e945db63105c7142d5cb458796d62c aria-expanded=false aria-controls=id45e945db63105c7142d5cb458796d62c><i class="fa-solid fa-angle-down" id=caret-id45e945db63105c7142d5cb458796d62c></i></a></div><ul class="nav docs-sidenav collapse show" id=id45e945db63105c7142d5cb458796d62c><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-ide238d20fd2359d369e77411e011aab9a")' href=#ide238d20fd2359d369e77411e011aab9a aria-expanded=false aria-controls=ide238d20fd2359d369e77411e011aab9a aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/bean/>Bean</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#ide238d20fd2359d369e77411e011aab9a aria-expanded=false aria-controls=ide238d20fd2359d369e77411e011aab9a><i class="fa-solid fa-angle-right" id=caret-ide238d20fd2359d369e77411e011aab9a></i></a></div><ul class="nav docs-sidenav collapse" id=ide238d20fd2359d369e77411e011aab9a><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/bean/bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/>Bean 生命周期</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/bean/bean-%E5%A3%B0%E6%98%8E/>Bean 声明</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/bean/bean-%E6%B3%A8%E5%85%A5/>Bean 注入</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idd41ce9481c794fbd6b1c9f9f9b0203b0")' href=#idd41ce9481c794fbd6b1c9f9f9b0203b0 aria-expanded=false aria-controls=idd41ce9481c794fbd6b1c9f9f9b0203b0 aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/>参数配置</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idd41ce9481c794fbd6b1c9f9f9b0203b0 aria-expanded=false aria-controls=idd41ce9481c794fbd6b1c9f9f9b0203b0><i class="fa-solid fa-angle-right" id=caret-idd41ce9481c794fbd6b1c9f9f9b0203b0></i></a></div><ul class="nav docs-sidenav collapse" id=idd41ce9481c794fbd6b1c9f9f9b0203b0><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/>多环境配置</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/>配置文件</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E5%BC%95%E7%94%A8/>配置引用</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-idbf60549c85e98c9321388897ac9560ee")' href=#idbf60549c85e98c9321388897ac9560ee aria-expanded=false aria-controls=idbf60549c85e98c9321388897ac9560ee aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/>依赖机制</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#idbf60549c85e98c9321388897ac9560ee aria-expanded=false aria-controls=idbf60549c85e98c9321388897ac9560ee><i class="fa-solid fa-angle-down" id=caret-idbf60549c85e98c9321388897ac9560ee></i></a></div><ul class="nav docs-sidenav collapse show" id=idbf60549c85e98c9321388897ac9560ee><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/jar-%E5%8A%A0%E8%BD%BD/>Jar 加载</a></li><li class="child level active"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/scopedproxymode/>ScopedProxyMode</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/>启动流程</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/>循环依赖</a></li></ul></div><div class="docs-toc-item has-child"><div class="parent-node d-flex justify-content-between" onclick='Collapse("caret-id47041fef90a8c61df0a375668c348fef")' href=#id47041fef90a8c61df0a375668c348fef aria-expanded=false aria-controls=id47041fef90a8c61df0a375668c348fef aria-hidden=false data-toggle=collapse><a class="d-inline docs-toc-link" href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/>应用上下文</a>
<a class="nav-toogle d-inline level" aria-hidden=false data-toggle=collapse href=#id47041fef90a8c61df0a375668c348fef aria-expanded=false aria-controls=id47041fef90a8c61df0a375668c348fef><i class="fa-solid fa-angle-right" id=caret-id47041fef90a8c61df0a375668c348fef></i></a></div><ul class="nav docs-sidenav collapse" id=id47041fef90a8c61df0a375668c348fef><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/spring-runner/>Spring Runner</a></li><li class="child level"><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/>自动配置</a></li></ul></div></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>目录</a></li></ul><nav id=TableOfContents><ul><li><a href=#代码验证>代码验证</a></li></ul></nav><div class="subscribe-module col-24 mt-1"><img src=https://ngte-superbed.oss-cn-beijing.aliyuncs.com/item/20230220172727.png alt=image title=王下邀月熊的微信公众号></div></div><main class="py-md-3 pl-md-3 docs-content col-xl-8" role=main><article class=article><h1>ScopedProxyMode</h1><div class=article-style><h1 id=scopedproxymode>ScopedProxyMode</h1><p>首先查看下 @Scope 注解的定义信息，其共有三个方法，分别为 value、scopeName、proxyMode，其中 value 和 scopeName 利用了 Spring 的显性覆盖，这两个方法的作用是一样的，只不过 scopeName 要比 value 更具有语义性。重点是 proxyMode 方法，其默认值为 ScopedProxyMode.DEFAULT。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=o>({</span><span class=n>ElementType</span><span class=o>.</span><span class=na>TYPE</span><span class=o>,</span> <span class=n>ElementType</span><span class=o>.</span><span class=na>METHOD</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=nd>@Retention</span><span class=o>(</span><span class=n>RetentionPolicy</span><span class=o>.</span><span class=na>RUNTIME</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Documented</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@interface</span> <span class=n>Scope</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@AliasFor</span><span class=o>(</span><span class=s>&#34;scopeName&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>String</span> <span class=nf>value</span><span class=o>()</span> <span class=k>default</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@AliasFor</span><span class=o>(</span><span class=s>&#34;value&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>String</span> <span class=nf>scopeName</span><span class=o>()</span> <span class=k>default</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ScopedProxyMode</span> <span class=nf>proxyMode</span><span class=o>()</span> <span class=k>default</span> <span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ScopedProxyMode 是一个枚举类，该类共定义了四个枚举值，分别为 NO、DEFAULT、INTERFACE、TARGET_CLASS，其中 DEFAULT 和 NO 的作用是一样的。INTERFACES 代表要使用 JDK 的动态代理来创建代理对象，TARGET_CLASS 代表要使用 CGLIB 来创建代理对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>enum</span> <span class=n>ScopedProxyMode</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>DEFAULT</span><span class=o>,</span>
</span></span><span class=line><span class=cl>	<span class=n>NO</span><span class=o>,</span>
</span></span><span class=line><span class=cl>	<span class=n>INTERFACES</span><span class=o>,</span>
</span></span><span class=line><span class=cl>	<span class=n>TARGET_CLASS</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>首先我们通过代码案例来看来不同取值的差异：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MyBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ScopeProxyBean</span> <span class=n>proxyBean</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>proxyBean</span><span class=o>.</span><span class=na>code</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Scope</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=n>DefaultListableBeanFactory</span><span class=o>.</span><span class=na>SCOPE_PROTOTYPE</span><span class=cm>/*,proxyMode = ScopedProxyMode.TARGET_CLASS*/</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ScopeProxyBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>code</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>hashCode</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 测试用例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@RunWith</span><span class=o>(</span><span class=n>SpringRunner</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=o>(</span><span class=n>classes</span> <span class=o>=</span> <span class=n>TestSpring</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestSpring</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Logger</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test1</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>UnknownHostException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=n>AnnotationConfigApplicationContext</span> <span class=n>applicationContext</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>AnnotationConfigApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>applicationContext</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>MyBean</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>applicationContext</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>ScopeProxyBean</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>applicationContext</span><span class=o>.</span><span class=na>refresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>MyBean</span> <span class=n>bean</span> <span class=o>=</span> <span class=n>applicationContext</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>MyBean</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bean</span><span class=o>.</span><span class=na>test</span><span class=o>();</span> <span class=c1>// 这里生成的所有 Bean 的 hashCode 都是一致的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>下面调整 @Scope 注解中的 proxyMode 属性为 ScopedProxyMode.TARGET_CLASS，能看到会得到不同的 hashCode 的值。</p><h1 id=源码解析>源码解析</h1><p>在 ClassPathBeanDefinitionScanner 的 doScan 方法中，对于 findCandidateComponents 方法返回值进行遍历时，会首先调用 ScopeMetadataResolver 的 resolveScopeMetadata 方法，传入 BeanDefinition 对象。该方法会返回一个 ScopeMetadata 对象，然后将该对象设置到 BeanDefinition 中去，通过 BeanDefinition 的 setScope 方法。接下来便是通过 BeanNameGenerator 的 generatedBeanName 方法来生成 BeanName，判断 BeanDefinition 对象(以下简称为 candidate)是否是 AbstractBeanDefinition，如果判断成立，则调用 postProcessBeanDefinition 方法(该方法主要用来设置 BeanDefinition 的一些默认值)，判断 candidate 是否是 AnnotatedBeanDefinition，如果判断成立则调用 AnnotationConfigUtils 的 processCommonDefinitionAn-notations 方法(通过方法名也可以看出，该方法主要用来解析一些通用的注解)。</p><p>调用 checkCandidate 方法，如果该方法返回值为 true(该方法用来判断当前(注意，不是层级查找)IoC 容器中是否指定 BeanName 的 BeanDefinition 信息，如果包含，则进行兼容性比对)。创建 BeanDefinitionHolder 实例，然后调用 AnnotationConfigUtils 的 applyScopedProxyMode 方法来根据前面解析好的 ScopeMetadata 对象来处理 BeanDefinitionHolder，注意这里传了 BeanDefinitionRegistry 实例，最后调用 registerBeanDefinition 方法将 AnnotationConfigUtils 的 applyScopedProxyMode 方法返回值注册到 BeanDefinition 到 IoC 容器中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>ScopeMetadataResolver</span> <span class=n>scopeMetadataResolver</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AnnotationScopeMetadataResolver</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// ClassPathBeanDefinitionScanner#doScan
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>protected</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinitionHolder</span><span class=o>&gt;</span> <span class=nf>doScan</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>basePackages</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Assert</span><span class=o>.</span><span class=na>notEmpty</span><span class=o>(</span><span class=n>basePackages</span><span class=o>,</span> <span class=s>&#34;At least one base package must be specified&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinitionHolder</span><span class=o>&gt;</span> <span class=n>beanDefinitions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>basePackage</span> <span class=o>:</span> <span class=n>basePackages</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 根据指定包路径扫描Bean资源并加载
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinition</span><span class=o>&gt;</span> <span class=n>candidates</span> <span class=o>=</span> <span class=n>findCandidateComponents</span><span class=o>(</span><span class=n>basePackage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>BeanDefinition</span> <span class=n>candidate</span> <span class=o>:</span> <span class=n>candidates</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 使用AnnotationScopeMetadataResolver的resolveScopeMeatdata方法来根据Bean中@Scope(如果有)注解创建ScopeMeatdata对象
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>ScopeMetadata</span> <span class=n>scopeMetadata</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scopeMetadataResolver</span><span class=o>.</span><span class=na>resolveScopeMetadata</span><span class=o>(</span><span class=n>candidate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=n>candidate</span><span class=o>.</span><span class=na>setScope</span><span class=o>(</span><span class=n>scopeMetadata</span><span class=o>.</span><span class=na>getScopeName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 调用AnnotationBeanNameGenerator的generatorBeanName方法生成beanName
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>String</span> <span class=n>beanName</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>beanNameGenerator</span><span class=o>.</span><span class=na>generateBeanName</span><span class=o>(</span><span class=n>candidate</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 如果BeanDefinition是AbstractBeanDefinition类型的，设置BeanDefinition的默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>candidate</span> <span class=k>instanceof</span> <span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>postProcessBeanDefinition</span><span class=o>((</span><span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=n>candidate</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 如果BeanDefinition是AnnotatedBeanDefinition类型，解析通用注解
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>candidate</span> <span class=k>instanceof</span> <span class=n>AnnotatedBeanDefinition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>processCommonDefinitionAnnotations</span><span class=o>((</span><span class=n>AnnotatedBeanDefinition</span><span class=o>)</span> <span class=n>candidate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 如果BeanDefinition可以兼容
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>checkCandidate</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>candidate</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>BeanDefinitionHolder</span> <span class=n>definitionHolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>candidate</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 解析Bean中的@Scope注解
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=n>definitionHolder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>							<span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>applyScopedProxyMode</span><span class=o>(</span><span class=n>scopeMetadata</span><span class=o>,</span> <span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>beanDefinitions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>registerBeanDefinition</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>beanDefinitions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span></code></pre></div><p>首先分析下 ScopeMetadataResolver 这个接口。该接口存在两个实现类，分别为 AnnotationScopeM-etadataResolver 和 Jsr330ScopeMetadataResolver。AnnotationScopeMetadataResolver 用来处理 Spring 的@Scope 注解，而 Jsr330ScopeMetadataResolver 则用来处理 Jsr-330 规范中提出的@Scope 注解。ClassPathBeanDefinitionScanner 默认使用的是 AnnotationScopeMetadataResolver。</p><p>在 AnnotationScopeMetadataResolver 的 resolveScopeMetadata 方法中，首先创建 ScopeMetadata 实例，然后判断传入的 BeanDefinition 是否是 AnnotatedBeanDefinition 类型的。这里需要说明下通过 Cl-assPathBeanDefinitionScanner 扫描的类信息并创建的 BeanDefinition 都是 ScannedGenericBeanDefin-ition 类型的，该类型实现了 AnnotatedBeanDefinition 接口，因此这里的判断成立。</p><p>判断成立后首先将 BeanDefinition 强制转型为 AnnotatedBeanDefinition，调用 AnnotationConfigUtils 的 attributesFor 方法，传入从注解元数据(AnnotationMetadata)以及@Scope 注解的类型，返回 AnnotationAttributes 对象(以下简称 attributes)，如果返回的对象不为空，则设置 ScopeMetadata 的 scopeName(通过调用 atributes 的 getString 方法)，调用 attributes 的 getEnum 方法来获取@Scope 注解中 proxyMode 方法的返回值，如果返回的 proxyMode 等等于 ScopeProxyMode 的 DEFAULT，则将 proxyMode 重置为 ScopedProxyMode.NO(这也是前面讲到的 DEFAULT 和 NO 的作用是一样的)，将 proxyMode 设置到 metadata 中。</p><p>最后返回设置好的 metadata。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>AnnotationScopeMetadataResolver</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>defaultProxyMode</span> <span class=o>=</span> <span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>NO</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// AnnotationScopeMetadataResolver#resolveScopeMetadata
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=n>ScopeMetadata</span> <span class=nf>resolveScopeMetadata</span><span class=o>(</span><span class=n>BeanDefinition</span> <span class=n>definition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>ScopeMetadata</span> <span class=n>metadata</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScopeMetadata</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>definition</span> <span class=k>instanceof</span> <span class=n>AnnotatedBeanDefinition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>AnnotatedBeanDefinition</span> <span class=n>annDef</span> <span class=o>=</span> <span class=o>(</span><span class=n>AnnotatedBeanDefinition</span><span class=o>)</span> <span class=n>definition</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>AnnotationAttributes</span> <span class=n>attributes</span> <span class=o>=</span> <span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>attributesFor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>annDef</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>scopeAnnotationType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>attributes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>metadata</span><span class=o>.</span><span class=na>setScopeName</span><span class=o>(</span><span class=n>attributes</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;value&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>         <span class=n>ScopedProxyMode</span> <span class=n>proxyMode</span> <span class=o>=</span> <span class=n>attributes</span><span class=o>.</span><span class=na>getEnum</span><span class=o>(</span><span class=s>&#34;proxyMode&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>proxyMode</span> <span class=o>==</span> <span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>proxyMode</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>defaultProxyMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=n>metadata</span><span class=o>.</span><span class=na>setScopedProxyMode</span><span class=o>(</span><span class=n>proxyMode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>metadata</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 AnnotationConfigUtils 的 applyScopedProxyMode 方法中，通过传入的 ScopeMetadata 实例的 getScopedProxyMode 方法来获取 ScopedProxyMode，如果获取到的 ScopedProxyMode 等于 ScopedProxyMode.NO，则直接原样返回。接下来则是判断获取到的 scopedProxyMode 是否等于 ScopedProxyMode.TARGET_CLASS，并将比较结果赋值给 proxyTargetClass，调用 ScopedProxyCreator 的 createScopeProxy 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// AnnotationConfigUtils#applyScopedProxyMode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>static</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>applyScopedProxyMode</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>ScopeMetadata</span> <span class=n>metadata</span><span class=o>,</span> <span class=n>BeanDefinitionHolder</span> <span class=n>definition</span><span class=o>,</span> <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>ScopedProxyMode</span> <span class=n>scopedProxyMode</span> <span class=o>=</span> <span class=n>metadata</span><span class=o>.</span><span class=na>getScopedProxyMode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>scopedProxyMode</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>NO</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>definition</span><span class=o>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=kt>boolean</span> <span class=n>proxyTargetClass</span> <span class=o>=</span> <span class=n>scopedProxyMode</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>TARGET_CLASS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>ScopedProxyCreator</span><span class=o>.</span><span class=na>createScopedProxy</span><span class=o>(</span><span class=n>definition</span><span class=o>,</span> <span class=n>registry</span><span class=o>,</span> <span class=n>proxyTargetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 ScopedProxyCreator 的 createScopedProxy 方法中直接委派给 ScopedProxyUtils 的 createdScopedProxy 方法实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ScopedProxyCreator#createScopedProxy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>createScopedProxy</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>BeanDefinitionHolder</span> <span class=n>definitionHolder</span><span class=o>,</span> <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>proxyTargetClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>ScopedProxyUtils</span><span class=o>.</span><span class=na>createScopedProxy</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>,</span> <span class=n>registry</span><span class=o>,</span> <span class=n>proxyTargetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 ScopedProxyUtils 的 createScopedProxy 方法中，调用传入的 BeanDefinitionHolder 的 getBeanName 方法获取 beanName 并赋值给 originalBeanName，调用传入的 BeanDefinitionHolder 的 getBeanDefinition 方法来获取 BeanDefinition 并赋值给 targetBeanDefinition 变量，调用 getTargetBeanName 方法来处理 originalBeanName 并赋值给 targetBeanName 变量(该方法的处理逻辑就是在传入的 beanName 前拼接上“scopedTarget.”)。</p><p>重点是接下来创建的 RootBeanDefinition-proxyDefinition，传入的 beanClass 为 ScopedProxyFactoryBean 的 Class，根据 targetBeanDefinition 以及 targetBeanName 来创建 BeanDefinitionHolder 并设置到 proxyDefinition 的 decoratedDefinition 属性中，设置 targetDefinition 到 proxyDefinition 的 originatingBeanDefinition 属性中，获取 proxyDefinition 的属性元数据(getPropertyValues 方法)，将其 targetBea-nName 的属性值设置为 targetBeanName。设置将 targetBeanDefinition 的 autowireCandidate 以及 primary 设置为 false(设置这两个属性的意义在后面会分析到)。</p><p>通过调用传入的 BeanDefinitionRegistry 的 registerBeanDefinition 方法，来注册 targetDefinition，需重点关注的是，在注册 targetDefinition 时，传递的 beanName 为 targetBeanName(即拼接上“scopedTarget.”前缀的 beanName)。最后创建 BeanDefinitionHolder，指定的 beanName 却为 originalBeanName(即未拼接上“scopedTarget.”前缀的 beanName)。返回该实例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ScopedProxyUtils#createScopedProxy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>createScopedProxy</span><span class=o>(</span><span class=n>BeanDefinitionHolder</span> <span class=n>definition</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>proxyTargetClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>String</span> <span class=n>originalBeanName</span> <span class=o>=</span> <span class=n>definition</span><span class=o>.</span><span class=na>getBeanName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=n>BeanDefinition</span> <span class=n>targetDefinition</span> <span class=o>=</span> <span class=n>definition</span><span class=o>.</span><span class=na>getBeanDefinition</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=n>String</span> <span class=n>targetBeanName</span> <span class=o>=</span> <span class=n>getTargetBeanName</span><span class=o>(</span><span class=n>originalBeanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Create a scoped proxy definition for the original bean name,
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// &#34;hiding&#34; the target bean in an internal target definition.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>RootBeanDefinition</span> <span class=n>proxyDefinition</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RootBeanDefinition</span><span class=o>(</span><span class=n>ScopedProxyFactoryBean</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setDecoratedDefinition</span><span class=o>(</span><span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>targetDefinition</span><span class=o>,</span> <span class=n>targetBeanName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setOriginatingBeanDefinition</span><span class=o>(</span><span class=n>targetDefinition</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setSource</span><span class=o>(</span><span class=n>definition</span><span class=o>.</span><span class=na>getSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setRole</span><span class=o>(</span><span class=n>targetDefinition</span><span class=o>.</span><span class=na>getRole</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>getPropertyValues</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;targetBeanName&#34;</span><span class=o>,</span> <span class=n>targetBeanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>proxyTargetClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>targetDefinition</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=n>AutoProxyUtils</span><span class=o>.</span><span class=na>PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>TRUE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ScopedProxyFactoryBean&#39;s &#34;proxyTargetClass&#34; default is TRUE, so we don&#39;t need to set it explicitly here.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>getPropertyValues</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;proxyTargetClass&#34;</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>FALSE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Copy autowire settings from original bean definition.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setAutowireCandidate</span><span class=o>(</span><span class=n>targetDefinition</span><span class=o>.</span><span class=na>isAutowireCandidate</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>setPrimary</span><span class=o>(</span><span class=n>targetDefinition</span><span class=o>.</span><span class=na>isPrimary</span><span class=o>());</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>targetDefinition</span> <span class=k>instanceof</span> <span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>proxyDefinition</span><span class=o>.</span><span class=na>copyQualifiersFrom</span><span class=o>((</span><span class=n>AbstractBeanDefinition</span><span class=o>)</span> <span class=n>targetDefinition</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// The target bean should be ignored in favor of the scoped proxy.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>targetDefinition</span><span class=o>.</span><span class=na>setAutowireCandidate</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>targetDefinition</span><span class=o>.</span><span class=na>setPrimary</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Register the target bean as separate bean in the factory.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>registry</span><span class=o>.</span><span class=na>registerBeanDefinition</span><span class=o>(</span><span class=n>targetBeanName</span><span class=o>,</span> <span class=n>targetDefinition</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Return the scoped proxy definition as primary bean definition
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// (potentially an inner bean).
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>return</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>proxyDefinition</span><span class=o>,</span> <span class=n>originalBeanName</span><span class=o>,</span> <span class=n>definition</span><span class=o>.</span><span class=na>getAliases</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TARGET_NAME_PREFIX</span> <span class=o>=</span> <span class=s>&#34;scopedTarget.&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>getTargetBeanName</span><span class=o>(</span><span class=n>String</span> <span class=n>originalBeanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>TARGET_NAME_PREFIX</span> <span class=o>+</span> <span class=n>originalBeanName</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>把目光回到调用入口处-ClassPathBeanDefinitionScanner 的 doScan 方法中，在该方法的最后将 Annot-ationConfigUtils 的 applyScopedProxyMode 方法返回的 BeanDefinitionHolder 注册到 BeanDefinitionRegistry 中。这意味着如果某个 Bean 添加了@Scope 注解，并且将 proxyMode 设置为非 DEFAULT、NO 时，IoC 容器中将会存在该 Bean 的两个实例，一个名为“scopedTarget.beanName”其对应的是真正的 Bean 实例，另一个为“beanName”其对应的是 ScopedProxyFactoryBean 创建出来的目标 Bean 的代理对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BeanDefinitionHolder</span> <span class=n>definitionHolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>candidate</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>definitionHolder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>		<span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>applyScopedProxyMode</span><span class=o>(</span><span class=n>scopeMetadata</span><span class=o>,</span> <span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>beanDefinitions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>registerBeanDefinition</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span></code></pre></div><h2 id=代码验证>代码验证</h2><p>使用启动类来进行 @Scope 的 proxyMode 属性测试。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Scope</span><span class=o>(</span><span class=n>proxyMode</span> <span class=o>=</span> <span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>TARGET_CLASS</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ScopedBeanDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AnnotationConfigApplicationContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AnnotationConfigApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>ScopedBeanDemo</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>refresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span><span class=o>[]</span> <span class=n>beanDefinitionNames</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getBeanDefinitionNames</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Stream</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>beanDefinitionNames</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>forEach</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>beanName</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>beanType</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getType</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;beanName : %s -----&gt; beanType：%s \n&#34;</span><span class=o>,</span><span class=n>beanName</span><span class=o>,</span><span class=n>beanType</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>可以发现，IoC 容器中的确存在 ScopedBeanDemo 的两个 BeanDefinition 数据，一个 beanName 为“scopedTarget.scopedBeanName”，另一个为“scopeBeanDemo”。如上面的分析结果，IoC 容器中存在两个相同类型的 Bean，那么当我们通过 BeanFactory 的 getBean(Class)方法来查找时，是会抛出异常呢？还是正常返回呢？如果正常返回，那么该返回那个呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.aop.scope.ScopedProxyUtils</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Scope</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.ScopedProxyMode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.beans.Introspector</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.lang.reflect.Field</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Scope</span><span class=o>(</span><span class=n>proxyMode</span> <span class=o>=</span> <span class=n>ScopedProxyMode</span><span class=o>.</span><span class=na>TARGET_CLASS</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ScopedBeanDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AnnotationConfigApplicationContext</span> <span class=n>context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AnnotationConfigApplicationContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>ScopedBeanDemo</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=na>refresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据 ScopedBeanDemo 类型来查找
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ScopedBeanDemo</span> <span class=n>byType</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>ScopedBeanDemo</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据 ScopedBeanDemo 在IoC容器中的BeanName来进行查找 -&gt; 其底层也是通过 Java Beans 中的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Introspector#decapitalize方法来生成BeanName
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ScopedBeanDemo</span> <span class=n>byName</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>ScopedBeanDemo</span><span class=o>)</span> <span class=n>context</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>Introspector</span><span class=o>.</span><span class=na>decapitalize</span><span class=o>(</span><span class=s>&#34;ScopedBeanDemo&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在 ScopedBeanDemo 在IoC容器中的BeanName 前面拼接上 ScopedProxyUtils#TARGET_NAME_PREFIX 字段的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Field</span> <span class=n>field</span> <span class=o>=</span> <span class=n>ScopedProxyUtils</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;TARGET_NAME_PREFIX&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>field</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Object</span> <span class=n>value</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ScopedBeanDemo</span> <span class=n>byScopedName</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>ScopedBeanDemo</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>context</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>value</span> <span class=o>+</span> <span class=n>Introspector</span><span class=o>.</span><span class=na>decapitalize</span><span class=o>(</span><span class=s>&#34;ScopedBeanDemo&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;根据ScopedBeanDemo类型查找到的：&#34;</span> <span class=o>+</span> <span class=n>byType</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;根据ScopedBeanDemo名称查找到的：&#34;</span> <span class=o>+</span> <span class=n>byName</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;根据scopedTarget.ScopedBeanDemo名称查找到的：&#34;</span> <span class=o>+</span> <span class=n>byScopedName</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 关闭Spring 应用上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>context</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>可以发现无论是根据类型还是根据 beanName 来进行 IoC 容器返回的始终是是代理后的对象。只有按其拼接的规则来拼接 beanName 后(在 beanName 前拼接上“scopedTarget.”前缀)，再使用 BeanFactory 的 getBean(String)方法来查找才会返回原始对象。按照 beanName 来进行查找，IoC 容器会返回代理对象，这点可以理解，因为在 ScopedProxyUtils 的 createScopedProxy 方法偷梁换柱，将原始的 beanName 对应的 BeanDefinition 替换为代理 BeanDefinition，所以查找根据原始 beanName 查找出来的 bean 为代理 Bean 就不奇怪了，那么为什么根据类型来查找返回的依然是代理 Bean 呢？</p><p>这里先说下结论：是因为前面在 ScopedProxyUtils 的 createScopedProxy 方法中将原始的 BeanDefinit-ion(targetDefinition)的 autowireCandidate 设置为 false 导致的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// The target bean should be ignored in favor of the scoped proxy.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>targetDefinition</span><span class=o>.</span><span class=na>setAutowireCandidate</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>targetDefinition</span><span class=o>.</span><span class=na>setPrimary</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span></code></pre></div><p>下面我们来分析下 BeanFactory 的 getBean(Class)方法。AsbtractApplicationContext 实现了该方法，在该方法中首先来对 BeanFactory 实现类实例的存活状态进行校验。之后就是调用 BeanFactory 实现类实例的 getBean 方法，传入要获取的 Class。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// AbstractApplicationContext#getBean(java.lang.Class&lt;T&gt;)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getBean</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>requiredType</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>assertBeanFactoryActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>getBeanFactory</span><span class=o>().</span><span class=na>getBean</span><span class=o>(</span><span class=n>requiredType</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 DefaultListableBeanFactory 实现的 getBean 方法中，调用 resolveBean 方法来根据类型获取，如果该方法的返回值为 null，抛出 NoSuchBeanDefinitionException 异常。可以看出的是 resolveBean 方法并不会主动抛出异常，而是 getBean 方法抛出的异常，这一点很重要，因为包括 BeanFactory 提供的安全查找 Bean 的 getBeanProvider 方法底层也是基于该方法进行实现，这里就不再展开分析了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// DefaultListableBeanFactory#getBean(java.lang.Class&lt;T&gt;, java.lang.Object...)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getBean</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>requiredType</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>requiredType</span><span class=o>,</span> <span class=s>&#34;Required type must not be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>Object</span> <span class=n>resolved</span> <span class=o>=</span> <span class=n>resolveBean</span><span class=o>(</span><span class=n>ResolvableType</span><span class=o>.</span><span class=na>forRawClass</span><span class=o>(</span><span class=n>requiredType</span><span class=o>),</span> <span class=n>args</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>resolved</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>NoSuchBeanDefinitionException</span><span class=o>(</span><span class=n>requiredType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>resolved</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 resolveBean 方法中，调用 resolveNamedBean 方法来进行查找，如果该方法返回值不为 null，则直接返回，否则获取当前 IoC 容器的父容器(如果有)，层层查找。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// DefaultListableBeanFactory#resolveBean
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>resolveBean</span><span class=o>(</span><span class=n>ResolvableType</span> <span class=n>requiredType</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>nonUniqueAsNull</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>NamedBeanHolder</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>namedBean</span> <span class=o>=</span> <span class=n>resolveNamedBean</span><span class=o>(</span><span class=n>requiredType</span><span class=o>,</span> <span class=n>args</span><span class=o>,</span> <span class=n>nonUniqueAsNull</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>namedBean</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>namedBean</span><span class=o>.</span><span class=na>getBeanInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=n>BeanFactory</span> <span class=n>parent</span> <span class=o>=</span> <span class=n>getParentBeanFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>parent</span> <span class=k>instanceof</span> <span class=n>DefaultListableBeanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>((</span><span class=n>DefaultListableBeanFactory</span><span class=o>)</span> <span class=n>parent</span><span class=o>).</span><span class=na>resolveBean</span><span class=o>(</span><span class=n>requiredType</span><span class=o>,</span> <span class=n>args</span><span class=o>,</span> <span class=n>nonUniqueAsNull</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>parent</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ObjectProvider</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>parentProvider</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>getBeanProvider</span><span class=o>(</span><span class=n>requiredType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=n>parentProvider</span><span class=o>.</span><span class=na>getObject</span><span class=o>(</span><span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=o>(</span><span class=n>nonUniqueAsNull</span> <span class=o>?</span> <span class=n>parentProvider</span><span class=o>.</span><span class=na>getIfUnique</span><span class=o>()</span> <span class=o>:</span> <span class=n>parentProvider</span><span class=o>.</span><span class=na>getIfAvailable</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>在 resolveNamedBean 方法中，首先根据 getNamesForType 方法来获取指定类型的所有 beanName，该方法的返回值是一个数组。结合前面的代码可以得出这里获取到的 candidateNames 有两个，分别为：scopedTarget.scopedBeanDemo 和 scopedBeanDemo。</p><p>因此会进入第一个判断即 candidateNames 的长度大于 1，遍历 candidateNames 集合，对于遍历到的每一个 beanName，通过 containsBeanDefinition 方法来判断当前 IoC 容器中是否包含指定 beanName 的 BeanDefinition 数据(注意这里是对结果进行取反，因此判断失败)，第二个判断是根据 beanName 获取到对应的 BeanDefinition 实例后，然后调用其 isAutowireCandidate 方法，注意前面我们已经分析过在 ScopedProxyUtils 的 createScopedProxy 方法将 targetDefinition 的 autowireCandidate 属性设置为 false，因此真正的 BeanDefinition 是不会被作为候选的 BeanDefinition，反而是代理 BeanDefinition 会作为候选的 BeanDefinition。</p><p>next，判断 candidateNames 数组的长度是否等等于 1，如果判断成立，则调用 getBean 方法来根据 beanName 获取，并将方法返回结果构建为 NamedBeanHolder 返回。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// DefaultListableBeanFactory#resolveNamedBean
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>NamedBeanHolder</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>resolveNamedBean</span><span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=n>ResolvableType</span> <span class=n>requiredType</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>nonUniqueAsNull</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>BeansException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>requiredType</span><span class=o>,</span> <span class=s>&#34;Required type must not be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// getBean(ScopedBeanDemo.class) -&gt; candidateNames 中存在两个beanName，分别为
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// “scopedTarget.scopedBeanDemo”以及“scopedBeanDemo”。
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>String</span><span class=o>[]</span> <span class=n>candidateNames</span> <span class=o>=</span> <span class=n>getBeanNamesForType</span><span class=o>(</span><span class=n>requiredType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=o>(</span><span class=n>candidateNames</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>autowireCandidates</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>candidateNames</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>beanName</span> <span class=o>:</span> <span class=n>candidateNames</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 由于真正的ScopedBeanDemo的BeanDefinition的autowireCandidate属性被设置为false，
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 因此这里被保存到autowireCandidates集合中的是代理Bean的BeanDefinition
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>if</span> <span class=o>(!</span><span class=n>containsBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>)</span> <span class=o>||</span> <span class=n>getBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>).</span><span class=na>isAutowireCandidate</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>autowireCandidates</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>autowireCandidates</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>candidateNames</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>toStringArray</span><span class=o>(</span><span class=n>autowireCandidates</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果candidateNames的长度为1，通过getBean方法来触发初始化或者从缓存中获取并构建为
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// NamedBeanHolder 对象返回。
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=o>(</span><span class=n>candidateNames</span><span class=o>.</span><span class=na>length</span> <span class=o>==</span> <span class=mi>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>beanName</span> <span class=o>=</span> <span class=n>candidateNames</span><span class=o>[</span><span class=mi>0</span><span class=o>];</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=n>NamedBeanHolder</span><span class=o>&lt;&gt;(</span><span class=n>beanName</span><span class=o>,</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>getBean</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>requiredType</span><span class=o>.</span><span class=na>toClass</span><span class=o>(),</span> <span class=n>args</span><span class=o>));</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>candidateNames</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>candidates</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;(</span><span class=n>candidateNames</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>beanName</span> <span class=o>:</span> <span class=n>candidateNames</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>containsSingleton</span><span class=o>(</span><span class=n>beanName</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>args</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>beanInstance</span> <span class=o>=</span> <span class=n>getBean</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>candidates</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=o>(</span><span class=n>beanInstance</span> <span class=k>instanceof</span> <span class=n>NullBean</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=n>beanInstance</span><span class=o>));</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>candidates</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>getType</span><span class=o>(</span><span class=n>beanName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>candidateName</span> <span class=o>=</span> <span class=n>determinePrimaryCandidate</span><span class=o>(</span><span class=n>candidates</span><span class=o>,</span> <span class=n>requiredType</span><span class=o>.</span><span class=na>toClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>candidateName</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>candidateName</span> <span class=o>=</span> <span class=n>determineHighestPriorityCandidate</span><span class=o>(</span><span class=n>candidates</span><span class=o>,</span> <span class=n>requiredType</span><span class=o>.</span><span class=na>toClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>candidateName</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>Object</span> <span class=n>beanInstance</span> <span class=o>=</span> <span class=n>candidates</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>candidateName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>beanInstance</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>beanInstance</span> <span class=k>instanceof</span> <span class=n>Class</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>beanInstance</span> <span class=o>=</span> <span class=n>getBean</span><span class=o>(</span><span class=n>candidateName</span><span class=o>,</span> <span class=n>requiredType</span><span class=o>.</span><span class=na>toClass</span><span class=o>(),</span> <span class=n>args</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=k>new</span> <span class=n>NamedBeanHolder</span><span class=o>&lt;&gt;(</span><span class=n>candidateName</span><span class=o>,</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>beanInstance</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(!</span><span class=n>nonUniqueAsNull</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=k>throw</span> <span class=k>new</span> <span class=n>NoUniqueBeanDefinitionException</span><span class=o>(</span><span class=n>requiredType</span><span class=o>,</span> <span class=n>candidates</span><span class=o>.</span><span class=na>keySet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h1 id=总结>总结</h1><p>@Scope 注解中的 proxyMode 方法值指示了 IoC 容器要不要为 Bean 创建代理，如何创建代理，是使用 JDK 的动态代理还是使用 CGLIB？我们通过源码也了解到 ScopedProxyMode 的 DEFAULT 和 NO 作用是一样的，如果配置为 INTERFACES 或 TARGET_CLASS，在 ScopedProxyUtils 的 createScopedProxy 方法中将会为目标 Bean 创建一个 ScopedProxyFactoryBean 的 BeanDefinition，并使用目标 Bean 的 beanName 来注册这个 BeanDefinition，将目标 Bean 的 beanName 拼接上“ScopedTarget.”前缀来注册目标 Bean 的 BeanDefinition。</p><p>同时将目标 BeanDefinition 的 autowireCandidate 属性设置为 false，以此来确保 IoC 容器在查找该类型的单个 Bean 时(getBean 方法)不会返回原始 Bean 实例，而是返回经过代理后的 Bean 实例。</p></div><div class=article-widget><div class="container-xl row post-nav"><div class="col-6 post-nav-item"><div class=meta-nav>上一页</div><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/jar-%E5%8A%A0%E8%BD%BD/ rel=next>Jar 加载</a></div><div class="col-6 post-nav-item"><div class=meta-nav>下一页</div><a href=/books/spring-series/1.%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/3.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/%E4%BE%9D%E8%B5%96%E6%9C%BA%E5%88%B6/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/ rel=prev>启动流程</a></div></div></div><div class=body-footer><p>最近更新于 0001-01-01</p><section id=comments class="mb-3 pt-0"><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="https://ngte-website.oss-accelerate.aliyuncs.com/disqus/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><footer class=site-footer><div class="copyright py-4 bg-footer"><div class="row justify-content-center"><div class="text-center footer-color"><p class=mb-0>© 2017-2022 NGTE all rights reserved</p></div></div></div></footer></main></div></div><script src=//unpkg.com/heti/umd/heti-addon.min.js></script>
<script>const heti=new Heti(".article");heti.autoSpacing()</script><script type=text/javascript>window.$crisp=[],window.CRISP_WEBSITE_ID="12adcc35-9621-4313-8262-62dc654b29d8",function(){setTimeout(function(){d=document,s=d.createElement("script"),s.src="https://client.crisp.chat/l.js",s.async=1,d.getElementsByTagName("head")[0].appendChild(s)},2500)}()</script></div><div class=page-footer></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script id=dsq-count-scr src=https://ngte-website.oss-accelerate.aliyuncs.com/disqus/count.js async></script>
<script src=/zh/js/algolia-search-built.min.4387d694ca1258194aaf562b8cd1c400.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":false}</script><script src=/zh/js/wowchemy.min.d1673c7a11d1238516cbe12a1e84257f.js></script>
<script>var mybutton=document.getElementById("backTopBtn");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script><script>(function(){"use strict";if(!document.queryCommandSupported("copy"))return;function e(e,t){e.className="highlight-copy-btn",e.textContent=t,setTimeout(function(){e.textContent="",e.className="highlight-copy-btn fa fa-copy"},1e3)}function t(e){var t=window.getSelection(),n=document.createRange();return n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t}function n(n){var o,s=document.createElement("button");s.className="highlight-copy-btn fa fa-copy",s.textContent="",o=n.firstElementChild,s.addEventListener("click",function(){try{var n=t(o);document.execCommand("copy"),n.removeAllRanges(),e(s,"已复制")}catch(t){console&&console.log(t),e(s,"Failed :'(")}}),n.appendChild(s)}var s=document.getElementsByClassName("highlight");Array.prototype.forEach.call(s,n)})()</script></body></html>